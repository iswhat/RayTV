/**
 * å›¾ç‰‡ç»„ä»¶
 * æä¾›ç»Ÿä¸€çš„å›¾ç‰‡åŠ è½½ã€å ä½ç¬¦å’Œé”™è¯¯å¤„ç†åŠŸèƒ? */
import { Component, Prop, State, EventHub, Event } from '@ohos/arkui';
import Logger from '../common/util/Logger';

export interface ImageComponentOptions {
  /** å›¾ç‰‡URL */
  src?: string;
  /** å ä½å›¾URL */
  placeholder?: string;
  /** é”™è¯¯å›¾URL */
  errorImage?: string;
  /** å›¾ç‰‡å®½åº¦ */
  width?: number | string;
  /** å›¾ç‰‡é«˜åº¦ */
  height?: number | string;
  /** å›¾ç‰‡æ¨¡å¼ */
  mode?: ImageMode;
  /** æ˜¯å¦å¯ç”¨æ‡’åŠ è½?*/
  lazyLoad?: boolean;
  /** æ˜¯å¦æ˜¾ç¤ºåŠ è½½çŠ¶æ€?*/
  showLoading?: boolean;
  /** è‡ªå®šä¹‰æ ·å¼?*/
  style?: object;
}

/**
 * å›¾ç‰‡æ¨¡å¼æšä¸¾
 */
export enum ImageMode {
  /** ä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œå¯èƒ½ä¼šæœ‰ç•™ç™?*/
  ASPECT_FIT,
  /** ä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œå¯èƒ½ä¼šè£å‰ª */
  ASPECT_FILL,
  /** æ‹‰ä¼¸å¡«å……æ•´ä¸ªå®¹å™¨ */
  FILL,
  /** è£å‰ªå¹¶å±…ä¸­æ˜¾ç¤?*/
  CROP_CENTER,
  /** ä¿æŒåŸå›¾å¤§å° */
  ORIGINAL
}

@Component
class ImageComponent {
  private static readonly TAG = 'ImageComponent';
  
  @Prop private src?: string;
  @Prop private placeholder?: string = '/common/images/placeholder.png';
  @Prop private errorImage?: string = '/common/images/error.png';
  @Prop private width?: number | string = '100%';
  @Prop private height?: number | string = '100%';
  @Prop private mode?: ImageMode = ImageMode.ASPECT_FIT;
  @Prop private lazyLoad?: boolean = true;
  @Prop private showLoading?: boolean = true;
  @Prop private style?: object = {};
  
  @State private isLoading: boolean = false;
  @State private loadFailed: boolean = false;
  @State private currentImage: string = '';
  
  private observer?: IntersectionObserver;
  private isVisible: boolean = false;
  
  /**
   * ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ - ç»„ä»¶æŒ‚è½½å?   */
  aboutToAppear() {
    Logger.debug(this.TAG, 'About to appear');
    
    // åˆå§‹åŒ–æ˜¾ç¤ºå ä½å›¾
    this.currentImage = this.placeholder || '';
    
    // å¦‚æœä¸æ˜¯æ‡’åŠ è½½ï¼Œç›´æ¥åŠ è½½å›¾ç‰‡
    if (!this.lazyLoad) {
      this.loadImage();
    } else {
      // è®¾ç½®äº¤å‰è§‚å¯Ÿå™¨ç”¨äºæ‡’åŠ è½½
      this.setupIntersectionObserver();
    }
  }
  
  /**
   * ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ - ç»„ä»¶å¸è½½å‰?   */
  aboutToDisappear() {
    Logger.debug(this.TAG, 'About to disappear');
    
    // æ¸…ç†è§‚å¯Ÿå™?    if (this.observer) {
      this.observer.disconnect();
      this.observer = undefined;
    }
  }
  
  /**
   * è®¾ç½®äº¤å‰è§‚å¯Ÿå™?   */
  private setupIntersectionObserver() {
    try {
      // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œéœ€è¦ä½¿ç”¨å¹³å°æä¾›çš„äº¤å‰è§‚å¯Ÿå™¨API
      // è¿™é‡Œæ˜¯æ¦‚å¿µæ€§å®ç?      const element = this.$element();
      if (element) {
        // æ¨¡æ‹Ÿäº¤å‰è§‚å¯Ÿå™?        this.observer = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting && !this.isVisible) {
              this.isVisible = true;
              this.loadImage();
              
              // åŠ è½½å®Œæˆåå¯ä»¥åœæ­¢è§‚å¯?              if (this.observer) {
                this.observer.unobserve(element);
              }
            }
          });
        });
        
        this.observer.observe(element);
      }
    } catch (error) {
      Logger.error(this.TAG, `Setup intersection observer error: ${error}`);
      // å¤±è´¥æ—¶ç›´æ¥åŠ è½½å›¾ç‰?      this.loadImage();
    }
  }
  
  /**
   * åŠ è½½å›¾ç‰‡
   */
  private loadImage() {
    if (!this.src) {
      Logger.warn(this.TAG, 'No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided' : new Error(String('No image source provided' instanceof Error ? 'No image source provided' : new Error(String('No image source provided')))))));
      this.loadFailed = true;
      this.isLoading = false;
      this.currentImage = this.errorImage || '';
      return;
    }
    
    Logger.debug(this.TAG, `Loading image: ${this.src}`);
    
    this.isLoading = true;
    this.loadFailed = false;
    
    // æ¨¡æ‹Ÿå›¾ç‰‡åŠ è½½è¿‡ç¨‹
    // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œéœ€è¦ä½¿ç”¨å¹³å°æä¾›çš„å›¾ç‰‡åŠ è½½API
    const image = new Image();
    
    image.onload = () => {
      Logger.debug(this.TAG, `Image loaded successfully: ${this.src}`);
      this.isLoading = false;
      this.currentImage = this.src!;
    };
    
    image.onerror = () => {
      Logger.error(this.TAG, `Failed to load image: ${this.src}`);
      this.isLoading = false;
      this.loadFailed = true;
      this.currentImage = this.errorImage || '';
    };
    
    // è®¾ç½®å›¾ç‰‡æº?    image.src = this.src;
    
    // æ¨¡æ‹ŸåŠ è½½è¶…æ—¶
    setTimeout(() => {
      if (this.isLoading) {
        Logger.warn(this.TAG, `Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}` instanceof Error ? `Image loading timeout: ${this.src}` : new Error(String(`Image loading timeout: ${this.src}`)))))));
        this.isLoading = false;
        this.loadFailed = true;
        this.currentImage = this.errorImage || '';
      }
    }, 10000); // 10ç§’è¶…æ—?  }
  
  /**
   * é‡è¯•åŠ è½½å›¾ç‰‡
   */
  private retryLoad() {
    Logger.debug(this.TAG, `Retrying to load image: ${this.src}`);
    this.loadImage();
  }
  
  /**
   * è®¡ç®—å›¾ç‰‡æ¨¡å¼
   */
  private getImageMode(): string {
    switch (this.mode) {
      case ImageMode.ASPECT_FIT:
        return 'aspectFit';
      case ImageMode.ASPECT_FILL:
        return 'aspectFill';
      case ImageMode.FILL:
        return 'fill';
      case ImageMode.CROP_CENTER:
        return 'cropCenter';
      case ImageMode.ORIGINAL:
        return 'original';
      default:
        return 'aspectFit';
    }
  }
  
  /**
   * æ„å»ºç»„ä»¶æ ·å¼
   */
  private buildStyle(): object {
    return {
      width: this.width,
      height: this.height,
      ...this.style,
    };
  }
  
  /**
   * æ¸²æŸ“åŠ è½½æŒ‡ç¤ºå™?   */
  private renderLoadingIndicator() {
    if (this.isLoading && this.showLoading) {
      return (
        <div class="loading-indicator">
          {/* è¿™é‡Œå¯ä»¥ä½¿ç”¨å¹³å°æä¾›çš„åŠ è½½ç»„ä»?*/}
          <text>åŠ è½½ä¸?..</text>
        </div>
      );
    }
    return null;
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  render() {
    return (
      <div class="image-component-container" style={this.buildStyle()}>
        <image
          src={this.currentImage}
          mode={this.getImageMode()}
          onclick={() => this.loadFailed && this.retryLoad()}
        />
        {this.renderLoadingIndicator()}
      </div>
    );
  }
}

export default ImageComponent;


