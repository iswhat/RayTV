/**
 * JSONæ•°æ®ç±»ï¼Œç”¨äºå®‰å…¨åœ°å¤„ç†JSONå¯¹è±¡
 */
export class JsonData {
  private data: Record<string, string | number | boolean | null> = {};

  /**
   * è®¾ç½®å±æ€§å€?
   * @param key - å±æ€§å
   * @param value - å±æ€§å€?
   */
  set(key: string, value: string | number | boolean | null): void {
    this.data[key] = value;
  }

  /**
   * è·å–å±æ€§å€?
   * @param key - å±æ€§å
   * @returns å±æ€§å€?
   */
  get(key: string): string | number | boolean | null | undefined {
    return this.data[key];
  }

  /**
   * æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ?
   * @param key - å±æ€§å
   * @returns æ˜¯å¦å­˜åœ¨
   */
  has(key: string): boolean {
    // ä½¿ç”¨Object.keyså’Œincludesæ›¿ä»£Object.prototype.hasOwnProperty.call
    return Object.keys(this.data).includes(key);
  }

  /**
   * è·å–æ‰€æœ‰å±æ€§å
   * @returns å±æ€§åæ•°ç»„
   */
  keys(): string[] {
    return Object.keys(this.data);
  }

  /**
   * è½¬æ¢ä¸ºæ™®é€šå¯¹è±?
   * @returns è½¬æ¢åçš„å¯¹è±¡
   */
  toObject(): Record<string, string | number | boolean | null> {
    // ç›´æ¥è¿”å›this.dataçš„å‰¯æœ¬ï¼Œé¿å…é€’å½’è°ƒç”¨
    const result: Record<string, string | number | boolean | null> = {};
    const keys = Object.keys(this.data);
    for (let i = 0; i < keys.length; i++) {
      const key = keys[i];
      result[key] = this.data[key];
    }
    return result;
  }
}

/**
 * JSONå·¥å…·ç±?- å…¨åŠŸèƒ½ç‰ˆæœ?
 * æä¾›å®‰å…¨çš„JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–åŠŸèƒ½
 */
export default class JsonUtil {
  /**
   * æ£€æŸ¥å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡å®šå±æ€?
   * ä½¿ç”¨Object.keyså’Œincludesæ›¿ä»£Object.prototype.hasOwnProperty.call
   */
  private static hasOwnProperty<T extends object>(obj: T, key: string | number): boolean {
    // ä½¿ç”¨Object.keyså’Œincludesæ›¿ä»£Object.prototype.hasOwnProperty.call
    if (typeof obj !== 'object' || obj === null) {
      return false;
    }
    const keys = Object.keys(obj);
    return keys.includes(String(key));
  }

  /**
   * å®‰å…¨åœ°è·å–å¯¹è±¡å±æ€§å€¼ï¼Œé¿å…å­—æ®µç´¢å¼•è®¿é—®é”™è¯¯
   * @param obj - è¦è®¿é—®çš„å¯¹è±¡
   * @param key - å±æ€§å
   * @returns å±æ€§å€?
   */
  private static getPropertyValue<T extends object>(obj: T, key: string): string | number | boolean | null | undefined {
    if (typeof obj !== 'object' || obj === null) {
      return undefined;
    }
    
    // ä½¿ç”¨ç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼?
    const recordObj = obj as Record<string, string | number | boolean | null>;
    if (JsonUtil.hasOwnProperty(recordObj, key)) {
      return recordObj[key];
    }
    
    return undefined;
  }
  /**
   * å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸?
   * @param value - è¦åºåˆ—åŒ–çš„å¯¹è±?
   * @returns JSONå­—ç¬¦ä¸?
   */
  static stringify<T>(value: T): string {
    try {
      return JSON.stringify(value);
    } catch (error) {
      console.error('JSON stringify failed:', error instanceof Error ? error.message : String(error));
      return "{}";
    }
  }

  /**
   * å°†JSONå­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡
   * @param jsonStr JSONå­—ç¬¦ä¸?
   * @returns è§£æåçš„å¯¹è±¡
   */
  static parse<T>(jsonStr: string): T {
    try {
      if (typeof jsonStr !== 'string') {
        // å‚æ•°ç±»å‹ä¸åŒ¹é…æ—¶æŠ›å‡ºæ˜ç¡®çš„ç±»å‹é”™è¯?
        throw new TypeError('Expected string as input to parse method');
      }
      // ä½¿ç”¨æ˜ç¡®çš„ç±»å‹æ–­è¨€ä»¥å…¼å®¹ArkTS
      return JSON.parse(jsonStr) as T;
    } catch (error) {
      // ä½¿ç”¨æ›´æ˜ç¡®çš„é”™è¯¯ç±»å‹å¤„ç†ä»¥å…¼å®¹ArkTS
      console.error('JSON parse failed:', error instanceof Error ? error.message : String(error));
      // è¿”å›ç©ºå¯¹è±¡å¹¶è¿›è¡Œé€‚å½“çš„ç±»å‹æ–­è¨€
      const emptyResult: Record<string, string | number | boolean | null> = {};
      return emptyResult as T;
    }
  }

  /**
   * å®‰å…¨åœ°è§£æJSONå­—ç¬¦ä¸²ï¼Œå‡ºé”™æ—¶è¿”å›é»˜è®¤å€?
   * @param jsonStr JSONå­—ç¬¦ä¸?
   * @param defaultValue é»˜è®¤å€?
   * @returns è§£æåçš„å¯¹è±¡æˆ–é»˜è®¤å€?
   */
  static safeParse<T>(jsonStr: string, defaultValue?: T): T | null {
    try {
      if (!jsonStr || typeof jsonStr !== 'string') {
        return defaultValue || null;
      }
      // ä½¿ç”¨æ˜ç¡®çš„ç±»å‹æ–­è¨€ä»¥å…¼å®¹ArkTS
      return JSON.parse(jsonStr) as T;
    } catch (error) {
      // ä½¿ç”¨æ˜ç¡®çš„é”™è¯¯ç±»å‹å¤„ç†ä»¥å…¼å®¹ArkTS
      console.error('JSON parse failed:', error instanceof Error ? error.message : String(error));
      return defaultValue || null;
    }
  }

  /**
   * æ·±åº¦å…‹éš†å¯¹è±¡
   * @param obj - è¦å…‹éš†çš„å¯¹è±¡
   * @returns å…‹éš†åçš„æ–°å¯¹è±?
   */
  /**
   * æ·±åº¦å…‹éš†å¯¹è±¡
   * @param obj - è¦å…‹éš†çš„å¯¹è±¡
   * @returns å…‹éš†åçš„æ–°å¯¹è±?
   */
  static deepClone<T>(obj: T): T {
    try {
      // å¤„ç†åŸºæœ¬ç±»å‹å’Œnull
      if (obj === null || typeof obj !== 'object') {
        return obj;
      }
      
      // ç‰¹æ®Šå¤„ç†Dateå¯¹è±¡
      if (obj instanceof Date) {
        return new Date(obj.getTime()) as T;
      }
      
      // ç‰¹æ®Šå¤„ç†Arrayå¯¹è±¡
      if (Array.isArray(obj)) {
        // ä½¿ç”¨å…·ä½“çš„æ•°ç»„ç±»å‹æ›¿ä»£unknown[]
        const clonedArray: (string | number | boolean | null)[] = [];
        for (let i = 0; i < obj.length; i++) {
          // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆï¼Œå®‰å…¨è®¿é—®æ•°ç»„å…ƒç´?
          if (i >= 0 && i < obj.length) {
            // ä½¿ç”¨ç±»å‹å®‰å…¨çš„æ•°ç»„è®¿é—®æ–¹å¼ï¼Œé¿å…any/unknownç±»å‹
            const arrayItem = (obj as (string | number | boolean | null)[])[i];
            clonedArray[i] = JsonUtil.deepClone(arrayItem);
          }
        }
        return clonedArray as T;
      }
      
      // å¤„ç†å¯¹è±¡å­—é¢é‡?
      const clone: Record<string, string | number | boolean | null> = {};
      
      // ä½¿ç”¨Object.getOwnPropertyNamesè·å–å±æ€§å
      const keys = Object.getOwnPropertyNames(obj);
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const safeKey = String(key);
        // ä½¿ç”¨ç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼ï¼Œé¿å…å­—æ®µç´¢å¼•è®¿é—®
        const propertyValue = JsonUtil.getPropertyValue(obj, safeKey);
        // ä¿®å¤ç±»å‹é”™è¯¯ï¼šç¡®ä¿deepCloneè¿”å›æ­£ç¡®çš„ç±»å?
        const clonedValue = JsonUtil.deepClone<string | number | boolean | null>(propertyValue as string | number | boolean | null);
        if (clonedValue !== undefined) {
          clone[safeKey] = clonedValue as string | number | boolean | null;
        }
      }
      
      return clone as T;
    } catch (error) {
      console.error('Deep clone failed:', error instanceof Error ? error.message : String(error));
      // åœ¨å…‹éš†å¤±è´¥æ—¶ï¼Œå°è¯•ä½¿ç”¨JSONåºåˆ—åŒ–ä½œä¸ºå¤‡é€‰æ–¹æ¡?
      try {
        return JSON.parse(JSON.stringify(obj)) as T;
      } catch {
        // æœ€åå›é€€åˆ°è¿”å›åŸå§‹å¯¹è±?
        return obj;
      }
    }
  }

  /**
   * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
   * @param str - è¦æ£€æŸ¥çš„å­—ç¬¦ä¸?
   * @returns æ˜¯å¦ä¸ºæœ‰æ•ˆJSON
   */
  static isValidJSON(str: string): boolean {
    try {
      JSON.parse(str);
      return true;
    } catch {
      return false;
    }
  }

  /**
   * ç¾åŒ–JSONå­—ç¬¦ä¸?
   * @param jsonStr - JSONå­—ç¬¦ä¸?
   * @param indent - ç¼©è¿›ç©ºæ ¼æ•°ï¼Œé»˜è®¤2
   * @returns ç¾åŒ–åçš„JSONå­—ç¬¦ä¸?
   */
  static prettyPrint(jsonStr: string, indent: number = 2): string {
    try {
      // ä½¿ç”¨æ˜ç¡®çš„åºåˆ—åŒ–å€¼ç±»å‹è¿›è¡Œè§£æ?
      const parsed: Record<string, string | number | boolean | null> = JSON.parse(jsonStr) as Record<string, string | number | boolean | null>;
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å¯¹è±¡æˆ–æ•°ç»„
      if (parsed === null || (typeof parsed !== 'object')) {
        return jsonStr;
      }
      
      return JSON.stringify(parsed, null, indent);
    } catch {
      return jsonStr;
    }
  }

  /**
   * åˆå¹¶å¤šä¸ªJSONå¯¹è±¡
   * @param objects - è¦åˆå¹¶çš„å¯¹è±¡æ•°ç»„
   * @returns åˆå¹¶åçš„å¯¹è±¡
   */
  static merge<T extends Record<string, string | number | boolean | null>>(...objects: T[]): T {
    // ä½¿ç”¨JsonDataç±»æ›¿ä»£å¯¹è±¡å­—é¢é‡
    const jsonData = new JsonData();
    
    // æ›¿æ¢å¤–å±‚for..ofå¾ªç¯
    for (let i = 0; i < objects.length; i++) {
      const current = objects[i];
      if (!current || typeof current !== 'object') {
        continue;
      }
      
      const keys = Object.getOwnPropertyNames(current);
      // æ›¿æ¢å†…å±‚for..ofå¾ªç¯
      for (let j = 0; j < keys.length; j++) {
        const key = keys[j];
        if (JsonUtil.hasOwnProperty(current, key)) {
          // ä½¿ç”¨ç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼ï¼Œé¿å…å­—æ®µç´¢å¼•è®¿é—®
          const propertyValue = JsonUtil.getPropertyValue(current, key);
          // ä¿®å¤ç±»å‹é”™è¯¯ï¼šç¡®ä¿å±æ€§å€¼ç±»å‹æ­£ç¡?
          if (propertyValue !== undefined) {
            jsonData.set(key, propertyValue as string | number | boolean | null);
          }
        }
      }
    }
    
    return jsonData.toObject() as T;
  }

  /**
   * è¿‡æ»¤å¯¹è±¡ä¸­çš„nullå’Œundefinedå€?
   * @param obj - è¦è¿‡æ»¤çš„å¯¹è±¡
   * @returns è¿‡æ»¤åçš„å¯¹è±¡
   */
  static filterNullUndefined<T extends Record<string, string | number | boolean | null>>(
    obj: T
  ): Record<string, string | number | boolean | null> {
    // ç±»å‹å®‰å…¨æ£€æŸ?
    if (!obj || typeof obj !== 'object') {
      const emptyResult: Record<string, string | number | boolean | null> = {};
      return emptyResult;
    }
    
    // ä½¿ç”¨JsonDataç±»æ›¿ä»£å¯¹è±¡å­—é¢é‡
    const jsonData = new JsonData();
    const keys = Object.getOwnPropertyNames(obj);
    
    // æ›¿æ¢for..ofå¾ªç¯ä¸ºæ ‡å‡†forå¾ªç¯
    for (let i = 0; i < keys.length; i++) {
      const key = keys[i];
      if (JsonUtil.hasOwnProperty(obj, key)) {
        // ä½¿ç”¨ç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼ï¼Œé¿å…å­—æ®µç´¢å¼•è®¿é—®
        const value = JsonUtil.getPropertyValue(obj, key);
        // ç¡®ä¿å€¼ä¸ä¸ºnullä¸”ä¸ä¸ºundefined
        if (value !== null && value !== undefined) {
          // ä¿®å¤ç±»å‹é”™è¯¯ï¼šç¡®ä¿å€¼ç±»å‹æ­£ç¡?
          jsonData.set(key, value as string | number | boolean | null);
        }
      }
    }
    
    // ç›´æ¥è¿”å›æ˜ç¡®çš„ç±»å?
    return jsonData.toObject();
  }
}

/**
 * å®‰å…¨çš„JSONåºåˆ—åŒ–å‡½æ•?
 * @param value - è¦åºåˆ—åŒ–çš„å¯¹è±?
 * @returns JSONå­—ç¬¦ä¸?
 */
export function safeStringify(value: Record<string, string | number | boolean | null>): string {
  return JsonUtil.stringify(value);
}

/**
 * å¿«é€Ÿè§£æJSONå­—ç¬¦ä¸²ï¼ˆåˆ«åï¼?
 * @param jsonStr - JSONå­—ç¬¦ä¸?
 * @returns è§£æåçš„å¯¹è±¡
 */
export function quickParse(jsonStr: string): Record<string, string | number | boolean | null> {
  return JsonUtil.parse<Record<string, string | number | boolean | null>>(jsonStr);
}

/**
 * æ£€æŸ¥JSONå­—ç¬¦ä¸²æ˜¯å¦æœ‰æ•?
 * @param str - è¦æ£€æŸ¥çš„å­—ç¬¦ä¸?
 * @returns æ˜¯å¦ä¸ºæœ‰æ•ˆJSON
 */
export function isValidJSON(str: string): boolean {
  return JsonUtil.isValidJSON(str);
}
