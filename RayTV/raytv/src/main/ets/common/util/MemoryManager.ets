// MemoryManager - å†…å­˜ç®¡ç†å·¥å…·ç±?import Logger from './Logger';

const TAG = 'MemoryManager';

/**
 * å†…å­˜ç®¡ç†å·¥å…·ç±? * æä¾›å†…å­˜ä½¿ç”¨ç›‘æŽ§ã€å†…å­˜é™åˆ¶æ£€æŸ¥ç­‰åŠŸèƒ½
 */
export default class MemoryManager {
  private static instance: MemoryManager;
  private maxMemoryUsage: number = 0.8; // æœ€å¤§å†…å­˜ä½¿ç”¨çŽ‡ 80%
  private checkInterval: number = 30000; // 30ç§’æ£€æŸ¥ä¸€æ¬?  private lastCheckTime: number = 0;
  private memoryUsageHistory: number[] = [];

  /**
   * ç§æœ‰æž„é€ å‡½æ•?   */
  private constructor() {
    Logger.info(TAG, 'MemoryManager initialized');
    this.startPeriodicCheck();
  }

  /**
   * èŽ·å–å•ä¾‹å®žä¾‹
   */
  public static getInstance(): MemoryManager {
    if (!MemoryManager.instance) {
      MemoryManager.instance = new MemoryManager();
    }
    return MemoryManager.instance;
  }

  /**
   * è®¾ç½®æœ€å¤§å†…å­˜ä½¿ç”¨çŽ‡
   * @param usage å†…å­˜ä½¿ç”¨çŽ‡é˜ˆå€?(0-1)
   */
  public setMaxMemoryUsage(usage: number): void {
    if (usage > 0 && usage <= 1) {
      this.maxMemoryUsage = usage;
      Logger.info(TAG, `Max memory usage set to: ${(usage * 100).toFixed(0)}%`);
    }
  }

  /**
   * æ£€æŸ¥å†…å­˜å¯ç”¨æ€?   * @returns æ˜¯å¦æœ‰è¶³å¤Ÿå†…å­˜å¯ç”?   */
  public checkMemoryAvailability(): boolean {
    try {
      const currentUsage = this.getCurrentMemoryUsage();
      
      // è®°å½•å†…å­˜ä½¿ç”¨åŽ†å²
      this.recordMemoryUsage(currentUsage);
      
      const result = currentUsage < this.maxMemoryUsage;
      
      if (!result) {
        Logger.warn(TAG, `Memory usage too high: ${(currentUsage * 100).toFixed(1)}% (max: ${(this.maxMemoryUsage * 100).toFixed(0)}%)`);
      }
      
      return result;
    } catch (error) {
      Logger.error(TAG, `Failed to check memory availability: ${error}`);
      // å‡ºé”™æ—¶é»˜è®¤è¿”å›žtrueï¼Œé¿å…åº”ç”¨å´©æº?      return true;
    }
  }

  /**
   * èŽ·å–å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ
   * @returns å†…å­˜ä½¿ç”¨çŽ?(0-1)
   */
  public getCurrentMemoryUsage(): number {
    try {
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»ŸAPIèŽ·å–å†…å­˜ä¿¡æ¯
      // è¿™é‡Œæä¾›ä¸€ä¸ªæ¨¡æ‹Ÿå®žçŽ°ï¼Œå®žé™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®žçš„ç³»ç»ŸAPIè°ƒç”¨
      const totalMemory = this.getTotalMemory();
      const freeMemory = this.getFreeMemory();
      
      if (totalMemory <= 0) {
        return 0;
      }
      
      const usedMemory = totalMemory - freeMemory;
      return usedMemory / totalMemory;
    } catch (error) {
      Logger.error(TAG, `Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}` instanceof Error ? `Failed to get current memory usage: ${error}` : new Error(String(`Failed to get current memory usage: ${error}`)))))));
      return 0.5; // é»˜è®¤è¿”å›ž50%ä½¿ç”¨çŽ?    }
  }

  /**
   * èŽ·å–æ€»å†…å­˜å¤§å°?   * @returns æ€»å†…å­˜å­—èŠ‚æ•°
   */
  private getTotalMemory(): number {
    try {
      // æ¨¡æ‹Ÿå®žçŽ°ï¼Œå®žé™…åº”ä½¿ç”¨ç³»ç»ŸAPI
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡@ohos.systemCapabilityèµ„æºèŽ·å–
      return 8 * 1024 * 1024 * 1024; // å‡è®¾8GBå†…å­˜
    } catch (error) {
      Logger.error(TAG, `Failed to get total memory: ${error}`);
      return 4 * 1024 * 1024 * 1024; // é»˜è®¤4GB
    }
  }

  /**
   * èŽ·å–å¯ç”¨å†…å­˜å¤§å°
   * @returns å¯ç”¨å†…å­˜å­—èŠ‚æ•?   */
  private getFreeMemory(): number {
    try {
      // æ¨¡æ‹Ÿå®žçŽ°ï¼Œå®žé™…åº”ä½¿ç”¨ç³»ç»ŸAPI
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡@ohos.systemCapabilityèµ„æºèŽ·å–
      const total = this.getTotalMemory();
      return total * 0.4; // å‡è®¾40%å¯ç”¨
    } catch (error) {
      Logger.error(TAG, `Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}` instanceof Error ? `Failed to get free memory: ${error}` : new Error(String(`Failed to get free memory: ${error}`)))))));
      return 2 * 1024 * 1024 * 1024; // é»˜è®¤2GB
    }
  }

  /**
   * è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
   * @param usage å½“å‰å†…å­˜ä½¿ç”¨çŽ?   */
  private recordMemoryUsage(usage: number): void {
    this.memoryUsageHistory.push(usage);
    
    // åªä¿ç•™æœ€è¿?00æ¡è®°å½?    if (this.memoryUsageHistory.length > 100) {
      this.memoryUsageHistory.shift();
    }
    
    // å®šæœŸè®°å½•å¹³å‡å†…å­˜ä½¿ç”¨æƒ…å†µ
    const now = Date.now();
    if (now - this.lastCheckTime > this.checkInterval) {
      this.lastCheckTime = now;
      this.logAverageMemoryUsage();
    }
  }

  /**
   * è®°å½•å¹³å‡å†…å­˜ä½¿ç”¨æƒ…å†µ
   */
  private logAverageMemoryUsage(): void {
    if (this.memoryUsageHistory.length === 0) return;
    
    const sum = this.memoryUsageHistory.reduce((acc, val) => acc + val, 0);
    const average = sum / this.memoryUsageHistory.length;
    
    Logger.info(TAG, `Average memory usage: ${(average * 100).toFixed(1)}%`);
  }

  /**
   * å¼€å§‹å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†?   */
  private startPeriodicCheck(): void {
    setInterval(() => {
      try {
        const usage = this.getCurrentMemoryUsage();
        this.recordMemoryUsage(usage);
        
        if (usage > this.maxMemoryUsage * 0.9) {
          Logger.warn(TAG, `Memory usage approaching limit: ${(usage * 100).toFixed(1)}%`);
        }
      } catch (error) {
        Logger.error(TAG, `Periodic memory check failed: ${error}`);
      }
    }, this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval : new Error(String(this.checkInterval instanceof Error ? this.checkInterval : new Error(String(this.checkInterval)))))));
  }

  /**
   * æ¸…ç†å†…å­˜ï¼ˆå¦‚æžœå¯èƒ½ï¼‰
   */
  public clearMemory(): void {
    try {
      Logger.info(TAG, 'Attempting to clear memory');
      
      // HarmonyOSä¸­ä¸æ”¯æŒç›´æŽ¥è°ƒç”¨åžƒåœ¾å›žæ”¶
      // ç§»é™¤å¯¹globalThis.gcçš„ä¾èµ–ï¼Œä½¿ç”¨ç³»ç»ŸæŽ¨èçš„å†…å­˜ç®¡ç†æ–¹å¼?      Logger.info(TAG, 'Memory cleanup performed (HarmonyOS compatible)');
      
      // æ¸…ç†åŽ†å²è®°å½•
      this.memoryUsageHistory = [];
    } catch (error) {
      Logger.error(TAG, `Failed to clear memory: ${error}`);
    }
  }

  /**
   * èŽ·å–å†…å­˜ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯
   * @returns å†…å­˜ä½¿ç”¨ç»Ÿè®¡
   */
  public getMemoryStats(): {
    currentUsage: number;
    averageUsage: number;
    maxUsage: number;
    minUsage: number;
  } {
    const current = this.getCurrentMemoryUsage();
    let average = 0;
    let max = 0;
    let min = 1;
    
    if (this.memoryUsageHistory.length > 0) {
      const sum = this.memoryUsageHistory.reduce((acc, val instanceof Error ? val : new Error(String(val instanceof Error ? val instanceof Error ? val : new Error(String(val : new Error(String(val instanceof Error ? val : new Error(String(val instanceof Error ? val instanceof Error ? val : new Error(String(val instanceof Error ? val instanceof Error ? val : new Error(String(val : new Error(String(val instanceof Error ? val : new Error(String(val : new Error(String(val instanceof Error ? val : new Error(String(val instanceof Error ? val instanceof Error ? val : new Error(String(val : new Error(String(val instanceof Error ? val : new Error(String(val))))))) => acc + val, 0);
      average = sum / this.memoryUsageHistory.length;
      // ArkTSå…¼å®¹ï¼šä½¿ç”¨ç›´æŽ¥è°ƒç”¨æ›¿ä»£apply
      max = Math.max(...this.memoryUsageHistory);
      min = Math.min(...this.memoryUsageHistory);
    } else {
      average = current;
      max = current;
      min = current;
    }
    
    return {
      currentUsage: current,
      averageUsage: average,
      maxUsage: max,
      minUsage: min
    };
  }
}


