// TypeUtils.ets - ArkTSå…¼å®¹çš„ç±»å‹å·¥å…·å‡½æ•?
/**
 * ç±»å‹å·¥å…·å‡½æ•°
 * æä¾›ArkTSç¯å¢ƒä¸­å®‰å…¨çš„ç±»å‹æ£€æŸ¥å’Œè½¬æ¢åŠŸèƒ½
 */
import { SafeAny, SafeObject, isNonNull, Optional } from './types/ArkTSBaseTypes';

/**
 * ç±»å‹å·¥å…·å‡½æ•°é›†åˆ
 */
export const TypeUtils = {
  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ç±»å?   */
  isString(value: SafeAny): boolean {
    return typeof value === 'string';
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°å­—ç±»å‹
   */
  isNumber(value: SafeAny): boolean {
    return typeof value === 'number' && !isNaN(value) && isFinite(value);
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå¸ƒå°”ç±»å‹
   */
  isBoolean(value: SafeAny): boolean {
    return typeof value === 'boolean';
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºundefined
   */
  isUndefined(value: SafeAny): boolean {
    return value === undefined;
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºnull
   */
  isNull(value: SafeAny): boolean {
    return value === null;
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºnullæˆ–undefined
   */
  isNullOrUndefined(value: SafeAny): boolean {
    return value === null || value === undefined;
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå¯¹è±¡ç±»å‹
   */
  isObject(value: SafeAny): boolean {
    return value !== null && typeof value === 'object' && !Array.isArray(value);
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°ç»„ç±»å‹
   */
  isArray(value: SafeAny): boolean {
    return Array.isArray(value);
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå‡½æ•°ç±»å‹
   */
  isFunction(value: SafeAny): boolean {
    return typeof value === 'function';
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºDateç±»å‹
   */
  isDate(value: SafeAny): boolean {
    return value instanceof Date && !isNaN(value.getTime());
  },

  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºç©ºï¼ˆnullã€undefinedã€ç©ºå­—ç¬¦ä¸²ã€ç©ºæ•°ç»„ã€ç©ºå¯¹è±¡ï¼?   */
  isEmpty(value: SafeAny): boolean {
    if (value === null || value === undefined) {
      return true;
    }
    
    if (typeof value === 'string') {
      return value.trim().length === 0;
    }
    
    if (Array.isArray(value)) {
      return value.length === 0;
    }
    
    if (typeof value === 'object') {
      // ä½¿ç”¨Object.keysè·å–å±æ€§æ•°é‡ï¼Œé¿å…ä½¿ç”¨hasOwnProperty
      return Object.keys(value).length === 0;
    }
    
    return false;
  },

  /**
   * å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸?   */
  toString(value: SafeAny, defaultValue: string = ''): string {
    if (value === null || value === undefined) {
      return defaultValue;
    }
    
    return String(value);
  },

  /**
   * å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºæ•°å­—
   */
  toNumber(value: SafeAny, defaultValue: number = 0): number {
    if (value === null || value === undefined) {
      return defaultValue;
    }
    
    // ç›´æ¥æ•°å­—ç±»å‹æ£€æŸ?    if (typeof value === 'number') {
      return isFinite(value) ? value : defaultValue;
    }
    
    // å­—ç¬¦ä¸²ç±»å‹è½¬æ?    if (typeof value === 'string') {
      const num = parseFloat(value);
      return isFinite(num) ? num : defaultValue;
    }
    
    return defaultValue;
  },

  /**
   * å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºå¸ƒå°”å€?   */
  toBoolean(value: SafeAny): boolean {
    if (value === null || value === undefined) {
      return false;
    }
    
    // ç›´æ¥å¸ƒå°”ç±»å‹æ£€æŸ?    if (typeof value === 'boolean') {
      return value;
    }
    
    // æ•°å­—ç±»å‹è½¬æ¢
    if (typeof value === 'number') {
      return value !== 0;
    }
    
    // å­—ç¬¦ä¸²ç±»å‹è½¬æ?    if (typeof value === 'string') {
      const lowerValue = value.toLowerCase();
      return lowerValue === 'true' || lowerValue === '1';
    }
    
    return true;
  },

  /**
   * å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºæ•°ç»„
   */
  toArray<T>(value: Optional<T | T[]>, defaultValue: T[] = []): T[] {
    if (value === null || value === undefined) {
      return defaultValue;
    }
    
    if (Array.isArray(value)) {
      return value as T[];
    }
    
    return [value as T];
  },

  /**
   * å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºå¯¹è±¡
   */
  toObject(value: SafeAny): SafeObject {
    if (value === null || value === undefined || typeof value !== 'object' || Array.isArray(value)) {
      return {};
    }
    
    return value as SafeObject;
  },

  /**
   * å®‰å…¨åœ°è·å–å¯¹è±¡å±æ€§å€?   * @param obj - è¦è·å–å±æ€§çš„å¯¹è±¡
   * @param key - å±æ€§é”®å?   * @returns å±æ€§å€¼ï¼Œå¦‚æœå±æ€§ä¸å­˜åœ¨åˆ™è¿”å›undefined
   */
  getPropertyValue(obj: SafeAny, key: string): SafeAny {
    if (!TypeUtils.isObject(obj)) {
      return undefined;
    }
    
    // ä½¿ç”¨ç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼?    const safeObj = obj as Record<string, SafeAny>;
    if (Object.prototype.hasOwnProperty.call(safeObj, key)) {
      return safeObj[key];
    }
    
    return undefined;
  },

  /**
   * åˆ›å»ºç±»å‹å®ˆå«å‡½æ•°
   */
  createTypeGuard<T extends SafeObject>(
    schema: Record<string, (value: SafeAny) => boolean>
  ): (obj: SafeAny) => boolean {
    return (obj: SafeAny): boolean => {
      if (!TypeUtils.isObject(obj)) {
        return false;
      }
      
      // éªŒè¯æ‰€æœ‰å¿…éœ€çš„å±æ€§éƒ½å­˜åœ¨ä¸”ç¬¦åˆç±»å?      for (const [key, validator] of Object.entries(schema)) {
        // ä½¿ç”¨ç±»å‹å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼ï¼Œé¿å…å­—æ®µç´¢å¼•è®¿é—®
        const value = TypeUtils.getPropertyValue(obj, key);
        if (!validator(value)) {
          return false;
        }
      }
      
      return true;
    };
  }
};

export default TypeUtils;
