// DateUtils.ets - ArkTSå…¼å®¹çš„æ—¥æœŸæ—¶é—´å·¥å…·å‡½æ•?
/**
 * æ—¥æœŸæ—¶é—´å·¥å…·å‡½æ•°
 * æä¾›ArkTSç¯å¢ƒä¸­å®‰å…¨çš„æ—¥æœŸæ—¶é—´æ“ä½œåŠŸèƒ½
 */
import { Optional } from './types/ArkTSBaseTypes';
import TypeUtils from './TypeUtils';
import StringUtils from './StringUtils';

/**
 * æ—¥æœŸæ—¶é—´å·¥å…·å‡½æ•°é›†åˆ
 */
export const DateUtils = {
  /**
   * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºDateå¯¹è±¡
   */
  isDate(value: Record<string, string | number | boolean | null>): boolean {
    return value instanceof Date && !isNaN(value.getTime());
  },

  /**
   * è·å–å½“å‰æ—¥æœŸæ—¶é—´
   */
  now(): Date {
    return new Date();
  },

  /**
   * è·å–å½“å‰æ—¶é—´æˆ?   */
  timestamp(): number {
    return Date.now();
  },

  /**
   * åˆ›å»ºæ—¥æœŸå¯¹è±¡
   */
  create(year: number, month: number, date: number = 1, hours: number = 0, minutes: number = 0, seconds: number = 0, milliseconds: number = 0): Date {
    // æ³¨æ„ï¼šJavaScriptä¸­æœˆä»½æ˜¯ä»?å¼€å§‹çš„ï¼Œè¿™é‡Œä¹Ÿéµå¾ªç›¸åŒçš„è§„åˆ?    return new Date(year, month, date, hours, minutes, seconds, milliseconds);
  },

  /**
   * è§£ææ—¥æœŸå­—ç¬¦ä¸?   */
  parse(dateString: Optional<string>): Date | null {
    if (StringUtils.isEmpty(dateString)) {
      return null;
    }
    
    const date = new Date(dateString);
    
    return DateUtils.isDate(date) ? date : null;
  },

  /**
   * è·å–æ—¥æœŸçš„å¹´
   */
  getFullYear(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getFullYear();
  },

  /**
   * è·å–æ—¥æœŸçš„æœˆï¼?-11ï¼?   */
  getMonth(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getMonth();
  },

  /**
   * è·å–æ—¥æœŸçš„æ—¥ï¼?-31ï¼?   */
  getDate(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getDate();
  },

  /**
   * è·å–æ—¥æœŸçš„å°æ—¶ï¼ˆ0-23ï¼?   */
  getHours(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getHours();
  },

  /**
   * è·å–æ—¥æœŸçš„åˆ†é’Ÿï¼ˆ0-59ï¼?   */
  getMinutes(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getMinutes();
  },

  /**
   * è·å–æ—¥æœŸçš„ç§’ï¼?-59ï¼?   */
  getSeconds(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getSeconds();
  },

  /**
   * è·å–æ—¥æœŸçš„æ¯«ç§’ï¼ˆ0-999ï¼?   */
  getMilliseconds(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getMilliseconds();
  },

  /**
   * è·å–æ—¥æœŸçš„æ˜ŸæœŸï¼ˆ0-6ï¼?è¡¨ç¤ºå‘¨æ—¥ï¼?   */
  getDay(date: Optional<Date>): number {
    if (!DateUtils.isDate(date)) {
      return 0;
    }
    
    return date.getDay();
  },

  /**
   * æ ¼å¼åŒ–æ—¥æœŸæ—¶é—?   */
  format(date: Optional<Date>, formatString: string = 'YYYY-MM-DD HH:mm:ss'): string {
    if (!DateUtils.isDate(date)) {
      return '';
    }
    
    const year = DateUtils.getFullYear(date).toString();
    const month = (DateUtils.getMonth(date) + 1).toString().padStart(2, '0');
    const day = DateUtils.getDate(date).toString().padStart(2, '0');
    const hours = DateUtils.getHours(date).toString().padStart(2, '0');
    const minutes = DateUtils.getMinutes(date).toString().padStart(2, '0');
    const seconds = DateUtils.getSeconds(date).toString().padStart(2, '0');
    const milliseconds = DateUtils.getMilliseconds(date).toString().padStart(3, '0');
    
    return formatString
      .replace('YYYY', year)
      .replace('YY', year.slice(-2))
      .replace('MM', month)
      .replace('DD', day)
      .replace('HH', hours)
      .replace('mm', minutes)
      .replace('ss', seconds)
      .replace('SSS', milliseconds);
  },

  /**
   * è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°å·®
   */
  daysBetween(date1: Optional<Date>, date2: Optional<Date>): number {
    if (!DateUtils.isDate(date1) || !DateUtils.isDate(date2)) {
      return 0;
    }
    
    const oneDay = 24 * 60 * 60 * 1000;
    const diffTime = Math.abs(date2.getTime() - date1.getTime());
    
    return Math.floor(diffTime / oneDay);
  },

  /**
   * æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ˜¯ä»Šå¤©
   */
  isToday(date: Optional<Date>): boolean {
    if (!DateUtils.isDate(date)) {
      return false;
    }
    
    const today = DateUtils.now();
    
    return DateUtils.getFullYear(date) === DateUtils.getFullYear(today) &&
           DateUtils.getMonth(date) === DateUtils.getMonth(today) &&
           DateUtils.getDate(date) === DateUtils.getDate(today);
  },

  /**
   * æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ˜¯æ˜¨å¤©
   */
  isYesterday(date: Optional<Date>): boolean {
    if (!DateUtils.isDate(date)) {
      return false;
    }
    
    const yesterday = DateUtils.subDays(DateUtils.now(), 1);
    
    return DateUtils.getFullYear(date) === DateUtils.getFullYear(yesterday) &&
           DateUtils.getMonth(date) === DateUtils.getMonth(yesterday) &&
           DateUtils.getDate(date) === DateUtils.getDate(yesterday);
  },

  /**
   * æ·»åŠ å¤©æ•°
   */
  addDays(date: Optional<Date>, days: number): Date | null {
    if (!DateUtils.isDate(date)) {
      return null;
    }
    
    const result = new Date(date.getTime());
    result.setDate(result.getDate() + days);
    
    return result;
  },

  /**
   * å‡å»å¤©æ•°
   */
  subDays(date: Optional<Date>, days: number): Date | null {
    return DateUtils.addDays(date, -days);
  },

  /**
   * æ·»åŠ æœˆæ•°
   */
  addMonths(date: Optional<Date>, months: number): Date | null {
    if (!DateUtils.isDate(date)) {
      return null;
    }
    
    const result = new Date(date.getTime());
    result.setMonth(result.getMonth() + months);
    
    return result;
  },

  /**
   * å‡å»æœˆæ•°
   */
  subMonths(date: Optional<Date>, months: number): Date | null {
    return DateUtils.addMonths(date, -months);
  },

  /**
   * æ·»åŠ å¹´æ•°
   */
  addYears(date: Optional<Date>, years: number): Date | null {
    if (!DateUtils.isDate(date)) {
      return null;
    }
    
    const result = new Date(date.getTime());
    result.setFullYear(result.getFullYear() + years);
    
    return result;
  },

  /**
   * å‡å»å¹´æ•°
   */
  subYears(date: Optional<Date>, years: number): Date | null {
    return DateUtils.addYears(date, -years);
  },

  /**
   * æ ¼å¼åŒ–æ—¶é•¿ï¼ˆæ¯«ç§’è½¬å¯è¯»æ—¶é—´ï¼‰
   */
  formatDuration(milliseconds: number): string {
    if (!TypeUtils.isNumber(milliseconds) || milliseconds < 0) {
      return '00:00';
    }
    
    const totalSeconds = Math.floor(milliseconds / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    if (hours > 0) {
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  },

  /**
   * è·å–ç›¸å¯¹æ—¶é—´æè¿°
   */
  getRelativeTimeString(date: Optional<Date>): string {
    if (!DateUtils.isDate(date)) {
      return '';
    }
    
    const now = DateUtils.timestamp();
    const targetTime = date.getTime();
    const diff = now - targetTime;
    
    // è½¬æ¢ä¸ºç§’
    const diffSeconds = Math.floor(diff / 1000);
    
    // è½¬æ¢ä¸ºåˆ†é’?    const diffMinutes = Math.floor(diffSeconds / 60);
    
    // è½¬æ¢ä¸ºå°æ—?    const diffHours = Math.floor(diffMinutes / 60);
    
    // è½¬æ¢ä¸ºå¤©
    const diffDays = Math.floor(diffHours / 24);
    
    // è½¬æ¢ä¸ºæœˆï¼ˆè¿‘ä¼¼ï¼‰
    const diffMonths = Math.floor(diffDays / 30);
    
    // è½¬æ¢ä¸ºå¹´ï¼ˆè¿‘ä¼¼ï¼‰
    const diffYears = Math.floor(diffDays / 365);
    
    if (diffYears > 0) {
      return `${diffYears}å¹´å‰`;
    } else if (diffMonths > 0) {
      return `${diffMonths}ä¸ªæœˆå‰`;
    } else if (diffDays > 0) {
      return `${diffDays}å¤©å‰`;
    } else if (diffHours > 0) {
      return `${diffHours}å°æ—¶å‰`;
    } else if (diffMinutes > 0) {
      return `${diffMinutes}åˆ†é’Ÿå‰`;
    } else if (diffSeconds > 0) {
      return `${diffSeconds}ç§’å‰`;
    } else {
      return 'åˆšåˆš';
    }
  }
};

export default DateUtils;

