// StorageUtils.ets - ArkTSå…¼å®¹çš„å­˜å‚¨å·¥å…·å‡½æ•?

/**
 * å­˜å‚¨å·¥å…·å‡½æ•°
 * æä¾›ArkTSç¯å¢ƒä¸­å®‰å…¨çš„æ•°æ®æŒä¹…åŒ–æ“ä½œåŠŸèƒ?
 */
import { Optional, SafeAny } from './types/ArkTSBaseTypes';
import TypeUtils from './TypeUtils';
import StringUtils from './StringUtils';

/**
 * å­˜å‚¨å·¥å…·å‡½æ•°é›†åˆ
 */
export const StorageUtils = {
  /**
   * æ£€æŸ¥æ˜¯å¦æ”¯æŒæœ¬åœ°å­˜å‚?
   */
  isSupported(): boolean {
    try {
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨localStorageå¯¹è±¡
      return typeof localStorage !== 'undefined';
    } catch (e) {
      return false;
    }
  },

  /**
   * è®¾ç½®å­˜å‚¨é¡?
   */
  setItem(key: string, value: SafeAny): boolean {
    if (!StorageUtils.isSupported() || StringUtils.isEmpty(key)) {
      return false;
    }
    
    try {
      const stringValue = TypeUtils.isString(value) ? value : JSON.stringify(value);
      localStorage.setItem(key, stringValue);
      return true;
    } catch (e) {
      console.error('StorageUtils.setItem error:', e);
      return false;
    }
  },

  /**
   * è·å–å­˜å‚¨é¡?
   */
  getItem<T = string>(key: string): T | null {
    if (!StorageUtils.isSupported() || StringUtils.isEmpty(key)) {
      return null;
    }
    
    try {
      const value = localStorage.getItem(key);
      
      if (value === null) {
        return null;
      }
      
      // å°è¯•è§£æJSONï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›åŸå§‹å­—ç¬¦ä¸?
      try {
        return JSON.parse(value) as T;
      } catch {
        // å½“JSONè§£æå¤±è´¥æ—¶ï¼Œè¿”å›nullè€Œä¸æ˜¯è¿›è¡Œä¸å®‰å…¨çš„ç±»å‹è½¬æ?
        return null as unknown as T;
      }
    } catch (e) {
      console.error('StorageUtils.getItem error:', e);
      return null;
    }
  },

  /**
   * è·å–å­—ç¬¦ä¸²ç±»å‹å­˜å‚¨é¡¹
   */
  getString(key: string): string | null {
    return StorageUtils.getItem<string>(key);
  },

  /**
   * è·å–æ•°å­—ç±»å‹å­˜å‚¨é¡?
   */
  getNumber(key: string): number | null {
    const value = StorageUtils.getItem(key);
    return TypeUtils.isNumber(value) ? value : null;
  },

  /**
   * è·å–å¸ƒå°”ç±»å‹å­˜å‚¨é¡?
   */
  getBoolean(key: string): boolean | null {
    const value = StorageUtils.getItem(key);
    return TypeUtils.isBoolean(value) ? value : null;
  },

  /**
   * è·å–å¯¹è±¡ç±»å‹å­˜å‚¨é¡?
   */
  getObject<T>(key: string): T | null {
    const value = StorageUtils.getItem<T>(key);
    return TypeUtils.isObject(value) ? value : null;
  },

  /**
   * è·å–æ•°ç»„ç±»å‹å­˜å‚¨é¡?
   */
  getArray<T>(key: string): T[] | null {
    const value = StorageUtils.getItem<T[]>(key);
    return Array.isArray(value) ? value : null;
  },

  /**
   * ç§»é™¤å­˜å‚¨é¡?
   */
  removeItem(key: string): boolean {
    if (!StorageUtils.isSupported() || StringUtils.isEmpty(key)) {
      return false;
    }
    
    try {
      localStorage.removeItem(key);
      return true;
    } catch (e) {
      console.error('StorageUtils.removeItem error:', e);
      return false;
    }
  },

  /**
   * æ¸…ç©ºæ‰€æœ‰å­˜å‚¨é¡¹
   */
  clear(): boolean {
    if (!StorageUtils.isSupported()) {
      return false;
    }
    
    try {
      localStorage.clear();
      return true;
    } catch (e) {
      console.error('StorageUtils.clear error:', e);
      return false;
    }
  },

  /**
   * æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­˜å‚¨é¡?
   */
  hasItem(key: string): boolean {
    if (!StorageUtils.isSupported() || StringUtils.isEmpty(key)) {
      return false;
    }
    
    try {
      return localStorage.getItem(key) !== null;
    } catch (e) {
      console.error('StorageUtils.hasItem error:', e);
      return false;
    }
  },

  /**
   * è·å–å­˜å‚¨é¡¹æ•°é‡?
   */
  getLength(): number {
    if (!StorageUtils.isSupported()) {
      return 0;
    }
    
    try {
      return localStorage.length;
    } catch (e) {
      console.error('StorageUtils.getLength error:', e);
      return 0;
    }
  },

  /**
   * è·å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å­˜å‚¨é¡¹é”®å
   */
  getKey(index: number): string | null {
    if (!StorageUtils.isSupported() || !TypeUtils.isNumber(index) || index < 0) {
      return null;
    }
    
    try {
      return localStorage.key(index);
    } catch (e) {
      console.error('StorageUtils.getKey error:', e);
      return null;
    }
  },

  /**
   * è·å–æ‰€æœ‰å­˜å‚¨é¡¹çš„é”®ååˆ—è¡?
   */
  getAllKeys(): string[] {
    const keys: string[] = [];
    
    if (!StorageUtils.isSupported()) {
      return keys;
    }
    
    try {
      const length = localStorage.length;
      
      for (let i = 0; i < length; i++) {
        const key = localStorage.key(i);
        if (key) {
          keys.push(key);
        }
      }
    } catch (e) {
      console.error('StorageUtils.getAllKeys error:', e);
    }
    
    return keys;
  },

  /**
   * è·å–æ‰€æœ‰å­˜å‚¨é¡¹
   */
  getAllItems(): Record<string, SafeAny> {
    const items: Record<string, SafeAny> = {};
    
    if (!StorageUtils.isSupported()) {
      return items;
    }
    
    try {
      const keys = StorageUtils.getAllKeys();
      
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        items[key] = StorageUtils.getItem(key);
      }
    } catch (e) {
      console.error('StorageUtils.getAllItems error:', e);
    }
    
    return items;
  },

  /**
   * æ‰¹é‡è®¾ç½®å­˜å‚¨é¡?
   */
  setMultiple(items: Record<string, SafeAny>): boolean {
    if (!StorageUtils.isSupported() || !TypeUtils.isObject(items)) {
      return false;
    }
    
    try {
      const keys = Object.keys(items);
      let success = true;
      
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const value = items[key];
        
        if (!StorageUtils.setItem(key, value)) {
          success = false;
        }
      }
      
      return success;
    } catch (e) {
      console.error('StorageUtils.setMultiple error:', e);
      return false;
    }
  },

  /**
   * æ‰¹é‡è·å–å­˜å‚¨é¡?
   */
  getMultiple(keys: string[]): Record<string, SafeAny> {
    const items: Record<string, SafeAny> = {};
    
    if (!StorageUtils.isSupported() || !Array.isArray(keys)) {
      return items;
    }
    
    try {
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        if (StringUtils.isNotEmpty(key)) {
          items[key] = StorageUtils.getItem(key);
        }
      }
    } catch (e) {
      console.error('StorageUtils.getMultiple error:', e);
    }
    
    return items;
  },

  /**
   * æ‰¹é‡ç§»é™¤å­˜å‚¨é¡?
   */
  removeMultiple(keys: string[]): boolean {
    if (!StorageUtils.isSupported() || !Array.isArray(keys)) {
      return false;
    }
    
    try {
      let success = true;
      
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        if (!StorageUtils.removeItem(key)) {
          success = false;
        }
      }
      
      return success;
    } catch (e) {
      console.error('StorageUtils.removeMultiple error:', e);
      return false;
    }
  },

  /**
   * è·å–å­˜å‚¨ä½¿ç”¨æƒ…å†µï¼ˆè¿‘ä¼¼å€¼ï¼‰
   */
  getStorageUsage(): number {
    if (!StorageUtils.isSupported()) {
      return 0;
    }
    
    try {
      let size = 0;
      const keys = StorageUtils.getAllKeys();
      
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const value = localStorage.getItem(key);
        
        if (value) {
          // ä¼°ç®—å­—ç¬¦ä¸²å¤§å°ï¼ˆUTF-16ç¼–ç ï¼Œæ¯ä¸ªå­—ç¬?å­—èŠ‚ï¼?
          size += (key.length + value.length) * 2;
        }
      }
      
      return size; // è¿”å›å­—èŠ‚æ•?
    } catch (e) {
      console.error('StorageUtils.getStorageUsage error:', e);
      return 0;
    }
  },

  /**
   * åˆ›å»ºå¸¦å‘½åç©ºé—´çš„å­˜å‚¨é”?
   */
  createNamespacedKey(namespace: string, key: string): string {
    if (StringUtils.isEmpty(namespace)) {
      return key;
    }
    
    return `${namespace}.${key}`;
  },

  /**
   * åˆ›å»ºå‘½åç©ºé—´å­˜å‚¨
   */
  createNamespacedStorage(namespace: string): typeof StorageUtils {
    if (StringUtils.isEmpty(namespace)) {
      return StorageUtils;
    }
    
    const createNamespacedMethod = (originalMethod: Function) => {
      return function(this: typeof StorageUtils, ...args: SafeAny[]) {
        // å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²é”®åï¼Œåˆ™æ·»åŠ å‘½åç©ºé—?
        if (args.length > 0 && TypeUtils.isString(args[0])) {
          args[0] = StorageUtils.createNamespacedKey(namespace, args[0]);
        }
        
        return originalMethod.apply(this, args);
      };
    };
    
    return {
      ...StorageUtils,
      setItem: createNamespacedMethod(StorageUtils.setItem),
      getItem: createNamespacedMethod(StorageUtils.getItem),
      getString: createNamespacedMethod(StorageUtils.getString),
      getNumber: createNamespacedMethod(StorageUtils.getNumber),
      getBoolean: createNamespacedMethod(StorageUtils.getBoolean),
      getObject: createNamespacedMethod(StorageUtils.getObject),
      getArray: createNamespacedMethod(StorageUtils.getArray),
      removeItem: createNamespacedMethod(StorageUtils.removeItem),
      hasItem: createNamespacedMethod(StorageUtils.hasItem)
    };
  }
};

export default StorageUtils;
