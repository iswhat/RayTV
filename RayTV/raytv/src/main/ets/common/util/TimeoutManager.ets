// TimeoutManager - è¶…æ—¶ç®¡ç†å·¥å…·ç±?import Logger from './Logger';

const TAG = 'TimeoutManager';

/**
 * è¶…æ—¶ç®¡ç†å™? * æä¾›ç»Ÿä¸€çš„è¶…æ—¶æ§åˆ¶å’Œç®¡ç†åŠŸèƒ½
 */
export default class TimeoutManager {
  private static instance: TimeoutManager;
  private timeouts: Map<string, number> = new Map();
  private defaultTimeout: number = 30000; // é»˜è®¤30ç§’è¶…æ—?
  /**
   * ç§æœ‰æ„é€ å‡½æ•?   */
  private constructor() {
    Logger.info(TAG, 'TimeoutManager initialized');
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): TimeoutManager {
    if (!TimeoutManager.instance) {
      TimeoutManager.instance = new TimeoutManager();
    }
    return TimeoutManager.instance;
  }

  /**
   * è®¾ç½®é»˜è®¤è¶…æ—¶æ—¶é—´
   * @param milliseconds é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   */
  public setDefaultTimeout(milliseconds: number): void {
    if (milliseconds > 0) {
      this.defaultTimeout = milliseconds;
      Logger.info(TAG, `Default timeout set to: ${milliseconds}ms`);
    }
  }

  /**
   * åˆ›å»ºè¶…æ—¶ä»»åŠ¡
   * @param id è¶…æ—¶ä»»åŠ¡ID
   * @param callback è¶…æ—¶å›è°ƒå‡½æ•°
   * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤å€?   */
  public setTimeout(id: string, callback: () => void, timeout?: number): void {
    // æ¸…é™¤å·²å­˜åœ¨çš„ç›¸åŒIDçš„è¶…æ—¶ä»»åŠ?    this.clearTimeout(id);

    // è®¾ç½®æ–°çš„è¶…æ—¶ä»»åŠ¡
    const actualTimeout = timeout || this.defaultTimeout;
    const timerId = setTimeout(() => {
      try {
        this.timeouts.delete(id);
        callback();
      } catch (error) {
        Logger.error(TAG, `Error in timeout callback for ${id}: ${error}`);
      }
    }, actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout : new Error(String(actualTimeout instanceof Error ? actualTimeout : new Error(String(actualTimeout)))))));

    this.timeouts.set(id, timerId);
    Logger.debug(TAG, `Timeout set for ${id}: ${actualTimeout}ms`);
  }

  /**
   * æ¸…é™¤æŒ‡å®šIDçš„è¶…æ—¶ä»»åŠ?   * @param id è¶…æ—¶ä»»åŠ¡ID
   * @returns æ˜¯å¦æˆåŠŸæ¸…é™¤
   */
  public clearTimeout(id: string): boolean {
    const timerId = this.timeouts.get(id);
    if (timerId) {
      clearTimeout(timerId);
      this.timeouts.delete(id);
      Logger.debug(TAG, `Timeout cleared for ${id}`);
      return true;
    }
    return false;
  }

  /**
   * æ¸…é™¤æ‰€æœ‰è¶…æ—¶ä»»åŠ?   */
  public clearAllTimeouts(): void {
    for (const [id, timerId] of this.timeouts) {
      clearTimeout(timerId);
    }
    const count = this.timeouts.size;
    this.timeouts.clear();
    Logger.info(TAG, `Cleared all ${count} timeouts`);
  }

  /**
   * åˆ›å»ºå¸¦è¶…æ—¶çš„Promise
   * @param promise åŸå§‹Promise
   * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   * @param timeoutMessage è¶…æ—¶é”™è¯¯æ¶ˆæ¯
   * @returns åŒ…è£…åçš„Promise
   */
  public withTimeout<T>(
    promise: Promise<T>,
    timeout?: number,
    timeoutMessage?: string
  ): Promise<T> {
    const actualTimeout = timeout || this.defaultTimeout;
    const id = `promise_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    return new Promise<T>((resolve, reject) => {
      // è®¾ç½®è¶…æ—¶
      this.setTimeout(
        id,
        () => {
          reject(new Error(timeoutMessage || `Operation timed out after ${actualTimeout}ms`));
        },
        actualTimeout
      );

      // å¤„ç†åŸå§‹Promise
      promise
        .then((result) => {
          this.clearTimeout(id);
          resolve(result);
        })
        .catch((error) => {
          this.clearTimeout(id);
          reject(error);
        });
    });
  }

  /**
   * è·å–å½“å‰æ´»è·ƒçš„è¶…æ—¶ä»»åŠ¡æ•°é‡?   */
  public getActiveTimeoutCount(): number {
    return this.timeouts.size;
  }

  /**
   * æ£€æŸ¥æŒ‡å®šIDçš„è¶…æ—¶ä»»åŠ¡æ˜¯å¦å­˜åœ?   * @param id è¶…æ—¶ä»»åŠ¡ID
   * @returns æ˜¯å¦å­˜åœ¨
   */
  public hasTimeout(id: string): boolean {
    return this.timeouts.has(id);
  }

  /**
   * åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„å»¶è¿Ÿå‡½æ•?   * @param delay å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   * @returns åŒ…å«promiseå’Œcancelæ–¹æ³•çš„å¯¹è±?   */
  public delay(delay: number): {
    promise: Promise<void>;
    cancel: () => void;
  } {
    const id = `delay_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    let cancelled = false;

    const promise = new Promise<void>((resolve) => {
      this.setTimeout(id, () => {
        if (!cancelled) {
          resolve();
        }
      }, delay);
    });

    const cancel = () => {
      cancelled = true;
      this.clearTimeout(id);
    };

    return { promise, cancel };
  }

  /**
   * åˆ›å»ºé‡è¯•æœºåˆ¶ï¼Œå¸¦è¶…æ—¶æ§åˆ¶
   * @param fn è¦é‡è¯•çš„å‡½æ•°
   * @param options é‡è¯•é€‰é¡¹
   * @returns æ‰§è¡Œç»“æœ
   */
  public async withRetry<T>(
    fn: () => Promise<T>,
    options: {
      maxRetries?: number;
      retryDelay?: number;
      timeout?: number;
      onRetry?: (attempt: number, error: Error) => void;
    } = {}
  ): Promise<T> {
    try {
      const maxRetries = options.maxRetries ?? 3;
      const retryDelay = options.retryDelay ?? 1000;
      const timeout = options.timeout;
      const onRetry = options.onRetry;
      let lastError: Error | null = null;

      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          // ä½¿ç”¨å¸¦è¶…æ—¶çš„Promiseæ‰§è¡Œå‡½æ•°
          return await this.withTimeout(fn(), timeout);
        } catch (error) {
          lastError = error instanceof Error ? error : new Error(String(error));

          // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œåˆ™æŠ›å‡ºé”™è¯?          if (attempt >= maxRetries) {
            Logger.error(TAG, `All ${maxRetries + 1} attempts failed: ${lastError.message}`);
            throw lastError;
          }

          // è°ƒç”¨é‡è¯•å›è°ƒ
          if (onRetry) {
            try {
              onRetry(attempt + 1, lastError instanceof Error ? lastError : new Error(String(lastError instanceof Error ? lastError instanceof Error ? lastError : new Error(String(lastError : new Error(String(lastError instanceof Error ? lastError : new Error(String(lastError instanceof Error ? lastError instanceof Error ? lastError : new Error(String(lastError instanceof Error ? lastError instanceof Error ? lastError : new Error(String(lastError : new Error(String(lastError instanceof Error ? lastError : new Error(String(lastError : new Error(String(lastError instanceof Error ? lastError : new Error(String(lastError instanceof Error ? lastError instanceof Error ? lastError : new Error(String(lastError : new Error(String(lastError instanceof Error ? lastError : new Error(String(lastError)))))));
            } catch (callbackError) {
              Logger.error(TAG, `Error in retry callback: ${callbackError instanceof Error ? callbackError.message : String(callbackError)}`);
            }
          }

          Logger.warn(TAG, `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` instanceof Error ? `Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}` : new Error(String(`Attempt ${attempt + 1} failed, retrying in ${retryDelay}ms: ${lastError.message}`)))))));

          // ç­‰å¾…é‡è¯•å»¶è¿Ÿ
          await new Promise((resolve) => setTimeout(resolve, retryDelay));
        }
      }

      // è¿™ä¸€è¡Œç†è®ºä¸Šä¸ä¼šæ‰§è¡Œåˆ°ï¼Œä½†ä¸ºäº†ç±»å‹å®‰å…?      const finalError = lastError || new Error('Retry failed without error');
      Logger.error(TAG, 'Unexpected end of retry loop: ' + finalError.message);
      throw finalError;
    } catch (error) {
      // ç¡®ä¿æŠ›å‡ºçš„æ€»æ˜¯Errorç±»å‹
      const finalError = error instanceof Error ? error : new Error(String(error));
      Logger.error(TAG, `Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}` instanceof Error ? `Error in withRetry method: ${finalError.message}` : new Error(String(`Error in withRetry method: ${finalError.message}`)))))));
      throw finalError;
    }
  }
}


