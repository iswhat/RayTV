// HomePage.ets - ä¸»é¡µé¢ç»„ä»¶
import VideoCard from '../view/VideoCard';
import CategoryNavigation from '../view/CategoryNavigation';
import { VideoType } from '../../data/model/Movie';
import { PlaybackStatus } from '../../service/player/PlayerService';
import PlayerController from '../view/PlayerController';

interface MovieData {
  id: string;
  title: string;
  coverUrl: string;
  type: VideoType;
  year: string;
  rating: number;
  isNew?: boolean;
  isFavorite?: boolean;
}

@Component
export default struct HomePage {
  @State selectedCategory: string = 'recommend';
  @State showPlayerController: boolean = false;
  @State currentTime: number = 0;
  @State totalTime: number = 3600;
  @State volume: number = 0.8;
  @State isMuted: boolean = false;
  @State isFullscreen: boolean = false;
  @State isBuffering: boolean = false;
  @State playbackStatus: PlaybackStatus = PlaybackStatus.PAUSED;
  
  // æ¨¡æ‹Ÿåˆ†ç±»æ•°æ®
  categories: any[] = [
    { id: 'recommend', name: 'æ¨è', icon: 'ğŸŒŸ' },
    { id: 'movie', name: 'ç”µå½±', icon: 'ğŸ¬' },
    { id: 'tv', name: 'å‰§é›†', icon: 'ğŸ“º' },
    { id: 'variety', name: 'ç»¼è‰º', icon: 'ğŸ­' },
    { id: 'anime', name: 'åŠ¨æ¼«', icon: 'ğŸ¤–' },
    { id: 'documentary', name: 'çºªå½•ç‰‡', icon: 'ğŸ“¹' },
    { id: 'kids', name: 'å„¿ç«¥', icon: 'ğŸ‘¶' },
    { id: 'sports', name: 'ä½“è‚²', icon: 'âš½' }
  ];
  
  // æ¨¡æ‹Ÿè§†é¢‘æ•°æ®
  featuredMovies: MovieData[] = [
    {
      id: '1',
      title: 'æ˜Ÿé™…ç©¿è¶Š',
      coverUrl: 'https://example.com/interstellar.jpg',
      type: VideoType.MOVIE,
      year: '2014',
      rating: 9.3,
      isNew: false,
      isFavorite: true
    },
    {
      id: '2',
      title: 'æµæµªåœ°çƒ2',
      coverUrl: 'https://example.com/the_wandering_earth_2.jpg',
      type: VideoType.MOVIE,
      year: '2023',
      rating: 8.7,
      isNew: true,
      isFavorite: false
    },
    {
      id: '3',
      title: 'ä¸‰ä½“',
      coverUrl: 'https://example.com/three_body.jpg',
      type: VideoType.TV,
      year: '2023',
      rating: 8.4,
      isNew: false,
      isFavorite: false
    },
    {
      id: '4',
      title: 'ç‹‚é£™',
      coverUrl: 'https://example.com/the_knockout.jpg',
      type: VideoType.TV,
      year: '2023',
      rating: 9.1,
      isNew: false,
      isFavorite: true
    },
    {
      id: '5',
      title: 'æ»¡æ±Ÿçº¢',
      coverUrl: 'https://example.com/full_river_red.jpg',
      type: VideoType.MOVIE,
      year: '2023',
      rating: 7.8,
      isNew: true,
      isFavorite: false
    },
    {
      id: '6',
      title: 'æ¼«é•¿çš„å­£èŠ‚',
      coverUrl: 'https://example.com/long_season.jpg',
      type: VideoType.TV,
      year: '2023',
      rating: 9.5,
      isNew: false,
      isFavorite: true
    }
  ];
  
  // å¤„ç†åˆ†ç±»åˆ‡æ¢
  handleCategoryChange(categoryId: string) {
    this.selectedCategory = categoryId;
    // TODO: åŠ è½½å¯¹åº”åˆ†ç±»çš„å†…å®¹
  }
  
  // å¤„ç†è§†é¢‘ç‚¹å‡»
  handleVideoPress(movie: MovieData) {
    console.log(`æ’­æ”¾è§†é¢‘: ${movie.title}`);
    // æ˜¾ç¤ºæ’­æ”¾å™¨æ§åˆ¶ç•Œé¢
    this.showPlayerController = true;
    this.playbackStatus = PlaybackStatus.PLAYING;
    // TODO: è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡æ’­æ”¾è§†é¢‘
  }
  
  // å¤„ç†æ”¶è—æŒ‰é’®ç‚¹å‡»
  handleFavoritePress(movieId: string) {
    console.log(`æ”¶è—/å–æ¶ˆæ”¶è—: ${movieId}`);
    // TODO: è°ƒç”¨æ”¶è—æœåŠ¡æ›´æ–°æ”¶è—çŠ¶æ€
  }
  
  // å¤„ç†æ’­æ”¾/æš‚åœ
  handlePlayPause() {
    this.playbackStatus = this.playbackStatus === PlaybackStatus.PLAYING 
      ? PlaybackStatus.PAUSED 
      : PlaybackStatus.PLAYING;
    // TODO: è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡æ§åˆ¶æ’­æ”¾çŠ¶æ€
  }
  
  // å¤„ç†è¿›åº¦æ¡æ‹–åŠ¨
  handleSeek(time: number) {
    this.currentTime = time;
    // TODO: è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡æ›´æ–°æ’­æ”¾è¿›åº¦
  }
  
  // å¤„ç†éŸ³é‡å˜åŒ–
  handleVolumeChange(volume: number) {
    this.volume = volume;
    if (volume > 0 && this.isMuted) {
      this.isMuted = false;
    }
    // TODO: è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡æ›´æ–°éŸ³é‡
  }
  
  // å¤„ç†é™éŸ³åˆ‡æ¢
  handleToggleMute() {
    this.isMuted = !this.isMuted;
    // TODO: è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡åˆ‡æ¢é™éŸ³çŠ¶æ€
  }
  
  // å¤„ç†å…¨å±åˆ‡æ¢
  handleToggleFullscreen() {
    this.isFullscreen = !this.isFullscreen;
    // TODO: è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡åˆ‡æ¢å…¨å±çŠ¶æ€
  }
  
  // å¤„ç†è¿”å›æŒ‰é’®
  handleBack() {
    this.showPlayerController = false;
    // TODO: å¤„ç†è¿”å›é€»è¾‘
  }
  
  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('RayTV')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .marginLeft(20)
            .marginTop(10)
          
          Row() {
            Button() {
              Text('ğŸ”')
                .fontSize(20)
            }
            .width(48)
            .height(48)
            .marginRight(16)
            
            Button() {
              Text('â­')
                .fontSize(20)
            }
            .width(48)
            .height(48)
            .marginRight(20)
          }
          .marginLeft('auto')
        }
        .width('100%')
        .height(60)
        .alignItems(VerticalAlign.Center)
        .backgroundColor('#1a1a1a')
        
        // åˆ†ç±»å¯¼èˆª
        CategoryNavigation({
          categories: this.categories,
          selectedCategoryId: this.selectedCategory,
          onCategoryChange: this.handleCategoryChange.bind(this),
          showScrollButtons: true
        })
        
        // å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            // ç²¾é€‰å†…å®¹æ ‡é¢˜
            Text('ç²¾é€‰æ¨è')
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .marginTop(20)
              .marginLeft(20)
              .marginBottom(16)
            
            // ç²¾é€‰å†…å®¹æ¨ªå‘æ»šåŠ¨
            Scroll() {
              Row() {
                ForEach(this.featuredMovies, (movie) => {
                  VideoCard({
                    id: movie.id,
                    title: movie.title,
                    coverUrl: movie.coverUrl,
                    type: movie.type,
                    year: movie.year,
                    rating: movie.rating,
                    isNew: movie.isNew,
                    isFavorite: movie.isFavorite,
                    onPress: () => this.handleVideoPress(movie),
                    onFavorite: () => this.handleFavoritePress(movie.id),
                    width: 300,
                    aspectRatio: 0.5625
                  })
                  .marginRight(16)
                })
              }
              .paddingLeft(20)
              .paddingRight(20)
              .paddingBottom(20)
            }
            .scrollable(ScrollDirection.Horizontal)
            .scrollBar(BarState.Auto)
            
            // å…¶ä»–å†…å®¹åŒºå—å¯ä»¥åœ¨è¿™é‡Œç»§ç»­æ·»åŠ ...
            Text('çƒ­é—¨ç”µå½±')
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .marginTop(20)
              .marginLeft(20)
              .marginBottom(16)
            
            // çƒ­é—¨ç”µå½±ç½‘æ ¼å¸ƒå±€
            Grid() {
              ForEach(this.featuredMovies.filter(m => m.type === VideoType.MOVIE), (movie) => {
                GridItem() {
                  VideoCard({
                    id: movie.id,
                    title: movie.title,
                    coverUrl: movie.coverUrl,
                    type: movie.type,
                    year: movie.year,
                    rating: movie.rating,
                    isNew: movie.isNew,
                    isFavorite: movie.isFavorite,
                    onPress: () => this.handleVideoPress(movie),
                    onFavorite: () => this.handleFavoritePress(movie.id),
                    width: '100%',
                    aspectRatio: 0.75
                  })
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr 1fr')
            .columnsGap(16)
            .rowsGap(20)
            .paddingLeft(20)
            .paddingRight(20)
            .paddingBottom(20)
          }
          .width('100%')
        }
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .flexGrow(1)
        .backgroundColor('#121212')
      }
      .width('100%')
      .height('100%')
      
      // æ’­æ”¾å™¨æ§åˆ¶ç•Œé¢
      if (this.showPlayerController) {
        PlayerController({
          status: this.playbackStatus,
          currentTime: this.currentTime,
          totalTime: this.totalTime,
          volume: this.volume,
          isMuted: this.isMuted,
          isFullscreen: this.isFullscreen,
          isBuffering: this.isBuffering,
          title: 'å½“å‰æ’­æ”¾',
          subtitle: 'ç²¾å½©å†…å®¹æ­£åœ¨æ’­æ”¾',
          onPlayPause: this.handlePlayPause.bind(this),
          onSeek: this.handleSeek.bind(this),
          onVolumeChange: this.handleVolumeChange.bind(this),
          onToggleMute: this.handleToggleMute.bind(this),
          onToggleFullscreen: this.handleToggleFullscreen.bind(this),
          onBack: this.handleBack.bind(this),
          showController: this.showPlayerController
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}