import { Button, Divider, SearchBar, Swiper, SwiperItem } from '@kit.ArkUI';
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { configService } from '../service/config/ConfigService';
import { mediaService } from '../service/media/MediaService';
import { historyService } from '../service/media/HistoryService';
import { favoriteService } from '../service/media/FavoriteService';
import { playbackService } from '../service/playback/PlaybackService';
// ç±»å‹å®šä¹‰
export interface MediaItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  score?: string;
  year?: string;
  status?: string;
}

export interface MediaDetail {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  description?: string;
  score?: string;
  year?: string;
  type?: string;
  status?: string;
  episodes?: Episode[];
  directors?: string[];
  actors?: string[];
  genres?: string[];
  regions?: string[];
}

export interface Episode {
  id: string;
  name: string;
  season?: number;
  episode?: number;
}

export interface PlaySource {
  id?: string;
  name?: string;
  quality?: string;
  url?: string;
  description?: string;
}

export interface FavoriteItem {
  id: string;
  mediaId: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  favoriteTime: number;
}

export interface HistoryItem {
  id: string;
  mediaId: string;
  siteKey: string;
  episodeId: string;
  title: string;
  coverUrl: string;
  episodeName: string;
  currentTime: number;
  duration: number;
  lastPlayTime: number;
}

export interface WatchHistory {
  mediaId: string;
  episodeId: string;
  position: number;
  lastWatchTime: number;
}

/**
 * åª’ä½“è¯¦æƒ…é¡µç»„ä»¶
 * å±•ç¤ºåª’ä½“è¯¦ç»†ä¿¡æ¯ã€é›†æ•°åˆ—è¡¨å’Œæ“ä½œæŒ‰é’®
 */
@Entry
@Component
struct MediaDetailPage {
  private readonly TAG: string = 'MediaDetailPage';
  
  // è·¯ç”±å‚æ•°
  private mediaId: string = '';
  private siteKey: string = '';
  
  // çŠ¶æ€ç®¡ç†
  @State mediaDetail: MediaDetail | null = null;
  @State episodes: Episode[] = [];
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State relatedMedia: MediaItem[] = [];
  @State isLoading: boolean = true;
  @State isFavorite: boolean = false;
  @State selectedTab: string = 'episodes'; // 'episodes' or 'sources'
  @State currentPage: number = 1;
  @State hasMoreEpisodes: boolean = true;
  @State errorMessage: string = '';
  @State selectedEpisodeIndex: number = 0;
  @State selectedSeason: number = 1;
  @State seasons: number[] = [1]; // é»˜è®¤åªæœ‰ç¬¬1å­£
  @State searchText: string = '';
  @State activeTab: string = 'episodes'; // ç”¨äºæ ‡ç­¾é¡µåˆ‡æ¢
  
  // æ¯é¡µæ˜¾ç¤ºçš„å‰§é›†æ•°é‡
  private episodesPageSize: number = 50;
  
  // åˆå§‹åŒ–
  aboutToAppear(): void {
    Logger.info(this.TAG, 'MediaDetailPage mounted');
    
    // è·å–è·¯ç”±å‚æ•°
    const params = this.context.router.getParams();
    this.mediaId = (params?.mediaId as string) || '';
    this.siteKey = (params?.siteKey as string) || '';
    
    Logger.info(this.TAG, `Loading media detail for: ${this.siteKey}:${this.mediaId}`);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åŠ è½½çš„æ•°æ®ï¼ˆä»SearchPageä¼ é€’è¿‡æ¥çš„ï¼‰
    const title = params?.title as string;
    const coverUrl = params?.coverUrl as string;
    const description = params?.description as string;
    
    // å¦‚æœæœ‰é¢„åŠ è½½çš„æ•°æ®ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åª’ä½“è¯¦æƒ…å¯¹è±¡
    if (this.mediaId && title && coverUrl) {
      this.mediaDetail = {
        id: this.mediaId,
        siteKey: this.siteKey,
        title: title,
        coverUrl: coverUrl,
        description: description || '',
        year: params?.['year'] || '',
        type: params?.['type'] || '',
        score: params?.['score'] || '',
        directors: params?.['directors'] || [],
        actors: params?.['actors'] || [],
        episodes: [],
        genres: [],
        regions: []
      };
      this.isLoading = false;
    }
    
    // åŠ è½½å®Œæ•´çš„åª’ä½“è¯¦æƒ…
    this.loadMediaDetail();
  }
  
  // æ¸…ç†èµ„æº
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'MediaDetailPage unmounted');
  }
  
  /**
   * åŠ è½½åª’ä½“è¯¦æƒ…
   */
  private loadMediaDetail(): void {
    if (!this.mediaId || !this.siteKey) {
      this.errorMessage = 'ç¼ºå°‘å¿…è¦å‚æ•°';
      this.isLoading = false;
      return;
    }
    
    this.isLoading = false; // å› ä¸ºå¯èƒ½å·²æœ‰é¢„åŠ è½½æ•°æ®ï¼Œæš‚æ—¶ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.errorMessage = '';
    
    try {
      // è·å–åª’ä½“è¯¦æƒ…
      this.fetchMediaDetail().then((detail) => {
        this.mediaDetail = detail;
        // åŠ è½½ç›¸å…³æ¨è
        this.loadRelatedMedia();
        // åŠ è½½æ’­æ”¾æº
        if (this.mediaDetail?.episodes?.length > 0) {
          this.loadPlaySources(this.mediaDetail.episodes[0].id);
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load media detail: ${error}`);
        // å¦‚æœå·²ç»æœ‰é¢„åŠ è½½æ•°æ®ï¼Œåˆ™ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (!this.mediaDetail) {
          this.errorMessage = 'åŠ è½½è¯¦æƒ…å¤±è´¥';
        }
      }).finally(() => {
        this.isLoading = false;
      });
      
      // æ£€æŸ¥æ”¶è—çŠ¶æ€
      this.checkIsFavorited();
    } catch (error) {
      Logger.error(this.TAG, `Error in loadMediaDetail: ${error}`);
      this.isLoading = false;
    }
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
   */
  private checkIsFavorited(): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      favoriteService.isFavorite(this.mediaId, this.siteKey).then((isFavorited) => {
        this.isFavorite = isFavorited;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to check favorite status: ${error}`);
        this.isFavorite = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to check favorite status: ${error}`);
      this.isFavorite = false;
    }
  }
  
  /**
   * è·å–åª’ä½“è¯¦æƒ…
   */
  private fetchMediaDetail(): Promise<MediaDetail> {
    return new Promise((resolve, reject) => {
      if (!this.mediaId || !this.siteKey) {
        reject(new Error('Missing required parameters'));
        return;
      }
      
      try {
        mediaService.getMediaDetail(this.mediaId, this.siteKey).then((detail) => {
          // åˆå§‹åŒ–å‰§é›†åˆ—è¡¨
          if (detail.episodes && detail.episodes.length > 0) {
            this.episodes = detail.episodes;
            
            // æå–æ‰€æœ‰å­£æ•°
            this.seasons = [...new Set(detail.episodes.map(ep => ep.season || 1))].map(num => Number(num)).sort((a, b) => a - b);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šå‰§é›†
            this.hasMoreEpisodes = detail.episodes.length >= this.episodesPageSize;
          }
          
          resolve(detail);
        }).catch((error) => {
          Logger.error(this.TAG, `Failed to fetch media detail: ${error}`);
          reject(error);
        });
      } catch (error) {
        Logger.error(this.TAG, `Failed to fetch media detail: ${error}`);
        reject(error);
      }
    });
  }
  
  /**
   * åŠ è½½æ›´å¤šå‰§é›†
   */
  private loadMoreEpisodes(): void {
    if (!this.hasMoreEpisodes || !this.mediaId || !this.siteKey) return;
    
    try {
      this.currentPage++;
      mediaService.getEpisodes(
        this.mediaId, 
        this.siteKey, 
        this.currentPage, 
        this.episodesPageSize
      ).then((moreEpisodes) => {
        if (moreEpisodes && moreEpisodes.length > 0) {
          this.episodes = [...this.episodes, ...moreEpisodes];
          this.hasMoreEpisodes = moreEpisodes.length === this.episodesPageSize;
        } else {
          this.hasMoreEpisodes = false;
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load more episodes: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load more episodes: ${error}`);
    }
  }
  
  /**
   * åŠ è½½æ’­æ”¾æº
   */
  private loadPlaySources(episodeId?: string): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      mediaService.getPlaySources(this.mediaId, this.siteKey, episodeId).then((playSources) => {
        this.playSources = playSources;
        this.filteredSources = [...this.playSources]; // åˆå§‹åŒ–è¿‡æ»¤åçš„åˆ—è¡¨
        this.isLoading = false;
        
        // å¦‚æœæœ‰æ’­æ”¾æºä¸”é€‰æ‹©äº†å‰§é›†ï¼Œè·³è½¬åˆ°æ’­æ”¾é¡µé¢
        if (this.playSources && this.playSources.length > 0 && this.selectedEpisodeIndex >= 0) {
          AppNavigator.getInstance().navigateToVideoPlay({
          videoId: this.mediaId,
          siteKey: this.siteKey,
          episodeName: this.episodes[this.selectedEpisodeIndex].name
        });
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load play sources: ${error}`);
        this.errorMessage = 'åŠ è½½æ’­æ”¾æºå¤±è´¥';
        this.isLoading = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load play sources: ${error}`);
      this.errorMessage = 'åŠ è½½æ’­æ”¾æºå¤±è´¥';
    }
  }
  
  /**
   * å¤„ç†æœç´¢æ–‡æœ¬å˜åŒ–
   */
  private handleSearchChange(text: string) {
    this.searchText = text;
    
    // æ ¹æ®æœç´¢æ–‡æœ¬è¿‡æ»¤ç‰‡æº
    if (text.trim()) {
      const searchLower = text.toLowerCase();
      this.filteredSources = this.playSources.filter(source => 
        source.name.toLowerCase().includes(searchLower) ||
        (source.description && source.description.toLowerCase().includes(searchLower))
      );
    } else {
      // å¦‚æœæœç´¢æ–‡æœ¬ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç‰‡æº
      this.filteredSources = [...this.playSources];
    }
  }
  
  /**
   * åŠ è½½ç›¸å…³æ¨è
   */
  private loadRelatedMedia(): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      mediaService.getRelatedMedia(
        this.mediaId, 
        this.siteKey,
        10
      ).then((relatedMedia) => {
        this.relatedMedia = relatedMedia;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load related media: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load related media: ${error}`);
    }
  }
  
  /**
   * å¤„ç†æ”¶è—/å–æ¶ˆæ”¶è—
   */
  private async handleToggleFavorite(): Promise<void> {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      // å…ˆè®°å½•å½“å‰çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨æ“ä½œå¤±è´¥æ—¶æ¢å¤
      const originalState = this.isFavorite;
      
      // ç«‹å³æ›´æ–°UIçŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
      this.isFavorite = !this.isFavorite;
      
      // åˆ›å»ºæ”¶è—é¡¹å¯¹è±¡
      const favoriteItem: FavoriteItem = {
        id: `${this.siteKey}_${this.mediaId}`,
        mediaId: this.mediaId,
        siteKey: this.siteKey,
        title: this.mediaDetail.title,
        coverUrl: this.mediaDetail.coverUrl,
        type: this.mediaDetail.type,
        favoriteTime: Date.now()
      };
      
      // æ‰§è¡ŒçœŸå®çš„æ”¶è—/å–æ¶ˆæ”¶è—æ“ä½œ
      if (this.isFavorite) {
        await favoriteService.addToFavorites(favoriteItem);
        Logger.info(this.TAG, 'Added to favorites successfully');
      } else {
        await favoriteService.removeFromFavorites(this.mediaId, this.siteKey);
        Logger.info(this.TAG, 'Removed from favorites successfully');
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle favorite: ${error}`);
      // æ“ä½œå¤±è´¥ï¼Œæ¢å¤ä¹‹å‰çš„çŠ¶æ€
      this.isFavorite = !this.isFavorite;
    }
  }
  
  /**
   * å¤„ç†æ’­æ”¾å‰§é›†
   */
  private handlePlayEpisode(episode: Episode): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      // è®°å½•æ’­æ”¾å†å²
      const historyItem: HistoryItem = {
        id: `${this.siteKey}_${this.mediaId}_${episode.id}`,
        mediaId: this.mediaId,
        siteKey: this.siteKey,
        episodeId: episode.id,
        title: this.mediaDetail.title,
        coverUrl: this.mediaDetail.coverUrl,
        episodeName: episode.name,
        currentTime: 0,
        duration: 0,
        lastPlayTime: Date.now()
      };
      historyService.addHistory(historyItem);
      
      // åŠ è½½æ’­æ”¾æºå¹¶æ’­æ”¾
      this.loadPlaySources(episode.id);
    } catch (error) {
      Logger.error(this.TAG, `Failed to play episode: ${error}`);
      this.errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    }
  }
  
  /**
   * å¤„ç†æ’­æ”¾æºç‚¹å‡»
   */
  private async handlePlaySourceClick(source: PlaySource): Promise<void> {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      let episodeId: string | undefined;
      let episodeName: string | undefined;
      let currentPlayPosition = 0;
      
      // å¦‚æœæ²¡æœ‰é€‰æ‹©å‰§é›†ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
      if (this.episodes.length > 0) {
        const episodeIndex = this.selectedEpisodeIndex >= 0 ? this.selectedEpisodeIndex : 0;
        episodeId = this.episodes[episodeIndex].id;
        episodeName = this.episodes[episodeIndex].name;
        
        // å°è¯•è·å–ä¸Šæ¬¡è§‚çœ‹è¿›åº¦
        if (episodeId) {
          try {
            // ä½¿ç”¨çœŸå®çš„historyServiceè·å–è§‚çœ‹å†å²
            const watchHistory = await historyService.getWatchHistory(
              this.mediaId,
              this.siteKey,
              episodeId
            );
            
            if (watchHistory && watchHistory.position > 0) {
              currentPlayPosition = watchHistory.position;
            }
          } catch (e) {
            // è·å–å†å²è®°å½•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è¿›åº¦
            Logger.error(this.TAG, `Failed to get watch history: ${e}`);
          }
        }
      }
      
      // è·³è½¬åˆ°æ’­æ”¾é¡µé¢
      this.navigateToPlayback(episodeId, episodeName, source, currentPlayPosition);
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle play source click: ${error}`);
      this.errorMessage = 'æ’­æ”¾å¤±è´¥';
    }
  }
  
  /**
   * å¯¼èˆªåˆ°æ’­æ”¾é¡µé¢
   */
  private navigateToPlayback(
    episodeId: string | undefined,
    episodeName: string | undefined,
    playSource: PlaySource,
    startPosition: number
  ): void {
    AppNavigator.getInstance().navigateToVideoPlay({
      videoId: this.mediaId,
      siteKey: this.siteKey,
      episodeName: episodeName
    });
  }
  
  /**
   * ä¿å­˜å½“å‰æ’­æ”¾è¿›åº¦
   */
  private saveCurrentPlayProgress(episodeId: string): void {
    try {
      playbackService.getCurrentPosition()
        .then(position => {
          playbackService.getDuration()
            .then(duration => {
              if (position > 0 && this.mediaId && this.siteKey) {
                historyService.saveWatchProgress(
                  this.mediaId,
                  this.siteKey,
                  episodeId,
                  position,
                  duration
                ).catch(error => {
                  Logger.error(this.TAG, `Failed to save watch progress: ${error}`);
                });
              }
            })
            .catch(error => {
              Logger.error(this.TAG, `Failed to get duration: ${error}`);
            });
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to get current position: ${error}`);
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save play progress: ${error}`);
    }
  }
  
  /**
   * å¤„ç†ç›¸å…³åª’ä½“ç‚¹å‡»
   */
  private handleRelatedMediaClick(media: MediaItem): void {
      // è·³è½¬åˆ°å¯¹åº”åª’ä½“è¯¦æƒ…é¡µ
      AppNavigator.getInstance().navigateToDetail({
        id: media.id,
        siteKey: media.siteKey,
        type: 'vod'
      });
  }
  
  /**
   * å¤„ç†å­£åˆ‡æ¢
   */
  private handleSeasonChange(season: number): void {
    this.selectedSeason = season;
    // é‡ç½®é€‰ä¸­çš„é›†æ•°
    this.selectedEpisodeIndex = -1;
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
      AppNavigator.getInstance().back();
    }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€
   */
  @Builder
  private renderLoading(): void {
    Column({
      style: {
        width: '100%',
        height: '100%',
        backgroundColor: '#4CAF50',
        justifyContent: 'center',
        alignItems: 'center'
      }
    }) {
      // åŠ è½½æŒ‡ç¤ºå™¨ - ä½¿ç”¨ç®€å•çš„æ—‹è½¬åŠ¨ç”»
      Column({
        width: 50,
        height: 50,
        backgroundColor: '#FFFFFF',
        borderRadius: 25,
        justifyContent: 'center',
        alignItems: 'center'
      }) {
        Text("â—")
          .fontSize(20)
          .fontColor('#4CAF50')
      }
      Text("åŠ è½½ä¸­...")
        .fontSize(24)
        .fontColor('#FFFFFF')
        .margin({ top: 20 })
    }
  }
  
  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€
   */
  @Builder
  private renderError(): void {
    Column({
      style: {
        width: '100%',
        height: '100%',
        backgroundColor: '#4CAF50',
        justifyContent: 'center',
        alignItems: 'center',
        padding: 20
      }
    }) {
      Text("âš ï¸")
        .fontSize(48)
        .margin({ bottom: 20 })
      Text(this.errorMessage)
        .fontSize(24)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 30 })
      Button({
        style: {
          backgroundColor: '#FFFFFF',
          paddingHorizontal: 40,
          paddingVertical: 15,
          borderRadius: 25
        },
        onClick: () => this.loadMediaDetail()
      }) {
        Text("é‡è¯•")
          .fontSize(24)
          .fontColor('#4CAF50')
          .fontWeight(700)
      }
    }
  }
  
  /**
   * æ¸²æŸ“å¤´éƒ¨ä¿¡æ¯
   */
  @Builder
  private renderHeader(): void {
    Column({
      padding: 20
    }) {
      // åª’ä½“å°é¢å’ŒåŸºæœ¬ä¿¡æ¯
      Row({
        alignItems: 'flex-start'
      }) {
        // åª’ä½“å°é¢
        // Imageç»„ä»¶åœ¨ArkUIä¸­å¯èƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨å ä½ç¬¦
        Column({
          width: 150,
          height: 200,
          backgroundColor: '#E0E0E0',
          borderRadius: 8,
          justifyContent: 'center',
          alignItems: 'center'
        }) {
          Text("å°é¢")
            .fontSize(16)
            .fontColor('#666666')
        }
        
        Column({
          marginLeft: 20,
          flex: 1
        }) {
          Text(this.mediaDetail.title)
            .fontSize(28)
            .fontColor('#FFFFFF')
            .fontWeight(700)
          
          if (this.mediaDetail.year) {
            Text(`å¹´ä»½: ${this.mediaDetail.year}`)
              .fontSize(20)
              .fontColor('#E0E0E0')
              .margin({ top: 10 })
          }
          
          if (this.mediaDetail.score) {
            Text(`è¯„åˆ†: ${this.mediaDetail.score}`)
              .fontSize(20)
              .fontColor('#E0E0E0')
              .margin({ top: 5 })
          }
        }
      }
      
      // å‰§æƒ…ç®€ä»‹
      if (this.mediaDetail.description) {
        Column({
          marginTop: 20
        }) {
          Text("å‰§æƒ…ç®€ä»‹")
            .fontSize(22)
            .fontColor('#FFFFFF')
            .fontWeight(600)
            .margin({ bottom: 10 })
          
          Text(this.mediaDetail.description)
            .fontSize(18)
            .fontColor('#E0E0E0')
            .lineHeight(24)
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“å‰§æƒ…ç®€ä»‹
   */
  @Builder
  private renderSynopsis(): void {
    // æ­¤æ–¹æ³•åº”è¿”å›UIç»„ä»¶ï¼Œä½†å½“å‰å®ç°ä¸ç¬¦åˆArkTSè§„èŒƒ
    // éœ€è¦åœ¨buildæ–¹æ³•ä¸­ç›´æ¥ä½¿ç”¨æ¡ä»¶æ¸²æŸ“æ¥å®ç°å‰§æƒ…ç®€ä»‹
  }
  
  /**
   * æ¸²æŸ“æ ‡ç­¾é¡µåˆ‡æ¢æ 
   */
  @Builder
  private renderTabBar(): void {
    Flex({
      direction: FlexDirection.Row,
      justifyContent: FlexAlign.Start,
      alignItems: ItemAlign.Center
    }) {
      .backgroundColor('#4CAF50')
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .gap(10)
      Button({
        type: ButtonType.Normal
      }) {
        .backgroundColor(this.activeTab === 'episodes' ? '#FFFFFF' : '#66BB6A')
        .padding({ left: 25, right: 25, top: 10, bottom: 10 })
        .borderRadius(20)
        .minWidth(100)
        .onClick(() => this.activeTab = 'episodes')
        Text("å‰§é›†åˆ—è¡¨")
          .fontSize(24)
          .fontColor(this.activeTab === 'episodes' ? '#4CAF50' : '#FFFFFF')
          .fontWeight(700)
      }
      
      Button({
        type: ButtonType.Normal
      }) {
        .backgroundColor(this.activeTab === 'sources' ? '#FFFFFF' : '#66BB6A')
        .padding({ left: 25, right: 25, top: 10, bottom: 10 })
        .borderRadius(20)
        .minWidth(100)
        .onClick(() => this.activeTab = 'sources')
        Text("æ’­æ”¾æº")
          .fontSize(24)
          .fontColor(this.activeTab === 'sources' ? '#4CAF50' : '#FFFFFF')
          .fontWeight(700)
      }
    }
  }
  
  /**
   * æ¸²æŸ“å­£é€‰æ‹©å™¨
   */
  @Builder
  private renderSeasonSelector(): void {
    // å­£é€‰æ‹©å™¨
    if (this.seasons.length === 0) {
      Column({
        justifyContent: FlexAlign.Center,
        alignItems: ItemAlign.Center
      }) {
        .backgroundColor('#4CAF50')
        .padding(20)
        Text("æš‚æ— å­£ä¿¡æ¯")
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      Row({
        width: '100%',
        padding: 20,
        alignItems: 'center',
        justifyContent: 'flex-start'
      }) {
        Text("é€‰æ‹©å­£:")
          .fontSize(28)
          .fontColor('#FFFFFF')
          .fontWeight(600)
          .margin({ right: 15 })
        
        // å­£é€‰æ‹©æŒ‰é’®
        ForEach(this.seasons, (season: number) => {
          Button({
            key: season.toString(),
            type: ButtonType.Normal
          }) {
            .backgroundColor(this.selectedSeason === season ? '#66BB6A' : '#E0E0E0')
            .padding({ left: 20, right: 20, top: 10, bottom: 10 })
            .borderRadius(6)
            .margin({ right: 10 })
            .onClick(() => this.handleSeasonChange(season))
            Text(`ç¬¬${season}å­£`)
              .fontSize(24)
              .fontColor(this.selectedSeason === season ? '#FFFFFF' : '#666666')
              .fontWeight(600)
          }
        })
      }
    }
  }
  
  /**
   * æ¸²æŸ“å‰§é›†åˆ—è¡¨
   */
  @Builder
  private renderEpisodes(): void {
    // å‰§é›†åˆ—è¡¨
    if (this.episodes.length === 0) {
      Column({
        style: {
          backgroundColor: '#4CAF50',
          padding: 20,
          alignItems: 'center'
        }
      }) {
        Text("æš‚æ— å‰§é›†")
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      // ä½¿ç”¨Flexå¸ƒå±€å±•ç¤ºå‰§é›†
      Flex({
        direction: FlexDirection.Row,
        wrap: FlexWrap.Wrap,
        justifyContent: FlexAlign.Start,
        alignItems: ItemAlign.Center
      }) {
        .width('100%')
        .gap(15)
        ForEach(this.episodes, (episode: Episode, index: number) => {
          Flex({
            key: episode.id,
            direction: FlexDirection.Row,
            justifyContent: FlexAlign.Center,
            alignItems: ItemAlign.Center
          }) {
            .width('15%')
            .minWidth(80)
            Button({
              type: ButtonType.Normal
            }) {
              .backgroundColor('#66BB6A')
              .padding(15)
              .borderRadius(8)
              .width('100%')
              .onClick(() => this.handlePlayEpisode(episode))
              Text(`${index + 1}`)
                .fontSize(24)
                .fontColor('#FFFFFF')
                .fontWeight(600)
            }
          }
        })
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾æºåˆ—è¡¨
   */
  @Builder
  private renderPlaySources(): void {
    Column({
      width: '100%',
      backgroundColor: '#4CAF50',
      padding: 20
    }) {
      // æœç´¢æ¡†
      Row({
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: '#FFFFFF',
        borderRadius: 25,
        paddingHorizontal: 20,
        marginBottom: 20,
        height: 50
      }) {
        Text('ğŸ”')
          .fontSize(24)
          .fontColor('#999999')
          .margin({ right: 10 })
        
        TextInput()
          .placeholder('æœç´¢æ’­æ”¾æº...')
          .flexGrow(1)
          .fontSize(20)
          .onChange((value: string) => {
            this.searchText = value;
            this.filteredSources = this.playSources.filter(source => 
              source.name?.toLowerCase().includes(value.toLowerCase())
            );
          })
        
        if (this.searchText) {
          Button({
            type: ButtonType.Normal
          })
          .backgroundColor('transparent')
          .onClick(() => {
            this.searchText = '';
            this.filteredSources = [...this.playSources];
          }) {
            Text('âœ•')
              .fontSize(24)
              .fontColor('#999999')
          }
        }
      }
    
      if (this.filteredSources.length === 0) {
        Column({
          justifyContent: FlexAlign.Center,
          alignItems: ItemAlign.Center
        }) {
          .backgroundColor('#4CAF50')
          .padding(40)
          Text("æš‚æ— æ’­æ”¾æºæˆ–æ²¡æœ‰åŒ¹é…çš„ç‰‡æº")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else {
        Column() {
          .width('100%')
          ForEach(this.filteredSources, (source: PlaySource, index: number) => {
            Row({
              key: index.toString(),
              alignItems: ItemAlign.Center
            }) {
              .padding({ top: 10, bottom: 10 })
              Button({
                type: ButtonType.Normal
              })
              .backgroundColor('#66BB6A')
              .padding(25)
              .borderRadius(10)
              .width('100%')
              .border({ width: 2, color: 'transparent' })
              .onClick(() => this.handlePlaySourceClick(source)) {
                Flex({
                  direction: FlexDirection.Row,
                  alignItems: ItemAlign.Center,
                  justifyContent: FlexAlign.SpaceBetween
                }) {
                  .width('100%')
                  Text(source.name || `æ’­æ”¾æº${index + 1}`)
                    .fontSize(28)
                    .fontColor('#FFFFFF')
                    .fontWeight(700)
                    .flexGrow(1)
                  
                  if (source.quality) {
                    Flex({
                      direction: FlexDirection.Row,
                      justifyContent: FlexAlign.Center,
                      alignItems: ItemAlign.Center
                    }) {
                      .backgroundColor('#FFEB3B')
                      .padding({ left: 15, right: 15, top: 8, bottom: 8 })
                      .borderRadius(15)
                      Text(source.quality)
                        .fontSize(22)
                        .fontColor('#000000')
                        .fontWeight(700)
                    }
                  }
                }
              }
            }
          })
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“ç›¸å…³æ¨è
   */
  @Builder
  private renderRelatedMedia(): void {
    // ç›¸å…³æ¨è
    if (this.relatedMedia.length === 0) {
      Column({
        backgroundColor: '#4CAF50',
        padding: 20,
        alignItems: 'center'
      }) {
        Text("æš‚æ— ç›¸å…³æ¨è")
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      Column({
        width: '100%'
      }) {
        // ç›¸å…³æ¨èæ ‡é¢˜
        Row({
          alignItems: ItemAlign.Center,
          justifyContent: FlexAlign.Start
        }) {
          .width('100%')
          .padding(20)
          Text("ç›¸å…³æ¨è")
            .fontSize(32)
            .fontColor('#333333')
            .fontWeight(600)
        }
        
        // ç›¸å…³æ¨èåˆ—è¡¨
        ScrollView() {
          Column() {
            ForEach(this.relatedMedia, (media: MediaItem) => {
              Row({
                width: '100%',
                padding: 15,
                alignItems: 'center',
                borderBottom: '1px solid #E0E0E0'
              })
              .key(media.id) {
                // åª’ä½“å°é¢
                Column({
                  width: 80,
                  height: 120,
                  backgroundColor: '#E0E0E0',
                  borderRadius: 8,
                  justifyContent: 'center',
                  alignItems: 'center',
                  margin: { right: 15 }
                }) {
                  Text("å°é¢")
                    .fontSize(12)
                    .fontColor('#666666')
                }
                
                // åª’ä½“ä¿¡æ¯
                Column() {
                  .flexGrow(1)
                  Text(media.title)
                    .fontSize(28)
                    .fontColor('#333333')
                    .fontWeight(600)
                  
                  Text(`${media.year} Â· ${media.rating}åˆ†`)
                    .fontSize(24)
                    .fontColor('#666666')
                }
              }
            })
          }
        }
      }
    }
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Column({
      flex: 1,
      backgroundColor: '#4CAF50'
    }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({
        backgroundColor: '#388E3C',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 20,
        paddingVertical: 15,
        width: '100%'
      }) {
        Button({
          backgroundColor: 'transparent'
        }) {
          Text("â† è¿”å›")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        .onClick(this.handleBack)
        
        Text("è¯¦æƒ…")
          .fontSize(26)
          .fontColor('#FFFFFF')
          .fontWeight(700)
        
        Blank()
          .width(80)
      }
      
      // ä¸»å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column({
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center'
        }) {
          Text("åŠ è½½ä¸­...")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        Column({
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center'
        }) {
          Text(this.errorMessage)
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else {
        ScrollView({
          flex: 1,
          backgroundColor: '#4CAF50'
        }) {
          // æ·»åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…è¢«å¯¼èˆªæ é®æŒ¡
          Blank()
            .height(60)
          
          // åª’ä½“å¤´éƒ¨ä¿¡æ¯
          if (this.mediaDetail) {
            this.renderHeader()
          }
          
          // æ ‡ç­¾é¡µåˆ‡æ¢æ 
          this.renderTabBar()
          
          // å†…å®¹åŒºåŸŸ
          Column({
            padding: 20
          }) {
            if (this.activeTab === 'episodes') {
              this.renderEpisodes()
            } else {
              this.renderPlaySources()
            }
          }
          
          // ç›¸å…³æ¨è
          if (this.relatedMedia.length > 0) {
            Column({
              padding: 20
            }) {
              Text("ç›¸å…³æ¨è")
                .fontSize(22)
                .fontColor('#FFFFFF')
                .fontWeight(600)
                .margin({ bottom: 15 })
              
              ScrollView() {
                Row({
                  gap: 15
                }) {
                  ForEach(this.relatedMedia, (media: MediaItem) => {
                    Column({
                      width: 150
                    })
                    .key(`${media.siteKey}-${media.id}`)
                    .onClick(() => this.handleRelatedMediaClick(media)) {
                      Image(media.coverUrl || "https://via.placeholder.com/150x200?text=No+Image")
                        .width(150)
                        .height(200)
                        .borderRadius(8)
                        .objectFit(ImageFit.Cover)
                      
                      Text(media.title)
                        .fontSize(18)
                        .fontColor('#FFFFFF')
                        .margin({ top: 10 })
                        .maxLines(2)
                        .textOverflow({ overflow: 'ellipsis' })
                    }
                  })
                }
              }
              .height(250)
              .scrollBar(BarState.Off)
            }
          }
          
          Blank()
            .height(50)
        }
      }
    }
  }
}

export default MediaDetailPage;