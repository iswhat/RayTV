
import { AppNavigator } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';

// ç±»å‹å®šä¹‰
export interface MediaItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  score?: string;
  year?: string;
  status?: string;
}

export interface MediaDetail {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  description?: string;
  score?: string;
  year?: string;
  type?: string;
  status?: string;
  episodes?: Episode[];
  directors?: string[];
  actors?: string[];
  genres?: string[];
  regions?: string[];
}

export interface Episode {
  id: string;
  name: string;
  season?: number;
  episode?: number;
}

export interface PlaySource {
  id?: string;
  name?: string;
  quality?: string;
  url?: string;
  description?: string;
}

export interface FavoriteItem {
  id: string;
  mediaId: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  favoriteTime: number;
}

export interface HistoryItem {
  id: string;
  mediaId: string;
  siteKey: string;
  episodeId: string;
  title: string;
  coverUrl: string;
  episodeName: string;
  currentTime: number;
  duration: number;
  lastPlayTime: number;
}

export interface WatchHistory {
  mediaId: string;
  episodeId: string;
  position: number;
  lastWatchTime: number;
}

/**
 * åª’ä½“è¯¦æƒ…é¡µç»„ä»?
 * å±•ç¤ºåª’ä½“è¯¦ç»†ä¿¡æ¯ã€é›†æ•°åˆ—è¡¨å’Œæ“ä½œæŒ‰é’®
 */
@Entry
@Component
struct MediaDetailPage {
  private readonly TAG: string = 'MediaDetailPage';
  
  // è·¯ç”±å‚æ•°
  private mediaId: string = '';
  private siteKey: string = '';
  
  // çŠ¶æ€ç®¡ç?
  @State mediaDetail: MediaDetail | null = null;
  @State episodes: Episode[] = [];
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State relatedMedia: MediaItem[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State activeTab: string = 'episodes';
  @State seasons: Array<{ season: number; episodes: Episode[] }> = [];
  @State selectedSeason: number = 1;
  @State searchKeyword: string = '';
  @State isFavorite: boolean = false;
  @State watchHistory: WatchHistory | null = null;
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  onPageShow() {
    Logger.info(this.TAG, 'onPageShow');
    this.loadMediaDetail();
  }
  
  /**
   * åŠ è½½åª’ä½“è¯¦æƒ…
   */
  private async loadMediaDetail() {
    try {
      this.isLoading = true;
      this.errorMessage = '';
      
      // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // æ¨¡æ‹Ÿæ•°æ®
      this.mediaDetail = {
        id: this.mediaId,
        siteKey: this.siteKey,
        title: 'æµ‹è¯•å½±ç‰‡',
        coverUrl: 'https://via.placeholder.com/150x200?text=Cover',
        description: 'è¿™æ˜¯ä¸€éƒ¨æµ‹è¯•å½±ç‰‡ï¼Œç”¨äºå±•ç¤ºåª’ä½“è¯¦æƒ…é¡µçš„åŠŸèƒ½ã€?,
        score: '8.5',
        year: '2024',
        type: 'ç”µå½±',
        status: 'å·²å®Œç»?,
        directors: ['å¯¼æ¼”A', 'å¯¼æ¼”B'],
        actors: ['æ¼”å‘˜A', 'æ¼”å‘˜B', 'æ¼”å‘˜C'],
        genres: ['åŠ¨ä½œ', 'å†’é™©'],
        regions: ['ä¸­å›½', 'ç¾å›½']
      };
      
      // æ¨¡æ‹Ÿå‰§é›†æ•°æ®
      this.episodes = Array.from({ length: 20 }, (_, index) => ({
        id: `episode_${index + 1}`,
        name: `ç¬?{index + 1}é›†`,
        season: 1,
        episode: index + 1
      }));
      
      // æ¨¡æ‹Ÿå­£æ•°æ?
      this.seasons = [{ season: 1, episodes: this.episodes }];
      
      // æ¨¡æ‹Ÿæ’­æ”¾æºæ•°æ?
      this.playSources = Array.from({ length: 5 }, (_, index) => ({
        id: `source_${index + 1}`,
        name: `æ’­æ”¾æº?{index + 1}`,
        quality: index % 2 === 0 ? '1080P' : '720P',
        url: `https://example.com/play/${index + 1}`
      }));
      
      this.filteredSources = this.playSources;
      
      // æ¨¡æ‹Ÿç›¸å…³æ¨èæ•°æ®
      this.relatedMedia = Array.from({ length: 10 }, (_, index) => ({
        id: `related_${index + 1}`,
        siteKey: this.siteKey,
        title: `ç›¸å…³å½±ç‰‡${index + 1}`,
        coverUrl: `https://via.placeholder.com/150x200?text=Related+${index + 1}`,
        type: 'ç”µå½±',
        score: `${Math.floor(Math.random() * 2) + 7}.${Math.floor(Math.random() * 10)}`
      }));
      
      // æ¨¡æ‹Ÿæ”¶è—çŠ¶æ€?
      this.isFavorite = false;
      
      // æ¨¡æ‹Ÿè§‚çœ‹å†å²
      this.watchHistory = {
        mediaId: this.mediaId,
        episodeId: 'episode_5',
        position: 300000, // 5åˆ†é’Ÿ
        lastWatchTime: Date.now() - 3600000 // 1å°æ—¶å‰?
      };
    } catch (error) {
      Logger.error(this.TAG, `Failed to load media detail: ${JSON.stringify(error)}`, error as Error);
      this.errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      this.isLoading = false;
    }
  }
  
  /**
   * è¿”å›ä¸Šä¸€é¡?
   */
  private async handleBack() {
    await AppNavigator.getInstance().navigateToBack();
  }
  
  /**
   * å¤„ç†ç›¸å…³åª’ä½“ç‚¹å‡»
   */
  private async handleRelatedMediaClick(media: MediaItem) {
    await AppNavigator.getInstance().navigateToDetail({
      id: media.id,
      siteKey: media.siteKey,
      type: 'vod'
    });
  }
  
  /**
   * å¤„ç†æ’­æ”¾ç‚¹å‡»
   */
  private async handlePlayClick(episode: Episode, source: PlaySource) {
    Logger.info(this.TAG, `Play episode ${episode.name} with source ${source.name}`);
    // è·³è½¬åˆ°æ’­æ”¾é¡µ
    await AppNavigator.getInstance().navigateToVideoPlay({
      videoId: this.mediaId,
      siteKey: this.siteKey,
      episodeName: episode.name,
      position: this.watchHistory?.position || 0
    });
  }
  
  /**
   * å¤„ç†æ”¶è—ç‚¹å‡»
   */
  private async handleFavoriteClick() {
    try {
      this.isFavorite = !this.isFavorite;
      if (this.isFavorite) {
        // ä¿å­˜æ”¶è—
        Logger.info(this.TAG, `Add to favorite: ${this.mediaDetail?.title}`);
      } else {
        // å–æ¶ˆæ”¶è—
        Logger.info(this.TAG, `Remove from favorite: ${this.mediaDetail?.title}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle favorite: ${JSON.stringify(error)}`, error as Error);
      // æ¢å¤åŸå§‹çŠ¶æ€?
      this.isFavorite = !this.isFavorite;
    }
  }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€?
   */
  @Builder
  private renderLoading(): void {
    Column({
      style: {
        width: '100%',
        height: '100%',
        backgroundColor: '#4CAF50',
        justifyContent: 'center',
        alignItems: 'center'
      }
    }) {
      // åŠ è½½æŒ‡ç¤ºå™? ä½¿ç”¨ç®€å•çš„æ—‹è½¬åŠ¨ç”»
      Column({
        style: {
          width: 50,
          height: 50,
          backgroundColor: '#FFFFFF',
          borderRadius: 25,
          justifyContent: 'center',
          alignItems: 'center'
        }
      }) {
        Text("âŸ?)
          .fontSize(20)
          .fontColor('#4CAF50')
      }
      Text("åŠ è½½ä¸?.")
        .fontSize(24)
        .fontColor('#FFFFFF')
        .margin({ top: 20 })
    }
  }
  
  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€?
   */
  @Builder
  private renderError(): void {
    Column({
      style: {
        width: '100%',
        height: '100%',
        backgroundColor: '#4CAF50',
        justifyContent: 'center',
        alignItems: 'center',
        padding: 20
      }
    }) {
      Text("âš ï¸")
        .fontSize(48)
        .margin({ bottom: 20 })
      Text(this.errorMessage)
        .fontSize(24)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 30 })
      Button({
        style: {
          backgroundColor: '#FFFFFF',
          paddingHorizontal: 40,
          paddingVertical: 15,
          borderRadius: 25
        },
        onClick: () => this.loadMediaDetail()
      }) {
        Text("é‡è¯•")
          .fontSize(24)
          .fontColor('#4CAF50')
          .fontWeight(700)
      }
    }
  }
  
  /**
   * æ¸²æŸ“å¤´éƒ¨ä¿¡æ¯
   */
  @Builder
  private renderHeader(): void {
    Column({
      style: {
        padding: 20
      }
    }) {
      // åª’ä½“å°é¢å’ŒåŸºæœ¬ä¿¡æ?
      Row({
        style: {
          alignItems: 'flex-start'
        }
      }) {
        // åª’ä½“å°é¢
        Column({
          style: {
            width: 150,
            height: 200,
            backgroundColor: '#E0E0E0',
            borderRadius: 8,
            justifyContent: 'center',
            alignItems: 'center'
          }
        }) {
          Text("å°é¢")
            .fontSize(16)
            .fontColor('#666666')
        }
        
        Column({
          style: {
            marginLeft: 20,
            flex: 1
          }
        }) {
          // æ ‡é¢˜
          Text(this.mediaDetail?.title || "")
            .fontSize(28)
            .fontColor('#FFFFFF')
            .fontWeight(700)
            .margin({ bottom: 10 })
          
          // è¯„åˆ†
          Row({
            style: {
              alignItems: 'center',
              marginBottom: 10
            }
          }) {
            Text("â­?)
              .fontSize(18)
              .marginRight(5)
            Text(this.mediaDetail?.score || "0.0")
              .fontSize(18)
              .fontColor('#FFFFFF')
              .marginRight(20)
            
            // å¹´ä»½å’Œç±»å?
            Text(`${this.mediaDetail?.year || ""} Â· ${this.mediaDetail?.type || ""}`)
              .fontSize(18)
              .fontColor('#FFFFFF')
          }
          
          // çŠ¶æ€?
          Text(this.mediaDetail?.status || "")
            .fontSize(18)
            .fontColor('#FFFFFF')
            .margin({ bottom: 15 })
          
          // å¯¼æ¼”å’Œæ¼”å‘?
          Column({
            style: {
              marginBottom: 15
            }
          }) {
            Row({
              style: {
                alignItems: 'center'
              }
            }) {
              Text("å¯¼æ¼”ï¼?)
                .fontSize(18)
                .fontColor('#FFFFFF')
                .marginRight(10)
              Text(this.mediaDetail?.directors?.join("ã€?) || "")
                .fontSize(18)
                .fontColor('#FFFFFF')
            }
            
            Row({
              style: {
                alignItems: 'center',
                marginTop: 5
              }
            }) {
              Text("æ¼”å‘˜ï¼?)
                .fontSize(18)
                .fontColor('#FFFFFF')
                .marginRight(10)
              Text(this.mediaDetail?.actors?.join("ã€?) || "")
                .fontSize(18)
                .fontColor('#FFFFFF')
            }
          }
          
          // ç±»å‹å’Œåœ°åŒ?
          Row({
            style: {
              alignItems: 'center',
              flexWrap: 'wrap',
              marginBottom: 20
            }
          }) {
            ForEach(this.mediaDetail?.genres || [], (genre: string) => {
              Column({
                style: {
                  padding: { left: 10, right: 10, top: 5, bottom: 5 },
                  backgroundColor: '#66BB6A',
                  borderRadius: 15,
                  marginRight: 10,
                  marginBottom: 10
                }
              }) {
                Text(genre)
                  .fontSize(16)
                  .fontColor('#FFFFFF')
              }
            })
            
            ForEach(this.mediaDetail?.regions || [], (region: string) => {
              Column({
                style: {
                  padding: { left: 10, right: 10, top: 5, bottom: 5 },
                  backgroundColor: '#66BB6A',
                  borderRadius: 15,
                  marginRight: 10,
                  marginBottom: 10
                }
              }) {
                Text(region)
                  .fontSize(16)
                  .fontColor('#FFFFFF')
              }
            })
          }
        }
      }
      
      // æ“ä½œæŒ‰é’®
      Row({
        style: {
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: 20
        }
      }) {
        // æ’­æ”¾æŒ‰é’®
        Button({
          style: {
            backgroundColor: '#FFFFFF',
            paddingHorizontal: 50,
            paddingVertical: 15,
            borderRadius: 25,
            flex: 1
          },
          onClick: () => this.handlePlayClick(this.episodes[0] || { id: '', name: '' }, this.playSources[0] || {})
        }) {
          Text("æ’­æ”¾")
            .fontSize(24)
            .fontColor('#4CAF50')
            .fontWeight(700)
        }
        
        // æ”¶è—æŒ‰é’®
        Button({
          style: {
            backgroundColor: this.isFavorite ? '#FF5722' : '#66BB6A',
            paddingHorizontal: 50,
            paddingVertical: 15,
            borderRadius: 25,
            marginLeft: 20
          },
          onClick: () => this.handleFavoriteClick()
        }) {
          Text(this.isFavorite ? "å–æ¶ˆæ”¶è—" : "æ”¶è—")
            .fontSize(24)
            .fontColor('#FFFFFF')
            .fontWeight(700)
        }
      }
      
      // å‰§æƒ…ç®€ä»?
      Column({
        style: {
          marginBottom: 20
        }
      }) {
        Text("å‰§æƒ…ç®€ä»?)
          .fontSize(22)
          .fontColor('#FFFFFF')
          .fontWeight(600)
          .margin({ bottom: 10 })
        Text(this.mediaDetail?.description || "")
          .fontSize(18)
          .fontColor('#FFFFFF')
          .lineHeight(28)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(3)
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ ‡ç­¾é¡µåˆ‡æ¢æ 
   */
  @Builder
  private renderTabBar(): void {
    Row({
      style: {
        backgroundColor: '#4CAF50',
        padding: { left: 20, right: 20, top: 10, bottom: 10 },
        gap: 10
      }
    }) {
      Button({
        style: {
          backgroundColor: this.activeTab === 'episodes' ? '#FFFFFF' : '#66BB6A',
          padding: { left: 25, right: 25, top: 10, bottom: 10 },
          borderRadius: 20,
          minWidth: 100
        },
        onClick: () => this.activeTab = 'episodes'
      }) {
        Text("å‰§é›†åˆ—è¡¨")
          .fontSize(24)
          .fontColor(this.activeTab === 'episodes' ? '#4CAF50' : '#FFFFFF')
          .fontWeight(700)
      }
      
      Button({
        style: {
          backgroundColor: this.activeTab === 'sources' ? '#FFFFFF' : '#66BB6A',
          padding: { left: 25, right: 25, top: 10, bottom: 10 },
          borderRadius: 20,
          minWidth: 100
        },
        onClick: () => this.activeTab = 'sources'
      }) {
        Text("æ’­æ”¾æº?)
          .fontSize(24)
          .fontColor(this.activeTab === 'sources' ? '#4CAF50' : '#FFFFFF')
          .fontWeight(700)
      }
    }
  }
  
  /**
   * æ¸²æŸ“å­£é€‰æ‹©å™?
   */
  @Builder
  private renderSeasonSelector(): void {
    // å­£é€‰æ‹©å™?
    if (this.seasons?.length === 0) {
      Column({
        style: {
          justifyContent: 'center',
          alignItems: 'center',
          backgroundColor: '#4CAF50',
          padding: 20
        }
      }) {
        Text("æš‚æ— å­£ä¿¡æ?)
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      Row({
        style: {
          flexWrap: 'wrap',
          gap: 10,
          marginBottom: 20
        }
      }) {
        ForEach(this.seasons, (seasonItem) => {
          Button({
            style: {
              backgroundColor: this.selectedSeason === seasonItem.season ? '#FFFFFF' : '#66BB6A',
              paddingHorizontal: 20,
              paddingVertical: 10,
              borderRadius: 15
            },
            onClick: () => this.selectedSeason = seasonItem.season
          }) {
            Text(`ç¬?{seasonItem.season}å­£`)
              .fontSize(18)
              .fontColor(this.selectedSeason === seasonItem.season ? '#4CAF50' : '#FFFFFF')
          }
        })
      }
    }
  }
  
  /**
   * æ¸²æŸ“å‰§é›†åˆ—è¡¨
   */
  @Builder
  private renderEpisodes(): void {
    Column({
      style: {
        marginBottom: 20
      }
    }) {
      // å­£é€‰æ‹©å™?
      this.renderSeasonSelector();
      
      // å‰§é›†åˆ—è¡¨
      Column({
        style: {
          gap: 10
        }
      }) {
        ForEach(this.episodes, (episode: Episode) => {
          // åªæ˜¾ç¤ºå½“å‰å­£çš„å‰§é›?
          if (episode.season === this.selectedSeason) {
            Button({
              style: {
                backgroundColor: '#66BB6A',
                padding: 15,
                borderRadius: 10,
                width: '100%',
                justifyContent: 'space-between',
                alignItems: 'center'
              },
              onClick: () => this.handlePlayClick(episode, this.playSources[0] || {})
            }) {
              Row({
                style: {
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  width: '100%'
                }
              }) {
                Text(episode.name)
                  .fontSize(20)
                  .fontColor('#FFFFFF')
                
                if (this.watchHistory?.episodeId === episode.id) {
                  Row({
                    style: {
                      alignItems: 'center'
                    }
                  }) {
                    Text("â±ï¸")
                      .fontSize(16)
                      .marginRight(5)
                    Text("å·²è§‚çœ?)
                      .fontSize(16)
                      .fontColor('#FFFFFF')
                  }
                }
              }
            }
          }
        })
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾æºåˆ—è¡?
   */
  @Builder
  private renderPlaySources(): void {
    Column({
      style: {
        marginBottom: 20
      }
    }) {
      // æœç´¢æ¡?
      Row({
        style: {
          alignItems: 'center',
          marginBottom: 20
        }
      }) {
        TextInput({
          type: InputType.Text,
          placeholder: "æœç´¢æ’­æ”¾æº?,
          style: {
            flex: 1,
            backgroundColor: '#FFFFFF',
            borderRadius: 25,
            paddingHorizontal: 20,
            paddingVertical: 15,
            fontSize: 18
          }
        })
        .onChange((value: string) => {
          this.searchKeyword = value;
          this.filteredSources = this.playSources.filter(source =>
            source.name?.includes(value) || source.quality?.includes(value)
          );
        })
      }
      
      // æ’­æ”¾æºåˆ—è¡?
      if (this.filteredSources?.length === 0) {
        Column({
          style: {
            justifyContent: 'center',
            alignItems: 'center',
            padding: 20
          }
        }) {
          Text("æš‚æ— æ’­æ”¾æºæˆ–æ²¡æœ‰åŒ¹é…çš„ç‰‡æº?)
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else {
        Column({
          style: {
            gap: 10
          }
        }) {
          ForEach(this.filteredSources, (source: PlaySource) => {
            Button({
              style: {
                backgroundColor: '#66BB6A',
                padding: 15,
                borderRadius: 10,
                width: '100%',
                justifyContent: 'space-between',
                alignItems: 'center'
              },
              onClick: () => this.handlePlayClick(this.episodes[0] || { id: '', name: '' }, source)
            }) {
              Row({
                style: {
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  width: '100%'
                }
              }) {
                Column({
                  style: {
                    alignItems: 'flex-start'
                  }
                }) {
                  Text(source.name || "")
                    .fontSize(20)
                    .fontColor('#FFFFFF')
                  Text(source.quality || "")
                    .fontSize(16)
                    .fontColor('#FFFFFF')
                }
                
                Text("â–?)
                  .fontSize(24)
                  .fontColor('#FFFFFF')
              }
            }
          })
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“ç›¸å…³æ¨è
   */
  @Builder
  private renderRelatedMedia(): void {
    if (this.relatedMedia?.length === 0) return;
    
    Column({
      style: {
        marginBottom: 20
      }
    }) {
      Text("ç›¸å…³æ¨è")
        .fontSize(22)
        .fontColor('#FFFFFF')
        .fontWeight(600)
        .margin({ bottom: 15 })
      
      // æ¨ªå‘æ»šåŠ¨çš„ç›¸å…³æ¨èåˆ—è¡?
      Scroller({
        style: {
          height: 250
        },
        scrollBar: BarState.Off
      }) {
        Row({
          style: {
            alignItems: 'flex-start',
            gap: 15
          }
        }) {
          ForEach(this.relatedMedia, (media: MediaItem) => {
            Column({
              style: {
                width: 150,
                marginRight: 15
              },
              onClick: () => this.handleRelatedMediaClick(media)
            }) {
              // ç›¸å…³æ¨èå°é¢
              Column({
                style: {
                  width: 150,
                  height: 200,
                  backgroundColor: '#E0E0E0',
                  borderRadius: 8,
                  justifyContent: 'center',
                  alignItems: 'center'
                }
              }) {
                Text("å°é¢")
                  .fontSize(16)
                  .fontColor('#666666')
              }
              
              // ç›¸å…³æ¨èæ ‡é¢˜
              Text(media.title || "")
                .fontSize(16)
                .fontColor('#FFFFFF')
                .margin({ top: 10, bottom: 5 })
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
              
              // ç›¸å…³æ¨èè¯„åˆ†
              Row({
                style: {
                  alignItems: 'center'
                }
              }) {
                Text("â­?)
                  .fontSize(14)
                  .marginRight(5)
                Text(media.score || "0.0")
                  .fontSize(14)
                  .fontColor('#FFFFFF')
              }
            }
          })
        }
      }
    }
  }
  
  build() {
    Column({
      style: {
        flex: 1,
        backgroundColor: '#4CAF50'
      }
    }) {
      // é¡¶éƒ¨å¯¼èˆªæ ?
      Row({
        style: {
          backgroundColor: '#388E3C',
          alignItems: 'center',
          justifyContent: 'space-between',
          paddingHorizontal: 20,
          paddingVertical: 15,
          width: '100%'
        }
      }) {
        Button({
          style: {
            backgroundColor: 'transparent'
          },
          onClick: this.handleBack
        }) {
          Text("è¿”å›")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        
        Text("è¯¦æƒ…")
          .fontSize(26)
          .fontColor('#FFFFFF')
          .fontWeight(700)
        
        Blank()
          .width(80)
      }
      
      // ä¸»å†…å®¹åŒºåŸ?
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€?
        Column({
          style: {
            flex: 1,
            justifyContent: 'center',
            alignItems: 'center'
          }
        }) {
          Text("åŠ è½½ä¸?.")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€?
        Column({
          style: {
            flex: 1,
            justifyContent: 'center',
            alignItems: 'center'
          }
        }) {
          Text(this.errorMessage)
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else {
        Scroller({
          style: {
            flex: 1,
            backgroundColor: '#4CAF50'
          }
        }) {
          // æ·»åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…è¢«å¯¼èˆªæ é®æŒ?
          Blank()
            .height(60)
          
          // åª’ä½“å¤´éƒ¨ä¿¡æ¯
          if (this.mediaDetail) {
            this.renderHeader();
          }
          
          // æ ‡ç­¾é¡µåˆ‡æ¢æ 
          this.renderTabBar();
          
          // å†…å®¹åŒºåŸŸ
          Column({
            style: {
              padding: { left: 20, right: 20, top: 20, bottom: 20 }
            }
          }) {
            if (this.activeTab === 'episodes') {
              this.renderEpisodes();
            } else {
              this.renderPlaySources();
            }
          }
          
          // ç›¸å…³æ¨è
          if (this.relatedMedia?.length > 0) {
            this.renderRelatedMedia();
          }
        }
      }
    }
  }
}
