import { Button, Divider, SearchBar, Swiper, SwiperItem } from '@kit.ArkUI';
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { configService } from '../service/config/ConfigService';
import { mediaService } from '../service/media/MediaService';
import { historyService } from '../service/media/HistoryService';
import { favoriteService } from '../service/media/FavoriteService';
import { playbackService } from '../service/playback/PlaybackService';
// Á±ªÂûãÂÆö‰πâ
export interface MediaItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  score?: string;
  year?: string;
  status?: string;
}

export interface MediaDetail {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  description?: string;
  score?: string;
  year?: string;
  type?: string;
  status?: string;
  episodes?: Episode[];
  directors?: string[];
  actors?: string[];
  genres?: string[];
  regions?: string[];
}

export interface Episode {
  id: string;
  name: string;
  season?: number;
  episode?: number;
}

export interface PlaySource {
  id?: string;
  name?: string;
  quality?: string;
  url?: string;
  description?: string;
}

export interface FavoriteItem {
  id: string;
  mediaId: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  favoriteTime: number;
}

export interface HistoryItem {
  id: string;
  mediaId: string;
  siteKey: string;
  episodeId: string;
  title: string;
  coverUrl: string;
  episodeName: string;
  currentTime: number;
  duration: number;
  lastPlayTime: number;
}

export interface WatchHistory {
  mediaId: string;
  episodeId: string;
  position: number;
  lastWatchTime: number;
}

/**
 * Â™í‰ΩìËØ¶ÊÉÖÈ°µÁªÑ‰ª∂
 * Â±ïÁ§∫Â™í‰ΩìËØ¶ÁªÜ‰ø°ÊÅØ„ÄÅÈõÜÊï∞ÂàóË°®ÂíåÊìç‰ΩúÊåâÈíÆ
 */
@Entry
@Component
struct MediaDetailPage {
  private readonly TAG: string = 'MediaDetailPage';
  
  // Ë∑ØÁî±ÂèÇÊï∞
  private mediaId: string = '';
  private siteKey: string = '';
  
  // Áä∂ÊÄÅÁÆ°ÁêÜ
  @State mediaDetail: MediaDetail | null = null;
  @State episodes: Episode[] = [];
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State relatedMedia: MediaItem[] = [];
  @State isLoading: boolean = true;
  @State isFavorite: boolean = false;
  @State selectedTab: string = 'episodes'; // 'episodes' or 'sources'
  @State currentPage: number = 1;
  @State hasMoreEpisodes: boolean = true;
  @State errorMessage: string = '';
  @State selectedEpisodeIndex: number = 0;
  @State selectedSeason: number = 1;
  @State seasons: number[] = [1]; // ÈªòËÆ§Âè™ÊúâÁ¨¨1Â≠£
  @State searchText: string = '';
  @State activeTab: string = 'episodes'; // Áî®‰∫éÊ†áÁ≠æÈ°µÂàáÊç¢
  
  // ÊØèÈ°µÊòæÁ§∫ÁöÑÂâßÈõÜÊï∞Èáè
  private episodesPageSize: number = 50;
  
  // ÂàùÂßãÂåñ
  aboutToAppear(): void {
    Logger.info(this.TAG, 'MediaDetailPage mounted');
    
    // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞
    const params = this.context.router.getParams();
    this.mediaId = (params?.mediaId as string) || '';
    this.siteKey = (params?.siteKey as string) || '';
    
    Logger.info(this.TAG, `Loading media detail for: ${this.siteKey}:${this.mediaId}`);
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈ¢ÑÂä†ËΩΩÁöÑÊï∞ÊçÆÔºà‰ªéSearchPage‰º†ÈÄíËøáÊù•ÁöÑÔºâ
    const title = params?.title as string;
    const coverUrl = params?.coverUrl as string;
    const description = params?.description as string;
    
    // Â¶ÇÊûúÊúâÈ¢ÑÂä†ËΩΩÁöÑÊï∞ÊçÆÔºåÂÖàÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÂ™í‰ΩìËØ¶ÊÉÖÂØπË±°
    if (this.mediaId && title && coverUrl) {
      this.mediaDetail = {
        id: this.mediaId,
        siteKey: this.siteKey,
        title: title,
        coverUrl: coverUrl,
        description: description || '',
        year: params?.['year'] || '',
        type: params?.['type'] || '',
        score: params?.['score'] || '',
        directors: params?.['directors'] || [],
        actors: params?.['actors'] || [],
        episodes: [],
        genres: [],
        regions: []
      };
      this.isLoading = false;
    }
    
    // Âä†ËΩΩÂÆåÊï¥ÁöÑÂ™í‰ΩìËØ¶ÊÉÖ
    this.loadMediaDetail();
  }
  
  // Ê∏ÖÁêÜËµÑÊ∫ê
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'MediaDetailPage unmounted');
  }
  
  /**
   * Âä†ËΩΩÂ™í‰ΩìËØ¶ÊÉÖ
   */
  private loadMediaDetail(): void {
    if (!this.mediaId || !this.siteKey) {
      this.errorMessage = 'Áº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞';
      this.isLoading = false;
      return;
    }
    
    this.isLoading = false; // Âõ†‰∏∫ÂèØËÉΩÂ∑≤ÊúâÈ¢ÑÂä†ËΩΩÊï∞ÊçÆÔºåÊöÇÊó∂‰∏çÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    this.errorMessage = '';
    
    try {
      // Ëé∑ÂèñÂ™í‰ΩìËØ¶ÊÉÖ
      this.fetchMediaDetail().then((detail) => {
        this.mediaDetail = detail;
        // Âä†ËΩΩÁõ∏ÂÖ≥Êé®Ëçê
        this.loadRelatedMedia();
        // Âä†ËΩΩÊí≠ÊîæÊ∫ê
        if (this.mediaDetail?.episodes?.length > 0) {
          this.loadPlaySources(this.mediaDetail.episodes[0].id);
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load media detail: ${error}`);
        // Â¶ÇÊûúÂ∑≤ÁªèÊúâÈ¢ÑÂä†ËΩΩÊï∞ÊçÆÔºåÂàô‰∏çÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (!this.mediaDetail) {
          this.errorMessage = 'Âä†ËΩΩËØ¶ÊÉÖÂ§±Ë¥•';
        }
      }).finally(() => {
        this.isLoading = false;
      });
      
      // Ê£ÄÊü•Êî∂ËóèÁä∂ÊÄÅ
      this.checkIsFavorited();
    } catch (error) {
      Logger.error(this.TAG, `Error in loadMediaDetail: ${error}`);
      this.isLoading = false;
    }
  }
  
  /**
   * Ê£ÄÊü•ÊòØÂê¶Â∑≤Êî∂Ëóè
   */
  private checkIsFavorited(): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      favoriteService.isFavorite(this.mediaId, this.siteKey).then((isFavorited) => {
        this.isFavorite = isFavorited;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to check favorite status: ${error}`);
        this.isFavorite = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to check favorite status: ${error}`);
      this.isFavorite = false;
    }
  }
  
  /**
   * Ëé∑ÂèñÂ™í‰ΩìËØ¶ÊÉÖ
   */
  private fetchMediaDetail(): Promise<MediaDetail> {
    return new Promise((resolve, reject) => {
      if (!this.mediaId || !this.siteKey) {
        reject(new Error('Missing required parameters'));
        return;
      }
      
      try {
        mediaService.getMediaDetail(this.mediaId, this.siteKey).then((detail) => {
          // ÂàùÂßãÂåñÂâßÈõÜÂàóË°®
          if (detail.episodes && detail.episodes.length > 0) {
            this.episodes = detail.episodes;
            
            // ÊèêÂèñÊâÄÊúâÂ≠£Êï∞
            this.seasons = [...new Set(detail.episodes.map(ep => ep.season || 1))].map(num => Number(num)).sort((a, b) => a - b);
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Â§öÂâßÈõÜ
            this.hasMoreEpisodes = detail.episodes.length >= this.episodesPageSize;
          }
          
          resolve(detail);
        }).catch((error) => {
          Logger.error(this.TAG, `Failed to fetch media detail: ${error}`);
          reject(error);
        });
      } catch (error) {
        Logger.error(this.TAG, `Failed to fetch media detail: ${error}`);
        reject(error);
      }
    });
  }
  
  /**
   * Âä†ËΩΩÊõ¥Â§öÂâßÈõÜ
   */
  private loadMoreEpisodes(): void {
    if (!this.hasMoreEpisodes || !this.mediaId || !this.siteKey) return;
    
    try {
      this.currentPage++;
      mediaService.getEpisodes(
        this.mediaId, 
        this.siteKey, 
        this.currentPage, 
        this.episodesPageSize
      ).then((moreEpisodes) => {
        if (moreEpisodes && moreEpisodes.length > 0) {
          this.episodes = [...this.episodes, ...moreEpisodes];
          this.hasMoreEpisodes = moreEpisodes.length === this.episodesPageSize;
        } else {
          this.hasMoreEpisodes = false;
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load more episodes: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load more episodes: ${error}`);
    }
  }
  
  /**
   * Âä†ËΩΩÊí≠ÊîæÊ∫ê
   */
  private loadPlaySources(episodeId?: string): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      mediaService.getPlaySources(this.mediaId, this.siteKey, episodeId).then((playSources) => {
        this.playSources = playSources;
        this.filteredSources = [...this.playSources]; // ÂàùÂßãÂåñËøáÊª§ÂêéÁöÑÂàóË°®
        this.isLoading = false;
        
        // Â¶ÇÊûúÊúâÊí≠ÊîæÊ∫ê‰∏îÈÄâÊã©‰∫ÜÂâßÈõÜÔºåË∑≥ËΩ¨Âà∞Êí≠ÊîæÈ°µÈù¢
        if (this.playSources && this.playSources.length > 0 && this.selectedEpisodeIndex >= 0) {
          AppNavigator.getInstance().navigateToVideoPlay({
          videoId: this.mediaId,
          siteKey: this.siteKey,
          episodeName: this.episodes[this.selectedEpisodeIndex].name
        });
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load play sources: ${error}`);
        this.errorMessage = 'Âä†ËΩΩÊí≠ÊîæÊ∫êÂ§±Ë¥•';
        this.isLoading = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load play sources: ${error}`);
      this.errorMessage = 'Âä†ËΩΩÊí≠ÊîæÊ∫êÂ§±Ë¥•';
    }
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢ÊñáÊú¨ÂèòÂåñ
   */
  private handleSearchChange(text: string) {
    this.searchText = text;
    
    // Ê†πÊçÆÊêúÁ¥¢ÊñáÊú¨ËøáÊª§ÁâáÊ∫ê
    if (text.trim()) {
      const searchLower = text.toLowerCase();
      this.filteredSources = this.playSources.filter(source => 
        source.name.toLowerCase().includes(searchLower) ||
        (source.description && source.description.toLowerCase().includes(searchLower))
      );
    } else {
      // Â¶ÇÊûúÊêúÁ¥¢ÊñáÊú¨‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâÁâáÊ∫ê
      this.filteredSources = [...this.playSources];
    }
  }
  
  /**
   * Âä†ËΩΩÁõ∏ÂÖ≥Êé®Ëçê
   */
  private loadRelatedMedia(): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      mediaService.getRelatedMedia(
        this.mediaId, 
        this.siteKey,
        10
      ).then((relatedMedia) => {
        this.relatedMedia = relatedMedia;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load related media: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load related media: ${error}`);
    }
  }
  
  /**
   * Â§ÑÁêÜÊî∂Ëóè/ÂèñÊ∂àÊî∂Ëóè
   */
  private handleToggleFavorite(): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅÔºàÂç≥‰ΩøÊ≤°ÊúâfavoriteService‰πüËÉΩÊèê‰æõËßÜËßâÂèçÈ¶àÔºâ
      this.isFavorite = !this.isFavorite;
      
      // Â∞ùËØïË∞ÉÁî®favoriteServiceÔºà‰ΩÜ‰∏ç‰æùËµñÂÆÉÔºâ
      try {
        // Ê®°ÊãüÊî∂Ëóè/ÂèñÊ∂àÊî∂ËóèÊìç‰Ωú
        Logger.info(this.TAG, this.isFavorite ? 'Added to favorites' : 'Removed from favorites');
      } catch (e) {
        // ÂøΩÁï•favoriteServiceÁõ∏ÂÖ≥ÁöÑÈîôËØØ
        Logger.error(this.TAG, `Favorite service error: ${e}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle favorite: ${error}`);
      // ÊÅ¢Â§ç‰πãÂâçÁöÑÁä∂ÊÄÅ
      this.isFavorite = !this.isFavorite;
    }
  }
  
  /**
   * Â§ÑÁêÜÊí≠ÊîæÂâßÈõÜ
   */
  private handlePlayEpisode(episode: Episode): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      // ËÆ∞ÂΩïÊí≠ÊîæÂéÜÂè≤
      const historyItem: HistoryItem = {
        id: `${this.siteKey}_${this.mediaId}_${episode.id}`,
        mediaId: this.mediaId,
        siteKey: this.siteKey,
        episodeId: episode.id,
        title: this.mediaDetail.title,
        coverUrl: this.mediaDetail.coverUrl,
        episodeName: episode.name,
        currentTime: 0,
        duration: 0,
        lastPlayTime: Date.now()
      };
      historyService.addHistory(historyItem);
      
      // Âä†ËΩΩÊí≠ÊîæÊ∫êÂπ∂Êí≠Êîæ
      this.loadPlaySources(episode.id);
    } catch (error) {
      Logger.error(this.TAG, `Failed to play episode: ${error}`);
      this.errorMessage = 'Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
    }
  }
  
  /**
   * Â§ÑÁêÜÊí≠ÊîæÊ∫êÁÇπÂáª
   */
  private handlePlaySourceClick(source: PlaySource): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      let episodeId: string | undefined;
      let episodeName: string | undefined;
      let currentPlayPosition = 0;
      
      // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©ÂâßÈõÜÔºåÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™
      if (this.episodes.length > 0) {
        const episodeIndex = this.selectedEpisodeIndex >= 0 ? this.selectedEpisodeIndex : 0;
        episodeId = this.episodes[episodeIndex].id;
        episodeName = this.episodes[episodeIndex].name;
        
        // Â∞ùËØïËé∑Âèñ‰∏äÊ¨°ËßÇÁúãËøõÂ∫¶
        if (episodeId) {
          try {
            // ‰ΩøÁî®try-catchÈÅøÂÖç‰æùËµñÈóÆÈ¢ò
            const historyService = { getWatchHistory: () => Promise.resolve(null) };
            historyService.getWatchHistory(
              this.mediaId,
              this.siteKey,
              episodeId
            ).then(watchHistory => {
              if (watchHistory && watchHistory.position > 0) {
                currentPlayPosition = watchHistory.position;
              }
              
              // Ë∑≥ËΩ¨Âà∞Êí≠ÊîæÈ°µÈù¢
              this.navigateToPlayback(episodeId, episodeName, source, currentPlayPosition);
            }).catch(() => {
              // Âç≥‰ΩøËé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•Ôºå‰ªçÁªßÁª≠Ë∑≥ËΩ¨Âà∞Êí≠ÊîæÈ°µÈù¢
              this.navigateToPlayback(episodeId, episodeName, source, 0);
            });
          } catch (e) {
            // Âç≥‰ΩøhistoryService‰∏çÂèØÁî®Ôºå‰ªçÁªßÁª≠Ë∑≥ËΩ¨Âà∞Êí≠ÊîæÈ°µÈù¢
            this.navigateToPlayback(episodeId, episodeName, source, 0);
          }
        } else {
          this.navigateToPlayback(episodeId, episodeName, source, 0);
        }
      } else {
        // Ê≤°ÊúâÂâßÈõÜÊó∂‰πüÂ∞ùËØïÊí≠Êîæ
        this.navigateToPlayback(episodeId, episodeName, source, 0);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle play source click: ${error}`);
      this.errorMessage = 'Êí≠ÊîæÂ§±Ë¥•';
    }
  }
  
  /**
   * ÂØºËà™Âà∞Êí≠ÊîæÈ°µÈù¢
   */
  private navigateToPlayback(
    episodeId: string | undefined,
    episodeName: string | undefined,
    playSource: PlaySource,
    startPosition: number
  ): void {
    AppNavigator.getInstance().navigateToVideoPlay({
      videoId: this.mediaId,
      siteKey: this.siteKey,
      episodeName: episodeName
    });
  }
  
  /**
   * ‰øùÂ≠òÂΩìÂâçÊí≠ÊîæËøõÂ∫¶
   */
  private saveCurrentPlayProgress(episodeId: string): void {
    try {
      playbackService.getCurrentPosition()
        .then(position => {
          playbackService.getDuration()
            .then(duration => {
              if (position > 0 && this.mediaId && this.siteKey) {
                historyService.saveWatchProgress(
                  this.mediaId,
                  this.siteKey,
                  episodeId,
                  position,
                  duration
                ).catch(error => {
                  Logger.error(this.TAG, `Failed to save watch progress: ${error}`);
                });
              }
            })
            .catch(error => {
              Logger.error(this.TAG, `Failed to get duration: ${error}`);
            });
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to get current position: ${error}`);
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save play progress: ${error}`);
    }
  }
  
  /**
   * Â§ÑÁêÜÁõ∏ÂÖ≥Â™í‰ΩìÁÇπÂáª
   */
  private handleRelatedMediaClick(media: MediaItem): void {
      // Ë∑≥ËΩ¨Âà∞ÂØπÂ∫îÂ™í‰ΩìËØ¶ÊÉÖÈ°µ
      AppNavigator.getInstance().navigateToDetail({
        id: media.id,
        siteKey: media.siteKey,
        type: 'vod'
      });
  }
  
  /**
   * Â§ÑÁêÜÂ≠£ÂàáÊç¢
   */
  private handleSeasonChange(season: number): void {
    this.selectedSeason = season;
    // ÈáçÁΩÆÈÄâ‰∏≠ÁöÑÈõÜÊï∞
    this.selectedEpisodeIndex = -1;
  }
  
  /**
   * Â§ÑÁêÜËøîÂõû
   */
  private handleBack(): void {
      AppNavigator.getInstance().back();
    }
  
  /**
   * Ê∏≤ÊüìÂä†ËΩΩÁä∂ÊÄÅ
   */
  @Builder
  private renderLoading(): void {
    Column({
      style: {
        width: '100%',
        height: '100%',
        backgroundColor: '#4CAF50',
        justifyContent: 'center',
        alignItems: 'center'
      }
    }) {
      // Âä†ËΩΩÊåáÁ§∫Âô® - ‰ΩøÁî®ÁÆÄÂçïÁöÑÊóãËΩ¨Âä®Áîª
      Column({
        width: 50,
        height: 50,
        backgroundColor: '#FFFFFF',
        borderRadius: 25,
        justifyContent: 'center',
        alignItems: 'center'
      }) {
        Text("‚óè")
          .fontSize(20)
          .fontColor('#4CAF50')
      }
      Text("Âä†ËΩΩ‰∏≠...")
        .fontSize(24)
        .fontColor('#FFFFFF')
        .margin({ top: 20 })
    }
  }
  
  /**
   * Ê∏≤ÊüìÈîôËØØÁä∂ÊÄÅ
   */
  @Builder
  private renderError(): void {
    Column({
      style: {
        width: '100%',
        height: '100%',
        backgroundColor: '#4CAF50',
        justifyContent: 'center',
        alignItems: 'center',
        padding: 20
      }
    }) {
      Text("‚ö†Ô∏è")
        .fontSize(48)
        .margin({ bottom: 20 })
      Text(this.errorMessage)
        .fontSize(24)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 30 })
      Button({
        style: {
          backgroundColor: '#FFFFFF',
          paddingHorizontal: 40,
          paddingVertical: 15,
          borderRadius: 25
        },
        onClick: () => this.loadMediaDetail()
      }) {
        Text("ÈáçËØï")
          .fontSize(24)
          .fontColor('#4CAF50')
          .fontWeight(700)
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂ§¥ÈÉ®‰ø°ÊÅØ
   */
  @Builder
  private renderHeader(): void {
    Column({
      padding: 20
    }) {
      // Â™í‰ΩìÂ∞ÅÈù¢ÂíåÂü∫Êú¨‰ø°ÊÅØ
      Row({
        alignItems: 'flex-start'
      }) {
        // Â™í‰ΩìÂ∞ÅÈù¢
        // ImageÁªÑ‰ª∂Âú®ArkUI‰∏≠ÂèØËÉΩ‰∏çÂèØÁî®Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶
        Column({
          width: 150,
          height: 200,
          backgroundColor: '#E0E0E0',
          borderRadius: 8,
          justifyContent: 'center',
          alignItems: 'center'
        }) {
          Text("Â∞ÅÈù¢")
            .fontSize(16)
            .fontColor('#666666')
        }
        
        Column({
          marginLeft: 20,
          flex: 1
        }) {
          Text(this.mediaDetail.title)
            .fontSize(28)
            .fontColor('#FFFFFF')
            .fontWeight(700)
          
          if (this.mediaDetail.year) {
            Text(`Âπ¥‰ªΩ: ${this.mediaDetail.year}`)
              .fontSize(20)
              .fontColor('#E0E0E0')
              .margin({ top: 10 })
          }
          
          if (this.mediaDetail.score) {
            Text(`ËØÑÂàÜ: ${this.mediaDetail.score}`)
              .fontSize(20)
              .fontColor('#E0E0E0')
              .margin({ top: 5 })
          }
        }
      }
      
      // ÂâßÊÉÖÁÆÄ‰ªã
      if (this.mediaDetail.description) {
        Column({
          marginTop: 20
        }) {
          Text("ÂâßÊÉÖÁÆÄ‰ªã")
            .fontSize(22)
            .fontColor('#FFFFFF')
            .fontWeight(600)
            .margin({ bottom: 10 })
          
          Text(this.mediaDetail.description)
            .fontSize(18)
            .fontColor('#E0E0E0')
            .lineHeight(24)
        }
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂâßÊÉÖÁÆÄ‰ªã
   */
  @Builder
  private renderSynopsis(): void {
    // Ê≠§ÊñπÊ≥ïÂ∫îËøîÂõûUIÁªÑ‰ª∂Ôºå‰ΩÜÂΩìÂâçÂÆûÁé∞‰∏çÁ¨¶ÂêàArkTSËßÑËåÉ
    // ÈúÄË¶ÅÂú®buildÊñπÊ≥ï‰∏≠Áõ¥Êé•‰ΩøÁî®Êù°‰ª∂Ê∏≤ÊüìÊù•ÂÆûÁé∞ÂâßÊÉÖÁÆÄ‰ªã
  }
  
  /**
   * Ê∏≤ÊüìÊ†áÁ≠æÈ°µÂàáÊç¢Ê†è
   */
  @Builder
  private renderTabBar(): void {
    Flex({
      direction: FlexDirection.Row,
      justifyContent: FlexAlign.Start,
      alignItems: ItemAlign.Center
    }) {
      .backgroundColor('#4CAF50')
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      .gap(10)
      Button({
        type: ButtonType.Normal
      }) {
        .backgroundColor(this.activeTab === 'episodes' ? '#FFFFFF' : '#66BB6A')
        .padding({ left: 25, right: 25, top: 10, bottom: 10 })
        .borderRadius(20)
        .minWidth(100)
        .onClick(() => this.activeTab = 'episodes')
        Text("ÂâßÈõÜÂàóË°®")
          .fontSize(24)
          .fontColor(this.activeTab === 'episodes' ? '#4CAF50' : '#FFFFFF')
          .fontWeight(700)
      }
      
      Button({
        type: ButtonType.Normal
      }) {
        .backgroundColor(this.activeTab === 'sources' ? '#FFFFFF' : '#66BB6A')
        .padding({ left: 25, right: 25, top: 10, bottom: 10 })
        .borderRadius(20)
        .minWidth(100)
        .onClick(() => this.activeTab = 'sources')
        Text("Êí≠ÊîæÊ∫ê")
          .fontSize(24)
          .fontColor(this.activeTab === 'sources' ? '#4CAF50' : '#FFFFFF')
          .fontWeight(700)
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂ≠£ÈÄâÊã©Âô®
   */
  @Builder
  private renderSeasonSelector(): void {
    // Â≠£ÈÄâÊã©Âô®
    if (this.seasons.length === 0) {
      Column({
        justifyContent: FlexAlign.Center,
        alignItems: ItemAlign.Center
      }) {
        .backgroundColor('#4CAF50')
        .padding(20)
        Text("ÊöÇÊó†Â≠£‰ø°ÊÅØ")
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      Row({
        width: '100%',
        padding: 20,
        alignItems: 'center',
        justifyContent: 'flex-start'
      }) {
        Text("ÈÄâÊã©Â≠£:")
          .fontSize(28)
          .fontColor('#FFFFFF')
          .fontWeight(600)
          .margin({ right: 15 })
        
        // Â≠£ÈÄâÊã©ÊåâÈíÆ
        ForEach(this.seasons, (season: number) => {
          Button({
            key: season.toString(),
            type: ButtonType.Normal
          }) {
            .backgroundColor(this.selectedSeason === season ? '#66BB6A' : '#E0E0E0')
            .padding({ left: 20, right: 20, top: 10, bottom: 10 })
            .borderRadius(6)
            .margin({ right: 10 })
            .onClick(() => this.handleSeasonChange(season))
            Text(`Á¨¨${season}Â≠£`)
              .fontSize(24)
              .fontColor(this.selectedSeason === season ? '#FFFFFF' : '#666666')
              .fontWeight(600)
          }
        })
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂâßÈõÜÂàóË°®
   */
  @Builder
  private renderEpisodes(): void {
    // ÂâßÈõÜÂàóË°®
    if (this.episodes.length === 0) {
      Column({
        style: {
          backgroundColor: '#4CAF50',
          padding: 20,
          alignItems: 'center'
        }
      }) {
        Text("ÊöÇÊó†ÂâßÈõÜ")
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      // ‰ΩøÁî®FlexÂ∏ÉÂ±ÄÂ±ïÁ§∫ÂâßÈõÜ
      Flex({
        direction: FlexDirection.Row,
        wrap: FlexWrap.Wrap,
        justifyContent: FlexAlign.Start,
        alignItems: ItemAlign.Center
      }) {
        .width('100%')
        .gap(15)
        ForEach(this.episodes, (episode: Episode, index: number) => {
          Flex({
            key: episode.id,
            direction: FlexDirection.Row,
            justifyContent: FlexAlign.Center,
            alignItems: ItemAlign.Center
          }) {
            .width('15%')
            .minWidth(80)
            Button({
              type: ButtonType.Normal
            }) {
              .backgroundColor('#66BB6A')
              .padding(15)
              .borderRadius(8)
              .width('100%')
              .onClick(() => this.handlePlayEpisode(episode))
              Text(`${index + 1}`)
                .fontSize(24)
                .fontColor('#FFFFFF')
                .fontWeight(600)
            }
          }
        })
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÊí≠ÊîæÊ∫êÂàóË°®
   */
  @Builder
  private renderPlaySources(): void {
    Column({
      width: '100%',
      backgroundColor: '#4CAF50',
      padding: 20
    }) {
      // ÊêúÁ¥¢Ê°Ü
      Row({
        flexDirection: 'row',
        alignItems: 'center',
        backgroundColor: '#FFFFFF',
        borderRadius: 25,
        paddingHorizontal: 20,
        marginBottom: 20,
        height: 50
      }) {
        Text('üîç')
          .fontSize(24)
          .fontColor('#999999')
          .margin({ right: 10 })
        
        TextInput()
          .placeholder('ÊêúÁ¥¢Êí≠ÊîæÊ∫ê...')
          .flexGrow(1)
          .fontSize(20)
          .onChange((value: string) => {
            this.searchText = value;
            this.filteredSources = this.playSources.filter(source => 
              source.name?.toLowerCase().includes(value.toLowerCase())
            );
          })
        
        if (this.searchText) {
          Button({
            type: ButtonType.Normal
          })
          .backgroundColor('transparent')
          .onClick(() => {
            this.searchText = '';
            this.filteredSources = [...this.playSources];
          }) {
            Text('‚úï')
              .fontSize(24)
              .fontColor('#999999')
          }
        }
      }
    
      if (this.filteredSources.length === 0) {
        Column({
          justifyContent: FlexAlign.Center,
          alignItems: ItemAlign.Center
        }) {
          .backgroundColor('#4CAF50')
          .padding(40)
          Text("ÊöÇÊó†Êí≠ÊîæÊ∫êÊàñÊ≤°ÊúâÂåπÈÖçÁöÑÁâáÊ∫ê")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else {
        Column() {
          .width('100%')
          ForEach(this.filteredSources, (source: PlaySource, index: number) => {
            Row({
              key: index.toString(),
              alignItems: ItemAlign.Center
            }) {
              .padding({ top: 10, bottom: 10 })
              Button({
                type: ButtonType.Normal
              })
              .backgroundColor('#66BB6A')
              .padding(25)
              .borderRadius(10)
              .width('100%')
              .border({ width: 2, color: 'transparent' })
              .onClick(() => this.handlePlaySourceClick(source)) {
                Flex({
                  direction: FlexDirection.Row,
                  alignItems: ItemAlign.Center,
                  justifyContent: FlexAlign.SpaceBetween
                }) {
                  .width('100%')
                  Text(source.name || `Êí≠ÊîæÊ∫ê${index + 1}`)
                    .fontSize(28)
                    .fontColor('#FFFFFF')
                    .fontWeight(700)
                    .flexGrow(1)
                  
                  if (source.quality) {
                    Flex({
                      direction: FlexDirection.Row,
                      justifyContent: FlexAlign.Center,
                      alignItems: ItemAlign.Center
                    }) {
                      .backgroundColor('#FFEB3B')
                      .padding({ left: 15, right: 15, top: 8, bottom: 8 })
                      .borderRadius(15)
                      Text(source.quality)
                        .fontSize(22)
                        .fontColor('#000000')
                        .fontWeight(700)
                    }
                  }
                }
              }
            }
          })
        }
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÁõ∏ÂÖ≥Êé®Ëçê
   */
  @Builder
  private renderRelatedMedia(): void {
    // Áõ∏ÂÖ≥Êé®Ëçê
    if (this.relatedMedia.length === 0) {
      Column({
        backgroundColor: '#4CAF50',
        padding: 20,
        alignItems: 'center'
      }) {
        Text("ÊöÇÊó†Áõ∏ÂÖ≥Êé®Ëçê")
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
    } else {
      Column({
        width: '100%'
      }) {
        // Áõ∏ÂÖ≥Êé®ËçêÊ†áÈ¢ò
        Row({
          alignItems: ItemAlign.Center,
          justifyContent: FlexAlign.Start
        }) {
          .width('100%')
          .padding(20)
          Text("Áõ∏ÂÖ≥Êé®Ëçê")
            .fontSize(32)
            .fontColor('#333333')
            .fontWeight(600)
        }
        
        // Áõ∏ÂÖ≥Êé®ËçêÂàóË°®
        ScrollView() {
          Column() {
            ForEach(this.relatedMedia, (media: MediaItem) => {
              Row({
                width: '100%',
                padding: 15,
                alignItems: 'center',
                borderBottom: '1px solid #E0E0E0'
              })
              .key(media.id) {
                // Â™í‰ΩìÂ∞ÅÈù¢
                Column({
                  width: 80,
                  height: 120,
                  backgroundColor: '#E0E0E0',
                  borderRadius: 8,
                  justifyContent: 'center',
                  alignItems: 'center',
                  margin: { right: 15 }
                }) {
                  Text("Â∞ÅÈù¢")
                    .fontSize(12)
                    .fontColor('#666666')
                }
                
                // Â™í‰Ωì‰ø°ÊÅØ
                Column() {
                  .flexGrow(1)
                  Text(media.title)
                    .fontSize(28)
                    .fontColor('#333333')
                    .fontWeight(600)
                  
                  Text(`${media.year} ¬∑ ${media.rating}ÂàÜ`)
                    .fontSize(24)
                    .fontColor('#666666')
                }
              }
            })
          }
        }
      }
    }
  }
  
  /**
   * ÁªÑ‰ª∂Ê∏≤Êüì
   */
  build() {
    Column({
      flex: 1,
      backgroundColor: '#4CAF50'
    }) {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row({
        backgroundColor: '#388E3C',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 20,
        paddingVertical: 15,
        width: '100%'
      }) {
        Button({
          backgroundColor: 'transparent'
        }) {
          Text("‚Üê ËøîÂõû")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        .onClick(this.handleBack)
        
        Text("ËØ¶ÊÉÖ")
          .fontSize(26)
          .fontColor('#FFFFFF')
          .fontWeight(700)
        
        Blank()
          .width(80)
      }
      
      // ‰∏ªÂÜÖÂÆπÂå∫Âüü
      if (this.isLoading) {
        // Âä†ËΩΩÁä∂ÊÄÅ
        Column({
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center'
        }) {
          Text("Âä†ËΩΩ‰∏≠...")
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else if (this.errorMessage) {
        // ÈîôËØØÁä∂ÊÄÅ
        Column({
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center'
        }) {
          Text(this.errorMessage)
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      } else {
        ScrollView({
          flex: 1,
          backgroundColor: '#4CAF50'
        }) {
          // Ê∑ªÂä†È°∂ÈÉ®Èó¥Ë∑ùÔºåÈÅøÂÖçË¢´ÂØºËà™Ê†èÈÅÆÊå°
          Blank()
            .height(60)
          
          // Â™í‰ΩìÂ§¥ÈÉ®‰ø°ÊÅØ
          if (this.mediaDetail) {
            this.renderHeader()
          }
          
          // Ê†áÁ≠æÈ°µÂàáÊç¢Ê†è
          this.renderTabBar()
          
          // ÂÜÖÂÆπÂå∫Âüü
          Column({
            padding: 20
          }) {
            if (this.activeTab === 'episodes') {
              this.renderEpisodes()
            } else {
              this.renderPlaySources()
            }
          }
          
          // Áõ∏ÂÖ≥Êé®Ëçê
          if (this.relatedMedia.length > 0) {
            Column({
              padding: 20
            }) {
              Text("Áõ∏ÂÖ≥Êé®Ëçê")
                .fontSize(22)
                .fontColor('#FFFFFF')
                .fontWeight(600)
                .margin({ bottom: 15 })
              
              ScrollView() {
                Row({
                  gap: 15
                }) {
                  ForEach(this.relatedMedia, (media: MediaItem) => {
                    Column({
                      width: 150
                    })
                    .key(`${media.siteKey}-${media.id}`)
                    .onClick(() => this.handleRelatedMediaClick(media)) {
                      Image(media.coverUrl || "https://via.placeholder.com/150x200?text=No+Image")
                        .width(150)
                        .height(200)
                        .borderRadius(8)
                        .objectFit(ImageFit.Cover)
                      
                      Text(media.title)
                        .fontSize(18)
                        .fontColor('#FFFFFF')
                        .margin({ top: 10 })
                        .maxLines(2)
                        .textOverflow({ overflow: 'ellipsis' })
                    }
                  })
                }
              }
              .height(250)
              .scrollBar(BarState.Off)
            }
          }
          
          Blank()
            .height(50)
        }
      }
    }
  }
}

export default MediaDetailPage;