import { ScrollView, Image, Text, Button, List, ListItem, Divider, LoadingProgress, Tag, SearchBar, Stack, Flex, Blank, TextInput, Grid, GridItem, Swiper, SwiperItem } from '@kit.ArkUI';
import { Router } from '@ohos.router';
import Logger from '../common/util/Logger';
import ConfigService from '../service/config/ConfigService';
import MediaService from '../service/media/MediaService';
import HistoryService from '../service/media/HistoryService';
import FavoriteService from '../service/media/FavoriteService';
// ç±»å‹å®šä¹‰
export interface MediaItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  score?: string;
  year?: string;
  status?: string;
}

export interface MediaDetail {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  description?: string;
  score?: string;
  year?: string;
  type?: string;
  status?: string;
  episodes?: Episode[];
  directors?: string[];
  actors?: string[];
  genres?: string[];
  regions?: string[];
}

export interface Episode {
  id: string;
  name: string;
  season?: number;
  episode?: number;
}

export interface PlaySource {
  id?: string;
  name?: string;
  quality?: string;
  url?: string;
  description?: string;
}

export interface FavoriteItem {
  id: string;
  mediaId: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type?: string;
  favoriteTime: number;
}

export interface HistoryItem {
  id: string;
  mediaId: string;
  siteKey: string;
  episodeId: string;
  title: string;
  coverUrl: string;
  episodeName: string;
  currentTime: number;
  duration: number;
  lastPlayTime: number;
}

export interface WatchHistory {
  mediaId: string;
  episodeId: string;
  position: number;
  lastWatchTime: number;
}

/**
 * åª’ä½“è¯¦æƒ…é¡µç»„ä»¶
 * å±•ç¤ºåª’ä½“è¯¦ç»†ä¿¡æ¯ã€é›†æ•°åˆ—è¡¨å’Œæ“ä½œæŒ‰é’®
 */
@Component
struct MediaDetailPage {
  private readonly TAG: string = 'MediaDetailPage';
  
  // è·¯ç”±å‚æ•°
  private mediaId: string = '';
  private siteKey: string = '';
  
  // çŠ¶æ€ç®¡ç†
  @State mediaDetail: MediaDetail | null = null;
  @State episodes: Episode[] = [];
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State relatedMedia: MediaItem[] = [];
  @State isLoading: boolean = true;
  @State isFavorite: boolean = false;
  @State selectedTab: string = 'episodes'; // 'episodes' or 'sources'
  @State currentPage: number = 1;
  @State hasMoreEpisodes: boolean = true;
  @State errorMessage: string = '';
  @State selectedEpisodeIndex: number = 0;
  @State selectedSeason: number = 1;
  @State seasons: number[] = [1]; // é»˜è®¤åªæœ‰ç¬¬1å­£
  @State searchText: string = '';
  @State activeTab: string = 'episodes'; // ç”¨äºæ ‡ç­¾é¡µåˆ‡æ¢
  
  // æ¯é¡µæ˜¾ç¤ºçš„å‰§é›†æ•°é‡
  private episodesPageSize: number = 50;
  
  // åˆå§‹åŒ–
  aboutToAppear(): void {
    Logger.info(this.TAG, 'MediaDetailPage mounted');
    
    // è·å–è·¯ç”±å‚æ•°
    const params = Router.getParams();
    this.mediaId = params?.['mediaId'] || '';
    this.siteKey = params?.['siteKey'] || '';
    
    Logger.info(this.TAG, `Loading media detail for: ${this.siteKey}:${this.mediaId}`);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åŠ è½½çš„æ•°æ®ï¼ˆä»SearchPageä¼ é€’è¿‡æ¥çš„ï¼‰
    const title = params?.['title'];
    const coverUrl = params?.['coverUrl'];
    const description = params?.['description'];
    
    // å¦‚æœæœ‰é¢„åŠ è½½çš„æ•°æ®ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åª’ä½“è¯¦æƒ…å¯¹è±¡
    if (this.mediaId && title && coverUrl) {
      this.mediaDetail = {
        id: this.mediaId,
        siteKey: this.siteKey,
        title: title,
        coverUrl: coverUrl,
        description: description || '',
        year: params?.['year'] || '',
        type: params?.['type'] || '',
        score: params?.['score'] || '',
        directors: params?.['directors'] || [],
        actors: params?.['actors'] || [],
        episodes: [],
        genres: [],
        regions: []
      };
      this.isLoading = false;
    }
    
    // åŠ è½½å®Œæ•´çš„åª’ä½“è¯¦æƒ…
    this.loadMediaDetail();
  }
  
  // æ¸…ç†èµ„æº
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'MediaDetailPage unmounted');
  }
  
  /**
   * åŠ è½½åª’ä½“è¯¦æƒ…
   */
  private loadMediaDetail(): void {
    if (!this.mediaId || !this.siteKey) {
      this.errorMessage = 'ç¼ºå°‘å¿…è¦å‚æ•°';
      this.isLoading = false;
      return;
    }
    
    this.isLoading = false; // å› ä¸ºå¯èƒ½å·²æœ‰é¢„åŠ è½½æ•°æ®ï¼Œæš‚æ—¶ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.errorMessage = '';
    
    try {
      // è·å–åª’ä½“è¯¦æƒ…
      this.fetchMediaDetail().then((detail) => {
        this.mediaDetail = detail;
        // åŠ è½½ç›¸å…³æ¨è
        this.loadRelatedMedia();
        // åŠ è½½æ’­æ”¾æº
        if (this.mediaDetail?.episodes?.length > 0) {
          this.loadPlaySources(this.mediaDetail.episodes[0].id);
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load media detail: ${error}`);
        // å¦‚æœå·²ç»æœ‰é¢„åŠ è½½æ•°æ®ï¼Œåˆ™ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (!this.mediaDetail) {
          this.errorMessage = 'åŠ è½½è¯¦æƒ…å¤±è´¥';
        }
      }).finally(() => {
        this.isLoading = false;
      });
      
      // æ£€æŸ¥æ”¶è—çŠ¶æ€
      this.checkIsFavorited();
    } catch (error) {
      Logger.error(this.TAG, `Error in loadMediaDetail: ${error}`);
      this.isLoading = false;
    }
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
   */
  private checkIsFavorited(): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      favoriteService.isFavorite(this.mediaId, this.siteKey).then((isFavorited) => {
        this.isFavorite = isFavorited;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to check favorite status: ${error}`);
        this.isFavorite = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to check favorite status: ${error}`);
      this.isFavorite = false;
    }
  }
  
  /**
   * è·å–åª’ä½“è¯¦æƒ…
   */
  private fetchMediaDetail(): Promise<MediaDetail> {
    return new Promise((resolve, reject) => {
      if (!this.mediaId || !this.siteKey) {
        reject(new Error('Missing required parameters'));
        return;
      }
      
      try {
        mediaService.getMediaDetail(this.mediaId, this.siteKey).then((detail) => {
          // åˆå§‹åŒ–å‰§é›†åˆ—è¡¨
          if (detail.episodes && detail.episodes.length > 0) {
            this.episodes = detail.episodes;
            
            // æå–æ‰€æœ‰å­£æ•°
            this.seasons = [...new Set(detail.episodes.map(ep => ep.season || 1))].map(num => Number(num)).sort((a, b) => a - b);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šå‰§é›†
            this.hasMoreEpisodes = detail.episodes.length >= this.episodesPageSize;
          }
          
          resolve(detail);
        }).catch((error) => {
          Logger.error(this.TAG, `Failed to fetch media detail: ${error}`);
          reject(error);
        });
      } catch (error) {
        Logger.error(this.TAG, `Failed to fetch media detail: ${error}`);
        reject(error);
      }
    });
  }
  
  /**
   * åŠ è½½æ›´å¤šå‰§é›†
   */
  private loadMoreEpisodes(): void {
    if (!this.hasMoreEpisodes || !this.mediaId || !this.siteKey) return;
    
    try {
      this.currentPage++;
      mediaService.getEpisodes(
        this.mediaId, 
        this.siteKey, 
        this.currentPage, 
        this.episodesPageSize
      ).then((moreEpisodes) => {
        if (moreEpisodes && moreEpisodes.length > 0) {
          this.episodes = [...this.episodes, ...moreEpisodes];
          this.hasMoreEpisodes = moreEpisodes.length === this.episodesPageSize;
        } else {
          this.hasMoreEpisodes = false;
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load more episodes: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load more episodes: ${error}`);
    }
  }
  
  /**
   * åŠ è½½æ’­æ”¾æº
   */
  private loadPlaySources(episodeId?: string): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      mediaService.getPlaySources(this.mediaId, this.siteKey, episodeId).then((playSources) => {
        this.playSources = playSources;
        this.filteredSources = [...this.playSources]; // åˆå§‹åŒ–è¿‡æ»¤åçš„åˆ—è¡¨
        this.isLoading = false;
        
        // å¦‚æœæœ‰æ’­æ”¾æºä¸”é€‰æ‹©äº†å‰§é›†ï¼Œè·³è½¬åˆ°æ’­æ”¾é¡µé¢
        if (this.playSources && this.playSources.length > 0 && this.selectedEpisodeIndex >= 0) {
          Router.pushUrl({
            url: 'pages/PlaybackPage',
            params: {
              mediaId: this.mediaId,
              siteKey: this.siteKey,
              episodeId: this.episodes[this.selectedEpisodeIndex].id,
              playSourceIndex: 0,
              mediaTitle: this.mediaDetail?.title || '',
              episodeName: this.episodes[this.selectedEpisodeIndex].name
            }
          });
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load play sources: ${error}`);
        this.errorMessage = 'åŠ è½½æ’­æ”¾æºå¤±è´¥';
        this.isLoading = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load play sources: ${error}`);
      this.errorMessage = 'åŠ è½½æ’­æ”¾æºå¤±è´¥';
    }
  }
  
  /**
   * å¤„ç†æœç´¢æ–‡æœ¬å˜åŒ–
   */
  private handleSearchChange(text: string) {
    this.searchText = text;
    
    // æ ¹æ®æœç´¢æ–‡æœ¬è¿‡æ»¤ç‰‡æº
    if (text.trim()) {
      const searchLower = text.toLowerCase();
      this.filteredSources = this.playSources.filter(source => 
        source.name.toLowerCase().includes(searchLower) ||
        (source.description && source.description.toLowerCase().includes(searchLower))
      );
    } else {
      // å¦‚æœæœç´¢æ–‡æœ¬ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç‰‡æº
      this.filteredSources = [...this.playSources];
    }
  }
  
  /**
   * åŠ è½½ç›¸å…³æ¨è
   */
  private loadRelatedMedia(): void {
    if (!this.mediaId || !this.siteKey) return;
    
    try {
      mediaService.getRelatedMedia(
        this.mediaId, 
        this.siteKey,
        10
      ).then((relatedMedia) => {
        this.relatedMedia = relatedMedia;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load related media: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load related media: ${error}`);
    }
  }
  
  /**
   * å¤„ç†æ”¶è—/å–æ¶ˆæ”¶è—
   */
  private handleToggleFavorite(): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      // åˆ‡æ¢æ”¶è—çŠ¶æ€ï¼ˆå³ä½¿æ²¡æœ‰favoriteServiceä¹Ÿèƒ½æä¾›è§†è§‰åé¦ˆï¼‰
      this.isFavorite = !this.isFavorite;
      
      // å°è¯•è°ƒç”¨favoriteServiceï¼ˆä½†ä¸ä¾èµ–å®ƒï¼‰
      try {
        // æ¨¡æ‹Ÿæ”¶è—/å–æ¶ˆæ”¶è—æ“ä½œ
        Logger.info(this.TAG, this.isFavorite ? 'Added to favorites' : 'Removed from favorites');
      } catch (e) {
        // å¿½ç•¥favoriteServiceç›¸å…³çš„é”™è¯¯
        Logger.error(this.TAG, `Favorite service error: ${e}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle favorite: ${error}`);
      // æ¢å¤ä¹‹å‰çš„çŠ¶æ€
      this.isFavorite = !this.isFavorite;
    }
  }
  
  /**
   * å¤„ç†æ’­æ”¾å‰§é›†
   */
  private handlePlayEpisode(episode: Episode): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      // è®°å½•æ’­æ”¾å†å²
      const historyItem: HistoryItem = {
        id: `${this.siteKey}_${this.mediaId}_${episode.id}`,
        mediaId: this.mediaId,
        siteKey: this.siteKey,
        episodeId: episode.id,
        title: this.mediaDetail.title,
        coverUrl: this.mediaDetail.coverUrl,
        episodeName: episode.name,
        currentTime: 0,
        duration: 0,
        lastPlayTime: Date.now()
      };
      historyService.addHistory(historyItem);
      
      // åŠ è½½æ’­æ”¾æºå¹¶æ’­æ”¾
      this.loadPlaySources(episode.id);
    } catch (error) {
      Logger.error(this.TAG, `Failed to play episode: ${error}`);
      this.errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    }
  }
  
  /**
   * å¤„ç†æ’­æ”¾æºç‚¹å‡»
   */
  private handlePlaySourceClick(source: PlaySource): void {
    if (!this.mediaId || !this.siteKey || !this.mediaDetail) return;
    
    try {
      let episodeId: string | undefined;
      let episodeName: string | undefined;
      let currentPlayPosition = 0;
      
      // å¦‚æœæ²¡æœ‰é€‰æ‹©å‰§é›†ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
      if (this.episodes.length > 0) {
        const episodeIndex = this.selectedEpisodeIndex >= 0 ? this.selectedEpisodeIndex : 0;
        episodeId = this.episodes[episodeIndex].id;
        episodeName = this.episodes[episodeIndex].name;
        
        // å°è¯•è·å–ä¸Šæ¬¡è§‚çœ‹è¿›åº¦
        if (episodeId) {
          try {
            // ä½¿ç”¨try-catché¿å…ä¾èµ–é—®é¢˜
            const historyService = { getWatchHistory: () => Promise.resolve(null) };
            historyService.getWatchHistory(
              this.mediaId,
              this.siteKey,
              episodeId
            ).then(watchHistory => {
              if (watchHistory && watchHistory.position > 0) {
                currentPlayPosition = watchHistory.position;
              }
              
              // è·³è½¬åˆ°æ’­æ”¾é¡µé¢
              this.navigateToPlayback(episodeId, episodeName, source, currentPlayPosition);
            }).catch(() => {
              // å³ä½¿è·å–å†å²è®°å½•å¤±è´¥ï¼Œä»ç»§ç»­è·³è½¬åˆ°æ’­æ”¾é¡µé¢
              this.navigateToPlayback(episodeId, episodeName, source, 0);
            });
          } catch (e) {
            // å³ä½¿historyServiceä¸å¯ç”¨ï¼Œä»ç»§ç»­è·³è½¬åˆ°æ’­æ”¾é¡µé¢
            this.navigateToPlayback(episodeId, episodeName, source, 0);
          }
        } else {
          this.navigateToPlayback(episodeId, episodeName, source, 0);
        }
      } else {
        // æ²¡æœ‰å‰§é›†æ—¶ä¹Ÿå°è¯•æ’­æ”¾
        this.navigateToPlayback(episodeId, episodeName, source, 0);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle play source click: ${error}`);
      this.errorMessage = 'æ’­æ”¾å¤±è´¥';
    }
  }
  
  /**
   * å¯¼èˆªåˆ°æ’­æ”¾é¡µé¢
   */
  private navigateToPlayback(
    episodeId: string | undefined,
    episodeName: string | undefined,
    playSource: PlaySource,
    startPosition: number
  ): void {
    Router.pushUrl({
      url: 'pages/PlaybackPage',
      params: {
        mediaId: this.mediaId,
        siteKey: this.siteKey,
        episodeId: episodeId,
        playSource: playSource,
        playSources: this.filteredSources,
        mediaTitle: this.mediaDetail?.title || '',
        episodeName: episodeName,
        startPosition: startPosition,
        autoSwitchSourceOnError: true
      }
    });
  }
  
  /**
   * ä¿å­˜å½“å‰æ’­æ”¾è¿›åº¦
   */
  private saveCurrentPlayProgress(episodeId: string): void {
    try {
      playbackService.getCurrentPosition()
        .then(position => {
          playbackService.getDuration()
            .then(duration => {
              if (position > 0 && this.mediaId && this.siteKey) {
                historyService.saveWatchProgress(
                  this.mediaId,
                  this.siteKey,
                  episodeId,
                  position,
                  duration
                ).catch(error => {
                  Logger.error(this.TAG, `Failed to save watch progress: ${error}`);
                });
              }
            })
            .catch(error => {
              Logger.error(this.TAG, `Failed to get duration: ${error}`);
            });
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to get current position: ${error}`);
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save play progress: ${error}`);
    }
  }
  
  /**
   * å¤„ç†ç›¸å…³åª’ä½“ç‚¹å‡»
   */
  private handleRelatedMediaClick(media: MediaItem): void {
    // è·³è½¬åˆ°å¯¹åº”åª’ä½“è¯¦æƒ…é¡µ
    Router.pushUrl({
      url: 'pages/MediaDetailPage',
      params: {
        mediaId: media.id,
        siteKey: media.siteKey
      }
    });
  }
  
  /**
   * å¤„ç†å­£åˆ‡æ¢
   */
  private handleSeasonChange(season: number): void {
    this.selectedSeason = season;
    // é‡ç½®é€‰ä¸­çš„é›†æ•°
    this.selectedEpisodeIndex = -1;
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    Router.back();
  }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€
   */
  @Builder
  private renderLoading(): void {
    Stack.create();
    Stack.style({
      width: '100%',
      height: '100%',
      backgroundColor: '#4CAF50',
      justifyContent: 'center',
      alignItems: 'center'
    });
    LoadingProgress.create();
    LoadingProgress.style({
      width: 50,
      height: 50,
      color: '#FFFFFF'
    });
    LoadingProgress.pop();
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#FFFFFF',
      marginTop: 20
    });
    Text.content("åŠ è½½ä¸­...");
    Text.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€
   */
  @Builder
  private renderError(): void {
    Stack.create();
    Stack.className("error-container");
    Text.create();
    Text.className("error-icon");
    Text.content("âš ï¸");
    Text.pop();
    Text.create();
    Text.className("error-message");
    Text.content(this.errorMessage);
    Text.pop();
    Button.create();
    Button.className("retry-button");
    Button.onClick(() => this.loadMediaDetail());
    Text.create();
    Text.content("é‡è¯•");
    Text.pop();
    Button.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“åª’ä½“ä¿¡æ¯å¤´éƒ¨
   */
  @Builder
  private renderHeader(): void {
    if (!this.mediaDetail) return;
    
    Stack.create();
    Stack.style({
      backgroundColor: '#4CAF50',
      padding: 20
    });
    
    // åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
    Flex.create();
    Flex.style({
      width: '100%',
      flexDirection: 'row',
      gap: 20
    });
    
    // å°é¢å›¾
    Image.create();
    Image.src(this.mediaDetail.coverUrl || "https://via.placeholder.com/200x300?text=No+Image");
    Image.style({
      width: 150,
      height: 200,
      borderRadius: 10
    });
    Image.objectFit("cover");
    Image.pop();
    
    // è¯¦ç»†ä¿¡æ¯
    Flex.create();
    Flex.style({
      flex: 1,
      flexDirection: 'column',
      gap: 10
    });
    Text.create();
    Text.style({
      fontSize: 28,
      fontWeight: 700,
      color: '#FFFFFF'
    });
    Text.content(this.mediaDetail.title);
    Text.pop();
    
    // å…ƒæ•°æ®æ ‡ç­¾
    Flex.create();
    Flex.style({
      flexDirection: 'row',
      flexWrap: 'wrap',
      gap: 10
    });
    if (this.mediaDetail.year) {
      Flex.create();
      Flex.style({
        backgroundColor: '#FFFFFF',
        paddingHorizontal: 12,
        paddingVertical: 4,
        borderRadius: 15
      });
      Text.create();
      Text.style({
        fontSize: 20,
        color: '#4CAF50',
        fontWeight: 600
      });
      Text.content(this.mediaDetail.year);
      Text.pop();
      Flex.pop();
    }
    if (this.mediaDetail.score) {
      Flex.create();
      Flex.style({
        backgroundColor: '#FF9800',
        paddingHorizontal: 12,
        paddingVertical: 4,
        borderRadius: 15
      });
      Text.create();
      Text.style({
        fontSize: 20,
        color: '#FFFFFF',
        fontWeight: 600
      });
      Text.content(this.mediaDetail.score);
      Text.pop();
      Flex.pop();
    }
    if (this.mediaDetail.type) {
      Flex.create();
      Flex.style({
        backgroundColor: '#FFFFFF',
        paddingHorizontal: 12,
        paddingVertical: 4,
        borderRadius: 15
      });
      Text.create();
      Text.style({
        fontSize: 20,
        color: '#4CAF50',
        fontWeight: 600
      });
      Text.content(this.mediaDetail.type);
      Text.pop();
      Flex.pop();
    }
    Flex.pop();
    
    // å…¶ä»–ä¿¡æ¯
    if (this.mediaDetail.directors && this.mediaDetail.directors.length > 0) {
      Text.create();
      Text.style({
        fontSize: 22,
        color: '#FFFFFF',
        lineHeight: 32
      });
      Text.content(`å¯¼æ¼”: ${this.mediaDetail.directors.join(', ')}`);
      Text.pop();
    }
    if (this.mediaDetail.actors && this.mediaDetail.actors.length > 0) {
      Text.create();
      Text.style({
        fontSize: 22,
        color: '#FFFFFF',
        lineHeight: 32
      });
      Text.content(`æ¼”å‘˜: ${this.mediaDetail.actors.slice(0, 5).join(', ')}${this.mediaDetail.actors.length > 5 ? '...' : ''}`);
      Text.pop();
    }
    Flex.pop();
    Flex.pop();
    
    // å‰§æƒ…ç®€ä»‹
    if (this.mediaDetail.description) {
      Text.create();
      Text.style({
        fontSize: 22,
        color: '#FFFFFF',
        lineHeight: 32,
        marginTop: 20,
        marginBottom: 10
      });
      Text.content(this.mediaDetail.description);
      Text.pop();
    }
    
    // æ“ä½œæŒ‰é’®
    Flex.create();
    Flex.style({
      flexDirection: 'row',
      gap: 20,
      marginTop: 20
    });
    Button.create();
    Button.style({
      backgroundColor: '#FFEB3B',
      paddingHorizontal: 30,
      paddingVertical: 12,
      borderRadius: 25,
      flex: 1
    });
    Button.onClick(() => {
      if (this.episodes.length > 0) {
        this.handlePlayEpisode(this.episodes[0]);
      }
    });
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#000000',
      fontWeight: 700
    });
    Text.content("ç«‹å³æ’­æ”¾");
    Text.pop();
    Button.pop();
    
    Button.create();
    Button.style({
      backgroundColor: this.isFavorite ? '#F44336' : '#FFFFFF',
      paddingHorizontal: 30,
      paddingVertical: 12,
      borderRadius: 25,
      flex: 1
    });
    Button.onClick(this.handleToggleFavorite);
    Text.create();
    Text.style({
      fontSize: 24,
      color: this.isFavorite ? '#FFFFFF' : '#4CAF50',
      fontWeight: 700
    });
    Text.content(this.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—');
    Text.pop();
    Button.pop();
    Flex.pop();
    
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“å‰§æƒ…ç®€ä»‹
   */
  @Builder
  private renderSynopsis(): void {
    if (!this.mediaDetail || !this.mediaDetail.synopsis) return;
    
    Stack.create();
    Stack.className("synopsis-section");
    Text.create();
    Text.className("section-title");
    Text.content("å‰§æƒ…ç®€ä»‹");
    Text.pop();
    Text.create();
    Text.className("synopsis-content");
    Text.content(this.mediaDetail.synopsis);
    Text.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“æ ‡ç­¾é¡µåˆ‡æ¢æ 
   */
  @Builder
  private renderTabBar(): void {
    Flex.create();
    Flex.style({
      flexDirection: 'row',
      backgroundColor: '#4CAF50',
      paddingHorizontal: 20,
      paddingVertical: 10,
      gap: 10
    });
    Button.create();
    Button.style({
      backgroundColor: this.activeTab === 'episodes' ? '#FFFFFF' : '#66BB6A',
      paddingHorizontal: 25,
      paddingVertical: 10,
      borderRadius: 20,
      minWidth: 100
    });
    Button.onClick(() => this.activeTab = 'episodes');
    Text.create();
    Text.style({
      fontSize: 24,
      color: this.activeTab === 'episodes' ? '#4CAF50' : '#FFFFFF',
      fontWeight: 700
    });
    Text.content("å‰§é›†åˆ—è¡¨");
    Text.pop();
    Button.pop();
    Button.create();
    Button.style({
      backgroundColor: this.activeTab === 'sources' ? '#FFFFFF' : '#66BB6A',
      paddingHorizontal: 25,
      paddingVertical: 10,
      borderRadius: 20,
      minWidth: 100
    });
    Button.onClick(() => this.activeTab = 'sources');
    Text.create();
    Text.style({
      fontSize: 24,
      color: this.activeTab === 'sources' ? '#4CAF50' : '#FFFFFF',
      fontWeight: 700
    });
    Text.content("æ’­æ”¾æº");
    Text.pop();
    Button.pop();
    Flex.pop();
  }
  
  /**
   * æ¸²æŸ“å­£é€‰æ‹©å™¨
   */
  @Builder
  private renderSeasonSelector(): void {
    if (this.seasons.length <= 1) return;
    
    Flex.create();
    Flex.className("season-selector");
    Text.create();
    Text.className("selector-label");
    Text.content("é€‰æ‹©å­£æ•°:");
    Text.pop();
    Flex.create();
    Flex.className("season-buttons");
    this.seasons.forEach((season, index) => {
      Button.create();
      Button.key(season.id);
      Button.className(`season-button ${this.selectedSeasonIndex === index ? 'active' : ''}`);
      Button.onClick(() => this.selectedSeasonIndex = index);
      Text.create();
      Text.content(`ç¬¬${season.seasonNumber}å­£`);
      Text.pop();
      Button.pop();
    });
    Flex.pop();
    Flex.pop();
  }
  
  /**
   * æ¸²æŸ“å‰§é›†åˆ—è¡¨
   */
  @Builder
  private renderEpisodes(): void {
    if (this.episodes.length === 0) {
      Stack.create();
      Stack.style({
        backgroundColor: '#4CAF50',
        padding: 20,
        alignItems: 'center'
      });
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#FFFFFF'
      });
      Text.content("æš‚æ— å‰§é›†");
      Text.pop();
      Stack.pop();
      return;
    }
    
    Stack.create();
    Stack.style({
      backgroundColor: '#4CAF50',
      padding: 20
    });
    
    // ç½‘æ ¼å¸ƒå±€å±•ç¤ºå‰§é›†
    Grid.create();
    Grid.style({
      width: '100%'
    });
    Grid.columnsTemplate('repeat(6, 1fr)');
    Grid.columnsGap(15);
    Grid.rowsGap(15);
    
    this.episodes.forEach((episode, index) => {
      GridItem.create();
      GridItem.key(episode.id);
      Button.create();
      Button.style({
        backgroundColor: '#66BB6A',
        padding: 15,
        borderRadius: 8,
        width: '100%'
      });
      Button.onClick(() => this.handlePlayEpisode(episode));
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#FFFFFF',
        fontWeight: 600
      });
      Text.content(`${index + 1}`);
      Text.pop();
      Button.pop();
      GridItem.pop();
    });
    Grid.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾æºåˆ—è¡¨
   */
  @Builder
  private renderPlaySources(): void {
    Stack.create();
    Stack.style({
      backgroundColor: '#4CAF50',
      padding: 20
    });
    
    // æœç´¢æ¡†
    Stack.create();
    Stack.style({
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: '#FFFFFF',
      borderRadius: 25,
      paddingHorizontal: 20,
      marginBottom: 20,
      height: 50
    });
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#999999',
      marginRight: 10
    });
    Text.content('ğŸ”');
    Text.pop();
    TextInput.create();
    TextInput.style({
      flex: 1,
      fontSize: 24,
      color: '#333333'
    });
    TextInput.placeholder("æœç´¢ç‰‡æº...");
    TextInput.placeholderColor('#999999');
    TextInput.value(this.searchText);
    TextInput.onChange(this.handleSearchChange);
    TextInput.pop();
    if (this.searchText.length > 0) {
      Button.create();
      Button.style({
        backgroundColor: 'transparent'
      });
      Button.onClick(() => {
        this.searchText = '';
        this.filteredSources = [...this.playSources];
      });
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#999999'
      });
      Text.content('âœ•');
      Text.pop();
      Button.pop();
    }
    Stack.pop();
    
    if (this.filteredSources.length === 0) {
      Stack.create();
      Stack.style({
        backgroundColor: '#4CAF50',
        padding: 40,
        alignItems: 'center',
        justifyContent: 'center'
      });
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#FFFFFF'
      });
      Text.content("æš‚æ— æ’­æ”¾æºæˆ–æ²¡æœ‰åŒ¹é…çš„ç‰‡æº");
      Text.pop();
      Stack.pop();
      return;
    }
    
    List.create();
    List.style({
      width: '100%'
    });
    this.filteredSources.forEach((source, index) => {
      ListItem.create();
      ListItem.key(index.toString());
      ListItem.style({
        paddingVertical: 10
      });
      Button.create();
      Button.style({
        backgroundColor: '#66BB6A',
        padding: 25,
        borderRadius: 10,
        width: '100%',
        borderWidth: 2,
        borderColor: 'transparent'
      });
      Button.onClick(() => this.handlePlaySourceClick(source));
      Flex.create();
      Flex.style({
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        width: '100%'
      });
      Text.create();
      Text.style({
        fontSize: 28,
        color: '#FFFFFF',
        fontWeight: 700,
        flex: 1
      });
      Text.content(source.name || `æ’­æ”¾æº${index + 1}`);
      Text.pop();
      if (source.quality) {
        Flex.create();
        Flex.style({
          backgroundColor: '#FFEB3B',
          paddingHorizontal: 15,
          paddingVertical: 8,
          borderRadius: 15
        });
        Text.create();
        Text.style({
          fontSize: 22,
          color: '#000000',
          fontWeight: 700
        });
        Text.content(source.quality);
        Text.pop();
        Flex.pop();
      }
      Flex.pop();
      Button.pop();
      ListItem.pop();
    });
    List.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“ç›¸å…³æ¨è
   */
  @Builder
  private renderRelatedMedia(): void {
    if (this.relatedMedia.length === 0) return;
    
    <Stack className="related-section">
      <Text className="section-title">ç›¸å…³æ¨è</Text>
      <ScrollView scrollable="horizontal" className="related-scroll">
        <Flex>
          {this.relatedMedia.map((media) => (
            <Stack key={`${media.siteKey}-${media.id}`} className="related-item" onClick={() => this.handleRelatedMediaClick(media)}>
              <Image
                src={media.coverUrl || "https://via.placeholder.com/150x200?text=No+Image"}
                className="related-cover"
                objectFit="cover"
              ></Image>
              <Text className="related-title" numberOfLines={2}>{media.title}</Text>
            </Stack>
          ))}
        </Flex>
      </ScrollView>
    </Stack>
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Stack.create();
    Stack.style({
      flex: 1,
      backgroundColor: '#4CAF50'
    });
    
    // é¡¶éƒ¨å¯¼èˆªæ 
    Stack.create();
    Stack.style({
      backgroundColor: '#388E3C',
      flexDirection: 'row',
      alignItems: 'center',
      justifyContent: 'space-between',
      paddingHorizontal: 20,
      paddingVertical: 15,
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      zIndex: 1000
    });
    Button.create();
    Button.style({
      backgroundColor: 'transparent'
    });
    Button.onClick(this.handleBack);
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#FFFFFF'
    });
    Text.content("â† è¿”å›");
    Text.pop();
    Button.pop();
    Text.create();
    Text.style({
      fontSize: 26,
      color: '#FFFFFF',
      fontWeight: 700
    });
    Text.content("è¯¦æƒ…");
    Text.pop();
    Blank.create();
    Blank.style({ width: 80 });
    Blank.pop();
    Stack.pop();
    
    // ä¸»å†…å®¹åŒºåŸŸ
    if (this.isLoading) {
      this.renderLoading();
    } else if (this.errorMessage) {
      this.renderError();
    } else {
      ScrollView.create();
      ScrollView.style({
        flex: 1,
        backgroundColor: '#4CAF50'
      });
      ScrollView.scrollBar("auto");
      
      // æ·»åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…è¢«å¯¼èˆªæ é®æŒ¡
      Blank.create();
      Blank.style({ height: 60 });
      Blank.pop();
      
      this.renderHeader();
      this.renderTabBar();
      
      Stack.create();
      if (this.activeTab === 'episodes') {
        this.renderEpisodes();
      } else {
        this.renderPlaySources();
      }
      Stack.pop();
      
      this.renderRelatedMedia();
      Blank.create();
      Blank.style({ height: 50 });
      Blank.pop();
      ScrollView.pop();
    }
    Stack.pop();
  }
}

export default MediaDetailPage;