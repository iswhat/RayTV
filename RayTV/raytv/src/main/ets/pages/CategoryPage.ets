import { AppNavigator } from '../navigation/AppNavigator';
// Logger import removed as AnalyticsService was deleted
import { MediaService } from '../service/media/MediaService';
import { MediaItem } from '../data/bean/MediaItem';

// ç§»é™¤ @ohos.ui å¯¼å…¥ï¼Œå› ä¸ºå®ƒåœ¨å½“å‰ç¯å¢ƒä¸­ä¸å¯ç”¨

/**
 * åˆ†ç±»é¡µé¢ç»„ä»¶ | Category page component
 * å®ç°åª’ä½“åˆ†ç±»æµè§ˆã€é€‰æ‹©å’Œåˆ—è¡¨å±•ç¤ºåŠŸèƒ½ | Implement media category browsing, selection and list display functionality
 */
@Entry
@Component
struct CategoryPage {
  private readonly TAG: string = 'CategoryPage';
  
  // çŠ¶æ€ç®¡ç† | State management
  @State selectedCategory: string = 'å…¨éƒ¨';
  @State selectedRegion: string = 'å…¨éƒ¨';
  @State selectedYear: string = 'å…¨éƒ¨';
  @State selectedSort: string = 'æœ€æ–°';
  @State mediaList: MediaItem[] = [];
  @State categories: string[] = ['å…¨éƒ¨', 'ç”µå½±', 'ç”µè§†å‰§', 'åŠ¨ç”»', 'ç»¼è‰º', 'çºªå½•ç‰‡'];
  @State regions: string[] = ['å…¨éƒ¨', 'å›½å†…', 'é¦™æ¸¯', 'å°æ¹¾', 'ç¾å›½', 'æ—¥æœ¬', 'éŸ©å›½', 'å…¶ä»–'];
  @State years: string[] = [];
  @State sortOptions: string[] = ['æœ€æ–°', 'æœ€çƒ­', 'è¯„åˆ†æœ€é«˜'];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State currentPage: number = 1;
  @State hasMoreResults: boolean = true;
  @State isRefreshing: boolean = false;
  
  // åˆ†é¡µé…ç½® | Pagination configuration
  private pageSize: number = 20;
  // æœåŠ¡å®ä¾‹å°†åœ¨æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨ | Service instances will be called directly in methods
  
  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒç”¨ | Called when page loads
   */
  async aboutToAppear(): Promise<void> {
    console.info('CategoryPage appeared');
    
    // åˆå§‹åŒ–å¹´ä»½é€‰é¡¹ | Initialize year options
    const currentYear = new Date().getFullYear();
    // å…ˆæ„å»ºå¹´ä»½æ•°ç»„ï¼Œç„¶åæ·»åŠ "å…¨éƒ¨"é€‰é¡¹ | Build year array first, then add "å…¨éƒ¨" option
    const yearArray: string[] = [];
    yearArray.push('å…¨éƒ¨');
    for (let i = 0; i < 10; i++) {
      yearArray.push((currentYear - i).toString());
    }
    this.years = yearArray;
    
    // åˆå§‹åŒ–æ•°æ® | Initialize data
    await this.loadMediaList(true);
  }
  
  /**
   * é¡µé¢å¸è½½æ—¶è°ƒç”¨ | Called when page unloads
   */
  aboutToDisappear(): void {
    console.info('CategoryPage disappeared');
  }
  
  /**
   * åŠ è½½åª’ä½“åˆ—è¡¨ | Load media list
   */
  private async loadMediaList(reset: boolean = false): Promise<void> {
    try {
      this.isLoading = true;
      this.errorMessage = '';
      
      if (reset) {
        this.currentPage = 1;
        this.mediaList = [];
      } else if (!this.hasMoreResults) {
        this.isLoading = false;
        return;
      }
      
      const category = this.selectedCategory === 'å…¨éƒ¨' ? '' : this.selectedCategory;
      const region = this.selectedRegion === 'å…¨éƒ¨' ? '' : this.selectedRegion;
      const year = this.selectedYear === 'å…¨éƒ¨' ? '' : this.selectedYear;
      
      console.info('Loading media list: category=' + category + ', region=' + region + ', year=' + year + ', sort=' + this.selectedSort + ', page=' + this.currentPage);
      
      // è°ƒç”¨MediaServiceè·å–çœŸå®æ•°æ® | Call MediaService to get real data
      // æ³¨æ„ï¼šä½¿ç”¨getRecommendedContentæ›¿ä»£ä¸å­˜åœ¨çš„getCategoryMediaæ–¹æ³• | Note: Using getRecommendedContent instead of non-existent getCategoryMedia method
      const result = await MediaService.getInstance().getRecommendedContent();
      
      if (result.isSuccess() && result.data) {
        const newMediaItems: MediaItem[] = result.data;
        
        if (reset) {
          this.mediaList = newMediaItems;
        } else {
          const mergedList: MediaItem[] = [];
          for (let i = 0; i < this.mediaList.length; i++) {
            mergedList.push(this.mediaList[i]);
          }
          for (let i = 0; i < newMediaItems.length; i++) {
            mergedList.push(newMediaItems[i]);
          }
          this.mediaList = mergedList;
        }
        
        // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ® | Determine if there are more results
        this.hasMoreResults = newMediaItems.length === this.pageSize;
        
        console.info('Media list loaded, total: ' + this.mediaList.length + ', has more: ' + this.hasMoreResults);
      } else {
        this.errorMessage = result.message || 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        this.hasMoreResults = false;
        console.warn('Failed to load media list: ' + this.errorMessage);
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('Failed to load media list: ' + errorMsg);
      this.errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      this.hasMoreResults = false;
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }
  
  /**
   * å¤„ç†ç­›é€‰æ¡ä»¶å˜åŒ– | Handle filter condition changes
   */
  private async handleFilterChange(): Promise<void> {
    this.currentPage = 1;
    this.mediaList = [];
    this.hasMoreResults = true;
    await this.loadMediaList(true);
  }
  
  /**
   * å¤„ç†åˆ†ç±»é€‰æ‹© | Handle category selection
   */
  private async handleCategorySelect(category: string): Promise<void> {
    if (this.selectedCategory !== category) {
      this.selectedCategory = category;

      await this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†åœ°åŒºé€‰æ‹© | Handle region selection
   */
  private async handleRegionSelect(region: string): Promise<void> {
    if (this.selectedRegion !== region) {
      this.selectedRegion = region;

      await this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†å¹´ä»½é€‰æ‹© | Handle year selection
   */
  private async handleYearSelect(year: string): Promise<void> {
    if (this.selectedYear !== year) {
      this.selectedYear = year;

      await this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†æ’åºé€‰æ‹© | Handle sort selection
   */
  private async handleSortSelect(sort: string): Promise<void> {
    if (this.selectedSort !== sort) {
      this.selectedSort = sort;

      await this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†åª’ä½“é¡¹ç‚¹å‡» | Handle media item click
   */
  private handleMediaItemClick(media: MediaItem): void {
    console.info('Media item clicked: ' + media.title);

    // è·³è½¬åˆ°è¯¦æƒ…é¡µ | Navigate to detail page
    AppNavigator.getInstance().navigateToDetail({
      id: media.id,
      siteKey: media.siteKey,
      type: 'vod'
    });
  }
  
  /**
   * å¤„ç†åŠ è½½æ›´å¤š | Handle load more
   */
  private async handleLoadMore(): Promise<void> {
    if (!this.isLoading && this.hasMoreResults) {
      this.currentPage++;
      await this.loadMediaList(false);
    }
  }
  
  /**
   * å¤„ç†åˆ·æ–° | Handle refresh
   */
  private async handleRefresh(): Promise<void> {
    this.isRefreshing = true;
    await this.loadMediaList(true);
  }
  
  /**
   * å¤„ç†è¿”å› | Handle back
   */
  private handleBack(): void {
    // ä½¿ç”¨AppNavigatorå¤„ç†è¿”å› | Use AppNavigator to handle back
    AppNavigator.getInstance().navigateToBack();
  }
  
  /**
   * æ¸²æŸ“å¤´éƒ¨ | Render header
   */
  @Builder
  private renderHeader(): void {
    Row() {
      Button("è¿”å›")
        .onClick(() => this.handleBack())
      Text("åˆ†ç±»æµè§ˆ")
        .fontSize(20)
        .fontWeight(700)
      // ä½¿ç”¨ç©ºçš„Rowä½œä¸ºå ä½ç¬¦ï¼Œç±»ä¼¼HTML blankå…ƒç´  | Use empty Row as placeholder, similar to HTML blank element
      Row() {}
    }
    .justifyContent(FlexAlign.SpaceBetween)
    .padding(20)
  }
  
  /**
   * æ¸²æŸ“åˆ†ç±»é€‰æ‹©å™¨ | Render category selector
   */
  @Builder
  private renderCategorySelector() {
    Row() {
      ForEach(this.categories, (category: string) => {
        Button(category)
        .onClick(() => this.handleCategorySelect(category))
        .margin(5)
      }, (category: string) => category)
    }
    .padding(5)
  }
  
  /**
   * æ¸²æŸ“ç­›é€‰æ¡ä»¶ | Render filters
   */
  @Builder
  private renderFilters(): void {
    Column() {
      // åœ°åŒºç­›é€‰ | Region filter
      Row() {
        Text("åœ°åŒº:")
          .fontSize(16)
          .fontColor('#333333')
          .margin(10)
        Row() {
          ForEach(this.regions.slice(0, 5), (region: string) => {
            Button(region)
            .onClick(() => this.handleRegionSelect(region))
            .margin(5)
          })
        }
      }
      
      // å¹´ä»½ç­›é€‰ | Year filter
      Row() {
        Text("å¹´ä»½:")
          .fontSize(16)
          .fontColor('#333333')
          .margin(10)
        Row() {
          ForEach(this.years.slice(0, 5), (year: string) => {
            Button(year)
            .onClick(() => this.handleYearSelect(year))
            .margin(5)
          })
        }
      }
      
      // æ’åºç­›é€‰ | Sort filter
      Row() {
        Text("æ’åº:")
          .fontSize(16)
          .fontColor('#333333')
          .margin(10)
        Row() {
          ForEach(this.sortOptions.slice(0, 3), (sort: string) => {
            Button(sort)
            .onClick(() => this.handleSortSelect(sort))
            .margin(5)
          })
        }
      }
    }
    .margin(20)
  }
  
  /**
   * æ¸²æŸ“åª’ä½“é¡¹ | Render media item
   */
  @Builder
  private renderMediaItem(media: MediaItem): void {
    Row() {
      Image(media.coverUrl || "https://via.placeholder.com/80x120?text=No+Image")
        .width(80)
        .height(120)
        .objectFit(ImageFit.Cover)
        .borderRadius(4)
      Column() {
        Text(media.title)
          .fontSize(16)
          .fontColor('#333333')
          .maxLines(2)
        if (media.year) {
          Text(media.year)
            .fontSize(12)
            .fontColor('#666666')
        }
        if (media.score) {
          Text("è¯„åˆ†: " + media.score)
            .fontSize(12)
            .fontColor('#FF6B35')
        }
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .height(120)
      .margin({ left: 10 })
    }
    .padding(10)
    .backgroundColor('#F5F5F5')
    .borderRadius(8)
    .margin({ bottom: 10 })
    .onClick(() => this.handleMediaItemClick(media))
  }
  

  
  /**
   * ç»„ä»¶æ¸²æŸ“ | Component render
   */
  build() {
    Column() {
      // é¡µé¢å¤´éƒ¨ | Page header
      this.renderHeader()
      
      // åˆ†ç±»é€‰æ‹© | Category selection
      this.renderCategorySelector()
      
      // ç­›é€‰æ¡ä»¶ | Filters
      this.renderFilters()
      
      // åª’ä½“åˆ—è¡¨ | Media list
      Column() {
        if (this.isLoading && this.currentPage === 1) {
          Column() {
            Text("åŠ è½½ä¸­...")
              .fontSize(16)
              .fontColor('#333333')
          }
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Center)
          .padding(20)
        } else if (this.errorMessage) {
          Column() {
            Text("ğŸ˜”")
              .fontSize(24)
            Text(this.errorMessage)
              .fontSize(16)
              .fontColor('#333333')
              .margin({ top: 10 })
            Button("é‡è¯•")
              .onClick(() => this.loadMediaList(true))
              .margin({ top: 15 })
          }
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Center)
          .padding(20)
        } else if (this.mediaList.length === 0) {
          Column() {
            Text("æš‚æ— ç›¸å…³å†…å®¹")
              .fontSize(16)
              .fontColor('#333333')
          }
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Center)
          .padding(20)
        } else {
          List() {
            ForEach(this.mediaList, (item: MediaItem) => {
              ListItem() {
                this.renderMediaItem(item)
              }
            }, (item: MediaItem) => item.id)
          }
          .margin(20)
        }
        
        // åŠ è½½æ›´å¤š | Load more
        if (this.isLoading && this.currentPage > 1 && this.hasMoreResults) {
          Column() {
            Text("åŠ è½½æ›´å¤š...")
              .fontSize(16)
              .fontColor('#333333')
          }
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Center)
          .padding(20)
        } else if (!this.hasMoreResults && this.mediaList.length > 0) {
          Text("æ²¡æœ‰æ›´å¤šå†…å®¹å•¦~")
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .padding(20)
        }
      }
    }
  }
}
