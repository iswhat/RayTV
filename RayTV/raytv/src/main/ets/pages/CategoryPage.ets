
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { mediaService } from '../service/media/MediaService';
import { MediaItem } from '../data/bean/MediaItem';
// å¯¼å…¥å¿…è¦çš„ArkTSç»„ä»¶
import { Column, Row, Text, Image, Flex, Stack, LoadingProgress, List, ForEach, Button, Scroller, Refresh, TextInput } from '@ohos.arkui';

/**
 * åˆ†ç±»é¡µé¢ç»„ä»¶
 * å®ç°åª’ä½“åˆ†ç±»æµè§ˆã€ç­›é€‰å’Œåˆ—è¡¨å±•ç¤ºåŠŸèƒ½
 */
@Entry
@Component
struct CategoryPage {
  private readonly TAG: string = 'CategoryPage';
  
  // çŠ¶æ€ç®¡ç?
  @State selectedCategory: string = 'å…¨éƒ¨';
  @State selectedRegion: string = 'å…¨éƒ¨';
  @State selectedYear: string = 'å…¨éƒ¨';
  @State selectedSort: string = 'æœ€æ–?;
  @State mediaList: MediaItem[] = [];
  @State categories: string[] = [];
  @State regions: string[] = [];
  @State years: string[] = [];
  @State sortOptions: string[] = ['æœ€æ–?, 'æœ€çƒ?, 'è¯„åˆ†æœ€é«?, 'æœ€æ—?];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State currentPage: number = 1;
  @State hasMoreResults: boolean = true;
  @State isRefreshing: boolean = false;
  
  // åˆ†é¡µé…ç½®
  private pageSize: number = 20;
  
  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒç”?
   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'CategoryPage appeared');
    
    // è·å–è·¯ç”±å‚æ•°
    const params = this.context.router.getParams();
    if (params?.category) {
      this.selectedCategory = params.category as string;
    }
    
    // åˆå§‹åŒ–æ•°æ?
    this.initCategoryData();
    this.loadMediaList(true);
  }
  
  /**
   * é¡µé¢å¸è½½æ—¶è°ƒç”?
   */
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'CategoryPage disappeared');
  }
  
  /**
   * åˆå§‹åŒ–åˆ†ç±»æ•°æ?
   */
  private initCategoryData(): void {
    try {
      // åŠ è½½åˆ†ç±»åˆ—è¡¨
      mediaService.getCategories()
        .then(categories => {
          this.categories = ['å…¨éƒ¨', ...categories];
          
          // åŠ è½½åœ°åŒºåˆ—è¡¨
          return mediaService.getRegions();
        })
        .then(regions => {
          this.regions = ['å…¨éƒ¨', ...regions];
          
          // åŠ è½½å¹´ä»½åˆ—è¡¨ (æœ€è¿?0å¹?
          const currentYear = new Date().getFullYear();
          this.years = ['å…¨éƒ¨', ...Array.from({ length: 10 }, (_, i) => (currentYear - i).toString())];
          
          Logger.info(this.TAG, `Loaded categories: ${this.categories.length}, regions: ${this.regions.length}`);
        })
        .catch(error => {
          Logger.error(this.TAG, 'Failed to load category data', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
          
          // ä½¿ç”¨é»˜è®¤æ•°æ®
          this.categories = ['å…¨éƒ¨', 'ç”µå½±', 'ç”µè§†å‰?, 'åŠ¨æ¼«', 'ç»¼è‰º', 'çºªå½•ç‰?];
          this.regions = ['å…¨éƒ¨', 'å†…åœ°', 'é¦™æ¸¯', 'å°æ¹¾', 'ç¾å›½', 'æ—¥æœ¬', 'éŸ©å›½', 'å…¶ä»–'];
        });
    } catch (error) {
      Logger.error(this.TAG, 'Failed to load category data', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.categories = ['å…¨éƒ¨', 'ç”µå½±', 'ç”µè§†å‰?, 'åŠ¨æ¼«', 'ç»¼è‰º', 'çºªå½•ç‰?];
      this.regions = ['å…¨éƒ¨', 'å†…åœ°', 'é¦™æ¸¯', 'å°æ¹¾', 'ç¾å›½', 'æ—¥æœ¬', 'éŸ©å›½', 'å…¶ä»–'];
    }
  }
  
  /**
   * åŠ è½½åª’ä½“åˆ—è¡¨
   */
  private loadMediaList(reset: boolean = false): void {
    if (this.isLoading) return;
    
    this.isLoading = true;
    this.errorMessage = '';
    
    if (reset) {
      this.currentPage = 1;
      this.mediaList = [];
    } else if (!this.hasMoreResults) {
      this.isLoading = false;
      return;
    }
    
    const category = this.selectedCategory === 'å…¨éƒ¨' ? '' : this.selectedCategory;
    const region = this.selectedRegion === 'å…¨éƒ¨' ? '' : this.selectedRegion;
    const year = this.selectedYear === 'å…¨éƒ¨' ? '' : this.selectedYear;
    
    Logger.info(this.TAG, `Loading media list: category=${category}, region=${region}, year=${year}, sort=${this.selectedSort}, page=${this.currentPage}`);
    
    // è°ƒç”¨åª’ä½“æœåŠ¡è·å–åˆ—è¡¨
    mediaService.getMediaByCategory(
      category,
      region,
      year,
      this.selectedSort,
      this.currentPage,
      this.pageSize
    )
    .then(result => {
      if (reset) {
        this.mediaList = result;
      } else {
        this.mediaList = [...this.mediaList, ...result];
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šæ•°æ®
      this.hasMoreResults = result.length === this.pageSize;
      
      Logger.info(this.TAG, `Media list loaded, total: ${this.mediaList.length}, has more: ${this.hasMoreResults}`);
    })
    .catch(error => {
      Logger.error(this.TAG, 'Failed to load media list', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      this.errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      this.hasMoreResults = false;
    })
    .finally(() => {
      this.isLoading = false;
      this.isRefreshing = false;
    });
  }
  
  /**
   * å¤„ç†ç­›é€‰æ¡ä»¶å˜æ›?
   */
  private handleFilterChange(): void {
    this.currentPage = 1;
    this.mediaList = [];
    this.hasMoreResults = true;
    this.loadMediaList(true);
  }
  
  /**
   * å¤„ç†åˆ†ç±»é€‰æ‹©
   */
  private handleCategorySelect(category: string): void {
    if (this.selectedCategory !== category) {
      this.selectedCategory = category;
      this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†åœ°åŒºé€‰æ‹©
   */
  private handleRegionSelect(region: string): void {
    if (this.selectedRegion !== region) {
      this.selectedRegion = region;
      this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†å¹´ä»½é€‰æ‹©
   */
  private handleYearSelect(year: string): void {
    if (this.selectedYear !== year) {
      this.selectedYear = year;
      this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†æ’åºé€‰æ‹©
   */
  private handleSortSelect(sort: string): void {
    if (this.selectedSort !== sort) {
      this.selectedSort = sort;
      this.handleFilterChange();
    }
  }
  
  /**
   * å¤„ç†åª’ä½“é¡¹ç‚¹å‡?
   */
  private handleMediaItemClick(media: MediaItem): void {
    Logger.info(this.TAG, `Media item clicked: ${media.title}`);
    // è·³è½¬åˆ°è¯¦æƒ…é¡µ
    AppNavigator.getInstance().navigateToDetail({
      id: media.id,
      siteKey: media.siteKey,
      type: 'vod'
    });
  }
  
  /**
   * å¤„ç†åŠ è½½æ›´å¤š
   */
  private handleLoadMore(): void {
    if (!this.isLoading && this.hasMoreResults) {
      this.currentPage++;
      this.loadMediaList(false);
    }
  }
  
  /**
   * å¤„ç†åˆ·æ–°
   */
  private handleRefresh(): void {
    this.isRefreshing = true;
    this.loadMediaList(true);
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    this.context.router.back();
  }
  
  /**
   * æ¸²æŸ“å¤´éƒ¨
   */
  @Builder
  private renderHeader(): void {
    Flex()
    .alignItems(FlexAlign.Center)
    .justifyContent(FlexAlign.SpaceBetween) {
      Button("â†?)
        .onClick(() => this.handleBack())
      Text("åˆ†ç±»æµè§ˆ")
      // ä½¿ç”¨ç©ºçš„Flexä½œä¸ºå ä½ç¬¦æ›¿ä»£Blankç»„ä»¶
      Flex() {}
    }
  }
  
  /**
   * æ¸²æŸ“åˆ†ç±»é€‰æ‹©å™?
   */
  @Builder
  private renderCategorySelector() {
    Scroller() {
      Flex()
      .className("category-list")
      .flexWrap(FlexWrap.NoWrap) {
        ForEach(this.categories, (category: string) => {
          Button(category)
          .key(`category-${category}`)
          .className(`category-button ${this.selectedCategory === category ? 'selected' : ''}`)
          .onClick(() => this.handleCategorySelect(category))
        }, (category: string) => category)
      }
    }
  }
  
  /**
   * æ¸²æŸ“ç­›é€‰æ¡ä»?
   */
  @Builder
  private renderFilters(): void {
    Flex()
    .alignItems(FlexAlign.Center)
    .gap(10) {
      // åœ°åŒºç­›é€?- ä½¿ç”¨æŒ‰é’®ç»„æ›¿ä»£Selectç»„ä»¶
      Flex()
      .alignItems(FlexAlign.Center) {
        Text("åœ°åŒº:")
          .fontSize(16)
          .fontColor('#333333')
        Flex()
        .alignItems(FlexAlign.Center)
        .gap(5) {
          ForEach(this.regions.slice(0, 5), (region: string) => {
            Button(region)
            .backgroundColor(this.selectedRegion === region ? '#4CAF50' : '#E0E0E0')
            .fontColor(this.selectedRegion === region ? '#FFFFFF' : '#333333')
            .onClick(() => this.handleRegionSelect(region))
          })
        }
      }
      
      // å¹´ä»½ç­›é€?- ä½¿ç”¨æŒ‰é’®ç»„æ›¿ä»£Selectç»„ä»¶
      Flex()
      .alignItems(FlexAlign.Center) {
        Text("å¹´ä»½:")
          .fontSize(16)
          .fontColor('#333333')
        Flex()
        .alignItems(FlexAlign.Center)
        .gap(5) {
          ForEach(this.years.slice(0, 5), (year: string) => {
            Button(year)
            .backgroundColor(this.selectedYear === year ? '#4CAF50' : '#E0E0E0')
            .fontColor(this.selectedYear === year ? '#FFFFFF' : '#333333')
            .onClick(() => this.handleYearSelect(year))
          })
        }
      }
      
      // æ’åºç­›é€?- ä½¿ç”¨æŒ‰é’®ç»„æ›¿ä»£Selectç»„ä»¶
      Flex()
      .alignItems(FlexAlign.Center) {
        Text("æ’åº:")
          .fontSize(16)
          .fontColor('#333333')
        Flex()
        .alignItems(FlexAlign.Center)
        .gap(5) {
          ForEach(this.sortOptions.slice(0, 3), (sort: string) => {
            Button(sort)
            .backgroundColor(this.selectedSort === sort ? '#4CAF50' : '#E0E0E0')
            .fontColor(this.selectedSort === sort ? '#FFFFFF' : '#333333')
            .onClick(() => this.handleSortSelect(sort))
          })
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“åª’ä½“é¡?
   */
  @Builder
  private renderMediaItem(media: MediaItem): void {
    Flex()
    .alignItems(FlexAlign.Start)
    .gap(10)
    .padding(10)
    .backgroundColor('#F5F5F5')
    .borderRadius(8)
    .margin({ bottom: 10 })
    .onClick(() => this.handleMediaItemClick(media)) {
      Image(media.coverUrl || "https://via.placeholder.com/80x120?text=No+Image")
        .width(80)
        .height(120)
        .objectFit(ImageFit.Cover)
        .borderRadius(4)
      Flex()
      .direction(FlexDirection.Column)
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(FlexAlign.Start)
      .height(120) {
        Text(media.title)
          .fontSize(16)
          .fontColor('#333333')
          .maxLines(2)
        if (media.year) {
          Text(media.year)
            .fontSize(12)
            .fontColor('#666666')
        }
        if (media.score) {
          Text("è¯„åˆ†: " + media.score)
            .fontSize(12)
            .fontColor('#FF6B35')
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“åª’ä½“åˆ—è¡¨
   */
  @Builder
  private renderMediaList(): void {
    if (this.isLoading && this.currentPage === 1) {
      Stack()
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
      .padding(20) {
        LoadingProgress()
          .color("#FF4500")
        Text("åŠ è½½ä¸?..")
          .fontSize(16)
          .fontColor('#333333')
          .margin({ top: 10 })
      }
    } else if (this.errorMessage) {
      Stack()
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
      .padding(20) {
        Text("âš ï¸")
          .fontSize(24)
        Text(this.errorMessage)
          .fontSize(16)
          .fontColor('#333333')
          .margin({ top: 10 })
        Button("é‡è¯•")
          .backgroundColor('#4CAF50')
          .fontColor('#FFFFFF')
          .margin({ top: 15 })
          .onClick(() => this.loadMediaList(true))
      }
    } else if (this.mediaList.length === 0) {
      Stack()
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
      .padding(20) {
        Text("æš‚æ— ç›¸å…³å†…å®¹")
          .fontSize(16)
          .fontColor('#666666')
      }
    } else {
      List() {
        ForEach(this.mediaList, (item: MediaItem) => {
          this.renderMediaItem(item)
        }, (item: MediaItem) => item.id)
      }
      .onScrollBottom(() => this.handleLoadMore())
      .onRefresh(() => this.handleRefresh())
      .refreshing(this.isRefreshing)
    }
  }
  
  /**
   * æ¸²æŸ“åŠ è½½æ›´å¤š
   */
  @Builder
  private renderLoadMore(): void {
    if (this.isLoading && this.currentPage > 1 && this.hasMoreResults) {
      Stack()
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
      .padding(20) {
        LoadingProgress()
          .color("#FF4500")
        Text("åŠ è½½æ›´å¤š...")
          .fontSize(16)
          .fontColor('#333333')
          .margin({ top: 10 })
      }
    } else if (!this.hasMoreResults && this.mediaList.length > 0) {
      Text("æ²¡æœ‰æ›´å¤šå†…å®¹äº?)
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .padding(20)
    }
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Stack({ className: "category-page" }) {
      // é¡µé¢å¤´éƒ¨
      this.renderHeader()
      
      // åˆ†ç±»é€‰æ‹©
      this.renderCategorySelector()
      
      // ç­›é€‰æ¡ä»?
      this.renderFilters()
      
      // åª’ä½“åˆ—è¡¨
      Column() {
        this.renderMediaList()
        this.renderLoadMore()
        // ä½¿ç”¨ç©ºçš„Columnä½œä¸ºå ä½ç¬¦æ›¿ä»£Blankç»„ä»¶
        Column() {}
      }
    }
  }
}

export default CategoryPage;


