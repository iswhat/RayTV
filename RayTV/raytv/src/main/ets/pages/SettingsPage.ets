import { ScrollView, Text, Button, Switch, List, ListItem, Divider, Image, Dialog, Toast } from '@kit.ArkUI';
import { Router } from '@ohos.router';
import Logger from '../common/util/Logger';
import { configService } from '../service/config/ConfigService';
import { mediaService } from '../service/media/MediaService';

/**
 * è®¾ç½®é¡µé¢ç»„ä»¶
 * å®ç°åº”ç”¨é…ç½®ç®¡ç†ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€è¯­è¨€ã€ç¼“å­˜ã€æ’­æ”¾ç­‰è®¾ç½®
 */
@Component
struct SettingsPage {
  private readonly TAG: string = 'SettingsPage';
  
  // çŠ¶æ€ç®¡ç†
  @State themeMode: 'light' | 'dark' | 'auto' = 'auto';
  @State language: 'zh' | 'en' = 'zh';
  @State autoPlay: boolean = true;
  @State autoNextEpisode: boolean = true;
  @State rememberProgress: boolean = true;
  @State enableHardwareAcceleration: boolean = true;
  @State cacheStrategy: 'memory' | 'disk' | 'none' = 'disk';
  @State maxCacheSize: number = 1024; // MB
  @State currentCacheSize: number = 0;
  @State enableUpdateCheck: boolean = true;
  @State notificationsEnabled: boolean = true;
  @State version: string = '1.0.0';
  
  // å¹¿å‘Šå±è”½è®¾ç½®
  @State enableAdBlock: boolean = true;
  @State blockVideoAds: boolean = true;
  @State blockPopupAds: boolean = true;
  
  // å£çº¸è®¾ç½®
  @State enableWallpaper: boolean = false;
  @State wallpaperType: 'none' | 'image' | 'video' = 'none';
  
  // é¸¿è’™ç‰¹æœ‰åŠŸèƒ½è®¾ç½®
  @State enableVoiceAssistant: boolean = true;
  @State enableDeviceFlow: boolean = true;
  
  // å¯¹è¯æ¡†çŠ¶æ€
  @State showClearCacheDialog: boolean = false;
  @State showAboutDialog: boolean = false;
  
  // åˆå§‹åŒ–
  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒç”¨
   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'SettingsPage appeared');
    this.loadSettings();
    this.calculateCacheSize();
  }

  /**
   * é¡µé¢å¸è½½æ—¶è°ƒç”¨
   */
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'SettingsPage disappeared');
  }
  
  /**
   * åŠ è½½è®¾ç½®
   */
  private loadSettings(): void {
    try {
      // ä»é…ç½®æœåŠ¡åŠ è½½è®¾ç½®
      // ä½¿ç”¨Promiseé“¾æ¥åŠ è½½æ‰€æœ‰è®¾ç½®
      configService.getConfig('themeMode', 'auto')
        .then(themeMode => {
          this.themeMode = themeMode;
          return configService.getConfig('language', 'zh');
        })
        .then(language => {
          this.language = language;
          return configService.getConfig('autoPlay', true);
        })
        .then(autoPlay => {
          this.autoPlay = autoPlay;
          return configService.getConfig('autoNextEpisode', true);
        })
        .then(autoNextEpisode => {
          this.autoNextEpisode = autoNextEpisode;
          return configService.getConfig('rememberProgress', true);
        })
        .then(rememberProgress => {
          this.rememberProgress = rememberProgress;
          return configService.getConfig('enableHardwareAcceleration', true);
        })
        .then(enableHardwareAcceleration => {
          this.enableHardwareAcceleration = enableHardwareAcceleration;
          return configService.getConfig('cacheStrategy', 'disk');
        })
        .then(cacheStrategy => {
          this.cacheStrategy = cacheStrategy;
          return configService.getConfig('maxCacheSize', 1024);
        })
        .then(maxCacheSize => {
          this.maxCacheSize = maxCacheSize;
          return configService.getConfig('enableUpdateCheck', true);
        })
        .then(enableUpdateCheck => {
          this.enableUpdateCheck = enableUpdateCheck;
          return configService.getConfig('notificationsEnabled', true);
        })
        .then(notificationsEnabled => {
          this.notificationsEnabled = notificationsEnabled;
          return configService.getConfig('enableAdBlock', true);
        })
        .then(enableAdBlock => {
          this.enableAdBlock = enableAdBlock;
          return configService.getConfig('blockVideoAds', true);
        })
        .then(blockVideoAds => {
          this.blockVideoAds = blockVideoAds;
          return configService.getConfig('blockPopupAds', true);
        })
        .then(blockPopupAds => {
          this.blockPopupAds = blockPopupAds;
          return configService.getConfig('enableWallpaper', false);
        })
        .then(enableWallpaper => {
          this.enableWallpaper = enableWallpaper;
          return configService.getConfig('wallpaperType', 'none');
        })
        .then(wallpaperType => {
          this.wallpaperType = wallpaperType;
          return configService.getConfig('enableVoiceAssistant', true);
        })
        .then(enableVoiceAssistant => {
          this.enableVoiceAssistant = enableVoiceAssistant;
          return configService.getConfig('enableDeviceFlow', true);
        })
        .then(enableDeviceFlow => {
          this.enableDeviceFlow = enableDeviceFlow;
          // è·å–åº”ç”¨ç‰ˆæœ¬
          return this.getAppVersion();
        })
        .then(version => {
          this.version = version;
          Logger.info(this.TAG, 'Settings loaded successfully');
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to load settings: ${error}`);
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load settings: ${error}`);
    }
  }
  
  /**
   * ä¿å­˜è®¾ç½®
   */
  private saveSetting(key: string, value: any): void {
    try {
      configService.setConfig(key, value)
        .then(() => {
          Logger.info(this.TAG, `Setting saved: ${key} = ${value}`);
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to save setting ${key}: ${error}`);
          Toast.show({ message: 'ä¿å­˜è®¾ç½®å¤±è´¥' });
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save setting ${key}: ${error}`);
      Toast.show({ message: 'ä¿å­˜è®¾ç½®å¤±è´¥' });
    }
  }
  
  /**
   * è®¡ç®—ç¼“å­˜å¤§å°
   */
  private calculateCacheSize(): void {
    try {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨ç¼“å­˜ç®¡ç†æœåŠ¡è®¡ç®—ç¼“å­˜å¤§å°
      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.currentCacheSize = 235; // MB
      Logger.info(this.TAG, `Cache size calculated: ${this.currentCacheSize} MB`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to calculate cache size: ${error}`);
    }
  }
  
  /**
   * æ¸…é™¤ç¼“å­˜
   */
  private clearCache(): void {
    try {
      // è°ƒç”¨ç›¸å…³æœåŠ¡æ¸…é™¤ç¼“å­˜
      mediaService.clearCache()
        .then(() => {
          // æ›´æ–°ç¼“å­˜å¤§å°
          this.currentCacheSize = 0;
          this.showClearCacheDialog = false;
          
          Logger.info(this.TAG, 'Cache cleared successfully');
          Toast.show({ message: 'ç¼“å­˜å·²æ¸…é™¤' });
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to clear cache: ${error}`);
          Toast.show({ message: 'æ¸…é™¤ç¼“å­˜å¤±è´¥' });
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear cache: ${error}`);
      Toast.show({ message: 'æ¸…é™¤ç¼“å­˜å¤±è´¥' });
    }
  }
  
  /**
   * è·å–åº”ç”¨ç‰ˆæœ¬
   */
  private getAppVersion(): string {
    try {
      // è¿™é‡Œåº”è¯¥ä»åº”ç”¨é…ç½®ä¸­è·å–ç‰ˆæœ¬å·
      // æš‚æ—¶è¿”å›å›ºå®šç‰ˆæœ¬
      return '1.0.0';
    } catch (error) {
      Logger.error(this.TAG, `Failed to get app version: ${error}`);
      return '1.0.0';
    }
  }
  
  /**
   * æ£€æŸ¥æ›´æ–°
   */
  private checkForUpdates(): void {
    try {
      // è°ƒç”¨æ›´æ–°æ£€æŸ¥æœåŠ¡
      Logger.info(this.TAG, 'Checking for updates...');
      
      // æ¨¡æ‹Ÿæ£€æŸ¥æ›´æ–°
      Toast.show({ message: 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬' });
    } catch (error) {
      Logger.error(this.TAG, `Failed to check for updates: ${error}`);
      Toast.show({ message: 'æ£€æŸ¥æ›´æ–°å¤±è´¥' });
    }
  }
  
  /**
   * é‡ç½®æ‰€æœ‰è®¾ç½®
   */
  private resetSettings(): void {
    try {
      // é‡ç½®é…ç½®æœåŠ¡ä¸­çš„æ‰€æœ‰è®¾ç½®
      configService.resetAllConfigs()
        .then(() => {
          // é‡æ–°åŠ è½½è®¾ç½®
          this.loadSettings();
          
          Logger.info(this.TAG, 'Settings reset to default');
          Toast.show({ message: 'å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®' });
        })
        .catch(error => {
          Logger.error(this.TAG, `Failed to reset settings: ${error}`);
          Toast.show({ message: 'é‡ç½®è®¾ç½®å¤±è´¥' });
        });
    } catch (error) {
      Logger.error(this.TAG, `Failed to reset settings: ${error}`);
      Toast.show({ message: 'é‡ç½®è®¾ç½®å¤±è´¥' });
    }
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    Router.back();
  }
  
  /**
   * å¤„ç†ä¸»é¢˜åˆ‡æ¢
   */
  private handleThemeChange(theme: 'light' | 'dark' | 'auto'): void {
    this.themeMode = theme;
    this.saveSetting('themeMode', theme);
    // è¿™é‡Œåº”è¯¥åº”ç”¨ä¸»é¢˜åˆ‡æ¢
  }
  
  /**
   * æ¸²æŸ“å¤´éƒ¨
   */
  @Builder
  private renderHeader(): void {
    Stack.create();
    Stack.width('100%');
    Stack.height('80vp');
    Stack.backgroundColor('#00AA00');
    Stack.justifyContent(FlexAlign.Center);
    Stack.alignItems(FlexAlign.Start);
    Stack.padding({ left: '20vp' });
    
    Button.create();
    Button.width('60vp');
    Button.height('60vp');
    Button.backgroundColor('transparent');
    Button.justifyContent(FlexAlign.Center);
    Button.alignItems(FlexAlign.Center);
    Button.onClick(this.handleBack);
    Text.create();
    Text.fontSize('30vp');
    Text.text("â†");
    Text.fontColor('#FFFFFF');
    Text.pop();
    Button.pop();
    
    Text.create();
    Text.fontSize('32vp');
    Text.fontColor('#FFFFFF');
    Text.fontWeight(FontWeight.Bold);
    Text.text("è®¾ç½®");
    Text.margin({ left: '20vp' });
    Text.pop();
    
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“è®¾ç½®åˆ†ç»„
   */
  @Builder
  private renderSettingGroup(title: string, content: () => void): void {
    Column.create();
    Column.width('100%');
    Column.margin({ top: '20vp' });
    
    Text.create();
    Text.fontSize('24vp');
    Text.fontColor('#333333');
    Text.fontWeight(FontWeight.Bold);
    Text.margin({ left: '20vp', bottom: '10vp' });
    Text.text(title);
    Text.pop();
    
    content();
    
    Column.pop();
  }
  
  /**
   * æ¸²æŸ“å¼€å…³è®¾ç½®é¡¹
   */
  @Builder
  private renderSwitchItem(label: string, checked: boolean, onValueChange: (value: boolean) => void, description?: string): void {
    Stack.create();
    Stack.width('90%');
    Stack.height('100vp');
    Stack.margin({ left: '5%', right: '5%', bottom: '10vp' });
    Stack.backgroundColor('#FFFFFF');
    Stack.borderRadius('12vp');
    Stack.padding({ left: '20vp', right: '20vp' });
    Stack.justifyContent(FlexAlign.Center);
    Stack.shadow({ radius: 4, color: '#00000020', offsetX: 0, offsetY: 2 });
    
    Flex.create();
    Flex.width('100%');
    Flex.justifyContent(FlexAlign.SpaceBetween);
    Flex.alignItems(FlexAlign.Center);
    
    Flex.create();
    Flex.direction(FlexDirection.Column);
    
    Text.create();
    Text.fontSize('20vp');
    Text.fontColor('#333333');
    Text.text(label);
    Text.pop();
    
    if (description) {
      Text.create();
      Text.fontSize('14vp');
      Text.fontColor('#666666');
      Text.margin({ top: '5vp' });
      Text.text(description);
      Text.pop();
    }
    
    Flex.pop();
    
    Switch.create();
    Switch.checked(checked);
    Switch.onValueChange(onValueChange);
    Switch.trackColor({ checked: '#00AA00', unchecked: '#DDDDDD' });
    Switch.thumbColor('#FFFFFF');
    Switch.width('80vp');
    Switch.height('40vp');
    Switch.pop();
    
    Flex.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“é€‰é¡¹è®¾ç½®é¡¹
   */
  @Builder
  private renderOptionItem(label: string, value: string, onClick: () => void, icon?: string): void {
    Stack.create();
    Stack.width('90%');
    Stack.height('100vp');
    Stack.margin({ left: '5%', right: '5%', bottom: '10vp' });
    Stack.backgroundColor('#FFFFFF');
    Stack.borderRadius('12vp');
    Stack.padding({ left: '20vp', right: '20vp' });
    Stack.justifyContent(FlexAlign.Center);
    Stack.shadow({ radius: 4, color: '#00000020', offsetX: 0, offsetY: 2 });
    Stack.onClick(onClick);
    
    Flex.create();
    Flex.width('100%');
    Flex.justifyContent(FlexAlign.SpaceBetween);
    Flex.alignItems(FlexAlign.Center);
    
    Flex.create();
    Flex.alignItems(FlexAlign.Center);
    
    if (icon) {
      Text.create();
      Text.fontSize('24vp');
      Text.margin({ right: '15vp' });
      Text.text(icon);
      Text.pop();
    }
    
    Flex.create();
    Flex.direction(FlexDirection.Column);
    
    Text.create();
    Text.fontSize('20vp');
    Text.fontColor('#333333');
    Text.text(label);
    Text.pop();
    
    if (value) {
      Text.create();
      Text.fontSize('16vp');
      Text.fontColor('#666666');
      Text.margin({ top: '5vp' });
      Text.text(value);
      Text.pop();
    }
    
    Flex.pop();
    Flex.pop();
    
    Flex.create();
    Flex.alignItems(FlexAlign.Center);
    
    if (value) {
      Text.create();
      Text.fontSize('16vp');
      Text.fontColor('#666666');
      Text.margin({ right: '10vp' });
      Text.text(value);
      Text.pop();
    }
    
    Text.create();
    Text.fontSize('20vp');
    Text.fontColor('#999999');
    Text.text("â†’");
    Text.pop();
    
    Flex.pop();
    
    Flex.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“ä¸»é¢˜è®¾ç½®
   */
  @Builder
  private renderThemeSettings(): void {
    this.renderSettingGroup('å¤–è§‚è®¾ç½®', () => {
      Stack.create();
      Stack.width('90%');
      Stack.height('140vp');
      Stack.margin({ left: '5%', right: '5%', bottom: '10vp' });
      Stack.backgroundColor('#FFFFFF');
      Stack.borderRadius('12vp');
      Stack.padding({ left: '20vp', right: '20vp' });
      Stack.justifyContent(FlexAlign.Center);
      Stack.shadow({ radius: 4, color: '#00000020', offsetX: 0, offsetY: 2 });
      
      Column.create();
      Column.width('100%');
      
      Text.create();
      Text.fontSize('20vp');
      Text.fontColor('#333333');
      Text.margin({ bottom: '20vp' });
      Text.text("ä¸»é¢˜æ¨¡å¼");
      Text.pop();
      
      Flex.create();
      Flex.width('100%');
      Flex.justifyContent(FlexAlign.SpaceBetween);
      
      Button.create();
      Button.width('30%');
      Button.height('50vp');
      Button.backgroundColor(this.themeMode === 'light' ? '#00AA00' : '#F0F0F0');
      Button.borderRadius('8vp');
      Button.onClick(() => this.handleThemeChange('light'));
      Text.create();
      Text.fontSize('16vp');
      Text.fontColor(this.themeMode === 'light' ? '#FFFFFF' : '#333333');
      Text.text("æµ…è‰²");
      Text.pop();
      Button.pop();
      
      Button.create();
      Button.width('30%');
      Button.height('50vp');
      Button.backgroundColor(this.themeMode === 'dark' ? '#00AA00' : '#F0F0F0');
      Button.borderRadius('8vp');
      Button.onClick(() => this.handleThemeChange('dark'));
      Text.create();
      Text.fontSize('16vp');
      Text.fontColor(this.themeMode === 'dark' ? '#FFFFFF' : '#333333');
      Text.text("æ·±è‰²");
      Text.pop();
      Button.pop();
      
      Button.create();
      Button.width('30%');
      Button.height('50vp');
      Button.backgroundColor(this.themeMode === 'auto' ? '#00AA00' : '#F0F0F0');
      Button.borderRadius('8vp');
      Button.onClick(() => this.handleThemeChange('auto'));
      Text.create();
      Text.fontSize('16vp');
      Text.fontColor(this.themeMode === 'auto' ? '#FFFFFF' : '#333333');
      Text.text("è‡ªåŠ¨");
      Text.pop();
      Button.pop();
      
      Flex.pop();
      Column.pop();
      Stack.pop();
      
      this.renderOptionItem(
        'è¯­è¨€', 
        this.language === 'zh' ? 'ç®€ä½“ä¸­æ–‡' : 'English', 
        () => {}
      );
    });
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾è®¾ç½®
   */
  @Builder
  private renderPlaybackSettings(): void {
    this.renderSettingGroup('æ’­æ”¾è®¾ç½®', () => {
      this.renderSwitchItem(
        'è‡ªåŠ¨æ’­æ”¾', 
        this.autoPlay, 
        (value) => {
          this.autoPlay = value;
          this.saveSetting('autoPlay', value);
        },
        'è¿›å…¥æ’­æ”¾é¡µåè‡ªåŠ¨å¼€å§‹æ’­æ”¾'
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é›†',
        this.autoNextEpisode, 
        (value) => {
          this.autoNextEpisode = value;
          this.saveSetting('autoNextEpisode', value);
        }
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'è®°ä½æ’­æ”¾è¿›åº¦', 
        this.rememberProgress, 
        (value) => {
          this.rememberProgress = value;
          this.saveSetting('rememberProgress', value);
        }
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'ç¡¬ä»¶åŠ é€Ÿ', 
        this.enableHardwareAcceleration, 
        (value) => {
          this.enableHardwareAcceleration = value;
          this.saveSetting('enableHardwareAcceleration', value);
        },
        'ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæé«˜æ’­æ”¾æµç•…åº¦'
      );
    });
  }
  
  /**
   * æ¸²æŸ“ç¼“å­˜è®¾ç½®
   */
  @Builder
  private renderCacheSettings(): void {
    this.renderSettingGroup('ç¼“å­˜è®¾ç½®', () => {
      this.renderOptionItem(
        'ç¼“å­˜ç­–ç•¥', 
        this.getCacheStrategyText(), 
        () => {}
      );
      
      Stack.create();
      Stack.width('90%');
      Stack.height('100vp');
      Stack.margin({ left: '5%', right: '5%', bottom: '10vp' });
      Stack.backgroundColor('#FFFFFF');
      Stack.borderRadius('12vp');
      Stack.padding({ left: '20vp', right: '20vp' });
      Stack.justifyContent(FlexAlign.Center);
      Stack.shadow({ radius: 4, color: '#00000020', offsetX: 0, offsetY: 2 });
      
      Flex.create();
      Flex.width('100%');
      Flex.justifyContent(FlexAlign.SpaceBetween);
      Flex.alignItems(FlexAlign.Center);
      
      Text.create();
      Text.fontSize('20vp');
      Text.fontColor('#333333');
      Text.text("æœ€å¤§ç¼“å­˜å¤§å°");
      Text.pop();
      
      Text.create();
      Text.fontSize('18vp');
      Text.fontColor('#00AA00');
      Text.fontWeight(FontWeight.Bold);
      Text.text(this.maxCacheSize + " MB");
      Text.pop();
      
      Flex.pop();
      Stack.pop();
      
      this.renderOptionItem(
        'æ¸…é™¤ç¼“å­˜', 
        `${this.currentCacheSize} MB`, 
        () => { this.showClearCacheDialog = true; },
        'ğŸ—‘ï¸'
      );
    });
  }
  
  /**
   * æ¸²æŸ“é€šçŸ¥è®¾ç½®
   */
  @Builder
  private renderNotificationSettings(): void {
    this.renderSettingGroup('é€šçŸ¥è®¾ç½®', () => {
      this.renderSwitchItem(
        'å¼€å¯é€šçŸ¥', 
        this.notificationsEnabled, 
        (value) => {
          this.notificationsEnabled = value;
          this.saveSetting('notificationsEnabled', value);
        }
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'æ£€æŸ¥æ›´æ–°', 
        this.enableUpdateCheck, 
        (value) => {
          this.enableUpdateCheck = value;
          this.saveSetting('enableUpdateCheck', value);
        }
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderOptionItem(
        'æ£€æŸ¥æ›´æ–°', 
        '', 
        this.checkForUpdates,
        'ğŸ”„'
      );
    });
  }
  
  /**
   * æ¸²æŸ“å¹¿å‘Šå±è”½è®¾ç½®
   */
  @Builder
  private renderAdBlockSettings(): void {
    this.renderSettingGroup('å¹¿å‘Šå±è”½', () => {
      this.renderSwitchItem(
        'å¯ç”¨å¹¿å‘Šå±è”½', 
        this.enableAdBlock, 
        (value) => {
          this.enableAdBlock = value;
          this.saveSetting('enableAdBlock', value);
        },
        'å±è”½è§†é¢‘ä¸­çš„å¹¿å‘Šå†…å®¹'
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'å±è”½è§†é¢‘å¹¿å‘Š', 
        this.blockVideoAds, 
        (value) => {
          this.blockVideoAds = value;
          this.saveSetting('blockVideoAds', value);
        },
        'è¿‡æ»¤æ’­æ”¾è¿‡ç¨‹ä¸­çš„å¹¿å‘Šç‰‡æ®µ'
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'å±è”½å¼¹çª—å¹¿å‘Š', 
        this.blockPopupAds, 
        (value) => {
          this.blockPopupAds = value;
          this.saveSetting('blockPopupAds', value);
        },
        'æ‹¦æˆªé¡µé¢ä¸­çš„å¼¹çª—å¹¿å‘Š'
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderOptionItem(
        'æ›´æ–°å¹¿å‘Šè§„åˆ™', 
        '', 
        this.updateAdBlockRules,
        'ğŸ”„'
      );
    });
  }
  
  /**
   * æ¸²æŸ“å£çº¸è®¾ç½®
   */
  @Builder
  private renderWallpaperSettings(): void {
    this.renderSettingGroup('å£çº¸è®¾ç½®', () => {
      this.renderSwitchItem(
        'å¯ç”¨å£çº¸', 
        this.enableWallpaper, 
        (value) => {
          this.enableWallpaper = value;
          this.saveSetting('enableWallpaper', value);
        },
        'è‡ªå®šä¹‰åº”ç”¨èƒŒæ™¯å£çº¸'
      );
      
      this.renderOptionItem(
        'å£çº¸ç±»å‹', 
        this.getWallpaperTypeText(), 
        () => {}
      );
      
      this.renderOptionItem(
        'é€‰æ‹©å£çº¸', 
        '', 
        this.selectWallpaper,
        'ğŸ–¼ï¸'
      );
    });
  }
  
  /**
   * æ¸²æŸ“é¸¿è’™ç‰¹æœ‰åŠŸèƒ½è®¾ç½®
   */
  @Builder
  private renderHarmonyFeaturesSettings(): void {
    this.renderSettingGroup('é¸¿è’™åŠŸèƒ½', () => {
      this.renderSwitchItem(
        'å°è‰ºè¯­éŸ³åŠ©æ‰‹', 
        this.enableVoiceAssistant, 
        (value) => {
          this.enableVoiceAssistant = value;
          this.saveSetting('enableVoiceAssistant', value);
        },
        'é€šè¿‡è¯­éŸ³æ§åˆ¶åº”ç”¨åŠŸèƒ½'
      );
      
      Divider.create();
      Divider.pop();
      
      this.renderSwitchItem(
        'è®¾å¤‡æµè½¬', 
        this.enableDeviceFlow, 
        (value) => {
          this.enableDeviceFlow = value;
          this.saveSetting('enableDeviceFlow', value);
        },
        'åœ¨ä¸åŒè®¾å¤‡é—´æ— ç¼åˆ‡æ¢æ’­æ”¾'
      );
    });
  }
  
  /**
   * æ›´æ–°å¹¿å‘Šè§„åˆ™
   */
  private updateAdBlockRules(): void {
    try {
      Logger.info(this.TAG, 'Updating ad block rules...');
      // è¿™é‡Œåº”è¯¥è°ƒç”¨å¹¿å‘Šå±è”½æœåŠ¡æ›´æ–°è§„åˆ™
      Toast.show({ message: 'å¹¿å‘Šè§„åˆ™æ›´æ–°æˆåŠŸ' });
    } catch (error) {
      Logger.error(this.TAG, `Failed to update ad block rules: ${error}`);
      Toast.show({ message: 'æ›´æ–°å¹¿å‘Šè§„åˆ™å¤±è´¥' });
    }
  }
  
  /**
   * é€‰æ‹©å£çº¸
   */
  private selectWallpaper(): void {
    try {
      Logger.info(this.TAG, 'Selecting wallpaper...');
      // è¿™é‡Œåº”è¯¥æ‰“å¼€å£çº¸é€‰æ‹©ç•Œé¢
      Toast.show({ message: 'è¯·é€‰æ‹©å£çº¸' });
    } catch (error) {
      Logger.error(this.TAG, `Failed to select wallpaper: ${error}`);
      Toast.show({ message: 'é€‰æ‹©å£çº¸å¤±è´¥' });
    }
  }
  
  /**
   * è·å–å£çº¸ç±»å‹æ–‡æœ¬
   */
  private getWallpaperTypeText(): string {
    switch (this.wallpaperType) {
      case 'none':
        return 'æ— å£çº¸';
      case 'image':
        return 'å›¾ç‰‡å£çº¸';
      case 'video':
        return 'è§†é¢‘å£çº¸';
      default:
        return 'æ— å£çº¸';
    }
  }
  
  /**
   * æ¸²æŸ“å…³äºè®¾ç½®
   */
  @Builder
  private renderAboutSettings(): void {
    this.renderSettingGroup('å…³äº', () => {
      this.renderOptionItem(
        'å…³äºåº”ç”¨', 
        '', 
        () => { this.showAboutDialog = true; },
        'â„¹ï¸'
      );
      
      Stack.create();
      Stack.width('90%');
      Stack.height('100vp');
      Stack.margin({ left: '5%', right: '5%', bottom: '10vp' });
      Stack.backgroundColor('#FFFFFF');
      Stack.borderRadius('12vp');
      Stack.padding({ left: '20vp', right: '20vp' });
      Stack.justifyContent(FlexAlign.Center);
      Stack.shadow({ radius: 4, color: '#00000020', offsetX: 0, offsetY: 2 });
      
      Flex.create();
      Flex.width('100%');
      Flex.justifyContent(FlexAlign.SpaceBetween);
      Flex.alignItems(FlexAlign.Center);
      
      Text.create();
      Text.fontSize('20vp');
      Text.fontColor('#333333');
      Text.text("ç‰ˆæœ¬");
      Text.pop();
      
      Text.create();
      Text.fontSize('18vp');
      Text.fontColor('#00AA00');
      Text.fontWeight(FontWeight.Bold);
      Text.text("v" + this.version);
      Text.pop();
      
      Flex.pop();
      Stack.pop();
      
      this.renderOptionItem(
        'ç”¨æˆ·åè®®', 
        '', 
        () => {},
        'ğŸ“„'
      );
      
      this.renderOptionItem(
        'éšç§æ”¿ç­–', 
        '', 
        () => {},
        'ğŸ”’'
      );
      
      Button.create();
      Button.width('90%');
      Button.height('80vp');
      Button.margin({ left: '5%', right: '5%', top: '10vp', bottom: '20vp' });
      Button.backgroundColor('#00AA00');
      Button.borderRadius('12vp');
      Button.onClick(this.resetSettings);
      Text.create();
      Text.fontSize('20vp');
      Text.fontColor('#FFFFFF');
      Text.fontWeight(FontWeight.Bold);
      Text.content("æ¢å¤é»˜è®¤è®¾ç½®");
      Text.pop();
      Button.pop();
    });
  }
  
  /**
   * è·å–ç¼“å­˜ç­–ç•¥æ–‡æœ¬
   */
  private getCacheStrategyText(): string {
    switch (this.cacheStrategy) {
      case 'memory':
        return 'ä»…å†…å­˜';
      case 'disk':
        return 'ç£ç›˜';
      case 'none':
        return 'æ— ç¼“å­˜';
      default:
        return 'ç£ç›˜';
    }
  }
  
  /**
   * æ¸²æŸ“æ¸…é™¤ç¼“å­˜å¯¹è¯æ¡†
   */
  @Builder
  private renderClearCacheDialog(): void {
    Dialog.create();
    Dialog.open(this.showClearCacheDialog);
    Dialog.onCancel(() => { this.showClearCacheDialog = false; });
    Dialog.onClose(() => { this.showClearCacheDialog = false; });
    Stack.create();
    Stack.width('80%');
    Stack.height('280vp');
    Stack.backgroundColor('#FFFFFF');
    Stack.borderRadius('16vp');
    Stack.padding({ left: '20vp', right: '20vp', top: '30vp', bottom: '20vp' });
    Stack.justifyContent(FlexAlign.SpaceBetween);
    
    Column.create();
    Column.alignItems(FlexAlign.Center);
    
    Text.create();
    Text.fontSize('24vp');
    Text.fontColor('#333333');
    Text.fontWeight(FontWeight.Bold);
    Text.margin({ bottom: '20vp' });
    Text.content("æ¸…é™¤ç¼“å­˜");
    Text.pop();
    
    Text.create();
    Text.fontSize('18vp');
    Text.fontColor('#666666');
    Text.textAlign(TextAlign.Center);
    Text.content("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç¦»çº¿å†…å®¹ã€‚");
    Text.pop();
    
    Column.pop();
    
    Flex.create();
    Flex.width('100%');
    Flex.justifyContent(FlexAlign.SpaceBetween);
    
    Button.create();
    Button.width('48%');
    Button.height('60vp');
    Button.backgroundColor('#F0F0F0');
    Button.borderRadius('30vp');
    Button.onClick(() => { this.showClearCacheDialog = false; });
    Text.create();
    Text.fontSize('18vp');
    Text.fontColor('#333333');
    Text.content("å–æ¶ˆ");
    Text.pop();
    Button.pop();
    
    Button.create();
    Button.width('48%');
    Button.height('60vp');
    Button.backgroundColor('#00AA00');
    Button.borderRadius('30vp');
    Button.onClick(this.clearCache);
    Text.create();
    Text.fontSize('18vp');
    Text.fontColor('#FFFFFF');
    Text.content("ç¡®å®š");
    Text.pop();
    Button.pop();
    
    Flex.pop();
    Stack.pop();
    Dialog.pop();
  }
  
  /**
   * æ¸²æŸ“å…³äºå¯¹è¯æ¡†
   */
  @Builder
  private renderAboutDialog(): void {
    Dialog.create();
    Dialog.open(this.showAboutDialog);
    Dialog.onCancel(() => { this.showAboutDialog = false; });
    Dialog.onClose(() => { this.showAboutDialog = false; });
    Stack.create();
    Stack.width('85%');
    Stack.height('400vp');
    Stack.backgroundColor('#FFFFFF');
    Stack.borderRadius('16vp');
    Stack.padding({ left: '20vp', right: '20vp', top: '30vp', bottom: '20vp' });
    Stack.justifyContent(FlexAlign.Center);
    Stack.alignItems(FlexAlign.Center);
    
    Column.create();
    Column.alignItems(FlexAlign.Center);
    
    Stack.create();
    Stack.width('120vp');
    Stack.height('120vp');
    Stack.backgroundColor('#00AA00');
    Stack.borderRadius('24vp');
    Stack.justifyContent(FlexAlign.Center);
    Stack.alignItems(FlexAlign.Center);
    Text.create();
    Text.fontSize('60vp');
    Text.fontColor('#FFFFFF');
    Text.text('RT');
    Text.pop();
    Stack.pop();
    
    Text.create();
    Text.fontSize('28vp');
    Text.fontColor('#333333');
    Text.fontWeight(FontWeight.Bold);
    Text.margin({ top: '20vp' });
    Text.content("RayTV");
    Text.pop();
    
    Text.create();
    Text.fontSize('18vp');
    Text.fontColor('#00AA00');
    Text.margin({ top: '10vp' });
    Text.content("ç‰ˆæœ¬ v" + this.version);
    Text.pop();
    
    Text.create();
    Text.fontSize('16vp');
    Text.fontColor('#666666');
    Text.textAlign(TextAlign.Center);
    Text.margin({ top: '20vp', left: '10vp', right: '10vp' });
    Text.content("ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„åª’ä½“æ’­æ”¾å™¨åº”ç”¨ï¼Œä¸ºæ‚¨æä¾›ä¼˜è´¨çš„è§‚å½±ä½“éªŒã€‚");
    Text.pop();
    
    Text.create();
    Text.fontSize('14vp');
    Text.fontColor('#999999');
    Text.margin({ top: '20vp' });
    Text.content("Â© 2024 RayTV Team");
    Text.pop();
    
    Button.create();
    Button.width('60%');
    Button.height('60vp');
    Button.backgroundColor('#00AA00');
    Button.borderRadius('30vp');
    Button.margin({ top: '20vp' });
    Button.onClick(() => { this.showAboutDialog = false; });
    Text.create();
    Text.fontSize('18vp');
    Text.fontColor('#FFFFFF');
    Text.content("ç¡®å®š");
    Text.pop();
    Button.pop();
    
    Column.pop();
    Stack.pop();
    Dialog.pop();
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Stack.create();
    Stack.width('100%');
    Stack.height('100%');
    Stack.backgroundColor('#F5F5F5');
    
    // é¡µé¢å¤´éƒ¨
    this.renderHeader();
    
    // è®¾ç½®å†…å®¹
    ScrollView.create();
    ScrollView.width('100%');
    ScrollView.height('100%');
    ScrollView.scrollBar(ScrollBarState.Auto);
    ScrollView.padding({ top: '10vp', bottom: '30vp' });
    
    // åˆ›å»ºè®¾ç½®é¡¹ç½‘æ ¼å¸ƒå±€
    Column.create();
    Column.width('100%');
    
    // æ¸²æŸ“å„ç§è®¾ç½®åˆ†ç»„
    this.renderThemeSettings();
    this.renderPlaybackSettings();
    this.renderAdBlockSettings();
    this.renderWallpaperSettings();
    this.renderHarmonyFeaturesSettings();
    this.renderCacheSettings();
    this.renderNotificationSettings();
    this.renderAboutSettings();
    
    // åº•éƒ¨ç©ºé—´
    Blank.create();
    Blank.height('30vp');
    Blank.pop();
    
    Column.pop();
    ScrollView.pop();
    
    // å¯¹è¯æ¡†
    this.renderClearCacheDialog();
    this.renderAboutDialog();
    
    Stack.pop();
  }
}

export default SettingsPage;