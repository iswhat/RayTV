import { Stack, Video, Image, Button, Slider, List, ListItem, LoadingProgress, Toast, PromptAction } from '@kit.ArkUI';
import Router from '@ohos.router';
import Logger from '../common/util/Logger';
import { playbackService } from '../service/media/PlaybackService';
import { historyService } from '../service/media/HistoryService';
import { mediaService } from '../service/media/MediaService';
import { configService } from '../service/config/ConfigService';
import { PlaybackState, PlaybackSpeed, PlaySource, Subtitle } from '../service/media/PlaybackService';

/**
 * Êí≠ÊîæÈ°µÈù¢ÁªÑ‰ª∂
 * ÂÆûÁé∞ËßÜÈ¢ëÊí≠ÊîæÊéßÂà∂ÁïåÈù¢ÔºåÂåÖÂê´Êí≠Êî?ÊöÇÂÅú„ÄÅËøõÂ∫¶ÊéßÂà∂„ÄÅÈü≥ÈáèÊéßÂà∂„ÄÅÈÄüÂ∫¶Ë∞ÉÊï¥Á≠âÂäüËÉ? */
@Component
struct PlaybackPage {
  private readonly TAG: string = 'PlaybackPage';
  
  // Ë∑ØÁî±ÂèÇÊï∞
  private mediaId: string = '';
  private siteKey: string = '';
  private episodeId?: string;
  private initialPosition: number = 0;
  private mediaTitle: string = '';
  private episodeName: string = '';
  private playSource?: PlaySource;
  private playSourceIndex: number = 0;
  
  // Áä∂ÊÄÅÁÆ°Áê?  @State playbackState: PlaybackState = PlaybackState.IDLE;
  @State currentTime: number = 0;
  @State duration: number = 0;
  @State isPlaying: boolean = false;
  @State volume: number = 1.0;
  @State isMuted: boolean = false;
  @State playbackSpeed: PlaybackSpeed = PlaybackSpeed.NORMAL;
  @State isBuffering: boolean = false;
  @State bufferPercentage: number = 0;
  @State showControls: boolean = true;
  @State showSpeedMenu: boolean = false;
  @State showSourceMenu: boolean = false;
  @State showSubtitleMenu: boolean = false;
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State searchText: string = '';
  @State subtitles: Subtitle[] = [];
  @State selectedSubtitle: Subtitle | null = null;
  @State isFullscreen: boolean = false;
  @State errorMessage: string = '';
  @State isLoading: boolean = true;
  @State controlsTimeout: number | null = null;
  @State lastProgressSaveTime: number = 0;
  @State saveProgressInterval: number = 30000; // 30Áßí‰øùÂ≠ò‰∏ÄÊ¨°ËøõÂ∫?  @State searchFocused: boolean = false;
  private autoSwitchSourceOnError: boolean = true; // ÊòØÂê¶Ëá™Âä®ÂàáÊç¢ÁâáÊ∫ê
  private lastSaveTime: number = 0; // ‰∏äÊ¨°‰øùÂ≠òËøõÂ∫¶ÁöÑÊó∂Èó?ÊØ´Áßí)
  private currentPosition: number = 0; // ÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
  private totalTime: number = 0;
  
  // ÂàùÂßãÂå?  /**
   * È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî?   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'PlaybackPage appeared');
    
    // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞
    const params = this.context.router.getParams();
    this.mediaId = (params?.mediaId as string) || '';
    this.siteKey = (params?.siteKey as string) || '';
    this.episodeId = params?.episodeId;
    this.initialPosition = (params?.currentTime as number) || (params?.startPosition as number) || 0;
    this.mediaTitle = (params?.mediaTitle as string) || 'Ê≠£Âú®Êí≠Êîæ';
    this.episodeName = (params?.episodeName as string) || '';
    this.playSource = params?.playSource;
    this.playSourceIndex = (params?.playSourceIndex as number) || 0;
    this.autoSwitchSourceOnError = params?.autoSwitchSourceOnError !== false; // ÈªòËÆ§ÂºÄÂê?    
    Logger.info(this.TAG, `Starting playback for: ${this.siteKey}:${this.mediaId}${this.episodeId ? ` episode: ${this.episodeId}` : ''}, startPosition=${this.initialPosition}`);
    
    // ÂàùÂßãÂåñÊí≠ÊîæÂô®
    this.initializePlayback();
    
    // ËÆæÁΩÆÊéßÂà∂Ê†èËá™Âä®ÈöêËó?    this.startControlsTimeout();
  }
  
  /**
     * È°µÈù¢Âç∏ËΩΩÊó∂Ë∞ÉÁî?     */
    aboutToDisappear(): void {
      Logger.info(this.TAG, 'PlaybackPage disappeared');
      this.cleanupPlayer();
    }

    /**
     * Ê∏ÖÁêÜÊí≠ÊîæÂô®ËµÑÊ∫?     */
    private cleanupPlayer(): void {
      // ÁßªÈô§Êí≠ÊîæÁõëÂê¨Âô?      playbackService.removeAllListeners();
      
      // ‰øùÂ≠òÊúÄÁªàÊí≠ÊîæËøõÂ∫?    this.savePlayProgress(this.currentPosition);
    
    // ÂÅúÊ≠¢ÊéßÂà∂Ê†èË∂ÖÊó?    this.stopControlsTimeout();
    
    // ÈáäÊîæÊí≠ÊîæÂô®ËµÑÊ∫?    this.releasePlayer();
    playbackService.stop();
    playbackService.destroy();
  }
  
  /**
   * ÂàùÂßãÂåñÊí≠Êî?   */
  private initializePlayback(): void {
    if (!this.mediaId || !this.siteKey) {
      this.errorMessage = 'Áº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞';
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
      return;
    }
    
    try {
      // Âä†ËΩΩÊí≠ÊîæÊ∫?      this.loadPlaySources().then(() => {
        // ÂàùÂßãÂåñËøáÊª§ÂêéÁöÑÁâáÊ∫êÂàóË°?        this.filteredSources = [...this.playSources];
        
        // ËÆæÁΩÆÊí≠ÊîæÊ∫êÂπ∂ÂºÄÂßãÊí≠Êî?        if (this.playSource) {
          this.setupPlayback(this.playSource);
        } else if (this.playSources.length > 0 && this.playSourceIndex < this.playSources.length) {
          this.setupPlayback(this.playSources[this.playSourceIndex]);
        } else {
          this.errorMessage = 'Êó†ÂèØÁî®Êí≠ÊîæÊ∫ê';
          this.isLoading = false;
          this.playbackState = PlaybackState.ERROR;
        }
      }).catch((error) => {
        Logger.error(this.TAG, 'Failed to initialize playback', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
        this.errorMessage = 'Êí≠ÊîæÂàùÂßãÂåñÂ§±Ë¥?;
        this.isLoading = false;
        this.playbackState = PlaybackState.ERROR;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize playback: ${error}`);
      this.errorMessage = 'Êí≠ÊîæÂàùÂßãÂåñÂ§±Ë¥?;
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
    }
  }
  
  /**
   * Âä†ËΩΩÊí≠ÊîæÊ∫?   */
  private loadPlaySources(): Promise<void> {
    return new Promise<void>((resolve, reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject))))))) => {
      try {
        // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ•Êí≠ÊîæÊ∫êÔºåÂàô‰ªéÊúçÂä°Ëé∑Âèñ
        if (!this.playSource || this.playSources.length === 0) {
          mediaService.getPlaySources(
            this.mediaId,
            this.siteKey,
            this.episodeId
          ).then((sources) => {
            this.playSources = sources;
            Logger.info(this.TAG, `Loaded ${this.playSources.length} play sources`);
            
            // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Êí≠ÊîæÊ∫êÔºåÂàô‰ΩøÁî®ÂÆ?            if (this.playSources.length === 1 && !this.playSource) {
              this.playSource = this.playSources[0];
            }
            resolve();
          }).catch((error) => {
            Logger.error(this.TAG, `Failed to load play sources: ${error}`);
            reject(error);
          });
        } else {
          resolve();
        }
      } catch (error) {
        Logger.error(this.TAG, `Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}` instanceof Error ? `Failed to load play sources: ${error}` : new Error(String(`Failed to load play sources: ${error}`)))))));
        reject(error);
      }
    });
  }
  
  /**
   * ËÆæÁΩÆÊí≠Êîæ
   */
  private setupPlayback(source: PlaySource): void {
    try {
      // Ê∑ªÂä†Êí≠ÊîæÁõëÂê¨Âô?      this.addPlaybackListeners();
      
      // ËÆæÁΩÆÊí≠ÊîæÊ∫?      playbackService.setSource(source, {
        autoPlay: true,
        startPosition: this.initialPosition,
        volume: this.volume,
        isMuted: this.isMuted,
        playbackSpeed: this.playbackSpeed
      }).then(() => {
        this.playSource = source;
        this.isLoading = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to setup playback: ${error}`);
        
        // Â∞ùËØïËá™Âä®ÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™ÁâáÊ∫?        if (this.autoSwitchSourceOnError) {
          this.handlePlaybackError(error);
        } else {
          this.errorMessage = 'Êí≠ÊîæËÆæÁΩÆÂ§±Ë¥•';
          this.isLoading = false;
          this.playbackState = PlaybackState.ERROR;
        }
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}` instanceof Error ? `Failed to setup playback: ${error}` : new Error(String(`Failed to setup playback: ${error}`)))))));
      
      // Â∞ùËØïËá™Âä®ÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™ÁâáÊ∫?      if (this.autoSwitchSourceOnError) {
        this.handlePlaybackError(error);
      } else {
        this.errorMessage = 'Êí≠ÊîæËÆæÁΩÆÂ§±Ë¥•';
        this.isLoading = false;
        this.playbackState = PlaybackState.ERROR;
      }
    }
  }
  
  /**
   * Ê∑ªÂä†Êí≠ÊîæÁõëÂê¨Âô?   */
  private addPlaybackListeners(): void {
    playbackService.addListener({
      onStateChanged: (state) => {
        this.playbackState = state;
        this.isPlaying = state === PlaybackState.PLAYING;
        
        if (state === PlaybackState.COMPLETED) {
          this.handlePlaybackCompleted();
        } else if (state === PlaybackState.ERROR) {
          this.errorMessage = 'Êí≠ÊîæÂá∫Èîô';
        }
        
        this.showControls = true;
        this.restartControlsTimeout();
      },
      
      onError: (error: Error) => {
        Logger.error(this.TAG, `Playback error: ${error}`);
        
        // Â∞ùËØïËá™Âä®ÂàáÊç¢ÁâáÊ∫ê
        if (this.autoSwitchSourceOnError) {
          this.handlePlaybackError(error);
        } else {
          this.errorMessage = `Êí≠ÊîæÈîôËØØ: ${error.message || 'Êú™Áü•ÈîôËØØ'}`;
        }
      }, // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration instanceof Error ? // ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration : new Error(String(// ÂÆöÊúü‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
      onTimeUpdate: (currentTime, duration))))))) => {
        this.currentTime = currentTime;
        this.currentPosition = currentTime;
        this.duration = duration;
        this.totalTime = duration || this.totalTime;
        
        // ÊØ?0Áßí‰øùÂ≠ò‰∏ÄÊ¨°Êí≠ÊîæËøõÂ∫?        if (this.lastSaveTime === 0 || currentTime - this.lastSaveTime > 10000) {
          this.savePlayProgress(currentTime);
          this.lastSaveTime = currentTime;
        }
      },
      
      onCompleted: () => {
        Logger.info(this.TAG, 'Playback completed');
      },
      
      onBufferUpdate: (bufferPercentage) => {
        this.bufferPercentage = bufferPercentage;
      },
      
      onSeekCompleted: (seekTime) => {
        Logger.info(this.TAG, `Seek completed to ${seekTime}s`);
      }
    });
  }
  
  /**
   * Â§ÑÁêÜÊí≠ÊîæÂÆåÊàê
   */
  private handlePlaybackCompleted(): void {
    try {
      // ‰øùÂ≠òÂÆåÊàêÁöÑÊí≠ÊîæÁä∂ÊÄ?      historyService.updateProgress(
        this.mediaId,
        this.siteKey,
        this.duration, // Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàê
        this.episodeId,
        true // Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàê
      ).then(() => {
        Toast.show('Êí≠ÊîæÂÆåÊàê');
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to handle playback completed: ${error}`);
        Toast.show('Êí≠ÊîæÂÆåÊàê');
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}` instanceof Error ? `Failed to handle playback completed: ${error}` : new Error(String(`Failed to handle playback completed: ${error}`)))))));
      Toast.show('Êí≠ÊîæÂÆåÊàê');
    }
  }
  
  /**
   * ‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
   */
  private savePlaybackProgress(): void {
    try {
      playbackService.savePlaybackPosition(
        this.mediaId,
        this.siteKey,
        this.episodeId
      ).catch((error) => {
        Logger.error(this.TAG, `Failed to save playback progress: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}` instanceof Error ? `Failed to save playback progress: ${error}` : new Error(String(`Failed to save playback progress: ${error}`)))))));
    }
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢ÊñáÊú¨ÂèòÂåñ
   */
  private handleSearchChange(text: string) {
    this.searchText = text;
    
    // Ê†πÊçÆÊêúÁ¥¢ÊñáÊú¨ËøáÊª§ÁâáÊ∫ê
    if (text.trim()) {
      const searchLower = text.toLowerCase();
      this.filteredSources = this.playSources.filter(source => 
        (source.name && source.name.toLowerCase().includes(searchLower)) ||
        (source.description && source.description.toLowerCase().includes(searchLower))
      );
    } else {
      // Â¶ÇÊûúÊêúÁ¥¢ÊñáÊú¨‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâÁâáÊ∫?      this.filteredSources = [...this.playSources];
    }
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢Ê°ÜÁÑ¶ÁÇπÂèòÂå?   */
  private handleSearchFocusChange(focused: boolean) {
    this.searchFocused = focused;
  }
  
  /**
   * Ê∏ÖÈô§ÊêúÁ¥¢ÊñáÊú¨
   */
  private clearSearchText() {
    this.searchText = '';
    this.filteredSources = [...this.playSources];
  }
  
  /**
   * ÂàáÊç¢Êí≠Êîæ/ÊöÇÂÅú
   */
  private togglePlayPause(): void {
    try {
      if (this.isPlaying) {
        playbackService.pause().catch((error) => {
          Logger.error(this.TAG, `Failed to pause playback: ${error}`);
        });
      } else {
        playbackService.play().catch((error) => {
          Logger.error(this.TAG, `Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` : new Error(String(`Failed to play: ${error}` instanceof Error ? `Failed to play: ${error}` : new Error(String(`Failed to play: ${error}`)))))));
        });
      }
      
      this.showControls = true;
      this.restartControlsTimeout();
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle play/pause: ${error}`);
    }
  }
  
  /**
   * Â§ÑÁêÜËøõÂ∫¶Êù°ÂèòÂå?   */
  private handleProgressChange(value: number): void {
    try {
      const seekTime = (value / 100) * this.duration;
      playbackService.seekTo(seekTime).then(() => {
        this.showControls = true;
        this.restartControlsTimeout();
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}` instanceof Error ? `Failed to seek: ${error}` : new Error(String(`Failed to seek: ${error}`)))))));
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to seek: ${error}`);
    }
  }
  
  /**
   * Â§ÑÁêÜÈü≥ÈáèÂèòÂåñ
   */
  private handleVolumeChange(value: number): void {
    try {
      this.volume = value;
      if (this.isMuted && value > 0) {
        this.isMuted = false;
      }
      playbackService.setVolume(value).catch((error) => {
        Logger.error(this.TAG, `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}`)))))));
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to set volume: ${error}`);
    }
  }
  
  /**
   * ÂàáÊç¢ÈùôÈü≥
   */
  private toggleMute(): void {
    try {
      const newMuteState = !this.isMuted;
      playbackService.setMuted(newMuteState).then(() => {
        this.isMuted = newMuteState;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}` instanceof Error ? `Failed to toggle mute: ${error}` : new Error(String(`Failed to toggle mute: ${error}`)))))));
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle mute: ${error}`);
    }
  }
  
  /**
   * ËÆæÁΩÆÊí≠ÊîæÈÄüÂ∫¶
   */
  private setPlaybackSpeed(speed: PlaybackSpeed): void {
    try {
      this.playbackSpeed = speed;
      playbackService.setPlaybackSpeed(speed).then(() => {
        this.showSpeedMenu = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}` instanceof Error ? `Failed to set playback speed: ${error}` : new Error(String(`Failed to set playback speed: ${error}`)))))));
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to set playback speed: ${error}`);
    }
  }
  
  /**
   * ‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
   */
  private savePlayProgress(position: number): void {
    if (!this.mediaId || !this.siteKey || !this.episodeId) return;
    
    try {
      const duration = this.totalTime || this.duration;
      
      // ‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶Âà∞ÂéÜÂè≤ËÆ∞ÂΩ?      historyService.saveWatchProgress(
        this.mediaId, this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
       instanceof Error ? this.siteKey,
        this.episodeId,
        position,
        duration
       : new Error(String(this.siteKey,
        this.episodeId,
        position,
        duration
      ))))))).then(() => {
        Logger.info(this.TAG, `Saved playback progress: ${position}ms of ${duration}ms`);
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to save play progress: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}` instanceof Error ? `Failed to save play progress: ${error}` : new Error(String(`Failed to save play progress: ${error}`)))))));
    }
  }
  
  /**
   * Â§ÑÁêÜÊí≠ÊîæÈîôËØØÔºåÂ∞ùËØïÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™ÂèØÁî®ÁâáÊ∫?   */
  private handlePlaybackError(error: Error): void {
    if (!this.playSources || this.playSources.length <= 1) {
      this.errorMessage = 'Êí≠ÊîæÂ§±Ë¥•ÔºåÊöÇÊó†ÂèØÁî®Â§áÁî®ÁâáÊ∫?;
      this.isLoading = false;
      return;
    }
    
    // Êü•ÊâæÂΩìÂâçÁâáÊ∫êÁöÑÁ¥¢Âº?    const currentIndex = this.playSources.findIndex(s => 
      s.id === this.playSource?.id || 
      (s.name === this.playSource?.name && s.url === this.playSource?.url)
    );
    
    // ÈÄâÊã©‰∏ã‰∏Ä‰∏™ÂèØÁî®ÁöÑÁâáÊ∫ê
    let nextIndex = (currentIndex + 1) % this.playSources.length;
    
    if (currentIndex !== -1) {
      Logger.info(this.TAG, `Â∞ùËØïÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™ÁâáÊ∫? ${nextIndex}ÔºåÂéüÁâáÊ∫ê: ${currentIndex}`);
      
      // ÊòæÁ§∫ÂàáÊç¢ÊèêÁ§∫
      this.errorMessage = `ÂΩìÂâçÁâáÊ∫êÊí≠ÊîæÂ§±Ë¥•ÔºåÊ≠£Âú®Â∞ùËØïÂàáÊç¢Âà∞Â§áÁî®ÁâáÊ∫ê(${nextIndex + 1}/${this.playSources.length})...`;
      
      // ‰øùÂ≠òÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
      const currentPosition = this.currentPosition;
      
      // ÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™ÁâáÊ∫?      this.initialPosition = currentPosition; // ‰øùÊåÅÁõ∏ÂêåÁöÑÊí≠Êîæ‰ΩçÁΩ?      this.setupPlayback(this.playSources[nextIndex]);
      this.errorMessage = '';
    } else {
      this.errorMessage = 'Êí≠ÊîæÂ§±Ë¥•ÔºåÊó†Ê≥ïËØÜÂà´ÂΩìÂâçÁâáÊ∫?;
      this.isLoading = false;
    }
  }
  
  /**
   * ÂàáÊç¢Êí≠ÊîæÊ∫?   */
  private switchPlaySource(source: PlaySource): void {
    try {
      this.isLoading = true;
      this.playbackState = PlaybackState.BUFFERING;
      
      // ‰øùÂ≠òÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
      const currentPosition = this.currentPosition;
      
      // ËÆæÁΩÆÊñ∞ÁöÑÊí≠ÊîæÊ∫?      this.setupPlayback(source);
      
      // ÊÅ¢Â§çÊí≠Êîæ‰ΩçÁΩÆ
      if (currentPosition > 0) {
        playbackService.seek(currentPosition).catch((error) => {
          Logger.error(this.TAG, `Failed to seek to position after switching source: ${error}`);
        });
      }
      
      this.isLoading = false;
      this.showSourceMenu = false;
      
      // ÊòæÁ§∫ÂàáÊç¢ÊàêÂäüÊèêÁ§∫
      Toast.show('ÁâáÊ∫êÂàáÊç¢ÊàêÂäü');
    } catch (error) {
      Logger.error(this.TAG, `Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}` instanceof Error ? `Failed to switch play source: ${error}` : new Error(String(`Failed to switch play source: ${error}`)))))));
      this.errorMessage = 'ÂàáÊç¢Êí≠ÊîæÊ∫êÂ§±Ë¥?;
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
    }
  }
  
  /**
   * ÂàáÊç¢ÂÖ®Â±è
   */
  private toggleFullscreen(): void {
    this.isFullscreen = !this.isFullscreen;
    // ËøôÈáåÈúÄË¶ÅÂ§ÑÁêÜÂÆûÈôÖÁöÑÂÖ®Â±èÈÄªËæëÔºåÂèØËÉΩÈúÄË¶ÅË∞ÉÁî®Á≥ªÁªüAPI
    Logger.info(this.TAG, `Fullscreen mode: ${this.isFullscreen}`);
  }
  
  /**
   * Â§ÑÁêÜËøîÂõû
   */
  private handleBack(): void {
    // ÂÖà‰øùÂ≠òËøõÂ∫?    this.savePlaybackProgress();
    this.context.router.back();
  }
  
  /**
   * Â§ÑÁêÜÂ±èÂπïÁÇπÂáª
   */
  private handleScreenTap(): void {
    this.showControls = !this.showControls;
    if (this.showControls) {
      this.restartControlsTimeout();
    } else {
      this.stopControlsTimeout();
    }
  }
  
  /**
   * ÂºÄÂßãÊéßÂà∂Ê†èË∂ÖÊó∂ÈöêËóè
   */
  private startControlsTimeout(): void {
    this.stopControlsTimeout();
    this.controlsTimeout = setTimeout(() => {
      if (this.isPlaying && this.playbackState !== PlaybackState.ERROR) {
        this.showControls = false;
      }
    }, 3000); // 3ÁßíÂêéÈöêËóè
  }
  
  /**
   * ÈáçÊñ∞ÂºÄÂßãÊéßÂà∂Ê†èË∂ÖÊó∂
   */
  private restartControlsTimeout(): void {
    this.startControlsTimeout();
  }
  
  /**
   * ÂÅúÊ≠¢ÊéßÂà∂Ê†èË∂ÖÊó?   */
  private stopControlsTimeout(): void {
    if (this.controlsTimeout) {
      clearTimeout(this.controlsTimeout);
      this.controlsTimeout = null;
    }
  }
  
  /**
   * ÈáäÊîæÊí≠ÊîæÂô®ËµÑÊ∫?   */
  private releasePlayer(): void {
    try {
      // ‰øùÂ≠òÂΩìÂâçÊí≠ÊîæËøõÂ∫¶
      this.savePlaybackProgress();
      
      // ÁßªÈô§Êí≠ÊîæÁõëÂê¨Âô?      playbackService.removeAllListeners();
      
      // ÈáäÊîæÊí≠ÊîæÂô®ËµÑÊ∫?      playbackService.release().catch((error) => {
        Logger.error(this.TAG, `Failed to release player: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}` instanceof Error ? `Failed to release player: ${error}` : new Error(String(`Failed to release player: ${error}`)))))));
    }
  }
  
  /**
   * Ê†ºÂºèÂåñÊó∂Èó?   */
  private formatTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }
  
  /**
   * Ê∏≤ÊüìÂä†ËΩΩÁä∂ÊÄ?   */
  @Builder
  private renderLoading(): void {
    Stack({ className: "loading-overlay" }) {
      LoadingProgress({ className: "loading-progress", color: "#FF4500" })
      Text("Ê≠£Âú®Âä†ËΩΩ...").className("loading-text")
      if (this.bufferPercentage > 0) {
        Text(`Â∑≤ÁºìÂÜ?${this.bufferPercentage}%`).className("buffer-text")
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÈîôËØØÁä∂ÊÄ?   */
  @Builder
  private renderError(): void {
    Stack({ className: "error-overlay" }) {
      Text("‚ö†Ô∏è").className("error-icon")
      Text(this.errorMessage).className("error-message")
      Button({ className: "retry-button", onClick: () => this.initializePlayback() }) {
        Text("ÈáçËØï")
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÈ°∂ÈÉ®ÊéßÂà∂Ê†?   */
  @Builder
  private renderTopControls(): void {
    Stack({ className: "top-controls" }) {
      Button({ className: "back-button", onClick: this.handleBack }) {
        Text("‚Ü?ËøîÂõû")
      }
      Stack({ className: "title-container" }) {
        Text(this.mediaTitle).className("media-title").numberOfLines(1)
        if (this.episodeName) {
          Text(this.episodeName).className("episode-name").numberOfLines(1)
        }
      }
      Button({ className: "settings-button", onClick: () => this.showSpeedMenu = !this.showSpeedMenu }) {
        Text(`${this.playbackSpeed}x`)
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂ∫ïÈÉ®ÊéßÂà∂Ê†?   */
  @Builder
  private renderBottomControls(): void {
    Stack({ className: "bottom-controls" }) {
      Button({ className: "play-pause-button", onClick: this.togglePlayPause }) {
        Text(this.isPlaying ? '‚è? : '‚ñ?)
      }
      
      Stack({ className: "progress-container" }) {
        Slider({ 
          className: "progress-slider",
          value: (this.currentTime / this.duration) * 100 || 0,
          min: 0,
          max: 100,
          onChange: this.handleProgressChange 
        })
        Flex({ className: "time-display" }) {
          Text(this.formatTime(this.currentTime)).className("current-time")
          Text(this.formatTime(this.duration)).className("duration")
        }
      }
      
      Button({ className: "mute-button", onClick: this.toggleMute }) {
        Text(this.isMuted ? 'üîá' : 'üîä')
      }
      
      Stack({ className: "volume-container" }) {
        Slider({ 
          className: "volume-slider",
          value: this.volume * 100,
          min: 0,
          max: 100,
          onChange: this.handleVolumeChange 
        })
      }
      
      Button({ className: "source-button", onClick: () => this.showSourceMenu = !this.showSourceMenu }) {
        Text("Ê∫?)
      }
      
      Button({ className: "fullscreen-button", onClick: this.toggleFullscreen }) {
        Text(this.isFullscreen ? '‚§? : '‚§?)
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÊí≠ÊîæÈÄüÂ∫¶ËèúÂçï
   */
  @Builder
  private renderSpeedMenu(): void {
    if (!this.showSpeedMenu) return;
    
    Stack({ className: "speed-menu" }) {
      playbackService.getSupportedPlaybackSpeeds().forEach((speed) => {
        Button({ 
          key: speed.toString(),
          className: `speed-option ${this.playbackSpeed === speed ? 'selected' : ''}`,
          onClick: () => this.setPlaybackSpeed(speed) 
        }) {
          Text(playbackService.getPlaybackSpeedText(speed))
        }
      })
    }
  }
  
  /**
   * Ê∏≤ÊüìÊí≠ÊîæÊ∫êËèúÂç?   */
  @Builder
  private renderSourceMenu(): void {
    if (!this.showSourceMenu) return;
    
    Stack({
      style: {
        position: 'absolute',
        bottom: 0,
        left: 0,
        right: 0,
        backgroundColor: '#4CAF50',
        height: '80%',
        borderTopLeftRadius: 20,
        borderTopRightRadius: 20,
        padding: 20,
        zIndex: 1000
      }
    }) {
      // ËèúÂçïÊ†áÈ¢ò
      Flex({
        style: {
          flexDirection: 'row',
          alignItems: 'center',
          justifyContent: 'space-between',
          marginBottom: 20
        }
      }) {
        Text('ÂàáÊç¢ÁâáÊ∫ê')
          .fontSize(28)
          .fontColor('#FFFFFF')
          .fontWeight(700)
        Button({
          style: {
            backgroundColor: 'transparent'
          },
          onClick: () => this.showSourceMenu = false
        }) {
          Text('‚ú?)
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
      }
    
      // ÊêúÁ¥¢Ê°?      Stack({
        style: {
          flexDirection: 'row',
          alignItems: 'center',
          backgroundColor: '#FFFFFF',
          borderRadius: 25,
          paddingHorizontal: 20,
          marginBottom: 20,
          height: 50
        }
      }) {
        Text('üîç')
          .fontSize(24)
          .fontColor('#999999')
          .margin({ right: 10 })
        TextInput({
          style: {
            flex: 1,
            fontSize: 24,
            color: '#333333'
          },
          value: this.searchText,
          onChange: (text) => this.handleSearchChange(text),
          onFocusChange: (focused) => this.handleSearchFocusChange(focused),
          placeholder: 'ÊêúÁ¥¢ÁâáÊ∫ê...',
          placeholderColor: '#999999'
        })
        if (this.searchText.length > 0) {
          Button({
            style: {
              backgroundColor: 'transparent'
            },
            onClick: () => this.clearSearchText()
          }) {
            Text('‚ú?)
          .fontSize(24)
          .fontColor('#999999')
          }
        }
      }
      
      // ÊêúÁ¥¢ÁªìÊûúÊï∞ÈáèÊèêÁ§∫
      Text(`ÂÖ±ÊâæÂà?${this.filteredSources.length} ‰∏™ÁâáÊ∫ê`)
        .fontSize(24)
        .fontColor('#FFFFFF')
        .fontWeight(600)
        .margin({ bottom: 10 })
    
      // ÁâáÊ∫êÂàóË°®
      List({
        style: {
          flex: 1,
          backgroundColor: 'transparent'
        },
        divider: {
          strokeWidth: 1,
          color: '#FFFFFF',
          startMargin: 0,
          endMargin: 0
        }
      }) {
        this.filteredSources.forEach((source, index) => {
          ListItem({
            key: source.id,
            style: {
              backgroundColor: this.playSource?.id === source.id ? '#FFFFFF' : 'transparent',
              borderRadius: 10,
              marginBottom: 10,
              padding: 15
            },
            onClick: () => this.switchPlaySource(source)
          }) {
            Flex({
              style: {
                flexDirection: 'row',
                alignItems: 'center',
                justifyContent: 'space-between'
              }
            }) {
              // ÁâáÊ∫ê‰ø°ÊÅØ
              Flex({
                style: {
                  flexDirection: 'column',
                  alignItems: 'flex-start',
                  flex: 1
                }
              }) {
                Text(source.name || `Êí≠ÊîæÊ∫?{index + 1}`)
                  .fontSize(26)
                  .fontColor(this.playSource?.id === source.id ? '#4CAF50' : '#FFFFFF')
                  .fontWeight(600)
                  .margin({ bottom: 5 })
                Text(source.url)
                  .fontSize(22)
                  .fontColor(this.playSource?.id === source.id ? '#666666' : '#CCCCCC')
              }
              
              // Ë¥®ÈáèÊ†áÁ≠æ
              if (source.quality) {
                Flex({
                  style: {
                    backgroundColor: '#FFEB3B',
                    paddingHorizontal: 12,
                    paddingVertical: 4,
                    borderRadius: 12
                  }
                }) {
                  Text(source.quality)
                    .fontSize(20)
                    .fontColor('#000000')
                    .fontWeight(700)
                }
              }
              
              // ÈÄâ‰∏≠Ê†áËÆ∞
              if (this.playSource?.id === source.id) {
                Text('‚ú?)
                  .fontSize(24)
                  .fontColor('#4CAF50')
              }
            }
          }
        }
    }
  }
  
  /**
   * ÁªÑ‰ª∂Ê∏≤Êüì
   */
  build() {
    Stack({ className: `playback-page ${this.isFullscreen ? 'fullscreen' : ''}`, onClick: this.handleScreenTap }) {
      // ËßÜÈ¢ëÊí≠ÊîæÂå∫Âüü
      Stack({ className: "video-container" }) {
        // ËøôÈáåÂ∫îËØ•‰ΩøÁî®ÂÆûÈôÖÁöÑËßÜÈ¢ëÊí≠ÊîæÂô®ÁªÑ‰ª∂
        // Áî±‰∫éHarmonyOSÁöÑVideoÁªÑ‰ª∂ÂÖ∑‰ΩìAPIÂèØËÉΩ‰∏çÂêåÔºåËøôÈáåÁî®Âç†‰ΩçÁ¨¶Ë°®Á§?        Image("https://via.placeholder.com/1920x1080?text=Video+Player")
          .className("video-placeholder")
          .objectFit("cover")
        
        // Âä†ËΩΩÁä∂ÊÄ?        if (this.isLoading) {
          this.renderLoading();
        }
        
        // ÈîôËØØÁä∂ÊÄ?        if (this.errorMessage) {
          this.renderError();
        }
        
        // Êí≠ÊîæÊéßÂà∂ÁïåÈù¢
        if (this.showControls) {
          Stack({ className: "controls-overlay" }) {
            this.renderTopControls();
            this.renderBottomControls();
          }
        }
        
        // Êí≠ÊîæÈÄüÂ∫¶ËèúÂçï
        this.renderSpeedMenu();
        
        // Êí≠ÊîæÊ∫êËèúÂç?        this.renderSourceMenu();
      }
    }
  }
}

export default PlaybackPage;


