import { Stack, Video, Image, Text, Button, Slider, List, ListItem, LoadingProgress, Toast, PromptAction } from '@kit.ArkUI';
import Router from '@ohos.router';
import Logger from '../common/util/Logger';
import { playbackService } from '../service/media/PlaybackService';
import { historyService } from '../service/media/HistoryService';
import { mediaService } from '../service/media/MediaService';
import { configService } from '../service/config/ConfigService';
import { PlaybackState, PlaybackSpeed, PlaySource, Subtitle } from '../service/media/PlaybackService';

/**
 * æ’­æ”¾é¡µé¢ç»„ä»¶
 * å®ç°è§†é¢‘æ’­æ”¾æ§åˆ¶ç•Œé¢ï¼ŒåŒ…å«æ’­æ”¾/æš‚åœã€è¿›åº¦æ§åˆ¶ã€éŸ³é‡æ§åˆ¶ã€é€Ÿåº¦è°ƒæ•´ç­‰åŠŸèƒ½
 */
@Component
struct PlaybackPage {
  private readonly TAG: string = 'PlaybackPage';
  
  // è·¯ç”±å‚æ•°
  private mediaId: string = '';
  private siteKey: string = '';
  private episodeId?: string;
  private initialPosition: number = 0;
  private mediaTitle: string = '';
  private episodeName: string = '';
  private playSource?: PlaySource;
  private playSourceIndex: number = 0;
  
  // çŠ¶æ€ç®¡ç†
  @State playbackState: PlaybackState = PlaybackState.IDLE;
  @State currentTime: number = 0;
  @State duration: number = 0;
  @State isPlaying: boolean = false;
  @State volume: number = 1.0;
  @State isMuted: boolean = false;
  @State playbackSpeed: PlaybackSpeed = PlaybackSpeed.NORMAL;
  @State isBuffering: boolean = false;
  @State bufferPercentage: number = 0;
  @State showControls: boolean = true;
  @State showSpeedMenu: boolean = false;
  @State showSourceMenu: boolean = false;
  @State showSubtitleMenu: boolean = false;
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State searchText: string = '';
  @State subtitles: Subtitle[] = [];
  @State selectedSubtitle: Subtitle | null = null;
  @State isFullscreen: boolean = false;
  @State errorMessage: string = '';
  @State isLoading: boolean = true;
  @State controlsTimeout: number | null = null;
  @State lastProgressSaveTime: number = 0;
  @State saveProgressInterval: number = 30000; // 30ç§’ä¿å­˜ä¸€æ¬¡è¿›åº¦
  @State searchFocused: boolean = false;
  private autoSwitchSourceOnError: boolean = true; // æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢ç‰‡æº
  private lastSaveTime: number = 0; // ä¸Šæ¬¡ä¿å­˜è¿›åº¦çš„æ—¶é—´(æ¯«ç§’)
  private currentPosition: number = 0; // å½“å‰æ’­æ”¾ä½ç½®
  private totalTime: number = 0;
  
  // åˆå§‹åŒ–
  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒç”¨
   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'PlaybackPage appeared');
    
    // è·å–è·¯ç”±å‚æ•°
    const params = this.context.router.getParams();
    this.mediaId = (params?.mediaId as string) || '';
    this.siteKey = (params?.siteKey as string) || '';
    this.episodeId = params?.episodeId;
    this.initialPosition = (params?.currentTime as number) || (params?.startPosition as number) || 0;
    this.mediaTitle = (params?.mediaTitle as string) || 'æ­£åœ¨æ’­æ”¾';
    this.episodeName = (params?.episodeName as string) || '';
    this.playSource = params?.playSource;
    this.playSourceIndex = (params?.playSourceIndex as number) || 0;
    this.autoSwitchSourceOnError = params?.autoSwitchSourceOnError !== false; // é»˜è®¤å¼€å¯
    
    Logger.info(this.TAG, `Starting playback for: ${this.siteKey}:${this.mediaId}${this.episodeId ? ` episode: ${this.episodeId}` : ''}, startPosition=${this.initialPosition}`);
    
    // åˆå§‹åŒ–æ’­æ”¾å™¨
    this.initializePlayback();
    
    // è®¾ç½®æ§åˆ¶æ è‡ªåŠ¨éšè—
    this.startControlsTimeout();
  }
  
  /**
     * é¡µé¢å¸è½½æ—¶è°ƒç”¨
     */
    aboutToDisappear(): void {
      Logger.info(this.TAG, 'PlaybackPage disappeared');
      this.cleanupPlayer();
    }

    /**
     * æ¸…ç†æ’­æ”¾å™¨èµ„æº
     */
    private cleanupPlayer(): void {
      // ç§»é™¤æ’­æ”¾ç›‘å¬å™¨
      playbackService.removeAllListeners();
      
      // ä¿å­˜æœ€ç»ˆæ’­æ”¾è¿›åº¦
    this.savePlayProgress(this.currentPosition);
    
    // åœæ­¢æ§åˆ¶æ è¶…æ—¶
    this.stopControlsTimeout();
    
    // é‡Šæ”¾æ’­æ”¾å™¨èµ„æº
    this.releasePlayer();
    playbackService.stop();
    playbackService.destroy();
  }
  
  /**
   * åˆå§‹åŒ–æ’­æ”¾
   */
  private initializePlayback(): void {
    if (!this.mediaId || !this.siteKey) {
      this.errorMessage = 'ç¼ºå°‘å¿…è¦å‚æ•°';
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
      return;
    }
    
    try {
      // åŠ è½½æ’­æ”¾æº
      this.loadPlaySources().then(() => {
        // åˆå§‹åŒ–è¿‡æ»¤åçš„ç‰‡æºåˆ—è¡¨
        this.filteredSources = [...this.playSources];
        
        // è®¾ç½®æ’­æ”¾æºå¹¶å¼€å§‹æ’­æ”¾
        if (this.playSource) {
          this.setupPlayback(this.playSource);
        } else if (this.playSources.length > 0 && this.playSourceIndex < this.playSources.length) {
          this.setupPlayback(this.playSources[this.playSourceIndex]);
        } else {
          this.errorMessage = 'æ— å¯ç”¨æ’­æ”¾æº';
          this.isLoading = false;
          this.playbackState = PlaybackState.ERROR;
        }
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to initialize playback: ${error}`);
        this.errorMessage = 'æ’­æ”¾åˆå§‹åŒ–å¤±è´¥';
        this.isLoading = false;
        this.playbackState = PlaybackState.ERROR;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize playback: ${error}`);
      this.errorMessage = 'æ’­æ”¾åˆå§‹åŒ–å¤±è´¥';
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
    }
  }
  
  /**
   * åŠ è½½æ’­æ”¾æº
   */
  private loadPlaySources(): Promise<void> {
    return new Promise<void>((resolve, reject) => {
      try {
        // å¦‚æœæ²¡æœ‰ä¼ å…¥æ’­æ”¾æºï¼Œåˆ™ä»æœåŠ¡è·å–
        if (!this.playSource || this.playSources.length === 0) {
          mediaService.getPlaySources(
            this.mediaId,
            this.siteKey,
            this.episodeId
          ).then((sources) => {
            this.playSources = sources;
            Logger.info(this.TAG, `Loaded ${this.playSources.length} play sources`);
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªæ’­æ”¾æºï¼Œåˆ™ä½¿ç”¨å®ƒ
            if (this.playSources.length === 1 && !this.playSource) {
              this.playSource = this.playSources[0];
            }
            resolve();
          }).catch((error) => {
            Logger.error(this.TAG, `Failed to load play sources: ${error}`);
            reject(error);
          });
        } else {
          resolve();
        }
      } catch (error) {
        Logger.error(this.TAG, `Failed to load play sources: ${error}`);
        reject(error);
      }
    });
  }
  
  /**
   * è®¾ç½®æ’­æ”¾
   */
  private setupPlayback(source: PlaySource): void {
    try {
      // æ·»åŠ æ’­æ”¾ç›‘å¬å™¨
      this.addPlaybackListeners();
      
      // è®¾ç½®æ’­æ”¾æº
      playbackService.setSource(source, {
        autoPlay: true,
        startPosition: this.initialPosition,
        volume: this.volume,
        isMuted: this.isMuted,
        playbackSpeed: this.playbackSpeed
      }).then(() => {
        this.playSource = source;
        this.isLoading = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to setup playback: ${error}`);
        
        // å°è¯•è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡æº
        if (this.autoSwitchSourceOnError) {
          this.handlePlaybackError(error);
        } else {
          this.errorMessage = 'æ’­æ”¾è®¾ç½®å¤±è´¥';
          this.isLoading = false;
          this.playbackState = PlaybackState.ERROR;
        }
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to setup playback: ${error}`);
      
      // å°è¯•è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡æº
      if (this.autoSwitchSourceOnError) {
        this.handlePlaybackError(error);
      } else {
        this.errorMessage = 'æ’­æ”¾è®¾ç½®å¤±è´¥';
        this.isLoading = false;
        this.playbackState = PlaybackState.ERROR;
      }
    }
  }
  
  /**
   * æ·»åŠ æ’­æ”¾ç›‘å¬å™¨
   */
  private addPlaybackListeners(): void {
    playbackService.addListener({
      onStateChanged: (state) => {
        this.playbackState = state;
        this.isPlaying = state === PlaybackState.PLAYING;
        
        if (state === PlaybackState.COMPLETED) {
          this.handlePlaybackCompleted();
        } else if (state === PlaybackState.ERROR) {
          this.errorMessage = 'æ’­æ”¾å‡ºé”™';
        }
        
        this.showControls = true;
        this.restartControlsTimeout();
      },
      
      onError: (error: Error) => {
        Logger.error(this.TAG, `Playback error: ${error}`);
        
        // å°è¯•è‡ªåŠ¨åˆ‡æ¢ç‰‡æº
        if (this.autoSwitchSourceOnError) {
          this.handlePlaybackError(error);
        } else {
          this.errorMessage = `æ’­æ”¾é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
        }
      },
      
      // å®šæœŸä¿å­˜æ’­æ”¾è¿›åº¦
      onTimeUpdate: (currentTime, duration) => {
        this.currentTime = currentTime;
        this.currentPosition = currentTime;
        this.duration = duration;
        this.totalTime = duration || this.totalTime;
        
        // æ¯10ç§’ä¿å­˜ä¸€æ¬¡æ’­æ”¾è¿›åº¦
        if (this.lastSaveTime === 0 || currentTime - this.lastSaveTime > 10000) {
          this.savePlayProgress(currentTime);
          this.lastSaveTime = currentTime;
        }
      },
      
      onCompleted: () => {
        Logger.info(this.TAG, 'Playback completed');
      },
      
      onBufferUpdate: (bufferPercentage) => {
        this.bufferPercentage = bufferPercentage;
      },
      
      onSeekCompleted: (seekTime) => {
        Logger.info(this.TAG, `Seek completed to ${seekTime}s`);
      }
    });
  }
  
  /**
   * å¤„ç†æ’­æ”¾å®Œæˆ
   */
  private handlePlaybackCompleted(): void {
    try {
      // ä¿å­˜å®Œæˆçš„æ’­æ”¾çŠ¶æ€
      historyService.updateProgress(
        this.mediaId,
        this.siteKey,
        this.duration, // æ ‡è®°ä¸ºå·²å®Œæˆ
        this.episodeId,
        true // æ ‡è®°ä¸ºå·²å®Œæˆ
      ).then(() => {
        Toast.show('æ’­æ”¾å®Œæˆ');
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to handle playback completed: ${error}`);
        Toast.show('æ’­æ”¾å®Œæˆ');
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle playback completed: ${error}`);
      Toast.show('æ’­æ”¾å®Œæˆ');
    }
  }
  
  /**
   * ä¿å­˜æ’­æ”¾è¿›åº¦
   */
  private savePlaybackProgress(): void {
    try {
      playbackService.savePlaybackPosition(
        this.mediaId,
        this.siteKey,
        this.episodeId
      ).catch((error) => {
        Logger.error(this.TAG, `Failed to save playback progress: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save playback progress: ${error}`);
    }
  }
  
  /**
   * å¤„ç†æœç´¢æ–‡æœ¬å˜åŒ–
   */
  private handleSearchChange(text: string) {
    this.searchText = text;
    
    // æ ¹æ®æœç´¢æ–‡æœ¬è¿‡æ»¤ç‰‡æº
    if (text.trim()) {
      const searchLower = text.toLowerCase();
      this.filteredSources = this.playSources.filter(source => 
        (source.name && source.name.toLowerCase().includes(searchLower)) ||
        (source.description && source.description.toLowerCase().includes(searchLower))
      );
    } else {
      // å¦‚æœæœç´¢æ–‡æœ¬ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç‰‡æº
      this.filteredSources = [...this.playSources];
    }
  }
  
  /**
   * å¤„ç†æœç´¢æ¡†ç„¦ç‚¹å˜åŒ–
   */
  private handleSearchFocusChange(focused: boolean) {
    this.searchFocused = focused;
  }
  
  /**
   * æ¸…é™¤æœç´¢æ–‡æœ¬
   */
  private clearSearchText() {
    this.searchText = '';
    this.filteredSources = [...this.playSources];
  }
  
  /**
   * åˆ‡æ¢æ’­æ”¾/æš‚åœ
   */
  private togglePlayPause(): void {
    try {
      if (this.isPlaying) {
        playbackService.pause().catch((error) => {
          Logger.error(this.TAG, `Failed to pause playback: ${error}`);
        });
      } else {
        playbackService.play().catch((error) => {
          Logger.error(this.TAG, `Failed to play: ${error}`);
        });
      }
      
      this.showControls = true;
      this.restartControlsTimeout();
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle play/pause: ${error}`);
    }
  }
  
  /**
   * å¤„ç†è¿›åº¦æ¡å˜åŒ–
   */
  private handleProgressChange(value: number): void {
    try {
      const seekTime = (value / 100) * this.duration;
      playbackService.seekTo(seekTime).then(() => {
        this.showControls = true;
        this.restartControlsTimeout();
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to seek: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to seek: ${error}`);
    }
  }
  
  /**
   * å¤„ç†éŸ³é‡å˜åŒ–
   */
  private handleVolumeChange(value: number): void {
    try {
      this.volume = value;
      if (this.isMuted && value > 0) {
        this.isMuted = false;
      }
      playbackService.setVolume(value).catch((error) => {
        Logger.error(this.TAG, `Failed to set volume: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to set volume: ${error}`);
    }
  }
  
  /**
   * åˆ‡æ¢é™éŸ³
   */
  private toggleMute(): void {
    try {
      const newMuteState = !this.isMuted;
      playbackService.setMuted(newMuteState).then(() => {
        this.isMuted = newMuteState;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to toggle mute: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle mute: ${error}`);
    }
  }
  
  /**
   * è®¾ç½®æ’­æ”¾é€Ÿåº¦
   */
  private setPlaybackSpeed(speed: PlaybackSpeed): void {
    try {
      this.playbackSpeed = speed;
      playbackService.setPlaybackSpeed(speed).then(() => {
        this.showSpeedMenu = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to set playback speed: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to set playback speed: ${error}`);
    }
  }
  
  /**
   * ä¿å­˜æ’­æ”¾è¿›åº¦
   */
  private savePlayProgress(position: number): void {
    if (!this.mediaId || !this.siteKey || !this.episodeId) return;
    
    try {
      const duration = this.totalTime || this.duration;
      
      // ä¿å­˜æ’­æ”¾è¿›åº¦åˆ°å†å²è®°å½•
      historyService.saveWatchProgress(
        this.mediaId,
        this.siteKey,
        this.episodeId,
        position,
        duration
      ).then(() => {
        Logger.info(this.TAG, `Saved playback progress: ${position}ms of ${duration}ms`);
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to save play progress: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save play progress: ${error}`);
    }
  }
  
  /**
   * å¤„ç†æ’­æ”¾é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨ç‰‡æº
   */
  private handlePlaybackError(error: Error): void {
    if (!this.playSources || this.playSources.length <= 1) {
      this.errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œæš‚æ— å¯ç”¨å¤‡ç”¨ç‰‡æº';
      this.isLoading = false;
      return;
    }
    
    // æŸ¥æ‰¾å½“å‰ç‰‡æºçš„ç´¢å¼•
    const currentIndex = this.playSources.findIndex(s => 
      s.id === this.playSource?.id || 
      (s.name === this.playSource?.name && s.url === this.playSource?.url)
    );
    
    // é€‰æ‹©ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç‰‡æº
    let nextIndex = (currentIndex + 1) % this.playSources.length;
    
    if (currentIndex !== -1) {
      Logger.info(this.TAG, `å°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡æº: ${nextIndex}ï¼ŒåŸç‰‡æº: ${currentIndex}`);
      
      // æ˜¾ç¤ºåˆ‡æ¢æç¤º
      this.errorMessage = `å½“å‰ç‰‡æºæ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨å°è¯•åˆ‡æ¢åˆ°å¤‡ç”¨ç‰‡æº(${nextIndex + 1}/${this.playSources.length})...`;
      
      // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
      const currentPosition = this.currentPosition;
      
      // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡æº
      this.initialPosition = currentPosition; // ä¿æŒç›¸åŒçš„æ’­æ”¾ä½ç½®
      this.setupPlayback(this.playSources[nextIndex]);
      this.errorMessage = '';
    } else {
      this.errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œæ— æ³•è¯†åˆ«å½“å‰ç‰‡æº';
      this.isLoading = false;
    }
  }
  
  /**
   * åˆ‡æ¢æ’­æ”¾æº
   */
  private switchPlaySource(source: PlaySource): void {
    try {
      this.isLoading = true;
      this.playbackState = PlaybackState.BUFFERING;
      
      // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
      const currentPosition = this.currentPosition;
      
      // è®¾ç½®æ–°çš„æ’­æ”¾æº
      this.setupPlayback(source);
      
      // æ¢å¤æ’­æ”¾ä½ç½®
      if (currentPosition > 0) {
        playbackService.seek(currentPosition).catch((error) => {
          Logger.error(this.TAG, `Failed to seek to position after switching source: ${error}`);
        });
      }
      
      this.isLoading = false;
      this.showSourceMenu = false;
      
      // æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸæç¤º
      Toast.show('ç‰‡æºåˆ‡æ¢æˆåŠŸ');
    } catch (error) {
      Logger.error(this.TAG, `Failed to switch play source: ${error}`);
      this.errorMessage = 'åˆ‡æ¢æ’­æ”¾æºå¤±è´¥';
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
    }
  }
  
  /**
   * åˆ‡æ¢å…¨å±
   */
  private toggleFullscreen(): void {
    this.isFullscreen = !this.isFullscreen;
    // è¿™é‡Œéœ€è¦å¤„ç†å®é™…çš„å…¨å±é€»è¾‘ï¼Œå¯èƒ½éœ€è¦è°ƒç”¨ç³»ç»ŸAPI
    Logger.info(this.TAG, `Fullscreen mode: ${this.isFullscreen}`);
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    // å…ˆä¿å­˜è¿›åº¦
    this.savePlaybackProgress();
    this.context.router.back();
  }
  
  /**
   * å¤„ç†å±å¹•ç‚¹å‡»
   */
  private handleScreenTap(): void {
    this.showControls = !this.showControls;
    if (this.showControls) {
      this.restartControlsTimeout();
    } else {
      this.stopControlsTimeout();
    }
  }
  
  /**
   * å¼€å§‹æ§åˆ¶æ è¶…æ—¶éšè—
   */
  private startControlsTimeout(): void {
    this.stopControlsTimeout();
    this.controlsTimeout = setTimeout(() => {
      if (this.isPlaying && this.playbackState !== PlaybackState.ERROR) {
        this.showControls = false;
      }
    }, 3000); // 3ç§’åéšè—
  }
  
  /**
   * é‡æ–°å¼€å§‹æ§åˆ¶æ è¶…æ—¶
   */
  private restartControlsTimeout(): void {
    this.startControlsTimeout();
  }
  
  /**
   * åœæ­¢æ§åˆ¶æ è¶…æ—¶
   */
  private stopControlsTimeout(): void {
    if (this.controlsTimeout) {
      clearTimeout(this.controlsTimeout);
      this.controlsTimeout = null;
    }
  }
  
  /**
   * é‡Šæ”¾æ’­æ”¾å™¨èµ„æº
   */
  private releasePlayer(): void {
    try {
      // ä¿å­˜å½“å‰æ’­æ”¾è¿›åº¦
      this.savePlaybackProgress();
      
      // ç§»é™¤æ’­æ”¾ç›‘å¬å™¨
      playbackService.removeAllListeners();
      
      // é‡Šæ”¾æ’­æ”¾å™¨èµ„æº
      playbackService.release().catch((error) => {
        Logger.error(this.TAG, `Failed to release player: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to release player: ${error}`);
    }
  }
  
  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€
   */
  @Builder
  private renderLoading(): void {
    Stack.create();
    Stack.className("loading-overlay");
    LoadingProgress.create();
    LoadingProgress.className("loading-progress");
    LoadingProgress.color("#FF4500");
    LoadingProgress.pop();
    Text.create();
    Text.className("loading-text");
    Text.content("æ­£åœ¨åŠ è½½...");
    Text.pop();
    if (this.bufferPercentage > 0) {
      Text.create();
      Text.className("buffer-text");
      Text.content(`å·²ç¼“å†² ${this.bufferPercentage}%`);
      Text.pop();
    }
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€
   */
  @Builder
  private renderError(): void {
    Stack.create();
    Stack.className("error-overlay");
    Text.create();
    Text.className("error-icon");
    Text.content("âš ï¸");
    Text.pop();
    Text.create();
    Text.className("error-message");
    Text.content(this.errorMessage);
    Text.pop();
    Button.create();
    Button.className("retry-button");
    Button.onClick(() => this.initializePlayback());
    Text.create();
    Text.content("é‡è¯•");
    Text.pop();
    Button.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“é¡¶éƒ¨æ§åˆ¶æ 
   */
  @Builder
  private renderTopControls(): void {
    Stack.create();
    Stack.className("top-controls");
    Button.create();
    Button.className("back-button");
    Button.onClick(this.handleBack);
    Text.create();
    Text.content("â† è¿”å›");
    Text.pop();
    Button.pop();
    Stack.create();
    Stack.className("title-container");
    Text.create();
    Text.className("media-title");
    Text.numberOfLines(1);
    Text.content(this.mediaTitle);
    Text.pop();
    if (this.episodeName) {
      Text.create();
      Text.className("episode-name");
      Text.numberOfLines(1);
      Text.content(this.episodeName);
      Text.pop();
    }
    Stack.pop();
    Button.create();
    Button.className("settings-button");
    Button.onClick(() => this.showSpeedMenu = !this.showSpeedMenu);
    Text.create();
    Text.content(`${this.playbackSpeed}x`);
    Text.pop();
    Button.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“åº•éƒ¨æ§åˆ¶æ 
   */
  @Builder
  private renderBottomControls(): void {
    Stack.create();
    Stack.className("bottom-controls");
    Button.create();
    Button.className("play-pause-button");
    Button.onClick(this.togglePlayPause);
    Text.create();
    Text.content(this.isPlaying ? 'â¸' : 'â–¶');
    Text.pop();
    Button.pop();
    
    Stack.create();
    Stack.className("progress-container");
    Slider.create();
    Slider.className("progress-slider");
    Slider.value((this.currentTime / this.duration) * 100 || 0);
    Slider.min(0);
    Slider.max(100);
    Slider.onChange(this.handleProgressChange);
    Slider.pop();
    Flex.create();
    Flex.className("time-display");
    Text.create();
    Text.className("current-time");
    Text.content(this.formatTime(this.currentTime));
    Text.pop();
    Text.create();
    Text.className("duration");
    Text.content(this.formatTime(this.duration));
    Text.pop();
    Flex.pop();
    Stack.pop();
    
    Button.create();
    Button.className("mute-button");
    Button.onClick(this.toggleMute);
    Text.create();
    Text.content(this.isMuted ? 'ğŸ”‡' : 'ğŸ”Š');
    Text.pop();
    Button.pop();
    
    Stack.create();
    Stack.className("volume-container");
    Slider.create();
    Slider.className("volume-slider");
    Slider.value(this.volume * 100);
    Slider.min(0);
    Slider.max(100);
    Slider.onChange(this.handleVolumeChange);
    Slider.pop();
    Stack.pop();
    
    Button.create();
    Button.className("source-button");
    Button.onClick(() => this.showSourceMenu = !this.showSourceMenu);
    Text.create();
    Text.content("æº");
    Text.pop();
    Button.pop();
    
    Button.create();
    Button.className("fullscreen-button");
    Button.onClick(this.toggleFullscreen);
    Text.create();
    Text.content(this.isFullscreen ? 'â¤¢' : 'â¤¡');
    Text.pop();
    Button.pop();
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾é€Ÿåº¦èœå•
   */
  @Builder
  private renderSpeedMenu(): void {
    if (!this.showSpeedMenu) return;
    
    Stack.create();
    Stack.className("speed-menu");
    playbackService.getSupportedPlaybackSpeeds().forEach((speed) => {
      Button.create();
      Button.key(speed.toString());
      Button.className(`speed-option ${this.playbackSpeed === speed ? 'selected' : ''}`);
      Button.onClick(() => this.setPlaybackSpeed(speed));
      Text.create();
      Text.content(playbackService.getPlaybackSpeedText(speed));
      Text.pop();
      Button.pop();
    });
    Stack.pop();
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾æºèœå•
   */
  @Builder
  private renderSourceMenu(): void {
    if (!this.showSourceMenu) return;
    
    Stack.create();
    Stack.style({
      position: 'absolute',
      bottom: 0,
      left: 0,
      right: 0,
      backgroundColor: '#4CAF50',
      height: '80%',
      borderTopLeftRadius: 20,
      borderTopRightRadius: 20,
      padding: 20,
      zIndex: 1000
    });
    
    // èœå•æ ‡é¢˜
    Flex.create();
    Flex.style({
      flexDirection: 'row',
      alignItems: 'center',
      justifyContent: 'space-between',
      marginBottom: 20
    });
    Text.create();
    Text.style({
      fontSize: 28,
      color: '#FFFFFF',
      fontWeight: 700
    });
    Text.content('åˆ‡æ¢ç‰‡æº');
    Text.pop();
    Button.create();
    Button.style({
      backgroundColor: 'transparent'
    });
    Button.onClick(() => this.showSourceMenu = false);
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#FFFFFF'
    });
    Text.content('âœ•');
    Text.pop();
    Button.pop();
    Flex.pop();
    
    // æœç´¢æ¡†
    Stack.create();
    Stack.style({
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: '#FFFFFF',
      borderRadius: 25,
      paddingHorizontal: 20,
      marginBottom: 20,
      height: 50
    });
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#999999',
      marginRight: 10
    });
    Text.content('ğŸ”');
    Text.pop();
    TextInput.create();
    TextInput.style({
      flex: 1,
      fontSize: 24,
      color: '#333333'
    });
    TextInput.value(this.searchText);
    TextInput.onChange((text) => this.handleSearchChange(text));
    TextInput.onFocusChange((focused) => this.handleSearchFocusChange(focused));
    TextInput.placeholder('æœç´¢ç‰‡æº...');
    TextInput.placeholderColor('#999999');
    TextInput.pop();
    if (this.searchText.length > 0) {
      Button.create();
      Button.style({
        backgroundColor: 'transparent'
      });
      Button.onClick(() => this.clearSearchText());
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#999999'
      });
      Text.content('âœ•');
      Text.pop();
      Button.pop();
    }
    Stack.pop();
    
    // æœç´¢ç»“æœæ•°é‡æç¤º
    Text.create();
    Text.style({
      fontSize: 24,
      color: '#FFFFFF',
      fontWeight: 600,
      marginBottom: 10
    });
    Text.content(`å…±æ‰¾åˆ° ${this.filteredSources.length} ä¸ªç‰‡æº`);
    Text.pop();
    
    // ç‰‡æºåˆ—è¡¨
    if (this.filteredSources.length === 0) {
      Stack.create();
      Stack.style({
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center'
      });
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#FFFFFF'
      });
      Text.content('æš‚æ— åŒ¹é…çš„ç‰‡æº');
      Text.pop();
      Stack.pop();
    } else {
      List.create();
      List.style({
        flex: 1
      });
      this.filteredSources.forEach((source, index) => {
        ListItem.create();
        ListItem.key(index.toString());
        ListItem.style({
          paddingVertical: 15
        });
        Button.create();
        Button.style({
          backgroundColor: '#66BB6A',
          padding: 20,
          borderRadius: 10,
          width: '100%'
        });
        Button.onClick(() => {
          this.switchPlaySource(source);
          this.showSourceMenu = false;
        });
        Flex.create();
        Flex.style({
          flexDirection: 'row',
          alignItems: 'center',
          justifyContent: 'space-between',
          width: '100%'
        });
        Text.create();
        Text.style({
          fontSize: 26,
          color: '#FFFFFF',
          fontWeight: 600
        });
        Text.content(source.name || `æ’­æ”¾æº${index + 1}`);
        Text.pop();
        if (source.quality) {
          Flex.create();
          Flex.style({
            backgroundColor: '#FFEB3B',
            paddingHorizontal: 12,
            paddingVertical: 4,
            borderRadius: 12
          });
          Text.create();
          Text.style({
            fontSize: 20,
            color: '#000000',
            fontWeight: 700
          });
          Text.content(source.quality);
          Text.pop();
          Flex.pop();
        }
        Flex.pop();
        Button.pop();
        ListItem.pop();
      });
      List.pop();
    }
    
    Stack.pop();
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Stack.create();
    Stack.className(`playback-page ${this.isFullscreen ? 'fullscreen' : ''}`);
    Stack.onClick(this.handleScreenTap);
    
    // è§†é¢‘æ’­æ”¾åŒºåŸŸ
    Stack.create();
    Stack.className("video-container");
    
    // è¿™é‡Œåº”è¯¥ä½¿ç”¨å®é™…çš„è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
    // ç”±äºHarmonyOSçš„Videoç»„ä»¶å…·ä½“APIå¯èƒ½ä¸åŒï¼Œè¿™é‡Œç”¨å ä½ç¬¦è¡¨ç¤º
    Image.create();
    Image.src("https://via.placeholder.com/1920x1080?text=Video+Player");
    Image.className("video-placeholder");
    Image.objectFit("cover");
    Image.pop();
    
    // åŠ è½½çŠ¶æ€
    if (this.isLoading) {
      this.renderLoading();
    }
    
    // é”™è¯¯çŠ¶æ€
    if (this.errorMessage) {
      this.renderError();
    }
    
    // æ’­æ”¾æ§åˆ¶ç•Œé¢
    if (this.showControls) {
      Stack.create();
      Stack.className("controls-overlay");
      this.renderTopControls();
      this.renderBottomControls();
      Stack.pop();
    }
    
    // æ’­æ”¾é€Ÿåº¦èœå•
    this.renderSpeedMenu();
    
    // æ’­æ”¾æºèœå•
    this.renderSourceMenu();
    
    Stack.pop();
    Stack.pop();
  }
}

export default PlaybackPage;