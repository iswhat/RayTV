import { Stack, Video, Image, Button, Slider, List, ListItem, LoadingProgress, Toast, PromptAction, VideoFit } from '@kit.ArkUI';
import Router from '@ohos.router';
import Logger from '../common/util/Logger';
import { playbackService } from '../service/media/PlaybackService';
import { historyService } from '../service/media/HistoryService';
import { mediaService } from '../service/media/MediaService';
import { configService } from '../service/config/ConfigService';
import { PlaybackState, PlaybackSpeed, PlaySource, Subtitle } from '../service/media/PlaybackService';

/**
 * æ’­æ”¾é¡µé¢ç»„ä»¶
 * å®ç°è§†é¢‘æ’­æ”¾æ§åˆ¶ç•Œé¢ï¼ŒåŒ…å«æ’­æ”¾æš‚åœã€è¿›åº¦æ§åˆ¶ã€éŸ³é‡æ§åˆ¶ã€é€Ÿåº¦è°ƒæ•´ç­‰åŠŸèƒ½ */
@Component
struct PlaybackPage {
  private readonly TAG: string = 'PlaybackPage';
  
  // è·¯ç”±å‚æ•°
  private mediaId: string = '';
  private siteKey: string = '';
  private episodeId?: string;
  private initialPosition: number = 0;
  private mediaTitle: string = '';
  private episodeName: string = '';
  private playSource?: PlaySource;
  private playSourceIndex: number = 0;
  // çŠ¶æ€ç®¡ç†
  @State playbackState: PlaybackState = PlaybackState.IDLE;
  @State currentTime: number = 0;
  @State duration: number = 0;
  @State isPlaying: boolean = false;
  @State volume: number = 1.0;
  @State isMuted: boolean = false;
  @State playbackSpeed: PlaybackSpeed = PlaybackSpeed.NORMAL;
  @State isBuffering: boolean = false;
  @State bufferPercentage: number = 0;
  @State showControls: boolean = true;
  @State showSpeedMenu: boolean = false;
  @State showSourceMenu: boolean = false;
  @State showSubtitleMenu: boolean = false;
  @State playSources: PlaySource[] = [];
  @State filteredSources: PlaySource[] = [];
  @State searchText: string = '';
  @State subtitles: Subtitle[] = [];
  @State selectedSubtitle: Subtitle | null = null;
  @State isFullscreen: boolean = false;
  @State errorMessage: string = '';
  @State isLoading: boolean = true;
  @State controlsTimeout: number | null = null;
  @State lastProgressSaveTime: number = 0;
  @State saveProgressInterval: number = 30000; // 30ç§’ä¿å­˜ä¸€æ¬¡è¿›åº¦
  @State searchFocused: boolean = false;
  private autoSwitchSourceOnError: boolean = true; // æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢ç‰‡æº
  private lastSaveTime: number = 0; // ä¸Šæ¬¡ä¿å­˜è¿›åº¦çš„æ—¶ï¿½?æ¯«ç§’)
  private currentPosition: number = 0; // å½“å‰æ’­æ”¾ä½ç½®
  private totalTime: number = 0;
  
  // åˆå§‹ï¿½?  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒï¿½?   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'PlaybackPage appeared');
    
    // è·å–è·¯ç”±å‚æ•°
    const params = Router.getParams();
    this.mediaId = (params?.mediaId as string) || '';
    this.siteKey = (params?.siteKey as string) || '';
    this.episodeId = params?.episodeId;
    this.initialPosition = (params?.currentTime as number) || (params?.startPosition as number) || 0;
    this.mediaTitle = (params?.mediaTitle as string) || 'æ­£åœ¨æ’­æ”¾';
    this.episodeName = (params?.episodeName as string) || '';
    this.playSource = params?.playSource;
    this.playSourceIndex = (params?.playSourceIndex as number) || 0;
    this.autoSwitchSourceOnError = params?.autoSwitchSourceOnError !== false; // é»˜è®¤å¼€ï¿½?    
    Logger.info(this.TAG, `Starting playback for: ${this.siteKey}:${this.mediaId}`, `${this.episodeId ? ` episode: ${this.episodeId}` : ''}, startPosition=${this.initialPosition}`);
    
    // åˆå§‹åŒ–æ’­æ”¾å™¨
    this.initializePlayback();
    
    // è®¾ç½®æ§åˆ¶æ è‡ªåŠ¨éšï¿½?    this.startControlsTimeout();
  }
  
  /**
     * é¡µé¢å¸è½½æ—¶è°ƒï¿½?     */
    aboutToDisappear(): void {
      Logger.info(this.TAG, 'PlaybackPage disappeared');
      this.cleanupPlayer();
    }

    /**
     * æ¸…ç†æ’­æ”¾å™¨èµ„ï¿½?     */
    private cleanupPlayer(): void {
      // ç§»é™¤æ’­æ”¾ç›‘å¬ï¿½?      playbackService.removeAllListeners();
      
      // ä¿å­˜æœ€ç»ˆæ’­æ”¾è¿›ï¿½?    this.savePlayProgress(this.currentPosition);
    
    // åœæ­¢æ§åˆ¶æ è¶…ï¿½?    this.stopControlsTimeout();
    
    // é‡Šæ”¾æ’­æ”¾å™¨èµ„ï¿½?    this.releasePlayer();
    playbackService.stop();
    playbackService.destroy();
  }
  
  /**
   * åˆå§‹åŒ–æ’­ï¿½?   */
  private initializePlayback(): void {
    if (!this.mediaId || !this.siteKey) {
      this.errorMessage = 'ç¼ºå°‘å¿…è¦å‚æ•°';
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
      return;
    }
    
    try {
      // åŠ è½½æ’­æ”¾ï¿½?      this.loadPlaySources().then(() => {
        // åˆå§‹åŒ–è¿‡æ»¤åçš„ç‰‡æºåˆ—ï¿½?        this.filteredSources = [...this.playSources];
        
        // è®¾ç½®æ’­æ”¾æºå¹¶å¼€å§‹æ’­ï¿½?        if (this.playSource) {
          this.setupPlayback(this.playSource);
        } else if (this.playSources.length > 0 && this.playSourceIndex < this.playSources.length) {
          this.setupPlayback(this.playSources[this.playSourceIndex]);
        } else {
          this.errorMessage = 'æ— å¯ç”¨æ’­æ”¾æº';
          this.isLoading = false;
          this.playbackState = PlaybackState.ERROR;
        }
      }).catch((error) => {
        Logger.error(this.TAG, 'Failed to initialize playback', error as Error);
        this.errorMessage = 'æ’­æ”¾åˆå§‹åŒ–å¤±ï¿½?;
        this.isLoading = false;
        this.playbackState = PlaybackState.ERROR;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize playback`, `${error}`);
      this.errorMessage = 'æ’­æ”¾åˆå§‹åŒ–å¤±ï¿½?;
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
    }
  }
  
  /**
   * åŠ è½½æ’­æ”¾ï¿½?   */
  private loadPlaySources(): Promise<void> {
    return new Promise<void>((resolve, reject) => {
      try {
        // å¦‚æœæ²¡æœ‰ä¼ å…¥æ’­æ”¾æºï¼Œåˆ™ä»æœåŠ¡è·å–
        if (!this.playSource || this.playSources.length === 0) {
          mediaService.getPlaySources(
            this.mediaId,
            this.siteKey,
            this.episodeId
          ).then((sources) => {
            this.playSources = sources;
            Logger.info(this.TAG, `Loaded ${this.playSources.length} play sources`);
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªæ’­æ”¾æºï¼Œåˆ™ä½¿ç”¨ï¿½?            if (this.playSources.length === 1 && !this.playSource) {
              this.playSource = this.playSources[0];
            }
            resolve();
          }).catch((error) => {
            Logger.error(this.TAG, `Failed to load play sources`, `${error}`);
            reject(error);
          });
        } else {
          resolve();
        }
      } catch (error) {
        Logger.error(this.TAG, `Failed to load play sources`, `${error}`);
        reject(error);
      }
    });
  }
  
  /**
   * è®¾ç½®æ’­æ”¾
   */
  private setupPlayback(source: PlaySource): void {
    try {
      // æ·»åŠ æ’­æ”¾ç›‘å¬ï¿½?      this.addPlaybackListeners();
      
      // è®¾ç½®æ’­æ”¾ï¿½?      playbackService.setSource(source, {
        autoPlay: true,
        startPosition: this.initialPosition,
        volume: this.volume,
        isMuted: this.isMuted,
        playbackSpeed: this.playbackSpeed
      }).then(() => {
        this.playSource = source;
        this.isLoading = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to setup playback`, `${error}`);
        
        // å°è¯•è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡ï¿½?        if (this.autoSwitchSourceOnError) {
          this.handlePlaybackError(error);
        } else {
          this.errorMessage = 'æ’­æ”¾è®¾ç½®å¤±è´¥';
          this.isLoading = false;
          this.playbackState = PlaybackState.ERROR;
        }
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to setup playback`, `${error}`);
      
      // å°è¯•è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡ï¿½?      if (this.autoSwitchSourceOnError) {
        this.handlePlaybackError(error);
      } else {
        this.errorMessage = 'æ’­æ”¾è®¾ç½®å¤±è´¥';
        this.isLoading = false;
        this.playbackState = PlaybackState.ERROR;
      }
    }
  }
  
  /**
   * æ·»åŠ æ’­æ”¾ç›‘å¬ï¿½?   */
  private addPlaybackListeners(): void {
    playbackService.addListener({
      onStateChanged: (state) => {
        this.playbackState = state;
        this.isPlaying = state === PlaybackState.PLAYING;
        
        if (state === PlaybackState.COMPLETED) {
          this.handlePlaybackCompleted();
        } else if (state === PlaybackState.ERROR) {
          this.errorMessage = 'æ’­æ”¾å‡ºé”™';
        }
        
        this.showControls = true;
        this.restartControlsTimeout();
      },
      
      onError: (error: Error) => {
        Logger.error(this.TAG, `Playback error`, `${error}`);
        
        // å°è¯•è‡ªåŠ¨åˆ‡æ¢ç‰‡æº
        if (this.autoSwitchSourceOnError) {
          this.handlePlaybackError(error);
        } else {
          this.errorMessage = `æ’­æ”¾é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
        }
      },
      
      // å®šæœŸä¿å­˜æ’­æ”¾è¿›åº¦
      onTimeUpdate: (currentTime, duration) => {
        this.currentTime = currentTime;
        this.currentPosition = currentTime;
        this.duration = duration;
        this.totalTime = duration || this.totalTime;
        
        // ï¿½?0ç§’ä¿å­˜ä¸€æ¬¡æ’­æ”¾è¿›ï¿½?        if (this.lastSaveTime === 0 || currentTime - this.lastSaveTime > 10000) {
          this.savePlayProgress(currentTime);
          this.lastSaveTime = currentTime;
        }
      },
      
      onCompleted: () => {
        Logger.info(this.TAG, 'Playback completed');
      },
      
      onBufferUpdate: (bufferPercentage) => {
        this.bufferPercentage = bufferPercentage;
      },
      
      onSeekCompleted: (seekTime) => {
        Logger.info(this.TAG, `Seek completed to ${seekTime}s`);
      }
    });
  }
  
  /**
   * å¤„ç†æ’­æ”¾å®Œæˆ
   */
  private handlePlaybackCompleted(): void {
    try {
      // ä¿å­˜å®Œæˆçš„æ’­æ”¾çŠ¶ï¿½?      historyService.updateProgress(
        this.mediaId,
        this.siteKey,
        this.duration, // æ ‡è®°ä¸ºå·²å®Œæˆ
        this.episodeId,
        true // æ ‡è®°ä¸ºå·²å®Œæˆ
      ).then(() => {
        Toast.show('æ’­æ”¾å®Œæˆ');
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to handle playback completed`, `${error}`);
        Toast.show('æ’­æ”¾å®Œæˆ');
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle playback completed`, `${error}`);
      Toast.show('æ’­æ”¾å®Œæˆ');
    }
  }
  
  /**
   * ä¿å­˜æ’­æ”¾è¿›åº¦
   */
  private savePlayProgress(position: number): void {
    if (!this.mediaId || !this.siteKey || !this.episodeId) return;
    
    try {
      const duration = this.totalTime || this.duration;
      
      // ä¿å­˜æ’­æ”¾è¿›åº¦åˆ°å†å²è®°å½•
      historyService.saveWatchProgress(
        this.mediaId, 
        this.siteKey,
        this.episodeId,
        position,
        duration
      ).then(() => {
        Logger.info(this.TAG, `Saved playback progress: ${position}ms of ${duration}ms`);
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to save play progress`, `${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to save play progress`, `${error}`);
    }
  }
  
  /**
   * å¤„ç†æœç´¢æ–‡æœ¬å˜åŒ–
   */
  private handleSearchChange(text: string) {
    this.searchText = text;
    
    // æ ¹æ®æœç´¢æ–‡æœ¬è¿‡æ»¤ç‰‡æº
    if (text.trim()) {
      const searchLower = text.toLowerCase();
      this.filteredSources = this.playSources.filter(source => 
        (source.name && source.name.toLowerCase().includes(searchLower)) ||
        (source.description && source.description.toLowerCase().includes(searchLower))
      );
    } else {
      // å¦‚æœæœç´¢æ–‡æœ¬ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç‰‡ï¿½?      this.filteredSources = [...this.playSources];
    }
  }
  
  /**
   * å¤„ç†æœç´¢æ¡†ç„¦ç‚¹å˜ï¿½?   */
  private handleSearchFocusChange(focused: boolean) {
    this.searchFocused = focused;
  }
  
  /**
   * æ¸…é™¤æœç´¢æ–‡æœ¬
   */
  private clearSearchText() {
    this.searchText = '';
    this.filteredSources = [...this.playSources];
  }
  
  /**
   * åˆ‡æ¢æ’­æ”¾/æš‚åœ
   */
  private togglePlayPause(): void {
    try {
      if (this.isPlaying) {
        playbackService.pause().catch((error) => {
          Logger.error(this.TAG, `Failed to pause playback`, `${error}`);
        });
      } else {
        playbackService.play().catch((error) => {
          Logger.error(this.TAG, `Failed to play`, `${error}`);
        });
      }
      
      this.showControls = true;
      this.restartControlsTimeout();
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle play/pause`, `${error}`);
    }
  }
  
  /**
   * å¤„ç†è¿›åº¦æ¡å˜ï¿½?   */
  private handleProgressChange(value: number): void {
    try {
      const seekTime = (value / 100) * this.duration;
      playbackService.seekTo(seekTime).catch((error) => {
        Logger.error(this.TAG, `Failed to seek`, `${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to seek`, `${error}`);
    }
  }
  
  /**
   * å¤„ç†éŸ³é‡å˜åŒ–
   */
  private handleVolumeChange(value: number): void {
    try {
      this.volume = value;
      if (this.isMuted && value > 0) {
        this.isMuted = false;
      }
      playbackService.setVolume(value).catch((error) => {
        Logger.error(this.TAG, `Failed to set volume`, `${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to set volume`, `${error}`);
    }
  }
  
  /**
   * åˆ‡æ¢é™éŸ³
   */
  private toggleMute(): void {
    try {
      const newMuteState = !this.isMuted;
      playbackService.setMuted(newMuteState).then(() => {
        this.isMuted = newMuteState;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to toggle mute`, `${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to toggle mute`, `${error}`);
    }
  }
  
  /**
   * è®¾ç½®æ’­æ”¾é€Ÿåº¦
   */
  private setPlaybackSpeed(speed: PlaybackSpeed): void {
    try {
      this.playbackSpeed = speed;
      playbackService.setPlaybackSpeed(speed).then(() => {
        this.showSpeedMenu = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to set playback speed`, `${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to set playback speed`, `${error}`);
    }
  }
  
  /**
   * å¤„ç†æ’­æ”¾é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨ç‰‡ï¿½?   */
  private handlePlaybackError(error: Error): void {
    if (!this.playSources || this.playSources.length <= 1) {
      this.errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œæš‚æ— å¯ç”¨å¤‡ç”¨ç‰‡ï¿½?;
      this.isLoading = false;
      return;
    }
    
    // æŸ¥æ‰¾å½“å‰ç‰‡æºçš„ç´¢ï¿½?    const currentIndex = this.playSources.findIndex(s => 
      s.id === this.playSource?.id || 
      (s.name === this.playSource?.name && s.url === this.playSource?.url)
    );
    
    // é€‰æ‹©ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç‰‡æº
    let nextIndex = (currentIndex + 1) % this.playSources.length;
    
    if (currentIndex !== -1) {
      Logger.info(this.TAG, `å°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡æº ${nextIndex}ï¼ŒåŸç‰‡æº: ${currentIndex}`);
      
      // æ˜¾ç¤ºåˆ‡æ¢æç¤º
      this.errorMessage = `å½“å‰ç‰‡æºæ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨å°è¯•åˆ‡æ¢åˆ°å¤‡ç”¨ç‰‡æº(${nextIndex + 1}/${this.playSources.length})...`;
      
      // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
      const currentPosition = this.currentPosition;
      
      // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç‰‡ï¿½?      this.initialPosition = currentPosition; // ä¿æŒç›¸åŒçš„æ’­æ”¾ä½ï¿½?      this.setupPlayback(this.playSources[nextIndex]);
      this.errorMessage = '';
    } else {
      this.errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œæ— æ³•è¯†åˆ«å½“å‰ç‰‡ï¿½?;
      this.isLoading = false;
    }
  }
  
  /**
   * åˆ‡æ¢æ’­æ”¾ï¿½?   */
  private switchPlaySource(source: PlaySource): void {
    try {
      this.isLoading = true;
      this.playbackState = PlaybackState.BUFFERING;
      
      // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
      const currentPosition = this.currentPosition;
      
      // è®¾ç½®æ–°çš„æ’­æ”¾ï¿½?      this.setupPlayback(source);
      
      // æ¢å¤æ’­æ”¾ä½ç½®
      if (currentPosition > 0) {
        playbackService.seekTo(currentPosition).catch((error) => {
          Logger.error(this.TAG, `Failed to seek to position after switching source: ${error}`);
        });
      }
      
      this.isLoading = false;
      this.showSourceMenu = false;
      
      // æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸæç¤º
      Toast.show('ç‰‡æºåˆ‡æ¢æˆåŠŸ');
    } catch (error) {
      Logger.error(this.TAG, `Failed to switch play source`, `${error}`);
      this.errorMessage = 'åˆ‡æ¢æ’­æ”¾æºå¤±ï¿½?;
      this.isLoading = false;
      this.playbackState = PlaybackState.ERROR;
    }
  }
  
  /**
   * åˆ‡æ¢å…¨å±
   */
  private toggleFullscreen(): void {
    this.isFullscreen = !this.isFullscreen;
    // è¿™é‡Œéœ€è¦å¤„ç†å®é™…çš„å…¨å±é€»è¾‘ï¼Œå¯èƒ½éœ€è¦è°ƒç”¨ç³»ç»ŸAPI
    Logger.info(this.TAG, `Fullscreen mode: ${this.isFullscreen}`);
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    // å…ˆä¿å­˜è¿›ï¿½?    this.savePlayProgress(this.currentPosition);
    Router.back();
  }
  
  /**
   * å¤„ç†å±å¹•ç‚¹å‡»
   */
  private handleScreenTap(): void {
    this.showControls = !this.showControls;
    if (this.showControls) {
      this.restartControlsTimeout();
    } else {
      this.stopControlsTimeout();
    }
  }
  
  /**
   * å¼€å§‹æ§åˆ¶æ è¶…æ—¶éšè—
   */
  private startControlsTimeout(): void {
    this.stopControlsTimeout();
    this.controlsTimeout = setTimeout(() => {
      if (this.isPlaying && this.playbackState !== PlaybackState.ERROR) {
        this.showControls = false;
      }
    }, 3000); // 3ç§’åéšè—
  }
  
  /**
   * é‡æ–°å¼€å§‹æ§åˆ¶æ è¶…æ—¶
   */
  private restartControlsTimeout(): void {
    this.startControlsTimeout();
  }
  
  /**
   * åœæ­¢æ§åˆ¶æ è¶…ï¿½?   */
  private stopControlsTimeout(): void {
    if (this.controlsTimeout) {
      clearTimeout(this.controlsTimeout);
      this.controlsTimeout = null;
    }
  }
  
  /**
   * é‡Šæ”¾æ’­æ”¾å™¨èµ„ï¿½?   */
  private releasePlayer(): void {
    try {
      // ä¿å­˜å½“å‰æ’­æ”¾è¿›åº¦
      this.savePlayProgress(this.currentPosition);
      
      // ç§»é™¤æ’­æ”¾ç›‘å¬ï¿½?      playbackService.removeAllListeners();
      
      // é‡Šæ”¾æ’­æ”¾å™¨èµ„ï¿½?      playbackService.release().catch((error) => {
        Logger.error(this.TAG, `Failed to release player`, `${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to release player`, `${error}`);
    }
  }
  
  /**
   * æ ¼å¼åŒ–æ—¶ï¿½?   */
  private formatTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€
   */
  @Builder
  private renderLoading(): void {
    Stack() {
      LoadingProgress({ color: "#FF4500" })
      Text("æ­£åœ¨åŠ è½½...")
      if (this.bufferPercentage > 0) {
        Text(`å·²ç¼“å­˜${this.bufferPercentage}%`)
      }
    }
  }
  
  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€
   */
  @Builder
  private renderError(): void {
    Stack() {
      Text("âš ï¸")
      Text(this.errorMessage)
      Button() {
        Text("é‡è¯•")
      }
      .onClick(() => this.initializePlayback())
    }
  }
  
  /**
   * æ¸²æŸ“é¡¶éƒ¨æ§åˆ¶æ 
   */
  @Builder
  private renderTopControls(): void {
    Stack() {
      Button() {
        Text("è¿”å›")
      }
      .onClick(this.handleBack)
      Stack() {
        Text(this.mediaTitle).numberOfLines(1)
        if (this.episodeName) {
          Text(this.episodeName).numberOfLines(1)
        }
      }
      Button() {
        Text(`${this.playbackSpeed}x`)
      }
      .onClick(() => this.showSpeedMenu = !this.showSpeedMenu)
    }
  }
  
  /**
   * æ¸²æŸ“åº•éƒ¨æ§åˆ¶æ 
   */
  @Builder
  private renderBottomControls(): void {
    Stack() {
      Button() {
        Text(this.isPlaying ? 'æš‚åœ' : 'æ’­æ”¾')
      }
      .onClick(this.togglePlayPause)
      
      Stack() {
        Slider({ 
          value: (this.currentTime / this.duration) * 100 || 0,
          min: 0,
          max: 100,
          onChange: this.handleProgressChange 
        })
        Flex() {
          Text(this.formatTime(this.currentTime))
          Text(this.formatTime(this.duration))
        }
      }
      
      Button() {
        Text(this.isMuted ? 'ğŸ”‡' : 'ğŸ”Š')
      }
      .onClick(this.toggleMute)
      
      Stack() {
        Slider({ 
          value: this.volume * 100,
          min: 0,
          max: 100,
          onChange: this.handleVolumeChange 
        })
      }
      
      Button() {
        Text("åˆ‡æ¢æº")
      }
      .onClick(() => this.showSourceMenu = !this.showSourceMenu)
      
      Button() {
        Text(this.isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±')
      }
      .onClick(this.toggleFullscreen)
    }
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾é€Ÿåº¦èœå•
   */
  @Builder
  private renderSpeedMenu(): void {
    if (!this.showSpeedMenu) return;
    
    Stack() {
      playbackService.getSupportedPlaybackSpeeds().forEach((speed) => {
        Button() {
          Text(playbackService.getPlaybackSpeedText(speed))
        }
        .onClick(() => this.setPlaybackSpeed(speed))
      })
    }
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾æºèœå•
   */
  @Builder
  private renderSourceMenu(): void {
    if (!this.showSourceMenu) return;
    
    Stack() {
      // èœå•æ ‡é¢˜
      Flex() {
        Text('åˆ‡æ¢ç‰‡æº')
          .fontSize(28)
          .fontColor('#FFFFFF')
          .fontWeight(700)
        Button() {
          Text('å…³é—­')
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        .onClick(() => this.showSourceMenu = false)
      }
    
      // æœç´¢æ¡†
      Stack() {
        Text('ğŸ”')
          .fontSize(24)
          .fontColor('#999999')
          .margin({ right: 10 })
        TextInput({
          value: this.searchText,
          placeholder: 'æœç´¢ç‰‡æº...',
          placeholderColor: '#999999'
        })
        .onChange((text) => this.handleSearchChange(text))
        .onFocusChange((focused) => this.handleSearchFocusChange(focused))
        if (this.searchText.length > 0) {
          Button() {
            Text('æ¸…é™¤')
            .fontSize(24)
            .fontColor('#999999')
          }
          .onClick(() => this.clearSearchText())
        }
      }
      
      // æœç´¢ç»“æœæ•°é‡æç¤º
      Text(`å…±æ‰¾åˆ°${this.filteredSources.length} ä¸ªç‰‡æº`)
        .fontSize(24)
        .fontColor('#FFFFFF')
        .fontWeight(600)
        .margin({ bottom: 10 })
    
      // ç‰‡æºåˆ—è¡¨
      List() {
        ForEach(this.filteredSources, (source, index) => {
          ListItem() {
            Flex() {
              // ç‰‡æºä¿¡æ¯
              Flex() {
                Text(source.name || `ç‰‡æº ${index + 1}`)
                  .fontSize(24)
                  .fontColor(this.playSource?.id === source.id ? '#333333' : '#FFFFFF')
                  .fontWeight(700)
                if (source.description) {
                  Text(source.description)
                    .fontSize(18)
                    .fontColor(this.playSource?.id === source.id ? '#666666' : '#CCCCCC')
                    .margin({ top: 5 })
                    .numberOfLines(2)
                }
              }
              
              // å½“å‰æ’­æ”¾æ ‡è®°
              if (this.playSource?.id === source.id) {
                Text('æ­£åœ¨æ’­æ”¾')
                  .fontSize(18)
                  .fontColor('#FF4500')
                  .fontWeight(700)
                  .backgroundColor('#FFFF00')
                  .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                  .borderRadius(15)
              }
            }
          }
          .onClick(() => this.switchPlaySource(source))
        })
      }
    }
  }
  
  /**
   * æ¸²æŸ“å­—å¹•èœå•
   */
  @Builder
  private renderSubtitleMenu(): void {
    if (!this.showSubtitleMenu) return;
    
    Stack() {
      Text("å­—å¹•èœå•")
        .fontSize(24)
        .fontColor("#FFFFFF")
        .margin({ bottom: 20 })
      
      Button() {
        Text("å…³é—­èœå•")
      }
      .onClick(() => this.showSubtitleMenu = false)
    }
  }
  
  /**
   * æ¸²æŸ“æ’­æ”¾æ§åˆ¶ç•Œé¢
   */
  build() {
    Stack()
    .onClick(this.handleScreenTap) {
      // è§†é¢‘æ’­æ”¾åŒºåŸŸ
      Video({
        src: this.playSource?.url || "",
        autoPlay: true,
        objectFit: VideoFit.COVER
      })
      
      // åŠ è½½çŠ¶æ€
      if (this.isLoading && this.playbackState !== PlaybackState.ERROR) {
        this.renderLoading();
      }
      
      // é”™è¯¯çŠ¶æ€
      if (this.playbackState === PlaybackState.ERROR) {
        this.renderError();
      }
      
      // æ§åˆ¶æ 
      if (this.showControls) {
        // é¡¶éƒ¨æ§åˆ¶æ 
        this.renderTopControls();
        
        // åº•éƒ¨æ§åˆ¶æ 
        this.renderBottomControls();
      }
      
      // é€Ÿåº¦èœå•
      this.renderSpeedMenu();
      
      // æ’­æ”¾æºèœå•
      this.renderSourceMenu();
      
      // å­—å¹•èœå•
      this.renderSubtitleMenu();
    }
  }
}