import { Button, Image, List } from '@ohos/arkui';
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { mediaService } from '../service/media/MediaService';
import { configService } from '../service/config/ConfigService';
import { RecommendationRepository, RecommendationType, RecommendationItem } from '../data/repository/RecommendationRepository';

/**
 * åº”ç”¨ä¸»é¡µé?
 * ä½œä¸ºåº”ç”¨çš„å…¥å£é¡µé¢ï¼Œæ˜¾ç¤ºä¸»è¦åŠŸèƒ½åŒºåŸŸ
 */
interface FeaturedMediaItem {
  id: string;
  title: string;
  cover: string;
  type: string;
  siteKey?: string;
}

@Entry
@Component
struct MainPage {
  private readonly TAG: string = 'MainPage';
  private scroller: Scroller = new Scroller();
  
  // çŠ¶æ€ç®¡ç?
  @State featuredMedia: FeaturedMediaItem[] = [];
  @State isLoading: boolean = true;
  
  // ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    Logger.info(`${this.TAG}: MainPage about to appear`);
    
    // åˆå§‹åŒ–å¹¶æ£€æŸ¥é…ç½?
    this.initializeConfig();
  }
  
  /**
   * åˆå§‹åŒ–é…ç½®å¹¶åŠ è½½æ•°æ®
   */
  private async initializeConfig() {
    try {
      // ç¡®ä¿é…ç½®æœåŠ¡å·²åˆå§‹åŒ–
      if (!configService.isInitialized) {
        await configService.initializeConfig();
        Logger.info(`${this.TAG}: ConfigService initialized successfully`);
      }
      
      // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæ¨èå†…å®?
      const showRecommendations = configService.getConfig('showRecommendedContent') as boolean;
      
      if (showRecommendations) {
        // åŠ è½½æ¨èå†…å®¹
        this.loadFeaturedMedia();
      } else {
        Logger.info(`${this.TAG}: Recommended content is disabled in config`);
        this.isLoading = false;
      }
    } catch (error) {
      Logger.error(this.TAG, 'Failed to initialize config', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      // å‘ç”Ÿé”™è¯¯æ—¶ä»å°è¯•åŠ è½½å†…å®¹
      this.loadFeaturedMedia();
    }
  }
  
  /**
   * åŠ è½½æ¨èå†…å®¹
   */
  private async loadFeaturedMedia() {
    try {
      this.isLoading = true;
      const recommendationRepo = RecommendationRepository.getInstance();
      
      // è·å–ç²¾é€‰æ¨èå†…å®?
      const response = await recommendationRepo.getRecommendations({
        type: RecommendationType.FEATURED,
        limit: 10,
        contentTypes: ['video']
      });
      
      // è½¬æ¢æ¨èé¡¹ç›®ä¸ºé¡µé¢æ‰€éœ€æ ¼å¼
      this.featuredMedia = response.items.map((item: RecommendationItem) => {
        // æå–æ•°æ®ä¸­çš„å¿…è¦ä¿¡æ¯
        const data = item.data || {};
        return {
          id: item.id,
          title: data.title as string || 'æœªå‘½åå†…å®?,
          cover: data.coverUrl as string || data.imageUrl as string || '/resources/images/default_cover.jpg',
          type: data.type as string || item.type,
          siteKey: data.siteKey as string
        };
      });
      
      Logger.info(`${this.TAG}: Loaded ${this.featuredMedia.length} featured media items`);
    } catch (error) {
      Logger.error(this.TAG, 'Failed to load featured media', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      
      // å°è¯•ä»MediaServiceè·å–æ•°æ®ä½œä¸ºåå¤‡
      try {
        Logger.info(`${this.TAG}: Trying to load data from MediaService as fallback`);
        const fallbackData = await mediaService.getPopularContent();
        
        if (fallbackData && fallbackData.length > 0) {
          this.featuredMedia = fallbackData.map((item: { id?: string; title?: string; coverUrl?: string; imageUrl?: string; type?: string; siteKey?: string }) => ({
            id: item.id || String(Math.random()),
            title: item.title || 'æœªå‘½åå†…å®?,
            cover: item.coverUrl || item.imageUrl || '/resources/images/default_cover.jpg',
            type: item.type || 'video',
            siteKey: item.siteKey
          }));
          Logger.info(`${this.TAG}: Successfully loaded ${this.featuredMedia.length} items from MediaService`);
        } else {
          // å¦‚æœæ‰€æœ‰æ•°æ®æ¥æºéƒ½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°ç»„
          this.featuredMedia = [];
          Logger.warn(`${this.TAG}: No fallback content available`);
        }
      } catch (fallbackError) {
        Logger.error(this.TAG, 'Failed to load fallback data', fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError : new Error(String(fallbackError instanceof Error ? fallbackError : new Error(String(fallbackError)))))))));
        this.featuredMedia = [];
      }
    } finally {
      this.isLoading = false;
    }
  }
  
  // è·³è½¬åˆ°åˆ†ç±»é¡µé?
  private navigateToCategory() {
    AppNavigator.getInstance().navigateToCategory({ id: "", name: "", type: "" });
  }
  
  // è·³è½¬åˆ°æœç´¢é¡µé?
  private navigateToSearch() {
    AppNavigator.getInstance().navigateToSearch("");
  }
  
  // è·³è½¬åˆ°è®¾ç½®é¡µé?
  private navigateToSettings() {
    AppNavigator.getInstance().navigateToSettings();
  }
  
  // æ¸²æŸ“åª’ä½“é¡?
  @Builder
  renderMediaItem(media: FeaturedMediaItem) {
    ListItem() {
      Column({ padding: 10 }) {
        Image(media.cover)
          .width(150)
          .height(200)
          .objectFit(ImageFit.Cover)
          .borderRadius(8)
        Text(media.title)
          .fontSize(14)
          .maxLines(2)
          .marginTop(8)
      }
    }
    .onClick(() => AppNavigator.getInstance().navigateToDetail({ id: media.id, siteKey: media.siteKey || '', type: 'vod' }))
  }
  
  build() {
    Flex({
      direction: FlexDirection.Column,
      padding: 20
    }) {
      // æ ‡é¢˜æ ?
      Row({
        justifyContent: FlexAlign.SpaceBetween,
        alignItems: ItemAlign.Center,
        marginBottom: 20
      }) {
        Text("RayTV")
          .fontSize(24)
          .fontWeight(700)
        Row() {
          Button("æœç´¢")
            .onClick(() => this.navigateToSearch())
            .marginRight(10)
          Button("è®¾ç½®")
            .onClick(() => this.navigateToSettings())
        }
      }
      
      // åˆ†ç±»å…¥å£
      Button("æµè§ˆåˆ†ç±»")
        .onClick(() => this.navigateToCategory())
        .backgroundColor("#007AFF")
        .fontColor("white")
        .width("100%")
        .padding(12)
        .fontSize(16)
        .marginBottom(20)
      
      // æ¨èå†…å®¹
      Text("æ¨èå†…å®¹")
        .fontSize(20)
        .fontWeight(700)
        .marginBottom(15)
      
      if (this.isLoading) {
        Text("åŠ è½½ä¸?..")
      } else {
        List() {
          ForEach(this.featuredMedia, (item: FeaturedMediaItem) => {
            this.renderMediaItem(item)
          }, (item: FeaturedMediaItem) => item.id)
        }
        .scroller(this.scroller)
        .orientation("horizontal")
        .height(250)
      }
      
      // åº•éƒ¨æç¤º
      Text("è¯·ç¡®ä¿å·²é…ç½®è§†é¢‘æºä»¥è·å¾—æœ€ä½³ä½“éª?)
        .fontSize(12)
        .fontColor("#888888")
        .marginTop(20)
        .textAlign(TextAlign.Center)
    }
  }
}


