// SearchPage.ets
// æœç´¢é¡µé¢ç»„ä»¶

import { AppNavigator } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { SearchHistoryRepository } from '../repository/SearchHistoryRepository';

@Entry
@Component
struct SearchPage {
  private readonly TAG: string = 'SearchPage';
  @State searchText: string = '';
  @State searchHistory: string[] = [];
  @State hotKeywords: string[] = [];
  @State searchResults: any[] = [];
  @State isSearching: boolean = false;
  @State showQuickResults: boolean = false;
  @State quickResults: any[] = [];
  @State showHistory: boolean = true;
  @State showHotKeywords: boolean = true;
  private searchHistoryRepo: SearchHistoryRepository;
  private mediaService: any;

  constructor() {
    this.searchHistoryRepo = new SearchHistoryRepository();
    // è¿™é‡Œåº”è¯¥æ³¨å…¥çœŸå®çš„mediaServiceï¼Œæš‚æ—¶ç”¨ç©ºå¯¹è±¡ä»£æ›?    this.mediaService = {};
  }

  aboutToAppear() {
    this.loadHotKeywords();
    this.loadSearchHistory();
  }

  /**
   * åŠ è½½çƒ­é—¨å…³é”®è¯?   */
  private loadHotKeywords(): void {
    try {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„mediaServiceè·å–çƒ­é—¨å…³é”®è¯?      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.hotKeywords = ['çƒ­é—¨ç”µå½±', 'æœ€æ–°å‰§é›?, 'ç»å…¸åŠ¨æ¼«', 'ç§‘å¹»å¤§ç‰‡', 'çˆ±æƒ…å–œå‰§'];
      Logger.info(this.TAG, `Loaded ${this.hotKeywords.length} hot keywords`);
    } catch (error) {
      Logger.error(this.TAG, 'Failed to load hot keywords', error as Error);
      // ä½¿ç”¨é»˜è®¤çƒ­é—¨å…³é”®è¯?      this.hotKeywords = ['çƒ­é—¨ç”µå½±', 'æœ€æ–°å‰§é›?, 'ç»å…¸åŠ¨æ¼«', 'ç§‘å¹»å¤§ç‰‡', 'çˆ±æƒ…å–œå‰§'];
    }
  }

  /**
   * åŠ è½½æœç´¢å†å²
   */
  private async loadSearchHistory(): Promise<void> {
    try {
      // ä½¿ç”¨SearchHistoryRepositoryä»æœ¬åœ°å­˜å‚¨ä¸­è¯»å–æœç´¢å†å²
      const searchHistoryRepo = new SearchHistoryRepository();
      const history = await searchHistoryRepo.getHistory();
      
      // ç¡®ä¿historyæ˜¯æ•°ç»„ç±»å?      if (Array.isArray(history)) {
        this.searchHistory = history;
        Logger.info(this.TAG, `Loaded ${this.searchHistory.length} search history items from repository`);
      } else {
        Logger.warn(this.TAG, `Invalid history data format, using empty array`);
        this.searchHistory = [];
      }
    } catch (error) {
      Logger.error(this.TAG, 'Failed to load search history', error as Error);
      this.searchHistory = [];
    }
  }

  /**
   * ä¿å­˜æœç´¢å†å²
   */
  private async saveSearchHistory(keyword: string): Promise<void> {
    try {
      // å»é‡å¹¶é™åˆ¶æ•°é‡?      let history = this.searchHistory.filter(item => item !== keyword);
      history.unshift(keyword);
      history = history.slice(0, 10); // æœ€å¤šä¿å­?0æ?      this.searchHistory = history;
      
      // ä½¿ç”¨SearchHistoryRepositoryä¿å­˜åˆ°æœ¬åœ°å­˜å‚?      const searchHistoryRepo = new SearchHistoryRepository();
      await searchHistoryRepo.saveHistory(history);
      
      Logger.info(this.TAG, `Search history saved: ${keyword}`);
    } catch (error) {
      Logger.error(this.TAG, 'Failed to save search history', error as Error);
    }
  }

  /**
   * å¤„ç†æœç´¢è¾“å…¥å˜åŒ–
   */
  private onSearchTextChange(text: string): void {
    this.searchText = text;
    if (text.length > 0) {
      this.showQuickResults = true;
      // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„mediaServiceè·å–å¿«é€Ÿæœç´¢ç»“æ?      this.quickSearch(text);
    } else {
      this.showQuickResults = false;
      this.quickResults = [];
    }
  }

  /**
   * å¿«é€Ÿæœç´?   */
  private quickSearch(keyword: string): void {
    try {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„mediaServiceè·å–å¿«é€Ÿæœç´¢ç»“æ?      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.quickResults = [
        { id: '1', title: `å¿«é€Ÿæœç´¢ç»“æ? - ${keyword}`, type: 'movie', coverUrl: '' },
        { id: '2', title: `å¿«é€Ÿæœç´¢ç»“æ? - ${keyword}`, type: 'tv', coverUrl: '' },
        { id: '3', title: `å¿«é€Ÿæœç´¢ç»“æ? - ${keyword}`, type: 'anime', coverUrl: '' }
      ];
      Logger.info(this.TAG, `Quick search for '${keyword}' returned ${this.quickResults.length} results`);
    } catch (error) {
      Logger.error(this.TAG, 'Quick search failed', error as Error);
      this.quickResults = [];
    }
  }

  /**
   * æ‰§è¡Œæœç´¢
   */
  private async executeSearch(): Promise<void> {
    if (!this.searchText.trim()) return;
    
    try {
      this.isSearching = true;
      this.showQuickResults = false;
      
      // ä¿å­˜æœç´¢å†å²
      await this.saveSearchHistory(this.searchText);
      
      // è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„mediaServiceæ‰§è¡Œæœç´¢
      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.searchResults = [
        { id: '1', title: `æœç´¢ç»“æœ1 - ${this.searchText}`, type: 'movie', coverUrl: '' },
        { id: '2', title: `æœç´¢ç»“æœ2 - ${this.searchText}`, type: 'tv', coverUrl: '' },
        { id: '3', title: `æœç´¢ç»“æœ3 - ${this.searchText}`, type: 'anime', coverUrl: '' },
        { id: '4', title: `æœç´¢ç»“æœ4 - ${this.searchText}`, type: 'movie', coverUrl: '' },
        { id: '5', title: `æœç´¢ç»“æœ5 - ${this.searchText}`, type: 'tv', coverUrl: '' }
      ];
      
      Logger.info(this.TAG, `Search for '${this.searchText}' returned ${this.searchResults.length} results`);
    } catch (error) {
      Logger.error(this.TAG, 'Search failed', error as Error);
      this.searchResults = [];
    } finally {
      this.isSearching = false;
    }
  }

  /**
   * å¤„ç†å¿«é€Ÿæœç´¢ç»“æœç‚¹å‡?   */
  private async handleQuickResultClick(result: any): Promise<void> {
    try {
      // ä¿å­˜æœç´¢å†å²
      await this.saveSearchHistory(this.searchText);
      
      // è·³è½¬åˆ°è¯¦æƒ…é¡µ
      await AppNavigator.getInstance().navigateToDetail({
        id: result.id,
        siteKey: 'default',
        type: result.type
      });
      
      Logger.info(this.TAG, `Navigating to detail for ${result.title}`);
    } catch (error) {
      Logger.error(this.TAG, 'Error handling quick search result click', error as Error);
    }
  }

  /**
   * å¤„ç†æœç´¢ç»“æœç‚¹å‡»
   */
  private async handleSearchResultClick(result: any): Promise<void> {
    try {
      // è·³è½¬åˆ°è¯¦æƒ…é¡µ
      await AppNavigator.getInstance().navigateToDetail({
        id: result.id,
        siteKey: 'default',
        type: result.type
      });
      
      Logger.info(this.TAG, `Navigating to detail for ${result.title}`);
    } catch (error) {
      Logger.error(this.TAG, 'Error handling search result click', error as Error);
    }
  }

  /**
   * å¤„ç†çƒ­é—¨å…³é”®è¯ç‚¹å‡?   */
  private async handleHotKeywordClick(keyword: string): Promise<void> {
    try {
      this.searchText = keyword;
      await this.executeSearch();
      Logger.info(this.TAG, `Searching for hot keyword: ${keyword}`);
    } catch (error) {
      Logger.error(this.TAG, 'Error handling hot keyword click', error as Error);
    }
  }

  /**
   * å¤„ç†æœç´¢å†å²ç‚¹å‡»
   */
  private async handleHistoryClick(keyword: string): Promise<void> {
    try {
      this.searchText = keyword;
      await this.executeSearch();
      Logger.info(this.TAG, `Searching for history keyword: ${keyword}`);
    } catch (error) {
      Logger.error(this.TAG, 'Error handling history click', error as Error);
    }
  }

  /**
   * æ¸…ç©ºæœç´¢å†å²
   */
  private async clearSearchHistory(): Promise<void> {
    try {
      this.searchHistory = [];
      // ä½¿ç”¨SearchHistoryRepositoryæ¸…ç©ºæœ¬åœ°å­˜å‚¨
      const searchHistoryRepo = new SearchHistoryRepository();
      await searchHistoryRepo.clearHistory();
      Logger.info(this.TAG, 'Search history cleared');
    } catch (error) {
      Logger.error(this.TAG, 'Failed to clear search history', error as Error);
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡?   */
  private async handleBack(): Promise<void> {
    try {
      await AppNavigator.getInstance().navigateToBack();
      Logger.info(this.TAG, 'Navigating back');
    } catch (error) {
      Logger.error(this.TAG, 'Failed to navigate back', error as Error);
    }
  }

  /**
   * æ„å»ºæœç´¢æ ?   */
  @Builder
  buildSearchBar(): void {
    Row({
      style: {
        alignItems: 'center',
        padding: { left: 20, right: 20, top: 10, bottom: 10 },
        backgroundColor: '#4CAF50'
      }
    }) {
      // è¿”å›æŒ‰é’®
      Button({
        style: {
          backgroundColor: 'transparent',
          width: 40,
          height: 40,
          justifyContent: 'center',
          alignItems: 'center'
        },
        onClick: () => this.handleBack()
      }) {
        Text('â†?)
          .fontSize(24)
          .fontColor('#FFFFFF')
      }

      // æœç´¢è¾“å…¥æ¡?      Column({
        style: {
          flex: 1,
          marginLeft: 10,
          marginRight: 10
        }
      }) {
        SearchInput({
          placeholder: 'æœç´¢ç”µå½±ã€å‰§é›†ã€åŠ¨æ¼?..',
          style: {
            backgroundColor: '#FFFFFF',
            borderRadius: 20,
            paddingHorizontal: 20,
            height: 40,
            fontSize: 16
          },
          value: this.searchText,
          onSubmit: () => this.executeSearch(),
          onChange: (text) => this.onSearchTextChange(text),
          onClear: () => this.searchText = ''
        })

        // å¿«é€Ÿæœç´¢ç»“æ?        if (this.showQuickResults && this.quickResults.length > 0) {
          Column({
            style: {
              backgroundColor: '#FFFFFF',
              borderRadius: 10,
              marginTop: 5,
              padding: 10,
              shadowColor: '#000000',
              shadowOffsetX: 0,
              shadowOffsetY: 2,
              shadowBlurRadius: 5
            }
          }) {
            ForEach(this.quickResults, (result) => {
              Row({
                style: {
                  padding: 10,
                  borderRadius: 8,
                  backgroundColor: '#F5F5F5',
                  marginBottom: 5,
                  alignItems: 'center'
                },
                onClick: () => this.handleQuickResultClick(result)
              }) {
                Column({
                  style: {
                    marginLeft: 10,
                    flex: 1
                  }
                }) {
                  Text(result.title)
                    .fontSize(16)
                    .fontColor('#333333')
                  Text(result.type)
                    .fontSize(14)
                    .fontColor('#666666')
                    .marginTop(2)
                }
                Text('â†?)
                  .fontSize(18)
                  .fontColor('#999999')
              }
            })
          }
        }
      }

      // æœç´¢æŒ‰é’®
      Button({
        style: {
          backgroundColor: '#FFFFFF',
          paddingHorizontal: 20,
          paddingVertical: 10,
          borderRadius: 20
        },
        onClick: () => this.executeSearch()
      }) {
        Text('æœç´¢')
          .fontSize(16)
          .fontColor('#4CAF50')
          .fontWeight(600)
      }
    }
  }

  /**
   * æ„å»ºæœç´¢å†å²
   */
  @Builder
  buildSearchHistory(): void {
    if (this.searchHistory.length > 0 && this.showHistory) {
      Column({
        style: {
          padding: 20
        }
      }) {
        Row({
          style: {
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: 15
          }
        }) {
          Text('æœç´¢å†å²')
            .fontSize(18)
            .fontColor('#333333')
            .fontWeight(600)
          Button({
            style: {
              backgroundColor: '#FFFFFF',
              paddingHorizontal: 15,
              paddingVertical: 5,
              borderRadius: 15
            },
            onClick: () => this.clearSearchHistory()
          }) {
            Text('æ¸…ç©º')
              .fontSize(14)
              .fontColor('#666666')
          }
        }

        Wrap({
          style: {
            gap: 10
          }
        }) {
          ForEach(this.searchHistory, (keyword) => {
            Button({
              style: {
                backgroundColor: '#FFFFFF',
                paddingHorizontal: 20,
                paddingVertical: 10,
                borderRadius: 20
              },
              onClick: () => this.handleHistoryClick(keyword)
            }) {
              Text(keyword)
                .fontSize(14)
                .fontColor('#333333')
            }
          })
        }
      }
    }
  }

  /**
   * æ„å»ºçƒ­é—¨å…³é”®è¯?   */
  @Builder
  buildHotKeywords(): void {
    if (this.hotKeywords.length > 0 && this.showHotKeywords) {
      Column({
        style: {
          padding: 20
        }
      }) {
        Row({
          style: {
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: 15
          }
        }) {
          Text('çƒ­é—¨æœç´¢')
            .fontSize(18)
            .fontColor('#333333')
            .fontWeight(600)
        }

        Wrap({
          style: {
            gap: 10
          }
        }) {
          ForEach(this.hotKeywords, (keyword) => {
            Button({
              style: {
                backgroundColor: '#66BB6A',
                paddingHorizontal: 20,
                paddingVertical: 10,
                borderRadius: 20
              },
              onClick: () => this.handleHotKeywordClick(keyword)
            }) {
              Text(keyword)
                .fontSize(14)
                .fontColor('#FFFFFF')
            }
          })
        }
      }
    }
  }

  /**
   * æ„å»ºæœç´¢ç»“æœ
   */
  @Builder
  buildSearchResults(): void {
    if (this.isSearching) {
      Column({
        style: {
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center'
        }
      }) {
        Text('æœç´¢ä¸?..')
          .fontSize(18)
          .fontColor('#666666')
      }
    } else if (this.searchResults.length > 0) {
      Column({
        style: {
          flex: 1,
          padding: 20
        }
      }) {
        Text(`æœç´¢ç»“æœ (${this.searchResults.length})`)
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(600)
          .marginBottom(15)

        ForEach(this.searchResults, (result) => {
          Row({
            style: {
              padding: 15,
              backgroundColor: '#FFFFFF',
              borderRadius: 10,
              marginBottom: 15,
              alignItems: 'center',
              shadowColor: '#000000',
              shadowOffsetX: 0,
              shadowOffsetY: 2,
              shadowBlurRadius: 5
            },
            onClick: () => this.handleSearchResultClick(result)
          }) {
            // å ä½å°é¢
            Column({
              style: {
                width: 80,
                height: 120,
                backgroundColor: '#E0E0E0',
                borderRadius: 5,
                justifyContent: 'center',
                alignItems: 'center'
              }
            }) {
              Text('å°é¢')
                .fontSize(14)
                .fontColor('#999999')
            }

            Column({
              style: {
                marginLeft: 15,
                flex: 1
              }
            }) {
              Text(result.title)
                .fontSize(16)
                .fontColor('#333333')
                .fontWeight(600)
              Text(result.type)
                .fontSize(14)
                .fontColor('#666666')
                .marginTop(5)
            }
            Text('â†?)
              .fontSize(20)
              .fontColor('#999999')
          }
        })
      }
    } else if (this.searchText.trim()) {
      Column({
        style: {
          flex: 1,
          justifyContent: 'center',
          alignItems: 'center',
          padding: 20
        }
      }) {
        Text('æœªæ‰¾åˆ°ç›¸å…³ç»“æ?)
          .fontSize(18)
          .fontColor('#666666')
        Text('è¯·å°è¯•å…¶ä»–å…³é”®è¯')
          .fontSize(16)
          .fontColor('#999999')
          .marginTop(10)
      }
    }
  }

  build() {
    Column({
      style: {
        flex: 1,
        backgroundColor: '#F5F5F5'
      }
    }) {
      // æœç´¢æ ?      this.buildSearchBar();

      // ä¸»ä½“å†…å®¹
      if (this.searchText.trim()) {
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        this.buildSearchResults();
      } else {
        // æ˜¾ç¤ºæœç´¢å†å²å’Œçƒ­é—¨å…³é”®è¯
        Scroll({
          style: {
            flex: 1
          }
        }) {
          Column({
            style: {
              backgroundColor: '#F5F5F5'
            }
          }) {
            this.buildSearchHistory();
            this.buildHotKeywords();
          }
        }
      }
    }
  }
}
