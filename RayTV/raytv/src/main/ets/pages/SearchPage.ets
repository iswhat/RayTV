
import { Router } from '@ohos.router';
import Logger from '../common/util/Logger';
import { MediaItem } from '../data/bean/MediaItem';
import { SearchHistoryItem } from '../../data/repository/SearchHistoryRepository';
import { mediaService } from '../service/media/MediaService';
import { SearchType, SearchFilter, SearchSort } from '../data/dto/SearchDto';
import { siteManager } from '../service/spider/SiteManager';
import { lineManager } from '../service/config/LineManager';

// Âø´ÈÄüÊêúÁ¥¢ÁªìÊûúÊé•Âè£
interface QuickSearchResult {
  id: string;
  title: string;
  quality: string;
  sourceType: string;
}

/**
 * ÊêúÁ¥¢È°µÈù¢ÁªÑ‰ª∂
 * ÂÆûÁé∞Â™í‰ΩìÊêúÁ¥¢ÂäüËÉΩÔºåÂåÖÊã¨ÊêúÁ¥¢ËæìÂÖ•„ÄÅÁªìÊûúÂ±ïÁ§∫„ÄÅÂéÜÂè≤ÊêúÁ¥¢Á≠â
 */
@Component
struct SearchPage {
  private readonly TAG: string = 'SearchPage';
  
  // Áä∂ÊÄÅÁÆ°ÁêÜ
  @State searchQuery: string = '';
  @State searchResults: MediaItem[] = [];
  @State hotKeywords: string[] = [];
  @State searchHistory: SearchHistoryItem[] = [];
  @State isLoading: boolean = false;
  @State isSearching: boolean = false;
  @State errorMessage: string = '';
  @State currentPage: number = 1;
  @State hasMoreResults: boolean = true;
  @State showHistory: boolean = true;
  @State displayMode: 'list' | 'grid' = 'list'; // ÊòæÁ§∫Ê®°ÂºèÔºöÂàóË°®ÊàñÁΩëÊ†º
  @State showFilterPanel: boolean = false; // ÊòØÂê¶ÊòæÁ§∫Á≠õÈÄâÈù¢Êùø
  @State filters: SearchFilter = {}; // ÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂
  @State showSourceList: boolean = false; // ÊòØÂê¶ÊòæÁ§∫Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫êÂàóË°®
  @State quickSearchResults: QuickSearchResult[] = []; // Âø´ÈÄüÊêúÁ¥¢ÁªìÊûú
  
  // ÂàÜÈ°µÈÖçÁΩÆ
  private pageSize: number = 20;
  private searchDebounceTimer: number | null = null;
  
  /**
   * È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®
   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'SearchPage appeared');
    
    // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞‰∏≠ÁöÑÊêúÁ¥¢ËØç
    const params = Router.getParams();
    if (params?.['query']) {
      this.searchQuery = params['query'];
      this.performSearch();
    } else {
      // Âä†ËΩΩÁÉ≠Èó®ÊêúÁ¥¢ËØç
      this.loadHotKeywords();
    }
    
    // Âä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤
    this.loadSearchHistory();
  }
  
  /**
   * È°µÈù¢Âç∏ËΩΩÊó∂Ë∞ÉÁî®
   */
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'SearchPage disappeared');
    
    // Ê∏ÖÁêÜÂÆöÊó∂Âô®
    if (this.searchDebounceTimer) {
      clearTimeout(this.searchDebounceTimer);
    }
  }
  
  /**
   * Âä†ËΩΩÁÉ≠Èó®ÊêúÁ¥¢ËØç
   */
  private loadHotKeywords(): void {
    try {
      mediaService.getHotSearchKeywords(10).then((data) => {
        this.hotKeywords = data;
        Logger.info(this.TAG, `Loaded ${this.hotKeywords.length} hot keywords`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load hot keywords: ${error}`);
      // ‰ΩøÁî®ÈªòËÆ§ÁÉ≠Èó®ÂÖ≥ÈîÆËØç
      this.hotKeywords = ['ÁÉ≠Èó®ÁîµÂΩ±', 'ÊúÄÊñ∞ÂâßÈõÜ', 'ÁªèÂÖ∏Âä®Êº´', 'ÁßëÂπªÂ§ßÁâá', 'Áà±ÊÉÖÂñúÂâß'];
    }
  }
  
  /**
   * Âä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤
   */
  private loadSearchHistory(): void {
    try {
      // ËøôÈáåÂ∫îËØ•‰ªéÊú¨Âú∞Â≠òÂÇ®‰∏≠ËØªÂèñÊêúÁ¥¢ÂéÜÂè≤
      // ÊöÇÊó∂‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
      const history = ['Â§ç‰ªáËÄÖËÅîÁõü', 'Êµ∑Ë¥ºÁéã', 'ÊòüÈôÖÁ©øË∂ä'];
      this.searchHistory = history;
      Logger.info(this.TAG, `Loaded ${this.searchHistory.length} search history items`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to load search history: ${error}`);
      this.searchHistory = [];
    }
  }
  
  /**
   * ‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤
   */
  private saveSearchHistory(keyword: string): void {
    try {
      // ÂéªÈáçÂπ∂ÈôêÂà∂Êï∞Èáè
      let history = this.searchHistory.filter(item => item !== keyword);
      history.unshift(keyword);
      history = history.slice(0, 10); // ÊúÄÂ§ö‰øùÂ≠ò10Êù°
      
      this.searchHistory = history;
      
      // ËøôÈáåÂ∫îËØ•‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
      Logger.info(this.TAG, `Search history saved: ${keyword}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to save search history: ${error}`);
    }
  }
  
  /**
   * Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫ê
   */
  private quickSearch(keyword: string): void {
    try {
      // Ëé∑Âèñ‰ªéÁ∫øË∑ØÈÖçÁΩÆÊñá‰ª∂Âä†ËΩΩÁöÑÁúüÂÆûÁ´ôÁÇπÂàóË°®
      const sites = siteManager.getAllSites();
      
      // ‰ΩøÁî®ÁúüÂÆûÁ´ôÁÇπ‰ø°ÊÅØÁîüÊàêÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
      this.quickSearchResults = [];
      
      // Â¶ÇÊûúÊúâÁ´ôÁÇπÔºå‰ΩøÁî®ÁúüÂÆûÁ´ôÁÇπ‰ø°ÊÅØ
      if (sites.length > 0) {
        sites.forEach((site) => {
          // Á°Æ‰øùÁ´ôÁÇπ‰ø°ÊÅØÊúâÊïà‰∏îÂèØÊêúÁ¥¢
          if (site && site.enabled !== false && (site.searchable === true || site.quickSearch === 1)) {
            // Â∞ùËØïËé∑ÂèñÁ´ôÁÇπÂêçÁß∞ÔºåÂ¶ÇÊûúÂêçÁß∞‰∏çÂ≠òÂú®Âàô‰ΩøÁî®key‰Ωú‰∏∫Â§áÁî®
            const siteName = site.name || site.key || 'Êú™Áü•Á´ôÁÇπ';
            
            this.quickSearchResults.push({
              id: `${keyword}-${site.key || Math.random().toString(36).substr(2, 9)}`,
              title: `${keyword} - ${siteName}`,
              quality: site.quality || 'È´òÊ∏Ö',
              sourceType: siteName
            });
          }
        });
        
        // Â¶ÇÊûú‰ªéÁ´ôÁÇπÂàóË°®‰∏≠Ê≤°ÊúâËé∑ÂèñÂà∞ÂèØÊêúÁ¥¢ÁöÑÁ´ôÁÇπÔºåÊ∑ªÂä†‰∏Ä‰∫õÈªòËÆ§Á´ôÁÇπ
        if (this.quickSearchResults.length === 0) {
          this.addDefaultQuickSearchResults(keyword);
        }
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâÁ´ôÁÇπ‰ø°ÊÅØÔºå‰ΩøÁî®Â§áÁî®ÁöÑÈªòËÆ§Á´ôÁÇπ
        this.addDefaultQuickSearchResults(keyword);
      }
      
      // ÈôêÂà∂ÁªìÊûúÊï∞ÈáèÔºåÈÅøÂÖçÊòæÁ§∫ËøáÂ§ö
      this.quickSearchResults = this.quickSearchResults.slice(0, 10);
      
      // ÊòæÁ§∫Âø´ÈÄüÊêúÁ¥¢ÁªìÊûú
      this.showSourceList = true;
      Logger.info(this.TAG, `Quick search for: ${keyword}, results: ${this.quickSearchResults.length}`);
      
      // Ëé∑ÂèñÂΩìÂâçÁ∫øË∑Ø‰ø°ÊÅØÂπ∂ËÆ∞ÂΩïÊó•Âøó
      const currentLine = lineManager.getCurrentLine();
      if (currentLine) {
        Logger.info(this.TAG, `Current line: ${currentLine.name || 'Êú™Áü•ÂêçÁß∞'}, sources loaded from: ${currentLine.url}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Quick search failed: ${JSON.stringify(error)}`);
      // Âç≥‰ΩøÂá∫ÈîôÔºå‰πüÊ∑ªÂä†‰∏Ä‰∫õÈªòËÆ§Á´ôÁÇπ‰æõÁî®Êà∑ÈÄâÊã©
      this.quickSearchResults = [];
      this.addDefaultQuickSearchResults(keyword);
      this.showSourceList = this.quickSearchResults.length > 0;
    }
  }
  
  /**
   * Ê∑ªÂä†ÈªòËÆ§ÁöÑÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
   */
  private addDefaultQuickSearchResults(keyword: string): void {
    // ‰ªéÂÖ∏ÂûãÁ∫øË∑ØÈÖçÁΩÆ‰∏≠ÊèêÂèñÁöÑÂ∏∏ËßÅÁ´ôÁÇπÂàóË°®
    const defaultSources = [
      {key: 'lebei', name: '‰πêË¥ùËßÜÈ¢ë'},
      {key: 'qimi', name: 'Â•áÁ±≥ÂΩ±ËßÜ'},
      {key: 'jiumo', name: '‰πùÁå´ÂΩ±ËßÜ'},
      {key: 'yiso', name: 'ÊòìÂèëÂΩ±ËßÜ'},
      {key: 'lengfan', name: 'ÂÜ∑Áï™ÂΩ±ËßÜ'},
      {key: 'jinlian', name: 'ÈáëÊøÇËßÜÈ¢ë'},
      {key: 'miaofan', name: 'ÁßíÁï™ÂΩ±ËßÜ'},
      {key: 'zhuifan', name: 'ËøΩÁï™ËßÜÈ¢ë'},
      {key: 'kanfan', name: 'ÁúãÁï™ËßÜÈ¢ë'},
      {key: 'haokan', name: 'Â•ΩÁúãËßÜÈ¢ë'}
    ];
    
    defaultSources.forEach((source) => {
      this.quickSearchResults.push({
        id: `${keyword}-${source.key}`,
        title: `${keyword} - ${source.name}`,
        quality: 'È´òÊ∏ÖÂÖ®Áâá',
        sourceType: source.name
      });
    });
  }

  /**
   * Â§ÑÁêÜÂø´ÈÄüÊêúÁ¥¢ÁªìÊûúÁÇπÂáª‰∫ã‰ª∂
   */
  private handleQuickSearchResultClick(result: QuickSearchResult): void {
    try {
      Logger.info(this.TAG, `Quick search result clicked: ${JSON.stringify(result)}`);
      
      // ÈöêËóèÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
      this.showSourceList = false;
      
      // Ë∑≥ËΩ¨Âà∞MediaDetailPageÈ°µÈù¢ÔºåÊê∫Â∏¶Áõ∏ÂÖ≥ÂèÇÊï∞
      Router.pushUrl({
        url: 'pages/MediaDetailPage',
        params: {
          title: result.title,
          sourceId: result.id,
          sourceType: result.sourceType,
          mediaType: 'video',
          keyword: this.searchText,
          // ‰º†ÈÄíÁ´ôÁÇπ‰ø°ÊÅØÔºå‰ª•‰æøÂú®ËØ¶ÊÉÖÈ°µËÉΩÂ§ü‰ΩøÁî®Ê≠£Á°ÆÁöÑÊêúÁ¥¢Ê∫ê
          siteName: result.sourceType,
          // ËÆ∞ÂΩïÂΩìÂâç‰ΩøÁî®ÁöÑÁ∫øË∑Ø‰ø°ÊÅØ
          currentLine: lineManager.getCurrentLine() ? lineManager.getCurrentLine().name : 'Default'
        }
      });
      
      // ËÆ∞ÂΩïÊêúÁ¥¢ÂéÜÂè≤
      this.saveSearchHistory(this.searchText);
    } catch (error) {
      Logger.error(this.TAG, `Error handling quick search result click: ${error}`);
    }
  }

  /**
   * Ê∏ÖÈô§ÊêúÁ¥¢ÂéÜÂè≤
   */
  private clearSearchHistory(): void {
    try {
      this.searchHistory = [];
      // ËøôÈáåÂ∫îËØ•Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®‰∏≠ÁöÑÊêúÁ¥¢ÂéÜÂè≤
      Logger.info(this.TAG, 'Search history cleared');
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear search history: ${error}`);
    }
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢ËæìÂÖ•ÂèòÂåñ
   */
  private handleSearchInputChange(value: string): void {
    this.searchQuery = value;
    
    // Èò≤ÊäñÂ§ÑÁêÜ
    if (this.searchDebounceTimer) {
      clearTimeout(this.searchDebounceTimer);
    }
    
    // ËæìÂÖ•‰∏∫Á©∫Êó∂ÈáçÁΩÆÁä∂ÊÄÅ
    if (value.trim().length === 0) {
      this.resetSearchState();
      this.showSourceList = false;
      return;
    }
    
    // Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫êÔºàÂΩìËæìÂÖ•ËææÂà∞‰∏ÄÂÆöÈïøÂ∫¶Êó∂Ôºâ
    if (value.trim().length >= 2) {
      // Á´ãÂç≥ÊâßË°åÂø´ÈÄüÊêúÁ¥¢
      this.quickSearch(value.trim());
      
      // ËæìÂÖ•ÂÅúÊ≠¢300msÂêéÊâßË°åÂ∏∏ËßÑÊêúÁ¥¢
      this.searchDebounceTimer = setTimeout(() => {
        this.performSearch();
      }, 300);
    }
  }
  
  /**
   * ÊâßË°åÊêúÁ¥¢
   */
  private performSearch(): void {
    const query = this.searchQuery.trim();
    if (!query) return;
    
    // ÈöêËóèÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
    this.showSourceList = false;
    
    this.isSearching = true;
    this.isLoading = true;
    this.errorMessage = '';
    this.showHistory = false;
    this.currentPage = 1;
    
    try {
      // ‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤
      this.saveSearchHistory(query);
      
      // ÊâßË°åÊêúÁ¥¢Ôºå‰º†ÈÄíÁ≠õÈÄâÊù°‰ª∂
      Logger.info(this.TAG, `Searching for: ${query} with filters:`, JSON.stringify(this.filters));
      
      // ÊûÑÂª∫ÊêúÁ¥¢ÂèÇÊï∞ÔºåÂåÖÂê´Á≠õÈÄâÊù°‰ª∂
      const searchParams = {
        keyword: query,
        type: SearchType.All,
        page: this.currentPage,
        pageSize: this.pageSize,
        ...this.filters // ÂêàÂπ∂Á≠õÈÄâÊù°‰ª∂
      };
      
      mediaService.searchMedia(searchParams).then((result) => {
        // Â§ÑÁêÜÊêúÁ¥¢ÁªìÊûú
        this.searchResults = result.items || [];
        this.hasMoreResults = result.hasMore || false;
        
        Logger.info(this.TAG, `Search completed, found ${this.searchResults.length} results`);
        this.isLoading = false;
        this.isSearching = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Search failed: ${error}`);
        this.errorMessage = 'ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
        this.searchResults = [];
        this.hasMoreResults = false;
        this.isLoading = false;
        this.isSearching = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Search failed: ${error}`);
      this.errorMessage = 'ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
      this.searchResults = [];
      this.hasMoreResults = false;
      this.isLoading = false;
      this.isSearching = false;
    }
  }
  
  /**
   * Âä†ËΩΩÊõ¥Â§öÊêúÁ¥¢ÁªìÊûú
   */
  private loadMoreResults(): void {
    if (!this.hasMoreResults || this.isLoading || !this.searchQuery.trim()) return;
    
    this.isLoading = true;
    this.currentPage++;
    
    try {
      const query = this.searchQuery.trim();
      Logger.info(this.TAG, `Loading more results for: ${query}, page ${this.currentPage}`);
      
      // ÊûÑÂª∫ÊêúÁ¥¢ÂèÇÊï∞ÔºåÂåÖÂê´Á≠õÈÄâÊù°‰ª∂
      const searchParams = {
        keyword: query,
        type: SearchType.All,
        page: this.currentPage,
        pageSize: this.pageSize,
        ...this.filters // ÂêàÂπ∂Á≠õÈÄâÊù°‰ª∂
      };
      
      mediaService.searchMedia(searchParams).then((result) => {
        if (result && result.items && result.items.length > 0) {
          this.searchResults = [...this.searchResults, ...result.items];
          this.hasMoreResults = result.hasMore || false;
        } else {
          this.hasMoreResults = false;
        }
        this.isLoading = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load more results: ${error}`);
        this.errorMessage = 'Âä†ËΩΩÊõ¥Â§öÁªìÊûúÂ§±Ë¥•';
        this.isLoading = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load more results: ${error}`);
      this.errorMessage = 'Âä†ËΩΩÊõ¥Â§öÁªìÊûúÂ§±Ë¥•';
      this.isLoading = false;
    }
  }
  
  /**
   * ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅ
   */
  private resetSearchState(): void {
    this.searchResults = [];
    this.showHistory = true;
    this.errorMessage = '';
    this.currentPage = 1;
    this.hasMoreResults = true;
  }
  
  /**
   * Â§ÑÁêÜÂÖ≥ÈîÆËØçÁÇπÂáª
   */
  private handleKeywordClick(keyword: string): void {
    this.searchQuery = keyword;
    this.performSearch();
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢ÁªìÊûúÈ°πÁÇπÂáª
   */
  private handleSearchResultClick(media: MediaItem): void {
    if (!media || !media.id) {
      Logger.error(this.TAG, `Invalid media item: ${JSON.stringify(media)}`);
      return;
    }
    
    Logger.info(this.TAG, `Search result clicked: ${media.title}`);
    
    // Ë∑≥ËΩ¨Âà∞‰ªäÊó•ËØ¶ÊÉÖÈ°µ
    Router.pushUrl({
      url: 'pages/MediaDetailPage',
      params: {
        mediaId: media.id,
        siteKey: media.siteKey || '',
        title: media.title || '',
        coverUrl: media.coverUrl || '',
        description: media.description || '',
        year: media.year || '',
        type: media.type || '',
        score: media.score || '',
        directors: media.directors || [],
        actors: media.actors || []
      }
    });
  }
  
  /**
   * Â§ÑÁêÜÊ∏ÖÈô§ÊåâÈíÆÁÇπÂáª
   */
  private handleClearInput(): void {
    this.searchQuery = '';
    this.resetSearchState();
  }
  
  /**
   * Â§ÑÁêÜËøîÂõû
   */
  private handleBack(): void {
    Router.back();
  }
  
  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ËæìÂÖ•Ê°Ü
   */
  @Builder
  private renderSearchInput(): void {
    Stack.create();
    Stack.className("search-input-container");
    Button.create();
    Button.className("back-button");
    Button.onClick(this.handleBack);
    Text.create();
    Text.content("‚Üê");
    Text.pop();
    Button.pop();
    Flex.create();
    Flex.className("search-input-wrapper");
    Text.create();
    Text.className("search-icon");
    Text.content("üîç");
    Text.pop();
    TextInput.create();
    TextInput.className("search-input");
    TextInput.value(this.searchQuery);
    TextInput.onChange(this.handleSearchInputChange);
    TextInput.onSubmit(this.performSearch);
    TextInput.placeholder("ÊêúÁ¥¢ÁîµÂΩ±„ÄÅÁîµËßÜÂâß„ÄÅÂä®Êº´...");
    TextInput.enterKeyType("search");
    TextInput.autoFocus(true);
    TextInput.pop();
    if (this.searchQuery) {
      Button.create();
      Button.className("clear-button");
      Button.onClick(this.handleClearInput);
      Text.create();
      Text.content("‚úï");
      Text.pop();
      Button.pop();
    }
    Flex.pop();
    Button.create();
    Button.className("search-button");
    Button.onClick(this.performSearch);
    Text.create();
    Text.content("ÊêúÁ¥¢");
    Text.pop();
    Button.pop();
    Stack.pop();
  }
  
  /**
   * Ê∏≤ÊüìÁÉ≠Èó®ÊêúÁ¥¢
   */
  @Builder
  private renderHotKeywords(): void {
    Stack.create();
    Stack.className("hot-keywords-section");
    Flex.create();
    Flex.className("section-header");
    Text.create();
    Text.className("section-title");
    Text.content("ÁÉ≠Èó®ÊêúÁ¥¢");
    Text.pop();
    Flex.pop();
    Flex.create();
    Flex.className("keywords-container");
    Flex.wrap("wrap");
    this.hotKeywords.forEach((keyword, index) => {
      Tag.create();
      Tag.key(`hot-${index}`);
      Tag.className("keyword-tag hot");
      Tag.onClick(() => this.handleKeywordClick(keyword));
      Text.create();
      Text.className("keyword-rank");
      Text.content((index + 1).toString());
      Text.pop();
      Text.create();
      Text.content(keyword);
      Text.pop();
      Tag.pop();
    });
    Flex.pop();
    Stack.pop();
  }
  
  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ÂéÜÂè≤
   */
  @Builder
  private renderSearchHistory(): void {
    if (this.searchHistory.length === 0) return;
    
    Stack.create();
    Stack.className("search-history-section");
    Flex.create();
    Flex.className("section-header");
    Text.create();
    Text.className("section-title");
    Text.content("ÊêúÁ¥¢ÂéÜÂè≤");
    Text.pop();
    Button.create();
    Button.className("clear-history-button");
    Button.onClick(this.clearSearchHistory);
    Text.create();
    Text.content("Ê∏ÖÈô§");
    Text.pop();
    Button.pop();
    Flex.pop();
    Flex.create();
    Flex.className("keywords-container");
    Flex.wrap("wrap");
    this.searchHistory.forEach((keyword, index) => {
      Tag.create();
      Tag.key(`history-${index}`);
      Tag.className("keyword-tag history");
      Tag.onClick(() => this.handleKeywordClick(keyword));
      Text.create();
      Text.className("history-icon");
      Text.content("üïê");
      Text.pop();
      Text.create();
      Text.content(keyword);
      Text.pop();
      Tag.pop();
    });
    Flex.pop();
    Stack.pop();
  }
  
  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûúÈ°π
   */
  @Builder
  private renderSearchResultItem(media: MediaItem): void {
    ListItem.create();
    ListItem.onClick(() => this.handleSearchResultClick(media));
    Flex.create();
    Flex.className("search-result-item");
    Image.create();
    Image.src(media.coverUrl || "https://via.placeholder.com/100x150?text=No+Image");
    Image.className("result-cover");
    Image.objectFit("cover");
    Image.pop();
    Flex.create();
    Flex.className("result-info");
    Flex.direction("column");
    Text.create();
    Text.className("result-title");
    Text.numberOfLines(2);
    Text.content(media.title);
    Text.pop();
    Flex.create();
    Flex.className("result-meta");
    if (media.year) {
      Tag.create();
      Tag.className("meta-tag");
      Text.create();
      Text.content(media.year);
      Text.pop();
      Tag.pop();
    }
    if (media.type) {
      Tag.create();
      Tag.className("meta-tag");
      Text.create();
      Text.content(media.type);
      Text.pop();
      Tag.pop();
    }
    if (media.score) {
      Tag.create();
      Tag.className("meta-tag score");
      Text.create();
      Text.content(media.score);
      Text.pop();
      Tag.pop();
    }
    Flex.pop();
    if (media.description) {
      Text.create();
      Text.className("result-description");
      Text.numberOfLines(2);
      Text.content(media.description);
      Text.pop();
    }
    if (media.directors && media.directors.length > 0) {
      Text.create();
      Text.className("result-directors");
      Text.numberOfLines(1);
      Text.content(`ÂØºÊºî: ${media.directors.slice(0, 3).join(', ')}`);
      Text.pop();
    }
    if (media.actors && media.actors.length > 0) {
      Text.create();
      Text.className("result-actors");
      Text.numberOfLines(1);
      Text.content(`‰∏ªÊºî: ${media.actors.slice(0, 3).join(', ')}`);
      Text.pop();
    }
    Flex.pop();
    Flex.pop();
    ListItem.pop();
  }
  
  /**
   * Ê∏≤ÊüìÊòæÁ§∫Ê®°ÂºèÂàáÊç¢ÊåâÈíÆ
   */
  @Builder
  private renderDisplayModeToggle(): void {
    Button.create();
    Button.className("display-mode-toggle");
    Button.onClick(this.toggleDisplayMode);
    Button.type("circle");
    Button.size("small");
    Text.create();
    Text.content(this.displayMode === 'list' ? 'ÁΩëÊ†º' : 'ÂàóË°®');
    Text.pop();
    Button.pop();
  }
  
  /**
   * Ê∏≤ÊüìÁ≠õÈÄâÊåâÈíÆ
   */
  @Builder
  private renderFilterButton(): void {
    Button.create();
    Button.className("filter-button");
    Button.onClick(this.toggleFilterPanel);
    Button.type("text");
    Button.size("small");
    Text.create();
    Text.content("Á≠õÈÄâ");
    Text.pop();
    Button.pop();
  }
  
  /**
   * Ê∏≤ÊüìÁ≠õÈÄâÈù¢Êùø
   */
  @Builder
  private renderFilterPanel(): void {
    if (!this.showFilterPanel) return;
    
    Stack.create();
    Stack.className("filter-panel-overlay");
    Stack.onClick(this.toggleFilterPanel);
    Stack.create();
    Stack.className("filter-panel");
    Stack.onClick((e) => e.stopPropagation());
    Stack.create();
    Stack.className("filter-header");
    Text.create();
    Text.className("filter-title");
    Text.content("Á≠õÈÄâÊù°‰ª∂");
    Text.pop();
    Button.create();
    Button.onClick(this.toggleFilterPanel);
    Button.type("text");
    Button.size("small");
    Button.pop();
    Stack.pop();
    
    ScrollView.create();
    ScrollView.className("filter-content");
    // Â™í‰ΩìÁ±ªÂûãÁ≠õÈÄâ
    Stack.create();
    Stack.className("filter-section");
    Text.create();
    Text.className("filter-section-title");
    Text.content("Â™í‰ΩìÁ±ªÂûã");
    Text.pop();
    Flex.create();
    Flex.className("filter-options");
    CheckboxGroup.create();
    Checkbox.create();
    Checkbox.value("movie");
    Checkbox.onChange((value) => this.updateMediaTypeFilter('movie', value));
    Text.create();
    Text.content("ÁîµÂΩ±");
    Text.pop();
    Checkbox.pop();
    Checkbox.create();
    Checkbox.value("tv");
    Checkbox.onChange((value) => this.updateMediaTypeFilter('tv', value));
    Text.create();
    Text.content("ÁîµËßÜÂâß");
    Text.pop();
    Checkbox.pop();
    Checkbox.create();
    Checkbox.value("anime");
    Checkbox.onChange((value) => this.updateMediaTypeFilter('anime', value));
    Text.create();
    Text.content("Âä®Êº´");
    Text.pop();
    Checkbox.pop();
    Checkbox.create();
    Checkbox.value("variety");
    Checkbox.onChange((value) => this.updateMediaTypeFilter('variety', value));
    Text.create();
    Text.content("ÁªºËâ∫");
    Text.pop();
    Checkbox.pop();
    CheckboxGroup.pop();
    Flex.pop();
    Stack.pop();
    
    // ÊéíÂ∫èÊñπÂºè
    Stack.create();
    Stack.className("filter-section");
    Text.create();
    Text.className("filter-section-title");
    Text.content("ÊéíÂ∫èÊñπÂºè");
    Text.pop();
    RadioGroup.create();
    RadioGroup.onChange((value) => {
      this.filters.sortBy = value;
    });
    Radio.create();
    Radio.value("time");
    Text.create();
    Text.content("ÊúÄÊñ∞");
    Text.pop();
    Radio.pop();
    Radio.create();
    Radio.value("score");
    Text.create();
    Text.content("ËØÑÂàÜ");
    Text.pop();
    Radio.pop();
    Radio.create();
    Radio.value("hot");
    Text.create();
    Text.content("ÁÉ≠Â∫¶");
    Text.pop();
    Radio.pop();
    RadioGroup.pop();
    Stack.pop();
    ScrollView.pop();
    
    Stack.create();
    Stack.className("filter-actions");
    Button.create();
    Button.onClick(this.resetFilters);
    Button.type("text");
    Text.create();
    Text.content("ÈáçÁΩÆ");
    Text.pop();
    Button.pop();
    Button.create();
    Button.onClick(this.applyFilters);
    Button.type("capsule");
    Text.create();
    Text.content("Â∫îÁî®Á≠õÈÄâ");
    Text.pop();
    Button.pop();
    Stack.pop();
    Stack.pop();
    Stack.pop();
  }

  /**
   * Êõ¥Êñ∞Â™í‰ΩìÁ±ªÂûãÁ≠õÈÄâ
   */
  private updateMediaTypeFilter(type: string, checked: boolean): void {
    if (!this.filters.types) {
      this.filters.types = [];
    }
    
    if (checked) {
      if (!this.filters.types.includes(type)) {
        this.filters.types.push(type);
      }
    } else {
      const index = this.filters.types.indexOf(type);
      if (index > -1) {
        this.filters.types.splice(index, 1);
      }
    }
  }

  /**
   * Ê∏≤ÊüìÁΩëÊ†ºÊ®°ÂºèÁöÑÊêúÁ¥¢ÁªìÊûúÈ°π
   */
  @Builder
  private renderGridItem(item: MediaItem): void {
    if (!item) return;
    
    GridItem.create();
    GridItem.className("green-grid-item");
    GridItem.onClick(() => this.handleSearchResultClick(item));
    Stack.create();
    Stack.className("green-grid-item-content");
    
    // Êù•Ê∫êÊ†áÁ≠æ - Êîπ‰∏∫ÁªøËâ≤‰∏ªÈ¢ò
    if (item.siteKey) {
      Text.create();
      Text.style({
        backgroundColor: '#4CAF50',
        color: '#FFFFFF',
        fontSize: 16,
        paddingHorizontal: 8,
        paddingVertical: 4,
        borderRadius: 4,
        position: 'absolute',
        top: 8,
        left: 8,
        zIndex: 10,
        fontWeight: 600
      });
      Text.content(`${item.siteKey} | APP`);
      Text.pop();
    }
    
    // ÂõæÁâá
    Image.create();
    Image.style({
      width: '100%',
      aspectRatio: 2/3,
      borderRadius: 8
    });
    Image.src(item.coverUrl || "https://via.placeholder.com/200x300?text=No+Image");
    Image.objectFit("cover");
    Image.pop();
    
    // Ê†áÈ¢ò
    Text.create();
    Text.style({
      fontSize: 20,
      color: '#FFFFFF',
      marginTop: 8,
      fontWeight: 600,
      textShadowColor: 'rgba(0, 0, 0, 0.8)',
      textShadowOffset: {
        dx: 1,
        dy: 1
      },
      textShadowRadius: 3
    });
    Text.numberOfLines(2);
    Text.content(item.title || 'Êú™Áü•Ê†áÈ¢ò');
    Text.pop();
    
    // ËØÑÂàÜÊ†áÁ≠æ - Â¶ÇÊûúÊúâËØÑÂàÜÂàôÊòæÁ§∫
    if (item.score) {
      Text.create();
      Text.style({
        backgroundColor: '#FFEB3B',
        color: '#000000',
        fontSize: 16,
        paddingHorizontal: 8,
        paddingVertical: 2,
        borderRadius: 4,
        marginTop: 4,
        fontWeight: 700
      });
      Text.content(`${item.score}ÂàÜ`);
      Text.pop();
    }
    
    Stack.pop();
    GridItem.pop();
  }

  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûú
   */
  @Builder
  private renderSearchResults(): void {
    // Ê∏≤ÊüìÂàÜÁ±ªÁ≠õÈÄâÊåâÈíÆ
    ScrollView.create();
    ScrollView.style({
      whiteSpace: 'nowrap',
      marginBottom: 20
    });
    Flex.create();
    Flex.style({
      paddingHorizontal: 15,
      alignItems: 'center',
      gap: 10
    });
    
    // ÂÖ®ÈÉ®ÊòæÁ§∫ÊåâÈíÆ
    Button.create();
    Button.style({
      backgroundColor: '#4CAF50',
      borderRadius: 20,
      paddingHorizontal: 20,
      paddingVertical: 8,
      marginRight: 10
    });
    Button.onClick(() => {});
    Text.create();
    Text.style({
      fontSize: 22,
      color: '#FFFFFF',
      fontWeight: 600
    });
    Text.content("ÂÖ®ÈÉ®ÊòæÁ§∫");
    Text.pop();
    Button.pop();
    
    // ÂàÜÁ±ªÊåâÈíÆ
    const categories = ["ÁÉ≠Êí≠ | APP", "Êµ™ÈÖ∑ | APP", "ÁßíÁúã | APP", "ÊòüÁ©∫ | APP", "Áà±Áúã | APP", "ÂÜ∑ÂøÉ | APP"];
    categories.forEach((category) => {
      Button.create();
      Button.style({
        backgroundColor: '#FFFFFF',
        borderRadius: 20,
        paddingHorizontal: 20,
        paddingVertical: 8,
        marginRight: 10
      });
      Button.onClick(() => {});
      Text.create();
      Text.style({
        fontSize: 22,
        color: '#4CAF50',
        fontWeight: 600
      });
      Text.content(category);
      Text.pop();
      Button.pop();
    });
    Flex.pop();
    ScrollView.pop();
    
    // Ê∏≤ÊüìÁΩëÊ†ºÁªìÊûú
    Grid.create();
    Grid.style({
      paddingHorizontal: 15,
      gap: 15
    });
    Grid.columnsTemplate("1fr 1fr 1fr 1fr 1fr");
    Grid.rowsTemplate("auto");
    
    if (this.searchResults.length === 0) {
      // Êó†ÊêúÁ¥¢ÁªìÊûúÊó∂ÁöÑÊèêÁ§∫
      GridItem.create();
      GridItem.style({
        gridColumnStart: 1,
        gridColumnEnd: 6,
        padding: 30,
        alignItems: 'center',
        justifyContent: 'center'
      });
      Text.create();
      Text.style({
        fontSize: 24,
        color: '#FFFFFF',
        textAlign: 'center'
      });
      Text.content('Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπ');
      Text.pop();
      GridItem.pop();
    } else {
      // Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûúÈ°π
      this.searchResults.forEach((item) => {
        this.renderGridItem(item);
      });
    }
    
    Grid.pop();
  }
  
  /**
   * Ê∏≤ÊüìÂä†ËΩΩÁä∂ÊÄÅ
   */
  @Builder
  private renderLoading(): void {
    Stack.create();
    Stack.className("loading-container");
    LoadingProgress.create();
    LoadingProgress.className("loading-progress");
    LoadingProgress.color("#FF4500");
    LoadingProgress.pop();
    Text.create();
    Text.content("ÊêúÁ¥¢‰∏≠...");
    Text.pop();
    Stack.pop();
  }
  
  /**
   * Ê∏≤ÊüìÂø´ÈÄüÊêúÁ¥¢ÁªìÊûúÔºàÁâáÊ∫êÂàáÊç¢ÁïåÈù¢Ôºâ
   */
  @Builder
  private renderQuickSearchResults(): void {
    if (this.showSourceList && this.quickSearchResults.length > 0) {
      Stack.create();
      Stack.style({
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        borderRadius: 15,
        padding: 20,
        marginHorizontal: 20,
        marginVertical: 10,
        position: 'absolute',
        top: 120,
        left: 0,
        right: 0,
        zIndex: 100
      });
      
      // Ê†áÈ¢òÊ†è
      Flex.create();
      Flex.style({
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 15
      });
      Text.create();
      Text.style({
        fontSize: 28,
        color: '#FFFFFF',
        fontWeight: 700
      });
      Text.content(`‰∏∫ÊÇ®ÊâæÂà∞Áõ∏ÂÖ≥ÁâáÊ∫ê: ${this.quickSearchResults.length}‰∏™`);
      Text.pop();
      Button.create();
      Button.style({
        backgroundColor: 'transparent'
      });
      Button.onClick(() => {
        this.showSourceList = false;
      });
      Text.create();
      Text.style({
        fontSize: 28,
        color: '#FFFFFF'
      });
      Text.content('‚úï');
      Text.pop();
      Button.pop();
      Flex.pop();
      
      // ÁâáÊ∫êÂàóË°®
      List.create();
      List.style({
        width: '100%',
        height: 500
      });
      
      this.quickSearchResults.forEach((item, index) => {
        ListItem.create();
        ListItem.key(`${item.id || index}`);
        ListItem.style({
          backgroundColor: '#66BB6A',
          marginBottom: 10,
          padding: 15,
          borderRadius: 10
        });
        ListItem.onClick(() => {
          this.handleQuickSearchResultClick(item);
        });
        
        Flex.create();
        Flex.style({
          flexDirection: 'row',
          justifyContent: 'space-between',
          alignItems: 'center'
        });
        
        // Ê†áÈ¢òÂíåÊù•Ê∫ê
        Flex.create();
        Flex.style({
          flex: 1,
          flexDirection: 'column'
        });
        Text.create();
        Text.style({
          fontSize: 26,
          color: '#FFFFFF',
          fontWeight: 700,
          marginBottom: 5
        });
        Text.content(item.title);
        Text.pop();
        Text.create();
        Text.style({
          fontSize: 20,
          color: '#E0E0E0'
        });
        Text.content(item.sourceType);
        Text.pop();
        Flex.pop();
        
        // Ë¥®ÈáèÊ†áÁ≠æ
        if (item.quality) {
          Flex.create();
          Flex.style({
            backgroundColor: '#FFEB3B',
            paddingHorizontal: 12,
            paddingVertical: 6,
            borderRadius: 12
          });
          Text.create();
          Text.style({
            fontSize: 22,
            color: '#000000',
            fontWeight: 700
          });
          Text.content(item.quality);
          Text.pop();
          Flex.pop();
        }
        
        Flex.pop();
        ListItem.pop();
      });
      
      List.pop();
      Stack.pop();
    }
  }

  /**
   * Ê∏≤ÊüìÈîôËØØÁä∂ÊÄÅ
   */
  @Builder
  private renderError(): void {
    Stack.create();
    Stack.className("error-container");
    Text.create();
    Text.className("error-icon");
    Text.content("‚ö†Ô∏è");
    Text.pop();
    Text.create();
    Text.className("error-message");
    Text.content(this.errorMessage);
    Text.pop();
    Button.create();
    Button.className("retry-button");
    Button.onClick(this.performSearch);
    Text.create();
    Text.content("ÈáçËØï");
    Text.pop();
    Button.pop();
    Stack.pop();
  }
  
  /**
   * ÁªÑ‰ª∂Ê∏≤Êüì
   */
  build() {
    Stack.create();
    Stack.style({
      backgroundColor: '#2E7D32',
      flex: 1
    });
    
    // ÊêúÁ¥¢ËæìÂÖ•Âå∫Âüü
    this.renderSearchInput();
    
    // Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫êÂàáÊç¢ÁïåÈù¢
    this.renderQuickSearchResults();
    
    // ‰∏ªÂÜÖÂÆπÂå∫Âüü
    ScrollView.create();
    ScrollView.style({
      flex: 1,
      scrollBar: 'auto'
    });
    
    // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÊï∞Èáè
    if (!this.showHistory && this.searchResults.length > 0) {
      Text.create();
      Text.style({
        fontSize: 22,
        color: '#FFFFFF',
        paddingHorizontal: 15,
        paddingVertical: 10,
        fontWeight: 600
      });
      Text.content(`ÊêúÁ¥¢(${this.searchResults.length}/${this.searchResults.length})`);
      Text.pop();
    }
    
    if (this.isSearching && this.isLoading && this.currentPage === 1) {
      this.renderLoading();
    } else if (this.errorMessage) {
      this.renderError();
    } else if (this.showHistory) {
      Stack.create();
      Stack.style({
        paddingHorizontal: 15
      });
      this.renderHotKeywords();
      this.renderSearchHistory();
      Stack.pop();
    } else {
      this.renderSearchResults();
    }
    
    Blank.create();
    Blank.style({
      height: 50
    });
    Blank.pop();
    ScrollView.pop();
    Stack.pop();
  }
}

export default SearchPage;