
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { MediaItem } from '../data/bean/MediaItem';
import { SearchHistoryItem } from '../../data/repository/SearchHistoryRepository';
import { mediaService } from '../service/media/MediaService';
import { SearchType, SearchFilter, SearchSort } from '../data/dto/SearchDto';
import { siteManager } from '../service/spider/SiteManager';
import { lineManager } from '../service/config/LineManager';
import { Button } from '@kit.ArkUI';

// Âø´ÈÄüÊêúÁ¥¢ÁªìÊûúÊé•Âè£
interface QuickSearchResult {
  id: string;
  title: string;
  quality: string;
  sourceType: string;
}

// Ê†∑ÂºèÁõ∏ÂÖ≥Êé•Âè£ÂÆö‰πâ
interface ButtonStyle {
  backgroundColor?: string;
  borderRadius?: number;
  paddingHorizontal?: number;
  paddingVertical?: number;
  marginRight?: number;
}

interface TextStyle {
  fontSize?: number;
  color?: string;
  fontWeight?: number;
}

interface GridStyle {
  paddingHorizontal?: number;
  gap?: number;
  columnsTemplate?: string;
  rowsTemplate?: string;
}

interface GridItemStyle {
  gridColumnStart?: number;
  gridColumnEnd?: number;
  padding?: number;
  alignItems?: string;
  justifyContent?: string;
}

interface StackStyle {
  backgroundColor?: string;
  borderRadius?: number;
  padding?: number;
  marginHorizontal?: number;
  marginVertical?: number;
  position?: string;
  top?: number;
  left?: number;
  right?: number;
  zIndex?: number;
}

interface FlexStyle {
  flexDirection?: string;
  justifyContent?: string;
  alignItems?: string;
  marginBottom?: number;
  flex?: number;
}

interface ListStyle {
  width?: string;
  height?: number;
}

/**
 * ÊêúÁ¥¢È°µÈù¢ÁªÑ‰ª∂
 * ÂÆûÁé∞Â™í‰ΩìÊêúÁ¥¢ÂäüËÉΩÔºåÂåÖÊã¨ÊêúÁ¥¢ËæìÂÖ•„ÄÅÁªìÊûúÂ±ïÁ§∫„ÄÅÂéÜÂè≤ÊêúÁ¥¢Á≠â
 */
@Entry
@Component
struct SearchPage {
  private readonly TAG: string = 'SearchPage';
  
  // Áä∂ÊÄÅÁÆ°ÁêÜ
  @State searchQuery: string = '';
  @State searchResults: MediaItem[] = [];
  @State hotKeywords: string[] = [];
  @State searchHistory: SearchHistoryItem[] = [];
  @State isLoading: boolean = false;
  @State isSearching: boolean = false;
  @State errorMessage: string = '';
  @State currentPage: number = 1;
  @State hasMoreResults: boolean = true;
  @State showHistory: boolean = true;
  @State displayMode: 'list' | 'grid' = 'list'; // ÊòæÁ§∫Ê®°ÂºèÔºöÂàóË°®ÊàñÁΩëÊ†º
  @State showFilterPanel: boolean = false; // ÊòØÂê¶ÊòæÁ§∫Á≠õÈÄâÈù¢Êùø
  @State filters: SearchFilter = {}; // ÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂
  @State showSourceList: boolean = false; // ÊòØÂê¶ÊòæÁ§∫Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫êÂàóË°®
  @State quickSearchResults: QuickSearchResult[] = []; // Âø´ÈÄüÊêúÁ¥¢ÁªìÊûú
  
  // ÂàÜÈ°µÈÖçÁΩÆ
  private pageSize: number = 20;
  private searchDebounceTimer: number | null = null;
  
  /**
   * È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®
   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'SearchPage appeared');
    
    // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞‰∏≠ÁöÑÊêúÁ¥¢ËØç
    const params = this.context.router.getParams();
    if (params?.query) {
      this.searchQuery = params.query as string;
      this.performSearch();
    } else {
      // Âä†ËΩΩÁÉ≠Èó®ÊêúÁ¥¢ËØç
      this.loadHotKeywords();
    }
    
    // Âä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤
    this.loadSearchHistory();
  }
  
  /**
   * È°µÈù¢Âç∏ËΩΩÊó∂Ë∞ÉÁî®
   */
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'SearchPage disappeared');
    
    // Ê∏ÖÁêÜÂÆöÊó∂Âô®
    if (this.searchDebounceTimer) {
      clearTimeout(this.searchDebounceTimer);
    }
  }
  
  /**
   * Âä†ËΩΩÁÉ≠Èó®ÊêúÁ¥¢ËØç
   */
  private loadHotKeywords(): void {
    try {
      mediaService.getHotSearchKeywords(10).then((data) => {
        this.hotKeywords = data;
        Logger.info(this.TAG, `Loaded ${this.hotKeywords.length} hot keywords`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load hot keywords: ${error}`);
      // ‰ΩøÁî®ÈªòËÆ§ÁÉ≠Èó®ÂÖ≥ÈîÆËØç
      this.hotKeywords = ['ÁÉ≠Èó®ÁîµÂΩ±', 'ÊúÄÊñ∞ÂâßÈõÜ', 'ÁªèÂÖ∏Âä®Êº´', 'ÁßëÂπªÂ§ßÁâá', 'Áà±ÊÉÖÂñúÂâß'];
    }
  }
  
  /**
   * Âä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤
   */
  private loadSearchHistory(): void {
    try {
      // ËøôÈáåÂ∫îËØ•‰ªéÊú¨Âú∞Â≠òÂÇ®‰∏≠ËØªÂèñÊêúÁ¥¢ÂéÜÂè≤
      // ÊöÇÊó∂‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
      const history = ['Â§ç‰ªáËÄÖËÅîÁõü', 'Êµ∑Ë¥ºÁéã', 'ÊòüÈôÖÁ©øË∂ä'];
      this.searchHistory = history;
      Logger.info(this.TAG, `Loaded ${this.searchHistory.length} search history items`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to load search history: ${error}`);
      this.searchHistory = [];
    }
  }
  
  /**
   * ‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤
   */
  private saveSearchHistory(keyword: string): void {
    try {
      // ÂéªÈáçÂπ∂ÈôêÂà∂Êï∞Èáè
      let history = this.searchHistory.filter(item => item !== keyword);
      history.unshift(keyword);
      history = history.slice(0, 10); // ÊúÄÂ§ö‰øùÂ≠ò10Êù°
      
      this.searchHistory = history;
      
      // ËøôÈáåÂ∫îËØ•‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
      Logger.info(this.TAG, `Search history saved: ${keyword}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to save search history: ${error}`);
    }
  }
  
  /**
   * Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫ê
   */
  private quickSearch(keyword: string): void {
    try {
      // Ëé∑Âèñ‰ªéÁ∫øË∑ØÈÖçÁΩÆÊñá‰ª∂Âä†ËΩΩÁöÑÁúüÂÆûÁ´ôÁÇπÂàóË°®
      const sites = siteManager.getAllSites();
      
      // ‰ΩøÁî®ÁúüÂÆûÁ´ôÁÇπ‰ø°ÊÅØÁîüÊàêÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
      this.quickSearchResults = [];
      
      // Â¶ÇÊûúÊúâÁ´ôÁÇπÔºå‰ΩøÁî®ÁúüÂÆûÁ´ôÁÇπ‰ø°ÊÅØ
      if (sites.length > 0) {
        sites.forEach((site) => {
          // Á°Æ‰øùÁ´ôÁÇπ‰ø°ÊÅØÊúâÊïà‰∏îÂèØÊêúÁ¥¢
          if (site && site.enabled !== false && (site.searchable === true || site.quickSearch === 1)) {
            // Â∞ùËØïËé∑ÂèñÁ´ôÁÇπÂêçÁß∞ÔºåÂ¶ÇÊûúÂêçÁß∞‰∏çÂ≠òÂú®Âàô‰ΩøÁî®key‰Ωú‰∏∫Â§áÁî®
            const siteName = site.name || site.key || 'Êú™Áü•Á´ôÁÇπ';
            
            this.quickSearchResults.push({
              id: `${keyword}-${site.key || Math.random().toString(36).substr(2, 9)}`,
              title: `${keyword} - ${siteName}`,
              quality: site.quality || 'È´òÊ∏Ö',
              sourceType: siteName
            });
          }
        });
        
        // Â¶ÇÊûú‰ªéÁ´ôÁÇπÂàóË°®‰∏≠Ê≤°ÊúâËé∑ÂèñÂà∞ÂèØÊêúÁ¥¢ÁöÑÁ´ôÁÇπÔºåÊ∑ªÂä†‰∏Ä‰∫õÈªòËÆ§Á´ôÁÇπ
        if (this.quickSearchResults.length === 0) {
          this.addDefaultQuickSearchResults(keyword);
        }
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâÁ´ôÁÇπ‰ø°ÊÅØÔºå‰ΩøÁî®Â§áÁî®ÁöÑÈªòËÆ§Á´ôÁÇπ
        this.addDefaultQuickSearchResults(keyword);
      }
      
      // ÈôêÂà∂ÁªìÊûúÊï∞ÈáèÔºåÈÅøÂÖçÊòæÁ§∫ËøáÂ§ö
      this.quickSearchResults = this.quickSearchResults.slice(0, 10);
      
      // ÊòæÁ§∫Âø´ÈÄüÊêúÁ¥¢ÁªìÊûú
      this.showSourceList = true;
      Logger.info(this.TAG, `Quick search for: ${keyword}, results: ${this.quickSearchResults.length}`);
      
      // Ëé∑ÂèñÂΩìÂâçÁ∫øË∑Ø‰ø°ÊÅØÂπ∂ËÆ∞ÂΩïÊó•Âøó
      const currentLine = lineManager.getCurrentLine();
      if (currentLine) {
        Logger.info(this.TAG, `Current line: ${currentLine.name || 'Êú™Áü•ÂêçÁß∞'}, sources loaded from: ${currentLine.url}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Quick search failed: ${JSON.stringify(error)}`);
      // Âç≥‰ΩøÂá∫ÈîôÔºå‰πüÊ∑ªÂä†‰∏Ä‰∫õÈªòËÆ§Á´ôÁÇπ‰æõÁî®Êà∑ÈÄâÊã©
      this.quickSearchResults = [];
      this.addDefaultQuickSearchResults(keyword);
      this.showSourceList = this.quickSearchResults.length > 0;
    }
  }
  
  /**
   * Ê∑ªÂä†ÈªòËÆ§ÁöÑÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
   */
  private addDefaultQuickSearchResults(keyword: string): void {
    // ‰ªéÂÖ∏ÂûãÁ∫øË∑ØÈÖçÁΩÆ‰∏≠ÊèêÂèñÁöÑÂ∏∏ËßÅÁ´ôÁÇπÂàóË°®
    const defaultSources = [
      {key: 'lebei', name: '‰πêË¥ùËßÜÈ¢ë'},
      {key: 'qimi', name: 'Â•áÁ±≥ÂΩ±ËßÜ'},
      {key: 'jiumo', name: '‰πùÁå´ÂΩ±ËßÜ'},
      {key: 'yiso', name: 'ÊòìÂèëÂΩ±ËßÜ'},
      {key: 'lengfan', name: 'ÂÜ∑Áï™ÂΩ±ËßÜ'},
      {key: 'jinlian', name: 'ÈáëÊøÇËßÜÈ¢ë'},
      {key: 'miaofan', name: 'ÁßíÁï™ÂΩ±ËßÜ'},
      {key: 'zhuifan', name: 'ËøΩÁï™ËßÜÈ¢ë'},
      {key: 'kanfan', name: 'ÁúãÁï™ËßÜÈ¢ë'},
      {key: 'haokan', name: 'Â•ΩÁúãËßÜÈ¢ë'}
    ];
    
    defaultSources.forEach((source) => {
      this.quickSearchResults.push({
        id: `${keyword}-${source.key}`,
        title: `${keyword} - ${source.name}`,
        quality: 'È´òÊ∏ÖÂÖ®Áâá',
        sourceType: source.name
      });
    });
  }

  /**
   * ÊûÑÂª∫È°µÈù¢UI
   */
  build() {
    // ËøôÈáåÈúÄË¶ÅÂÆûÁé∞È°µÈù¢ÁöÑUIÊûÑÂª∫ÈÄªËæë
    // ÊöÇÊó∂ËøîÂõû‰∏Ä‰∏™Á©∫ÁöÑColumn‰Ωú‰∏∫Âç†‰ΩçÁ¨¶
    Column() {
      Text('ÊêúÁ¥¢È°µÈù¢')
        .fontSize(20)
        .fontColor('#333333')
    }
  }

  /**
   * Â§ÑÁêÜÂø´ÈÄüÊêúÁ¥¢ÁªìÊûúÁÇπÂáª‰∫ã‰ª∂
   */
  private handleQuickSearchResultClick(result: QuickSearchResult): void {
    try {
      Logger.info(this.TAG, `Quick search result clicked: ${JSON.stringify(result)}`);
      
      // ÈöêËóèÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
      this.showSourceList = false;
      
      // Ë∑≥ËΩ¨Âà∞MediaDetailPageÈ°µÈù¢ÔºåÊê∫Â∏¶Áõ∏ÂÖ≥ÂèÇÊï∞
      AppNavigator.getInstance().navigateToDetail({
          title: result.title,
          sourceId: result.id,
          sourceType: result.sourceType,
          mediaType: 'video',
          keyword: this.searchText,
          // ‰º†ÈÄíÁ´ôÁÇπ‰ø°ÊÅØÔºå‰ª•‰æøÂú®ËØ¶ÊÉÖÈ°µËÉΩÂ§ü‰ΩøÁî®Ê≠£Á°ÆÁöÑÊêúÁ¥¢Ê∫ê
          siteName: result.sourceType,
          // ËÆ∞ÂΩïÂΩìÂâç‰ΩøÁî®ÁöÑÁ∫øË∑Ø‰ø°ÊÅØ
          currentLine: lineManager.getCurrentLine() ? lineManager.getCurrentLine().name : 'Default'
        });
      
      // ËÆ∞ÂΩïÊêúÁ¥¢ÂéÜÂè≤
      this.saveSearchHistory(this.searchText);
    } catch (error) {
      Logger.error(this.TAG, `Error handling quick search result click: ${error}`);
    }
  }

  /**
   * Ê∏ÖÈô§ÊêúÁ¥¢ÂéÜÂè≤
   */
  private clearSearchHistory(): void {
    try {
      this.searchHistory = [];
      // ËøôÈáåÂ∫îËØ•Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®‰∏≠ÁöÑÊêúÁ¥¢ÂéÜÂè≤
      Logger.info(this.TAG, 'Search history cleared');
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear search history: ${error}`);
    }
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢ËæìÂÖ•ÂèòÂåñ
   */
  private handleSearchInputChange(value: string): void {
    this.searchQuery = value;
    
    // Èò≤ÊäñÂ§ÑÁêÜ
    if (this.searchDebounceTimer) {
      clearTimeout(this.searchDebounceTimer);
    }
    
    // ËæìÂÖ•‰∏∫Á©∫Êó∂ÈáçÁΩÆÁä∂ÊÄÅ
    if (value.trim().length === 0) {
      this.resetSearchState();
      this.showSourceList = false;
      return;
    }
    
    // Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫êÔºàÂΩìËæìÂÖ•ËææÂà∞‰∏ÄÂÆöÈïøÂ∫¶Êó∂Ôºâ
    if (value.trim().length >= 2) {
      // Á´ãÂç≥ÊâßË°åÂø´ÈÄüÊêúÁ¥¢
      this.quickSearch(value.trim());
      
      // ËæìÂÖ•ÂÅúÊ≠¢300msÂêéÊâßË°åÂ∏∏ËßÑÊêúÁ¥¢
      this.searchDebounceTimer = setTimeout(() => {
        this.performSearch();
      }, 300);
    }
  }
  
  /**
   * ÊâßË°åÊêúÁ¥¢
   */
  private performSearch(): void {
    const query = this.searchQuery.trim();
    if (!query) return;
    
    // ÈöêËóèÂø´ÈÄüÊêúÁ¥¢ÁªìÊûú
    this.showSourceList = false;
    
    this.isSearching = true;
    this.isLoading = true;
    this.errorMessage = '';
    this.showHistory = false;
    this.currentPage = 1;
    
    try {
      // ‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤
      this.saveSearchHistory(query);
      
      // ÊâßË°åÊêúÁ¥¢Ôºå‰º†ÈÄíÁ≠õÈÄâÊù°‰ª∂
      Logger.info(this.TAG, `Searching for: ${query} with filters:`, JSON.stringify(this.filters));
      
      // ÊûÑÂª∫ÊêúÁ¥¢ÂèÇÊï∞ÔºåÂåÖÂê´Á≠õÈÄâÊù°‰ª∂
      const searchParams = {
        keyword: query,
        type: SearchType.All,
        page: this.currentPage,
        pageSize: this.pageSize,
        ...this.filters // ÂêàÂπ∂Á≠õÈÄâÊù°‰ª∂
      };
      
      mediaService.searchMedia(searchParams).then((result) => {
        // Â§ÑÁêÜÊêúÁ¥¢ÁªìÊûú
        this.searchResults = result.items || [];
        this.hasMoreResults = result.hasMore || false;
        
        Logger.info(this.TAG, `Search completed, found ${this.searchResults.length} results`);
        this.isLoading = false;
        this.isSearching = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Search failed: ${error}`);
        this.errorMessage = 'ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
        this.searchResults = [];
        this.hasMoreResults = false;
        this.isLoading = false;
        this.isSearching = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Search failed: ${error}`);
      this.errorMessage = 'ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
      this.searchResults = [];
      this.hasMoreResults = false;
      this.isLoading = false;
      this.isSearching = false;
    }
  }
  
  /**
   * Âä†ËΩΩÊõ¥Â§öÊêúÁ¥¢ÁªìÊûú
   */
  private loadMoreResults(): void {
    if (!this.hasMoreResults || this.isLoading || !this.searchQuery.trim()) return;
    
    this.isLoading = true;
    this.currentPage++;
    
    try {
      const query = this.searchQuery.trim();
      Logger.info(this.TAG, `Loading more results for: ${query}, page ${this.currentPage}`);
      
      // ÊûÑÂª∫ÊêúÁ¥¢ÂèÇÊï∞ÔºåÂåÖÂê´Á≠õÈÄâÊù°‰ª∂
      const searchParams = {
        keyword: query,
        type: SearchType.All,
        page: this.currentPage,
        pageSize: this.pageSize,
        ...this.filters // ÂêàÂπ∂Á≠õÈÄâÊù°‰ª∂
      };
      
      mediaService.searchMedia(searchParams).then((result) => {
        if (result && result.items && result.items.length > 0) {
          this.searchResults = [...this.searchResults, ...result.items];
          this.hasMoreResults = result.hasMore || false;
        } else {
          this.hasMoreResults = false;
        }
        this.isLoading = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load more results: ${error}`);
        this.errorMessage = 'Âä†ËΩΩÊõ¥Â§öÁªìÊûúÂ§±Ë¥•';
        this.isLoading = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load more results: ${error}`);
      this.errorMessage = 'Âä†ËΩΩÊõ¥Â§öÁªìÊûúÂ§±Ë¥•';
      this.isLoading = false;
    }
  }
  
  /**
   * ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅ
   */
  private resetSearchState(): void {
    this.searchResults = [];
    this.showHistory = true;
    this.errorMessage = '';
    this.currentPage = 1;
    this.hasMoreResults = true;
  }
  
  /**
   * Â§ÑÁêÜÂÖ≥ÈîÆËØçÁÇπÂáª
   */
  private handleKeywordClick(keyword: string): void {
    this.searchQuery = keyword;
    this.performSearch();
  }
  
  /**
   * Â§ÑÁêÜÊêúÁ¥¢ÁªìÊûúÈ°πÁÇπÂáª
   */
  private handleSearchResultClick(media: MediaItem): void {
    if (!media || !media.id) {
      Logger.error(this.TAG, `Invalid media item: ${JSON.stringify(media)}`);
      return;
    }
    
    Logger.info(this.TAG, `Search result clicked: ${media.title}`);
    
    // Ë∑≥ËΩ¨Âà∞ËØ¶ÊÉÖÈ°µ
    AppNavigator.getInstance().navigateToDetail({
      id: media.id,
      siteKey: media.siteKey || '',
      type: 'vod'
    });
  }
  
  /**
   * Â§ÑÁêÜÊ∏ÖÈô§ÊåâÈíÆÁÇπÂáª
   */
  private handleClearInput(): void {
    this.searchQuery = '';
    this.resetSearchState();
  }
  
  /**
   * Â§ÑÁêÜËøîÂõû
   */
  private handleBack(): void {
    this.context.router.back();
  }
  
  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ËæìÂÖ•Ê°Ü
   */
  @Builder
  private renderSearchInput(): void {
    Stack({ className: "search-input-container" }) {
      Button({ className: "back-button", onClick: this.handleBack }) {
        Text("‚Üê")
      }
      Flex({ className: "search-input-wrapper" }) {
        Text({ className: "search-icon", content: "üîç" })
        TextInput({
          className: "search-input",
          value: this.searchQuery,
          onChange: this.handleSearchInputChange,
          onSubmit: this.performSearch,
          placeholder: "ÊêúÁ¥¢ÁîµÂΩ±„ÄÅÁîµËßÜÂâß„ÄÅÂä®Êº´...",
          enterKeyType: "search",
          autoFocus: true
        })
        if (this.searchQuery) {
          Button({ className: "clear-button", onClick: this.handleClearInput }) {
            Text("‚úï")
          }
        }
      }
      Button({ className: "search-button", onClick: this.performSearch }) {
        Text("ÊêúÁ¥¢")
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÁÉ≠Èó®ÊêúÁ¥¢
   */
  @Builder
  private renderHotKeywords(): void {
    Stack({ className: "hot-keywords-section" }) {
      Flex({ className: "section-header" }) {
        Text({ className: "section-title", content: "ÁÉ≠Èó®ÊêúÁ¥¢" })
      }
      Flex({ className: "keywords-container", wrap: "wrap" }) {
        ForEach(this.hotKeywords, (keyword, index) => {
          Tag({
            key: `hot-${index}`,
            className: "keyword-tag hot",
            onClick: () => this.handleKeywordClick(keyword)
          }) {
            Text({ className: "keyword-rank", content: (index + 1).toString() })
            Text(keyword)
          }
        }, (keyword, index) => `hot-${index}`)
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ÂéÜÂè≤
   */
  @Builder
  private renderSearchHistory(): void {
    if (this.searchHistory.length === 0) return;
    
    Stack({
      backgroundColor: '#FFFFFF',
      borderRadius: 10,
      padding: 15,
      margin: { bottom: 15 }
    }) {
      Flex({ direction: FlexDirection.Row, justifyContent: FlexAlign.SpaceBetween, alignItems: ItemAlign.Center, marginBottom: 10 }) {
        Text("ÊêúÁ¥¢ÂéÜÂè≤")
          .fontSize(20)
          .fontColor('#333333')
          .fontWeight(600)
        Button({
          backgroundColor: 'transparent',
          onClick: this.clearSearchHistory
        }) {
          Text("Ê∏ÖÈô§")
            .fontSize(16)
            .fontColor('#666666')
        }
      }
      Flex({ direction: FlexDirection.Row, flexWrap: FlexWrap.Wrap, gap: 10 }) {
        ForEach(this.searchHistory, (keyword, index) => {
          Button({
            key: `history-${index}`,
            backgroundColor: '#E0E0E0',
            borderRadius: 15,
            paddingHorizontal: 15,
            paddingVertical: 8,
            onClick: () => this.handleKeywordClick(keyword)
          }) {
            Flex({ direction: FlexDirection.Row, alignItems: ItemAlign.Center, gap: 5 }) {
              Text("üïê")
                .fontSize(16)
              Text(keyword)
                .fontSize(16)
            }
          }
        }, (keyword, index) => `history-${index}`)
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûúÈ°π
   */
  @Builder
  private renderSearchResultItem(media: MediaItem): void {
    ListItem({ onClick: () => this.handleSearchResultClick(media) }) {
      Flex({
        direction: FlexDirection.Row,
        alignItems: ItemAlign.Center,
        padding: 15,
        backgroundColor: '#FFFFFF',
        borderRadius: 10,
        marginBottom: 10
      }) {
        // Â™í‰ΩìÂ∞ÅÈù¢ - ‰ΩøÁî®Âç†‰ΩçÁ¨¶Êõø‰ª£ImageÁªÑ‰ª∂
        Column({
          width: 100,
          height: 150,
          backgroundColor: '#E0E0E0',
          borderRadius: 8,
          justifyContent: FlexAlign.Center,
          alignItems: HorizontalAlign.Center,
          marginRight: 15
        }) {
          Text("Â∞ÅÈù¢")
            .fontSize(14)
            .fontColor('#666666')
        }
        Flex({
          direction: FlexDirection.Column,
          flex: 1
        }) {
          Text(media.title)
            .fontSize(20)
            .fontColor('#333333')
            .fontWeight(600)
            .numberOfLines(2)
          Flex({
            direction: FlexDirection.Row,
            flexWrap: FlexWrap.Wrap,
            gap: 8,
            marginTop: 8
          }) {
            if (media.year) {
              Button({
                backgroundColor: '#E0E0E0',
                borderRadius: 10,
                paddingHorizontal: 10,
                paddingVertical: 4
              }) {
                Text(media.year)
                  .fontSize(14)
                  .fontColor('#666666')
              }
            }
            if (media.type) {
              Button({
                backgroundColor: '#E0E0E0',
                borderRadius: 10,
                paddingHorizontal: 10,
                paddingVertical: 4
              }) {
                Text(media.type)
                  .fontSize(14)
                  .fontColor('#666666')
              }
            }
            if (media.score) {
              Button({
                backgroundColor: '#FFEB3B',
                borderRadius: 10,
                paddingHorizontal: 10,
                paddingVertical: 4
              }) {
                Text(media.score)
                  .fontSize(14)
                  .fontColor('#000000')
                  .fontWeight(600)
              }
            }
          }
          if (media.description) {
            Text(media.description)
              .fontSize(16)
              .fontColor('#666666')
              .numberOfLines(2)
              .margin({ top: 8 })
          }
          if (media.directors && media.directors.length > 0) {
            Text(`ÂØºÊºî: ${media.directors.slice(0, 3).join(', ')}`)
              .fontSize(14)
              .fontColor('#999999')
              .numberOfLines(1)
              .margin({ top: 5 })
          }
          if (media.actors && media.actors.length > 0) {
            Text(`‰∏ªÊºî: ${media.actors.slice(0, 3).join(', ')}`)
              .fontSize(14)
              .fontColor('#999999')
              .numberOfLines(1)
              .margin({ top: 2 })
          }
        }
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÊòæÁ§∫Ê®°ÂºèÂàáÊç¢ÊåâÈíÆ
   */
  @Builder
  private renderDisplayModeToggle(): void {
    Button({
      backgroundColor: '#4CAF50',
      borderRadius: 20,
      paddingHorizontal: 15,
      paddingVertical: 8,
      onClick: this.toggleDisplayMode
    }) {
      Text(this.displayMode === 'list' ? 'ÁΩëÊ†º' : 'ÂàóË°®')
        .fontSize(16)
        .fontColor('#FFFFFF')
        .fontWeight(600)
    }
  }
  
  /**
   * Ê∏≤ÊüìÁ≠õÈÄâÊåâÈíÆ
   */
  @Builder
  private renderFilterButton(): void {
    Button({
      backgroundColor: '#4CAF50',
      borderRadius: 20,
      paddingHorizontal: 15,
      paddingVertical: 8,
      onClick: this.toggleFilterPanel
    }) {
      Text("Á≠õÈÄâ")
        .fontSize(16)
        .fontColor('#FFFFFF')
        .fontWeight(600)
    }
  }
  
  /**
   * Ê∏≤ÊüìÁ≠õÈÄâÈù¢Êùø
   */
  @Builder
  private renderFilterPanel(): void {
    if (!this.showFilterPanel) return;
    
    Stack({
      backgroundColor: 'rgba(0, 0, 0, 0.85)',
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      zIndex: 100
    }) {
      Stack({
          backgroundColor: '#4CAF50',
          position: 'absolute',
          bottom: 0,
          left: 0,
          right: 0,
          padding: 20,
          borderTopLeftRadius: 20,
          borderTopRightRadius: 20
        }) {
        // Ê†áÈ¢òÊ†è
        Flex({ direction: FlexDirection.Row, justifyContent: FlexAlign.SpaceBetween, alignItems: ItemAlign.Center, marginBottom: 20 }) {
          Text('Á≠õÈÄâÊù°‰ª∂')
            .fontSize(28)
            .fontColor('#FFFFFF')
            .fontWeight(700)
          Button({
            backgroundColor: 'transparent',
            onClick: () => {
              this.showFilterPanel = false;
            }
          }) {
            Text('‚úï')
              .fontSize(28)
              .fontColor('#FFFFFF')
          }
        }
        
        // Â™í‰ΩìÁ±ªÂûãÁ≠õÈÄâ
        Text('Â™í‰ΩìÁ±ªÂûã:')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .margin({ bottom: 15 })
          .fontWeight(600)
        
        Flex({ direction: FlexDirection.Row, flexWrap: FlexWrap.Wrap, gap: 10, marginBottom: 20 }) {
          ForEach([
            { label: 'ÁîµÂΩ±', value: 'movie' },
            { label: 'ÁîµËßÜÂâß', value: 'tv' },
            { label: 'Âä®Êº´', value: 'anime' },
            { label: 'ÁªºËâ∫', value: 'variety' },
            { label: 'Á∫™ÂΩïÁâá', value: 'documentary' }
          ], (type) => {
            Button({
              backgroundColor: this.filters.types?.includes(type.value) ? '#FFEB3B' : '#FFFFFF',
              borderRadius: 15,
              paddingHorizontal: 15,
              paddingVertical: 8,
              onClick: () => {
                this.updateMediaTypeFilter(type.value, !this.filters.types?.includes(type.value));
              }
            }) {
              Text(type.label)
                .fontSize(22)
                .fontColor(this.filters.types?.includes(type.value) ? '#000000' : '#4CAF50')
                .fontWeight(600)
            }
          })
        }
        
        // ÊéíÂ∫èÊñπÂºè
        Text('ÊéíÂ∫èÊñπÂºè:')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .margin({ bottom: 15 })
          .fontWeight(600)
        
        Flex({
          direction: FlexDirection.Row,
          flexWrap: FlexWrap.Wrap,
          gap: 10,
          marginBottom: 20
        }) {
          ForEach([
            { label: 'ÈªòËÆ§ÊéíÂ∫è', value: 'default' },
            { label: 'ÊúÄÊñ∞ÂèëÂ∏É', value: 'latest' },
            { label: 'ËØÑÂàÜÊúÄÈ´ò', value: 'rating' },
            { label: 'Êí≠ÊîæÊúÄÂ§ö', value: 'popular' }
          ], (option) => {
            Button({
              backgroundColor: this.filters.sort === option.value ? '#FFEB3B' : '#FFFFFF',
              borderRadius: 15,
              paddingHorizontal: 15,
              paddingVertical: 8,
              onClick: () => {
                this.filters.sort = option.value;
              }
            }) {
              Text(option.label)
                .fontSize(22)
                .fontColor(this.filters.sort === option.value ? '#000000' : '#4CAF50')
                .fontWeight(600)
            }
          })
        }
        
        // Êìç‰ΩúÊåâÈíÆ
        Flex({
          direction: FlexDirection.Row,
          justifyContent: FlexAlign.SpaceBetween,
          gap: 15
        }) {
          Button({
            style: {
              backgroundColor: '#FFFFFF',
              borderRadius: 15,
              paddingHorizontal: 20,
              paddingVertical: 12,
              flex: 1
            },
            onClick: this.resetFilters
          }) {
            Text('ÈáçÁΩÆ')
              .fontSize(22)
              .fontColor('#4CAF50')
              .fontWeight(600)
          }
          Button({
            type: 'capsule',
            onClick: this.applyFilters
          }) {
            Text('Â∫îÁî®Á≠õÈÄâ')
          }
        }
      }
    }
  }

  /**
   * Êõ¥Êñ∞Â™í‰ΩìÁ±ªÂûãÁ≠õÈÄâ
   */
  private updateMediaTypeFilter(type: string, checked: boolean): void {
    if (!this.filters.types) {
      this.filters.types = [];
    }
    
    if (checked) {
      if (!this.filters.types.includes(type)) {
        this.filters.types.push(type);
      }
    } else {
      const index = this.filters.types.indexOf(type);
      if (index > -1) {
        this.filters.types.splice(index, 1);
      }
    }
  }

  /**
   * Ê∏≤ÊüìÁΩëÊ†ºÊ®°ÂºèÁöÑÊêúÁ¥¢ÁªìÊûúÈ°π
   */
  @Builder
  private renderGridItem(item: MediaItem): void {
    if (!item) return;
    
    // ‰ΩøÁî®ColumnÊõø‰ª£GridItem
    Column({
      width: '100%',
      margin: { bottom: 15 }
    })
    .onClick(() => this.handleSearchResultClick(item)) {
      Stack({
          width: '100%'
        }) {
        // Êù•Ê∫êÊ†áÁ≠æ - Êîπ‰∏∫ÁªøËâ≤‰∏ªÈ¢ò
        if (item.siteKey) {
          Text(`${item.siteKey} | APP`)
            .backgroundColor('#4CAF50')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .padding({ horizontal: 8, vertical: 4 })
            .borderRadius(4)
            .position({ x: 0, y: 0 })
            .margin({ top: 8, left: 8 })
            .zIndex(10)
            .fontWeight(600)
        }
        
        // ÂõæÁâá - ‰ΩøÁî®Âç†‰ΩçÁ¨¶Êõø‰ª£ImageÁªÑ‰ª∂
        Column({
          width: '100%',
          aspectRatio: 2/3,
          backgroundColor: '#E0E0E0',
          borderRadius: 8,
          justifyContent: FlexAlign.Center,
          alignItems: HorizontalAlign.Center
        }) {
          Text("Â∞ÅÈù¢")
            .fontSize(16)
            .fontColor('#666666')
        }
        
        // Ê†áÈ¢ò
        Text(item.title || 'Êú™Áü•Ê†áÈ¢ò')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .margin({ top: 8 })
          .fontWeight(600)
          .textShadow({
            radius: 3,
            color: 'rgba(0, 0, 0, 0.8)',
            offset: { x: 1, y: 1 }
          })
          .numberOfLines(2)
        
        // ËØÑÂàÜÊ†áÁ≠æ - Â¶ÇÊûúÊúâËØÑÂàÜÂàôÊòæÁ§∫
        if (item.score) {
          Text(`${item.score}ÂàÜ`)
            .backgroundColor('#FFEB3B')
            .fontColor('#000000')
            .fontSize(16)
            .padding({ horizontal: 8, vertical: 2 })
            .borderRadius(4)
            .margin({ top: 4 })
            .fontWeight(700)
        }
      }
    }
  }

  /**
   * Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûú
   */
  @Builder
  private renderSearchResults(): void {
    // Ê∏≤ÊüìÂàÜÁ±ªÁ≠õÈÄâÊåâÈíÆ
    ScrollView({
      whiteSpace: 'nowrap',
      margin: { bottom: 20 }
    }) {
      Flex({
        paddingHorizontal: 15,
        alignItems: FlexAlign.Center,
        gap: 10
      }) {
        // ÂÖ®ÈÉ®ÊòæÁ§∫ÊåâÈíÆ
        Button({
          backgroundColor: '#4CAF50',
          borderRadius: 20,
          paddingHorizontal: 20,
          paddingVertical: 8,
          marginRight: 10,
          onClick: () => {}
        }) {
          Text("ÂÖ®ÈÉ®ÊòæÁ§∫")
            .fontSize(22)
            .fontColor('#FFFFFF')
            .fontWeight(600)
        }
        
        // ÂàÜÁ±ªÊåâÈíÆ
        ForEach(["ÁÉ≠Êí≠ | APP", "Êµ™ÈÖ∑ | APP", "ÁßíÁúã | APP", "ÊòüÁ©∫ | APP", "Áà±Áúã | APP", "ÂÜ∑ÂøÉ | APP"], (category) => {
          Button({
            backgroundColor: '#FFFFFF',
            borderRadius: 20,
            paddingHorizontal: 20,
            paddingVertical: 8,
            marginRight: 10,
            onClick: () => {}
          }) {
            Text(category)
              .fontSize(22)
              .fontColor('#4CAF50')
              .fontWeight(600)
          }
        })
      }
    }
    
    // Ê∏≤ÊüìÁΩëÊ†ºÁªìÊûú - ‰ΩøÁî®FlexÂ∏ÉÂ±ÄÊõø‰ª£Grid
    Flex({
      paddingHorizontal: 15,
      gap: 15,
      flexWrap: FlexWrap.Wrap,
      justifyContent: FlexAlign.Start
    }) {
      if (this.searchResults.length === 0) {
        // Êó†ÊêúÁ¥¢ÁªìÊûúÊó∂ÁöÑÊèêÁ§∫
        Column({ width: '100%', padding: 30, alignItems: HorizontalAlign.Center, justifyContent: FlexAlign.Center }) {
          Text('Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπ')
            .fontSize(24)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)
        }
      } else {
        // Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûúÈ°π
        ForEach(this.searchResults, (item) => {
          Column({ width: '18%', marginBottom: 15 }) {
            this.renderGridItem(item)
          }
        })
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂä†ËΩΩÁä∂ÊÄÅ
   */
  @Builder
  private renderLoading(): void {
    Stack({
      width: '100%',
      height: '100%',
      justifyContent: FlexAlign.Center,
      alignItems: HorizontalAlign.Center
    }) {
      // Ëá™ÂÆö‰πâÂä†ËΩΩÊåáÁ§∫Âô®
      Column({
        backgroundColor: '#FFFFFF',
          borderRadius: 20,
          padding: 20,
          alignItems: 'center'
        }
      }) {
        Text("‚óè")
          .fontSize(40)
          .fontColor('#4CAF50')
          .animation({
            duration: 1000,
            iterations: -1,
            curve: 'easeInOut'
          })
        Text("ÊêúÁ¥¢‰∏≠...")
          .fontSize(18)
          .fontColor('#333333')
          .margin({ top: 10 })
      }
    }
  }
  
  /**
   * Ê∏≤ÊüìÂø´ÈÄüÊêúÁ¥¢ÁªìÊûúÔºàÁâáÊ∫êÂàáÊç¢ÁïåÈù¢Ôºâ
   */
  @Builder
  private renderQuickSearchResults(): void {
    if (this.showSourceList && this.quickSearchResults.length > 0) {
      Stack({
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        borderRadius: 15,
        padding: 20,
        marginHorizontal: 20,
        marginVertical: 10,
        position: 'absolute',
        top: 120,
        left: 0,
        right: 0,
        zIndex: 100
      }) {
        // Ê†áÈ¢òÊ†è
        Flex({ direction: FlexDirection.Row, justifyContent: FlexAlign.SpaceBetween, alignItems: ItemAlign.Center, marginBottom: 15 }) {
          Text(`‰∏∫ÊÇ®ÊâæÂà∞Áõ∏ÂÖ≥ÁâáÊ∫ê: ${this.quickSearchResults.length}‰∏™`)
            .fontSize(28)
            .fontColor('#FFFFFF')
            .fontWeight(700)
          Button({
            backgroundColor: 'transparent',
            onClick: () => {
              this.showSourceList = false;
            }
          }) {
            Text('‚úï')
              .fontSize(28)
              .fontColor('#FFFFFF')
          }
        }
        
        // ÁâáÊ∫êÂàóË°®
        List({ width: '100%', height: 500 }) {
          ForEach(this.quickSearchResults, (item, index) => {
            ListItem({
              key: `${item.id || index}`,
              backgroundColor: '#66BB6A',
              marginBottom: 10,
              padding: 15,
              borderRadius: 10,
              onClick: () => {
                this.handleQuickSearchResultClick(item);
              }
            }) {
              Flex({ direction: FlexDirection.Row, justifyContent: FlexAlign.SpaceBetween, alignItems: ItemAlign.Center }) {
                // Ê†áÈ¢òÂíåÊù•Ê∫ê
                Flex({ flex: 1, direction: FlexDirection.Column }) {
                  Text(item.title)
                    .fontSize(26)
                    .fontColor('#FFFFFF')
                    .fontWeight(700)
                    .margin({ bottom: 5 })
                  Text(item.sourceType)
                    .fontSize(20)
                    .fontColor('#E0E0E0')
                }
                
                // Ë¥®ÈáèÊ†áÁ≠æ
                if (item.quality) {
                  Flex({
                    backgroundColor: '#FFEB3B',
                    paddingHorizontal: 12,
                    paddingVertical: 6,
                    borderRadius: 12
                  }) {
                    Text(item.quality)
                      .fontSize(22)
                      .fontColor('#000000')
                      .fontWeight(700)
                  }
                }
              }
            }
          })
        }
      }
    }
  }

  /**
   * Ê∏≤ÊüìÈîôËØØÁä∂ÊÄÅ
   */
  @Builder
  private renderError(): void {
    Stack({
      alignItems: HorizontalAlign.Center,
      justifyContent: FlexAlign.Center,
      padding: 20
    }) {
      Text("‚ö†Ô∏è")
        .fontSize(40)
        .fontColor('#FF6B6B')
        .margin({ bottom: 10 })
      Text(this.errorMessage)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 20 })
      Button({
        backgroundColor: '#4CAF50',
        borderRadius: 20,
        paddingHorizontal: 20,
        paddingVertical: 10,
        onClick: this.performSearch
      }) {
        Text("ÈáçËØï")
          .fontSize(16)
          .fontColor('#FFFFFF')
          .fontWeight(600)
      }
    }
  }
  
  /**
   * ÁªÑ‰ª∂Ê∏≤Êüì
   */
  build() {
    Stack({
      backgroundColor: '#2E7D32',
      flexGrow: 1
    }) {
      // ÊêúÁ¥¢ËæìÂÖ•Âå∫Âüü
      this.renderSearchInput();
      
      // Âø´ÈÄüÊêúÁ¥¢ÁâáÊ∫êÂàáÊç¢ÁïåÈù¢
      this.renderQuickSearchResults();
      
      // ‰∏ªÂÜÖÂÆπÂå∫Âüü
      ScrollView({
        scrollBar: ScrollBarState.Auto,
        flexGrow: 1
      }) {
        // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÊï∞Èáè
        if (!this.showHistory && this.searchResults.length > 0) {
          Text(`ÊêúÁ¥¢(${this.searchResults.length}/${this.searchResults.length})`)
            .fontSize(22)
            .fontColor('#FFFFFF')
            .padding({ left: 15, right: 15, top: 10, bottom: 10 })
            .fontWeight(FontWeight.SemiBold)
        }
        
        if (this.isSearching && this.isLoading && this.currentPage === 1) {
          this.renderLoading();
        } else if (this.errorMessage) {
          this.renderError();
        } else if (this.showHistory) {
          Stack({
            padding: { left: 15, right: 15 }
          }) {
            this.renderHotKeywords();
            this.renderSearchHistory();
          }
        } else {
          this.renderSearchResults();
        }
        
        Blank()
          .height(50)
      }
    }
  }
}

export default SearchPage;