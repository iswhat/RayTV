
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { MediaItem } from '../data/bean/MediaItem';
import { SearchHistoryItem } from '../../data/repository/SearchHistoryRepository';
import { mediaService } from '../service/media/MediaService';
import { SearchType, SearchFilter, SearchSort } from '../data/dto/SearchDto';
import { siteManager } from '../service/spider/SiteManager';
import { lineManager } from '../service/config/LineManager';
import { Column, Row, Text, Image, Flex, Stack, Button, List, ForEach, Scroller, Blank, ImageFit, BarState, TextOverflow, FlexDirection, FlexWrap, FlexAlign, ItemAlign, HorizontalAlign } from '@ohos/arkui';

// å¿«é€Ÿæœç´¢ç»“æœæ¥å£
interface QuickSearchResult {
  id: string;
  title: string;
  quality: string;
  sourceType: string;
}

// æ ·å¼ç›¸å…³æ¥å£å®šä¹‰
interface ButtonStyle {
  backgroundColor?: string;
  borderRadius?: number;
  paddingHorizontal?: number;
  paddingVertical?: number;
  marginRight?: number;
}

interface TextStyle {
  fontSize?: number;
  color?: string;
  fontWeight?: number;
}

interface GridStyle {
  paddingHorizontal?: number;
  gap?: number;
  columnsTemplate?: string;
  rowsTemplate?: string;
}

interface GridItemStyle {
  gridColumnStart?: number;
  gridColumnEnd?: number;
  padding?: number;
  alignItems?: string;
  justifyContent?: string;
}

interface StackStyle {
  backgroundColor?: string;
  borderRadius?: number;
  padding?: number;
  marginHorizontal?: number;
  marginVertical?: number;
  position?: string;
  top?: number;
  left?: number;
  right?: number;
  zIndex?: number;
}

interface FlexStyle {
  flexDirection?: string;
  justifyContent?: string;
  alignItems?: string;
  marginBottom?: number;
  flex?: number;
}

interface ListStyle {
  width?: string;
  height?: number;
}

/**
 * æœç´¢é¡µé¢ç»„ä»¶
 * å®ç°åª’ä½“æœç´¢åŠŸèƒ½ï¼ŒåŒ…æ‹¬æœç´¢è¾“å…¥ã€ç»“æœå±•ç¤ºã€å†å²æœç´¢ç­‰
 */
@Entry
@Component
struct SearchPage {
  private readonly TAG: string = 'SearchPage';
  
  // çŠ¶æ€ç®¡ç†
  @State searchQuery: string = '';
  @State searchResults: MediaItem[] = [];
  @State hotKeywords: string[] = [];
  @State searchHistory: SearchHistoryItem[] = [];
  @State isLoading: boolean = false;
  @State isSearching: boolean = false;
  @State errorMessage: string = '';
  @State currentPage: number = 1;
  @State hasMoreResults: boolean = true;
  @State showHistory: boolean = true;
  @State displayMode: 'list' | 'grid' = 'list'; // æ˜¾ç¤ºæ¨¡å¼ï¼šåˆ—è¡¨æˆ–ç½‘æ ¼
  @State showFilterPanel: boolean = false; // æ˜¯å¦æ˜¾ç¤ºç­›é€‰é¢æ¿
  @State filters: SearchFilter = {}; // å½“å‰ç­›é€‰æ¡ä»¶
  @State showSourceList: boolean = false; // æ˜¯å¦æ˜¾ç¤ºå¿«é€Ÿæœç´¢ç‰‡æºåˆ—è¡¨
  @State quickSearchResults: QuickSearchResult[] = []; // å¿«é€Ÿæœç´¢ç»“æœ
  
  // åˆ†é¡µé…ç½®
  private pageSize: number = 20;
  private searchDebounceTimer: number | null = null;
  
  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒç”¨
   */
  async aboutToAppear(): Promise<void> {
    Logger.info(this.TAG, 'SearchPage appeared');
    
    // è·å–è·¯ç”±å‚æ•°ä¸­çš„æœç´¢è¯
    const params = this.context.router.getParams();
    if (params?.query) {
      this.searchQuery = params.query as string;
      await this.performSearch();
    } else {
      // åŠ è½½çƒ­é—¨æœç´¢è¯
      this.loadHotKeywords();
    }
    
    // åŠ è½½æœç´¢å†å²ï¼ˆå¼‚æ­¥ï¼‰
    await this.loadSearchHistory();
  }
  
  /**
   * é¡µé¢å¸è½½æ—¶è°ƒç”¨
   */
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'SearchPage disappeared');
    
    // æ¸…ç†å®šæ—¶å™¨
    if (this.searchDebounceTimer) {
      clearTimeout(this.searchDebounceTimer);
    }
  }
  
  /**
   * åŠ è½½çƒ­é—¨æœç´¢è¯
   */
  private loadHotKeywords(): void {
    try {
      mediaService.getHotSearchKeywords(10).then((data) => {
        this.hotKeywords = data;
        Logger.info(this.TAG, `Loaded ${this.hotKeywords.length} hot keywords`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load hot keywords: ${error}`);
      // ä½¿ç”¨é»˜è®¤çƒ­é—¨å…³é”®è¯
      this.hotKeywords = ['çƒ­é—¨ç”µå½±', 'æœ€æ–°å‰§é›†', 'ç»å…¸åŠ¨æ¼«', 'ç§‘å¹»å¤§ç‰‡', 'çˆ±æƒ…å–œå‰§'];
    }
  }
  
  /**
   * åŠ è½½æœç´¢å†å²
   */
  private async loadSearchHistory(): Promise<void> {
    try {
      // ä½¿ç”¨SearchHistoryRepositoryä»æœ¬åœ°å­˜å‚¨ä¸­è¯»å–æœç´¢å†å²
      const searchHistoryRepo = new SearchHistoryRepository();
      const history = await searchHistoryRepo.getHistory();
      
      // ç¡®ä¿historyæ˜¯æ•°ç»„ç±»å‹
      if (Array.isArray(history)) {
        this.searchHistory = history;
        Logger.info(this.TAG, `Loaded ${this.searchHistory.length} search history items from repository`);
      } else {
        Logger.warn(this.TAG, `Invalid history data format, using empty array`);
        this.searchHistory = [];
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to load search history: ${error}`);
      this.searchHistory = [];
    }
  }
  
  /**
   * ä¿å­˜æœç´¢å†å²
   */
  private async saveSearchHistory(keyword: string): Promise<void> {
    try {
      // å»é‡å¹¶é™åˆ¶æ•°é‡
      let history = this.searchHistory.filter(item => item !== keyword);
      history.unshift(keyword);
      history = history.slice(0, 10); // æœ€å¤šä¿å­˜10æ¡
      
      this.searchHistory = history;
      
      // ä½¿ç”¨SearchHistoryRepositoryä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      const searchHistoryRepo = new SearchHistoryRepository();
      await searchHistoryRepo.saveHistory(history);
      
      Logger.info(this.TAG, `Search history saved: ${keyword}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to save search history: ${error}`);
    }
  }
  
  /**
   * å¿«é€Ÿæœç´¢ç‰‡æº
   */
  private quickSearch(keyword: string): void {
    try {
      // è·å–ä»çº¿è·¯é…ç½®æ–‡ä»¶åŠ è½½çš„çœŸå®ç«™ç‚¹åˆ—è¡¨
      const sites = siteManager.getAllSites();
      
      // ä½¿ç”¨çœŸå®ç«™ç‚¹ä¿¡æ¯ç”Ÿæˆå¿«é€Ÿæœç´¢ç»“æœ
      this.quickSearchResults = [];
      
      // å¦‚æœæœ‰ç«™ç‚¹ï¼Œä½¿ç”¨çœŸå®ç«™ç‚¹ä¿¡æ¯
      if (sites.length > 0) {
        sites.forEach((site) => {
          // ç¡®ä¿ç«™ç‚¹ä¿¡æ¯æœ‰æ•ˆä¸”å¯æœç´¢
          if (site && site.enabled !== false && (site.searchable === true || site.quickSearch === 1)) {
            // å°è¯•è·å–ç«™ç‚¹åç§°ï¼Œå¦‚æœåç§°ä¸å­˜åœ¨åˆ™ä½¿ç”¨keyä½œä¸ºå¤‡ç”¨
            const siteName = site.name || site.key || 'æœªçŸ¥ç«™ç‚¹';
            
            this.quickSearchResults.push({
              id: `${keyword}-${site.key || Math.random().toString(36).substr(2, 9)}`,
              title: `${keyword} - ${siteName}`,
              quality: site.quality || 'é«˜æ¸…',
              sourceType: siteName
            });
          }
        });
        
        // å¦‚æœä»ç«™ç‚¹åˆ—è¡¨ä¸­æ²¡æœ‰è·å–åˆ°å¯æœç´¢çš„ç«™ç‚¹ï¼Œæ·»åŠ ä¸€äº›é»˜è®¤ç«™ç‚¹
        if (this.quickSearchResults.length === 0) {
          this.addDefaultQuickSearchResults(keyword);
        }
      } else {
        // å¦‚æœæ²¡æœ‰ç«™ç‚¹ä¿¡æ¯ï¼Œä½¿ç”¨å¤‡ç”¨çš„é»˜è®¤ç«™ç‚¹
        this.addDefaultQuickSearchResults(keyword);
      }
      
      // é™åˆ¶ç»“æœæ•°é‡ï¼Œé¿å…æ˜¾ç¤ºè¿‡å¤š
      this.quickSearchResults = this.quickSearchResults.slice(0, 10);
      
      // æ˜¾ç¤ºå¿«é€Ÿæœç´¢ç»“æœ
      this.showSourceList = true;
      Logger.info(this.TAG, `Quick search for: ${keyword}, results: ${this.quickSearchResults.length}`);
      
      // è·å–å½“å‰çº¿è·¯ä¿¡æ¯å¹¶è®°å½•æ—¥å¿—
      const currentLine = lineManager.getCurrentLine();
      if (currentLine) {
        Logger.info(this.TAG, `Current line: ${currentLine.name || 'æœªçŸ¥åç§°'}, sources loaded from: ${currentLine.url}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Quick search failed: ${JSON.stringify(error)}`);
      // å³ä½¿å‡ºé”™ï¼Œä¹Ÿæ·»åŠ ä¸€äº›é»˜è®¤ç«™ç‚¹ä¾›ç”¨æˆ·é€‰æ‹©
      this.quickSearchResults = [];
      this.addDefaultQuickSearchResults(keyword);
      this.showSourceList = this.quickSearchResults.length > 0;
    }
  }
  
  /**
   * æ·»åŠ é»˜è®¤çš„å¿«é€Ÿæœç´¢ç»“æœ
   */
  private addDefaultQuickSearchResults(keyword: string): void {
    // ä»å…¸å‹çº¿è·¯é…ç½®ä¸­æå–çš„å¸¸è§ç«™ç‚¹åˆ—è¡¨
    const defaultSources = [
      {key: 'lebei', name: 'ä¹è´è§†é¢‘'},
      {key: 'qimi', name: 'å¥‡ç±³å½±è§†'},
      {key: 'jiumo', name: 'ä¹çŒ«å½±è§†'},
      {key: 'yiso', name: 'æ˜“å‘å½±è§†'},
      {key: 'lengfan', name: 'å†·ç•ªå½±è§†'},
      {key: 'jinlian', name: 'é‡‘æ¿‚è§†é¢‘'},
      {key: 'miaofan', name: 'ç§’ç•ªå½±è§†'},
      {key: 'zhuifan', name: 'è¿½ç•ªè§†é¢‘'},
      {key: 'kanfan', name: 'çœ‹ç•ªè§†é¢‘'},
      {key: 'haokan', name: 'å¥½çœ‹è§†é¢‘'}
    ];
    
    defaultSources.forEach((source) => {
      this.quickSearchResults.push({
        id: `${keyword}-${source.key}`,
        title: `${keyword} - ${source.name}`,
        quality: 'é«˜æ¸…å…¨ç‰‡',
        sourceType: source.name
      });
    });
  }

  /**
   * æ„å»ºé¡µé¢UI
   */
  build() {
    // è¿™é‡Œéœ€è¦å®ç°é¡µé¢çš„UIæ„å»ºé€»è¾‘
    // æš‚æ—¶è¿”å›ä¸€ä¸ªç©ºçš„Columnä½œä¸ºå ä½ç¬¦
    Column() {
      Text('æœç´¢é¡µé¢')
        .fontSize(20)
        .fontColor('#333333')
    }
  }

  /**
   * å¤„ç†å¿«é€Ÿæœç´¢ç»“æœç‚¹å‡»äº‹ä»¶
   */
  private async handleQuickSearchResultClick(result: QuickSearchResult): Promise<void> {
    try {
      Logger.info(this.TAG, `Quick search result clicked: ${JSON.stringify(result)}`);
      
      // éšè—å¿«é€Ÿæœç´¢ç»“æœ
      this.showSourceList = false;
      
      // è·³è½¬åˆ°MediaDetailPageé¡µé¢ï¼Œæºå¸¦ç›¸å…³å‚æ•°
      AppNavigator.getInstance().navigateToDetail({
          title: result.title,
          sourceId: result.id,
          sourceType: result.sourceType,
          mediaType: 'video',
          keyword: this.searchQuery,
          // ä¼ é€’ç«™ç‚¹ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨è¯¦æƒ…é¡µèƒ½å¤Ÿä½¿ç”¨æ­£ç¡®çš„æœç´¢æº
          siteName: result.sourceType,
          // è®°å½•å½“å‰ä½¿ç”¨çš„çº¿è·¯ä¿¡æ¯
          currentLine: lineManager.getCurrentLine() ? lineManager.getCurrentLine().name : 'Default'
        });
      
      // è®°å½•æœç´¢å†å²
      await this.saveSearchHistory(this.searchQuery);
    } catch (error) {
      Logger.error(this.TAG, `Error handling quick search result click: ${error}`);
    }
  }

  /**
   * æ¸…é™¤æœç´¢å†å²
   */
  private async clearSearchHistory(): Promise<void> {
    try {
      this.searchHistory = [];
      // ä½¿ç”¨SearchHistoryRepositoryæ¸…é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„æœç´¢å†å²
      const searchHistoryRepo = new SearchHistoryRepository();
      await searchHistoryRepo.clearHistory();
      
      Logger.info(this.TAG, 'Search history cleared');
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear search history: ${error}`);
    }
  }
  
  /**
   * å¤„ç†æœç´¢è¾“å…¥å˜åŒ–
   */
  private handleSearchInputChange(value: string): void {
    this.searchQuery = value;
    
    // é˜²æŠ–å¤„ç†
    if (this.searchDebounceTimer) {
      clearTimeout(this.searchDebounceTimer);
    }
    
    // è¾“å…¥ä¸ºç©ºæ—¶é‡ç½®çŠ¶æ€
    if (value.trim().length === 0) {
      this.resetSearchState();
      this.showSourceList = false;
      return;
    }
    
    // å¿«é€Ÿæœç´¢ç‰‡æºï¼ˆå½“è¾“å…¥è¾¾åˆ°ä¸€å®šé•¿åº¦æ—¶ï¼‰
    if (value.trim().length >= 2) {
      // ç«‹å³æ‰§è¡Œå¿«é€Ÿæœç´¢
      this.quickSearch(value.trim());
      
      // è¾“å…¥åœæ­¢300msåæ‰§è¡Œå¸¸è§„æœç´¢
      this.searchDebounceTimer = setTimeout(async () => {
        await this.performSearch();
      }, 300);
    }
  }
  
  /**
   * æ‰§è¡Œæœç´¢
   */
  private async performSearch(): Promise<void> {
    const query = this.searchQuery.trim();
    if (!query) return;
    
    // éšè—å¿«é€Ÿæœç´¢ç»“æœ
    this.showSourceList = false;
    
    this.isSearching = true;
    this.isLoading = true;
    this.errorMessage = '';
    this.showHistory = false;
    this.currentPage = 1;
    
    try {
      // ä¿å­˜æœç´¢å†å²ï¼ˆå¼‚æ­¥ï¼‰
      await this.saveSearchHistory(query);
      
      // æ‰§è¡Œæœç´¢ï¼Œä¼ é€’ç­›é€‰æ¡ä»¶
      Logger.info(this.TAG, `Searching for: ${query} with filters:`, JSON.stringify(this.filters));
      
      // æ„å»ºæœç´¢å‚æ•°ï¼ŒåŒ…å«ç­›é€‰æ¡ä»¶
      const searchParams = {
        keyword: query,
        type: SearchType.All,
        page: this.currentPage,
        pageSize: this.pageSize,
        ...this.filters // åˆå¹¶ç­›é€‰æ¡ä»¶
      };
      
      // ä½¿ç”¨awaitå¤„ç†Promise
      const result = await mediaService.searchMedia(searchParams);
      
      // å¤„ç†æœç´¢ç»“æœ
      this.searchResults = result.items || [];
      this.hasMoreResults = result.hasMore || false;
      
      Logger.info(this.TAG, `Search completed, found ${this.searchResults.length} results`);
    } catch (error) {
      Logger.error(this.TAG, `Search failed: ${error}`);
      this.errorMessage = 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      this.searchResults = [];
      this.hasMoreResults = false;
    } finally {
      this.isLoading = false;
      this.isSearching = false;
    }
  }
  
  /**
   * åŠ è½½æ›´å¤šæœç´¢ç»“æœ
   */
  private loadMoreResults(): void {
    if (!this.hasMoreResults || this.isLoading || !this.searchQuery.trim()) return;
    
    this.isLoading = true;
    this.currentPage++;
    
    try {
      const query = this.searchQuery.trim();
      Logger.info(this.TAG, `Loading more results for: ${query}, page ${this.currentPage}`);
      
      // æ„å»ºæœç´¢å‚æ•°ï¼ŒåŒ…å«ç­›é€‰æ¡ä»¶
      const searchParams = {
        keyword: query,
        type: SearchType.All,
        page: this.currentPage,
        pageSize: this.pageSize,
        ...this.filters // åˆå¹¶ç­›é€‰æ¡ä»¶
      };
      
      mediaService.searchMedia(searchParams).then((result) => {
        if (result && result.items && result.items.length > 0) {
          this.searchResults = [...this.searchResults, ...result.items];
          this.hasMoreResults = result.hasMore || false;
        } else {
          this.hasMoreResults = false;
        }
        this.isLoading = false;
      }).catch((error) => {
        Logger.error(this.TAG, `Failed to load more results: ${error}`);
        this.errorMessage = 'åŠ è½½æ›´å¤šç»“æœå¤±è´¥';
        this.isLoading = false;
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load more results: ${error}`);
      this.errorMessage = 'åŠ è½½æ›´å¤šç»“æœå¤±è´¥';
      this.isLoading = false;
    }
  }
  
  /**
   * é‡ç½®æœç´¢çŠ¶æ€
   */
  private resetSearchState(): void {
    this.searchResults = [];
    this.showHistory = true;
    this.errorMessage = '';
    this.currentPage = 1;
    this.hasMoreResults = true;
  }
  
  /**
   * å¤„ç†å…³é”®è¯ç‚¹å‡»
   */
  private async handleKeywordClick(keyword: string): Promise<void> {
    this.searchQuery = keyword;
    await this.performSearch();
  }
  
  /**
   * å¤„ç†æœç´¢ç»“æœé¡¹ç‚¹å‡»
   */
  private handleSearchResultClick(media: MediaItem): void {
    if (!media || !media.id) {
      Logger.error(this.TAG, `Invalid media item: ${JSON.stringify(media)}`);
      return;
    }
    
    Logger.info(this.TAG, `Search result clicked: ${media.title}`);
    
    // è·³è½¬åˆ°è¯¦æƒ…é¡µ
    AppNavigator.getInstance().navigateToDetail({
      id: media.id,
      siteKey: media.siteKey || '',
      type: 'vod'
    });
  }
  
  /**
   * å¤„ç†æ¸…é™¤æŒ‰é’®ç‚¹å‡»
   */
  private handleClearInput(): void {
    this.searchQuery = '';
    this.resetSearchState();
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    this.context.router.back();
  }
  
  /**
   * æ¸²æŸ“æœç´¢è¾“å…¥æ¡†
   */
  @Builder
  private renderSearchInput(): void {
    Stack({ className: "search-input-container" }) {
      Button({ className: "back-button", onClick: this.handleBack }) {
        Text("â†")
      }
      Flex({ className: "search-input-wrapper" }) {
        Text({ className: "search-icon", content: "ğŸ”" })
        TextInput({
          className: "search-input",
          value: this.searchQuery,
          onChange: this.handleSearchInputChange,
          onSubmit: this.performSearch,
          placeholder: "æœç´¢ç”µå½±ã€ç”µè§†å‰§ã€åŠ¨æ¼«...",
          enterKeyType: "search",
          autoFocus: true
        })
        if (this.searchQuery) {
          Button({ className: "clear-button", onClick: this.handleClearInput }) {
            Text("âœ•")
          }
        }
      }
      Button({ className: "search-button", onClick: this.performSearch }) {
        Text("æœç´¢")
      }
    }
  }
  
  /**
   * æ¸²æŸ“çƒ­é—¨æœç´¢
   */
  @Builder
  private renderHotKeywords(): void {
    Stack({ className: "hot-keywords-section" }) {
      Flex({ className: "section-header" }) {
        Text({ className: "section-title", content: "çƒ­é—¨æœç´¢" })
      }
      Flex({ className: "keywords-container", wrap: "wrap" }) {
        ForEach(this.hotKeywords, (keyword, index) => {
          Tag({
            key: `hot-${index}`,
            className: "keyword-tag hot",
            onClick: () => this.handleKeywordClick(keyword)
          }) {
            Text({ className: "keyword-rank", content: (index + 1).toString() })
            Text(keyword)
          }
        }, (keyword, index) => `hot-${index}`)
      }
    }
  }
  
  /**
   * æ¸²æŸ“æœç´¢å†å²
   */
  @Builder
  private renderSearchHistory(): void {
    if (this.searchHistory.length > 0) {
      Stack()
      .backgroundColor('#FFFFFF')
      .borderRadius(10)
      .padding(15)
      .margin({ bottom: 15 }) {
        Flex()
        .direction(FlexDirection.Row)
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(ItemAlign.Center)
        .margin({ bottom: 10 }) {
          Text("æœç´¢å†å²")
            .fontSize(20)
            .fontColor('#333333')
            .fontWeight(600)
          Button()
          .backgroundColor('transparent')
          .onClick(this.clearSearchHistory) {
            Text("æ¸…é™¤")
              .fontSize(16)
              .fontColor('#666666')
          }
        Flex()
        .direction(FlexDirection.Row)
        .flexWrap(FlexWrap.Wrap)
        .gap(10) {
          ForEach(this.searchHistory, (keyword, index) => {
            Button()
            .key(`history-${index}`)
            .backgroundColor('#E0E0E0')
            .borderRadius(15)
            .padding({ horizontal: 15, vertical: 8 })
            .onClick(() => this.handleKeywordClick(keyword)) {
              Flex()
              .direction(FlexDirection.Row)
              .alignItems(ItemAlign.Center)
              .gap(5) {
                Text("ğŸ•")
                  .fontSize(16)
                Text(keyword)
                  .fontSize(16)
              }
            }
        }, (keyword, index) => `history-${index}`)
      }
    }
  }
  
  /**
   * æ¸²æŸ“æœç´¢ç»“æœé¡¹
   */
  @Builder
  private renderSearchResultItem(media: MediaItem): void {
    Flex()
    .direction(FlexDirection.Row)
    .alignItems(ItemAlign.Center)
    .padding(15)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .margin({ bottom: 10 })
    .onClick(() => this.handleSearchResultClick(media)) {
      // åª’ä½“å°é¢ - ä½¿ç”¨å ä½ç¬¦æ›¿ä»£Imageç»„ä»¶
      Column()
      .width(100)
      .height(150)
      .backgroundColor('#E0E0E0')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .margin({ right: 15 }) {
        Text("å°é¢")
          .fontSize(14)
          .fontColor('#666666')
      }
      Flex()
      .direction(FlexDirection.Column)
      .flex(1) {
        Text(media.title)
          .fontSize(20)
          .fontColor('#333333')
          .fontWeight(600)
          .numberOfLines(2)
        Flex()
        .direction(FlexDirection.Row)
        .flexWrap(FlexWrap.Wrap)
        .gap(8)
        .margin({ top: 8 }) {
          if (media.year) {
            Button()
            .backgroundColor('#E0E0E0')
            .borderRadius(10)
            .padding({ horizontal: 10, vertical: 4 }) {
              Text(media.year)
                .fontSize(14)
                .fontColor('#666666')
            }
          }
          if (media.type) {
            Button()
            .backgroundColor('#E0E0E0')
            .borderRadius(10)
            .padding({ horizontal: 10, vertical: 4 }) {
              Text(media.type)
                .fontSize(14)
                .fontColor('#666666')
            }
          }
          if (media.score) {
            Button()
            .backgroundColor('#FFEB3B')
            .borderRadius(10)
            .padding({ horizontal: 10, vertical: 4 }) {
              Text(media.score)
                .fontSize(14)
                .fontColor('#000000')
                .fontWeight(600)
            }
          }
        }
        if (media.description) {
          Text(media.description)
            .fontSize(16)
            .fontColor('#666666')
            .numberOfLines(2)
            .margin({ top: 8 })
        }
        if (media.directors && media.directors.length > 0) {
          Text(`å¯¼æ¼”: ${media.directors.slice(0, 3).join(', ')}`)
            .fontSize(14)
            .fontColor('#999999')
            .numberOfLines(1)
            .margin({ top: 5 })
        }
        if (media.actors && media.actors.length > 0) {
          Text(`ä¸»æ¼”: ${media.actors.slice(0, 3).join(', ')}`)
            .fontSize(14)
            .fontColor('#999999')
            .numberOfLines(1)
            .margin({ top: 2 })
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢æŒ‰é’®
   */
  @Builder
  private renderDisplayModeToggle(): void {
    Button()
    .backgroundColor('#4CAF50')
    .borderRadius(20)
    .padding({ horizontal: 15, vertical: 8 })
    .onClick(this.toggleDisplayMode) {
      Text(this.displayMode === 'list' ? 'ç½‘æ ¼' : 'åˆ—è¡¨')
        .fontSize(16)
        .fontColor('#FFFFFF')
        .fontWeight(600)
    }
  }
  
  /**
   * æ¸²æŸ“ç­›é€‰æŒ‰é’®
   */
  @Builder
  private renderFilterButton(): void {
    Button()
    .backgroundColor('#4CAF50')
    .borderRadius(20)
    .padding({ horizontal: 15, vertical: 8 })
    .onClick(this.toggleFilterPanel) {
      Text("ç­›é€‰")
        .fontSize(16)
        .fontColor('#FFFFFF')
        .fontWeight(600)
    }
  }
  
  /**
   * æ¸²æŸ“ç­›é€‰é¢æ¿
   */
  @Builder
  private renderFilterPanel(): void {
    if (this.showFilterPanel) {
      Stack()
      .backgroundColor('rgba(0, 0, 0, 0.85)')
      .position({ x: 0, y: 0 })
      .width('100%')
      .height('100%')
      .zIndex(100) {
        Stack()
        .backgroundColor('#4CAF50')
        .position({ x: 0, y: 0 })
        .width('100%')
        .height('auto')
        .padding(20)
        .borderTopLeftRadius(20)
        .borderTopRightRadius(20) {
          // æ ‡é¢˜æ 
          Flex()
          .direction(FlexDirection.Row)
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(ItemAlign.Center)
          .margin({ bottom: 20 }) {
            Text('ç­›é€‰æ¡ä»¶')
              .fontSize(28)
              .fontColor('#FFFFFF')
              .fontWeight(700)
            Button()
            .backgroundColor('transparent')
            .onClick(() => {
              this.showFilterPanel = false;
            }) {
              Text('âœ•')
                .fontSize(28)
                .fontColor('#FFFFFF')
            }
          }
        
        // åª’ä½“ç±»å‹ç­›é€‰
        Text('åª’ä½“ç±»å‹:')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .margin({ bottom: 15 })
          .fontWeight(600)
        
        Flex({ direction: FlexDirection.Row, flexWrap: FlexWrap.Wrap, gap: 10, marginBottom: 20 }) {
          ForEach([
            { label: 'ç”µå½±', value: 'movie' },
            { label: 'ç”µè§†å‰§', value: 'tv' },
            { label: 'åŠ¨æ¼«', value: 'anime' },
            { label: 'ç»¼è‰º', value: 'variety' },
            { label: 'çºªå½•ç‰‡', value: 'documentary' }
          ], (type) => {
            Button({
              backgroundColor: this.filters.types?.includes(type.value) ? '#FFEB3B' : '#FFFFFF',
              borderRadius: 15,
              paddingHorizontal: 15,
              paddingVertical: 8,
              onClick: () => {
                this.updateMediaTypeFilter(type.value, !this.filters.types?.includes(type.value));
              }
            }) {
              Text(type.label)
                .fontSize(22)
                .fontColor(this.filters.types?.includes(type.value) ? '#000000' : '#4CAF50')
                .fontWeight(600)
            }
          })
        }
        
        // æ’åºæ–¹å¼
        Text('æ’åºæ–¹å¼:')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .margin({ bottom: 15 })
          .fontWeight(600)
        
        Flex({
          direction: FlexDirection.Row,
          flexWrap: FlexWrap.Wrap,
          gap: 10,
          marginBottom: 20
        }) {
          ForEach([
            { label: 'é»˜è®¤æ’åº', value: 'default' },
            { label: 'æœ€æ–°å‘å¸ƒ', value: 'latest' },
            { label: 'è¯„åˆ†æœ€é«˜', value: 'rating' },
            { label: 'æ’­æ”¾æœ€å¤š', value: 'popular' }
          ], (option) => {
            Button({
              backgroundColor: this.filters.sort === option.value ? '#FFEB3B' : '#FFFFFF',
              borderRadius: 15,
              paddingHorizontal: 15,
              paddingVertical: 8,
              onClick: () => {
                this.filters.sort = option.value;
              }
            }) {
              Text(option.label)
                .fontSize(22)
                .fontColor(this.filters.sort === option.value ? '#000000' : '#4CAF50')
                .fontWeight(600)
            }
          })
        }
        
        // æ“ä½œæŒ‰é’®
        Flex({
          direction: FlexDirection.Row,
          justifyContent: FlexAlign.SpaceBetween,
          gap: 15
        }) {
          Button({
            style: {
              backgroundColor: '#FFFFFF',
              borderRadius: 15,
              paddingHorizontal: 20,
              paddingVertical: 12,
              flex: 1
            },
            onClick: this.resetFilters
          }) {
            Text('é‡ç½®')
              .fontSize(22)
              .fontColor('#4CAF50')
              .fontWeight(600)
          }
          Button({
            type: 'capsule',
            onClick: this.applyFilters
          }) {
            Text('åº”ç”¨ç­›é€‰')
          }
        }
      }
    }
  }

  /**
   * æ›´æ–°åª’ä½“ç±»å‹ç­›é€‰
   */
  private updateMediaTypeFilter(type: string, checked: boolean): void {
    if (!this.filters.types) {
      this.filters.types = [];
    }
    
    if (checked) {
      if (!this.filters.types.includes(type)) {
        this.filters.types.push(type);
      }
    } else {
      const index = this.filters.types.indexOf(type);
      if (index > -1) {
        this.filters.types.splice(index, 1);
      }
    }
  }

  /**
   * æ¸²æŸ“ç½‘æ ¼æ¨¡å¼çš„æœç´¢ç»“æœé¡¹
   */
  @Builder
  private renderGridItem(item: MediaItem): void {
    if (item) {
      // ä½¿ç”¨Columnæ›¿ä»£GridItem
      Column()
      .width('100%')
      .margin({ bottom: 15 })
      .onClick(() => this.handleSearchResultClick(item)) {
      Stack({
          width: '100%'
        }) {
        // æ¥æºæ ‡ç­¾ - æ”¹ä¸ºç»¿è‰²ä¸»é¢˜
        if (item.siteKey) {
          Text(`${item.siteKey} | APP`)
            .backgroundColor('#4CAF50')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .padding({ horizontal: 8, vertical: 4 })
            .borderRadius(4)
            .position({ x: 0, y: 0 })
            .margin({ top: 8, left: 8 })
            .zIndex(10)
            .fontWeight(600)
        }
        
        // å›¾ç‰‡ - ä½¿ç”¨å ä½ç¬¦æ›¿ä»£Imageç»„ä»¶
        Column({
          width: '100%',
          aspectRatio: 2/3,
          backgroundColor: '#E0E0E0',
          borderRadius: 8,
          justifyContent: FlexAlign.Center,
          alignItems: HorizontalAlign.Center
        }) {
          Text("å°é¢")
            .fontSize(16)
            .fontColor('#666666')
        }
        
        // æ ‡é¢˜
        Text(item.title || 'æœªçŸ¥æ ‡é¢˜')
          .fontSize(20)
          .fontColor('#FFFFFF')
          .margin({ top: 8 })
          .fontWeight(600)
          .textShadow({
            radius: 3,
            color: 'rgba(0, 0, 0, 0.8)',
            offset: { x: 1, y: 1 }
          })
          .numberOfLines(2)
        
        // è¯„åˆ†æ ‡ç­¾ - å¦‚æœæœ‰è¯„åˆ†åˆ™æ˜¾ç¤º
        if (item.score) {
          Text(`${item.score}åˆ†`)
            .backgroundColor('#FFEB3B')
            .fontColor('#000000')
            .fontSize(16)
            .padding({ horizontal: 8, vertical: 2 })
            .borderRadius(4)
            .margin({ top: 4 })
            .fontWeight(700)
        }
      }
    }
  }

  /**
   * æ¸²æŸ“æœç´¢ç»“æœ
   */
  @Builder
  private renderSearchResults(): void {
    // æ¸²æŸ“åˆ†ç±»ç­›é€‰æŒ‰é’®
    Scroller()
    .scrollable(ScrollDirection.Horizontal)
    .margin({ bottom: 20 }) {
      Flex()
      .padding({ horizontal: 15 })
      .alignItems(FlexAlign.Center)
      .gap(10) {
        // å…¨éƒ¨æ˜¾ç¤ºæŒ‰é’®
        Button()
        .backgroundColor('#4CAF50')
        .borderRadius(20)
        .padding({ horizontal: 20, vertical: 8 })
        .margin({ right: 10 })
        .onClick(() => {}) {
          Text("å…¨éƒ¨æ˜¾ç¤º")
            .fontSize(22)
            .fontColor('#FFFFFF')
            .fontWeight(600)
        }
        
        // åˆ†ç±»æŒ‰é’®
        ForEach(["çƒ­æ’­ | APP", "æµªé…· | APP", "ç§’çœ‹ | APP", "æ˜Ÿç©º | APP", "çˆ±çœ‹ | APP", "å†·å¿ƒ | APP"], (category) => {
          Button()
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .padding({ horizontal: 20, vertical: 8 })
          .margin({ right: 10 })
          .onClick(() => {}) {
            Text(category)
              .fontSize(22)
              .fontColor('#4CAF50')
              .fontWeight(600)
          }
        })
      }
    }
    
    // æ¸²æŸ“ç½‘æ ¼ç»“æœ - ä½¿ç”¨Flexå¸ƒå±€æ›¿ä»£Grid
    Flex({
      paddingHorizontal: 15,
      gap: 15,
      flexWrap: FlexWrap.Wrap,
      justifyContent: FlexAlign.Start
    }) {
      if (this.searchResults.length === 0) {
        // æ— æœç´¢ç»“æœæ—¶çš„æç¤º
        Column({ width: '100%', padding: 30, alignItems: HorizontalAlign.Center, justifyContent: FlexAlign.Center }) {
          Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹')
            .fontSize(24)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)
        }
      } else {
        // æ¸²æŸ“æœç´¢ç»“æœé¡¹
        ForEach(this.searchResults, (item) => {
          Column({ width: '18%', marginBottom: 15 }) {
            this.renderGridItem(item)
          }
        })
      }
    }
  }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€
   */
  @Builder
  private renderLoading(): void {
    Stack({
      width: '100%',
      height: '100%',
      justifyContent: FlexAlign.Center,
      alignItems: HorizontalAlign.Center
    }) {
      // è‡ªå®šä¹‰åŠ è½½æŒ‡ç¤ºå™¨
      Column({
        backgroundColor: '#FFFFFF',
          borderRadius: 20,
          padding: 20,
          alignItems: 'center'
        }
      }) {
        Text("â—")
          .fontSize(40)
          .fontColor('#4CAF50')
          .animation({
            duration: 1000,
            iterations: -1,
            curve: 'easeInOut'
          })
        Text("æœç´¢ä¸­...")
          .fontSize(18)
          .fontColor('#333333')
          .margin({ top: 10 })
      }
    }
  }
  
  /**
   * æ¸²æŸ“å¿«é€Ÿæœç´¢ç»“æœï¼ˆç‰‡æºåˆ‡æ¢ç•Œé¢ï¼‰
   */
  @Builder
  private renderQuickSearchResults(): void {
    if (this.showSourceList && this.quickSearchResults.length > 0) {
      Stack() {
        // æ ‡é¢˜æ 
        Flex() {
          Text(`ä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ç‰‡æº: ${this.quickSearchResults.length}ä¸ª`)
            .fontSize(28)
            .fontColor('#FFFFFF')
            .fontWeight(700)
          Button() {
            Text('âœ•')
              .fontSize(28)
              .fontColor('#FFFFFF')
          }
          .backgroundColor('transparent')
          .onClick(() => {
            this.showSourceList = false;
          })
        }
        .direction(FlexDirection.Row)
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(ItemAlign.Center)
        .margin({ bottom: 15 })
        
        // ç‰‡æºåˆ—è¡¨
        List() {
          ForEach(this.quickSearchResults, (item, index) => {
            ListItem() {
              Flex() {
                // æ ‡é¢˜å’Œæ¥æº
                Flex() {
                  Text(item.title)
                    .fontSize(26)
                    .fontColor('#FFFFFF')
                    .fontWeight(700)
                    .margin({ bottom: 5 })
                  Text(item.sourceType)
                    .fontSize(20)
                    .fontColor('#E0E0E0')
                }
                .flex(1)
                .direction(FlexDirection.Column)
                
                // è´¨é‡æ ‡ç­¾
                if (item.quality) {
                  Flex() {
                    Text(item.quality)
                      .fontSize(22)
                      .fontColor('#000000')
                      .fontWeight(700)
                  }
                  .backgroundColor('#FFEB3B')
                  .padding({ horizontal: 12, vertical: 6 })
                  .borderRadius(12)
                }
              }
              .direction(FlexDirection.Row)
              .justifyContent(FlexAlign.SpaceBetween)
              .alignItems(ItemAlign.Center)
            }
            .key(`${item.id || index}`)
            .backgroundColor('#66BB6A')
            .margin({ bottom: 10 })
            .padding(15)
            .borderRadius(10)
            .onClick(() => {
              this.handleQuickSearchResultClick(item);
            })
          })
        }
        .width('100%')
        .height(500)
      }
      .backgroundColor('rgba(0, 0, 0, 0.85)')
      .borderRadius(15)
      .padding(20)
      .margin({ left: 20, right: 20, top: 10, bottom: 10 })
      .position({ x: 0, y: 120 })
      .width('100%')
      .zIndex(100)
    }
  }

  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€
   */
  @Builder
  private renderError(): void {
    Stack({
      alignItems: HorizontalAlign.Center,
      justifyContent: FlexAlign.Center,
      padding: 20
    }) {
      Text("âš ï¸")
        .fontSize(40)
        .fontColor('#FF6B6B')
        .margin({ bottom: 10 })
      Text(this.errorMessage)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 20 })
      Button({
        backgroundColor: '#4CAF50',
        borderRadius: 20,
        paddingHorizontal: 20,
        paddingVertical: 10,
        onClick: this.performSearch
      }) {
        Text("é‡è¯•")
          .fontSize(16)
          .fontColor('#FFFFFF')
          .fontWeight(600)
      }
    }
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Stack({
      backgroundColor: '#2E7D32',
      flexGrow: 1
    }) {
      // æœç´¢è¾“å…¥åŒºåŸŸ
      this.renderSearchInput();
      
      // å¿«é€Ÿæœç´¢ç‰‡æºåˆ‡æ¢ç•Œé¢
      this.renderQuickSearchResults();
      
      // ä¸»å†…å®¹åŒºåŸŸ
      ScrollView({
        scrollBar: ScrollBarState.Auto,
        flexGrow: 1
      }) {
        // æ˜¾ç¤ºæœç´¢ç»“æœæ•°é‡
        if (!this.showHistory && this.searchResults.length > 0) {
          Text(`æœç´¢(${this.searchResults.length}/${this.searchResults.length})`)
            .fontSize(22)
            .fontColor('#FFFFFF')
            .padding({ left: 15, right: 15, top: 10, bottom: 10 })
            .fontWeight(FontWeight.SemiBold)
        }
        
        if (this.isSearching && this.isLoading && this.currentPage === 1) {
          this.renderLoading();
        } else if (this.errorMessage) {
          this.renderError();
        } else if (this.showHistory) {
          Stack({
            padding: { left: 15, right: 15 }
          }) {
            this.renderHotKeywords();
            this.renderSearchHistory();
          }
        } else {
          this.renderSearchResults();
        }
        
        Blank()
          .height(50)
      }
    }
  }
}

export default SearchPage;