// HomePageç»„ä»¶ - Home page component
import { AppNavigator, PageRoute } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { MediaService } from '../service/media/MediaService';
import { MediaItem } from '../data/bean/MediaItem';

import ApiResponse from '../data/dto/ApiResponse';
import { Column, Row, Text, Button, Image, Scroll, ForEach, FlexAlign, TextAlign, VerticalAlign, BarState, ImageFit } from '@ohos/arkui';
import VirtualList from '../components/VirtualList';
import { VirtualListItem } from '../types/VirtualListTypes';
import { SkeletonScreen } from '../components/SkeletonScreen';

// åª’ä½“æ¨èç»“æœé¡¹ç±»å‹ | Media recommended result item type
interface RecommendedMediaItem {
  id: string;
  title: string;
  cover?: string;
  siteKey: string;
  rating?: string;
}

// å“åº”æ•°æ®æ¥å£ | Response data interface
interface SuccessResponse<T> {
  isSuccess: () => boolean;
  data: T[];
}

// ç®€åŒ–æ¡ä»¶åˆ¤æ–­çš„è¾…åŠ©æ–¹æ³• | Helper method to simplify condition checking
function isSuccessResponse<T>(response: ApiResponse<T[]>): boolean {
  return typeof response === 'object' && 
         response !== null && 
         typeof response.isSuccess === 'function' && 
         response.isSuccess() && 
         response.data !== undefined && 
         Array.isArray(response.data);
}

/**
 * é¦–é¡µç»„ä»¶ | Home page component
 * å±•ç¤ºæ¨èåª’ä½“å†…å®¹å’ŒåŠŸèƒ½å…¥å£ | Display recommended media content and feature entries
 */
@Component
struct HomePage {
  private readonly TAG: string = 'HomePage';
  private scroller: Scroller = new Scroller();
  
  // çŠ¶æ€ç®¡ç† | State management
  @State isLoading: boolean = false;
  @State recommendedMedia: MediaItem[] = [];
  @State popularMedia: MediaItem[] = [];
  @State newMedia: MediaItem[] = [];
  @State errorMessage: string = '';
  
  // æœåŠ¡å®ä¾‹ | Service instances
  private mediaService: MediaService = MediaService.getInstance();

  
  // åˆå§‹åŒ–é¡µé¢ | Initialize page
  async aboutToAppear(): Promise<void> {
    Logger.info(this.TAG, 'HomePage mounted');

    await this.loadHomePageData();
  }

  // æ¸…ç†èµ„æº | Clean up resources
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'HomePage unmounted');
  }
  
  /**
   * åŠ è½½é¦–é¡µæ•°æ® | Load home page data
   */
  private async loadHomePageData(): Promise<void> {
    try {
      this.isLoading = true;
      this.errorMessage = '';

      Logger.info(this.TAG, 'Loading home page data');

      // å¹¶è¡ŒåŠ è½½æ‰€æœ‰å†…å®¹ | Load all content in parallel
      const [recommendedResult, popularResult, newResult] = await Promise.all([
        this.mediaService.getPersonalizedRecommendations(),
        this.mediaService.getPopularContent(),
        this.mediaService.getNewContent()
      ]);

      // å¤„ç†æ¨èå†…å®¹ | Handle recommended content
      if (isSuccessResponse<RecommendedMediaItem>(recommendedResult)) {
        // ç¡®ä¿dataä¸æ˜¯undefined | Ensure data is not undefined
        const data = recommendedResult.data as RecommendedMediaItem[];
        this.recommendedMedia = data.map((item: RecommendedMediaItem) => {
          const mediaItem: MediaItem = {
            id: item.id,
            title: item.title,
            coverUrl: item.cover || '',
            siteKey: item.siteKey,
            score: item.rating || ''
          };
          return mediaItem;
        });
      }

      // å¤„ç†çƒ­é—¨å†…å®¹ | Handle popular content
      if (isSuccessResponse<RecommendedMediaItem>(popularResult)) {
        // ç¡®ä¿dataä¸æ˜¯undefined | Ensure data is not undefined
        const data = popularResult.data as RecommendedMediaItem[];
        this.popularMedia = data.map((item: RecommendedMediaItem) => {
          const mediaItem: MediaItem = {
            id: item.id,
            title: item.title,
            coverUrl: item.cover || '',
            siteKey: item.siteKey,
            score: item.rating || ''
          };
          return mediaItem;
        });
      }

      // å¤„ç†æœ€æ–°ä¸Šçº¿å†…å®¹ | Handle new content
      if (isSuccessResponse<RecommendedMediaItem>(newResult)) {
        // ç¡®ä¿dataä¸æ˜¯undefined | Ensure data is not undefined
        const data = newResult.data as RecommendedMediaItem[];
        this.newMedia = data.map((item: RecommendedMediaItem) => {
          const mediaItem: MediaItem = {
            id: item.id,
            title: item.title,
            coverUrl: item.cover || '',
            siteKey: item.siteKey,
            score: item.rating || ''
          };
          return mediaItem;
        });
      }

      Logger.info(this.TAG, `Home page data loaded: recommended=${this.recommendedMedia.length}, popular=${this.popularMedia.length}, new=${this.newMedia.length}`);
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      Logger.error(this.TAG, `Failed to load home page data: ${err.message}`);
      this.errorMessage = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    } finally {
      this.isLoading = false;
    }
  }
  
  /**
   * å¤„ç†æœç´¢ | Handle search
   */
  private handleSearch(): void {
    try {
      Logger.info(this.TAG, 'Search button clicked');

      // è·³è½¬åˆ°æœç´¢é¡µé¢ | Navigate to search page
      AppNavigator.getInstance().navigateToSearch('');
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      Logger.error(this.TAG, `Failed to navigate to search page: ${err.message}`);
    }
  }
  
  /**
   * å¤„ç†åª’ä½“é¡¹ç‚¹å‡» | Handle media item click
   */
  private handleMediaItemClick(media: MediaItem): void {
    try {
      Logger.info(this.TAG, `Media item clicked: ${media.title}`);

      // éªŒè¯åª’ä½“æ•°æ®å®Œæ•´æ€§ | Validate media data integrity
      if (!media.id || !media.siteKey) {
        Logger.error(this.TAG, 'Invalid media data: missing required fields');
        return;
      }

      // è®°å½•ç”¨æˆ·è¡Œä¸º | Record user behavior
      this.mediaService.recordUserBehavior({
        mediaId: media.id,
        type: 'click',
        timestamp: Date.now()
      });

      // è·³è½¬åˆ°è¯¦æƒ…é¡µ | Navigate to detail page
      AppNavigator.getInstance().navigateToDetail({
        id: media.id,
        siteKey: media.siteKey || '',
        type: 'movie'
      });
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      Logger.error(this.TAG, `Failed to navigate to detail page: ${err.message}`);
    }
  }
  
  /**
   * å°†MediaItemè½¬æ¢ä¸ºVirtualListItem | Convert MediaItem to VirtualListItem
   */
  private convertToVirtualItems(mediaList: MediaItem[]): VirtualListItem[] {
    const virtualItems: VirtualListItem[] = [];
    for (let i = 0; i < mediaList.length; i++) {
      const media = mediaList[i];
      const virtualItem: VirtualListItem = {
        id: media.id,
        index: i,
        data: media,
        top: i * 320, // ä¼°ç®—çš„é¡¹ç›®é«˜åº¦
        height: 320,
        visible: false
      };
      virtualItems.push(virtualItem);
    }
    return virtualItems;
  }
  }
  
  /**
   * æ¸²æŸ“åª’ä½“é¡¹ | Render media item
   */
  @Builder
  private renderMediaItem(media: MediaItem) {
    Column() {
      Image(media.coverUrl || 'https://via.placeholder.com/200x300?text=No+Image')
        .width(180)
        .height(270)
        .objectFit(ImageFit.Cover)
        .borderRadius(12)
        .backgroundColor('#F5F5F5')
        .margin({ bottom: 12 })
      
      Text(media.title)
        .fontSize(16)
        .fontWeight(600)
        .fontColor('#333333')
        .maxLines(2)
        .width(180)
        .textAlign(TextAlign.Center)
      
      if (media.score) {
        Text(`è¯„åˆ†: ${media.score}`)
          .fontSize(14)
          .fontColor('#FF6B35')
          .margin({ top: 4 })
      }
    }
    .width(180)
    .padding(10)
    .onClick(() => this.handleMediaItemClick(media))
  }
  
  /**
   * æ¸²æŸ“åª’ä½“åˆ—è¡¨ | Render media list
   */
  @Builder
  private renderMediaSection(title: string, mediaList: MediaItem[]) {
    Column() {
      Row() {
        Text(title)
          .fontSize(20)
          .fontWeight(700)
          .fontColor('#333333')
          .margin({ left: 30 })
        
        Button('æŸ¥çœ‹æ›´å¤š')
          .fontSize(14)
          .fontColor('#4CAF50')
          .backgroundColor('transparent')
          .margin({ right: 30 })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 20 })
      
      // ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨æé«˜æ€§èƒ½ | Use virtual list for better performance
      Column() {
        Scroll(this.scroller) {
          Row() {
            ForEach(mediaList, (media: MediaItem) => {
              this.renderMediaItem(media)
            }, (media: MediaItem) => media.id)
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
        }
        .height(320)
        .margin({ bottom: 30 })
      }
    }
    .width('100%')
  }
  
  /**
   * æ¸²æŸ“åª’ä½“åˆ—è¡¨ï¼ˆè™šæ‹Ÿåˆ—è¡¨ç‰ˆæœ¬ï¼‰| Render media list (virtual list version)
   */
  @Builder
  private renderMediaSectionWithVirtualList(title: string, mediaList: MediaItem[]) {
    Column() {
      Row() {
        Text(title)
          .fontSize(20)
          .fontWeight(700)
          .fontColor('#333333')
          .margin({ left: 30 })
        
        Button('æŸ¥çœ‹æ›´å¤š')
          .fontSize(14)
          .fontColor('#4CAF50')
          .backgroundColor('transparent')
          .margin({ right: 30 })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 20 })
      
      // ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨æé«˜æ€§èƒ½ | Use virtual list for better performance
      const virtualItems = this.convertToVirtualItems(mediaList);
      
      VirtualList({
        items: virtualItems,
        estimatedItemHeight: 320,
        bufferSize: 3,
        renderItem: (item: VirtualListItem) => {
          const media = item.data as MediaItem;
          return this.renderMediaItem(media);
        }
      })
      .height(320)
      .margin({ bottom: 30 })
    }
    .width('100%')
  }
  
  /**
   * æ¸²æŸ“åŠ è½½çŠ¶æ€ | Render loading state
   */
  @Builder
  private renderLoading() {
    Column() {
      SkeletonScreen({
        type: 'card',
        count: 10,
        animated: true,
        animationDuration: 1500
      })
    }
    .justifyContent(FlexAlign.Center)
    .height('80%')
  }
  
  /**
   * æ¸²æŸ“é”™è¯¯çŠ¶æ€ | Render error state
   */
  @Builder
  private renderError() {
    Column() {
      Text('ğŸ˜”')
        .fontSize(48)
        .margin({ bottom: 20 })
      Text(this.errorMessage)
        .fontSize(18)
        .fontColor('#333333')
        .margin({ bottom: 30 })
      Button('é‡è¯•')
        .onClick(() => this.loadHomePageData())
        .backgroundColor('#4CAF50')
        .fontColor('white')
        .borderRadius(8)
        .padding({ left: 30, right: 30, top: 12, bottom: 12 })
    }
    .justifyContent(FlexAlign.Center)
    .height('80%')
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“ | Component render
   */
  build() {
    Column() {
      // é¡¶éƒ¨æ  | Top bar
      Row() {
        Text('RayTVé¦–é¡µ')
          .fontSize(24)
          .fontWeight(700)
          .fontColor('#333333')
          .flexGrow(1)
          .margin({ left: 30 })
        
        Button('æœç´¢')
          .onClick(() => this.handleSearch())
          .width(100)
          .height(45)
          .backgroundColor('#4CAF50')
          .borderRadius(8)
          .margin({ right: 30 })
      }
      .width('100%')
      .height(80)
      .alignItems(VerticalAlign.Center)
      .backgroundColor('#FFFFFF')
      
      // å†…å®¹åŒºåŸŸ | Content area
      if (this.isLoading) {
        this.renderLoading()
      } else if (this.errorMessage) {
        this.renderError()
      } else {
        Scroll(this.scroller) {
          Column() {
            // æ¨èå†…å®¹ | Recommended content
            if (this.recommendedMedia.length > 0) {
              this.renderMediaSectionWithVirtualList('æ¨èå†…å®¹', this.recommendedMedia)
            }
            
            // çƒ­é—¨å†…å®¹ | Popular content
            if (this.popularMedia.length > 0) {
              this.renderMediaSectionWithVirtualList('çƒ­é—¨å†…å®¹', this.popularMedia)
            }
            
            // æœ€æ–°ä¸Šçº¿ | New releases
            if (this.newMedia.length > 0) {
              this.renderMediaSectionWithVirtualList('æœ€æ–°ä¸Šçº¿', this.newMedia)
            }
            
            // ç©ºçŠ¶æ€ | Empty state
            if (this.recommendedMedia.length === 0 && this.popularMedia.length === 0 && this.newMedia.length === 0) {
              Column() {
                Text('æš‚æ— å†…å®¹')
                  .fontSize(18)
                  .fontColor('#666666')
                  .margin(40)
              }
              .justifyContent(FlexAlign.Center)
              .height(400)
            }
          }
          .width('100%')
          .padding({ top: 20, bottom: 40 })
        }
        .scrollBar(BarState.Auto)
        .flexGrow(1)
        .backgroundColor('#F5F5F5')
      }
    }
    .width('100%')
    .height('100%')
  }
}

export default HomePage;
