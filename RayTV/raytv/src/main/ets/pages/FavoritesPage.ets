
import { AppNavigator } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { favoriteService } from '../service/media/FavoriteService';
import { mediaService } from '../service/media/MediaService';
import { Stack, Button, Image, ScrollView, List, LoadingProgress, Blank, Checkbox, Tag, Empty, ListItem } from '@kit.ArkUI';

/**
 * æ”¶è—é¡¹æ¥å£å®šä¹?
 */
interface FavoriteItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl?: string;
  type?: string;
  year?: string;
  addTime: string;
}

/**
 * åª’ä½“é¡¹æ¥å£å®šä¹?
 */
interface MediaItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl?: string;
  type?: string;
  year?: string;
  description: string;
  score: string;
  directors: string[];
  actors: string[];
  tags: string[];
  category: string;
  region: string;
  language: string;
  updateTime: string;
  status: string;
}

/**
 * æ”¶è—é¡µé¢ç»„ä»¶
 * å®ç°æ”¶è—åª’ä½“çš„å±•ç¤ºã€ç®¡ç†ã€ç¼–è¾‘ç­‰åŠŸèƒ½
 */
@Component
struct FavoritesPage {
  private readonly TAG: string = 'FavoritesPage';
  
  // çŠ¶æ€ç®¡ç?
  @State favorites: FavoriteItem[] = [];
  @State mediaItems: Map<string, MediaItem> = new Map();
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State isEditMode: boolean = false;
  @State selectedItems: Set<string> = new Set();
  @State isRefreshing: boolean = false;
  @State sortBy: 'time' | 'title' = 'time';
  
  // åˆå§‹åŒ?
  /**
   * é¡µé¢åŠ è½½æ—¶è°ƒç”?
   */
  aboutToAppear(): void {
    Logger.info(this.TAG, 'FavoritesPage appeared');
    this.loadFavorites();
  }

  /**
   * é¡µé¢å¸è½½æ—¶è°ƒç”?
   */
  aboutToDisappear(): void {
    Logger.info(this.TAG, 'FavoritesPage disappeared');
  }
  
  /**
   * åŠ è½½æ”¶è—åˆ—è¡¨
   */
  private loadFavorites(): void {
    this.isLoading = true;
    this.errorMessage = '';
    
    // ä»æ”¶è—æœåŠ¡è·å–æ”¶è—åˆ—è¡?
    favoriteService.getFavorites()
      .then(favorites => {
        // æ ¹æ®æ’åºæ–¹å¼æ’åº
        if (this.sortBy === 'time') {
          favorites.sort((a, b) => {
            return new Date(b.addTime).getTime() - new Date(a.addTime).getTime();
          });
        } else if (this.sortBy === 'title') {
          favorites.sort((a, b) => {
            const titleA = this.mediaItems.get(a.id)?.title || a.title;
            const titleB = this.mediaItems.get(b.id)?.title || b.title;
            return titleA.localeCompare(titleB);
          });
        }
        
        this.favorites = favorites;
        
        // åŠ è½½åª’ä½“è¯¦æƒ…
        this.loadMediaDetails(favorites);
        
        Logger.info(this.TAG, `Loaded ${this.favorites.length} favorites`);
      })
      .catch(error => {
        Logger.error(this.TAG, `Failed to load favorites: ${error}`);
        this.errorMessage = 'åŠ è½½æ”¶è—å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      })
      .finally(() => {
        this.isLoading = false;
        this.isRefreshing = false;
      });
  }
  
  /**
   * åŠ è½½åª’ä½“è¯¦æƒ…
   */
  private loadMediaDetails(favorites: FavoriteItem[]): void {
    try {
      // å¹¶è¡ŒåŠ è½½åª’ä½“è¯¦æƒ…
      const detailPromises = favorites.map((fav) => {
        return mediaService.getMediaDetail(fav.id, fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey : new Error(String(fav.siteKey instanceof Error ? fav.siteKey : new Error(String(fav.siteKey)))))))
          .then(media => {
            if (media) {
              this.mediaItems.set(fav.id, media);
            }
          })
          .catch(error => {
            Logger.warn(this.TAG, `Failed to load detail for ${fav.id}: ${error}`);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ”¶è—é¡¹ä¸­çš„åŸºç¡€ä¿¡æ¯
            const placeholderMedia: MediaItem = {
              id: fav.id,
              siteKey: fav.siteKey,
              title: fav.title,
              coverUrl: fav.coverUrl,
              type: fav.type,
              year: fav.year,
              description: '',
              score: '',
              directors: [],
              actors: [],
              tags: [],
              category: '',
              region: '',
              language: '',
              updateTime: '',
              status: ''
            };
            this.mediaItems.set(fav.id, placeholderMedia);
          });
      });
      
      Promise.all(detailPromises).catch(error => {
        Logger.error(this.TAG, `Failed in Promise.all: ${error}`);
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}` instanceof Error ? `Failed to load media details: ${error}` : new Error(String(`Failed to load media details: ${error}`)))))));
    }
  }
  
  /**
   * å¤„ç†è¿”å›
   */
  private handleBack(): void {
    this.context.router.back();
  }
  
  /**
   * å¤„ç†ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
   */
  private toggleEditMode(): void {
    this.isEditMode = !this.isEditMode;
    this.selectedItems.clear();
  }
  
  /**
   * å¤„ç†é¡¹ç›®é€‰æ‹©
   */
  private handleItemSelect(favoriteId: string): void {
    if (this.selectedItems.has(favoriteId)) {
      this.selectedItems.delete(favoriteId);
    } else {
      this.selectedItems.add(favoriteId);
    }
  }
  
  /**
   * å¤„ç†å…¨é€?å–æ¶ˆå…¨é€?
   */
  private handleSelectAll(): void {
    if (this.selectedItems.size === this.favorites.length) {
      this.selectedItems.clear();
    } else {
      this.selectedItems = new Set(this.favorites.map(item => item.id));
    }
  }
  
  /**
   * å¤„ç†åˆ é™¤é€‰ä¸­é¡?
   */
  private handleDeleteSelected(): void {
    if (this.selectedItems.size === 0) return;
    
    const idsToDelete = Array.from(this.selectedItems);
    
    // åˆ é™¤é€‰ä¸­çš„æ”¶è—é¡¹
    favoriteService.removeFavorites(idsToDelete)
      .then(() => {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€?
        this.favorites = this.favorites.filter(fav => !idsToDelete.includes(fav.id));
        idsToDelete.forEach(id => {
          this.mediaItems.delete(id);
          this.selectedItems.delete(id);
        });
        
        Logger.info(this.TAG, `Deleted ${idsToDelete.length} favorites`);
        
        // å¦‚æœæ²¡æœ‰æ”¶è—é¡¹äº†ï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼?
        if (this.favorites.length === 0) {
          this.isEditMode = false;
        }
      })
      .catch(error => {
        Logger.error(this.TAG, `Failed to delete favorites: ${error}`);
        this.errorMessage = 'åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      });
  }
  
  /**
   * å¤„ç†åª’ä½“é¡¹ç‚¹å‡?
   */
  private handleMediaClick(favorite: FavoriteItem): void {
    if (this.isEditMode) {
      this.handleItemSelect(favorite.id);
      return;
    }
    
    Logger.info(this.TAG, `Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}` instanceof Error ? `Favorite clicked: ${favorite.title}` : new Error(String(`Favorite clicked: ${favorite.title}`)))))));
    // è·³è½¬åˆ°è¯¦æƒ…é¡µ
    AppNavigator.getInstance().navigateToDetail({
      id: favorite.id,
      siteKey: favorite.siteKey,
      type: 'vod'
    });
  }
  
  /**
   * å¤„ç†æ’åºæ–¹å¼åˆ‡æ¢
   */
  private handleSortChange(): void {
    this.sortBy = this.sortBy === 'time' ? 'title' : 'time';
    this.loadFavorites();
  }
  
  /**
   * å¤„ç†åˆ·æ–°
   */
  private handleRefresh(): void {
    this.isRefreshing = true;
    this.mediaItems.clear();
    this.loadFavorites();
  }
  
  /**
   * æ¸²æŸ“å¤´éƒ¨
   */
  @Builder
  private renderHeader(): void {
    Stack({ className: "header" }) {
      Button({ className: "back-button", onClick: this.handleBack }) {
        Text("â†?)
      }
      Text("æˆ‘çš„æ”¶è—").className("page-title")
      Button({ className: "action-button", onClick: this.toggleEditMode }) {
        Text(this.isEditMode ? "å–æ¶ˆ" : "ç¼–è¾‘")
      }
    }
  }
  
  /**
   * æ¸²æŸ“ç¼–è¾‘å·¥å…·æ ?
   */
  @Builder
  private renderEditToolbar(): void {
    if (!this.isEditMode || this.favorites.length === 0) return;
    
    Flex({ className: "edit-toolbar" }) {
      Flex({ className: "select-all" }) {
        Checkbox({ 
          checked: this.selectedItems.size === this.favorites.length && this.favorites.length > 0,
          onCheckChange: this.handleSelectAll 
        })
        Text("å…¨é€?)
      }
      Text("å·²é€‰æ‹© " + this.selectedItems.size + " é¡?).className("selected-count")
      Button({ 
        className: "delete-button", 
        onClick: this.handleDeleteSelected,
        disabled: this.selectedItems.size === 0 
      }) {
        Text("åˆ é™¤")
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ’åºé€‰é¡¹
   */
  @Builder
  private renderSortOption(): void {
    if (this.isEditMode || this.favorites.length === 0) return;
    
    Flex({ className: "sort-option" }) {
      Text("æ’åºï¼?)
      Button({ 
        className: `sort-button ${this.sortBy === 'time' ? 'selected' : ''}`,
        onClick: () => {
          this.sortBy = 'time';
          this.loadFavorites();
        }
      }) {
        Text("æ—¶é—´")
      }
      Button({ 
        className: `sort-button ${this.sortBy === 'title' ? 'selected' : ''}`,
        onClick: () => {
          this.sortBy = 'title';
          this.loadFavorites();
        }
      }) {
        Text("æ ‡é¢˜")
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ”¶è—é¡?
   */
  @Builder
  private renderFavoriteItem(favorite: FavoriteItem): void {
    const media = this.mediaItems.get(favorite.id);
    
    ListItem({ onClick: () => this.handleMediaClick(favorite) }) {
      Flex({ className: "favorite-item" }) {
        if (this.isEditMode) {
          Checkbox({ 
            checked: this.selectedItems.has(favorite.id),
            onCheckChange: () => this.handleItemSelect(favorite.id) 
          })
        }
        Image({
          src: media?.coverUrl || favorite.coverUrl || "https://via.placeholder.com/120x160?text=No+Image",
          className: "media-cover",
          objectFit: "cover"
        })
        Flex({ className: "media-info", direction: "column" }) {
          Text(media?.title || favorite.title).className("media-title").numberOfLines(2)
          Flex({ className: "media-meta" }) {
            if (favorite.type) {
              Tag({ className: "meta-tag" }) {
                Text(favorite.type)
              }
            }
            if (favorite.year) {
              Tag({ className: "meta-tag" }) {
                Text(favorite.year)
              }
            }
            if (media?.score) {
              Tag({ className: "meta-tag score" }) {
                Text(media.score)
              }
            }
          }
          Text("æ”¶è—æ—¶é—´: " + new Date(favorite.addTime).toLocaleDateString()).className("add-time")
          if (media?.description) {
            Text(media.description).className("media-description").numberOfLines(2)
          }
        }
      }
    }
  }
  
  /**
   * æ¸²æŸ“æ”¶è—åˆ—è¡¨
   */
  @Builder
  private renderFavoritesList(): void {
    if (this.isLoading && !this.isRefreshing) {
      Stack({ className: "loading-container" }) {
        LoadingProgress({ className: "loading-progress", color: "#FF4500" })
        Text("åŠ è½½ä¸?..")
      }
      return;
    }
    
    if (this.errorMessage) {
      Stack({ className: "error-container" }) {
        Text("âš ï¸").className("error-icon")
        Text(this.errorMessage).className("error-message")
        Button({ className: "retry-button", onClick: this.loadFavorites }) {
          Text("é‡è¯•")
        }
      }
      return;
    }
    
    if (this.favorites.length === 0) {
      Empty({ className: "empty-container" }) {
        Text("ğŸŒŸ").className("empty-icon")
        Text("æš‚æ— æ”¶è—å†…å®¹")
        Button({ className: "explore-button", onClick: () => AppNavigator.getInstance().navigateToHome() }) {
          Text("å»æ¢ç´?)
        }
      }
      return;
    }
    
    List({
      className: "favorites-list",
      itemTemplate: this.renderFavoriteItem,
      data: this.favorites,
      onRefresh: () => this.handleRefresh(),
      refreshing: this.isRefreshing
    })
  }
  
  /**
   * ç»„ä»¶æ¸²æŸ“
   */
  build() {
    Stack({ className: "favorites-page" }) {
      // é¡µé¢å¤´éƒ¨
      this.renderHeader()
      
      // ç¼–è¾‘å·¥å…·æ ?
      this.renderEditToolbar()
      
      // æ’åºé€‰é¡¹
      this.renderSortOption()
      
      // æ”¶è—åˆ—è¡¨
      ScrollView({ className: "content-scroll", scrollBar: "auto" }) {
        this.renderFavoritesList()
        Blank({ className: "bottom-space" })
      }
    }
  }
}

export default FavoritesPage;


