import { AppNavigator } from '../navigation/AppNavigator';
import Logger from '../common/util/Logger';
import { HistoryService } from '../service/media/HistoryService';
import { MediaService } from '../service/media/MediaService';
import display from '@ohos.display';
import { ScrollDirection, BarState, FlexAlign, FlexDirection, ImageFit, TextAlign, VerticalAlign } from '@ohos/arkui';
import VirtualList from '../components/VirtualList';
import { VirtualListItem } from '../types/VirtualListTypes';

// å†å²è®°å½•é¡¹ | History item
interface HistoryItem {
  id: string;
  mediaId: string;
  siteKey: string;
  title: string;
  cover?: string;
  type: string;
  episodeId?: string;
  episodeTitle?: string;
  episodeIndex?: number;
  progress: number;
  duration?: number;
  lastPlayTime: number;
}

// åª’ä½“é¡¹ | Media item
interface MediaItem {
  id: string;
  siteKey: string;
  title: string;
  coverUrl: string;
  type: string;
  year?: string;
  description?: string;
  score?: string;
}

@Entry
@Component
struct HistoryPage {
  private readonly TAG: string = 'HistoryPage';
  private scroller: Scroller = new Scroller();
  
  // çŠ¶æ€ç®¡ç† | State management
  @State histories: HistoryItem[] = [];
  @State mediaItems: Map<string, MediaItem> = new Map();
  @State isLoading: boolean = true;
  @State isError: boolean = false;
  @State errorMessage: string = 'åŠ è½½å¤±è´¥';
  @State isEditMode: boolean = false;
  @State selectedItems: Set<string> = new Set();
  @State isRefreshing: boolean = false;
  @State autoPlayLast: boolean = true;
  @State isLandscape: boolean = false;
  @State screenWidth: number = 0;
  @State screenHeight: number = 0;
  @State coverWidth: number = 120;
  @State coverHeight: number = 160;
  
  // æœåŠ¡å®ä¾‹ | Service instances
  private historyService: HistoryService = HistoryService.getInstance();
  private mediaService: MediaService = MediaService.getInstance();
  
  // ç”Ÿå‘½å‘¨æœŸ | Lifecycle
  aboutToAppear() {
    Logger.info(this.TAG, 'HistoryPage about to appear');
    
    // åˆå§‹åŒ–å±å¹•ä¿¡æ¯ | Initialize screen information
    this.initScreenInfo();
    
    // åŠ è½½å†å²è®°å½• | Load history records
    this.loadHistories();
  }
  
  // åˆå§‹åŒ–å±å¹•ä¿¡æ¯ | Initialize screen information
  private initScreenInfo() {
    try {
      const displayInfo = display.getDefaultDisplaySync();
      this.screenWidth = displayInfo.width;
      this.screenHeight = displayInfo.height;
      this.isLandscape = this.screenWidth > this.screenHeight;
      
      // æ ¹æ®å±å¹•æ–¹å‘è°ƒæ•´å°é¢å¤§å° | Adjust cover size based on screen orientation
      if (this.isLandscape) {
        this.coverWidth = 150;
        this.coverHeight = 200;
      } else {
        this.coverWidth = 120;
        this.coverHeight = 160;
      }
      
      Logger.info(this.TAG, `Screen info: width=${this.screenWidth}, height=${this.screenHeight}, landscape=${this.isLandscape}, coverSize=${this.coverWidth}x${this.coverHeight}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to get screen info: ${error}`);
      // é»˜è®¤å€¼ | Default values
      this.screenWidth = 1920;
      this.screenHeight = 1080;
      this.isLandscape = true;
      this.coverWidth = 150;
      this.coverHeight = 200;
    }
  }
  
  /**
   * åŠ è½½å†å²è®°å½• | Load history records
   */
  private async loadHistories(): Promise<void> {
    try {
      this.isLoading = true;
      this.isError = false;
      this.errorMessage = '';
      
      Logger.info(this.TAG, 'Loading history records');
      
      // è°ƒç”¨å®é™…çš„HistoryServiceè·å–å†å²è®°å½• | Call actual HistoryService to get history records
      const result = await this.historyService.getHistories(100);
      
      if (result.isSuccess() && result.data) {
        // æŒ‰æœ€åæ’­æ”¾æ—¶é—´å€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰ | Sort by last play time in reverse order (newest first)
        this.histories = result.data.sort((a, b) => b.lastPlayTime - a.lastPlayTime);
        
        // åŠ è½½åª’ä½“è¯¦æƒ… | Load media details
        await this.loadMediaDetails(this.histories);
        
        Logger.info(this.TAG, `Loaded ${this.histories.length} history records in reverse chronological order`);
      } else {
        this.isError = true;
        this.errorMessage = result.message || 'åŠ è½½å¤±è´¥';
        Logger.warn(this.TAG, `Failed to load histories: ${this.errorMessage}`);
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      Logger.error(this.TAG, `Failed to load histories: ${errorMsg}`);
      this.isError = true;
      this.errorMessage = errorMsg;
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }
  
  /**
   * åŠ è½½åª’ä½“è¯¦æƒ… | Load media details
   */
  private async loadMediaDetails(histories: HistoryItem[]): Promise<void> {
    try {
      // å¹¶è¡ŒåŠ è½½åª’ä½“è¯¦æƒ… | Load media details in parallel
      const detailPromises = histories.map(async (history) => {
        try {
          // è°ƒç”¨å®é™…çš„MediaServiceè·å–åª’ä½“è¯¦æƒ… | Call actual MediaService to get media details
          const result = await this.mediaService.getMediaDetail(history.mediaId, history.siteKey, history.type);
          
          if (result.isSuccess() && result.data) {
            this.mediaItems.set(history.mediaId, {
              id: result.data.id,
              siteKey: result.data.siteKey || '',
              title: result.data.title,
              coverUrl: result.data.cover || '',
              type: result.data.type || '',
              year: result.data.year,
              description: result.data.description,
              score: result.data.rating
            });
          } else {
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†å²è®°å½•ä¸­çš„åŸºæœ¬ä¿¡æ¯ | If loading fails, use basic information from history records
            this.mediaItems.set(history.mediaId, {
              id: history.mediaId,
              siteKey: history.siteKey,
              title: history.title,
              coverUrl: history.cover || '',
              type: history.type
            });
          }
        } catch (error) {
          Logger.warn(this.TAG, `Failed to load detail for ${history.mediaId}: ${error}`);
          // ä½¿ç”¨å†å²è®°å½•ä¸­çš„åŸºæœ¬ä¿¡æ¯ | Use basic information from history records
          this.mediaItems.set(history.mediaId, {
            id: history.mediaId,
            siteKey: history.siteKey,
            title: history.title,
            coverUrl: history.cover || '',
            type: history.type
          });
        }
      });
      
      await Promise.all(detailPromises);
    } catch (error) {
      Logger.error(this.TAG, `Failed to load media details: ${error}`);
    }
  }
  
  /**
   * å¤„ç†è¿”å› | Handle back
   */
  private async handleBack(): Promise<void> {
    try {
      await AppNavigator.getInstance().navigateToBack();
      Logger.info(this.TAG, 'Navigating back');
    } catch (error) {
      Logger.error(this.TAG, `Failed to navigate back: ${error}`);
    }
  }
  
  /**
   * å¤„ç†ç¼–è¾‘æ¨¡å¼åˆ‡æ¢ | Handle edit mode toggle
   */
  private toggleEditMode(): void {
    this.isEditMode = !this.isEditMode;
    this.selectedItems.clear();
    Logger.info(this.TAG, `Edit mode ${this.isEditMode ? 'enabled' : 'disabled'}`);
  }
  
  /**
   * å¤„ç†é¡¹ç›®é€‰æ‹© | Handle item selection
   */
  private handleItemSelect(historyId: string): void {
    if (this.selectedItems.has(historyId)) {
      this.selectedItems.delete(historyId);
    } else {
      this.selectedItems.add(historyId);
    }
    Logger.info(this.TAG, `Selected items count: ${this.selectedItems.size}`);
  }
  
  /**
   * å¤„ç†å…¨é€‰/å–æ¶ˆå…¨é€‰ | Handle select all / deselect all
   */
  private handleSelectAll(): void {
    if (this.selectedItems.size === this.histories.length) {
      this.selectedItems.clear();
    } else {
      this.selectedItems = new Set(this.histories.map(item => item.id));
    }
    Logger.info(this.TAG, `Select all: ${this.selectedItems.size === this.histories.length}`);
  }
  
  /**
   * å¤„ç†åˆ é™¤é€‰ä¸­é¡¹ | Handle delete selected items
   */
  private async handleDeleteSelected(): Promise<void> {
    if (this.selectedItems.size === 0) return;
    
    try {
      const idsToDelete = Array.from(this.selectedItems);
      
      Logger.info(this.TAG, `Deleting ${idsToDelete.length} history items`);
      
      // è°ƒç”¨å®é™…çš„HistoryServiceåˆ é™¤é€‰ä¸­çš„å†å²è®°å½• | Call actual HistoryService to delete selected history records
      const result = await this.historyService.removeHistories(idsToDelete);
      
      if (result.isSuccess()) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€ | Update local state
        this.histories = this.histories.filter(history => !idsToDelete.includes(history.id));
        
        // æ¸…ç†å·²åˆ é™¤é¡¹çš„åª’ä½“ä¿¡æ¯ç¼“å­˜ | Clean up media information cache for deleted items
        idsToDelete.forEach(id => {
          const history = this.histories.find(h => h.id === id);
          if (history) {
            this.mediaItems.delete(history.mediaId);
          }
        });
        
        // æ¸…ç©ºé€‰æ‹© | Clear selection
        this.selectedItems.clear();
        
        Logger.info(this.TAG, `Successfully deleted ${idsToDelete.length} history items`);
      } else {
        Logger.error(this.TAG, `Failed to delete histories: ${result.message}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to delete histories: ${error}`);
    }
  }
  
  /**
   * å¤„ç†æ¸…ç©ºæ‰€æœ‰å†å² | Handle clear all history
   */
  private async handleClearAll(): Promise<void> {
    try {
      Logger.info(this.TAG, 'Clearing all history records');
      
      // è°ƒç”¨å®é™…çš„HistoryServiceæ¸…ç©ºæ‰€æœ‰å†å²è®°å½• | Call actual HistoryService to clear all history records
      const result = await this.historyService.clearAllHistories();
      
      if (result.isSuccess()) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€ | Update local state
        this.histories = [];
        this.mediaItems.clear();
        this.selectedItems.clear();
        this.isEditMode = false;
        
        Logger.info(this.TAG, 'Successfully cleared all history records');
      } else {
        Logger.error(this.TAG, `Failed to clear all histories: ${result.message}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear all histories: ${error}`);
    }
  }
  
  /**
   * å¤„ç†å†å²ç‚¹å‡» | Handle history click
   */
  private async handleHistoryClick(history: HistoryItem): Promise<void> {
    if (this.isEditMode) {
      this.handleItemSelect(history.id);
      return;
    }
    
    Logger.info(this.TAG, `History clicked: ${history.title}, episode: ${history.episodeIndex}`);
    
    try {
      // æ›´æ–°æ’­æ”¾å†å²æ—¶é—´ | Update play history time
      const updateResult = await this.historyService.updateHistoryTime(history.id);
      
      if (!updateResult.isSuccess()) {
        Logger.warn(this.TAG, `Failed to update history time: ${updateResult.message}`);
      }
      
      // è·³è½¬åˆ°æ’­æ”¾é¡µé¢ï¼Œå¸¦ä¸Šä¸Šæ¬¡æ’­æ”¾çš„è¿›åº¦ | Jump to playback page with last play progress
      AppNavigator.getInstance().navigateToPlayback({
        id: history.mediaId,
        siteKey: history.siteKey,
        type: history.type,
        episodeId: history.episodeId,
        playbackPosition: history.progress * 1000
      });
    } catch (error) {
      Logger.error(this.TAG, `Failed to handle history click: ${error}`);
      
      // å³ä½¿æ›´æ–°å¤±è´¥ï¼Œä¹Ÿè·³è½¬åˆ°æ’­æ”¾é¡µé¢ | Even if update fails, still jump to playback page
      AppNavigator.getInstance().navigateToPlayback({
        id: history.mediaId,
        siteKey: history.siteKey,
        type: history.type,
        episodeId: history.episodeId,
        playbackPosition: history.progress * 1000
      });
    }
  }
  
  /**
   * å¤„ç†ç»§ç»­æ’­æ”¾ | Handle continue play
   */
  private handleContinuePlay(history: HistoryItem): void {
    Logger.info(this.TAG, `Continue playing: ${history.title} from ${history.progress}s`);
    
    // è·³è½¬åˆ°æ’­æ”¾é¡µé¢ï¼Œå¸¦ä¸Šä¸Šæ¬¡æ’­æ”¾çš„è¿›åº¦ | Jump to playback page with last play progress
    AppNavigator.getInstance().navigateToPlayback({
      id: history.mediaId,
      siteKey: history.siteKey,
      type: history.type,
      episodeId: history.episodeId,
      playbackPosition: history.progress * 1000
    });
  }
  
  /**
   * å¤„ç†åˆ·æ–° | Handle refresh
   */
  private handleRefresh(): void {
    this.isRefreshing = true;
    this.mediaItems.clear();
    this.loadHistories();
  }
  
  /**
   * æ ¼å¼åŒ–æ’­æ”¾è¿›åº¦ | Format playback progress
   */
  private formatPlaybackProgress(progress: number, duration?: number): string {
    const progressSec = Math.floor(progress);
    const durationSec = Math.floor(duration || 0);
    
    const progMin = Math.floor(progressSec / 60);
    const progSec = progressSec % 60;
    const durMin = Math.floor(durationSec / 60);
    const durSec = durationSec % 60;
    
    return `${progMin.toString().padStart(2, '0')}:${progSec.toString().padStart(2, '0')} / ${durMin.toString().padStart(2, '0')}:${durSec.toString().padStart(2, '0')}`;
  }
  
  /**
   * è®¡ç®—æ’­æ”¾è¿›åº¦ç™¾åˆ†æ¯” | Calculate playback progress percentage
   */
  private getProgressPercentage(progress: number, duration?: number): number {
    if (!duration || duration === 0) return 0;
    return Math.min(100, Math.max(0, (progress / duration) * 100));
  }
  
  /**
   * æ ¼å¼åŒ–æ—¶é—´ | Format time
   */
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  /**
   * å°†HistoryItemè½¬æ¢ä¸ºVirtualListItem | Convert HistoryItem to VirtualListItem
   */
  private convertToVirtualItems(historyList: HistoryItem[]): VirtualListItem[] {
    return historyList.map((history, index) => ({
      id: history.id,
      index: index,
      data: history,
      top: index * (this.isLandscape ? 320 : 280), // ä¼°ç®—çš„é¡¹ç›®é«˜åº¦
      height: this.isLandscape ? 320 : 280,
      visible: false
    }));
  }
  
  // æ¸²æŸ“å†å²è®°å½•é¡¹ | Render history item
  @Builder
  renderHistoryItem(history: HistoryItem) {
    const media = this.mediaItems.get(history.mediaId);
    const progressText = this.formatPlaybackProgress(history.progress, history.duration);
    const progressPercentage = this.getProgressPercentage(history.progress, history.duration);
    const isSelected = this.selectedItems.has(history.id);
    
    Column() {
      Row() {
        // é€‰æ‹©æ¡† | Selection checkbox
        if (this.isEditMode) {
          Button() {
            Text(isSelected ? 'âœ“' : '')
              .fontSize(22)
              .fontColor('#FFFFFF')
              .fontWeight(600)
          }
          .width(45)
          .height(45)
          .backgroundColor(isSelected ? '#4CAF50' : '#E0E0E0')
          .borderRadius(22.5)
          .margin({ right: 20 })
          .onClick(() => this.handleItemSelect(history.id))
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, `Selection checkbox focused for ${history.id}`);
          })
        }
        
        // å°é¢ | Cover
        Image(media?.coverUrl || history.cover || 'https://via.placeholder.com/150x200?text=No+Image')
          .width(this.coverWidth)
          .height(this.coverHeight)
          .objectFit(ImageFit.Cover)
          .borderRadius(12)
          .backgroundColor('#F5F5F5')
          .margin({ right: this.isLandscape ? 30 : 20 })
          .onError(() => {
            Logger.warn(this.TAG, `Failed to load cover image: ${media?.coverUrl || history.cover}`);
          })
        
        // ä¿¡æ¯ | Info
        Column() {
          Text(media?.title || history.title)
            .fontSize(this.isLandscape ? 22 : 18)
            .fontWeight(600)
            .fontColor('#333333')
            .maxLines(2)
            .margin({ bottom: 10 })
          
          if (history.episodeTitle) {
            Text(history.episodeTitle)
              .fontSize(this.isLandscape ? 16 : 14)
              .fontColor('#666666')
              .margin({ bottom: 10 })
          }
          
          Text(`æ’­æ”¾æ—¶é—´: ${this.formatTime(history.lastPlayTime)}`)
            .fontSize(this.isLandscape ? 16 : 14)
            .fontColor('#999999')
            .margin({ bottom: 12 })
          
          // æ’­æ”¾è¿›åº¦æ¡ | Playback progress bar
          Column() {
            Row() {
              Text(progressText)
                .fontSize(this.isLandscape ? 14 : 12)
                .fontColor('#666666')
                .flexGrow(1)
                .textAlign(TextAlign.Start)
              Text(`${Math.round(progressPercentage)}%`)
                .fontSize(this.isLandscape ? 14 : 12)
                .fontColor('#666666')
                .margin({ left: 15 })
            }
            .width('100%')
            .margin({ bottom: 8 })
            
            Row() {
              Column()
                .width(`${progressPercentage}%`)
                .height(6)
                .backgroundColor('#4CAF50')
                .borderRadius(3)
              Column()
                .width(`${100 - progressPercentage}%`)
                .height(6)
                .backgroundColor('#E0E0E0')
                .borderRadius(3)
            }
            .width('100%')
            .borderRadius(3)
            .backgroundColor('#E0E0E0')
          }
          .margin({ bottom: 15 })
          
          // æ“ä½œæŒ‰é’® | Action buttons
          if (!this.isEditMode) {
            Row() {
              Button() {
                Text('ç»§ç»­è§‚çœ‹')
                  .fontSize(this.isLandscape ? 16 : 14)
                  .fontColor('#FFFFFF')
                  .fontWeight(500)
              }
              .width(this.isLandscape ? 140 : 120)
              .height(this.isLandscape ? 45 : 40)
              .backgroundColor('#4CAF50')
              .borderRadius(8)
              .onClick(() => this.handleContinuePlay(history))
              .focusable(true)
              .onFocus(() => {
                Logger.info(this.TAG, `Continue play button focused for ${history.id}`);
              })
            }
          }
        }
        .flexGrow(1)
      }
      .width('100%')
      .padding(this.isLandscape ? 25 : 20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .margin({ bottom: 20 })
      .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.15)', offsetY: 4 })
    }
    .width('100%')
    .onClick(() => this.handleHistoryClick(history))
  }
  
  // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨ | Render history list
  @Builder
  renderHistoryList() {
    if (this.isLoading && !this.isRefreshing) {
      Column() {
        Text('åŠ è½½ä¸­...')
          .fontSize(24)
          .fontColor('#666666')
          .margin(40)
          .fontWeight(500)
      }
      .justifyContent(FlexAlign.Center)
      .height(this.isLandscape ? '80%' : 500)
    } else if (this.isError) {
      Column() {
        Text('åŠ è½½å¤±è´¥')
          .fontSize(24)
          .fontColor('#FF5252')
          .margin({ top: 20 })
          .fontWeight(600)
        Text(this.errorMessage)
          .fontSize(18)
          .fontColor('#FF9800')
          .margin({ top: 12, left: 40, right: 40 })
          .textAlign(TextAlign.Center)
        Button('é‡è¯•')
          .onClick(() => this.loadHistories())
          .backgroundColor('#4CAF50')
          .fontColor('white')
          .borderRadius(12)
          .padding({ left: 30, right: 30, top: 12, bottom: 12 })
          .margin({ top: 25 })
          .fontSize(16)
          .fontWeight(500)
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, 'Retry button focused');
          })
      }
      .justifyContent(FlexAlign.Center)
      .height(this.isLandscape ? '80%' : 500)
    } else if (this.histories.length === 0) {
      Column() {
        Text('ğŸ“º')
          .fontSize(80)
          .margin({ bottom: 30 })
        Text('æš‚æ— æ’­æ”¾å†å²')
          .fontSize(24)
          .fontColor('#999999')
          .margin({ bottom: 15 })
          .fontWeight(500)
        Text('è§‚çœ‹è§†é¢‘åä¼šè‡ªåŠ¨è®°å½•æ’­æ”¾å†å²')
          .fontSize(18)
          .fontColor('#CCCCCC')
          .margin({ bottom: 40 })
        Button('å»æ¢ç´¢')
          .onClick(() => AppNavigator.getInstance().navigateToHome())
          .backgroundColor('#4CAF50')
          .fontColor('white')
          .borderRadius(12)
          .padding({ left: 40, right: 40, top: 15, bottom: 15 })
          .fontSize(18)
          .fontWeight(500)
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, 'Explore button focused');
          })
      }
      .justifyContent(FlexAlign.Center)
      .height(this.isLandscape ? '80%' : 500)
    } else {
      // ä½¿ç”¨VirtualListä¼˜åŒ–æ€§èƒ½ | Use VirtualList for better performance
      const virtualItems = this.convertToVirtualItems(this.histories);
      
      VirtualList({
        items: virtualItems,
        estimatedItemHeight: this.isLandscape ? 320 : 280,
        bufferSize: 3,
        renderItem: (item: VirtualListItem) => {
          const history = item.data as HistoryItem;
          return this.renderHistoryItem(history);
        }
      })
      .width('100%')
      .padding({ bottom: 40 })
      .height(this.isLandscape ? '80%' : 500)
    }
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ  | Top navigation bar
      Row() {
        // è¿”å›æŒ‰é’® | Back button
        Button() {
          Text('è¿”å›')
            .fontSize(18)
            .fontColor('#FFFFFF')
            .fontWeight(500)
        }
        .width(100)
        .height(60)
        .backgroundColor('#4CAF50')
        .borderRadius(12)
        .margin({ left: this.isLandscape ? 40 : 30 })
        .onClick(() => this.handleBack())
        .focusable(true)
        .onFocus(() => {
          Logger.info(this.TAG, 'Back button focused');
        })
        
        // æ ‡é¢˜ | Title
        Text('æ’­æ”¾å†å²')
          .fontSize(26)
          .fontWeight(700)
          .fontColor('#333333')
          .flexGrow(1)
          .margin({ left: this.isLandscape ? 40 : 30 })
          .textAlign(TextAlign.Start)
        
        // ç¼–è¾‘æŒ‰é’® | Edit button
        Button() {
          Text(this.isEditMode ? 'å–æ¶ˆ' : 'ç¼–è¾‘')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .fontWeight(500)
        }
        .width(100)
        .height(60)
        .backgroundColor('#2196F3')
        .borderRadius(12)
        .margin({ right: this.isLandscape ? 40 : 30 })
        .onClick(() => this.toggleEditMode())
        .focusable(true)
        .onFocus(() => {
          Logger.info(this.TAG, 'Edit button focused');
        })
      }
      .width('100%')
      .height(80)
      .alignItems(VerticalAlign.Center)
      .backgroundColor('#FFFFFF')
      .borderBottomWidth(2)
      .borderBottomColor('#E0E0E0')
      .shadow({ radius: 4, color: 'rgba(0, 0, 0, 0.1)', offsetY: 2 })
      
      // ç¼–è¾‘å·¥å…·æ  | Edit toolbar
      if (this.isEditMode && this.histories.length > 0) {
        Row() {
          Button() {
            Text(this.selectedItems.size === this.histories.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(500)
          }
          .width(150)
          .height(50)
          .backgroundColor('#2196F3')
          .borderRadius(8)
          .margin({ left: this.isLandscape ? 40 : 30 })
          .onClick(() => this.handleSelectAll())
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, 'Select all button focused');
          })
          
          Text(`å·²é€‰æ‹© ${this.selectedItems.size} é¡¹`)
            .fontSize(18)
            .fontColor('#333333')
            .fontWeight(500)
            .flexGrow(1)
            .margin({ left: this.isLandscape ? 40 : 30 })
          
          Button() {
            Text('åˆ é™¤')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(500)
          }
          .width(100)
          .height(50)
          .backgroundColor('#F44336')
          .borderRadius(8)
          .margin({ right: 15 })
          .onClick(() => this.handleDeleteSelected())
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, 'Delete button focused');
          })
          
          Button() {
            Text('æ¸…ç©º')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(500)
          }
          .width(100)
          .height(50)
          .backgroundColor('#9E9E9E')
          .borderRadius(8)
          .margin({ right: this.isLandscape ? 40 : 30 })
          .onClick(() => this.handleClearAll())
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, 'Clear all button focused');
          })
        }
        .width('100%')
        .height(70)
        .alignItems(VerticalAlign.Center)
        .backgroundColor('#F5F5F5')
      }
      
      // è®¾ç½®é€‰é¡¹ | Settings options
      if (!this.isEditMode && this.histories.length > 0) {
        Row() {
          Text('è‡ªåŠ¨ç»­æ’­ä¸Šæ¬¡å†…å®¹')
            .fontSize(18)
            .fontColor('#333333')
            .fontWeight(500)
            .flexGrow(1)
            .margin({ left: this.isLandscape ? 40 : 30 })
          
          Button() {
            Text(this.autoPlayLast ? 'å¼€' : 'å…³')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(500)
          }
          .width(80)
          .height(50)
          .backgroundColor(this.autoPlayLast ? '#4CAF50' : '#9E9E9E')
          .borderRadius(8)
          .margin({ right: this.isLandscape ? 40 : 30 })
          .onClick(() => this.autoPlayLast = !this.autoPlayLast)
          .focusable(true)
          .onFocus(() => {
            Logger.info(this.TAG, 'Auto play toggle focused');
          })
        }
        .width('100%')
        .height(70)
        .alignItems(VerticalAlign.Center)
        .backgroundColor('#F5F5F5')
      }
      
      // å†å²è®°å½•åˆ—è¡¨ | History list
      Scroll(this.scroller) {
        Column() {
          this.renderHistoryList()
        }
        .width('100%')
        .padding({ 
          top: 25, 
          left: this.isLandscape ? 40 : 30, 
          right: this.isLandscape ? 40 : 30 
        })
      }
      .scrollBar(BarState.Auto)
      .flexGrow(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
