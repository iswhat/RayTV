// DistributedDataService.ets - ÂàÜÂ∏ÉÂºèÊï∞ÊçÆÊúçÂä?
// Âü∫‰∫éHarmonyOSÂàÜÂ∏ÉÂºèËÉΩÂäõÂÆûÁé∞Â§öËÆæÂ§áÊï∞ÊçÆÂêåÊ≠•

import Logger from '../../common/util/Logger';
import distributedKVStore from '@ohos.data.distributedKVStore';
import BusinessError from '@ohos.base';
import ConfigService from '../../service/config/ConfigService';
import common from '@ohos.app.ability.common';
import { SyncData, DataChangeListener } from '../../types/common';

// Â∏∏ÈáèÂÆö‰πâ
const TAG = 'DistributedDataService';
const STORE_ID = 'raytv_distributed_data';

// Êï∞ÊçÆÂêåÊ≠•Á±ªÂûãÊûö‰∏æ
export enum SyncDataType {
  HISTORY = 'history',
  FAVORITES = 'favorites',
  CONFIG = 'config',
  PLAYBACK_PROGRESS = 'playback_progress',
  DEVICE_INFO = 'device_info'
}

// ÂêåÊ≠•ÂÜ≤Á™ÅËß£ÂÜ≥Á≠ñÁï•Êûö‰∏æ
export enum ConflictResolutionStrategy {
  LATEST_WIN = 'latest_win', // ÊúÄÊñ∞Êó∂Èó¥Êà≥‰ºòÂÖà
  LOCAL_WIN = 'local_win',   // Êú¨Âú∞Êï∞ÊçÆ‰ºòÂÖà
  REMOTE_WIN = 'remote_win', // ËøúÁ®ãÊï∞ÊçÆ‰ºòÂÖà
  MERGE = 'merge'            // ÂêàÂπ∂Êï∞ÊçÆ
}

// ÂêåÊ≠•Áä∂ÊÄÅÊûö‰∏?
export enum SyncStatus {
  IDLE = 'idle',
  SYNCHRONIZING = 'synchronizing',
  COMPLETED = 'completed',
  FAILED = 'failed',
  CONFLICT = 'conflict'
}

// ÂêåÊ≠•ÈÖçÁΩÆÊé•Âè£
export interface SyncConfig {
  enabled: boolean;
  autoSync: boolean;
  syncInterval: number; // Áß?
  conflictStrategy: ConflictResolutionStrategy;
  syncTypes: SyncDataType[];
  allowCellularSync: boolean;
  showSyncNotifications: boolean;
}

// ÈªòËÆ§ÂêåÊ≠•ÈÖçÁΩÆ
const DEFAULT_SYNC_CONFIG: SyncConfig = {
  enabled: true,
  autoSync: true,
  syncInterval: 300, // 5ÂàÜÈíü
  conflictStrategy: ConflictResolutionStrategy.LATEST_WIN,
  syncTypes: [SyncDataType.HISTORY, SyncDataType.FAVORITES],
  allowCellularSync: false,
  showSyncNotifications: true
};

// ÂêåÊ≠•Áä∂ÊÄÅÊé•Âè?
export interface SyncState {
  status: SyncStatus;
  lastSyncTime?: number;
  lastSyncResult?: boolean;
  error?: string;
  conflictCount?: number;
  syncedDevices?: string[];
  syncDataSize?: number;
}

// ÂàÜÂ∏ÉÂºèÊï∞ÊçÆÁõëÂê¨ÂõûË∞ÉÁ±ªÂûãÂ∑≤‰ªécommon.d.tsÂØºÂÖ•

export default class DistributedDataService {
  static instance: DistributedDataService;
  kvManager: distributedKVStore.KVManager | null = null;
  kvStore: distributedKVStore.SingleKVStore | null = null;
  configService: ConfigService;
  syncConfig: SyncConfig = DEFAULT_SYNC_CONFIG;
  syncState: SyncState = { status: SyncStatus.IDLE };
  dataListeners: Map<string, DataChangeListener[]> = new Map();
  syncTimerId: number | null = null;
  deviceIds: string[] = [];
  isInitialized: boolean = false;
  private context: common.Context | null = null;

  /**
   * Ëé∑ÂèñÂçï‰æãÂÆû‰æã
   */
  static getInstance(): DistributedDataService {
    if (!DistributedDataService.instance) {
      DistributedDataService.instance = new DistributedDataService();
    }
    return DistributedDataService.instance;
  }

  /**
   * ÊûÑÈÄ†ÂáΩÊï?
   */
  constructor() {
  }

  /**
   * ÂàùÂßãÂåñÂàÜÂ∏ÉÂºèÊï∞ÊçÆÊúçÂä°
   * @param context Â∫îÁî®‰∏ä‰∏ãÊñ?
   */
  async initialize(context: common.Context): Promise<void> {
    if (this.isInitialized) {
      Logger.info(TAG, 'Distributed data service already initialized');
      return;
    }

    this.context = context;

    try {
      Logger.info(TAG, 'Initializing distributed data service...');

      // ÂàõÂª∫KVManager
      const managerConfig: distributedKVStore.KVManagerConfig = {
        context: context,
        bundleName: 'com.example.raytv'
      };
      
      try {
        this.kvManager = await distributedKVStore.createKVManager(managerConfig);
      } catch (error: Error) {
        Logger.error(TAG, `Failed to create KVManager: ${JSON.stringify(error)}`);
        throw new Error(`KVManager creation failed: ${error instanceof Error ? error.message : String(error)}`);
      }

      if (!this.kvManager) {
        throw new Error('Failed to create KVManager instance');
      }

      // Ëé∑ÂèñKVStore
      const options: distributedKVStore.Options = {
        createIfMissing: true, encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options instanceof Error ? encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options : new Error(String(encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      try {
        this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options)))))));
      } catch (error: Error) {
        Logger.error(TAG, `Failed to get KVStore: ${JSON.stringify(error)}`);
        throw new Error(`KVStore initialization failed: ${error instanceof Error ? error.message : String(error)}`);
      }
      
      if (!this.kvStore) {
        throw new Error('Failed to get KVStore instance');
      }

      // ÂàùÂßãÂåñConfigService
      this.configService = ConfigService.getInstance();
      
      // Âä†ËΩΩÂêåÊ≠•ÈÖçÁΩÆ
      await this.loadSyncConfig();

      // Ê≥®ÂÜåÊï∞ÊçÆÂèòÂåñÁõëÂê¨
      await this.registerDataChangeListener();

      // ÂêØÂä®Ëá™Âä®ÂêåÊ≠•
      if (this.syncConfig.autoSync && this.syncConfig.enabled) {
        this.startAutoSync();
      }

      this.isInitialized = true;
      Logger.info(TAG, 'Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully' instanceof Error ? 'Distributed data service initialized successfully' : new Error(String('Distributed data service initialized successfully')))))));
    } catch (error: Error) {
      Logger.error(TAG, `Failed to initialize distributed data service: ${error instanceof Error ? error.message : String(error)}`);
      throw error;
    }
  }

  /**
   * Âä†ËΩΩÂêåÊ≠•ÈÖçÁΩÆ
   */
  async loadSyncConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig('syncConfig', DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG)))))));
      if (savedConfig) {
        this.syncConfig = { ...DEFAULT_SYNC_CONFIG, ...savedConfig };
      }
    } catch (error: Error) {
      Logger.error(TAG, `Failed to load sync config: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * ‰øùÂ≠òÂêåÊ≠•ÈÖçÁΩÆ
   */
  async saveSyncConfig(config: Partial<SyncConfig>): Promise<void> {
    try {
      this.syncConfig = { ...this.syncConfig, ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig)))))));
      
      // Ê†πÊçÆÈÖçÁΩÆË∞ÉÊï¥Ëá™Âä®ÂêåÊ≠•
      if (this.syncConfig.autoSync && this.syncConfig.enabled) {
        this.startAutoSync();
      } else {
        this.stopAutoSync();
      }
    } catch (error: Error) {
      Logger.error(TAG, `Failed to save sync config: ${error instanceof Error ? error.message : String(error)}`);
      throw error;
    }
  }

  /**
   * Ëé∑ÂèñÂêåÊ≠•ÈÖçÁΩÆ
   */
  getSyncConfig(): SyncConfig {
    return { ...this.syncConfig };
  }

  /**
   * Ê≥®ÂÜåÊï∞ÊçÆÂèòÂåñÁõëÂê¨
   */
  async registerDataChangeListener(): Promise<void> {
    if (!this.kvStore) {
      throw new Error('KVStore not initialized');
    }

    try {
      const subscriptionCallback = async (data: distributedKVStore.SubscribeResult) => {
        try {
          Logger.debug(TAG, `Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data instanceof Error ? `Data change detected: ${JSON.stringify(data : new Error(String(`Data change detected: ${JSON.stringify(data)))))))}`);
          
          if (data && data.insertEntries && data.insertEntries.length > 0) {
            for (const entry of data.insertEntries) {
              const key = entry.key;
              const deviceId = entry.deviceId || 'local';
              
              try {
                // Ëé∑ÂèñÊï∞ÊçÆÂπ∂ÈÄöÁü•ÁõëÂê¨Âô?
                let value;
                if (this.kvStore !== null && this.kvStore !== undefined) {
                  value = await this.kvStore.get(key);
                }
                if (value && this.dataListeners.size > 0) {
                  // Êü•ÊâæÊâÄÊúâÂåπÈÖçÁöÑÁõëÂê¨Âô?
                  this.notifyRelevantListeners(key, value, deviceId);
                }
              } catch (error: Error) {
                Logger.error(TAG, `Failed to process changed data for key ${key}: ${error instanceof Error ? error.message : String(error)}`);
              }
            }
          }
        } catch (error: Error) {
          Logger.error(TAG, `Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error in data change callback: ${error instanceof Error ? error.message : String(error : new Error(String(`Error in data change callback: ${error instanceof Error ? error.message : String(error)))))))}`);
        }
      };
      
      await this.kvStore.on('dataChange', distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, subscriptionCallback);
    } catch (error: Error) {
      Logger.error(TAG, `Failed to register data change listener: ${error instanceof Error ? error.message : String(error)}`);
    }
  }
  
  /**
   * ÈÄöÁü•Áõ∏ÂÖ≥ÁöÑÁõëÂê¨Âô®
   */
  private notifyRelevantListeners<T>(key: string, value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string : new Error(String(value: T, deviceId: string instanceof Error ? value: T, deviceId: string : new Error(String(value: T, deviceId: string))))))): void {
    for (const [prefix, listeners] of this.dataListeners.entries()) {
      if (key.startsWith(prefix)) {
        for (const listener of listeners) {
          try {
            listener(key, value, deviceId);
          } catch (error: Error) {
            Logger.error(TAG, `Error in data listener for prefix ${prefix}: ${error instanceof Error ? error.message : String(error)}`);
          }
        }
      }
    }
  }

  /**
   * ÁõëÂê¨ÁâπÂÆöÁ±ªÂûãÁöÑÊï∞ÊçÆÂèòÂå?
   * @param dataType Êï∞ÊçÆÁ±ªÂûã
   * @param listener ÁõëÂê¨ÂõûË∞É
   */
  addDataChangeListener(dataType: SyncDataType, listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener))))))): void {
    const keyPrefix = `${dataType}_`;
    
    if (!this.dataListeners.has(keyPrefix)) {
      this.dataListeners.set(keyPrefix, []);
    }
    
    this.dataListeners.get(keyPrefix)!.push(listener);
    Logger.debug(TAG, `Added data change listener for ${dataType}`);
  }

  /**
   * ÁßªÈô§Êï∞ÊçÆÂèòÂåñÁõëÂê¨
   * @param dataType Êï∞ÊçÆÁ±ªÂûã
   * @param listener ÁõëÂê¨ÂõûË∞É
   */
  removeDataChangeListener(dataType: SyncDataType, listener: DataChangeListener): void {
    const keyPrefix = `${dataType}_`;
    
    if (this.dataListeners.has(keyPrefix)) {
      const listeners = this.dataListeners.get(keyPrefix)!;
      const index = listeners.indexOf(listener);
      
      if (index > -1) {
        listeners.splice(index, 1);
        // Â¶ÇÊûúÊ≤°ÊúâÁõëÂê¨Âô®‰∫ÜÔºåÁßªÈô§Ëøô‰∏™ÂâçÁºÄ
        if (listeners.length === 0) {
          this.dataListeners.delete(keyPrefix);
        }
      }
    }
  }

  /**
   * ‰øùÂ≠òÂêåÊ≠•Êï∞ÊçÆ
   * @param dataType Êï∞ÊçÆÁ±ªÂûã
   * @param key Êï∞ÊçÆÈî?
   * @param data Êï∞ÊçÆÂÜÖÂÆπ
   */
  async saveSyncData<T>(dataType: SyncDataType, key: string, data: T): Promise<void> {
    if (!this.kvStore || !this.syncConfig.enabled) {
      return;
    }

    try {
      const fullKey = `${dataType}_${key}`;
      const syncData: Record<string, string | number | boolean | null> = { ... };

      // ‰øùÂ≠òÊï∞ÊçÆÂà∞KVStore
      await this.kvStore.put(fullKey, syncData);
      Logger.debug(TAG, `Saved sync data: ${fullKey}`);
    } catch (error: Error) {
      Logger.error(TAG, `Failed to get sync data for key ${key}: ${error instanceof Error ? error.message : String(error)}`);
      throw error;
    }
  }

  /**
   * Ëé∑ÂèñÂêåÊ≠•Êï∞ÊçÆ
   * @param dataType Êï∞ÊçÆÁ±ªÂûã
   * @param key Êï∞ÊçÆÈî?
   */
  async getSyncData<T>(dataType: SyncDataType, key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string))))))): Promise<T | null> {
    if (!this.kvStore) {
      return null;
    }

    try {
      const fullKey = `${dataType}_${key}`;
      const value = await this.kvStore.get(fullKey);

      if (value && typeof value === 'object' && 'data' in value) {
        Logger.debug(TAG, `Retrieved sync data: ${fullKey}`);
        return value.data;
      }
      
      return null;
    } catch (error: Error) {
      Logger.error(TAG, `Failed to get sync data: ${error instanceof Error ? error.message : String(error)}`);
      return null;
    }
  }

  /**
   * Âà†Èô§ÂêåÊ≠•Êï∞ÊçÆ
   * @param dataType Êï∞ÊçÆÁ±ªÂûã
   * @param key Êï∞ÊçÆÈî?
   */
  async deleteSyncData(dataType: SyncDataType, key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string))))))): Promise<void> {
    if (!this.kvStore || !this.syncConfig.enabled) {
      return;
    }

    try {
      const fullKey = `${dataType}_${key}`;
      await this.kvStore.delete(fullKey);
      Logger.debug(TAG, `Deleted sync data: ${fullKey}`);
    } catch (error: Error) {
      Logger.error(TAG, `Failed to delete sync data: ${error instanceof Error ? error.message : String(error)}`);
      throw error;
    }
  }

  /**
   * ÂêØÂä®Ëá™Âä®ÂêåÊ≠•
   */
  private startAutoSync(): void {
    this.stopAutoSync(); // ÂÖàÂÅúÊ≠¢Áé∞ÊúâÁöÑÂÆöÊó∂Âô?
    
    try {
      this.syncTimerId = setInterval(async () => {
        try {
          await this.synchronizeData();
        } catch (error: Error) {
          Logger.error(TAG, `Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error instanceof Error ? `Auto sync failed: ${error instanceof Error ? error.message : String(error : new Error(String(`Auto sync failed: ${error instanceof Error ? error.message : String(error)))))))}`);
        }
      }, this.syncConfig.syncInterval * 1000);
    } catch (error: Error) {
      Logger.error(TAG, `Failed to start auto sync: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * ÂÅúÊ≠¢Ëá™Âä®ÂêåÊ≠•
   */
  private stopAutoSync(): void {
    if (this.syncTimerId !== null) {
      clearInterval(this.syncTimerId);
      this.syncTimerId = null;
      Logger.info(TAG, 'Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped' : new Error(String('Auto sync stopped' instanceof Error ? 'Auto sync stopped' : new Error(String('Auto sync stopped')))))));
    }
  }

  /**
   * ÊâãÂä®Ëß¶ÂèëÊï∞ÊçÆÂêåÊ≠•
   */
  async synchronizeData(): Promise<void> {
    if (!this.kvStore || !this.syncConfig.enabled || this.syncState.status === SyncStatus.SYNCHRONIZING) {
      return;
    }

    this.syncState = {
      status: SyncStatus.SYNCHRONIZING,
      syncedDevices: []
    };

    try {
      Logger.info(TAG, 'Starting data synchronization...');
      
      // Ëé∑ÂèñÂú®Á∫øËÆæÂ§áÂàóË°®
      const devices = await this.getAvailableDevices();
      Logger.debug(TAG, `Available devices: ${JSON.stringify(devices)}`);
      
      // ÂêåÊ≠•ÊØèÁßçÊï∞ÊçÆÁ±ªÂûã
      for (const dataType of this.syncConfig.syncTypes) {
        await this.syncDataType(dataType, devices);
      }
      
      this.syncState = {
        status: SyncStatus.COMPLETED,
        lastSyncTime: Date.now(),
        lastSyncResult: true,
        syncedDevices: devices
      };
      
      Logger.info(TAG, 'Data synchronization completed successfully');
    } catch (error: Error) {
      Logger.error(TAG, `Data synchronization failed: ${error instanceof Error ? error.message : String(error)}`);
      this.syncState = {
        status: SyncStatus.FAILED, error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error instanceof Error ? error: error instanceof Error ? error.message : String(error : new Error(String(error: error instanceof Error ? error.message : String(error))))))),
      };
      throw error;
    }
  }

  /**
   * Ëé∑ÂèñÂèØÁî®ËÆæÂ§áÂàóË°®
   */
  private async getAvailableDevices(): Promise<string[]> {
    try {
      if (!this.kvManager) {
        return [];
      }
      
      const deviceInfoList = await this.kvManager.getConnectedDevicesInfo();
      this.deviceIds = deviceInfoList.map(device => device.deviceId).filter(id => id);
      return this.deviceIds;
    } catch (error: Error) {
      Logger.error(TAG, `Failed to get available devices: ${error instanceof Error ? error.message : String(error)}`);
      return [];
    }
  }

  /**
   * Ëé∑ÂèñÊú¨Âú∞ËÆæÂ§áID
   */
  private async getLocalDeviceId(): Promise<string> {
    try {
      if (!this.kvManager) {
        return 'unknown';
      }
      
      const deviceInfo = await this.kvManager.getLocalDeviceInfo();
      return deviceInfo?.deviceId || 'unknown';
    } catch (error: Error) {
      Logger.error(TAG, `Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to get local device ID: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to get local device ID: ${error instanceof Error ? error.message : String(error)))))))}`);
      return 'unknown';
    }
  }

  /**
   * ÂêåÊ≠•ÁâπÂÆöÊï∞ÊçÆÁ±ªÂûã
   */
  private async syncDataType(dataType: SyncDataType, deviceIds: string[]): Promise<void> {
    if (!this.kvStore) {
      return;
    }

    Logger.debug(TAG, `Syncing data type: ${dataType} with ${deviceIds.length} devices`);
    const keyPrefix = `${dataType}_`;

    try {
      // Ëé∑ÂèñÊâÄÊúâÂåπÈÖçÂâçÁºÄÁöÑÈîÆ
      const keys = await this.getAllKeysWithPrefix(keyPrefix);
      Logger.debug(TAG, `Found ${keys.length} keys for data type ${dataType}`);

      for (const fullKey of keys) {
        try {
          // Ëé∑ÂèñÊú¨Âú∞Êï∞ÊçÆ
          const localData = await this.kvStore.get(fullKey);
          if (localData) {
            Logger.debug(TAG, `Data ${fullKey} will be automatically synced to other devices`);
          }
        } catch (error: Error) {
          Logger.error(TAG, `Error processing key ${fullKey}: ${error instanceof Error ? error.message : String(error)}`);
          // ÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™ÈîÆÔºå‰∏ç‰∏≠Êñ≠Êï¥‰∏™ÂêåÊ≠•ÊµÅÁ®ã
          continue;
        }
      }
    } catch (error: Error) {
      Logger.error(TAG, `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error instanceof Error ? `Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error : new Error(String(`Failed to sync data type ${dataType}: ${error instanceof Error ? error.message : String(error)))))))}`);
      throw error;
    }
  }

  /**
   * Ëé∑ÂèñÊâÄÊúâÂåπÈÖçÂâçÁºÄÁöÑÈîÆ
   */
  private async getAllKeysWithPrefix(prefix: string): Promise<string[]> {
    if (!this.kvStore) {
      return [];
    }

    try {
      const allEntries = await this.kvStore.getEntries('');
      const keys: string[] = [];
      
      if (Array.isArray(allEntries)) {
        for (let i = 0; i < allEntries.length; i++) {
          const entry = allEntries[i];
          if (entry && entry.key && entry.key.startsWith(prefix)) {
            keys.push(entry.key);
          }
        }
      }
      
      return keys;
    } catch (error: Error) {
      Logger.error(TAG, `Failed to get keys with prefix ${prefix}: ${error instanceof Error ? error.message : String(error)}`);
      return [];
    }
  }

  /**
   * Â§ÑÁêÜÂêåÊ≠•ÂÜ≤Á™Å
   */
  private async resolveConflict<T>(localData: T, remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T))))))): Promise<T> {
    try {
      switch (this.syncConfig.conflictStrategy) {
        case ConflictResolutionStrategy.LOCAL_WIN:
          return localData;
        case ConflictResolutionStrategy.REMOTE_WIN:
          return remoteData;
        case ConflictResolutionStrategy.LATEST_WIN:
          const localTime = localData?.timestamp || 0;
          const remoteTime = remoteData?.timestamp || 0;
          return localTime >= remoteTime ? localData : remoteData;
        case ConflictResolutionStrategy.MERGE:
          // ÂÆûÁé∞ÂêàÂπ∂Á≠ñÁï•
          return await this.mergeData(localData, remoteData);
        default:
          return localData;
      }
    } catch (error: Error) {
      Logger.error(TAG, `Error resolving conflict: ${error instanceof Error ? error.message : String(error)}`);
      return localData; // Âá∫ÈîôÊó∂ÈªòËÆ§‰øùÁïôÊú¨Âú∞Êï∞Êç?
    }
  }

  /**
   * ÂêàÂπ∂Êï∞ÊçÆÔºàÊ†πÊçÆ‰∏çÂêåÊï∞ÊçÆÁ±ªÂûãÂÆûÁé∞Êô∫ËÉΩÂêàÂπ∂Á≠ñÁï•Ôºâ
   */
  private async mergeData<T>(localData: T, remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T : new Error(String(remoteData: T instanceof Error ? remoteData: T : new Error(String(remoteData: T))))))): Promise<T> {
    try {
      // Á°Æ‰øùËæìÂÖ•ÊòØÂØπË±?
      if (typeof localData !== 'object' || localData === null) {
        return remoteData;
      }
      if (typeof remoteData !== 'object' || remoteData === null) {
        return localData;
      }

      // ÂàõÂª∫ÂêàÂπ∂ÁªìÊûúÂØπË±°
      const merged: Record<string, string | number | boolean | null> = { ... };
      
      // Ê†πÊçÆÊï∞ÊçÆÁ±ªÂûãÂÆûÁé∞‰∏çÂêåÁöÑÂêàÂπ∂Á≠ñÁï?
      for (const key in remoteData) {
        if (remoteData.hasOwnProperty(key)) {
          // Ë∑≥ËøáÊó∂Èó¥Êà≥ÂíåËÆæÂ§áIDÔºåËøô‰∫õ‰∏çÂ∫îË¢´ÂêàÂπ∂
          if (key === 'timestamp' || key === 'deviceId') {
            continue;
          }

          const keyPrefix = key.split('_')[0];
          
          switch (keyPrefix) {
            case SyncDataType.HISTORY:
              // ÂéÜÂè≤ËÆ∞ÂΩïÂêàÂπ∂Ôºö‰øùÁïôÊúÄÊñ∞ÁöÑËßÇÁúãËÆ∞ÂΩï
              if (remoteData[key] && localData[key]) {
                merged[key] = {
                  ...remoteData[key],
                  // ‰øùÁïôÊú¨Âú∞Êï∞ÊçÆ‰∏≠ÂèØËÉΩÂ≠òÂú®ÁöÑÈ¢ùÂ§ñÂ≠óÊÆµ
                  ...localData[key],
                  // ‰ΩÜ‰ΩøÁî®ÊúÄÊñ∞ÁöÑÊó∂Èó¥Êà?
                  lastWatched: Math.max(
                    remoteData[key].lastWatched || 0, 
                    localData[key].lastWatched || 0
                  )
                };
              } else {
                merged[key] = remoteData[key] || localData[key];
              }
              break;
              
            case SyncDataType.FAVORITES:
              // Êî∂ËóèÂêàÂπ∂ÔºöÂêàÂπ∂‰∏§‰∏™ÂàóË°?
              if (Array.isArray(localData[key]) && Array.isArray(remoteData[key])) {
                // ÂàõÂª∫‰∏Ä‰∏™ÈõÜÂêà‰ª•ÈÅøÂÖçÈáçÂ§ç
                const mergedSet = new Set([...localData[key], ...remoteData[key]]);
                merged[key] = Array.from(mergedSet);
              } else {
                merged[key] = remoteData[key] || localData[key];
              }
              break;
              
            case SyncDataType.PLAYBACK_PROGRESS:
              // Êí≠ÊîæËøõÂ∫¶ÂêàÂπ∂Ôºö‰øùÁïôÊúÄÊñ∞ÁöÑËøõÂ∫¶
              if (remoteData[key] && localData[key]) {
                const remoteProgress = remoteData[key].progress || 0;
                const localProgress = localData[key].progress || 0;
                
                if (remoteProgress > localProgress) {
                  merged[key] = remoteData[key];
                } else {
                  merged[key] = localData[key];
                }
              } else {
                merged[key] = remoteData[key] || localData[key];
              }
              break;
              
            default:
              // ÈªòËÆ§Á≠ñÁï•ÔºöÂ¶ÇÊûú‰∏§‰∏™ÈÉΩÊòØÂØπË±°ÔºåÈÄíÂΩíÂêàÂπ∂
              if (typeof localData[key] === 'object' && 
                  typeof remoteData[key] === 'object' && 
                  !Array.isArray(localData[key]) && 
                  !Array.isArray(remoteData[key])) {
                merged[key] = await this.mergeData(localData[key], remoteData[key]);
              } else {
                // ÂØπ‰∫éÊï∞ÁªÑÂíåÂü∫Êú¨Á±ªÂûãÔºå‰ΩøÁî®ËøúÁ®ãÊï∞ÊçÆ
                merged[key] = remoteData[key];
              }
        }
      }
      
      // Êõ¥Êñ∞ÂêàÂπ∂ÂêéÁöÑÊó∂Èó¥Êà≥ÂíåËÆæÂ§áID
      merged.timestamp = Date.now();
      merged.deviceId = await this.getLocalDeviceId();
      
      return merged;
    } catch (error: Error) {
      Logger.error(TAG, `Error merging data: ${error instanceof Error ? error.message : String(error)}`);
      return localData; // Âá∫ÈîôÊó∂ÈªòËÆ§‰øùÁïôÊú¨Âú∞Êï∞Êç?
    }
  }

  /**
   * Ëé∑ÂèñÂêåÊ≠•Áä∂ÊÄ?
   */
  getSyncState(): SyncState {
    return { ...this.syncState };
  }

  /**
   * ÂÖ≥Èó≠ÂàÜÂ∏ÉÂºèÊï∞ÊçÆÊúçÂä?
   */
  close(): void {
    try {
      this.stopAutoSync();
      // Ê∏ÖÁêÜÁõëÂê¨Âô?
      this.dataListeners.clear();
      // KVStore‰ºöÁî±Á≥ªÁªüËá™Âä®ÁÆ°ÁêÜÁîüÂëΩÂë®ÊúüÔºå‰ΩÜÂèØ‰ª•ËøõË°åÊòéÁ°ÆÁöÑËµÑÊ∫êÈáäÊî?
      this.kvStore = null;
      this.kvManager = null;
      this.isInitialized = false;
      Logger.info(TAG, 'Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released' instanceof Error ? 'Distributed data service closed and resources released' : new Error(String('Distributed data service closed and resources released')))))));
    } catch (error: Error) {
      Logger.error(TAG, `Error closing distributed data service: ${error instanceof Error ? error.message : String(error)}`);
    }
  }
}


