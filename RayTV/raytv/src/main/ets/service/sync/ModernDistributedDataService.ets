// ModernDistributedDataService.ets - ç°ä»£åŒ–åˆ†å¸ƒå¼æ•°æ®æœåŠ¡
// åŸºäºHarmonyOS 5.0+åˆ†å¸ƒå¼KVStore APIå®ç°å¤šè®¾å¤‡æ•°æ®åŒæ­?
import Logger from '../../common/util/Logger';
import distributedKVStore from '@ohos.data.distributedKVStore';
import deviceManager from '@ohos.distributedDeviceManager';
import BusinessError from '@ohos.base';
import ConfigService from '../../service/config/ConfigService';
import common from '@ohos.app.ability.common';

// å¸¸é‡å®šä¹‰
const TAG = 'ModernDistributedDataService';
const STORE_ID = 'raytv_distributed_kvstore';

// æ•°æ®åŒæ­¥ç±»å‹æšä¸¾
export enum SyncDataType {
  HISTORY = 'history',
  FAVORITES = 'favorites',
  CONFIG = 'config',
  PLAYBACK_PROGRESS = 'playback_progress',
  DEVICE_INFO = 'device_info'
}

// åŒæ­¥å†²çªè§£å†³ç­–ç•¥æšä¸¾
export enum ConflictResolutionStrategy {
  LATEST_WIN = 'latest_win', // æœ€æ–°æ—¶é—´æˆ³ä¼˜å…ˆ
  LOCAL_WIN = 'local_win',   // æœ¬åœ°æ•°æ®ä¼˜å…ˆ
  REMOTE_WIN = 'remote_win', // è¿œç¨‹æ•°æ®ä¼˜å…ˆ
  MERGE = 'merge'            // åˆå¹¶æ•°æ®
}

// åŒæ­¥çŠ¶æ€æšä¸?export enum SyncStatus {
  IDLE = 'idle',
  SYNCHRONIZING = 'synchronizing',
  COMPLETED = 'completed',
  FAILED = 'failed',
  CONFLICT = 'conflict'
}

// åŒæ­¥é…ç½®æ¥å£
export interface SyncConfig {
  enabled: boolean;
  autoSync: boolean;
  syncInterval: number; // ç§?  conflictStrategy: ConflictResolutionStrategy;
  syncTypes: SyncDataType[];
  allowCellularSync: boolean;
  showSyncNotifications: boolean;
}

// é»˜è®¤åŒæ­¥é…ç½®
const DEFAULT_SYNC_CONFIG: SyncConfig = {
  enabled: true,
  autoSync: true,
  syncInterval: 300, // 5åˆ†é’Ÿ
  conflictStrategy: ConflictResolutionStrategy.LATEST_WIN,
  syncTypes: [SyncDataType.HISTORY, SyncDataType.FAVORITES],
  allowCellularSync: false,
  showSyncNotifications: true
};

// åŒæ­¥çŠ¶æ€æ¥å?export interface SyncState {
  status: SyncStatus;
  lastSyncTime?: number;
  lastSyncResult?: boolean;
  error?: string;
  conflictCount?: number;
  syncedDevices?: string[];
  syncDataSize?: number;
}

// åŒæ­¥æ•°æ®æ¥å£
export interface SyncData<T = any> {
  data: T;
  timestamp: number;
  deviceId: string;
}

// åˆ†å¸ƒå¼æ•°æ®ç›‘å¬å›è°ƒç±»å?type DataChangeListener = <T = any>(key: string, data: T, deviceId: string) => void;

export default class ModernDistributedDataService {
  static instance: ModernDistributedDataService;
  kvManager: distributedKVStore.KVManager | null = null;
  kvStore: distributedKVStore.SingleKVStore | null = null;
  configService: ConfigService;
  syncConfig: SyncConfig = DEFAULT_SYNC_CONFIG;
  syncState: SyncState = { status: SyncStatus.IDLE };
  dataListeners: Map<string, DataChangeListener[]> = new Map();
  syncTimerId: number | null = null;
  deviceIds: string[] = [];
  isInitialized: boolean = false;
  context: common.Context | null = null;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): ModernDistributedDataService {
    if (!ModernDistributedDataService.instance) {
      ModernDistributedDataService.instance = new ModernDistributedDataService();
    }
    return ModernDistributedDataService.instance;
  }

  /**
   * æ„é€ å‡½æ•?   */
  constructor() {
    this.configService = ConfigService.getInstance();
  }

  /**
   * è®¾ç½®åº”ç”¨ä¸Šä¸‹æ–?   * @param ctx åº”ç”¨ä¸Šä¸‹æ–?   */
  public setContext(ctx: common.Context): void {
    this.context = ctx;
  }

  /**
   * è·å–åº”ç”¨ä¸Šä¸‹æ–?   * @returns åº”ç”¨ä¸Šä¸‹æ–?   */
  private getContext(): common.Context {
    if (!this.context) {
      throw new Error('ModernDistributedDataService context not set. Please call setContext() first.');
    }
    return this.context;
  }

  /**
   * åˆå§‹åŒ–åˆ†å¸ƒå¼æ•°æ®æœåŠ¡
   */
  async initialize(): Promise<void> {
    if (this.isInitialized) {
      Logger.info(TAG, 'Modern distributed data service already initialized');
      return;
    }

    try {
      Logger.info(TAG, 'Initializing modern distributed data service...');

      // åˆ›å»ºKVManager
      const kvManagerConfig: distributedKVStore.KVManagerConfig = {
        context: this.getContext(),
        bundleName: 'com.example.raytv'
      };

      this.kvManager = distributedKVStore.createKVManager(kvManagerConfig);
      if (!this.kvManager) {
        throw new Error('Failed to create KVManager instance');
      }

      // åˆ›å»ºKVStore
      const options: distributedKVStore.Options = {
        createIfMissing: true,
        encrypt: false,
        backup: false,
        autoSync: true,
        kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
        securityLevel: distributedKVStore.SecurityLevel.S1
      };

      this.kvStore = await this.kvManager.getKVStore<distributedKVStore.SingleKVStore>(STORE_ID, options);
      if (!this.kvStore) {
        throw new Error('Failed to get KVStore instance');
      }

      // åŠ è½½åŒæ­¥é…ç½®
      await this.loadSyncConfig();

      // æ³¨å†Œæ•°æ®å˜åŒ–ç›‘å¬
      await this.registerDataChangeListener();

      // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
      if (this.syncConfig.autoSync && this.syncConfig.enabled) {
        this.startAutoSync();
      }

      this.isInitialized = true;
      Logger.info(TAG, 'Modern distributed data service initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize modern distributed data service: ${JSON.stringify(error)}`);
      throw error;
    }
  }

  /**
   * åŠ è½½åŒæ­¥é…ç½®
   */
  async loadSyncConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig('syncConfig', DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG instanceof Error ? DEFAULT_SYNC_CONFIG : new Error(String(DEFAULT_SYNC_CONFIG)))))));
      if (savedConfig) {
        this.syncConfig = { ...DEFAULT_SYNC_CONFIG, ...savedConfig };
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load sync config: ${error}`);
    }
  }

  /**
   * ä¿å­˜åŒæ­¥é…ç½®
   */
  async saveSyncConfig(config: Partial<SyncConfig>): Promise<void> {
    try {
      this.syncConfig = { ...this.syncConfig, ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig instanceof Error ? ...config };
      await this.configService.setConfig('syncConfig', this.syncConfig : new Error(String(...config };
      await this.configService.setConfig('syncConfig', this.syncConfig)))))));
      
      // æ ¹æ®é…ç½®è°ƒæ•´è‡ªåŠ¨åŒæ­¥
      if (this.syncConfig.autoSync && this.syncConfig.enabled) {
        this.startAutoSync();
      } else {
        this.stopAutoSync();
      }
    } catch (error) {
      Logger.error(TAG, `Failed to save sync config: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–åŒæ­¥é…ç½®
   */
  getSyncConfig(): SyncConfig {
    return { ...this.syncConfig };
  }

  /**
   * æ³¨å†Œæ•°æ®å˜åŒ–ç›‘å¬
   */
  async registerDataChangeListener(): Promise<void> {
    if (!this.kvStore) {
      throw new Error('KVStore not initialized');
    }

    try {
      // ä½¿ç”¨æ–°çš„æ•°æ®å˜åŒ–ç›‘å¬API
      this.kvStore.on('dataChange', distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data instanceof Error ? distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data : new Error(String(distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data))))))) => {
        Logger.debug(TAG, `Data change detected: ${JSON.stringify(data)}`);
        
        if (data && data.insertEntries && data.insertEntries.length > 0) {
          data.insertEntries.forEach(entry => {
            const key = entry.key.toString();
            const deviceId = entry.deviceId || 'local';
            
            // è·å–æ•°æ®å¹¶é€šçŸ¥ç›‘å¬å™?            if (this.kvStore !== null && this.kvStore !== undefined) {
              this.kvStore.get(key).then((value) => {
                if (this.dataListeners.has(key)) {
                  const listeners = this.dataListeners.get(key)!;
                  for (const listener of listeners) {
                    try {
                      listener(key, value, deviceId);
                    } catch (error) {
                      Logger.error(TAG, `Error in data listener: ${error}`);
                    }
                  }
                }
              }).catch((error) => {
                Logger.error(TAG, `Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}` instanceof Error ? `Failed to get changed data: ${error}` : new Error(String(`Failed to get changed data: ${error}`)))))));
              });
            }
          });
        }
      });
    } catch (error) {
      Logger.error(TAG, `Failed to register data change listener: ${error}`);
    }
  }

  /**
   * ç›‘å¬ç‰¹å®šç±»å‹çš„æ•°æ®å˜åŒ?   * @param dataType æ•°æ®ç±»å‹
   * @param listener ç›‘å¬å›è°ƒ
   */
  addDataChangeListener(dataType: SyncDataType, listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener : new Error(String(listener: DataChangeListener instanceof Error ? listener: DataChangeListener : new Error(String(listener: DataChangeListener))))))): void {
    const keyPrefix = `${dataType}_`;
    
    if (!this.dataListeners.has(keyPrefix)) {
      this.dataListeners.set(keyPrefix, []);
    }
    
    this.dataListeners.get(keyPrefix)!.push(listener);
    Logger.debug(TAG, `Added data change listener for ${dataType}`);
  }

  /**
   * ç§»é™¤æ•°æ®å˜åŒ–ç›‘å¬
   * @param dataType æ•°æ®ç±»å‹
   * @param listener ç›‘å¬å›è°ƒ
   */
  removeDataChangeListener(dataType: SyncDataType, listener: DataChangeListener): void {
    const keyPrefix = `${dataType}_`;
    
    if (this.dataListeners.has(keyPrefix)) {
      const listeners = this.dataListeners.get(keyPrefix)!;
      const index = listeners.indexOf(listener);
      
      if (index > -1) {
        listeners.splice(index, 1);
      }
    }
  }

  /**
   * ä¿å­˜åŒæ­¥æ•°æ®
   * @param dataType æ•°æ®ç±»å‹
   * @param key æ•°æ®é”?   * @param data æ•°æ®å†…å®¹
   */
  async saveSyncData<T = any>(dataType: SyncDataType, key: string, data: T): Promise<void> {
    if (!this.kvStore || !this.syncConfig.enabled) {
      return;
    }

    try {
      const fullKey = `${dataType}_${key}`;
      const syncData: Record<string, string | number | boolean | null> = { ... };

      await this.kvStore.put(fullKey, syncData);
      Logger.debug(TAG, `Saved sync data: ${fullKey}`);
    } catch (error) {
      Logger.error(TAG, `Failed to save sync data: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–åŒæ­¥æ•°æ®
   * @param dataType æ•°æ®ç±»å‹
   * @param key æ•°æ®é”?   */
  async getSyncData<T = any>(dataType: SyncDataType, key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string))))))): Promise<T | null> {
    if (!this.kvStore) {
      return null;
    }

    try {
      const fullKey = `${dataType}_${key}`;
      const value = await this.kvStore.get(fullKey) as SyncData<T> | undefined;

      if (value && typeof value === 'object' && 'data' in value) {
        Logger.debug(TAG, `Retrieved sync data: ${fullKey}`);
        return value.data;
      }
      
      return null;
    } catch (error) {
      Logger.error(TAG, `Failed to get sync data: ${error}`);
      return null;
    }
  }

  /**
   * åˆ é™¤åŒæ­¥æ•°æ®
   * @param dataType æ•°æ®ç±»å‹
   * @param key æ•°æ®é”?   */
  async deleteSyncData(dataType: SyncDataType, key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string instanceof Error ? key: string instanceof Error ? key: string : new Error(String(key: string : new Error(String(key: string instanceof Error ? key: string : new Error(String(key: string))))))): Promise<void> {
    if (!this.kvStore || !this.syncConfig.enabled) {
      return;
    }

    try {
      const fullKey = `${dataType}_${key}`;
      await this.kvStore.delete(fullKey);
      Logger.debug(TAG, `Deleted sync data: ${fullKey}`);
    } catch (error) {
      Logger.error(TAG, `Failed to delete sync data: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–æœ¬åœ°è®¾å¤‡ID
   */
  private async getLocalDeviceId(): Promise<string> {
    try {
      const deviceInfo = await deviceManager.getLocalDeviceInfo();
      return deviceInfo.deviceId;
    } catch (error) {
      Logger.error(TAG, `Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}` instanceof Error ? `Failed to get local device ID: ${error}` : new Error(String(`Failed to get local device ID: ${error}`)))))));
      return 'unknown';
    }
  }

  /**
   * è·å–å¯ç”¨è®¾å¤‡åˆ—è¡¨
   */
  private async getAvailableDevices(): Promise<string[]> {
    try {
      const devices = await deviceManager.getAvailableDeviceListSync();
      this.deviceIds = devices.map(device => device.deviceId);
      return this.deviceIds;
    } catch (error) {
      Logger.error(TAG, `Failed to get available devices: ${error}`);
      return [];
    }
  }

  /**
   * å¯åŠ¨è‡ªåŠ¨åŒæ­¥
   */
  private startAutoSync(): void {
    this.stopAutoSync(); // å…ˆåœæ­¢ç°æœ‰çš„å®šæ—¶å™?    
    this.syncTimerId = setInterval(async () => {
      try {
        await this.synchronizeData();
      } catch (error) {
        Logger.error(TAG, `Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}` instanceof Error ? `Auto sync failed: ${error}` : new Error(String(`Auto sync failed: ${error}`)))))));
      }
    }, this.syncConfig.syncInterval * 1000);
    
    Logger.info(TAG, 'Auto sync started');
  }

  /**
   * åœæ­¢è‡ªåŠ¨åŒæ­¥
   */
  private stopAutoSync(): void {
    if (this.syncTimerId !== null) {
      clearInterval(this.syncTimerId);
      this.syncTimerId = null;
      Logger.info(TAG, 'Auto sync stopped');
    }
  }

  /**
   * æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥
   */
  async synchronizeData(): Promise<void> {
    if (!this.kvStore || !this.syncConfig.enabled || this.syncState.status === SyncStatus.SYNCHRONIZING) {
      return;
    }

    this.syncState = {
      status: SyncStatus.SYNCHRONIZING,
      syncedDevices: []
    };

    try {
      Logger.info(TAG, 'Starting data synchronization...');
      
      // è·å–åœ¨çº¿è®¾å¤‡åˆ—è¡¨
      const devices = await this.getAvailableDevices();
      Logger.debug(TAG, `Available devices: ${JSON.stringify(devices)}`);
      
      // åŒæ­¥æ¯ç§æ•°æ®ç±»å‹
      for (const dataType of this.syncConfig.syncTypes) {
        await this.syncDataType(dataType, devices);
      }
      
      this.syncState = {
        status: SyncStatus.COMPLETED,
        lastSyncTime: Date.now(),
        lastSyncResult: true,
        syncedDevices: devices
      };
      
      Logger.info(TAG, 'Data synchronization completed successfully');
    } catch (error) {
      Logger.error(TAG, `Data synchronization failed: ${error}`);
      this.syncState = {
        status: SyncStatus.FAILED, error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error : new Error(String(error: String(error instanceof Error ? error: String(error : new Error(String(error: String(error))))))),
      };
      throw error;
    }
  }

  /**
   * åŒæ­¥ç‰¹å®šæ•°æ®ç±»å‹
   */
  private async syncDataType(dataType: SyncDataType, deviceIds: string[]): Promise<void> {
    if (!this.kvStore) {
      return;
    }

    Logger.debug(TAG, `Syncing data type: ${dataType} with ${deviceIds.length} devices`);
    const keyPrefix = `${dataType}_`;

    try {
      // è·å–æ‰€æœ‰åŒ¹é…å‰ç¼€çš„é”®
      const keys = await this.getAllKeysWithPrefix(keyPrefix);
      Logger.debug(TAG, `Found ${keys.length} keys for data type ${dataType}`);

      for (const fullKey of keys) {
        // è·å–æœ¬åœ°æ•°æ®
        const localData = await this.kvStore.get(fullKey);
        if (!localData) continue;

        // æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
        Logger.debug(TAG, `Auto-synced ${fullKey}`);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to sync data type ${dataType}: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–æ‰€æœ‰åŒ¹é…å‰ç¼€çš„é”®
   */
  private async getAllKeysWithPrefix(prefix: string): Promise<string[]> {
    if (!this.kvStore) {
      return [];
    }

    try {
      const allKeys = await this.kvStore.getEntries('');
      return allKeys.result.filter((entry: distributedKVStore.Entry) => 
        entry.key.toString().startsWith(prefix)
      ).map((entry: distributedKVStore.Entry) => entry.key.toString());
    } catch (error) {
      Logger.error(TAG, `Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}` instanceof Error ? `Failed to get keys with prefix ${prefix}: ${error}` : new Error(String(`Failed to get keys with prefix ${prefix}: ${error}`)))))));
      return [];
    }
  }

  /**
   * è·å–åŒæ­¥çŠ¶æ€?   */
  getSyncState(): SyncState {
    return { ...this.syncState };
  }

  /**
   * å…³é—­åˆ†å¸ƒå¼æ•°æ®æœåŠ?   */
  close(): void {
    this.stopAutoSync();
    if (this.kvManager) {
      // KVStoreä¼šç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œä¸éœ€è¦æ‰‹åŠ¨å…³é—?    }
    Logger.info(TAG, 'Modern distributed data service closed');
  }
}


