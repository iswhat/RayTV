// DataSyncService.ets - æ•°æ®åŒæ­¥æœåŠ¡
// è´Ÿè´£åè°ƒæœ¬åœ°æ•°æ®åº“ã€ç½‘ç»œæ•°æ®å’Œåˆ†å¸ƒå¼æ•°æ®ä¹‹é—´çš„åŒæ­¥

import Logger from '../../common/util/Logger';
import ConfigService from '../../service/config/ConfigService';
import ModernDistributedDataService from './ModernDistributedDataService';
import { SyncDataType } from './ModernDistributedDataService';

// å¸¸é‡å®šä¹‰
const TAG = 'DataSyncService';

// åŒæ­¥æ–¹å‘æšä¸¾
export enum SyncDirection {
  UPLOAD = 'upload',         // ä¸Šä¼ ï¼ˆæœ¬åœ?>è¿œç¨‹ï¼?
  DOWNLOAD = 'download',     // ä¸‹è½½ï¼ˆè¿œç¨?>æœ¬åœ°ï¼?
  BIDIRECTIONAL = 'bidirectional' // åŒå‘åŒæ­¥
}

// åŒæ­¥çŠ¶æ€æšä¸?
export enum SyncState {
  IDLE = 'idle',
  PENDING = 'pending',
  RUNNING = 'running',
  COMPLETED = 'completed',
  FAILED = 'failed',
  PARTIAL = 'partial',
  CONFLICT = 'conflict'
}

// åŒæ­¥ç­–ç•¥æšä¸¾
export enum SyncStrategy {
  TIMESTAMP_BASED = 'timestamp_based', // åŸºäºæ—¶é—´æˆ?
  VERSION_BASED = 'version_based',     // åŸºäºç‰ˆæœ¬å?
  CHECKSUM_BASED = 'checksum_based',   // åŸºäºæ ¡éªŒå’?
  FULL_SYNC = 'full_sync'             // å…¨é‡åŒæ­¥
}

// æ•°æ®åŒæ­¥é…ç½®æ¥å£
export interface DataSyncConfig {
  enabled: boolean;               // æ˜¯å¦å¯ç”¨åŒæ­¥
  autoSync: boolean;              // æ˜¯å¦è‡ªåŠ¨åŒæ­¥
  syncInterval: number;           // åŒæ­¥é—´éš”ï¼ˆç§’ï¼?
  syncStrategy: SyncStrategy;     // åŒæ­¥ç­–ç•¥
  syncDirection: SyncDirection;   // åŒæ­¥æ–¹å‘
  syncOnStart: boolean;           // åº”ç”¨å¯åŠ¨æ—¶åŒæ­?
  syncOnNetworkChange: boolean;   // ç½‘ç»œå˜åŒ–æ—¶åŒæ­?
  syncOnAppBackground: boolean;   // åº”ç”¨åå°æ—¶åŒæ­?
  allowCellularSync: boolean;     // å…è®¸èœ‚çªç½‘ç»œåŒæ­¥
  maxSyncRetry: number;           // æœ€å¤§é‡è¯•æ¬¡æ•?
  retryInterval: number;          // é‡è¯•é—´éš”ï¼ˆç§’ï¼?
  batchSize: number;              // æ‰¹é‡åŒæ­¥å¤§å°
}

// é»˜è®¤æ•°æ®åŒæ­¥é…ç½®
export const DEFAULT_DATA_SYNC_CONFIG: DataSyncConfig = {
  enabled: true,
  autoSync: true,
  syncInterval: 300, // 5åˆ†é’Ÿ
  syncStrategy: SyncStrategy.TIMESTAMP_BASED,
  syncDirection: SyncDirection.BIDIRECTIONAL,
  syncOnStart: true,
  syncOnNetworkChange: true,
  syncOnAppBackground: true,
  allowCellularSync: false,
  maxSyncRetry: 3,
  retryInterval: 60, // 1åˆ†é’Ÿ
  batchSize: 100
};

// åŒæ­¥ä»»åŠ¡æ¥å£
export interface SyncTask {
  id: string;                     // ä»»åŠ¡ID
  dataType: string;               // æ•°æ®ç±»å‹
  direction: SyncDirection;       // åŒæ­¥æ–¹å‘
  priority: number;               // ä¼˜å…ˆçº§ï¼ˆ0-100ï¼?
  startTime?: number;             // å¼€å§‹æ—¶é—?
  endTime?: number;               // ç»“æŸæ—¶é—´
  state: SyncState;               // çŠ¶æ€?
  progress: number;               // è¿›åº¦ï¼?-100ï¼?
  totalCount?: number;            // æ€»æ•°é‡?
  successCount?: number;          // æˆåŠŸæ•°é‡
  failedCount?: number;           // å¤±è´¥æ•°é‡
  error?: string;                 // é”™è¯¯ä¿¡æ¯
  retryCount: number;             // é‡è¯•æ¬¡æ•°
}

// é€šç”¨åŒæ­¥å®ä½“æ¥å£
export interface SyncEntity {
  id: string;                     // å®ä½“ID
  timestamp?: number;             // æ—¶é—´æˆ?
  version?: number;               // ç‰ˆæœ¬å?
  checksum?: string;              // æ ¡éªŒå’?
  extraData?: Record<string, unknown>; // å…¶ä»–å±æ€?
}

// åŒæ­¥è®°å½•æ¥å£
export interface SyncRecord {
  id: string;                     // è®°å½•ID
  syncTime: number;               // åŒæ­¥æ—¶é—´
  duration: number;               // æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  direction: SyncDirection;       // åŒæ­¥æ–¹å‘
  totalRecords: number;           // æ€»è®°å½•æ•°
  syncedRecords: number;          // åŒæ­¥æˆåŠŸè®°å½•æ•?
  failedRecords: number;          // å¤±è´¥è®°å½•æ•?
  conflictRecords: number;        // å†²çªè®°å½•æ•?
  networkType?: string;           // ç½‘ç»œç±»å‹
  batteryLevel?: number;          // ç”µæ± ç”µé‡
  success: boolean;               // æ˜¯å¦æˆåŠŸ
  errorMessage?: string;          // é”™è¯¯ä¿¡æ¯
}

// æ•°æ®å˜æ›´è®°å½•æ¥å£
export interface DataChange {
  entityId: string;               // å®ä½“ID
  entityType: string;             // å®ä½“ç±»å‹
  operation: 'create' | 'update' | 'delete'; // æ“ä½œç±»å‹
  timestamp: number;              // æ—¶é—´æˆ?
  data?: Record<string, unknown>; // æ•°æ®å†…å®¹
  version?: number;               // ç‰ˆæœ¬å?
  checksum?: string;              // æ ¡éªŒå’?
}

// åŒæ­¥å†²çªæ¥å£
export interface SyncConflict {
  entityId: string;               // å®ä½“ID
  entityType: string;             // å®ä½“ç±»å‹
  localData: Record<string, unknown>;                 // æœ¬åœ°æ•°æ®
  remoteData: Record<string, unknown>;                // è¿œç¨‹æ•°æ®
  resolved: boolean;              // æ˜¯å¦å·²è§£å†?
  resolution?: 'local' | 'remote' | 'merged'; // è§£å†³æ–¹å¼
}

// åŒæ­¥ç›‘å¬å™¨å›è°ƒç±»å?
type SyncListener = (task: SyncTask) => void;

// æ•°æ®æä¾›è€…æ¥å£ï¼ˆé€‚é…å™¨æ¨¡å¼ï¼‰
export interface DataProvider {
  getDataType(): string;
  fetchData(params?: Record<string, unknown>): Promise<Record<string, unknown>[]>;
  saveData(data: Record<string, unknown>[]): Promise<boolean>;
  updateData(data: Record<string, unknown>[]): Promise<boolean>;
  deleteData(ids: string[]): Promise<boolean>;
  getLastSyncTime(): Promise<number>;
  setLastSyncTime(timestamp: number): Promise<void>;
  getChanges(sinceTime: number): Promise<DataChange[]>;
  getEntityById(id: string): Promise<Record<string, unknown> | null>;
  getSyncVersion(): Promise<string>;
}

// åŒæ­¥äº‹ä»¶æšä¸¾
export enum SyncEvent {
  SYNC_STARTED = 'sync_started',
  SYNC_PROGRESS = 'sync_progress',
  SYNC_COMPLETED = 'sync_completed',
  SYNC_FAILED = 'sync_failed',
  CONFLICT_DETECTED = 'conflict_detected',
  CONFLICT_RESOLVED = 'conflict_resolved',
  AUTO_SYNC_STARTED = 'auto_sync_started',
  AUTO_SYNC_STOPPED = 'auto_sync_stopped'
}

// åŒæ­¥äº‹ä»¶ç›‘å¬å›è°ƒç±»å‹
type SyncEventListener = (event: SyncEvent, data: Record<string, string | number | boolean | null>) => void;

export default class DataSyncService {
  private static instance: DataSyncService;
  private configService: ConfigService;
  private distributedDataService: ModernDistributedDataService;
  private config: DataSyncConfig = DEFAULT_DATA_SYNC_CONFIG;
  private syncTasks: Map<string, SyncTask> = new Map();
  private syncRecords: SyncRecord[] = [];
  private dataProviders: Map<string, DataProvider> = new Map();
  private conflictQueue: SyncConflict[] = [];
  private pendingChanges: Map<string, DataChange[]> = new Map();
  private syncTimerId: number | null = null;
  private listeners: Map<string, SyncListener[]> = new Map();
  private eventListeners: Map<SyncEvent, SyncEventListener[]> = new Map();
  private isInitialized: boolean = false;
  private isRunning: boolean = false;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): DataSyncService {
    if (!DataSyncService.instance) {
      DataSyncService.instance = new DataSyncService();
    }
    return DataSyncService.instance;
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰å€?
   * æ›¿ä»£Object.valuesï¼Œå…¼å®¹ArkTSè¯­æ³•
   */
  private getObjectValues<T extends object>(obj: T): string[] {
    const values: string[] = [];
    for (const key in obj) {
      if (Object.getOwnPropertyNames(obj).includes(key)) {
        values.push(obj[key] as string);
      }
    }
    return values;
  }

  /**
   * æ„é€ å‡½æ•?
   */
  private constructor() {
    this.configService = ConfigService.getInstance();
    this.distributedDataService = ModernDistributedDataService.getInstance();
  }

  /**
   * åˆå§‹åŒ–æ•°æ®åŒæ­¥æœåŠ?
   * @param context åº”ç”¨ä¸Šä¸‹æ–?
   */
  public async initialize(context: Context): Promise<void> {
    if (this.isInitialized) {
      Logger.info(TAG, 'Data sync service already initialized');
      return;
    }

    try {
      Logger.info(TAG, 'Initializing data sync service...');

      // åŠ è½½é…ç½®
      await this.loadConfig();
      
      // åŠ è½½åŒæ­¥è®°å½•
      await this.loadSyncRecords();
      
      // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨åŒæ­¥ï¼Œå¯åŠ¨å®šæ—¶åŒæ­¥
      if (this.config.autoSync && this.config.enabled) {
        this.startAutoSync();
      }
      
      // å¦‚æœå¯ç”¨äº†å¯åŠ¨æ—¶åŒæ­¥ï¼Œæ‰§è¡ŒåŒæ­?
      if (this.config.syncOnStart && this.config.enabled) {
        this.synchronizeAll().catch(error => {
          Logger.error(TAG, `Failed to sync on start: ${error}`);
        });
      }
      
      // æ³¨å†Œåˆ†å¸ƒå¼æ•°æ®ç›‘å?
      this.registerDistributedDataListeners();
      
      this.isInitialized = true;
      Logger.info(TAG, 'Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully' instanceof Error ? 'Data sync service initialized successfully' : new Error(String('Data sync service initialized successfully')))))));
    } catch (error: Error) {
      Logger.error(TAG, `Failed to initialize data sync service: ${JSON.stringify(error)}`);
      throw error;
    }
  }

  /**
   * åŠ è½½é…ç½®
   */
  private async loadConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig('dataSyncConfig', DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG instanceof Error ? DEFAULT_DATA_SYNC_CONFIG : new Error(String(DEFAULT_DATA_SYNC_CONFIG)))))));
      if (savedConfig) {
        this.config = { ...DEFAULT_DATA_SYNC_CONFIG, ...savedConfig };
      }
    } catch (error: Error) {
      Logger.error(TAG, `Failed to load data sync config: ${error}`);
    }
  }

  /**
   * ä¿å­˜é…ç½®
   */
  public async saveConfig(config: Partial<DataSyncConfig>): Promise<void> {
    try {
      this.config = { ...this.config, ...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('dataSyncConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('dataSyncConfig', this.config)))))));
      
      // æ ¹æ®é…ç½®è°ƒæ•´è‡ªåŠ¨åŒæ­¥
      if (this.config.autoSync && this.config.enabled) {
        this.startAutoSync();
      } else {
        this.stopAutoSync();
      }
    } catch (error: Error) {
      Logger.error(TAG, `Failed to save data sync config: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–é…ç½®
   */
  public getConfig(): DataSyncConfig {
    return { ...this.config };
  }

  /**
   * åŠ è½½åŒæ­¥è®°å½•
   */
  private async loadSyncRecords(): Promise<void> {
    try {
      const records = await this.configService.getConfig<SyncRecord[]>('syncRecords', [] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([])))))));
      this.syncRecords = records;
      Logger.info(TAG, `Loaded ${this.syncRecords.length} sync records`);
    } catch (error: Error) {
      Logger.error(TAG, `Failed to load sync records: ${error}`);
    }
  }

  /**
   * ä¿å­˜åŒæ­¥è®°å½•
   */
  private async saveSyncRecords(): Promise<void> {
    try {
      // åªä¿ç•™æœ€è¿?00æ¡è®°å½?
      const recentRecords = this.syncRecords.slice(-100);
      await this.configService.setConfig('syncRecords', recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords : new Error(String(recentRecords instanceof Error ? recentRecords : new Error(String(recentRecords)))))));
    } catch (error: Error) {
      Logger.error(TAG, `Failed to save sync records: ${error}`);
    }
  }

  /**
   * æ³¨å†Œåˆ†å¸ƒå¼æ•°æ®ç›‘å?
   */
  private registerDistributedDataListeners(): void {
    // ç›‘å¬æ‰€æœ‰æ•°æ®ç±»å‹çš„å˜åŒ–
    const syncDataTypes = this.getObjectValues(SyncDataType);
    
    syncDataTypes.forEach(dataType => {
      this.distributedDataService.addDataChangeListener(
        dataType, (key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId : new Error(String((key, data, deviceId instanceof Error ? (key, data, deviceId : new Error(String((key, data, deviceId))))))) => {
          // å½“æ¥æ”¶åˆ°åˆ†å¸ƒå¼æ•°æ®å˜åŒ–æ—¶ï¼Œæ›´æ–°æœ¬åœ°æ•°æ?
          this.handleRemoteDataChange(dataType, key, data, deviceId).catch(error => {
            Logger.error(TAG, `Failed to handle remote data change: ${error}`);
          });
        }
      );
    });
  }

  /**
   * å¤„ç†è¿œç¨‹æ•°æ®å˜åŒ–
   */
  private async handleRemoteDataChange(dataType: SyncDataType, key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string instanceof Error ? key: string, data: Record<string, unknown>, deviceId: string : new Error(String(key: string, data: Record<string, unknown>, deviceId: string))))))): Promise<void> {
    // è·å–å¯¹åº”çš„æœ¬åœ°æ•°æ®æä¾›è€?
    const provider = this.dataProviders.get(dataType);
    if (!provider) {
      Logger.warn(TAG, `No data provider for type: ${dataType}`);
      return;
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­?
    if (!this.config.enabled) {
      return;
    }

    try {
      // æ ¹æ®åŒæ­¥ç­–ç•¥å¤„ç†æ•°æ®
      switch (this.config.syncStrategy) {
        case SyncStrategy.TIMESTAMP_BASED:
          await this.syncByTimestamp(provider, data, deviceId);
          break;
        case SyncStrategy.VERSION_BASED:
          await this.syncByVersion(provider, data, deviceId);
          break;
        case SyncStrategy.CHECKSUM_BASED:
          await this.syncByChecksum(provider, data, deviceId);
          break;
        default:
          // ç›´æ¥ä¿å­˜æ•°æ®
          await provider.saveData([data]);
          break;
      }
    } catch (error: Error) {
      Logger.error(TAG, `Failed to sync remote data: ${error}`);
    }
  }

  /**
   * åŸºäºæ—¶é—´æˆ³åŒæ­?
   */
  private async syncByTimestamp(provider: DataProvider, remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string instanceof Error ? remoteData: Record<string, unknown>, deviceId: string : new Error(String(remoteData: Record<string, unknown>, deviceId: string))))))): Promise<void> {
    const entityId = remoteData.id as string;
    const remoteTimestamp = (remoteData.timestamp as number) || Date.now();
    
    // è·å–æœ¬åœ°æ•°æ®
    const localData = await provider.getEntityById(entityId);
    
    if (!localData) {
      // æœ¬åœ°ä¸å­˜åœ¨ï¼Œç›´æ¥ä¿å­˜
      await provider.saveData([remoteData]);
    } else {
      const localTimestamp = localData.timestamp || 0;
      
      if (remoteTimestamp > localTimestamp) {
        // è¿œç¨‹æ•°æ®æ›´æ–°ï¼Œè¦†ç›–æœ¬åœ?
        await provider.updateData([remoteData]);
      } else if (remoteTimestamp < localTimestamp) {
        // æœ¬åœ°æ•°æ®æ›´æ–°ï¼ŒåŒæ­¥åˆ°è¿œç¨‹
        if (this.config.syncDirection !== SyncDirection.DOWNLOAD) {
          await this.distributedDataService.saveSyncData(
            provider.getDataType() as SyncDataType,
            entityId,
            localData,
            deviceId
          );
        }
      } else {
        // æ—¶é—´æˆ³ç›¸åŒï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å†²çª?
        const isConflict = this.checkConflict(localData, remoteData);
        if (isConflict) {
          await this.handleConflict(entityId, provider.getDataType(), localData, remoteData);
        }
      }
    }
  }

  /**
   * åŸºäºç‰ˆæœ¬å·åŒæ­?
   */
  private async syncByVersion(provider: DataProvider, remoteData: SyncEntity, deviceId: string): Promise<void> {
    const entityId = remoteData.id as string;
    const remoteVersion = (remoteData.version as number) || 0;
    
    const localData = await provider.getEntityById(entityId);
    
    if (!localData) {
      await provider.saveData([remoteData]);
    } else {
      const localVersion = localData.version || 0;
      
      if (remoteVersion > localVersion) {
        await provider.updateData([remoteData]);
      } else if (remoteVersion < localVersion) {
        if (this.config.syncDirection !== SyncDirection.DOWNLOAD) {
          await this.distributedDataService.saveSyncData(
            provider.getDataType() as SyncDataType,
            entityId,
            localData,
            deviceId
          );
        }
      } else {
        const isConflict = this.checkConflict(localData, remoteData);
        if (isConflict) {
          await this.handleConflict(entityId, provider.getDataType(), localData, remoteData);
        }
      }
    }
  }

  /**
   * åŸºäºæ ¡éªŒå’ŒåŒæ­?
   */
  private async syncByChecksum(provider: DataProvider, remoteData: SyncEntity, deviceId: string): Promise<void> {
    const entityId = remoteData.id as string;
    
    const localData = await provider.getEntityById(entityId);
    
    if (!localData) {
      await provider.saveData([remoteData]);
    } else {
      const localChecksum = this.calculateChecksum(localData);
      const remoteChecksum = remoteData.checksum || this.calculateChecksum(remoteData);
      
      if (localChecksum !== remoteChecksum) {
        // æ•°æ®ä¸åŒ¹é…ï¼Œå¤„ç†å†²çª
        await this.handleConflict(entityId, provider.getDataType(), localData, remoteData);
      }
    }
  }

  /**
   * æ£€æŸ¥å†²çª?
   */
  private checkConflict(localData: SyncEntity, remoteData: SyncEntity): boolean {
    // ç®€å•æ¯”è¾ƒï¼šå¦‚æœæ•°æ®å­—ç¬¦ä¸²è¡¨ç¤ºä¸åŒï¼Œåˆ™è®¤ä¸ºæœ‰å†²çª
    return JSON.stringify(localData) !== JSON.stringify(remoteData);
  }

  /**
   * å¤„ç†å†²çª
   */
  private async handleConflict(entityId: string, entityType: string, localData: SyncEntity, remoteData: SyncEntity): Promise<void> {
    const conflict: SyncConflict = {
      entityId,
      entityType,
      localData,
      remoteData,
      resolved: false
    };
    
    // æ·»åŠ åˆ°å†²çªé˜Ÿåˆ?
    this.conflictQueue.push(conflict);
    
    // é€šçŸ¥å†²çªæ£€æµ‹äº‹ä»?
    this.notifyEvent(SyncEvent.CONFLICT_DETECTED, conflict);
    
    // é»˜è®¤ä½¿ç”¨æ—¶é—´æˆ³è§£å†³å†²çª?
    const localTimestamp = (localData.timestamp as number) || 0;
    const remoteTimestamp = (remoteData.timestamp as number) || 0;
    
    if (localTimestamp > remoteTimestamp) {
      conflict.resolution = 'local';
    } else {
      conflict.resolution = 'remote';
    }
    
    conflict.resolved = true;
    await this.resolveConflict(conflict);
  }

  /**
   * è§£å†³å†²çª
   */
  private async resolveConflict(conflict: SyncConflict): Promise<void> {
    const provider = this.dataProviders.get(conflict.entityType);
    if (!provider) {
      return;
    }
    
    try {
      switch (conflict.resolution) {
        case 'local':
          // ä¿ç•™æœ¬åœ°æ•°æ®
          await provider.updateData([conflict.localData]);
          break;
        case 'remote':
          // ä½¿ç”¨è¿œç¨‹æ•°æ®
          await provider.updateData([conflict.remoteData]);
          break;
        case 'merged':
          // åˆå¹¶æ•°æ®ï¼ˆç®€å•å®ç°ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„åˆå¹¶é€»è¾‘ï¼?
          const mergedData = this.mergeData(conflict.localData, conflict.remoteData);
          await provider.updateData([mergedData]);
          break;
      }
      
      // é€šçŸ¥å†²çªè§£å†³äº‹ä»¶
      this.notifyEvent(SyncEvent.CONFLICT_RESOLVED, conflict);
    } catch (error: Error) {
      Logger.error(TAG, `Failed to resolve conflict: ${error}`);
    }
  }

  /**
   * åˆå¹¶æ•°æ®
   */
  private mergeData(localData: SyncEntity, remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity : new Error(String(remoteData: SyncEntity instanceof Error ? remoteData: SyncEntity : new Error(String(remoteData: SyncEntity))))))): SyncEntity {
    // ç®€å•åˆå¹¶ï¼šä¼˜å…ˆä¿ç•™æœ¬åœ°æ•°æ®ï¼Œè¡¥å……è¿œç¨‹æ•°æ®çš„æ–°å­—æ®?
    const merged: Record<string, string | number | boolean | null> = { ... };
    
    // ä¿ç•™æ›´æ–°æ—¶é—´æˆ?
    const localTimestamp = (localData.timestamp as number) || 0;
    const remoteTimestamp = (remoteData.timestamp as number) || 0;
    merged.timestamp = Math.max(localTimestamp, remoteTimestamp);
    
    return merged;
  }

  /**
   * è®¡ç®—æ ¡éªŒå’?
   */
  private calculateChecksum(data: SyncEntity): string {
    // ç®€å•å®ç°ï¼šä½¿ç”¨JSONå­—ç¬¦ä¸²çš„é•¿åº¦ä½œä¸ºæ ¡éªŒå’?
    // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„å“ˆå¸Œç®—æ³?
    const dataStr = JSON.stringify(data);
    let checksum = 0;
    for (let i = 0; i < dataStr.length; i++) {
      checksum += dataStr.charCodeAt(i);
    }
    return checksum.toString(16);
  }

  /**
   * æ³¨å†Œæ•°æ®æä¾›è€?
   */
  public registerDataProvider(provider: DataProvider): void {
    const dataType = provider.getDataType();
    this.dataProviders.set(dataType, provider);
    
    // åˆå§‹åŒ–å˜æ›´é˜Ÿåˆ?
    if (!this.pendingChanges.has(dataType)) {
      this.pendingChanges.set(dataType, []);
    }
    
    Logger.info(TAG, `Registered data provider for type: ${dataType}`);
  }

  /**
   * æ³¨é”€æ•°æ®æä¾›è€?
   */
  public unregisterDataProvider(dataType: string): void {
    this.dataProviders.delete(dataType);
    this.pendingChanges.delete(dataType);
    Logger.info(TAG, `Unregistered data provider for type: ${dataType}`);
  }

  /**
   * å¼€å§‹è‡ªåŠ¨åŒæ­?
   */
  private startAutoSync(): void {
    this.stopAutoSync();
    
    this.syncTimerId = setInterval(async () => {
      try {
        this.notifyEvent(SyncEvent.AUTO_SYNC_STARTED, null);
        await this.synchronizeAll();
      } catch (error: Error) {
        Logger.error(TAG, `Auto sync failed: ${error}`);
      } finally {
        this.notifyEvent(SyncEvent.AUTO_SYNC_STOPPED, null instanceof Error ? null : new Error(String(null instanceof Error ? null instanceof Error ? null : new Error(String(null : new Error(String(null instanceof Error ? null : new Error(String(null instanceof Error ? null instanceof Error ? null : new Error(String(null instanceof Error ? null instanceof Error ? null : new Error(String(null : new Error(String(null instanceof Error ? null : new Error(String(null : new Error(String(null instanceof Error ? null : new Error(String(null instanceof Error ? null instanceof Error ? null : new Error(String(null : new Error(String(null instanceof Error ? null : new Error(String(null)))))));
      }
    }, this.config.syncInterval * 1000);
    
    Logger.info(TAG, `Auto sync started with interval: ${this.config.syncInterval}s`);
  }

  /**
   * åœæ­¢è‡ªåŠ¨åŒæ­¥
   */
  private stopAutoSync(): void {
    if (this.syncTimerId !== null) {
      clearInterval(this.syncTimerId);
      this.syncTimerId = null;
      Logger.info(TAG, 'Auto sync stopped');
    }
  }

  /**
   * åŒæ­¥æ‰€æœ‰æ•°æ®ç±»å?
   */
  public async synchronizeAll(): Promise<void> {
    if (!this.config.enabled || this.isRunning) {
      return;
    }

    this.isRunning = true;
    const startTime = Date.now();
    
    try {
      Logger.info(TAG, 'Starting full data synchronization...');
      
      // éå†æ‰€æœ‰æ³¨å†Œçš„æ•°æ®æä¾›è€?
      const tasks = Array.from(this.dataProviders.keys()).map(dataType => 
        this.synchronizeDataType(dataType)
      );
      
      // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ?
      await Promise.all(tasks);
      
      // è®°å½•åŒæ­¥ç»“æœ
      const duration = Date.now() - startTime;
      await this.saveSyncRecord({
        syncTime: startTime,
        duration,
        direction: this.config.syncDirection,
        totalRecords: 0, // éœ€è¦æ ¹æ®å®é™…åŒæ­¥æƒ…å†µç»Ÿè®?
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: true
      });
      
      Logger.info(TAG, `Full data synchronization completed in ${duration}ms`);
    } catch (error: Error) {
      Logger.error(TAG, `Full data synchronization failed: ${error}`);
      
      // è®°å½•å¤±è´¥çš„åŒæ­?
      const duration = Date.now() - startTime;
      await this.saveSyncRecord({
        syncTime: startTime, duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error instanceof Error ? duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error : new Error(String(duration,
        direction: this.config.syncDirection,
        totalRecords: 0,
        syncedRecords: 0,
        failedRecords: 0,
        conflictRecords: 0,
        success: false,
        errorMessage: String(error)))))))
      });
    } finally {
      this.isRunning = false;
    }
  }

  /**
   * åŒæ­¥ç‰¹å®šæ•°æ®ç±»å‹
   */
  public async synchronizeDataType(dataType: string): Promise<void> {
    const provider = this.dataProviders.get(dataType);
    if (!provider) {
      throw new Error(`No data provider registered for type: ${dataType}`);
    }

    // åˆ›å»ºåŒæ­¥ä»»åŠ¡
    const task: SyncTask = {
      id: `sync_${dataType}_${Date.now()}`,
      dataType,
      direction: this.config.syncDirection,
      priority: 50,
      state: SyncState.PENDING,
      progress: 0,
      retryCount: 0
    };
    
    this.syncTasks.set(task.id, task);
    this.notifyTaskUpdate(task);
    
    try {
      task.state = SyncState.RUNNING;
      task.startTime = Date.now();
      this.notifyTaskUpdate(task);
      
      // æ‰§è¡ŒåŒæ­¥
      if (this.config.syncDirection === SyncDirection.UPLOAD || 
          this.config.syncDirection === SyncDirection.BIDIRECTIONAL) {
        await this.uploadData(provider, task);
      }
      
      if (this.config.syncDirection === SyncDirection.DOWNLOAD || 
          this.config.syncDirection === SyncDirection.BIDIRECTIONAL) {
        await this.downloadData(provider, task);
      }
      
      // æ›´æ–°ä»»åŠ¡çŠ¶æ€?
      task.state = SyncState.COMPLETED;
      task.progress = 100;
      task.endTime = Date.now();
      
      this.notifyTaskUpdate(task);
      this.notifyEvent(SyncEvent.SYNC_COMPLETED, task);
      
    } catch (error: Error) {
      Logger.error(TAG, `Failed to sync data type ${dataType}: ${error}`);
      
      task.state = SyncState.FAILED;
      task.error = String(error);
      task.endTime = Date.now();
      
      this.notifyTaskUpdate(task);
      this.notifyEvent(SyncEvent.SYNC_FAILED, task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task)))))));
      
      // å¤„ç†é‡è¯•
      if (task.retryCount < this.config.maxSyncRetry) {
        task.retryCount++;
        await this.retrySync(task);
      }
    } finally {
      // ä»æ´»è·ƒä»»åŠ¡ä¸­ç§»é™¤
      setTimeout(() => {
        this.syncTasks.delete(task.id);
      }, 60000); // 1åˆ†é’Ÿåç§»é™?
    }
  }

  /**
   * ä¸Šä¼ æ•°æ®
   */
  private async uploadData(provider: DataProvider, task: SyncTask): Promise<void> {
    const lastSyncTime = await provider.getLastSyncTime();
    const changes = await provider.getChanges(lastSyncTime);
    
    task.totalCount = changes.length;
    this.notifyTaskUpdate(task);
    
    let successCount = 0;
    let failedCount = 0;
    
    for (let i = 0; i < changes.length; i++) {
      const change = changes[i];
      
      try {
        // ä¸Šä¼ æ•°æ®åˆ°åˆ†å¸ƒå¼å­˜å‚¨
        await this.distributedDataService.saveSyncData(
          provider.getDataType() as SyncDataType,
          change.entityId,
          change.data
        );
        successCount++;
      } catch (error: Error) {
        Logger.error(TAG, `Failed to upload change for ${change.entityId}: ${error}`);
        failedCount++;
      }
      
      // æ›´æ–°è¿›åº¦
      task.progress = Math.round(((i + 1) / changes.length) * 100);
      task.successCount = successCount;
      task.failedCount = failedCount;
      this.notifyTaskUpdate(task);
    }
    
    // æ›´æ–°æœ€ååŒæ­¥æ—¶é—?
    await provider.setLastSyncTime(Date.now());
  }

  /**
   * ä¸‹è½½æ•°æ®
   */
  private async downloadData(provider: DataProvider, task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask : new Error(String(task: SyncTask instanceof Error ? task: SyncTask : new Error(String(task: SyncTask))))))): Promise<void> {
    // TODO: ä»åˆ†å¸ƒå¼å­˜å‚¨ä¸‹è½½æ•°æ®
    // è¿™é‡Œéœ€è¦å®ç°ä»åˆ†å¸ƒå¼æ•°æ®æœåŠ¡è·å–æ•°æ®å¹¶ä¿å­˜åˆ°æœ¬åœ°çš„é€»è¾‘
    Logger.debug(TAG, `Downloading data for type: ${provider.getDataType()}`);
    
    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    for (let progress = 10; progress <= 90; progress += 10) {
      task.progress = progress;
      this.notifyTaskUpdate(task);
      // çŸ­æš‚å»¶è¿Ÿæ¨¡æ‹ŸåŒæ­¥è¿‡ç¨‹
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }

  /**
   * é‡è¯•åŒæ­¥
   */
  private async retrySync(task: SyncTask): Promise<void> {
    Logger.info(TAG, `Retrying sync task ${task.id} (attempt ${task.retryCount}/${this.config.maxSyncRetry})`);
    
    // ç­‰å¾…é‡è¯•é—´éš”
    await new Promise(resolve => setTimeout(resolve, this.config.retryInterval * 1000));
    
    try {
      await this.synchronizeDataType(task.dataType);
    } catch (error: Error) {
      Logger.error(TAG, `Retry failed for task ${task.id}: ${error}`);
    }
  }

  /**
   * è®°å½•æ•°æ®å˜æ›´
   */
  public async recordDataChange(change: DataChange): Promise<void> {
    const { entityType } = change;
    
    if (!this.pendingChanges.has(entityType)) {
      this.pendingChanges.set(entityType, [] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([])))))));
    }
    
    this.pendingChanges.get(entityType)!.push(change);
    
    // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨åŒæ­¥ï¼Œå¯ä»¥è€ƒè™‘ç«‹å³åŒæ­¥é‡è¦å˜æ›´
    if (this.config.enabled && this.config.autoSync) {
      // TODO: å®ç°ç«‹å³åŒæ­¥é‡è¦å˜æ›´çš„é€»è¾‘
    }
  }

  /**
   * ä¿å­˜åŒæ­¥è®°å½•
   */
  private async saveSyncRecord(record: Omit<SyncRecord, 'id'>): Promise<void> {
    const syncRecord: SyncRecord = {
      id: `record_${Date.now()}`,
      ...record
    };
    
    this.syncRecords.push(syncRecord);
    await this.saveSyncRecords();
  }

  /**
   * è·å–åŒæ­¥è®°å½•
   */
  public getSyncRecords(limit: number = 20): SyncRecord[] {
    return [...this.syncRecords]
      .sort((a, b) => b.syncTime - a.syncTime)
      .slice(0, limit);
  }

  /**
   * è·å–åŒæ­¥ä»»åŠ¡
   */
  public getSyncTasks(): SyncTask[] {
    return Array.from(this.syncTasks.values());
  }

  /**
   * è·å–å†²çªé˜Ÿåˆ—
   */
  public getConflicts(): SyncConflict[] {
    return [...this.conflictQueue];
  }

  /**
   * æ‰‹åŠ¨è§£å†³å†²çª
   */
  public async resolveConflictManually(conflictId: string, resolution: 'local' | 'remote' | 'merged'): Promise<void> {
    const conflict = this.conflictQueue.find(c => c.entityId === conflictId);
    if (!conflict || conflict.resolved) {
      throw new Error('Conflict not found or already resolved');
    }
    
    conflict.resolution = resolution;
    conflict.resolved = true;
    
    await this.resolveConflict(conflict);
  }

  /**
   * é€šçŸ¥ä»»åŠ¡æ›´æ–°
   */
  private notifyTaskUpdate(task: SyncTask): void {
    const listeners = this.listeners.get(task.dataType) || [];
    for (const listener of listeners) {
      try {
        listener({ ...task });
      } catch (error: Error) {
        Logger.error(TAG, `Error in sync listener: ${error}`);
      }
    }
    
    // é€šçŸ¥è¿›åº¦äº‹ä»¶
    this.notifyEvent(SyncEvent.SYNC_PROGRESS, task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task instanceof Error ? task instanceof Error ? task : new Error(String(task : new Error(String(task instanceof Error ? task : new Error(String(task)))))));
  }

  /**
   * æ·»åŠ åŒæ­¥ç›‘å¬
   */
  public addSyncListener(dataType: string, listener: SyncListener): void {
    if (!this.listeners.has(dataType)) {
      this.listeners.set(dataType, []);
    }
    
    this.listeners.get(dataType)!.push(listener);
  }

  /**
   * ç§»é™¤åŒæ­¥ç›‘å¬
   */
  public removeSyncListener(dataType: string, listener: SyncListener): void {
    if (this.listeners.has(dataType)) {
      const listeners = this.listeners.get(dataType)!;
      const index = listeners.indexOf(listener);
      
      if (index > -1) {
        listeners.splice(index, 1);
      }
    }
  }

  /**
   * æ·»åŠ åŒæ­¥äº‹ä»¶ç›‘å¬
   */
  public addSyncEventListener(event: SyncEvent, listener: SyncEventListener): void {
    if (!this.eventListeners.has(event)) {
      this.eventListeners.set(event, []);
    }
    
    this.eventListeners.get(event)!.push(listener);
  }

  /**
   * ç§»é™¤åŒæ­¥äº‹ä»¶ç›‘å¬
   */
  public removeSyncEventListener(event: SyncEvent, listener: SyncEventListener): void {
    if (this.eventListeners.has(event)) {
      const listeners = this.eventListeners.get(event)!;
      const index = listeners.indexOf(listener);
      
      if (index > -1) {
        listeners.splice(index, 1);
      }
    }
  }

  /**
   * é€šçŸ¥äº‹ä»¶
   */
  private notifyEvent(event: SyncEvent, data: Record<string, unknown> | null): void {
    if (this.eventListeners.has(event)) {
      const listeners = this.eventListeners.get(event)!;
      for (const listener of listeners) {
        try {
          listener(event, data);
        } catch (error: Error) {
          Logger.error(TAG, `Error in sync event listener: ${error}`);
        }
      }
    }
  }

  /**
   * å…³é—­æ•°æ®åŒæ­¥æœåŠ¡
   */
  public close(): void {
    if (!this.isInitialized) {
      return;
    }

    this.stopAutoSync();
    
    // ä¿å­˜æ‰€æœ‰æ•°æ?
    this.saveSyncRecords().catch(error => {
      Logger.error(TAG, `Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}` instanceof Error ? `Error saving sync records on close: ${error}` : new Error(String(`Error saving sync records on close: ${error}`)))))));
    });

    this.isInitialized = false;
    Logger.info(TAG, 'Data sync service closed');
  }
}


