import Logger from '../../common/util/Logger';
import media from '@ohos.multimedia.media';

// çœŸå®æ’­æ”¾å™¨çŠ¶æ€æšä¸¾ï¼ˆåŸºäºHarmonyOSåª’ä½“æ’­æ”¾å™¨çŠ¶æ€ï¼‰
const PlayerState = {
  IDLE: 0,
  INITIALIZED: 1,
  PREPARED: 2,
  PLAYING: 3,
  PAUSED: 4,
  STOPPED: 5,
  PLAYBACK_COMPLETE: 6,
  ERROR: 7,
  RELEASED: 8
} as const;

// çœŸå®æ’­æ”¾å™¨ç±» - åŸºäºHarmonyOS AVPlayer
class RealPlayer {
  private avPlayer: media.AVPlayer | null = null;
  private currentTime: number = 0;
  private duration: number = 0;
  private volume: number = 1.0;
  private isMuted: boolean = false;
  private speed: number = 1.0;
  // å®šä¹‰æ¯ç§äº‹ä»¶ç±»å‹çš„å›è°ƒæ¥å?
  private stateChangeListeners: ((state: string, reason: number) => void)[] = [];
  private errorListeners: ((errorCode: number, errorMsg: string) => void)[] = [];
  private bufferListeners: ((bufferingRate: number) => void)[] = [];
  private completeListeners: (() => void)[] = [];
  private timeUpdateListeners: ((currentTime: number) => void)[] = [];

  async createPlayer(): Promise<RealPlayer> {
    try {
      // åˆ›å»ºAVPlayerå®ä¾‹
      this.avPlayer = await media.createAVPlayer();
      
      // è®¾ç½®æ’­æ”¾å™¨å›è°?
      this.setupPlayerCallbacks();
      
      Logger.info('RealPlayer', 'AVPlayer created successfully');
      return this;
    } catch (error) {
      Logger.error('RealPlayer', `Failed to create AVPlayer: ${error}`);
      throw error;
    }
  }

  async setSource(source: string): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // è®¾ç½®æ’­æ”¾æº?
      await this.avPlayer.setSource(source);
      Logger.info('RealPlayer', `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}`)))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to set source: ${error}`);
      throw error;
    }
  }

  async prepare(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // å‡†å¤‡æ’­æ”¾å™?
      await this.avPlayer.prepare();
      Logger.info('RealPlayer', 'Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared' : new Error(String('Player prepared' instanceof Error ? 'Player prepared' : new Error(String('Player prepared')))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to prepare: ${error}`);
      throw error;
    }
  }

  async play(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // å¼€å§‹æ’­æ”?
      await this.avPlayer.play();
      Logger.info('RealPlayer', 'Player started' instanceof Error ? 'Player started' : new Error(String('Player started' instanceof Error ? 'Player started' instanceof Error ? 'Player started' : new Error(String('Player started' : new Error(String('Player started' instanceof Error ? 'Player started' : new Error(String('Player started' instanceof Error ? 'Player started' instanceof Error ? 'Player started' : new Error(String('Player started' instanceof Error ? 'Player started' instanceof Error ? 'Player started' : new Error(String('Player started' : new Error(String('Player started' instanceof Error ? 'Player started' : new Error(String('Player started' : new Error(String('Player started' instanceof Error ? 'Player started' : new Error(String('Player started' instanceof Error ? 'Player started' instanceof Error ? 'Player started' : new Error(String('Player started' : new Error(String('Player started' instanceof Error ? 'Player started' : new Error(String('Player started')))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to play: ${error}`);
      throw error;
    }
  }

  async pause(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // æš‚åœæ’­æ”¾
      await this.avPlayer.pause();
      Logger.info('RealPlayer', 'Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused' : new Error(String('Player paused' instanceof Error ? 'Player paused' : new Error(String('Player paused')))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to pause: ${error}`);
      throw error;
    }
  }

  async stop(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // åœæ­¢æ’­æ”¾
      await this.avPlayer.stop();
      Logger.info('RealPlayer', 'Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped' : new Error(String('Player stopped' instanceof Error ? 'Player stopped' : new Error(String('Player stopped')))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to stop: ${error}`);
      throw error;
    }
  }

  async seek(timeMs: number, mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC instanceof Error ? mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC : new Error(String(mode: media.SeekMode = media.SeekMode.SEEK_PREV_SYNC))))))): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // è·³è½¬åˆ°æŒ‡å®šä½ç½?
      await this.avPlayer.seek(timeMs, mode);
      Logger.info('RealPlayer', `Seeked to: ${timeMs}ms`);
    } catch (error) {
      Logger.error('RealPlayer', `Failed to seek: ${error}`);
      throw error;
    }
  }

  async setVolume(volume: number): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // è®¾ç½®éŸ³é‡
      await this.avPlayer.setVolume(volume);
      this.volume = volume;
      Logger.info('RealPlayer', `Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}` instanceof Error ? `Volume set to: ${volume}` : new Error(String(`Volume set to: ${volume}`)))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to set volume: ${error}`);
      throw error;
    }
  }

  async setMute(mute: boolean): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // è®¾ç½®é™éŸ³
      await this.avPlayer.setMute(mute);
      this.isMuted = mute;
      Logger.info('RealPlayer', `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}`)))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to set mute: ${error}`);
      throw error;
    }
  }

  async setSpeed(speed: number): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not created');
      }
      
      // è®¾ç½®æ’­æ”¾é€Ÿåº¦
      await this.avPlayer.setSpeed(speed);
      this.speed = speed;
      Logger.info('RealPlayer', `Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}` instanceof Error ? `Speed set to: ${speed}` : new Error(String(`Speed set to: ${speed}`)))))));
    } catch (error) {
      Logger.error('RealPlayer', `Failed to set speed: ${error}`);
      throw error;
    }
  }

  async getCurrentTime(): Promise<number> {
    try {
      if (!this.avPlayer) {
        return 0;
      }
      
      // è·å–å½“å‰æ’­æ”¾ä½ç½®
      const currentTime = await this.avPlayer.getCurrentTime();
      this.currentTime = currentTime;
      return currentTime;
    } catch (error) {
      Logger.error('RealPlayer', `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}`)))))));
      return this.currentTime;
    }
  }

  async getDuration(): Promise<number> {
    try {
      if (!this.avPlayer) {
        return 0;
      }
      
      // è·å–æ€»æ—¶é•?
      const duration = await this.avPlayer.getDuration();
      this.duration = duration;
      return duration;
    } catch (error) {
      Logger.error('RealPlayer', `Failed to get duration: ${error}`);
      return this.duration;
    }
  }

  async release(): Promise<void> {
    try {
      if (this.avPlayer) {
        // é‡Šæ”¾æ’­æ”¾å™¨èµ„æº?
        await this.avPlayer.release();
        this.avPlayer = null;
        Logger.info('RealPlayer', 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released')))))));
      }
    } catch (error) {
      Logger.error('RealPlayer', `Failed to release player: ${error}`);
      throw error;
    }
  }

  // é‡è½½onæ–¹æ³•ï¼Œä¸ºæ¯ç§äº‹ä»¶ç±»å‹æä¾›ç±»å‹å®‰å…¨çš„æ¥å?
  on(event: 'stateChange', callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number instanceof Error ? callback: (state: string, reason: number : new Error(String(callback: (state: string, reason: number))))))) => void): void;
  on(event: 'error', callback: (errorCode: number, errorMsg: string) => void): void;
  on(event: 'bufferingChange', callback: (bufferingRate: number) => void): void;
  on(event: 'playbackComplete', callback: () => void): void;
  on(event: 'timeUpdate', callback: (currentTime: number) => void): void;
  // ä½œä¸ºç±»å‹ç³»ç»Ÿçš„å…¼å®¹å±‚ï¼Œå¤„ç†å¯èƒ½çš„æœªçŸ¥äº‹ä»¶ç±»å‹
  on(event: string, callback: (...args: Record<string, string | number | boolean | null>[]) => void): void {
    // æ ¹æ®äº‹ä»¶ç±»å‹å­˜å‚¨å¯¹åº”çš„å›è°ƒå‡½æ•?
    switch (event) {
      case 'stateChange':
        this.stateChangeListeners.push(callback as (state: string, reason: number) => void);
        break;
      case 'error':
        this.errorListeners.push(callback as (errorCode: number, errorMsg: string) => void);
        break;
      case 'bufferingChange':
        this.bufferListeners.push(callback as (bufferingRate: number) => void);
        break;
      case 'playbackComplete':
        this.completeListeners.push(callback as () => void);
        break;
      case 'timeUpdate':
        this.timeUpdateListeners.push(callback as (currentTime: number) => void);
        break;
    }
  }

  // é‡è½½emitæ–¹æ³•ï¼Œä¸ºæ¯ç§äº‹ä»¶ç±»å‹æä¾›ç±»å‹å®‰å…¨çš„æ¥å?
  private emit(event: 'stateChange', state: string, reason: number): void {
    this.stateChangeListeners.forEach(callback => callback(state, reason));
  }
  private emit(event: 'error', errorCode: number, errorMsg: string): void {
    this.errorListeners.forEach(callback => callback(errorCode, errorMsg));
  }
  private emit(event: 'bufferingChange', bufferingRate: number): void {
    this.bufferListeners.forEach(callback => callback(bufferingRate));
  }
  private emit(event: 'playbackComplete'): void {
    this.completeListeners.forEach(callback => callback());
  }
  private emit(event: 'timeUpdate', currentTime: number): void {
    this.timeUpdateListeners.forEach(callback => callback(currentTime));
  }
  // é€šç”¨å®ç°ï¼ˆä½œä¸ºåå¤‡ï¼‰
  // é€šç”¨å®ç°ä½œä¸ºç±»å‹ç³»ç»Ÿçš„å…¼å®¹å±‚
  private emit(event: string, ...args: Record<string, string | number | boolean | null>[]): void {
    // è¿™ä¸ªé€šç”¨å®ç°å®é™…ä¸Šä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä¸ºæ‰€æœ‰äº‹ä»¶ç±»å‹æä¾›äº†å…·ä½“å®ç°
    // è¿™é‡Œä»…ä½œä¸ºç±»å‹ç³»ç»Ÿçš„å…¼å®¹å±?
  }

  private setupPlayerCallbacks(): void {
    if (!this.avPlayer) return;

    // çŠ¶æ€å˜åŒ–å›è°?
    this.avPlayer.on('stateChange', (state: string, reason: number) => {
      Logger.info('RealPlayer', `Player state changed: ${state}, reason: ${reason}`);
      this.emit('stateChange', state, reason);
    });

    // é”™è¯¯å›è°ƒ
    this.avPlayer.on('error', (error: media.AVPlayerError) => {
      Logger.error('RealPlayer', `Player error: ${error.code}, message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}` : new Error(String(message: ${error.message}` instanceof Error ? message: ${error.message}` : new Error(String(message: ${error.message}`)))))));
      this.emit('error', error.code, error.message);
    });

    // ç¼“å†²æ›´æ–°å›è°ƒ
    this.avPlayer.on('bufferingUpdate', (info: media.BufferingInfo) => {
      Logger.info('RealPlayer', `Buffering update: ${info.bufferingPercentage}%`);
      this.emit('bufferingChange', info.bufferingPercentage);
    });

    // æ’­æ”¾å®Œæˆå›è°ƒ
    this.avPlayer.on('playbackComplete', () => {
      Logger.info('RealPlayer', 'Playback completed');
      this.emit('playbackComplete');
    });

    // æ—¶é—´æ›´æ–°å›è°ƒ
    this.avPlayer.on('timeUpdate', (currentTime: number) => {
      this.currentTime = currentTime;
      this.emit('timeUpdate', currentTime);
    });
  }
}

/**
 * æ’­æ”¾çŠ¶æ€æšä¸?
 */
export enum PlaybackStatus {
  IDLE = 'IDLE',
  INITIALIZED = 'INITIALIZED',
  PREPARING = 'PREPARING',
  PREPARED = 'PREPARED',
  PLAYING = 'PLAYING',
  PAUSED = 'PAUSED',
  STOPPED = 'STOPPED',
  COMPLETED = 'COMPLETED',
  ERROR = 'ERROR'
}

/**
 * æ’­æ”¾é€Ÿåº¦æšä¸¾
 */
export enum PlaybackSpeed {
  SLOWEST = 0.5,
  SLOW = 0.75,
  NORMAL = 1.0,
  FAST = 1.5,
  FASTEST = 2.0
}

/**
 * AVPlayerServiceæ¥å£
 */
export interface AVPlayerService {
  // åˆå§‹åŒ–æ’­æ”¾å™¨
  init(): Promise<void>;
  
  // è®¾ç½®æ’­æ”¾æº?
  setSource(source: string): Promise<void>;
  
  // å‡†å¤‡æ’­æ”¾
  prepare(): Promise<void>;
  
  // å¼€å§‹æ’­æ”?
  play(): Promise<void>;
  
  // æš‚åœæ’­æ”¾
  pause(): Promise<void>;
  
  // åœæ­¢æ’­æ”¾
  stop(): Promise<void>;
  
  // è·³è½¬åˆ°æŒ‡å®šä½ç½?
  seekTo(timeMs: number): Promise<void>;
  
  // è®¾ç½®éŸ³é‡
  setVolume(volume: number): Promise<void>;
  
  // è®¾ç½®é™éŸ³
  setMute(mute: boolean): Promise<void>;
  
  // è®¾ç½®æ’­æ”¾é€Ÿåº¦
  setSpeed(speed: PlaybackSpeed): Promise<void>;
  
  // è·å–å½“å‰æ’­æ”¾ä½ç½®
  getCurrentTime(): Promise<number>;
  
  // è·å–æ€»æ—¶é•?
  getDuration(): Promise<number>;
  
  // è·å–æ’­æ”¾çŠ¶æ€?
  getStatus(): PlaybackStatus;
  
  // è®¾ç½®æ’­æ”¾çŠ¶æ€ç›‘å¬å™¨
  onStatusChange(callback: (status: PlaybackStatus) => void): void;
  
  // è®¾ç½®é”™è¯¯ç›‘å¬å™?
  onError(callback: (error: Error) => void): void;
  
  // è®¾ç½®ç¼“å†²çŠ¶æ€ç›‘å¬å™¨
  onBufferUpdate(callback: (bufferingRate: number) => void): void;
  
  // é‡Šæ”¾æ’­æ”¾å™¨èµ„æº?
  release(): Promise<void>;
}

/**
 * AVPlayerServiceå®ç°ç±?
 * åŸºäºHarmonyOS AVPlayerå®ç°åª’ä½“æ’­æ”¾åŠŸèƒ½
 */
export class AVPlayerServiceImpl implements AVPlayerService {
  private readonly TAG: string = 'AVPlayerServiceImpl';
  private avPlayer: RealPlayer | null = null;
  private currentStatus: PlaybackStatus = PlaybackStatus.IDLE;
  private sourceUrl: string = '';
  private statusChangeCallback?: (status: PlaybackStatus) => void;
  private errorCallback?: (error: Error) => void;
  private bufferUpdateCallback?: (bufferingRate: number) => void;
  
  /**
   * åˆå§‹åŒ–æ’­æ”¾å™¨
   */
  public async init(): Promise<void> {
    try {
      // åˆ›å»ºçœŸå®æ’­æ”¾å™¨å®ä¾?
      this.avPlayer = new RealPlayer();
      await this.avPlayer.createPlayer();
      
      // è®¾ç½®çŠ¶æ€ç›‘å?
      this.setupPlayerListeners();
      
      this.updateStatus(PlaybackStatus.IDLE);
      Logger.info(this.TAG, 'AVPlayer initialized');
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize AVPlayer: ${error}`);
      throw error;
    }
  }
  
  /**
   * è®¾ç½®æ’­æ”¾æº?
   */
  public async setSource(source: string): Promise<void> {
    try {
      if (!this.avPlayer) {
        await this.init();
      }
      
      this.sourceUrl = source;
      await this.avPlayer.setSource(source);
      this.updateStatus(PlaybackStatus.INITIALIZED);
      Logger.info(this.TAG, `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}` : new Error(String(`Source set: ${source}` instanceof Error ? `Source set: ${source}` : new Error(String(`Source set: ${source}`)))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to set source: ${error}`);
      this.updateStatus(PlaybackStatus.ERROR);
      throw error;
    }
  }
  
  /**
   * å‡†å¤‡æ’­æ”¾
   */
  public async prepare(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      this.updateStatus(PlaybackStatus.PREPARING);
      await this.avPlayer.prepare();
      // å‡†å¤‡å®ŒæˆçŠ¶æ€ä¼šåœ¨äº‹ä»¶ç›‘å¬ä¸­æ›´æ–°
    } catch (error) {
      Logger.error(this.TAG, `Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}` instanceof Error ? `Failed to prepare: ${error}` : new Error(String(`Failed to prepare: ${error}`)))))));
      this.updateStatus(PlaybackStatus.ERROR);
      throw error;
    }
  }
  
  /**
   * å¼€å§‹æ’­æ”?
   */
  public async play(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      await this.avPlayer.play();
      // æ’­æ”¾çŠ¶æ€ä¼šåœ¨äº‹ä»¶ç›‘å¬ä¸­æ›´æ–°
    } catch (error) {
      Logger.error(this.TAG, `Failed to play: ${error}`);
      throw error;
    }
  }
  
  /**
   * æš‚åœæ’­æ”¾
   */
  public async pause(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      await this.avPlayer.pause();
      this.updateStatus(PlaybackStatus.PAUSED);
      Logger.info(this.TAG, 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused')))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to pause: ${error}`);
      throw error;
    }
  }
  
  /**
   * åœæ­¢æ’­æ”¾
   */
  public async stop(): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      await this.avPlayer.stop();
      this.updateStatus(PlaybackStatus.STOPPED);
      Logger.info(this.TAG, 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped')))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to stop: ${error}`);
      throw error;
    }
  }
  
  /**
   * è·³è½¬åˆ°æŒ‡å®šä½ç½?
   */
  public async seekTo(timeMs: number): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      await this.avPlayer.seek(timeMs, media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC instanceof Error ? media.SeekMode.SEEK_PREV_SYNC : new Error(String(media.SeekMode.SEEK_PREV_SYNC)))))));
      Logger.info(this.TAG, `Seeked to: ${timeMs}ms`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to seek: ${error}`);
      throw error;
    }
  }
  
  /**
   * è®¾ç½®éŸ³é‡
   */
  public async setVolume(volume: number): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      // ç¡®ä¿éŸ³é‡åœ?-1ä¹‹é—´
      const normalizedVolume = Math.max(0, Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume : new Error(String(Math.min(1, volume instanceof Error ? Math.min(1, volume : new Error(String(Math.min(1, volume))))))));
      await this.avPlayer.setVolume(normalizedVolume);
      Logger.info(this.TAG, `Volume set to: ${normalizedVolume}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to set volume: ${error}`);
      throw error;
    }
  }
  
  /**
   * è®¾ç½®é™éŸ³
   */
  public async setMute(mute: boolean): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      await this.avPlayer.setMute(mute);
      Logger.info(this.TAG, `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}` instanceof Error ? `Mute set to: ${mute}` : new Error(String(`Mute set to: ${mute}`)))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to set mute: ${error}`);
      throw error;
    }
  }
  
  /**
   * è®¾ç½®æ’­æ”¾é€Ÿåº¦
   */
  public async setSpeed(speed: PlaybackSpeed): Promise<void> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      await this.avPlayer.setSpeed(speed);
      Logger.info(this.TAG, `Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}` instanceof Error ? `Playback speed set to: ${speed}` : new Error(String(`Playback speed set to: ${speed}`)))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to set speed: ${error}`);
      throw error;
    }
  }
  
  /**
   * è·å–å½“å‰æ’­æ”¾ä½ç½®
   */
  public async getCurrentTime(): Promise<number> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      const currentTime = await this.avPlayer.getCurrentTime();
      return currentTime;
    } catch (error) {
      Logger.error(this.TAG, `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}` instanceof Error ? `Failed to get current time: ${error}` : new Error(String(`Failed to get current time: ${error}`)))))));
      return 0;
    }
  }
  
  /**
   * è·å–æ€»æ—¶é•?
   */
  public async getDuration(): Promise<number> {
    try {
      if (!this.avPlayer) {
        throw new Error('Player not initialized');
      }
      
      const duration = await this.avPlayer.getDuration();
      return duration;
    } catch (error) {
      Logger.error(this.TAG, `Failed to get duration: ${error}`);
      return 0;
    }
  }
  
  /**
   * è·å–æ’­æ”¾çŠ¶æ€?
   */
  public getStatus(): PlaybackStatus {
    return this.currentStatus;
  }
  
  /**
   * è®¾ç½®æ’­æ”¾çŠ¶æ€ç›‘å¬å™¨
   */
  public onStatusChange(callback: (status: PlaybackStatus) => void): void {
    this.statusChangeCallback = callback;
    // ç«‹å³å›è°ƒå½“å‰çŠ¶æ€?
    callback(this.currentStatus);
  }
  
  /**
   * è®¾ç½®é”™è¯¯ç›‘å¬å™?
   */
  public onError(callback: (error: Error) => void): void {
    this.errorCallback = callback;
  }
  
  /**
   * è®¾ç½®ç¼“å†²çŠ¶æ€ç›‘å¬å™¨
   */
  public onBufferUpdate(callback: (bufferingRate: number) => void): void {
    this.bufferUpdateCallback = callback;
  }
  
  /**
   * é‡Šæ”¾æ’­æ”¾å™¨èµ„æº?
   */
  public async release(): Promise<void> {
    try {
      if (this.avPlayer) {
        await this.avPlayer.release();
        this.avPlayer = null;
        this.updateStatus(PlaybackStatus.IDLE);
        Logger.info(this.TAG, 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released' instanceof Error ? 'Player released' instanceof Error ? 'Player released' : new Error(String('Player released' : new Error(String('Player released' instanceof Error ? 'Player released' : new Error(String('Player released')))))));
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to release player: ${error}`);
      throw error;
    }
  }
  
  /**
   * è®¾ç½®æ’­æ”¾å™¨ç›‘å¬å™¨
   */
  private setupPlayerListeners(): void {
    if (!this.avPlayer) return;
    
    // çŠ¶æ€å˜åŒ–ç›‘å?
    this.avPlayer.on('stateChange', (state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number : new Error(String((state: string, reason: number instanceof Error ? (state: string, reason: number : new Error(String((state: string, reason: number))))))) => {
      Logger.info(this.TAG, `Player state changed: ${state}, reason: ${reason}`);
      
      // æ ¹æ®HarmonyOS AVPlayerçŠ¶æ€æ˜ å°„åˆ°åº”ç”¨çŠ¶æ€?
      switch (state) {
        case 'idle':
          this.updateStatus(PlaybackStatus.IDLE);
          break;
        case 'initialized':
          this.updateStatus(PlaybackStatus.INITIALIZED);
          break;
        case 'prepared':
          this.updateStatus(PlaybackStatus.PREPARED);
          break;
        case 'playing':
          this.updateStatus(PlaybackStatus.PLAYING);
          break;
        case 'paused':
          this.updateStatus(PlaybackStatus.PAUSED);
          break;
        case 'stopped':
          this.updateStatus(PlaybackStatus.STOPPED);
          break;
        case 'playbackComplete':
          this.updateStatus(PlaybackStatus.COMPLETED);
          break;
        case 'error':
          this.updateStatus(PlaybackStatus.ERROR);
          if (this.errorCallback) {
            this.errorCallback(new Error(`Player error: ${reason}`));
          }
          break;
        default:
          Logger.warn(this.TAG, `Unknown player state: ${state}`);
          break;
      }
    });
    
    // é”™è¯¯ç›‘å¬
    this.avPlayer.on('error', (errorCode: number, errorMsg: string) => {
      Logger.error(this.TAG, `Player error: ${errorCode}, message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}` : new Error(String(message: ${errorMsg}` instanceof Error ? message: ${errorMsg}` : new Error(String(message: ${errorMsg}`)))))));
      this.updateStatus(PlaybackStatus.ERROR);
      if (this.errorCallback) {
        this.errorCallback(new Error(`Player error: ${errorMsg} (code: ${errorCode})`));
      }
    });
    
    // ç¼“å†²æ›´æ–°ç›‘å¬
    this.avPlayer.on('bufferingChange', (bufferingRate: number) => {
      Logger.info(this.TAG, `Buffering rate: ${bufferingRate}%`);
      if (this.bufferUpdateCallback) {
        this.bufferUpdateCallback(bufferingRate);
      }
    });
    
    // æ’­æ”¾å®Œæˆç›‘å¬
    this.avPlayer.on('playbackComplete', () => {
      Logger.info(this.TAG, 'Playback completed');
      this.updateStatus(PlaybackStatus.COMPLETED);
    });
    
    // æ—¶é—´æ›´æ–°ç›‘å¬
    this.avPlayer.on('timeUpdate', (currentTime: number) => {
      // å®æ—¶æ›´æ–°å½“å‰æ’­æ”¾æ—¶é—´
      Logger.debug(this.TAG, `Time updated: ${currentTime}ms`);
    });
  }
  
  /**
   * æ›´æ–°æ’­æ”¾çŠ¶æ€å¹¶è§¦å‘å›è°ƒ
   */
  private updateStatus(status: PlaybackStatus): void {
    this.currentStatus = status;
    if (this.statusChangeCallback) {
      this.statusChangeCallback(status);
    }
  }
}

/**
 * AVPlayerServiceå•ä¾‹
 */
export const AVPlayerServiceInstance: AVPlayerService = new AVPlayerServiceImpl();


