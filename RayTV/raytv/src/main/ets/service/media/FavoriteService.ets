import Logger from '../../common/util/Logger';
import { DatabaseManager } from '../../data/db/DatabaseManager';
import { MediaType } from './MediaService';
import { MediaItem } from '../../data/bean/MediaItem';
import { ValuesBucket, RdbPredicates as RelationalPredicates, ResultSet } from '@ohos.data.relationalStore';

/**
 * Êî∂ËóèÈ°πÊé•Âè? */
export interface FavoriteItem {
  id: string;           // Êî∂ËóèID
  mediaId: string;      // Â™í‰ΩìID
  siteKey: string;      // Á´ôÁÇπÊ†áËØÜ
  title: string;        // Ê†áÈ¢ò
  cover?: string;       // Â∞ÅÈù¢Âõ?  desc?: string;        // ÊèèËø∞
  type: MediaType;      // Â™í‰ΩìÁ±ªÂûã
  year?: string;        // Âπ¥‰ªΩ
  score?: number;       // ËØÑÂàÜ
  tags?: string[];      // Ê†áÁ≠æ
  favoriteTime: number; // Êî∂ËóèÊó∂Èó¥
  extra?: Record<string, unknown>; // ÂÖ∂‰ªñÈôÑÂä†‰ø°ÊÅØ
}

/**
 * Êî∂ËóèÊúçÂä°
 * ÂÆûÁé∞Â™í‰ΩìÊî∂ËóèÁöÑÊ∑ªÂä†„ÄÅÊü•ËØ¢„ÄÅÊõ¥Êñ∞ÂíåÂà†Èô§ÂäüËÉΩ
 */
export class FavoriteService {
  private readonly TAG: string = 'FavoriteService';
  private static instance: FavoriteService | null = null;
  private dbManager: DatabaseManager;
  private favoriteTable: string = 'media_favorites';

  /**
   * Ëé∑ÂèñÂçï‰æãÂÆû‰æã
   * @returns FavoriteService
   */
  public static getInstance(): FavoriteService {
    if (!FavoriteService.instance) {
      FavoriteService.instance = new FavoriteService();
    }
    return FavoriteService.instance;
  }

  /**
   * ÊûÑÈÄ†ÂáΩÊï?   * ÁßÅÊúâÊûÑÈÄ†ÂáΩÊï∞Èò≤Ê≠¢Â§ñÈÉ®ÂÆû‰æãÂåñ
   */
  private constructor() {
    this.dbManager = DatabaseManager.getInstance();
    this.initialize();
    Logger.info(this.TAG, 'FavoriteService initialized');
  }

  /**
   * ÂàùÂßãÂåñÊî∂ËóèÊúçÂä?   * @private
   */
  public async initialize(): Promise<void> {
    try {
      // ‰ΩøÁî®DatabaseManagerÂàõÂª∫Ë°®ÔºàË°®ÁªìÊûÑÂ∑≤Âú®DatabaseManager‰∏≠ÂÆö‰πâÔºâ
      // ËøôÈáåÂè™ËÆ∞ÂΩïÂàùÂßãÂåñÊó•Âøó
      Logger.info(this.TAG, 'FavoriteService initialized');
    } catch (error) {
      Logger.error(this.TAG, 'Failed to initialize favorite service', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
    }
  }

  /**
   * Ê∑ªÂä†Êî∂Ëóè
   * @param media Â™í‰Ωì‰ø°ÊÅØ
   * @returns Promise<FavoriteItem>
   */
  public async addFavorite(media: MediaItem): Promise<FavoriteItem> {
    try {
      const now = Date.now();
      const favoriteId = this.generateFavoriteId(media.siteKey, media.id);

      // ÊûÑÂª∫Êî∂ËóèÈ°?      const favoriteItem: FavoriteItem = {
        id: favoriteId,
        mediaId: media.id,
        siteKey: media.siteKey,
        title: media.title,
        cover: media.cover,
        desc: media.desc,
        type: media.type,
        year: media.year,
        score: media.score,
        tags: media.tags,
        favoriteTime: now,
        extra: media.extra || {}
      };

      try {
        const db = await this.dbManager.getDatabase();
        
        // ÂàõÂª∫ValuesBucketÂØπË±°
        const valuesBucket: ValuesBucket = {
          id: favoriteItem.id,
          mediaId: favoriteItem.mediaId,
          siteKey: favoriteItem.siteKey,
          title: favoriteItem.title,
          cover: favoriteItem.cover || '',
          desc: favoriteItem.desc || '',
          type: favoriteItem.type,
          year: favoriteItem.year || '',
          score: favoriteItem.score || 0,
          tags: favoriteItem.tags ? JSON.stringify(favoriteItem.tags) : '',
          favoriteTime: favoriteItem.favoriteTime,
          extra: JSON.stringify(favoriteItem.extra)
        };
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
        const predicates = new RelationalPredicates(this.favoriteTable);
        predicates.equalTo('mediaId', favoriteItem.mediaId);
        predicates.equalTo('siteKey', favoriteItem.siteKey);
        
        const resultSet = await db.query(this.favoriteTable, predicates);
        const exists = resultSet.rowCount > 0;
        resultSet.close();
        
        if (exists) {
          // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
          await db.update(this.favoriteTable, valuesBucket, predicates);
        } else {
          // ÊèíÂÖ•Êñ∞ËÆ∞ÂΩ?          await db.insert(this.favoriteTable, valuesBucket);
        }

        Logger.info(this.TAG, `Added favorite: ${media.siteKey}:${media.id}`);
        return favoriteItem;
      } catch (error) {
        Logger.error(this.TAG, 'Failed to insert favorite', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
        throw error;
      }
    } catch (error) {
      Logger.error(this.TAG, 'Failed to add favorite', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      throw new Error(`Failed to add favorite: ${error}`);
    }
  }

  /**
   * ÁßªÈô§Êî∂Ëóè
   * @param mediaId Â™í‰ΩìID
   * @param siteKey Á´ôÁÇπÊ†áËØÜ
   * @returns Promise<boolean>
   */
  public async removeFavorite(mediaId: string, siteKey: string): Promise<boolean> {
    try {
      const favoriteId = this.generateFavoriteId(siteKey, mediaId);
      
      const result = await this.dbManager.executeSql(
        `DELETE FROM ${this.favoriteTable} WHERE id = ?`,
        [favoriteId]
      );

      const success = result.affectedRows > 0;
      if (success) {
        Logger.info(this.TAG, `Removed favorite: ${siteKey}:${mediaId}`);
      }
      return success;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to remove favorite', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return false;
    }
  }

  /**
   * Ê£ÄÊü•ÊòØÂê¶Â∑≤Êî∂Ëóè
   * @param mediaId Â™í‰ΩìID
   * @param siteKey Á´ôÁÇπÊ†áËØÜ
   * @returns Promise<boolean>
   */
  public async isFavorite(mediaId: string, siteKey: string): Promise<boolean> {
    try {
      const favoriteId = this.generateFavoriteId(siteKey, mediaId);
      
      const result = await this.dbManager.executeSql(
        `SELECT 1 FROM ${this.favoriteTable} WHERE id = ?`,
        [favoriteId]
      );

      return (result.rows as Record<string, unknown>[]).length > 0;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to check favorite status', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return false;
    }
  }

  /**
   * Ëé∑ÂèñÊî∂ËóèÂàóË°®
   * @param params Êü•ËØ¢ÂèÇÊï∞
   * @returns Promise<FavoriteItem[]>
   */
  public async getFavoriteList(params: {
    type?: MediaType;
    page?: number;
    pageSize?: number;
    sortBy?: 'time' | 'score' | 'title';
    sortOrder?: 'asc' | 'desc';
  } = {}): Promise<FavoriteItem[]> {
    try {
      const {
        type,
        page = 1,
        pageSize = 20,
        sortBy = 'time',
        sortOrder = 'desc'
      } = params;
      
      const offset = (page - 1) * pageSize;

      // ÊûÑÂª∫Êü•ËØ¢Êù°‰ª∂
      let whereClause = '';
      const whereParams: Record<string, string | number | boolean | null>[] = [];
      
      if (type) {
        whereClause = 'WHERE type = ?';
        whereParams.push(type);
      }

      // ÊûÑÂª∫ÊéíÂ∫èÂ≠êÂè•
      let orderBy = 'favoriteTime';
      switch (sortBy) {
        case 'score':
          orderBy = 'score';
          break;
        case 'title':
          orderBy = 'title';
          break;
        default:
          orderBy = 'favoriteTime';
      }

      // ÊâßË°åÊü•ËØ¢
      const result = await this.dbManager.executeSql(
        `SELECT * FROM ${this.favoriteTable} 
         ${whereClause} 
         ORDER BY ${orderBy} ${sortOrder.toUpperCase()} 
         LIMIT ? OFFSET ?`,
        [...whereParams, pageSize, offset]
      );

      // Ëß£ÊûêÁªìÊûú
      return this.parseFavoriteRows(result.rows as Record<string, unknown>[]);
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get favorite list', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return [];
    }
  }

  /**
   * Ê†πÊçÆIDËé∑ÂèñÊî∂ËóèÈ°?   * @param mediaId Â™í‰ΩìID
   * @param siteKey Á´ôÁÇπÊ†áËØÜ
   * @returns Promise<FavoriteItem | null>
   */
  public async getFavoriteById(mediaId: string, siteKey: string): Promise<FavoriteItem | null> {
    try {
      const favoriteId = this.generateFavoriteId(siteKey, mediaId);
      
      const result = await this.dbManager.executeSql(
        `SELECT * FROM ${this.favoriteTable} WHERE id = ?`,
        [favoriteId]
      );

      const rows = result.rows as Record<string, unknown>[];
      if (rows.length > 0) {
        return this.parseFavoriteRow(rows[0]);
      }
      return null;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get favorite by id', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return null;
    }
  }

  /**
   * Êõ¥Êñ∞Êî∂Ëóè‰ø°ÊÅØ
   * @param mediaId Â™í‰ΩìID
   * @param siteKey Á´ôÁÇπÊ†áËØÜ
   * @param updateData Êõ¥Êñ∞Êï∞ÊçÆ
   * @returns Promise<boolean>
   */
  public async updateFavorite(
    mediaId: string,
    siteKey: string,
    updateData: Partial<Omit<FavoriteItem, 'id' | 'mediaId' | 'siteKey' | 'favoriteTime'>>
  ): Promise<boolean> {
    try {
      const favoriteId = this.generateFavoriteId(siteKey, mediaId);
      
      // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú?      const exists = await this.isFavorite(mediaId, siteKey);
      if (!exists) {
        return false;
      }

      // ÊûÑÂª∫Êõ¥Êñ∞ËØ≠Âè•
      const fields: string[] = [];
      const values: Record<string, string | number | boolean | null>[] = [];

      if (updateData.title !== undefined) {
        fields.push('title = ?');
        values.push(updateData.title);
      }
      if (updateData.cover !== undefined) {
        fields.push('cover = ?');
        values.push(updateData.cover || '');
      }
      if (updateData.desc !== undefined) {
        fields.push('desc = ?');
        values.push(updateData.desc || '');
      }
      if (updateData.type !== undefined) {
        fields.push('type = ?');
        values.push(updateData.type);
      }
      if (updateData.year !== undefined) {
        fields.push('year = ?');
        values.push(updateData.year || '');
      }
      if (updateData.score !== undefined) {
        fields.push('score = ?');
        values.push(updateData.score || 0);
      }
      if (updateData.tags !== undefined) {
        fields.push('tags = ?');
        values.push(updateData.tags ? JSON.stringify(updateData.tags) : '');
      }
      if (updateData.extra !== undefined) {
        fields.push('extra = ?');
        values.push(JSON.stringify(updateData.extra || {}));
      }

      if (fields.length === 0) {
        return true; // Ê≤°ÊúâÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÂ≠óÊÆµ
      }

      // ÊâßË°åÊõ¥Êñ∞
      const result = await this.dbManager.executeSql(
        `UPDATE ${this.favoriteTable} 
         SET ${fields.join(', ')} 
         WHERE id = ?`,
        [...values, favoriteId]
      );

      const success = result.affectedRows > 0;
      if (success) {
        Logger.info(this.TAG, `Updated favorite: ${siteKey}:${mediaId}`);
      }
      return success;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to update favorite', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return false;
    }
  }

  /**
   * Ëé∑ÂèñÊî∂ËóèÊï∞Èáè
   * @param type Â™í‰ΩìÁ±ªÂûãÔºàÂèØÈÄâÔºâ
   * @returns Promise<number>
   */
  public async getFavoriteCount(type?: MediaType): Promise<number> {
    try {
      let query = `SELECT COUNT(*) as count FROM ${this.favoriteTable}`;
      const params: Record<string, string | number | boolean | null>[] = [];

      if (type) {
        query += ' WHERE type = ?';
        params.push(type);
      }

      const result = await this.dbManager.executeSql(query, params);
      return ((result.rows as Record<string, unknown>[])[0] as Record<string, unknown>).count as number || 0;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get favorite count', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return 0;
    }
  }

  /**
   * Ê∏ÖÁ©∫ÊâÄÊúâÊî∂Ëó?   * @returns Promise<boolean>
   */
  public async clearAllFavorites(): Promise<boolean> {
    try {
      await this.dbManager.executeSql(`DELETE FROM ${this.favoriteTable}`);
      Logger.info(this.TAG, 'Cleared all favorites');
      return true;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to clear all favorites', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return false;
    }
  }

  /**
   * Ê∏ÖÁ©∫ÊåáÂÆöÁ±ªÂûãÁöÑÊî∂Ëó?   * @param type Â™í‰ΩìÁ±ªÂûã
   * @returns Promise<boolean>
   */
  public async clearFavoritesByType(type: MediaType): Promise<boolean> {
    try {
      await this.dbManager.executeSql(
        `DELETE FROM ${this.favoriteTable} WHERE type = ?`,
        [type]
      );
      Logger.info(this.TAG, `Cleared favorites for type: ${type}`);
      return true;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to clear favorites by type', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return false;
    }
  }

  /**
   * ÊâπÈáèÊ∑ªÂä†Êî∂Ëóè
   * @param mediaList Â™í‰ΩìÂàóË°®
   * @returns Promise<number> ÊàêÂäüÊ∑ªÂä†ÁöÑÊï∞Èá?   */
  public async batchAddFavorites(mediaList: MediaItem[]): Promise<number> {
    let successCount = 0;

    for (const media of mediaList) {
      try {
        await this.addFavorite(media);
        successCount++;
      } catch (error) {
        Logger.warn(this.TAG, `Failed to add favorite: ${media.siteKey}:${media.id}, error: ${error}`);
      }
    }

    return successCount;
  }

  /**
   * ÊâπÈáèÁßªÈô§Êî∂Ëóè
   * @param favorites Êî∂Ëóè‰ø°ÊÅØÂàóË°®
   * @returns Promise<number> ÊàêÂäüÁßªÈô§ÁöÑÊï∞Èá?   */
  public async batchRemoveFavorites(
    favorites: Array<{ mediaId: string; siteKey: string }>
  ): Promise<number> {
    let successCount = 0;

    for (const fav of favorites) {
      try {
        const success = await this.removeFavorite(fav.mediaId, fav.siteKey);
        if (success) {
          successCount++;
        }
      } catch (error) {
        Logger.warn(this.TAG, `Failed to remove favorite: ${fav.siteKey}:${fav.mediaId}, error: ${error}`);
      }
    }

    return successCount;
  }

  /**
   * ÊêúÁ¥¢Êî∂Ëóè
   * @param keyword ÊêúÁ¥¢ÂÖ≥ÈîÆËØ?   * @param type Â™í‰ΩìÁ±ªÂûãÔºàÂèØÈÄâÔºâ
   * @returns Promise<FavoriteItem[]>
   */
  public async searchFavorites(keyword: string, type?: MediaType): Promise<FavoriteItem[]> {
    try {
      let whereClause = 'WHERE title LIKE ?';
      const params: Record<string, string | number | boolean | null>[] = [`%${keyword}%`];

      if (type) {
        whereClause += ' AND type = ?';
        params.push(type);
      }

      const result = await this.dbManager.executeSql(
        `SELECT * FROM ${this.favoriteTable} 
         ${whereClause} 
         ORDER BY favoriteTime DESC`,
        params
      );

      return this.parseFavoriteRows(result.rows as Record<string, unknown>[]);
    } catch (error) {
      Logger.error(this.TAG, 'Failed to search favorites', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return [];
    }
  }

  /**
   * ÁîüÊàêÊî∂ËóèID
   * @param siteKey Á´ôÁÇπÊ†áËØÜ
   * @param mediaId Â™í‰ΩìID
   * @returns string
   * @private
   */
  private generateFavoriteId(siteKey: string, mediaId: string): string {
    return `${siteKey}:${mediaId}`;
  }

  /**
   * Ëß£ÊûêÊï∞ÊçÆÂ∫ìË°åÂà∞Êî∂ËóèÈ°π
   * @param row Êï∞ÊçÆÂ∫ìË°å
   * @returns FavoriteItem
   * @private
   */
  private parseFavoriteRow(row: Record<string, unknown>): FavoriteItem {
    return {
      id: row.id,
      mediaId: row.mediaId,
      siteKey: row.siteKey,
      title: row.title,
      cover: row.cover || undefined,
      desc: row.desc || undefined,
      type: row.type,
      year: row.year || undefined,
      score: row.score || undefined,
      tags: row.tags ? JSON.parse(row.tags) : undefined,
      favoriteTime: row.favoriteTime,
      extra: row.extra ? JSON.parse(row.extra) : {}
    };
  }

  /**
   * Ëß£ÊûêÂ§öË°åÊï∞ÊçÆÂ∫ìËÆ∞ÂΩ?   * @param rows Êï∞ÊçÆÂ∫ìË°åÊï∞ÁªÑ
   * @returns FavoriteItem[]
   * @private
   */
  private parseFavoriteRows(rows: Record<string, unknown>[]): FavoriteItem[] {
    return rows.map(row => this.parseFavoriteRow(row));
  }
}

// ÂØºÂá∫Êî∂ËóèÊúçÂä°Âçï‰æã
export const favoriteService = FavoriteService.getInstance();


