// MediaService.ets - åª’ä½“æœåŠ¡
// è´Ÿè´£è§†é¢‘å†…å®¹ç®¡ç†ã€æ’­æ”¾çŠ¶æ€åŒæ­¥å’Œå¤šè®¾å¤‡åª’ä½“æ§åˆ¶ï¼Œæ•´åˆäº†ä¸šåŠ¡é€»è¾‘å±‚åª’ä½“æœåŠ¡åŠŸèƒ?

import Logger from '../../common/util/Logger';
import ConfigService from '../../service/config/ConfigService';
import ModernDistributedDataService from '../sync/ModernDistributedDataService';
import DeviceManager from '../device/DeviceManager';
import PlayerService from '../player/PlayerService';
import { SyncDataType } from '../sync/ModernDistributedDataService';
import { Vod, Episode, VodCategory, VodTag } from '../../data/bean/Vod';
import { LiveChannel, LiveGroup, EpgItem } from '../../data/bean/Live';
import { VodRepository } from '../../data/repository/VodRepository';
import { LiveRepository } from '../../data/repository/LiveRepository';
import { HistoryRepository } from '../../data/repository/HistoryRepository';
import { CollectionRepository } from '../../data/repository/CollectionRepository';
import DeviceService from '../../service/device/DeviceService';
import HttpService from '../HttpService';
import { TypeSafetyUtil } from '../../common/util/TypeSafetyUtil';

// å¸¸é‡å®šä¹‰
const TAG = 'MediaService';

// åª’ä½“ç±»å‹æšä¸¾ - æ•´åˆä¸šåŠ¡å±‚å’ŒæœåŠ¡å±‚çš„åª’ä½“ç±»å‹å®šä¹‰
export enum MediaType {
  // æœåŠ¡å±‚åª’ä½“ç±»å?
  MOVIE = 'movie',
  TV_SERIES = 'tv_series',
  LIVE = 'live',
  ANIME = 'anime',
  DOCUMENTARY = 'documentary',
  VARIETY = 'variety',
  SPORTS = 'sports',
  OTHER = 'other',
  
  // ä¸šåŠ¡å±‚åª’ä½“ç±»å‹åˆ«å?
  VOD = 'vod',
  EPISODE = 'episode'
}

// åª’ä½“å…ƒæ•°æ®æ¥å?
export interface MediaMetadata {
  id: string;               // åª’ä½“å”¯ä¸€æ ‡è¯†
  title: string;            // æ ‡é¢˜
  subtitle?: string;        // å‰¯æ ‡é¢?
  description?: string;     // æè¿°
  coverUrl?: string;        // å°é¢å›¾ç‰‡URL
  bannerUrl?: string;       // æ¨ªå¹…å›¾ç‰‡URL
  type: MediaType;          // åª’ä½“ç±»å‹
  category?: string[];      // åˆ†ç±»æ ‡ç­¾
  tags?: string[];          // æ ‡ç­¾
  year?: number;            // å¹´ä»½
  duration?: number;        // æ—¶é•¿ï¼ˆç§’ï¼?
  episodeCount?: number;    // é›†æ•°ï¼ˆç”µè§†å‰§ï¼?
  director?: string[];      // å¯¼æ¼”
  actors?: string[];        // æ¼”å‘˜
  rating?: number;          // è¯„åˆ†
  region?: string[];        // åœ°åŒº
  language?: string[];      // è¯­è¨€
  releaseDate?: string;     // å‘å¸ƒæ—¥æœŸ
  updateStatus?: string;    // æ›´æ–°çŠ¶æ€?
  isFavorite?: boolean;     // æ˜¯å¦æ”¶è—
  isWatchLater?: boolean;   // æ˜¯å¦ç¨åè§‚çœ‹
  sourceSite?: string;      // æ¥æºç«™ç‚¹
  sourceUrl?: string;       // æ¥æºURL
  createTime: number;       // åˆ›å»ºæ—¶é—´
  updateTime: number;       // æ›´æ–°æ—¶é—´
}

// æ’­æ”¾è®°å½•æ¥å£ - æ•´åˆæœåŠ¡å±‚å’Œä¸šåŠ¡å±‚çš„æ’­æ”¾è®°å½•å®šä¹‰
export interface PlaybackRecord {
  mediaId: string;          // åª’ä½“ID
  episodeId?: string;       // å‰§é›†ID
  position: number;         // æ’­æ”¾ä½ç½®ï¼ˆç§’ï¼?
  lastPlayTime: number;     // æœ€åæ’­æ”¾æ—¶é—?
  playCount: number;        // æ’­æ”¾æ¬¡æ•°
  isFinished: boolean;      // æ˜¯å¦å·²æ’­æ”¾å®Œæˆ?
  deviceId?: string;        // æœ€åæ’­æ”¾è®¾å¤‡ID
  totalDuration?: number;   // æ€»æ—¶é•¿ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
  title?: string;           // æ ‡é¢˜ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
  coverUrl?: string;        // å°é¢URLï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
  currentEpisode?: string;  // å½“å‰å‰§é›†ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
  progress?: number;        // è¿›åº¦ç™¾åˆ†æ¯?0-100ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
}

// åª’ä½“æ’­æ”¾è¿›åº¦æ¥å£
export interface PlaybackProgress {
  mediaId: string;          // åª’ä½“ID
  episodeId?: string;       // å‰§é›†ID
  position: number;         // æ’­æ”¾ä½ç½®ï¼ˆç§’ï¼?
  timestamp: number;        // æ—¶é—´æˆ?
  deviceId: string;         // è®¾å¤‡ID
  deviceName: string;       // è®¾å¤‡åç§°
  isPlaying: boolean;       // æ˜¯å¦æ­£åœ¨æ’­æ”¾
}

// åª’ä½“é›†åˆæ¥å£
export interface MediaCollection {
  id: string;               // é›†åˆID
  name: string;             // é›†åˆåç§°
  description?: string;     // é›†åˆæè¿°
  coverUrl?: string;        // é›†åˆå°é¢
  mediaIds: string[];       // åª’ä½“IDåˆ—è¡¨
  createTime: number;       // åˆ›å»ºæ—¶é—´
  updateTime: number;       // æ›´æ–°æ—¶é—´
}

// åª’ä½“æœåŠ¡é…ç½®æ¥å£
export interface MediaServiceConfig {
  enableCrossDevicePlayback: boolean;  // å¯ç”¨è·¨è®¾å¤‡æ’­æ”?
  syncPlaybackProgress: boolean;       // åŒæ­¥æ’­æ”¾è¿›åº¦
  autoResumePlayback: boolean;         // è‡ªåŠ¨æ¢å¤æ’­æ”¾
  maxPlaybackHistory: number;          // æœ€å¤§æ’­æ”¾å†å²æ•°é‡?
  enableRecommendations: boolean;      // å¯ç”¨æ¨è
}

// é»˜è®¤åª’ä½“æœåŠ¡é…ç½®
export const DEFAULT_MEDIA_SERVICE_CONFIG: MediaServiceConfig = {
  enableCrossDevicePlayback: true,
  syncPlaybackProgress: true,
  autoResumePlayback: true,
  maxPlaybackHistory: 100,
  enableRecommendations: true
};

// åª’ä½“äº‹ä»¶æšä¸¾
export enum MediaEvent {
  PLAYBACK_STARTED = 'playback_started',
  PLAYBACK_PAUSED = 'playback_paused',
  PLAYBACK_RESUMED = 'playback_resumed',
  PLAYBACK_STOPPED = 'playback_stopped',
  PLAYBACK_COMPLETED = 'playback_completed',
  PLAYBACK_PROGRESS_CHANGED = 'playback_progress_changed',
  PLAYBACK_DEVICE_CHANGED = 'playback_device_changed',
  MEDIA_ADDED = 'media_added',
  MEDIA_UPDATED = 'media_updated',
  MEDIA_DELETED = 'media_deleted',
  COLLECTION_CREATED = 'collection_created',
  COLLECTION_UPDATED = 'collection_updated',
  COLLECTION_DELETED = 'collection_deleted'
}

// åª’ä½“äº‹ä»¶ç›‘å¬å›è°ƒç±»å‹
type MediaEventListener = (event: MediaEvent, data: MediaMetadata | PlaybackRecord | MediaCollection | PlaybackProgress) => void;

// æ’­æ”¾é€‰é¡¹æ¥å£ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
export interface PlayOptions {
  autoPlay?: boolean;
  startPosition?: number;
  selectedEpisode?: string;
  audioTrack?: string;
  subtitleTrack?: string;
  playbackRate?: number;
  volume?: number;
  muted?: boolean;
  quality?: string;
}

// æœç´¢ç»“æœæ¥å£ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
export interface SearchResult {
  vodItems: Vod[];
  totalCount: number;
  page: number;
  pageSize: number;
  hasMore: boolean;
}

// æ¨èå†…å®¹æ¥å£ï¼ˆä¸šåŠ¡å±‚éœ€è¦ï¼‰
export interface RecommendationResult {
  featured: Vod[];
  recentlyAdded: Vod[];
  popular: Vod[];
  continueWatching: PlaybackRecord[];
  related: Vod[];
}

export default class MediaService {
  private static instance: MediaService;
  // æœåŠ¡å±‚ä¾èµ?
  private configService: ConfigService;
  private distributedDataService: ModernDistributedDataService;
  private deviceManager: DeviceManager;
  private playerService: PlayerService;
  
  // ä¸šåŠ¡å±‚ä¾èµ?
  private vodRepository: VodRepository;
  private liveRepository: LiveRepository;
  private historyRepository: HistoryRepository;
  private collectionRepository: CollectionRepository;
  private deviceService: DeviceService;
  private httpService: HttpService;
  
  // æœåŠ¡å±‚çŠ¶æ€?
  private config: MediaServiceConfig = DEFAULT_MEDIA_SERVICE_CONFIG;
  private mediaMetadataCache: Map<string, MediaMetadata> = new Map();
  private playbackRecords: Map<string, PlaybackRecord> = new Map();
  private collections: Map<string, MediaCollection> = new Map();
  private currentPlaybackProgress: PlaybackProgress | null = null;
  private eventListeners: Record<MediaEvent, MediaEventListener[]> = {
    [MediaEvent.PLAYBACK_STARTED]: [],
    [MediaEvent.PLAYBACK_PAUSED]: [],
    [MediaEvent.PLAYBACK_RESUMED]: [],
    [MediaEvent.PLAYBACK_STOPPED]: [],
    [MediaEvent.PLAYBACK_PROGRESS_CHANGED]: [],
    [MediaEvent.PLAYBACK_DEVICE_CHANGED]: [],
    [MediaEvent.MEDIA_ADDED]: [],
    [MediaEvent.MEDIA_UPDATED]: [],
    [MediaEvent.MEDIA_DELETED]: [],
    [MediaEvent.COLLECTION_CREATED]: [],
    [MediaEvent.COLLECTION_UPDATED]: [],
    [MediaEvent.COLLECTION_DELETED]: []
  };
  private progressSyncInterval: number | null = null;
  private isInitialized: boolean = false;
  
  // ä¸šåŠ¡å±‚çŠ¶æ€?
  private currentPlayingMedia: { id: string; type: MediaType } | null = null;
  private playListeners: Array<(media: { id: string; type: MediaType }) => void> = [];

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): MediaService {
    if (!MediaService.instance) {
      MediaService.instance = new MediaService();
    }
    return MediaService.instance;
  }

  /**
   * æ„é€ å‡½æ•?
   */
  private constructor() {
    // åˆå§‹åŒ–æœåŠ¡å±‚ä¾èµ–
    this.configService = ConfigService.getInstance();
    this.distributedDataService = ModernDistributedDataService.getInstance();
    this.deviceManager = DeviceManager.getInstance();
    this.playerService = PlayerService.getInstance();
    
    // åˆå§‹åŒ–ä¸šåŠ¡å±‚ä¾èµ–
    this.vodRepository = VodRepository.getInstance();
    this.liveRepository = LiveRepository.getInstance();
    this.historyRepository = HistoryRepository.getInstance();
    this.collectionRepository = CollectionRepository.getInstance();
    this.deviceService = DeviceService.getInstance();
    this.httpService = HttpService.getInstance();
    
    // åˆå§‹åŒ?
    this.initialize();
  }

  /**
   * åˆå§‹åŒ–åª’ä½“æœåŠ?
   */
  public async initialize(): Promise<void> {
    if (this.isInitialized) {
      return;
    }
    
    try {
      // åŠ è½½é…ç½®
      await this.loadConfig();
      
      // åŠ è½½æ’­æ”¾è®°å½•
      await this.loadPlaybackRecords();
      
      // åŠ è½½åª’ä½“é›†åˆ
      await this.loadCollections();
      
      // æ³¨å†Œäº‹ä»¶ç›‘å¬
      this.registerPlayerEvents();
      this.registerDistributedDataListeners();
      
      // åˆå§‹åŒ–ä¸šåŠ¡å±‚
      await this.initializeBusinessLayer();
      
      this.isInitialized = true;
      Logger.info(TAG, 'Media service initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize media service: ${error}`);
    }
  }

  /**
   * åˆå§‹åŒ–ä¸šåŠ¡é€»è¾‘å±?
   */
  private async initializeBusinessLayer(): Promise<void> {
    try {
      Logger.info(TAG, 'Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...' : new Error(String('Initializing business layer...' instanceof Error ? 'Initializing business layer...' : new Error(String('Initializing business layer...')))))));
      
      // é¢„åŠ è½½å¸¸ç”¨æ•°æ?
      await this.preloadCommonData();
      
      Logger.info(TAG, 'Business layer initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize business layer: ${JSON.stringify(error)}`);
    }
  }
  
  /**
   * é¢„åŠ è½½å¸¸ç”¨æ•°æ?
   */
  private async preloadCommonData(): Promise<void> {
    try {
      // é¢„åŠ è½½çƒ­é—¨ç‚¹æ’­å†…å®?
      await this.vodRepository.preloadPopularVods();
      
      // é¢„åŠ è½½ç›´æ’­é¢‘é“åˆ—è¡?
      await this.liveRepository.preloadLiveGroups();
    } catch (error) {
      Logger.warn(TAG, `Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error instanceof Error ? `Failed to preload common data: ${JSON.stringify(error : new Error(String(`Failed to preload common data: ${JSON.stringify(error)))))))}`);
    }
  }
  
  /**
   * è·å–ç‚¹æ’­å†…å®¹è¯¦æƒ…
   */
  public async getVodDetail(vodId: string): Promise<Vod | null> {
    try {
      const vod = await this.vodRepository.getVodById(vodId);
      if (vod) {
        // è®°å½•è®¿é—®
        await this.vodRepository.incrementVodViewCount(vodId);
        
        // é¢„åŠ è½½ç›¸å…³ä¿¡æ?
        await this.preloadVodRelatedContent(vodId);
      }
      return vod;
    } catch (error) {
      Logger.error(TAG, `Failed to get VOD detail for ID: ${vodId}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return null;
    }
  }
  
  /**
   * è·å–ç›´æ’­é¢‘é“è¯¦æƒ…
   */
  public async getLiveChannelDetail(channelId: string): Promise<LiveChannel | null> {
    try {
      const channel = await this.liveRepository.getChannelById(channelId);
      if (channel) {
        // è®°å½•è®¿é—®
        await this.liveRepository.incrementChannelViewCount(channelId);
      }
      return channel;
    } catch (error) {
      Logger.error(TAG, `Failed to get live channel detail for ID: ${channelId}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return null;
    }
  }

  /**
   * æ’­æ”¾åª’ä½“
   */
  public async playMedia(mediaId: string, type: MediaType, options: PlayOptions = {}): Promise<boolean> {
    try {
      Logger.info(TAG, `Playing media: ${mediaId}, type: ${type}`);
      
      // æ›´æ–°å½“å‰æ’­æ”¾çš„åª’ä½?
      this.currentPlayingMedia = { id: mediaId, type };
      
      // é€šçŸ¥ç›‘å¬å™?
      for (const listener of this.playListeners) {
        listener(this.currentPlayingMedia);
      }
      
      // è°ƒç”¨æ’­æ”¾å™¨æœåŠ¡è¿›è¡Œå®é™…æ’­æ”?
      const success = await this.playerService.play(mediaId, type, options);
      
      if (success) {
        // è®°å½•æ’­æ”¾å¼€å§‹äº‹ä»?
        this.notifyEvent(MediaEvent.PLAYBACK_STARTED, {
          mediaId,
          episodeId: options.selectedEpisode,
          position: options.startPosition || 0,
          lastPlayTime: Date.now(),
          playCount: 1
        } as PlaybackRecord);
      }
      
      return success;
    } catch (error) {
      Logger.error(TAG, `Failed to play media ${mediaId}: ${error}`);
      return false;
    }
  }

  /**
   * æ·»åŠ æ’­æ”¾ç›‘å¬å™?
   */
  public addPlayListener(listener: (media: { id: string; type: MediaType }) => void): void {
    this.playListeners.push(listener);
  }
  
  /**
   * ç§»é™¤æ’­æ”¾ç›‘å¬å™?
   */
  public removePlayListener(listener: (media: { id: string; type: MediaType }) => void): void {
    const index = this.playListeners.indexOf(listener);
    if (index > -1) {
      this.playListeners.splice(index, 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1)))))));
    }
  }
  
  /**
   * è·å–å½“å‰æ’­æ”¾çš„åª’ä½?
   */
  public getCurrentPlayingMedia(): { id: string; type: MediaType } | null {
    return this.currentPlayingMedia;
  }
  
  /**
   * åœæ­¢æ’­æ”¾
   */
  public stopPlayback(): void {
    this.currentPlayingMedia = null;
    // å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨playerServiceåœæ­¢æ’­æ”¾
  }

  /**
   * åŠ è½½é…ç½®
   */
  private async loadConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig<unknown>('mediaServiceConfig', DEFAULT_MEDIA_SERVICE_CONFIG);
      if (savedConfig && TypeSafetyUtil.isObject(savedConfig)) {
        this.config = {
          ...DEFAULT_MEDIA_SERVICE_CONFIG,
          enableCrossDevicePlayback: TypeSafetyUtil.getProperty(savedConfig, 'enableCrossDevicePlayback', true),
          syncPlaybackProgress: TypeSafetyUtil.getProperty(savedConfig, 'syncPlaybackProgress', true),
          autoResumePlayback: TypeSafetyUtil.getProperty(savedConfig, 'autoResumePlayback', true),
          maxPlaybackHistory: TypeSafetyUtil.getProperty(savedConfig, 'maxPlaybackHistory', 100),
          enableRecommendations: TypeSafetyUtil.getProperty(savedConfig, 'enableRecommendations', true)
        };
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load media service config: ${error}`);
    }
  }

  /**
   * ä¿å­˜é…ç½®
   */
  public async saveConfig(config: Partial<MediaServiceConfig>): Promise<void> {
    try {
      this.config = { ...this.config, ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('mediaServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('mediaServiceConfig', this.config)))))));
      
      // æ ¹æ®é…ç½®è°ƒæ•´è¿›åº¦åŒæ­¥
      if (this.config.syncPlaybackProgress) {
        this.startProgressSync();
      } else {
        this.stopProgressSync();
      }
    } catch (error) {
      Logger.error(TAG, `Failed to save media service config: ${error}`);
      throw error;
    }
  }

  /**
   * åŠ è½½æ’­æ”¾è®°å½•
   */
  private async loadPlaybackRecords(): Promise<void> {
    try {
      const records = await this.configService.getConfig<Record<string, unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {} instanceof Error ? unknown>>('playbackRecords', {} : new Error(String(unknown>>('playbackRecords', {})))))));
      
      if (records && TypeSafetyUtil.isObject(records)) {
        Object.entries(records).forEach(([key, value]) => {
          if (TypeSafetyUtil.isObject(value)) {
            const record: PlaybackRecord = {
              mediaId: TypeSafetyUtil.getProperty(value, 'mediaId', ''),
              episodeId: TypeSafetyUtil.getProperty(value, 'episodeId', undefined),
              position: TypeSafetyUtil.getProperty(value, 'position', 0),
              lastPlayTime: TypeSafetyUtil.getProperty(value, 'lastPlayTime', 0),
              playCount: TypeSafetyUtil.getProperty(value, 'playCount', 0),
              deviceId: TypeSafetyUtil.getProperty(value, 'deviceId', undefined),
              totalDuration: TypeSafetyUtil.getProperty(value, 'totalDuration', undefined),
              title: TypeSafetyUtil.getProperty(value, 'title', undefined),
              coverUrl: TypeSafetyUtil.getProperty(value, 'coverUrl', undefined),
              currentEpisode: TypeSafetyUtil.getProperty(value, 'currentEpisode', undefined),
              progress: TypeSafetyUtil.getProperty(value, 'progress', undefined),
              isFinished: TypeSafetyUtil.getProperty(value, 'isFinished', false)
            };
            this.playbackRecords.set(key, record);
          }
        });
      }
      
      Logger.info(TAG, `Loaded ${this.playbackRecords.size} playback records`);
    } catch (error) {
      Logger.error(TAG, `Failed to load playback records: ${error}`);
    }
  }

  /**
   * ä¿å­˜æ’­æ”¾è®°å½•
   */
  private async savePlaybackRecords(): Promise<void> {
    try {
      const recordsObj: Record<string, PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key instanceof Error ? PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key : new Error(String(PlaybackRecord> = {};
      this.playbackRecords.forEach((record, key))))))) => {
        recordsObj[key] = record;
      });
      await this.configService.setConfig('playbackRecords', recordsObj);
    } catch (error) {
      Logger.error(TAG, `Failed to save playback records: ${error}`);
    }
  }

  /**
   * åŠ è½½åª’ä½“é›†åˆ
   */
  private async loadCollections(): Promise<void> {
    try {
      const collections = await this.configService.getConfig<Record<string, unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {} instanceof Error ? unknown>>('mediaCollections', {} : new Error(String(unknown>>('mediaCollections', {})))))));
      
      if (collections && TypeSafetyUtil.isObject(collections)) {
        Object.entries(collections).forEach(([key, value]) => {
          if (TypeSafetyUtil.isObject(value)) {
            const collection: MediaCollection = {
              id: TypeSafetyUtil.getProperty(value, 'id', ''),
              name: TypeSafetyUtil.getProperty(value, 'name', ''),
              description: TypeSafetyUtil.getProperty(value, 'description', undefined),
              coverUrl: TypeSafetyUtil.getProperty(value, 'coverUrl', undefined),
              mediaIds: TypeSafetyUtil.getArray(value, 'mediaIds', []),
              createTime: TypeSafetyUtil.getProperty(value, 'createTime', 0),
              updateTime: TypeSafetyUtil.getProperty(value, 'updateTime', 0)
            };
            this.collections.set(key, collection);
          }
        });
      }
      Logger.info(TAG, `Loaded ${this.collections.size} media collections`);
    } catch (error) {
      Logger.error(TAG, `Failed to load media collections: ${error}`);
    }
  }

  /**
   * ä¿å­˜åª’ä½“é›†åˆ
   */
  private async saveCollections(): Promise<void> {
    try {
      const collectionsObj: Record<string, MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key instanceof Error ? MediaCollection> = {};
      this.collections.forEach((collection, key : new Error(String(MediaCollection> = {};
      this.collections.forEach((collection, key))))))) => {
        collectionsObj[key] = collection;
      });
      await this.configService.setConfig('mediaCollections', collectionsObj);
    } catch (error) {
      Logger.error(TAG, `Failed to save media collections: ${error}`);
    }
  }

  /**
   * æ³¨å†Œæ’­æ”¾å™¨äº‹ä»¶ç›‘å?
   */
  private registerPlayerEvents(): void {
    // è¿™é‡Œåº”è¯¥æ³¨å†ŒPlayerServiceçš„äº‹ä»¶ç›‘å?
    // ä¾‹å¦‚æ’­æ”¾å¼€å§‹ã€æš‚åœã€åœæ­¢ã€è¿›åº¦å˜åŒ–ç­‰
    // ç”±äºPlayerServiceçš„å…·ä½“å®ç°å¯èƒ½å°šæœªå®Œæˆï¼Œè¿™é‡Œå…ˆä¿ç•™æ¥å?
    Logger.debug(TAG, 'Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered' : new Error(String('Player events registered' instanceof Error ? 'Player events registered' : new Error(String('Player events registered')))))));
  }

  /**
   * æ³¨å†Œåˆ†å¸ƒå¼æ•°æ®ç›‘å?
   */
  private registerDistributedDataListeners(): void {
    // ç›‘å¬æ’­æ”¾è¿›åº¦åŒæ­¥
    this.distributedDataService.addDataChangeListener<PlaybackProgress>(
      SyncDataType.PLAYBACK_PROGRESS,
      (key, data, deviceId) => {
        if (data && data.deviceId !== this.deviceManager.getLocalDeviceId()) {
          // æ¥æ”¶åˆ°å…¶ä»–è®¾å¤‡çš„æ’­æ”¾è¿›åº¦
          this.handleRemotePlaybackProgress(data);
        }
      }
    );
  }

  /**
   * å¤„ç†è¿œç¨‹æ’­æ”¾è¿›åº¦
   */
  private handleRemotePlaybackProgress(progress: PlaybackProgress): void {
    // å¤„ç†æ¥è‡ªå…¶ä»–è®¾å¤‡çš„æ’­æ”¾è¿›åº¦åŒæ­?
    Logger.debug(TAG, `Received remote playback progress from device ${progress.deviceId}`);
    
    // æ›´æ–°å½“å‰æ’­æ”¾è¿›åº¦
    this.currentPlaybackProgress = progress;
    
    // é€šçŸ¥äº‹ä»¶ç›‘å¬å™?
    this.notifyEvent(MediaEvent.PLAYBACK_PROGRESS_CHANGED, progress);
  }

  /**
   * å¼€å§‹è¿›åº¦åŒæ­?
   */
  private startProgressSync(): void {
    if (this.progressSyncInterval) {
      this.stopProgressSync();
    }
    
    // æ¯?ç§’åŒæ­¥ä¸€æ¬¡è¿›åº?
    this.progressSyncInterval = setInterval(async () => {
      await this.syncPlaybackProgress();
    }, 5000);
  }

  /**
   * åœæ­¢è¿›åº¦åŒæ­¥
   */
  private stopProgressSync(): void {
    if (this.progressSyncInterval) {
      clearInterval(this.progressSyncInterval);
      this.progressSyncInterval = null;
    }
  }

  /**
   * åŒæ­¥æ’­æ”¾è¿›åº¦
   */
  private async syncPlaybackProgress(): Promise<void> {
    if (!this.currentPlaybackProgress) {
      return;
    }
    
    try {
      const key = `playback_progress_${this.currentPlaybackProgress.mediaId}`;
      await this.distributedDataService.syncData(
        SyncDataType.PLAYBACK_PROGRESS,
        key,
        this.currentPlaybackProgress
      );
    } catch (error) {
      Logger.error(TAG, `Failed to sync playback progress: ${error}`);
    }
  }

  /**
   * é¢„åŠ è½½ç›¸å…³å†…å®?
   */
  private async preloadVodRelatedContent(vodId: string): Promise<void> {
    try {
      // é¢„åŠ è½½ç›¸å…³è§†é¢?
      await this.vodRepository.preloadRelatedVods(vodId);
    } catch (error) {
      Logger.warn(TAG, `Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}` instanceof Error ? `Failed to preload related content for VOD ${vodId}: ${error}` : new Error(String(`Failed to preload related content for VOD ${vodId}: ${error}`)))))));
    }
  }

  /**
   * è·å–åª’ä½“å…ƒæ•°æ?
   */
  public async getMediaMetadata(mediaId: string): Promise<MediaMetadata | null> {
    // å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰?
    let metadata = this.mediaMetadataCache.get(mediaId);
    
    if (!metadata) {
      // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä»é…ç½®ä¸­åŠ è½½
      try {
        const key = `media_metadata_${mediaId}`;
        const configData = await this.configService.getConfig<unknown>(key, null);
        
        // ä½¿ç”¨TypeSafetyUtilè¿›è¡Œç±»å‹å®‰å…¨è½¬æ¢
        if (configData && TypeSafetyUtil.isObject(configData)) {
          metadata = {
            id: TypeSafetyUtil.getProperty(configData, 'id', ''),
            title: TypeSafetyUtil.getProperty(configData, 'title', ''),
            subtitle: TypeSafetyUtil.getProperty(configData, 'subtitle', ''),
            description: TypeSafetyUtil.getProperty(configData, 'description', ''),
            coverUrl: TypeSafetyUtil.getProperty(configData, 'coverUrl', ''),
            bannerUrl: TypeSafetyUtil.getProperty(configData, 'bannerUrl', ''),
            type: TypeSafetyUtil.getProperty(configData, 'type', MediaType.OTHER),
            category: TypeSafetyUtil.getArray(configData, 'category', []),
            tags: TypeSafetyUtil.getArray(configData, 'tags', []),
            year: TypeSafetyUtil.getProperty(configData, 'year', 0),
            duration: TypeSafetyUtil.getProperty(configData, 'duration', 0),
            episodeCount: TypeSafetyUtil.getProperty(configData, 'episodeCount', 0),
            director: TypeSafetyUtil.getArray(configData, 'director', []),
            actors: TypeSafetyUtil.getArray(configData, 'actors', []),
            rating: TypeSafetyUtil.getProperty(configData, 'rating', 0),
            region: TypeSafetyUtil.getArray(configData, 'region', []),
            language: TypeSafetyUtil.getArray(configData, 'language', []),
            releaseDate: TypeSafetyUtil.getProperty(configData, 'releaseDate', ''),
            updateStatus: TypeSafetyUtil.getProperty(configData, 'updateStatus', ''),
            isFavorite: TypeSafetyUtil.getProperty(configData, 'isFavorite', false),
            isWatchLater: TypeSafetyUtil.getProperty(configData, 'isWatchLater', false),
            sourceSite: TypeSafetyUtil.getProperty(configData, 'sourceSite', ''),
            sourceUrl: TypeSafetyUtil.getProperty(configData, 'sourceUrl', ''),
            createTime: TypeSafetyUtil.getProperty(configData, 'createTime', Date.now()),
            updateTime: TypeSafetyUtil.getProperty(configData, 'updateTime', Date.now())
          };
          
          this.mediaMetadataCache.set(mediaId, metadata);
        }
      } catch (error) {
        Logger.error(TAG, `Failed to get media metadata for ${mediaId}: ${error}`);
      }
    }
    
    return metadata;
  }

  /**
   * ä¿å­˜åª’ä½“å…ƒæ•°æ?
   */
  public async saveMediaMetadata(metadata: MediaMetadata): Promise<void> {
    try {
      const key = `media_metadata_${metadata.id}`;
      const now = Date.now();
      
      // ç¡®ä¿æ—¶é—´æˆ³æ­£ç¡?
      const updatedMetadata: MediaMetadata = {
        ...metadata, createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata instanceof Error ? createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata : new Error(String(createTime: metadata.createTime || now,
        updateTime: now
      };
      
      // ä¿å­˜åˆ°é…ç½®å’Œç¼“å­˜
      await this.configService.setConfig(key, updatedMetadata)))))));
      this.mediaMetadataCache.set(metadata.id, updatedMetadata);
      
      this.notifyEvent(MediaEvent.MEDIA_ADDED, updatedMetadata);
    } catch (error) {
      Logger.error(TAG, `Failed to save media metadata for ${metadata.id}: ${error}`);
      throw error;
    }
  }

  /**
   * æ›´æ–°åª’ä½“å…ƒæ•°æ?
   */
  public async updateMediaMetadata(mediaId: string, updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata> instanceof Error ? updates: Partial<MediaMetadata> : new Error(String(updates: Partial<MediaMetadata>))))))): Promise<void> {
    try {
      const metadata = await this.getMediaMetadata(mediaId);
      if (!metadata) {
        throw new Error(`Media ${mediaId} not found`);
      }
      
      const updatedMetadata: Record<string, string | number | boolean | null> = { ... };
      
      await this.saveMediaMetadata(updatedMetadata);
      this.notifyEvent(MediaEvent.MEDIA_UPDATED, updatedMetadata);
    } catch (error) {
      Logger.error(TAG, `Failed to update media metadata for ${mediaId}: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–æ’­æ”¾è®°å½•
   */
  public getPlaybackRecord(mediaId: string, episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string : new Error(String(episodeId?: string instanceof Error ? episodeId?: string : new Error(String(episodeId?: string))))))): PlaybackRecord | null {
    const key = episodeId ? `${mediaId}_${episodeId}` : mediaId;
    return this.playbackRecords.get(key) || null;
  }

  /**
   * æ›´æ–°æ’­æ”¾è®°å½•
   */
  public async updatePlaybackRecord(mediaId: string, episodeId: string | undefined, position: number, isFinished: boolean = false): Promise<void> {
    try {
      const key = episodeId ? `${mediaId}_${episodeId}` : mediaId;
      const now = Date.now();
      const localDeviceId = this.deviceManager.getLocalDeviceId();
      
      let record = this.playbackRecords.get(key);
      if (!record) {
        record = {
          mediaId,
          episodeId,
          position: 0,
          lastPlayTime: 0,
          playCount: 0,
          isFinished: false
        };
      }
      
      // æ›´æ–°è®°å½•
      record.position = position;
      record.lastPlayTime = now;
      record.playCount += 1;
      record.isFinished = isFinished || record.isFinished;
      record.deviceId = localDeviceId;
      
      this.playbackRecords.set(key, record);
      
      // ä¿å­˜åˆ°é…ç½?
      await this.savePlaybackRecords();
      
      // å¦‚æœå¯ç”¨äº†è·¨è®¾å¤‡æ’­æ”¾ï¼ŒåŒæ­¥æ’­æ”¾è®°å½?
      if (this.config.enableCrossDevicePlayback) {
        await this.distributedDataService.saveSyncData(
          SyncDataType.HISTORY,
          key,
          record
        );
      }
      
      // é€šçŸ¥è¿›åº¦å˜åŒ–
      this.notifyEvent(MediaEvent.PLAYBACK_PROGRESS_CHANGED, record);
    } catch (error) {
      Logger.error(TAG, `Failed to update playback record: ${error}`);
    }
  }

  /**
   * è·å–æ’­æ”¾å†å²åˆ—è¡¨
   */
  public getPlaybackHistory(limit: number = 20): PlaybackRecord[] {
    return Array.from(this.playbackRecords.values())
      .sort((a, b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b))))))) => b.lastPlayTime - a.lastPlayTime)
      .slice(0, limit);
  }

  /**
   * åˆ›å»ºåª’ä½“é›†åˆ
   */
  public async createCollection(name: string, description?: string): Promise<MediaCollection> {
    try {
      const collection: MediaCollection = {
        id: `collection_${Date.now()}`,
        name,
        description,
        mediaIds: [],
        createTime: Date.now(),
        updateTime: Date.now()
      };
      
      this.collections.set(collection.id, collection);
      await this.saveCollections();
      
      this.notifyEvent(MediaEvent.COLLECTION_CREATED, collection);
      return collection;
    } catch (error) {
      Logger.error(TAG, `Failed to create collection: ${error}`);
      throw error;
    }
  }

  /**
   * æ·»åŠ åª’ä½“åˆ°é›†å?
   */
  public async addMediaToCollection(collectionId: string, mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string))))))): Promise<void> {
    try {
      const collection = this.collections.get(collectionId);
      if (!collection) {
        throw new Error(`Collection ${collectionId} not found`);
      }
      
      if (!collection.mediaIds.includes(mediaId)) {
        collection.mediaIds.push(mediaId);
        collection.updateTime = Date.now();
        
        await this.saveCollections();
        this.notifyEvent(MediaEvent.COLLECTION_UPDATED, collection);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to add media to collection: ${error}`);
      throw error;
    }
  }

  /**
   * ä»é›†åˆä¸­ç§»é™¤åª’ä½“
   */
  public async removeMediaFromCollection(collectionId: string, mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string : new Error(String(mediaId: string instanceof Error ? mediaId: string : new Error(String(mediaId: string))))))): Promise<void> {
    try {
      const collection = this.collections.get(collectionId);
      if (!collection) {
        throw new Error(`Collection ${collectionId} not found`);
      }
      
      const index = collection.mediaIds.indexOf(mediaId);
      if (index > -1) {
        collection.mediaIds.splice(index, 1);
        collection.updateTime = Date.now();
        
        await this.saveCollections();
        this.notifyEvent(MediaEvent.COLLECTION_UPDATED, collection);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to remove media from collection: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–æ‰€æœ‰åª’ä½“é›†å?
   */
  public getCollections(): MediaCollection[] {
    return Array.from(this.collections.values())
      .sort((a, b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b))))))) => b.updateTime - a.updateTime);
  }

  /**
   * æ·»åŠ åª’ä½“äº‹ä»¶ç›‘å¬
   */
  public addMediaEventListener(event: MediaEvent, listener: MediaEventListener): void {
    this.ensureEventExists(event);
    
    const listeners = this.getEventListeners(event);
    listeners.push(listener);
    Logger.debug(TAG, `Added media event listener for ${event}`);
  }

  /**
   * ç§»é™¤åª’ä½“äº‹ä»¶ç›‘å¬
   */
  public removeMediaEventListener(event: MediaEvent, listener: MediaEventListener): void {
    if (this.hasEvent(event)) {
      const listeners = this.getEventListeners(event);
      const index = listeners.indexOf(listener);
      
      if (index > -1) {
        listeners.splice(index, 1);
        Logger.debug(TAG, `Removed media event listener for ${event}`);
      }
    }
  }

  /**
   * é€šçŸ¥äº‹ä»¶
   */
  private notifyEvent(event: MediaEvent, data: MediaMetadata | PlaybackRecord | MediaCollection | PlaybackProgress): void {
    if (this.hasEvent(event)) {
      const listeners = this.getEventListeners(event);
      for (const listener of listeners) {
        try {
          listener(event, data);
        } catch (error) {
          Logger.error(TAG, `Error in media event listener: ${error}`);
        }
      }
    }
  }

  /**
   * ç¡®ä¿äº‹ä»¶å­˜åœ¨äºç›‘å¬å™¨æ˜ å°„ä¸?
   */
  private ensureEventExists(event: MediaEvent): void {
    if (!this.hasEvent(event)) {
      this.eventListeners[event] = [];
    }
  }
  
  /**
   * æ£€æŸ¥äº‹ä»¶æ˜¯å¦å­˜åœ?
   */
  private hasEvent(event: MediaEvent): boolean {
    return this.eventListeners[event] !== undefined;
  }
  
  /**
   * è·å–äº‹ä»¶ç›‘å¬å™?
   */
  private getEventListeners(event: MediaEvent): MediaEventListener[] {
    this.ensureEventExists(event);
    return this.eventListeners[event];
  }
  
  /**
   * è·¨è®¾å¤‡åˆ‡æ¢æ’­æ”?
   */
  public async switchPlaybackToDevice(deviceId: string): Promise<boolean> {
    try {
      if (!this.config.enableCrossDevicePlayback) {
        throw new Error('Cross-device playback is disabled');
      }

      const device = await this.deviceManager.getDevice(deviceId);
      if (!device || device.status !== 'online') {
        throw new Error('Target device is not online');
      }

      // è·å–å½“å‰æ’­æ”¾ä¿¡æ¯
      const mediaId = this.playerService.getCurrentMediaId();
      const position = this.playerService.getCurrentPosition();
      const episodeId = this.playerService.getCurrentEpisodeId();
      const isPlaying = this.playerService.isPlaying();
      
      if (!mediaId) {
        throw new Error('No media is currently playing');
      }

      // æ„å»ºåˆ‡æ¢æ’­æ”¾å‘½ä»¤
      const playbackCommand: Record<string, string | number | boolean | null> = { ... };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? string | number | boolean | null> = { ... };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(string | number | boolean | null> = { ... };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand instanceof Error ? mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand : new Error(String(mediaId,
        episodeId,
        position,
        isPlaying
      };

      // å‘é€åˆ°ç›®æ ‡è®¾å¤‡
      const success = await this.deviceManager.sendCommandToDevice(deviceId, playbackCommand)))))));
      
      if (success) {
        // æœ¬åœ°åœæ­¢æ’­æ”¾
        this.playerService.stop();
        this.stopPlayback();
        this.notifyEvent(MediaEvent.PLAYBACK_DEVICE_CHANGED, {
          deviceId,
          deviceName: device.name
        } as PlaybackProgress);
      }
      
      return success;
    } catch (error) {
      Logger.error(TAG, `Failed to switch playback to device ${deviceId}: ${error}`);
      return false;
    }
  }

  /**
   * å…³é—­åª’ä½“æœåŠ¡
   */
  public close(): void {
    if (!this.isInitialized) {
      return;
    }

    this.stopProgressSync();
    
    // ä¿å­˜æ‰€æœ‰æ•°æ?
    this.savePlaybackRecords().catch(error => {
      Logger.error(TAG, `Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}` instanceof Error ? `Error saving playback records on close: ${error}` : new Error(String(`Error saving playback records on close: ${error}`)))))));
    });
    
    this.saveCollections().catch(error => {
      Logger.error(TAG, `Error saving collections on close: ${error}`);
    });

    this.isInitialized = false;
    Logger.info(TAG, 'Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed' : new Error(String('Media service closed' instanceof Error ? 'Media service closed' : new Error(String('Media service closed')))))));
  }
}


