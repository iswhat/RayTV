// MovieService - ç”µå½±/è§†é¢‘æœåŠ¡ç±?import Logger from '../../common/util/Logger';
import JsonUtil from '../../common/util/JsonUtil';
import StorageUtil from '../../common/util/StorageUtil';
import DateUtil from '../../common/util/DateUtil';
import RepositoryFactory from '../../data/repository/RepositoryFactory';
import { NetworkRepository } from '../../data/repository/NetworkRepository';
import { DatabaseRepository } from '../../data/repository/DatabaseRepository';

// å¯¼å…¥æ¨¡å‹å’ŒDTO
import Movie, { VideoType, VideoQuality, RatingInfo, VideoSource, Episode } from '../model/Movie';
import {
  SearchRequest,
  SearchResponseData,
  SearchSuggestionsResponseData,
  HotSearchResponseData,
  SearchType,
  SearchSort,
  SearchFilter,
  SearchUtils
} from '../dto/SearchDto';
import {
  MovieDetailData,
  EpisodesResponseData,
  VideoSourcesResponseData,
  PlaybackState,
  VideoSourceRequest,
  MovieDetailUtils
} from '../dto/MovieDetailDto';
import ApiResponse, { ResponseCode } from '../dto/ApiResponse';

// å¸¸é‡å®šä¹‰
const TAG = 'MovieService';
const CACHE_PREFIX: Record<string, string | number | boolean | null> = { ... };
const CACHE_DURATION: Record<string, string | number | boolean | null> = { ... };

// APIç«¯ç‚¹
const API_ENDPOINTS: Record<string, string | number | boolean | null> = { ... };

/**
 * ç”µå½±/è§†é¢‘æœåŠ¡ç±? * è´Ÿè´£å¤„ç†ç”µå½±/è§†é¢‘ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 */
export default class MovieService {
  private static instance: MovieService;
  private networkRepo: NetworkRepository;
  private databaseRepo: DatabaseRepository;

  /**
   * æ„é€ å‡½æ•°ï¼ˆç§æœ‰ï¼Œé˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–ï¼?   */
  private constructor() {
    this.networkRepo = RepositoryFactory.getRepository('network') as NetworkRepository;
    this.databaseRepo = RepositoryFactory.getRepository('database') as DatabaseRepository;
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): MovieService {
    if (!MovieService.instance) {
      MovieService.instance = new MovieService();
    }
    return MovieService.instance;
  }

  /**
   * åˆå§‹åŒ–æœåŠ?   * ç”¨äºå…¼å®¹AppServiceçš„åˆå§‹åŒ–æµç¨‹
   */
  public async initialize(): Promise<void> {
    Logger.info(TAG, 'MovieService initialized');
    // ç©ºå®ç°ï¼Œç”¨äºå…¼å®¹AppServiceåˆå§‹åŒ–æµç¨?  }

  /**
   * æœç´¢ç”µå½±/è§†é¢‘
   */
  public async search(request: SearchRequest): Promise<ApiResponse<SearchResponseData>> {
    try {
      Logger.info(TAG, 'Searching movies...', { keyword: request.keyword, type: request.type });

      // éªŒè¯æœç´¢å…³é”®è¯?      if (!SearchUtils.validateKeyword(request.keyword)) {
        return ApiResponse.validationError<SearchResponseData>([
          { field: 'keyword', message: 'æœç´¢å…³é”®è¯ä¸èƒ½ä¸ºç©? }
        ]);
      }

      // ç”Ÿæˆç¼“å­˜é”?      const cacheKey = `${CACHE_PREFIX.SEARCH_RESULT}${request.keyword}_${request.type}_${request.page}_${request.pageSize}`;

      // å°è¯•ä»ç¼“å­˜è·å?      const cachedData = await this.getCachedData<ApiResponse<SearchResponseData>>(cacheKey, CACHE_DURATION.SEARCH_RESULT);
      if (cachedData) {
        Logger.info(TAG, 'Returning search results from cache');
        return cachedData;
      }

      // è°ƒç”¨æœç´¢API
      const response = await this.networkRepo.request<ApiResponse<SearchResponseData>>({
        url: API_ENDPOINTS.SEARCH,
        method: 'GET',
        params: request
      });

      // ç¼“å­˜ç»“æœ
      if (response.isSuccess()) {
        await this.setCachedData(cacheKey, response, CACHE_DURATION.SEARCH_RESULT);
        Logger.info(TAG, 'Search completed successfully', { results: response.data?.items.length });
      }

      return response;
    } catch (error) {
      Logger.error(TAG, 'Search failed', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<SearchResponseData>('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
    }
  }

  /**
   * è·å–æœç´¢å»ºè®®
   */
  public async getSearchSuggestions(keyword: string, type: SearchType = SearchType.ALL): Promise<ApiResponse<SearchSuggestionsResponseData>> {
    try {
      Logger.info(TAG, 'Getting search suggestions...', { keyword });

      // éªŒè¯å…³é”®è¯é•¿åº?      if (keyword.length < 1) {
        return ApiResponse.success<SearchSuggestionsResponseData>({
          suggestions: [],
          keyword,
          totalSuggestions: 0
        });
      }

      // è°ƒç”¨æœç´¢å»ºè®®API
      const response = await this.networkRepo.request<ApiResponse<SearchSuggestionsResponseData>>({
        url: API_ENDPOINTS.SEARCH_SUGGESTIONS,
        method: 'GET',
        params: { keyword, type }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get search suggestions', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      // å¤±è´¥æ—¶è¿”å›ç©ºå»ºè®®ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
      return ApiResponse.success<SearchSuggestionsResponseData>({
        suggestions: [],
        keyword,
        totalSuggestions: 0
      });
    }
  }

  /**
   * è·å–çƒ­é—¨æœç´¢
   */
  public async getHotSearch(): Promise<ApiResponse<HotSearchResponseData>> {
    try {
      Logger.info(TAG, 'Getting hot search keywords...');

      // ç”Ÿæˆç¼“å­˜é”?      const cacheKey = `${CACHE_PREFIX.HOT_SEARCH}`;

      // å°è¯•ä»ç¼“å­˜è·å?      const cachedData = await this.getCachedData<ApiResponse<HotSearchResponseData>>(cacheKey, CACHE_DURATION.HOT_SEARCH);
      if (cachedData) {
        Logger.info(TAG, 'Returning hot search from cache');
        return cachedData;
      }

      // è°ƒç”¨çƒ­é—¨æœç´¢API
      const response = await this.networkRepo.request<ApiResponse<HotSearchResponseData>>({
        url: API_ENDPOINTS.HOT_SEARCH,
        method: 'GET'
      });

      // ç¼“å­˜ç»“æœ
      if (response.isSuccess()) {
        await this.setCachedData(cacheKey, response, CACHE_DURATION.HOT_SEARCH);
      }

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get hot search', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<HotSearchResponseData>('è·å–çƒ­é—¨æœç´¢å¤±è´¥');
    }
  }

  /**
   * è·å–ç”µå½±/è§†é¢‘è¯¦æƒ…
   */
  public async getMovieDetail(movieId: string): Promise<ApiResponse<MovieDetailData>> {
    try {
      Logger.info(TAG, 'Getting movie detail...', { movieId });

      // éªŒè¯ID
      if (!movieId) {
        return ApiResponse.validationError<MovieDetailData>([
          { field: 'movieId', message: 'ç”µå½±IDä¸èƒ½ä¸ºç©º' }
        ]);
      }

      // ç”Ÿæˆç¼“å­˜é”?      const cacheKey = `${CACHE_PREFIX.MOVIE_DETAIL}${movieId}`;

      // å°è¯•ä»ç¼“å­˜è·å?      const cachedData = await this.getCachedData<ApiResponse<MovieDetailData>>(cacheKey, CACHE_DURATION.MOVIE_DETAIL);
      if (cachedData) {
        // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
        const isFavorite = await this.databaseRepo.isMovieFavorite(movieId);
        if (cachedData.data) {
          cachedData.data.isFavorite = isFavorite;
        }
        
        // æ£€æŸ¥è§‚çœ‹è¿›åº?        const watchProgress = await this.databaseRepo.getWatchProgress(movieId);
        if (cachedData.data && watchProgress) {
          cachedData.data.watchProgress = watchProgress.progress;
          cachedData.data.lastWatchTime = watchProgress.timestamp;
        }
        
        Logger.info(TAG, 'Returning movie detail from cache');
        return cachedData;
      }

      // è°ƒç”¨è¯¦æƒ…API
      const response = await this.networkRepo.request<ApiResponse<MovieDetailData>>({
        url: API_ENDPOINTS.MOVIE_DETAIL,
        method: 'GET',
        params: { id: movieId }
      });

      if (response.isSuccess() && response.data) {
        // æ·»åŠ æ”¶è—å’Œè§‚çœ‹è¿›åº¦ä¿¡æ?        response.data.isFavorite = await this.databaseRepo.isMovieFavorite(movieId);
        
        const watchProgress = await this.databaseRepo.getWatchProgress(movieId);
        if (watchProgress) {
          response.data.watchProgress = watchProgress.progress;
          response.data.lastWatchTime = watchProgress.timestamp;
        }
        
        // ç¼“å­˜ç»“æœ
        await this.setCachedData(cacheKey, response, CACHE_DURATION.MOVIE_DETAIL);
        
        // åŒæ­¥åˆ°æœ¬åœ°æ•°æ®åº“
        await this.syncMovieToLocal(response.data);
      }

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get movie detail', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData>('è·å–ç”µå½±è¯¦æƒ…å¤±è´¥');
    }
  }

  /**
   * è·å–å‰§é›†åˆ—è¡¨
   */
  public async getEpisodes(movieId: string, season?: number): Promise<ApiResponse<EpisodesResponseData>> {
    try {
      Logger.info(TAG, 'Getting episodes...', { movieId, season });

      // è°ƒç”¨å‰§é›†API
      const response = await this.networkRepo.request<ApiResponse<EpisodesResponseData>>({
        url: API_ENDPOINTS.EPISODES,
        method: 'GET',
        params: { id: movieId, season }
      });

      if (response.isSuccess() && response.data?.episodes) {
        // åŠ è½½æ¯é›†çš„è§‚çœ‹è¿›åº?        for (const episode of response.data.episodes) {
          const progress = await this.databaseRepo.getEpisodeWatchProgress(movieId, episode.id);
          if (progress) {
            episode.watchProgress = progress.progress;
            episode.watchTime = progress.timestamp;
            episode.isWatched = progress.progress >= 95; // è¿›åº¦è¶…è¿‡95%è§†ä¸ºå·²è§‚çœ?          }
        }
      }

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get episodes', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<EpisodesResponseData>('è·å–å‰§é›†åˆ—è¡¨å¤±è´¥');
    }
  }

  /**
   * è·å–è§†é¢‘æ’­æ”¾æº?   */
  public async getVideoSources(request: VideoSourceRequest): Promise<ApiResponse<VideoSourcesResponseData>> {
    try {
      Logger.info(TAG, 'Getting video sources...', { 
        contentId: request.contentId,
        episodeId: request.episodeId
      });

      // ç”Ÿæˆç¼“å­˜é”?      let cacheKey = `${CACHE_PREFIX.VIDEO_SOURCES}${request.contentId}`;
      if (request.episodeId) {
        cacheKey += `_${request.episodeId}`;
      }

      // å°è¯•ä»ç¼“å­˜è·å?      const cachedData = await this.getCachedData<ApiResponse<VideoSourcesResponseData>>(cacheKey, CACHE_DURATION.VIDEO_SOURCES);
      if (cachedData) {
        Logger.info(TAG, 'Returning video sources from cache');
        return cachedData;
      }

      // è°ƒç”¨è§†é¢‘æºAPI
      const response = await this.networkRepo.request<ApiResponse<VideoSourcesResponseData>>({
        url: API_ENDPOINTS.VIDEO_SOURCES,
        method: 'GET',
        params: request
      });

      // ç¼“å­˜ç»“æœ
      if (response.isSuccess()) {
        await this.setCachedData(cacheKey, response, CACHE_DURATION.VIDEO_SOURCES);
      }

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get video sources', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<VideoSourcesResponseData>('è·å–æ’­æ”¾æºå¤±è´?);
    }
  }

  /**
   * æ›´æ–°æ’­æ”¾çŠ¶æ€?   */
  public async updatePlaybackState(state: PlaybackState): Promise<ApiResponse<boolean>> {
    try {
      Logger.info(TAG, 'Updating playback state...', {
        contentId: state.contentId,
        position: state.position,
        completed: state.completed
      });

      // ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
      await this.databaseRepo.savePlaybackState(state);

      // å¦‚æœæ’­æ”¾å®Œæˆï¼Œè®°å½•è§‚çœ‹å†å?      if (state.completed) {
        await this.databaseRepo.addToHistory({
          userId: 'current', // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·ID
          contentId: state.contentId,
          episodeId: state.episodeId,
          progress: 100,
          duration: state.duration,
          timestamp: Date.now(),
          completed: true
        });
      }

      return ApiResponse.success(true, 'æ’­æ”¾çŠ¶æ€æ›´æ–°æˆåŠ?);
    } catch (error) {
      Logger.error(TAG, 'Failed to update playback state', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.error(ResponseCode.UNKNOWN_ERROR, 'æ›´æ–°æ’­æ”¾çŠ¶æ€å¤±è´?);
    }
  }

  /**
   * è·å–æ’­æ”¾çŠ¶æ€?   */
  public async getPlaybackState(contentId: string, episodeId?: string): Promise<ApiResponse<PlaybackState | null>> {
    try {
      Logger.info(TAG, 'Getting playback state...', { contentId, episodeId });

      // ä»æœ¬åœ°æ•°æ®åº“è·å–
      const state = await this.databaseRepo.getPlaybackState(contentId, episodeId);
      
      return ApiResponse.success(state, 'è·å–æ’­æ”¾çŠ¶æ€æˆåŠ?);
    } catch (error) {
      Logger.error(TAG, 'Failed to get playback state', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.success<null>(null, 'è·å–æ’­æ”¾çŠ¶æ€å¤±è´¥ï¼Œè¿”å›ç©?);
    }
  }

  /**
   * æ·»åŠ /ç§»é™¤æ”¶è—
   */
  public async toggleFavorite(movieId: string): Promise<ApiResponse<{ isFavorite: boolean }>> {
    try {
      Logger.info(TAG, 'Toggling favorite status...', { movieId });

      // æ£€æŸ¥å½“å‰æ”¶è—çŠ¶æ€?      const isFavorite = await this.databaseRepo.isMovieFavorite(movieId);
      
      if (isFavorite) {
        // ç§»é™¤æ”¶è—
        await this.databaseRepo.removeFromFavorites(movieId);
        Logger.info(TAG, 'Movie removed from favorites', { movieId });
      } else {
        // æ·»åŠ æ”¶è—
        // å…ˆè·å–ç”µå½±è¯¦æƒ?        const detailResponse = await this.getMovieDetail(movieId);
        if (detailResponse.isSuccess() && detailResponse.data) {
          await this.databaseRepo.addToFavorites({
            id: movieId,
            title: detailResponse.data.title,
            coverUrl: detailResponse.data.posters?.[0]?.url,
            type: detailResponse.data.type,
            rating: detailResponse.data.rating?.score,
            releaseYear: detailResponse.data.releaseYear,
            addedAt: Date.now()
          });
          Logger.info(TAG, 'Movie added to favorites', { movieId });
        } else {
          return ApiResponse.error(ResponseCode.NOT_FOUND, 'è·å–ç”µå½±ä¿¡æ¯å¤±è´¥ï¼Œæ— æ³•æ·»åŠ æ”¶è—?);
        }
      }

      // è¿”å›æ–°çš„æ”¶è—çŠ¶æ€?      const newFavoriteStatus = !isFavorite;
      
      // æ¸…é™¤è¯¦æƒ…ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡åŠ è½½æ—¶æ›´æ–°æ”¶è—çŠ¶æ€?      await this.clearMovieDetailCache(movieId);
      
      return ApiResponse.success({ isFavorite: newFavoriteStatus }, 
        newFavoriteStatus ? 'æ·»åŠ æ”¶è—æˆåŠŸ' : 'ç§»é™¤æ”¶è—æˆåŠŸ');
    } catch (error) {
      Logger.error(TAG, 'Failed to toggle favorite status', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.error(ResponseCode.UNKNOWN_ERROR, 'æ“ä½œæ”¶è—å¤±è´¥');
    }
  }

  /**
   * è·å–æ¨èå†…å®¹
   */
  public async getRecommendations(movieId?: string, limit: number = 20): Promise<ApiResponse<MovieDetailData[]>> {
    try {
      Logger.info(TAG, 'Getting recommendations...', { movieId, limit });

      const response = await this.networkRepo.request<ApiResponse<MovieDetailData[]>>({
        url: API_ENDPOINTS.RECOMMENDATIONS,
        method: 'GET',
        params: { id: movieId, limit }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get recommendations', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData[]>('è·å–æ¨èå†…å®¹å¤±è´¥');
    }
  }

  /**
   * è·å–ç›¸ä¼¼å†…å®¹
   */
  public async getSimilarMovies(movieId: string, limit: number = 10): Promise<ApiResponse<MovieDetailData[]>> {
    try {
      Logger.info(TAG, 'Getting similar movies...', { movieId, limit });

      const response = await this.networkRepo.request<ApiResponse<MovieDetailData[]>>({
        url: API_ENDPOINTS.SIMILAR,
        method: 'GET',
        params: { id: movieId, limit }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get similar movies', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData[]>('è·å–ç›¸ä¼¼å†…å®¹å¤±è´¥');
    }
  }

  /**
   * è·å–åˆ†ç±»åˆ—è¡¨
   */
  public async getCategories(type: VideoType = VideoType.ALL): Promise<ApiResponse<unknown[]>> {
    try {
      Logger.info(TAG, 'Getting categories...', { type });

      // ç”Ÿæˆç¼“å­˜é”?      const cacheKey = `${CACHE_PREFIX.CATEGORY_LIST}${type}`;

      // å°è¯•ä»ç¼“å­˜è·å?      const cachedData = await this.getCachedData<ApiResponse<unknown[]>>(cacheKey, CACHE_DURATION.CATEGORY_LIST);
      if (cachedData) {
        Logger.info(TAG, 'Returning categories from cache');
        return cachedData;
      }

      // è°ƒç”¨åˆ†ç±»API
      const response = await this.networkRepo.request<ApiResponse<unknown[]>>({
        url: API_ENDPOINTS.CATEGORIES,
        method: 'GET',
        params: { type }
      });

      // ç¼“å­˜ç»“æœ
      if (response.isSuccess()) {
        await this.setCachedData(cacheKey, response, CACHE_DURATION.CATEGORY_LIST);
      }

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get categories', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<unknown[]>('è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥');
    }
  }

  /**
   * è·å–åˆ†ç±»å†…å®¹
   */
  public async getCategoryItems(categoryId: string, page: number = 1, pageSize: number = 20): Promise<ApiResponse<SearchResponseData>> {
    try {
      Logger.info(TAG, 'Getting category items...', { categoryId, page });

      // è°ƒç”¨åˆ†ç±»å†…å®¹API
      const response = await this.networkRepo.request<ApiResponse<SearchResponseData>>({
        url: API_ENDPOINTS.CATEGORY_ITEMS,
        method: 'GET',
        params: { id: categoryId, page, pageSize }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get category items', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<SearchResponseData>('è·å–åˆ†ç±»å†…å®¹å¤±è´¥');
    }
  }

  /**
   * è·å–çƒ­é—¨å†…å®¹
   */
  public async getTrending(type: VideoType = VideoType.ALL, limit: number = 20): Promise<ApiResponse<MovieDetailData[]>> {
    try {
      Logger.info(TAG, 'Getting trending movies...', { type, limit });

      const response = await this.networkRepo.request<ApiResponse<MovieDetailData[]>>({
        url: API_ENDPOINTS.TRENDING,
        method: 'GET',
        params: { type, limit }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get trending movies', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData[]>('è·å–çƒ­é—¨å†…å®¹å¤±è´¥');
    }
  }

  /**
   * è·å–æœ€æ–°ä¸Šçº?   */
  public async getNewReleases(type: VideoType = VideoType.ALL, limit: number = 20): Promise<ApiResponse<MovieDetailData[]>> {
    try {
      Logger.info(TAG, 'Getting new releases...', { type, limit });

      const response = await this.networkRepo.request<ApiResponse<MovieDetailData[]>>({
        url: API_ENDPOINTS.NEW_RELEASES,
        method: 'GET',
        params: { type, limit }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get new releases', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData[]>('è·å–æœ€æ–°ä¸Šçº¿å¤±è´?);
    }
  }

  /**
   * è·å–æµè¡Œå†…å®¹
   */
  public async getPopular(type: VideoType = VideoType.ALL, limit: number = 20): Promise<ApiResponse<MovieDetailData[]>> {
    try {
      Logger.info(TAG, 'Getting popular movies...', { type, limit });

      const response = await this.networkRepo.request<ApiResponse<MovieDetailData[]>>({
        url: API_ENDPOINTS.POPULAR,
        method: 'GET',
        params: { type, limit }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get popular movies', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData[]>('è·å–æµè¡Œå†…å®¹å¤±è´¥');
    }
  }

  /**
   * è·å–é«˜è¯„åˆ†å†…å®?   */
  public async getTopRated(type: VideoType = VideoType.ALL, limit: number = 20): Promise<ApiResponse<MovieDetailData[]>> {
    try {
      Logger.info(TAG, 'Getting top rated movies...', { type, limit });

      const response = await this.networkRepo.request<ApiResponse<MovieDetailData[]>>({
        url: API_ENDPOINTS.TOP_RATED,
        method: 'GET',
        params: { type, limit }
      });

      return response;
    } catch (error) {
      Logger.error(TAG, 'Failed to get top rated movies', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return ApiResponse.networkError<MovieDetailData[]>('è·å–é«˜è¯„åˆ†å†…å®¹å¤±è´?);
    }
  }

  // ========== ç¼“å­˜ç›¸å…³æ–¹æ³• ==========

  /**
   * ä»ç¼“å­˜è·å–æ•°æ?   */
  private async getCachedData<T>(key: string, maxAge: number): Promise<T | null> {
    try {
      const cached = await StorageUtil.getObject<{ data: T; timestamp: number }>(key);
      
      if (!cached) {
        return null;
      }

      const now = Date.now();
      if (now - cached.timestamp > maxAge) {
        // ç¼“å­˜å·²è¿‡æœ?        await StorageUtil.remove(key);
        return null;
      }

      return cached.data;
    } catch (error) {
      Logger.error(TAG, `Failed to get cached data for key ${key}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      return null;
    }
  }

  /**
   * è®¾ç½®ç¼“å­˜æ•°æ®
   */
  private async setCachedData<T>(key: string, data: T, maxAge: number): Promise<void> {
    try {
      await StorageUtil.setObject(key, {
        data,
        timestamp: Date.now()
      });
    } catch (error) {
      Logger.error(TAG, `Failed to set cached data for key ${key}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
    }
  }

  /**
   * æ¸…é™¤ç”µå½±è¯¦æƒ…ç¼“å­˜
   */
  private async clearMovieDetailCache(movieId: string): Promise<void> {
    try {
      const cacheKey = `${CACHE_PREFIX.MOVIE_DETAIL}${movieId}`;
      await StorageUtil.remove(cacheKey);
    } catch (error) {
      Logger.error(TAG, `Failed to clear movie detail cache for movieId ${movieId}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
    }
  }

  // ========== æœ¬åœ°æ•°æ®åŒæ­¥æ–¹æ³• ==========

  /**
   * å°†ç”µå½±æ•°æ®åŒæ­¥åˆ°æœ¬åœ°æ•°æ®åº?   */
  private async syncMovieToLocal(movieData: MovieDetailData): Promise<void> {
    try {
      // åˆ›å»ºMovieå¯¹è±¡
      const movie = new Movie({
        id: movieData.id,
        title: movieData.title,
        originalTitle: movieData.originalTitle,
        type: movieData.type,
        description: movieData.description,
        coverUrl: movieData.posters?.[0]?.url,
        backdropUrl: movieData.backdrops?.[0]?.url,
        rating: movieData.rating,
        releaseYear: movieData.releaseYear,
        genres: movieData.genres,
        duration: movieData.runtime,
        directors: movieData.directors?.map(d => d.name) || [],
        actors: movieData.actors?.map(a => a.name) || [],
        sources: movieData.sources || [],
        totalEpisodes: movieData.totalEpisodes,
        airedEpisodes: movieData.airedEpisodes,
        isVip: movieData.isVip,
        isNew: movieData.isNew,
        isHot: movieData.isHot,
        updateTime: Date.now()
      });

      // ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
      await this.databaseRepo.saveMovie(movie);
    } catch (error) {
      Logger.error(TAG, `Failed to sync movie to local database: ${movieData.id}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
    }
  }
}


