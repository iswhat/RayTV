import Logger from '../../common/util/Logger';
import { DatabaseManager } from '../../data/db/DatabaseManager';
import { MediaType } from './MediaService';
import { MediaItem } from '../../data/bean/MediaItem';
import { TypeSafetyUtil } from '../../common/util/TypeSafetyUtil';

/**
 * å†å²è®°å½•é¡¹æ¥å? */
/**
 * å†å²è®°å½•é™„åŠ ä¿¡æ¯æ¥å£
 */
export interface HistoryExtraData {
  [key: string]: string | number | boolean | undefined;
}

/**
 * æ’­æ”¾æºä¿¡æ¯æ¥å? */
export interface PlaySource {
  sourceId: string;     // æ’­æ”¾æºID
  sourceName: string;   // æ’­æ”¾æºåç§?  url?: string;         // æ’­æ”¾URL
  quality?: string;     // è§†é¢‘è´¨é‡
  format?: string;      // è§†é¢‘æ ¼å¼
}

/**
 * å†å²è®°å½•é¡¹æ¥å? */
export interface HistoryItem {
  id: string;           // å†å²è®°å½•ID
  mediaId: string;      // åª’ä½“ID
  siteKey: string;      // ç«™ç‚¹æ ‡è¯†
  title: string;        // æ ‡é¢˜
  cover?: string;       // å°é¢å›?  type: MediaType;      // åª’ä½“ç±»å‹
  episodeId?: string;   // å‰§é›†ID
  episodeTitle?: string; // å‰§é›†æ ‡é¢˜
  progress: number;     // æ’­æ”¾è¿›åº¦ï¼ˆç§’ï¼?  duration?: number;    // æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  lastPlayTime: number; // æœ€åæ’­æ”¾æ—¶é—?  playCount: number;    // æ’­æ”¾æ¬¡æ•°
  playSource?: PlaySource; // æ’­æ”¾æºä¿¡æ?  extra?: HistoryExtraData; // å…¶ä»–é™„åŠ ä¿¡æ¯
}

/**
 * å†å²è®°å½•æœåŠ¡
 * å®ç°æ’­æ”¾å†å²çš„è®°å½•ã€æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤åŠŸèƒ½
 */
export class HistoryService {
  private readonly TAG: string = 'HistoryService';
  private static instance: HistoryService | null = null;
  private dbManager: DatabaseManager;
  private historyTable: string = 'media_history';

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns HistoryService
   */
  public static getInstance(): HistoryService {
    if (!HistoryService.instance) {
      HistoryService.instance = new HistoryService();
    }
    return HistoryService.instance;
  }

  /**
   * æ„é€ å‡½æ•?   * ç§æœ‰æ„é€ å‡½æ•°é˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
   */
  private constructor() {
    this.dbManager = DatabaseManager.getInstance();
    this.initialize();
    Logger.info(this.TAG, 'HistoryService initialized');
  }

  /**
   * åˆå§‹åŒ–å†å²è®°å½•æœåŠ?   */
  public async initialize(): Promise<void> {
    try {
      // åˆ›å»ºå†å²è®°å½•è¡?      await this.dbManager.executeSql(`
        CREATE TABLE IF NOT EXISTS ${this.historyTable} (
          id TEXT PRIMARY KEY,
          mediaId TEXT NOT NULL,
          siteKey TEXT NOT NULL,
          title TEXT NOT NULL,
          cover TEXT,
          type TEXT NOT NULL,
          episodeId TEXT,
          episodeTitle TEXT,
          progress INTEGER DEFAULT 0,
          duration INTEGER DEFAULT 0,
          lastPlayTime INTEGER NOT NULL,
          playCount INTEGER DEFAULT 1,
          playSource TEXT,
          extra TEXT,
          UNIQUE(mediaId, siteKey, episodeId)
        );
      `);

      // åˆ›å»ºç´¢å¼•
      await this.dbManager.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_history_last_play_time 
        ON ${this.historyTable} (lastPlayTime DESC);
      `);
      
      await this.dbManager.executeSql(`
        CREATE INDEX IF NOT EXISTS idx_history_media_site 
        ON ${this.historyTable} (mediaId, siteKey);
      `);

      Logger.info(this.TAG, 'History table initialized');
    } catch (error) {
      Logger.error(this.TAG, 'Failed to initialize history table', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
    }
  }

  /**
   * æ·»åŠ æˆ–æ›´æ–°å†å²è®°å½?   * @param media åª’ä½“ä¿¡æ¯
   * @param progress æ’­æ”¾è¿›åº¦ï¼ˆç§’ï¼?   * @param duration æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
   * @param episodeId å‰§é›†IDï¼ˆå¯é€‰ï¼‰
   * @param episodeTitle å‰§é›†æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
   * @param playSource æ’­æ”¾æºï¼ˆå¯é€‰ï¼‰
   * @returns Promise<HistoryItem>
   */
  public async addHistory(
    media: Pick<MediaItem, 'id' | 'siteKey' | 'title' | 'cover' | 'type'>,
    progress: number,
    duration: number,
    episodeId?: string,
    episodeTitle?: string,
    playSource?: PlaySource
  ): Promise<HistoryItem> {
    try {
      const now = Date.now();
      const historyId = this.generateHistoryId(media.id, media.siteKey, episodeId);
      const progressValue = Math.max(0, Math.min(progress, duration));

      // æ„å»ºå†å²è®°å½•é¡?      const historyItem: HistoryItem = {
        id: historyId,
        mediaId: media.id,
        siteKey: media.siteKey,
        title: media.title,
        cover: media.cover,
        type: media.type,
        episodeId,
        episodeTitle,
        progress: progressValue,
        duration,
        lastPlayTime: now,
        playCount: 1,
        playSource,
        extra: {} as HistoryExtraData
      };

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const existing = await this.getHistoryById(historyId);
      
      const db = this.dbManager.getDatabase();
      
      if (existing) {
        // æ›´æ–°ç°æœ‰è®°å½•
        historyItem.playCount = existing.playCount + 1;
        
        await this.dbManager.executeSql(
          `UPDATE ${this.historyTable} 
           SET title = ?, cover = ?, type = ?, episodeTitle = ?, 
               progress = ?, duration = ?, lastPlayTime = ?, 
               playCount = ?, playSource = ?, extra = ? 
           WHERE id = ?`,
          [
            historyItem.title,
            historyItem.cover || '',
            historyItem.type,
            historyItem.episodeTitle || '',
            historyItem.progress,
            historyItem.duration,
            historyItem.lastPlayTime,
            historyItem.playCount,
            playSource ? JSON.stringify(playSource) : '',
            JSON.stringify(historyItem.extra),
            historyItem.id
          ]
        );
      } else {
        // æ’å…¥æ–°è®°å½?        await this.dbManager.executeSql(
          `INSERT INTO ${this.historyTable} 
           (id, mediaId, siteKey, title, cover, type, episodeId, episodeTitle, 
            progress, duration, lastPlayTime, playCount, playSource, extra) 
           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
          [
            historyItem.id,
            historyItem.mediaId,
            historyItem.siteKey,
            historyItem.title,
            historyItem.cover || '',
            historyItem.type,
            historyItem.episodeId || '',
            historyItem.episodeTitle || '',
            historyItem.progress,
            historyItem.duration,
            historyItem.lastPlayTime,
            historyItem.playCount,
            playSource ? JSON.stringify(playSource) : '',
            JSON.stringify(historyItem.extra)
          ]
        );
      }

      Logger.info(this.TAG, `Added/updated history: ${media.siteKey}:${media.id}${episodeId ? `:${episodeId}` : ''}`);
      return historyItem;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to add history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      throw new Error(`Failed to add history: ${error}`);
    }
  }

  /**
   * æ›´æ–°æ’­æ”¾è¿›åº¦
   * @param mediaId åª’ä½“ID
   * @param siteKey ç«™ç‚¹æ ‡è¯†
   * @param progress æ’­æ”¾è¿›åº¦ï¼ˆç§’ï¼?   * @param episodeId å‰§é›†IDï¼ˆå¯é€‰ï¼‰
   * @returns Promise<boolean>
   */
  public async updateProgress(
    mediaId: string,
    siteKey: string,
    progress: number,
    episodeId?: string
  ): Promise<boolean> {
    try {
      const historyId = this.generateHistoryId(mediaId, siteKey, episodeId);
      const now = Date.now();

      // å…ˆæ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ?      const exists = await this.getHistoryById(historyId);
      if (!exists) {
        return false;
      }

      await this.dbManager.executeSql(
        `UPDATE ${this.historyTable} 
         SET progress = ?, lastPlayTime = ? 
         WHERE id = ?`,
        [progress, now, historyId]
      );

      Logger.info(this.TAG, `Updated progress for ${siteKey}:${mediaId}${episodeId ? `:${episodeId}` : ''}`);
      return true;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to update progress', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return false;
    }
  }

  /**
   * è·å–å†å²è®°å½•åˆ—è¡¨
   * @param params æŸ¥è¯¢å‚æ•°
   * @returns Promise<HistoryItem[]>
   */
  public async getHistoryList(params: {
    type?: MediaType;
    page?: number;
    pageSize?: number;
    limit?: number;
  } = {}): Promise<HistoryItem[]> {
    try {
      const type = params.type;
      const page = params.page ?? 1;
      const pageSize = params.pageSize ?? 20;
      const limit = params.limit;
      const offset = (page - 1) * pageSize;
      const limitValue = limit || pageSize;

      // æ„å»ºæŸ¥è¯¢æ¡ä»¶
      let whereClause = '';
      const whereParams: Record<string, string | number | boolean | null>[] = [];
      
      if (type) {
        whereClause = 'WHERE type = ?';
        whereParams.push(type);
      }

      // æ‰§è¡ŒæŸ¥è¯¢
      const result = await this.dbManager.getDatabase().querySql(
        `SELECT * FROM ${this.historyTable} 
         ${whereClause} 
         ORDER BY lastPlayTime DESC 
         LIMIT ? OFFSET ?`,
        [...whereParams, limitValue, offset]
      );

      // è§£æç»“æœ
      const historyItems: HistoryItem[] = [];
      
      if (result !== null) {
        while (result.goToNextRow()) {
          const item: Record<string, any> = {};
          for (let i = 0; i < result.rowCount; i++) {
            const columnName = result.getColumnName(i);
            const value = result.getLong(i) ?? result.getString(i);
            item[columnName] = value;
          }
          historyItems.push(this.parseHistoryRow(item));
        }
        result.close();
      }
      
      return historyItems;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get history list', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return [];
    }
  }

  /**
   * æ ¹æ®IDè·å–å†å²è®°å½•
   * @param historyId å†å²è®°å½•ID
   * @returns Promise<HistoryItem | null>
   */
  public async getHistoryById(historyId: string): Promise<HistoryItem | null> {
    try {
      const result = await this.dbManager.getDatabase().querySql(
        `SELECT * FROM ${this.historyTable} WHERE id = ?`,
        [historyId]
      );

      if (result !== null) {
        if (result.goToFirstRow()) {
          const item: Record<string, any> = {};
          for (let i = 0; i < result.columnCount; i++) {
            const columnName = result.getColumnName(i);
            const value = result.getLong(i) ?? result.getString(i);
            item[columnName] = value;
          }
          result.close();
          return this.parseHistoryRow(item);
        }
        result.close();
      }
      return null;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get history by id', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return null;
    }
  }

  /**
   * è·å–åª’ä½“çš„å†å²è®°å½?   * @param mediaId åª’ä½“ID
   * @param siteKey ç«™ç‚¹æ ‡è¯†
   * @returns Promise<HistoryItem | null>
   */
  public async getMediaHistory(mediaId: string, siteKey: string): Promise<HistoryItem | null> {
    try {
      const result = await this.dbManager.getDatabase().querySql(
        `SELECT * FROM ${this.historyTable} 
         WHERE mediaId = ? AND siteKey = ? AND episodeId IS NULL 
         ORDER BY lastPlayTime DESC LIMIT 1`,
        [mediaId, siteKey]
      );

      if (result !== null) {
        if (result.goToFirstRow()) {
          const item: Record<string, any> = {};
          for (let i = 0; i < result.columnCount; i++) {
            const columnName = result.getColumnName(i);
            const value = result.getLong(i) ?? result.getString(i);
            item[columnName] = value;
          }
          result.close();
          return this.parseHistoryRow(item);
        }
        result.close();
      }
      return null;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get media history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return null;
    }
  }

  /**
   * è·å–åª’ä½“å‰§é›†çš„å†å²è®°å½?   * @param mediaId åª’ä½“ID
   * @param siteKey ç«™ç‚¹æ ‡è¯†
   * @param episodeId å‰§é›†ID
   * @returns Promise<HistoryItem | null>
   */
  public async getEpisodeHistory(
    mediaId: string,
    siteKey: string,
    episodeId: string
  ): Promise<HistoryItem | null> {
    try {
      const result = await this.dbManager.getDatabase().querySql(
        `SELECT * FROM ${this.historyTable} 
         WHERE mediaId = ? AND siteKey = ? AND episodeId = ?`,
        [mediaId, siteKey, episodeId]
      );

      if (result !== null) {
        if (result.goToFirstRow()) {
          const item: Record<string, any> = {};
          for (let i = 0; i < result.columnCount; i++) {
            const columnName = result.getColumnName(i);
            const value = result.getLong(i) ?? result.getString(i);
            item[columnName] = value;
          }
          result.close();
          return this.parseHistoryRow(item);
        }
        result.close();
      }
      return null;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get episode history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return null;
    }
  }

  /**
   * åˆ é™¤å†å²è®°å½•
   * @param historyId å†å²è®°å½•ID
   * @returns Promise<boolean>
   */
  public async deleteHistory(historyId: string): Promise<boolean> {
    try {
      const db = this.dbManager.getDatabase();
      const result = await db.executeSql(
        `DELETE FROM ${this.historyTable} WHERE id = ?`,
        [historyId]
      );

      const success = result.affectedRows > 0;
      if (success) {
        Logger.info(this.TAG, `Deleted history: ${historyId}`);
      }
      return success;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to delete history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return false;
    }
  }

  /**
   * åˆ é™¤åª’ä½“çš„æ‰€æœ‰å†å²è®°å½?   * @param mediaId åª’ä½“ID
   * @param siteKey ç«™ç‚¹æ ‡è¯†
   * @returns Promise<boolean>
   */
  public async deleteMediaHistory(mediaId: string, siteKey: string): Promise<boolean> {
    try {
      const db = this.dbManager.getDatabase();
      const result = await db.executeSql(
        `DELETE FROM ${this.historyTable} WHERE mediaId = ? AND siteKey = ?`,
        [mediaId, siteKey]
      );

      const success = result.affectedRows > 0;
      if (success) {
        Logger.info(this.TAG, `Deleted all history for media: ${siteKey}:${mediaId}`);
      }
      return success;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to delete media history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return false;
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å†å²è®°å½?   * @returns Promise<boolean>
   */
  public async clearAllHistory(): Promise<boolean> {
    try {
      const db = this.dbManager.getDatabase();
      await db.executeSql(`DELETE FROM ${this.historyTable}`);
      Logger.info(this.TAG, 'Cleared all history');
      return true;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to clear all history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return false;
    }
  }

  /**
   * æ¸…ç©ºæŒ‡å®šç±»å‹çš„å†å²è®°å½?   * @param type åª’ä½“ç±»å‹
   * @returns Promise<boolean>
   */
  public async clearHistoryByType(type: MediaType): Promise<boolean> {
    try {
      const db = this.dbManager.getDatabase();
      await db.executeSql(
        `DELETE FROM ${this.historyTable} WHERE type = ?`,
        [type]
      );
      Logger.info(this.TAG, `Cleared history for type: ${type}`);
      return true;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to clear history by type', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return false;
    }
  }

  /**
   * è·å–å†å²è®°å½•æ•°é‡
   * @param type åª’ä½“ç±»å‹ï¼ˆå¯é€‰ï¼‰
   * @returns Promise<number>
   */
  public async getHistoryCount(type?: MediaType): Promise<number> {
    try {
      let query = `SELECT COUNT(*) as count FROM ${this.historyTable}`;
      const params: Record<string, string | number | boolean | null>[] = [];

      if (type) {
        query += ' WHERE type = ?';
        params.push(type);
      }

      // ä½¿ç”¨querySqlæ–¹æ³•æŸ¥è¯¢è€Œä¸æ˜¯executeSql
      const result = await this.dbManager.getDatabase().querySql(query, params);
      let count = 0;
      
      if (result !== null) {
        if (result.goToFirstRow()) {
          count = result.getLong(0) || 0;
        }
        result.close();
      }
      
      return count;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to get history count', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return 0;
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†å²è®°å½?   * @param mediaId åª’ä½“ID
   * @param siteKey ç«™ç‚¹æ ‡è¯†
   * @param episodeId å‰§é›†IDï¼ˆå¯é€‰ï¼‰
   * @returns Promise<boolean>
   */
  public async hasHistory(
    mediaId: string,
    siteKey: string,
    episodeId?: string
  ): Promise<boolean> {
    try {
      let sql = `SELECT COUNT(*) as count FROM ${this.historyTable} WHERE mediaId = ? AND siteKey = ?`;
      const params: string[] = [mediaId, siteKey];

      if (episodeId !== undefined) {
        sql += episodeId === null ? ' AND episodeId IS NULL' : ' AND episodeId = ?';
        if (episodeId !== null) {
          params.push(episodeId);
        }
      } else {
        sql += ' AND episodeId IS NULL';
      }

      const db = this.dbManager.getDatabase();
      const result = await db.querySql(sql, params);
      let count = 0;
      if (result !== null) {
        if (result.goToFirstRow()) {
          count = result.getLong(0);
        }
        result.close();
      }
      return count > 0;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to check history existence', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return false;
    }
  }

  /**
   * ç”Ÿæˆå†å²è®°å½•ID
   * @param mediaId åª’ä½“ID
   * @param siteKey ç«™ç‚¹æ ‡è¯†
   * @param episodeId å‰§é›†IDï¼ˆå¯é€‰ï¼‰
   * @returns string
   * @private
   */
  private generateHistoryId(mediaId: string, siteKey: string, episodeId?: string): string {
    return episodeId 
      ? `${siteKey}:${mediaId}:${episodeId}`
      : `${siteKey}:${mediaId}`;
  }

  /**
   * è§£ææ•°æ®åº“è¡Œåˆ°å†å²è®°å½•é¡¹
   * @param row æ•°æ®åº“è¡Œ
   * @returns HistoryItem
   * @private
   */
  private parseHistoryRow(row: Record<string, any>): HistoryItem {
    try {
      const typedRow = row as Record<keyof HistoryItem, any>;
      return {
        id: TypeSafetyUtil.asString(typedRow.id, ''),
        mediaId: TypeSafetyUtil.asString(typedRow.mediaId, ''),
        siteKey: TypeSafetyUtil.asString(typedRow.siteKey, ''),
        title: TypeSafetyUtil.asString(typedRow.title, ''),
        cover: typedRow.cover ? TypeSafetyUtil.asString(typedRow.cover) : undefined,
        type: TypeSafetyUtil.asString(typedRow.type, 'video') as MediaType,
        episodeId: typedRow.episodeId ? TypeSafetyUtil.asString(typedRow.episodeId) : undefined,
        episodeTitle: typedRow.episodeTitle ? TypeSafetyUtil.asString(typedRow.episodeTitle) : undefined,
        progress: TypeSafetyUtil.asNumber(typedRow.progress, 0),
        duration: TypeSafetyUtil.asNumber(typedRow.duration, 0),
        lastPlayTime: TypeSafetyUtil.asNumber(typedRow.lastPlayTime, Date.now()),
        playCount: TypeSafetyUtil.asNumber(typedRow.playCount, 1),
        playSource: typedRow.playSource ? this.safeParseJson<PlaySource>(typedRow.playSource) : undefined,
        extra: typedRow.extra ? this.safeParseJson<HistoryExtraData>(typedRow.extra) : {} as HistoryExtraData
      };
    } catch (error) {
      Logger.error(this.TAG, 'Failed to parse history row', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      throw new Error(`Invalid history data format`);
    }
  }

  /**
   * å®‰å…¨åœ°è§£æJSONå­—ç¬¦ä¸?   * @param jsonString JSONå­—ç¬¦ä¸?   * @returns è§£æåçš„å¯¹è±¡æˆ–é»˜è®¤å€?   */
  private safeParseJson<T>(jsonString: Record<string, string | number | boolean | null>, defaultValue?: T): T {
    try {
      if (!jsonString || typeof jsonString !== 'string') {
        return defaultValue as T;
      }
      return JSON.parse(jsonString) as T;
    } catch (error) {
      Logger.warn(this.TAG, 'Failed to parse JSON', error instanceof Error ? error : new Error(String(error)));
      return defaultValue as T;
    }
  }

  /**
   * è§£æå¤šè¡Œæ•°æ®åº“è®°å½?   * @param rows æ•°æ®åº“è¡Œæ•°ç»„
   * @returns HistoryItem[]
   * @private
   */
  private parseHistoryRows(rows: Record<string, any>[]): HistoryItem[] {
    return rows.map(row => this.parseHistoryRow(row));
  }

  /**
   * æ¸…ç†è¿‡æœŸçš„å†å²è®°å½?   * @param keepDays ä¿ç•™å¤©æ•°
   * @returns Promise<number>
   */
  public async cleanupOldHistory(keepDays: number = 30): Promise<number> {
    try {
      const cutoffTime = Date.now() - (keepDays * 24 * 60 * 60 * 1000);
      const db = this.dbManager.getDatabase();
      
      const result = await db.executeSql(
        `DELETE FROM ${this.historyTable} WHERE lastPlayTime < ?`,
        [cutoffTime]
      );
      
      const deletedCount = result.affectedRows;
      if (deletedCount > 0) {
        Logger.info(this.TAG, `Cleaned up ${deletedCount} old history records older than ${keepDays} days`);
      }
      
      return deletedCount;
    } catch (error) {
      Logger.error(this.TAG, 'Failed to cleanup old history', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))))));
      return 0;
    }
  }
}

// å¯¼å‡ºå†å²è®°å½•æœåŠ¡å•ä¾‹
export const historyService = HistoryService.getInstance();


