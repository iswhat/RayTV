// NotificationService.ets - é€šçŸ¥æœåŠ¡
// åŸºäºHarmonyOSé€šçŸ¥APIå®ç°åº”ç”¨é€šçŸ¥ç®¡ç†

import Logger from '../../common/util/Logger';
import ConfigService from '../config/ConfigService';
import media from '@ohos.multimedia.media';
import notificationManager from '@ohos.notificationManager';
import BusinessError from '@ohos.base';

// å¸¸é‡å®šä¹‰
const TAG = 'NotificationService';
const NOTIFICATION_CHANNEL_ID = 'raytv_default_channel';
const NOTIFICATION_CHANNEL_NAME = 'RayTVé€šçŸ¥';
const NOTIFICATION_BUNDLE_NAME = 'com.raytv';

// é€šçŸ¥ç±»å‹æšä¸¾
export enum NotificationType {
  GENERAL = 'general',
  UPDATE = 'update',
  DOWNLOAD = 'download',
  PLAYBACK = 'playback',
  REMINDER = 'reminder',
  ERROR = 'error',
  SYSTEM = 'system',
  CUSTOM = 'custom'
}

// é€šçŸ¥ä¼˜å…ˆçº§æšä¸?export enum NotificationPriority {
  LOW = 0,
  DEFAULT = 1,
  HIGH = 2,
  MAXIMUM = 3
}

// é€šçŸ¥çº§åˆ«æšä¸¾
export enum NotificationLevel {
  MIN = notificationManager.SupportLevel.MIN,
  LOW = notificationManager.SupportLevel.LOW,
  DEFAULT = notificationManager.SupportLevel.DEFAULT,
  HIGH = notificationManager.SupportLevel.HIGH
}

// é€šçŸ¥æ“ä½œæŒ‰é’®æ¥å£
export interface NotificationAction {
  id: string;              // æ“ä½œID
  title: string;           // æŒ‰é’®æ ‡é¢˜
  icon?: number;           // æŒ‰é’®å›¾æ ‡
  actionData?: Record<string, string | number | boolean | null>;        // æ“ä½œæ•°æ®
}

// é€šçŸ¥å†…å®¹æ¥å£
export interface NotificationContent {
  title: string;           // é€šçŸ¥æ ‡é¢˜
  body: string;            // é€šçŸ¥å†…å®¹
  subtitle?: string;       // é€šçŸ¥å‰¯æ ‡é¢?  icon?: number | string;  // é€šçŸ¥å›¾æ ‡
  largeIcon?: number | string; // å¤§å›¾æ ?  image?: string;          // é€šçŸ¥å›¾ç‰‡
  sound?: boolean;         // æ˜¯å¦æ’­æ”¾å£°éŸ³
  vibrate?: boolean;       // æ˜¯å¦æŒ¯åŠ¨
  badge?: number;          // è§’æ ‡æ•°å­—
  actions?: NotificationAction[]; // æ“ä½œæŒ‰é’®
  data?: Record<string, string | number | boolean | null>;              // é™„åŠ æ•°æ®
  type?: NotificationType; // é€šçŸ¥ç±»å‹
  priority?: NotificationPriority; // ä¼˜å…ˆçº?  level?: NotificationLevel; // é€šçŸ¥çº§åˆ«
  autoCancel?: boolean;    // ç‚¹å‡»åè‡ªåŠ¨å–æ¶?  ongoing?: boolean;       // æ˜¯å¦ä¸ºæŒç»­é€šçŸ¥
  timeoutMs?: number;      // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  category?: string;       // é€šçŸ¥åˆ†ç±»
  visibility?: number;     // å¯è§æ€?}

// è¿›åº¦é€šçŸ¥é…ç½®æ¥å£
export interface ProgressNotificationConfig extends NotificationContent {
  progress: number;        // è¿›åº¦ï¼?-100ï¼?  maxProgress: number;     // æœ€å¤§è¿›åº?  indeterminate?: boolean; // æ˜¯å¦ä¸ºä¸ç¡®å®šè¿›åº¦
  titleFormat?: string;    // æ ‡é¢˜æ ¼å¼
  bodyFormat?: string;     // å†…å®¹æ ¼å¼
}

// ä¸‹è½½é€šçŸ¥é…ç½®æ¥å£
export interface DownloadNotificationConfig extends ProgressNotificationConfig {
  fileName: string;        // æ–‡ä»¶å?  downloadSpeed?: number;  // ä¸‹è½½é€Ÿåº¦ï¼ˆå­—èŠ?ç§’ï¼‰
  totalSize?: number;      // æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼?  remainingTime?: number;  // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼?  status?: 'downloading' | 'paused' | 'completed' | 'failed'; // ä¸‹è½½çŠ¶æ€?}

// é€šçŸ¥æœåŠ¡é…ç½®æ¥å£
export interface NotificationServiceConfig {
  enabled: boolean;        // æ˜¯å¦å¯ç”¨é€šçŸ¥
  soundEnabled: boolean;   // æ˜¯å¦å¯ç”¨å£°éŸ³
  vibrationEnabled: boolean; // æ˜¯å¦å¯ç”¨æŒ¯åŠ¨
  badgeEnabled: boolean;   // æ˜¯å¦å¯ç”¨è§’æ ‡
  headsUpEnabled: boolean; // æ˜¯å¦å¯ç”¨æ‚¬æµ®é€šçŸ¥
  reminderEnabled: boolean; // æ˜¯å¦å¯ç”¨æé†’
  notificationLevels: Record<NotificationType, NotificationLevel>; // å„ç±»å‹é€šçŸ¥çº§åˆ«
  channelSettings: Record<string, unknown>; // é€šçŸ¥æ¸ é“è®¾ç½®
}

// é»˜è®¤é€šçŸ¥æœåŠ¡é…ç½®
export const DEFAULT_NOTIFICATION_SERVICE_CONFIG: NotificationServiceConfig = {
  enabled: true,
  soundEnabled: true,
  vibrationEnabled: true,
  badgeEnabled: true,
  headsUpEnabled: true,
  reminderEnabled: true,
  notificationLevels: {
    [NotificationType.GENERAL]: NotificationLevel.DEFAULT,
    [NotificationType.UPDATE]: NotificationLevel.HIGH,
    [NotificationType.DOWNLOAD]: NotificationLevel.DEFAULT,
    [NotificationType.PLAYBACK]: NotificationLevel.DEFAULT,
    [NotificationType.REMINDER]: NotificationLevel.HIGH,
    [NotificationType.ERROR]: NotificationLevel.HIGH,
    [NotificationType.SYSTEM]: NotificationLevel.HIGH,
    [NotificationType.CUSTOM]: NotificationLevel.DEFAULT
  },
  channelSettings: {}
};

// é€šçŸ¥ç‚¹å‡»å›è°ƒç±»å‹
type NotificationClickCallback = (notificationId: string, actionId?: string, data?: Record<string, string | number | boolean | null>) => void;
  type NotificationActionCallback = (actionId: string, data?: Record<string, string | number | boolean | null>) => void;

export default class NotificationService {
  private static instance: NotificationService;
  private configService: ConfigService;
  private config: NotificationServiceConfig = DEFAULT_NOTIFICATION_SERVICE_CONFIG;
  private notificationIdCounter: number = 0;
  private activeNotifications: Map<string, notificationManager.NotificationRequest> = new Map();
  private clickCallbacks: Map<string, NotificationClickCallback> = new Map();
  private actionCallbacks: Map<string, NotificationActionCallback> = new Map();
  private isInitialized: boolean = false;
  private hasPermission: boolean = false;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): NotificationService {
    if (!NotificationService.instance) {
      NotificationService.instance = new NotificationService();
    }
    return NotificationService.instance;
  }

  /**
   * æ„é€ å‡½æ•?   */
  private constructor() {
    this.configService = ConfigService.getInstance();
  }

  /**
   * åˆå§‹åŒ–é€šçŸ¥æœåŠ¡
   * @param context åº”ç”¨ä¸Šä¸‹æ–?   */
  public async initialize(context: Context): Promise<void> {
    if (this.isInitialized) {
      Logger.info(TAG, 'Notification service already initialized');
      return;
    }

    try {
      Logger.info(TAG, 'Initializing notification service...');

      // æ£€æŸ¥é€šçŸ¥æƒé™
      await this.checkPermission();
      
      if (!this.hasPermission) {
        Logger.warn(TAG, 'Notification permission not granted');
        return;
      }

      // åŠ è½½é…ç½®
      await this.loadConfig();
      
      // åˆ›å»ºé€šçŸ¥æ¸ é“
      await this.createNotificationChannel();
      
      // æ³¨å†Œé€šçŸ¥å“åº”å›è°ƒ
      await this.registerNotificationCallback();
      
      this.isInitialized = true;
      Logger.info(TAG, 'Notification service initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize notification service: ${JSON.stringify(error)}`);
      throw error;
    }
  }

  /**
   * æ£€æŸ¥é€šçŸ¥æƒé™
   */
  private async checkPermission(): Promise<void> {
    try {
      const hasPerm = await notificationManager.checkPermission();
      this.hasPermission = hasPerm === 0; // 0è¡¨ç¤ºæœ‰æƒé™?      
      if (!this.hasPermission) {
        Logger.warn(TAG, 'Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted' : new Error(String('Notification permission not granted' instanceof Error ? 'Notification permission not granted' : new Error(String('Notification permission not granted')))))));
      }
    } catch (error) {
      Logger.error(TAG, `Failed to check notification permission: ${error}`);
      this.hasPermission = false;
    }
  }

  /**
   * è¯·æ±‚é€šçŸ¥æƒé™
   */
  public async requestPermission(): Promise<boolean> {
    try {
      // è¯·æ±‚é€šçŸ¥æƒé™
      const result = await notificationManager.requestPermission();
      this.hasPermission = result === 0;
      
      if (this.hasPermission) {
        Logger.info(TAG, 'Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted' : new Error(String('Notification permission granted' instanceof Error ? 'Notification permission granted' : new Error(String('Notification permission granted')))))));
        if (!this.isInitialized) {
          // å¦‚æœåˆå§‹åŒ–å¤±è´¥æ˜¯å› ä¸ºæƒé™é—®é¢˜ï¼Œç°åœ¨é‡æ–°åˆå§‹åŒ–
          await this.createNotificationChannel();
          await this.registerNotificationCallback();
          this.isInitialized = true;
        }
      }
      
      return this.hasPermission;
    } catch (error) {
      Logger.error(TAG, `Failed to request notification permission: ${error}`);
      return false;
    }
  }

  /**
   * åŠ è½½é…ç½®
   */
  private async loadConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig('notificationServiceConfig', DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG instanceof Error ? DEFAULT_NOTIFICATION_SERVICE_CONFIG : new Error(String(DEFAULT_NOTIFICATION_SERVICE_CONFIG)))))));
      if (savedConfig) {
        this.config = { ...DEFAULT_NOTIFICATION_SERVICE_CONFIG, ...savedConfig };
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load notification service config: ${error}`);
    }
  }

  /**
   * ä¿å­˜é…ç½®
   */
  public async saveConfig(config: Partial<NotificationServiceConfig>): Promise<void> {
    try {
      this.config = { ...this.config, ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('notificationServiceConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('notificationServiceConfig', this.config)))))));
      
      // å¦‚æœç¦ç”¨äº†é€šçŸ¥ï¼Œå–æ¶ˆæ‰€æœ‰æ´»è·ƒé€šçŸ¥
      if (!this.config.enabled) {
        await this.cancelAll();
      }
    } catch (error) {
      Logger.error(TAG, `Failed to save notification service config: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–é…ç½®
   */
  public getConfig(): NotificationServiceConfig {
    return { ...this.config };
  }

  /**
   * åˆ›å»ºé€šçŸ¥æ¸ é“
   */
  private async createNotificationChannel(): Promise<void> {
    try {
      const channel: Record<string, string | number | boolean | null> = { ... };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? string | number | boolean | null> = { ... };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(string | number | boolean | null> = { ... };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel instanceof Error ? name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel : new Error(String(name: NOTIFICATION_CHANNEL_NAME,
        description: 'RayTVåº”ç”¨é€šçŸ¥æ¸ é“',
        importance: notificationManager.Importance.HIGH,
        enableLights: true,
        enableVibration: this.config.vibrationEnabled,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: 0xFF0000,
        bypassDnd: true,
        enableSound: this.config.soundEnabled
      };
      
      await notificationManager.createNotificationChannel(channel)))))));
      Logger.info(TAG, 'Notification channel created');
    } catch (error) {
      Logger.error(TAG, `Failed to create notification channel: ${error}`);
    }
  }

  /**
   * æ³¨å†Œé€šçŸ¥å“åº”å›è°ƒ
   */
  private async registerNotificationCallback(): Promise<void> {
    try {
      await notificationManager.on('notificationResponse', (response instanceof Error ? (response : new Error(String((response instanceof Error ? (response instanceof Error ? (response : new Error(String((response : new Error(String((response instanceof Error ? (response : new Error(String((response instanceof Error ? (response instanceof Error ? (response : new Error(String((response instanceof Error ? (response instanceof Error ? (response : new Error(String((response : new Error(String((response instanceof Error ? (response : new Error(String((response : new Error(String((response instanceof Error ? (response : new Error(String((response instanceof Error ? (response instanceof Error ? (response : new Error(String((response : new Error(String((response instanceof Error ? (response : new Error(String((response))))))) => {
        const notificationId = String(response.requestId);
        const actionId = response.actionType === notificationManager.ActionType.BUTTON ? response.actionData?.data?.actionId : undefined;
        
        Logger.debug(TAG, `Notification response: ${notificationId}, action: ${actionId}`);
        
        // è§¦å‘ç‚¹å‡»å›è°ƒ
        const callback = this.clickCallbacks.get(notificationId);
        if (callback) {
          try {
            callback(notificationId, actionId, response.actionData?.data);
          } catch (error) {
            Logger.error(TAG, `Error in notification click callback: ${error}`);
          }
          
          // å¦‚æœæ˜¯è‡ªåŠ¨å–æ¶ˆï¼Œç§»é™¤å›è°ƒ
          const notification = this.activeNotifications.get(notificationId);
          if (notification?.autoCancel) {
            this.clickCallbacks.delete(notificationId);
          }
        }
      });
    } catch (error) {
      Logger.error(TAG, `Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}` instanceof Error ? `Failed to register notification callback: ${error}` : new Error(String(`Failed to register notification callback: ${error}`)))))));
    }
  }

  /**
   * å‘é€æ™®é€šé€šçŸ¥
   */
  public async sendNotification(content: NotificationContent): Promise<string> {
    if (!this.canSendNotification()) {
      Logger.warn(TAG, 'Cannot send notification: service not initialized or disabled');
      return '';
    }

    try {
      // ç”Ÿæˆé€šçŸ¥ID
      const notificationId = this.generateNotificationId();
      
      // æ„å»ºé€šçŸ¥å†…å®¹
      const notificationContent = this.buildNotificationContent(content);
      
      // åˆ›å»ºé€šçŸ¥è¯·æ±‚
      const notificationRequest: notificationManager.NotificationRequest = {
        id: parseInt(notificationId),
        content: notificationContent,
        deliveryTime: Date.now(),
        autoCancel: content.autoCancel ?? true,
        isOngoing: content.ongoing ?? false,
        channelId: NOTIFICATION_CHANNEL_ID,
        badgeIconStyle: notificationManager.BadgeIconStyle.SMALL,
        level: content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL],
        isUnremovable: content.ongoing ?? false,
        tapDismissed: content.autoCancel ?? true,
        notificationCount: content.badge,
        requestAsync: false
      };
      
      // æ·»åŠ æ“ä½œæŒ‰é’®
      if (content.actions && content.actions.length > 0) {
        notificationContent.buttons = content.actions.map(action => ({
          title: action.title,
          actionData: {
            data: {
              actionId: action.id,
              ...action.actionData
            }
          },
          type: notificationManager.ButtonType. COMMON_BUTTON
        }));
      }
      
      // å‘é€é€šçŸ¥
      await notificationManager.publish(notificationRequest);
      
      // ä¿å­˜æ´»è·ƒé€šçŸ¥
      this.activeNotifications.set(notificationId, notificationRequest);
      
      Logger.info(TAG, `Notification sent: ${notificationId}`);
      return notificationId;
    } catch (error) {
      Logger.error(TAG, `Failed to send notification: ${error}`);
      return '';
    }
  }

  /**
   * æ„å»ºé€šçŸ¥å†…å®¹
   */
  private buildNotificationContent(content: NotificationContent): notificationManager.NotificationContent {
    const notificationContent: notificationManager.NotificationContent = {
      contentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT, normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image instanceof Error ? normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image : new Error(String(normal: {
        title: content.title,
        text: content.body,
        additionalText: content.subtitle
      }
    };
    
    // è®¾ç½®é€šçŸ¥çº§åˆ«
    notificationContent.level = content.level ?? this.config.notificationLevels[content.type || NotificationType.GENERAL];
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¤šè¡Œæ–‡æœ¬ç±»å‹
    if (content.image))))))) {
      notificationContent.contentType = notificationManager.ContentType.NOTIFICATION_CONTENT_LONG_TEXT;
      notificationContent.longText = {
        title: content.title,
        text: content.body,
        briefText: content.subtitle || content.body,
        expandedTitle: content.title,
        expandedText: content.body,
        bigPicture: {
          uri: content.image,
          sourceType: 1 // ç½‘ç»œå›¾ç‰‡
        }
      };
    }
    
    return notificationContent;
  }

  /**
   * å‘é€è¿›åº¦é€šçŸ¥
   */
  public async sendProgressNotification(config: ProgressNotificationConfig): Promise<string> {
    if (!this.canSendNotification()) {
      return '';
    }

    try {
      const notificationId = this.generateNotificationId();
      
      // æ„å»ºè¿›åº¦é€šçŸ¥å†…å®¹
      const progressBar = {
        progress: config.progress,
        maxProgress: config.maxProgress,
        indeterminate: config.indeterminate ?? false,
        progressText: `${config.progress}%`
      };
      
      const content: notificationManager.NotificationContent = {
        contentType: notificationManager.ContentType.NOTIFICATION_CONTENT_PROGRESS_BAR,
        progressBar: {
          title: this.formatProgressText(config.titleFormat || config.title, config),
          text: this.formatProgressText(config.bodyFormat || config.body, config),
          progress: progressBar.progress,
          maxProgress: progressBar.maxProgress,
          indeterminate: progressBar.indeterminate
        }
      };
      
      const notificationRequest: notificationManager.NotificationRequest = {
        id: parseInt(notificationId),
        content,
        deliveryTime: Date.now(),
        autoCancel: config.autoCancel ?? false,
        isOngoing: config.ongoing ?? true,
        channelId: NOTIFICATION_CHANNEL_ID,
        badgeIconStyle: notificationManager.BadgeIconStyle.SMALL,
        level: config.level ?? this.config.notificationLevels[NotificationType.DOWNLOAD]
      };
      
      await notificationManager.publish(notificationRequest);
      this.activeNotifications.set(notificationId, notificationRequest);
      
      Logger.info(TAG, `Progress notification sent: ${notificationId}`);
      return notificationId;
    } catch (error) {
      Logger.error(TAG, `Failed to send progress notification: ${error}`);
      return '';
    }
  }

  /**
   * å‘é€ä¸‹è½½é€šçŸ¥
   */
  public async sendDownloadNotification(config: DownloadNotificationConfig): Promise<string> {
    if (!this.canSendNotification()) {
      return '';
    }

    try {
      // é»˜è®¤æ ‡é¢˜å’Œå†…å®¹æ ¼å¼?      const defaultTitleFormat = 'æ­£åœ¨ä¸‹è½½: {{fileName}}';
      const defaultBodyFormat = '{{statusText}} - {{progress}}% ({{speed}})';
      
      // çŠ¶æ€æ–‡æœ¬æ˜ å°?      const statusTextMap: Record<string, string | number | boolean | null> = { ... };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? string | number | boolean | null> = { ... };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String(string | number | boolean | null> = { ... };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number instanceof Error ? 'paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number : new Error(String('paused': 'å·²æš‚å?,
        'completed': 'ä¸‹è½½å®Œæˆ',
        'failed': 'ä¸‹è½½å¤±è´¥'
      };
      
      // æ ¼å¼åŒ–é€Ÿåº¦
      const formatSpeed = (speed: number))))))): string => {
        if (speed < 1024) return `${speed} B/s`;
        if (speed < 1024 * 1024) return `${(speed / 1024).toFixed(1)} KB/s`;
        return `${(speed / (1024 * 1024)).toFixed(1)} MB/s`;
      };
      
      // æ‰©å±•é…ç½®
      const extendedConfig: Record<string, string | number | boolean | null> = { ... };
      
      // å¦‚æœä¸‹è½½å®Œæˆï¼Œè½¬ä¸ºæ™®é€šé€šçŸ¥
      if (config.status === 'completed' || config.status === 'failed') {
        const notificationContent: NotificationContent = {
          title: this.formatProgressText(extendedConfig.titleFormat, extendedConfig),
          body: this.formatProgressText(extendedConfig.bodyFormat, extendedConfig),
          type: NotificationType.DOWNLOAD,
          autoCancel: config.autoCancel ?? true,
          ongoing: false,
          level: config.level
        };
        
        // æ·»åŠ æ“ä½œæŒ‰é’®
        if (config.status === 'completed') {
          notificationContent.actions = [
            {
              id: 'open_file',
              title: 'æ‰“å¼€æ–‡ä»¶',
              actionData: { fileName: config.fileName }
            }
          ];
        }
        
        return this.sendNotification(notificationContent);
      }
      
      // å¦åˆ™å‘é€è¿›åº¦é€šçŸ¥
      return this.sendProgressNotification(extendedConfig);
    } catch (error) {
      Logger.error(TAG, `Failed to send download notification: ${error}`);
      return '';
    }
  }

  /**
   * æ ¼å¼åŒ–è¿›åº¦æ–‡æœ?   */
  private formatProgressText(format: string, config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null> instanceof Error ? config: Record<string, string | number | boolean | null> : new Error(String(config: Record<string, string | number | boolean | null>))))))): string {
    return format
      .replace('{{fileName}}', config.fileName || '')
      .replace('{{progress}}', config.progress || 0)
      .replace('{{statusText}}', config.statusText || '')
      .replace('{{speed}}', config.speed || '');
  }

  /**
   * æ›´æ–°é€šçŸ¥
   */
  public async updateNotification(notificationId: string, content: NotificationContent): Promise<boolean> {
    try {
      // å…ˆå–æ¶ˆæ—§é€šçŸ¥
      await this.cancelNotification(notificationId);
      
      // å‘é€æ–°é€šçŸ¥ï¼Œä¿æŒå›è°?      const callback = this.clickCallbacks.get(notificationId);
      const newId = await this.sendNotification(content);
      
      if (newId && callback) {
        this.clickCallbacks.set(newId, callback);
        this.clickCallbacks.delete(notificationId);
      }
      
      return !!newId;
    } catch (error) {
      Logger.error(TAG, `Failed to update notification ${notificationId}: ${error}`);
      return false;
    }
  }

  /**
   * æ›´æ–°è¿›åº¦é€šçŸ¥
   */
  public async updateProgressNotification(notificationId: string, progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string : new Error(String(progress: number, status?: string instanceof Error ? progress: number, status?: string : new Error(String(progress: number, status?: string))))))): Promise<boolean> {
    try {
      const notification = this.activeNotifications.get(notificationId);
      if (!notification || !notification.content.progressBar) {
        return false;
      }
      
      // æ›´æ–°è¿›åº¦
      notification.content.progressBar.progress = progress;
      
      \n      // æ›´æ–°é€šçŸ¥
      await notificationManager.publish(notification);
      
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to update progress notification ${notificationId}: ${error}`);
      return false;
    }
  }

  /**
   * å–æ¶ˆé€šçŸ¥
   */
  public async cancelNotification(notificationId: string): Promise<void> {
    try {
      await notificationManager.cancel(parseInt(notificationId));
      
      // ç§»é™¤æ´»è·ƒé€šçŸ¥å’Œå›è°?      this.activeNotifications.delete(notificationId);
      this.clickCallbacks.delete(notificationId);
      
      Logger.debug(TAG, `Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}` instanceof Error ? `Notification cancelled: ${notificationId}` : new Error(String(`Notification cancelled: ${notificationId}`)))))));
    } catch (error) {
      Logger.error(TAG, `Failed to cancel notification ${notificationId}: ${error}`);
    }
  }

  /**
   * å–æ¶ˆæ‰€æœ‰é€šçŸ¥
   */
  public async cancelAll(): Promise<void> {
    try {
      await notificationManager.cancelAll();
      
      // æ¸…ç©ºæ‰€æœ‰æ´»è·ƒé€šçŸ¥å’Œå›è°?      this.activeNotifications.clear();
      this.clickCallbacks.clear();
      
      Logger.info(TAG, 'All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled' : new Error(String('All notifications cancelled' instanceof Error ? 'All notifications cancelled' : new Error(String('All notifications cancelled')))))));
    } catch (error) {
      Logger.error(TAG, `Failed to cancel all notifications: ${error}`);
    }
  }

  /**
   * è®¾ç½®é€šçŸ¥ç‚¹å‡»å›è°ƒ
   */
  public setNotificationClickCallback(notificationId: string, callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback instanceof Error ? callback: NotificationClickCallback : new Error(String(callback: NotificationClickCallback))))))): void {
    this.clickCallbacks.set(notificationId, callback);
  }

  /**
   * ç§»é™¤é€šçŸ¥ç‚¹å‡»å›è°ƒ
   */
  public removeNotificationClickCallback(notificationId: string): void {
    this.clickCallbacks.delete(notificationId);
  }

  /**
   * ç”Ÿæˆé€šçŸ¥ID
   */
  private generateNotificationId(): string {
    this.notificationIdCounter++;
    return `${Date.now()}_${this.notificationIdCounter}`;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€é€šçŸ¥
   */
  private canSendNotification(): boolean {
    return this.isInitialized && this.config.enabled && this.hasPermission;
  }

  /**
   * è·å–æ´»è·ƒé€šçŸ¥æ•°é‡
   */
  public getActiveNotificationCount(): number {
    return this.activeNotifications.size;
  }

  /**
   * è®¾ç½®åº”ç”¨è§’æ ‡
   */
  public async setBadgeNumber(count: number): Promise<void> {
    if (!this.config.badgeEnabled || !this.hasPermission) {
      return;
    }

    try {
      await notificationManager.setBadgeCount({ badgeCount: count });
      Logger.debug(TAG, `Badge number set to: ${count}`);
    } catch (error) {
      Logger.error(TAG, `Failed to set badge number: ${error}`);
    }
  }

  /**
   * æ¸…é™¤åº”ç”¨è§’æ ‡
   */
  public async clearBadge(): Promise<void> {
    await this.setBadgeNumber(0);
  }

  /**
   * å‘é€æé†’é€šçŸ¥
   */
  public async sendReminder(title: string, message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date instanceof Error ? message: string, remindTime?: Date : new Error(String(message: string, remindTime?: Date))))))): Promise<string> {
    const content: NotificationContent = {
      title,
      body: message,
      type: NotificationType.REMINDER,
      priority: NotificationPriority.HIGH,
      level: NotificationLevel.HIGH,
      sound: this.config.soundEnabled,
      vibrate: this.config.vibrationEnabled,
      autoCancel: true
    };
    
    return this.sendNotification(content);
  }

  /**
   * å‘é€é”™è¯¯é€šçŸ¥
   */
  public async sendErrorNotification(title: string, errorMessage: string, autoCancel: boolean = true): Promise<string> {
    const content: NotificationContent = {
      title,
      body: errorMessage,
      type: NotificationType.ERROR,
      priority: NotificationPriority.HIGH,
      level: NotificationLevel.HIGH,
      sound: this.config.soundEnabled,
      vibrate: this.config.vibrationEnabled,
      autoCancel
    };
    
    return this.sendNotification(content);
  }

  /**
   * å‘é€ç³»ç»Ÿé€šçŸ¥
   */
  public async sendSystemNotification(title: string, message: string): Promise<string> {
    const content: NotificationContent = {
      title,
      body: message,
      type: NotificationType.SYSTEM,
      priority: NotificationPriority.HIGH,
      level: NotificationLevel.HIGH,
      sound: this.config.soundEnabled,
      vibrate: this.config.vibrationEnabled,
      autoCancel: true
    };
    
    return this.sendNotification(content);
  }

  /**
   * å…³é—­é€šçŸ¥æœåŠ¡
   */
  public close(): void {
    if (!this.isInitialized) {
      return;
    }

    // å–æ¶ˆæ‰€æœ‰é€šçŸ¥
    this.cancelAll().catch(error => {
      Logger.error(TAG, `Error cancelling notifications on close: ${error}`);
    });

    this.isInitialized = false;
    Logger.info(TAG, 'Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed' : new Error(String('Notification service closed' instanceof Error ? 'Notification service closed' : new Error(String('Notification service closed')))))));
  }
}


