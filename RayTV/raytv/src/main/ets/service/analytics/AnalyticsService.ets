// æ•°æ®åˆ†ææœåŠ¡
// æä¾›ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ã€é¡µé¢è®¿é—®è¿½è¸ªã€æ’­æ”¾ç»Ÿè®¡ç­‰åŠŸèƒ½

import { StorageUtil } from '../../common/util/StorageUtil';
import { HttpService } from '../HttpService';

export class AnalyticsService {
  private static instance: AnalyticsService;
  private storageUtil: StorageUtil;
  private httpService: HttpService;
  private eventQueue: AnalyticsEvent[] = [];
  private isEnabled: boolean = true;
  private userId: string;
  private sessionId: string;
  private sessionStartTime: number;

  private constructor() {
    this.storageUtil = StorageUtil.getInstance();
    this.httpService = HttpService.getInstance();
    this.initialize();
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): AnalyticsService {
    if (!AnalyticsService.instance) {
      AnalyticsService.instance = new AnalyticsService();
    }
    return AnalyticsService.instance;
  }

  /**
   * åˆå§‹åŒ–åˆ†ææœåŠ?   */
  public async initialize(): Promise<void> {
    // åŠ è½½é…ç½®
    const config = await this.storageUtil.get<{ enabled: boolean }>('analyticsConfig', { enabled: true });
    this.isEnabled = config.enabled;

    // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·ID
    this.userId = await this.storageUtil.get<string>('userId', this.generateId());
    await this.storageUtil.save('userId', this.userId);

    // åˆ›å»ºæ–°ä¼šè¯?    this.createNewSession();

    // å¼€å§‹è‡ªåŠ¨ä¸ŠæŠ?    this.startAutoReport();
  }

  /**
   * åˆ›å»ºæ–°ä¼šè¯?   */
  private createNewSession(): void {
    this.sessionId = this.generateId();
    this.sessionStartTime = Date.now();
  }

  /**
   * ç”Ÿæˆå”¯ä¸€ID
   */
  private generateId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  /**
   * å¼€å§‹è‡ªåŠ¨ä¸ŠæŠ?   */
  private startAutoReport(): void {
    // æ¯?0ç§’ä¸ŠæŠ¥ä¸€æ¬¡äº‹ä»¶é˜Ÿåˆ?    setInterval(() => {
      this.reportEvents();
    }, 30000);

    // åº”ç”¨è¿›å…¥åå°æ—¶ä¸ŠæŠ?    // åœ¨é¸¿è’™ç³»ç»Ÿä¸­ç›‘å¬åº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
    // è¿™é‡Œéœ€è¦æ³¨å†Œåˆ°åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸç›‘å¬ä¸­
  }

  /**
   * è®°å½•é¡µé¢è®¿é—®
   * @param pageName é¡µé¢åç§°
   * @param params é¢å¤–å‚æ•°
   */
  public trackPageView(pageName: string, params?: Record<string, unknown>): void {
    if (!this.isEnabled) return;

    const event: AnalyticsEvent = {
      eventName: 'page_view',
      timestamp: Date.now(),
      userId: this.userId,
      sessionId: this.sessionId,
      properties: {
        page_name: pageName,
        ...params
      }
    };

    this.addToQueue(event);
  }

  /**
   * è®°å½•è§†é¢‘æ’­æ”¾
   * @param videoId è§†é¢‘ID
   * @param siteKey ç«™ç‚¹é”?   * @param params æ’­æ”¾å‚æ•°
   */
  public trackVideoPlay(videoId: string, siteKey: string, params?: VideoPlayParams): void {
    if (!this.isEnabled) return;

    const event: AnalyticsEvent = {
      eventName: 'video_play',
      timestamp: Date.now(),
      userId: this.userId,
      sessionId: this.sessionId,
      properties: {
        video_id: videoId,
        site_key: siteKey,
        ...params
      }
    };

    this.addToQueue(event);
  }

  /**
   * è®°å½•è§†é¢‘æ’­æ”¾å®Œæˆ
   * @param videoId è§†é¢‘ID
   * @param duration æ’­æ”¾æ—¶é•¿
   * @param params é¢å¤–å‚æ•°
   */
  public trackVideoComplete(videoId: string, duration: number, params?: Record<string, unknown>): void {
    if (!this.isEnabled) return;

    const event: AnalyticsEvent = {
      eventName: 'video_complete',
      timestamp: Date.now(),
      userId: this.userId,
      sessionId: this.sessionId,
      properties: {
        video_id: videoId,
        duration: duration,
        ...params
      }
    };

    this.addToQueue(event);
  }

  /**
   * è®°å½•æœç´¢äº‹ä»¶
   * @param keyword æœç´¢å…³é”®è¯?   * @param siteKey ç«™ç‚¹é”?   * @param resultCount ç»“æœæ•°é‡
   */
  public trackSearch(keyword: string, siteKey?: string, resultCount: number = 0): void {
    if (!this.isEnabled) return;

    const event: AnalyticsEvent = {
      eventName: 'search',
      timestamp: Date.now(),
      userId: this.userId,
      sessionId: this.sessionId,
      properties: {
        keyword: keyword,
        site_key: siteKey,
        result_count: resultCount
      }
    };

    this.addToQueue(event);
  }

  /**
   * è®°å½•æ”¶è—äº‹ä»¶
   * @param itemId æ”¶è—é¡¹ID
   * @param itemType æ”¶è—é¡¹ç±»å?   */
  public trackFavorite(itemId: string, itemType: 'vod' | 'live'): void {
    if (!this.isEnabled) return;

    const event: AnalyticsEvent = {
      eventName: 'favorite',
      timestamp: Date.now(),
      userId: this.userId,
      sessionId: this.sessionId,
      properties: {
        item_id: itemId,
        item_type: itemType
      }
    };

    this.addToQueue(event);
  }

  /**
   * è®°å½•é”™è¯¯äº‹ä»¶
   * @param errorType é”™è¯¯ç±»å‹
   * @param message é”™è¯¯æ¶ˆæ¯
   * @param context é”™è¯¯ä¸Šä¸‹æ–?   */
  public trackError(errorType: string, message: string, context?: Record<string, unknown>): void {
    if (!this.isEnabled) return;

    const event: AnalyticsEvent = {
      eventName: 'error',
      timestamp: Date.now(),
      userId: this.userId,
      sessionId: this.sessionId,
      properties: {
        error_type: errorType,
        error_message: message,
        context: context
      }
    };

    this.addToQueue(event);
  }

  /**
   * æ·»åŠ äº‹ä»¶åˆ°é˜Ÿåˆ?   * @param event åˆ†æäº‹ä»¶
   */
  private addToQueue(event: AnalyticsEvent): void {
    this.eventQueue.push(event);

    // å¦‚æœé˜Ÿåˆ—è¶…è¿‡100ä¸ªäº‹ä»¶ï¼Œç«‹å³ä¸ŠæŠ¥
    if (this.eventQueue.length >= 100) {
      this.reportEvents();
    }
  }

  /**
   * ä¸ŠæŠ¥äº‹ä»¶
   */
  private async reportEvents(): Promise<void> {
    if (this.eventQueue.length === 0) return;

    const eventsToReport = [...this.eventQueue];
    this.eventQueue = [];

    try {
      // è¿™é‡Œåº”è¯¥å‘é€åˆ°åˆ†ææœåŠ¡å™?      // ç”±äºæ˜¯æœ¬åœ°å®ç°ï¼Œå¯ä»¥ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨æˆ–æ—¥å¿—æ–‡ä»¶
      // æ¨¡æ‹Ÿä¸ŠæŠ¥
      // await this.httpService.post('https://analytics-api.example.com/events', {
      //   events: eventsToReport
      // });

      // ä¿å­˜åˆ°æœ¬åœ°æ—¥å¿?      await this.saveEventsToLog(eventsToReport);
    } catch (error: Error) {
      // ä¸ŠæŠ¥å¤±è´¥ï¼Œå°†äº‹ä»¶é‡æ–°åŠ å…¥é˜Ÿåˆ—
      // ä¸ŠæŠ¥å¤±è´¥ï¼Œå°†äº‹ä»¶é‡æ–°åŠ å…¥é˜Ÿåˆ—
      this.eventQueue = [...eventsToReport, ...this.eventQueue];
    }
  }

  /**
   * ä¿å­˜äº‹ä»¶åˆ°æœ¬åœ°æ—¥å¿?   * @param events äº‹ä»¶åˆ—è¡¨
   */
  private async saveEventsToLog(events: AnalyticsEvent[]): Promise<void> {
    try {
      const logKey = `analytics_log_${new Date().toISOString().split('T')[0]}`;
      const existingLogs = await this.storageUtil.get<string>(logKey, '');
      const newLogs = events.map(e => JSON.stringify(e)).join('\n');
      await this.storageUtil.save(logKey, existingLogs + newLogs + '\n');
    } catch (error: Error) {
      // ä¿å­˜æ—¥å¿—å¤±è´¥
    }
  }

  /**
   * å¯ç”¨/ç¦ç”¨åˆ†æ
   * @param enabled æ˜¯å¦å¯ç”¨
   */
  public async setEnabled(enabled: boolean): Promise<void> {
    this.isEnabled = enabled;
    await this.storageUtil.save('analyticsConfig', { enabled });
  }

  /**
   * è·å–åˆ†æçŠ¶æ€?   */
  public getEnabled(): boolean {
    return this.isEnabled;
  }

  /**
   * æ¸…é™¤æ‰€æœ‰æ•°æ?   */
  public async clearData(): Promise<void> {
    this.eventQueue = [];
    this.createNewSession();
    await this.storageUtil.remove('userId');
    this.userId = this.generateId();
    await this.storageUtil.save('userId', this.userId);
  }

  /**
   * è·å–ä½¿ç”¨ç»Ÿè®¡æ‘˜è¦
   */
  public async getUsageSummary(): Promise<UsageSummary> {
    const today = new Date().toISOString().split('T')[0];
    const logKey = `analytics_log_${today}`;
    const logs = await this.storageUtil.get<string>(logKey, '');
    
    let totalPlays = 0;
    let totalPages = 0;
    let totalSearches = 0;

    if (logs) {
      const logLines = logs.split('\n');
      for (const line of logLines) {
        if (!line) continue;
        try {
          const event = JSON.parse(line) as AnalyticsEvent;
          switch (event.eventName) {
            case 'video_play':
              totalPlays++;
              break;
            case 'page_view':
              totalPages++;
              break;
            case 'search':
              totalSearches++;
              break;
          }
        } catch (e: Error) {
          // å¿½ç•¥è§£æé”™è¯¯
        }
      }
    }

    return {
      userId: this.userId,
      sessionId: this.sessionId,
      sessionStartTime: this.sessionStartTime,
      totalPlays,
      totalPages,
      totalSearches,
      sessionDuration: Date.now() - this.sessionStartTime
    };
  }
}

/**
 * åˆ†æäº‹ä»¶
 */
export interface AnalyticsEvent {
  eventName: string;
  timestamp: number;
  userId: string;
  sessionId: string;
  properties: Record<string, unknown>;
}

/**
 * è§†é¢‘æ’­æ”¾å‚æ•°
 */
export interface VideoPlayParams {
  episode_name?: string;
  position?: number;
  duration?: number;
  quality?: string;
}

/**
 * ä½¿ç”¨ç»Ÿè®¡æ‘˜è¦
 */
export interface UsageSummary {
  userId: string;
  sessionId: string;
  sessionStartTime: number;
  totalPlays: number;
  totalPages: number;
  totalSearches: number;
  sessionDuration: number;
}
