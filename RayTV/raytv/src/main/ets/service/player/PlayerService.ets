// PlayerService.ets - æ’­æ”¾å™¨æœåŠ?// åŸºäºHarmonyOS AVPlayer APIå®ç°åª’ä½“æ’­æ”¾åŠŸèƒ½ï¼Œæä¾›ç»Ÿä¸€çš„æ’­æ”¾å™¨æ¥å£

import Logger from '../../common/util/Logger';
import { AVPlayerService, AVPlayerServiceInstance } from '../playback/AVPlayerService';

// æ’­æ”¾å™¨çŠ¶æ€æšä¸?export enum PlayerStatus {
  IDLE = 'IDLE',
  INITIALIZED = 'INITIALIZED',
  PREPARING = 'PREPARING',
  PREPARED = 'PREPARED',
  PLAYING = 'PLAYING',
  PAUSED = 'PAUSED',
  STOPPED = 'STOPPED',
  COMPLETED = 'COMPLETED',
  ERROR = 'ERROR'
}

// æ’­æ”¾å™¨äº‹ä»¶æšä¸?export enum PlayerEvent {
  STATUS_CHANGED = 'status_changed',
  TIME_UPDATE = 'time_update',
  BUFFER_UPDATE = 'buffer_update',
  ERROR = 'error',
  COMPLETED = 'completed'
}

// æ’­æ”¾å™¨é…ç½®æ¥å?export interface PlayerConfig {
  autoPlay: boolean;
  loop: boolean;
  muted: boolean;
  volume: number;
  playbackRate: number;
  startPosition: number;
}

// é»˜è®¤æ’­æ”¾å™¨é…ç½?export const DEFAULT_PLAYER_CONFIG: PlayerConfig = {
  autoPlay: false,
  loop: false,
  muted: false,
  volume: 1.0,
  playbackRate: 1.0,
  startPosition: 0
};

// æ’­æ”¾å™¨äº‹ä»¶æ•°æ®ç±»å‹æ˜ å°?interface PlayerEventDataMap {
  [PlayerEvent.STATUS_CHANGED]: PlayerStatus;
  [PlayerEvent.TIME_UPDATE]: number;
  [PlayerEvent.BUFFER_UPDATE]: number;
  [PlayerEvent.ERROR]: {code: number; message: string};
  [PlayerEvent.COMPLETED]: void;
}

// æ’­æ”¾å™¨äº‹ä»¶ç›‘å¬å™¨ç±»å‹
type PlayerEventListener = <E extends PlayerEvent>(event: E, data: PlayerEventDataMap[E]) => void;

// å­—å¹•æ ·å¼æ¥å£
export interface SubtitleStyle {
  fontSize: number;
  fontColor: string;
  backgroundColor: string;
  backgroundOpacity: number;
  borderColor: string;
  borderWidth: number;
  position: 'bottom' | 'top';
}

// é»˜è®¤å­—å¹•æ ·å¼
export const DEFAULT_SUBTITLE_STYLE: SubtitleStyle = {
  fontSize: 16,
  fontColor: '#FFFFFF',
  backgroundColor: '#000000',
  backgroundOpacity: 0.7,
  borderColor: '#000000',
  borderWidth: 1,
  position: 'bottom'
};

export default class PlayerService {
  private static instance: PlayerService;
  private avPlayerService: AVPlayerService;
  private config: PlayerConfig = DEFAULT_PLAYER_CONFIG;
  private currentMediaId: string = '';
  private currentEpisodeId: string = '';
  private eventListeners: Map<PlayerEvent, PlayerEventListener[]> = new Map();
  private isInitialized: boolean = false;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): PlayerService {
    if (!PlayerService.instance) {
      PlayerService.instance = new PlayerService();
    }
    return PlayerService.instance;
  }

  /**
   * æ„é€ å‡½æ•?   */
  private constructor() {
    this.avPlayerService = AVPlayerServiceInstance;
  }

  /**
   * åˆå§‹åŒ–æ’­æ”¾å™¨æœåŠ¡
   */
  public async initialize(): Promise<void> {
    if (this.isInitialized) {
      Logger.info('PlayerService', 'Player service already initialized');
      return;
    }

    try {
      await this.avPlayerService.init();
      this.setupEventListeners();
      this.isInitialized = true;
      Logger.info('PlayerService', 'Player service initialized successfully');
    } catch (error) {
      Logger.error('PlayerService', `Failed to initialize player service: ${error}`);
      throw error;
    }
  }

  /**
   * è®¾ç½®äº‹ä»¶ç›‘å¬å™?   */
  private setupEventListeners(): void {
    // è®¾ç½®çŠ¶æ€å˜åŒ–ç›‘å?    this.avPlayerService.onStatusChange((status) => {
      this.emitEvent(PlayerEvent.STATUS_CHANGED, status instanceof Error ? status : new Error(String(status instanceof Error ? status instanceof Error ? status : new Error(String(status : new Error(String(status instanceof Error ? status : new Error(String(status instanceof Error ? status instanceof Error ? status : new Error(String(status instanceof Error ? status instanceof Error ? status : new Error(String(status : new Error(String(status instanceof Error ? status : new Error(String(status : new Error(String(status instanceof Error ? status : new Error(String(status instanceof Error ? status instanceof Error ? status : new Error(String(status : new Error(String(status instanceof Error ? status : new Error(String(status)))))));
    });

    // è®¾ç½®é”™è¯¯ç›‘å¬
    this.avPlayerService.onError((error) => {
      this.emitEvent(PlayerEvent.ERROR, error);
    });

    // è®¾ç½®ç¼“å†²æ›´æ–°ç›‘å¬
    this.avPlayerService.onBufferUpdate((bufferingRate) => {
      this.emitEvent(PlayerEvent.BUFFER_UPDATE, bufferingRate);
    });
  }

  /**
   * æ’­æ”¾åª’ä½“
   */
  public async playMedia(mediaId: string, sourceUrl: string, options?: Partial<PlayerConfig>): Promise<void> {
    try {
      if (!this.isInitialized) {
        await this.initialize();
      }

      this.currentMediaId = mediaId;
      this.config = { ...DEFAULT_PLAYER_CONFIG, ...options };

      // è®¾ç½®æ’­æ”¾æº?      await this.avPlayerService.setSource(sourceUrl);

      // å‡†å¤‡æ’­æ”¾
      await this.avPlayerService.prepare();

      // è®¾ç½®åˆå§‹é…ç½®
      await this.avPlayerService.setVolume(this.config.volume);
      await this.avPlayerService.setMute(this.config.muted);

      // è·³è½¬åˆ°æŒ‡å®šä½ç½?      if (this.config.startPosition > 0) {
        await this.avPlayerService.seekTo(this.config.startPosition);
      }

      // è‡ªåŠ¨æ’­æ”¾
      if (this.config.autoPlay) {
        await this.avPlayerService.play();
      }

      Logger.info('PlayerService', `Playing media: ${mediaId}`);
    } catch (error) {
      Logger.error('PlayerService', `Failed to play media: ${error}`);
      throw error;
    }
  }

  /**
   * æš‚åœæ’­æ”¾
   */
  public async pause(): Promise<void> {
    try {
      await this.avPlayerService.pause();
      Logger.info('PlayerService', 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused' : new Error(String('Playback paused' instanceof Error ? 'Playback paused' : new Error(String('Playback paused')))))));
    } catch (error) {
      Logger.error('PlayerService', `Failed to pause: ${error}`);
      throw error;
    }
  }

  /**
   * æ¢å¤æ’­æ”¾
   */
  public async resume(): Promise<void> {
    try {
      await this.avPlayerService.play();
      Logger.info('PlayerService', 'Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed' : new Error(String('Playback resumed' instanceof Error ? 'Playback resumed' : new Error(String('Playback resumed')))))));
    } catch (error) {
      Logger.error('PlayerService', `Failed to resume: ${error}`);
      throw error;
    }
  }

  /**
   * åœæ­¢æ’­æ”¾
   */
  public async stop(): Promise<void> {
    try {
      await this.avPlayerService.stop();
      this.currentMediaId = '';
      this.currentEpisodeId = '';
      Logger.info('PlayerService', 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped' : new Error(String('Playback stopped' instanceof Error ? 'Playback stopped' : new Error(String('Playback stopped')))))));
    } catch (error) {
      Logger.error('PlayerService', `Failed to stop: ${error}`);
      throw error;
    }
  }

  /**
   * è·³è½¬åˆ°æŒ‡å®šä½ç½?   */
  public async seekTo(position: number): Promise<void> {
    try {
      await this.avPlayerService.seekTo(position);
      Logger.debug('PlayerService', `Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` : new Error(String(`Seek to position: ${position}` instanceof Error ? `Seek to position: ${position}` : new Error(String(`Seek to position: ${position}`)))))));
    } catch (error) {
      Logger.error('PlayerService', `Failed to seek: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–å½“å‰æ’­æ”¾ä½ç½®
   */
  public async getCurrentPosition(): Promise<number> {
    try {
      return await this.avPlayerService.getCurrentTime();
    } catch (error) {
      Logger.error('PlayerService', `Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}` instanceof Error ? `Failed to get current position: ${error}` : new Error(String(`Failed to get current position: ${error}`)))))));
      return 0;
    }
  }

  /**
   * è·å–æ€»æ—¶é•?   */
  public async getDuration(): Promise<number> {
    try {
      return await this.avPlayerService.getDuration();
    } catch (error) {
      Logger.error('PlayerService', `Failed to get duration: ${error}`);
      return 0;
    }
  }

  /**
   * è·å–å½“å‰åª’ä½“ID
   */
  public getCurrentMediaId(): string {
    return this.currentMediaId;
  }

  /**
   * è·å–å½“å‰å‰§é›†ID
   */
  public getCurrentEpisodeId(): string {
    return this.currentEpisodeId;
  }

  /**
   * è®¾ç½®å½“å‰å‰§é›†ID
   */
  public setCurrentEpisodeId(episodeId: string): void {
    this.currentEpisodeId = episodeId;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ’­æ”?   */
  public isPlaying(): boolean {
    return this.avPlayerService.getStatus() === PlayerStatus.PLAYING;
  }

  /**
   * è®¾ç½®éŸ³é‡
   */
  public async setVolume(volume: number): Promise<void> {
    try {
      await this.avPlayerService.setVolume(volume);
      this.config.volume = volume;
    } catch (error) {
      Logger.error('PlayerService', `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}` instanceof Error ? `Failed to set volume: ${error}` : new Error(String(`Failed to set volume: ${error}`)))))));
      throw error;
    }
  }

  /**
   * è®¾ç½®é™éŸ³
   */
  public async setMute(muted: boolean): Promise<void> {
    try {
      await this.avPlayerService.setMute(muted);
      this.config.muted = muted;
    } catch (error) {
      Logger.error('PlayerService', `Failed to set mute: ${error}`);
      throw error;
    }
  }

  /**
   * è®¾ç½®æ’­æ”¾é€Ÿåº¦
   */
  public async setPlaybackRate(rate: number): Promise<void> {
    try {
      // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„æ’­æ”¾å™¨APIæ¥å®ç?      // æš‚æ—¶è®°å½•é…ç½®
      this.config.playbackRate = rate;
      Logger.info('PlayerService', `Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}` instanceof Error ? `Playback rate set to: ${rate}` : new Error(String(`Playback rate set to: ${rate}`)))))));
    } catch (error) {
      Logger.error('PlayerService', `Failed to set playback rate: ${error}`);
      throw error;
    }
  }

  /**
   * æ·»åŠ äº‹ä»¶ç›‘å¬å™?   */
  public addEventListener(event: PlayerEvent, listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener : new Error(String(listener: PlayerEventListener instanceof Error ? listener: PlayerEventListener : new Error(String(listener: PlayerEventListener))))))): void {
    if (!this.eventListeners.has(event)) {
      this.eventListeners.set(event, []);
    }
    const listeners = this.eventListeners.get(event);
    if (listeners !== null && listeners !== undefined) {
      listeners.push(listener);
    }
  }

  /**
   * ç§»é™¤äº‹ä»¶ç›‘å¬å™?   */
  public removeEventListener(event: PlayerEvent, listener: PlayerEventListener): void {
    const listeners = this.eventListeners.get(event);
    if (listeners) {
      const index = listeners.indexOf(listener);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    }
  }

  /**
   * è§¦å‘äº‹ä»¶
   */
  private emitEvent<E extends PlayerEvent>(event: E, data: PlayerEventDataMap[E]): void {
    const listeners = this.eventListeners.get(event);
    if (listeners) {
      listeners.forEach(listener => {
        try {
          listener(event, data);
        } catch (error) {
          Logger.error('PlayerService', `Error in event listener: ${error}`);
        }
      });
    }
  }

  /**
   * é‡Šæ”¾æ’­æ”¾å™¨èµ„æº?   */
  public async release(): Promise<void> {
    try {
      await this.avPlayerService.release();
      this.isInitialized = false;
      this.currentMediaId = '';
      this.currentEpisodeId = '';
      this.eventListeners.clear();
      Logger.info('PlayerService', 'Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released' : new Error(String('Player service released' instanceof Error ? 'Player service released' : new Error(String('Player service released')))))));
    } catch (error) {
      Logger.error('PlayerService', `Failed to release player service: ${error}`);
      throw error;
    }
  }
}



