import Logger from '../../common/util/Logger';
import { Site } from '../../data/bean/Site';
import { SiteManager } from '../spider/SiteManager';
import { ConfigLoader } from './ConfigLoader';
import { ConfigParser } from './ConfigParser';
import { SiteDao } from '../../data/db/dao/SiteDao';
import { LineDao } from '../../data/db/dao/LineDao';
import http from '@ohos.net.http';

const TAG = 'LineManager';

/**
 * çº¿è·¯é¡¹æ¥å£å®šä¹? */
export interface LineItem {
  id: string;              // å”¯ä¸€æ ‡è¯†
  name: string;            // çº¿è·¯åç§°
  url: string;             // çº¿è·¯URL
  description?: string;    // çº¿è·¯æè¿°
  type?: 'all' | 'vod' | 'live'; // çº¿è·¯ç±»å‹
  updateTime: number;      // æœ€åæ›´æ–°æ—¶é—?  createTime: number;      // åˆ›å»ºæ—¶é—´
  sourceCount: number;     // åŒ…å«ç‰‡æºæ•°é‡
  enabled: boolean;        // æ˜¯å¦å¯ç”¨
  current: boolean;        // æ˜¯å¦ä¸ºå½“å‰ä½¿ç”¨çš„çº¿è·¯
  cacheTime?: number;      // ç¼“å­˜æ—¶é—´ï¼ˆå°æ—¶ï¼‰
  responseTime?: number;   // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
}

/**
 * ç‰‡æºå“åº”æ£€æµ‹ç»“æ? */
export interface SourceResponseResult {
  sourceId: string;
  sourceName: string;
  responseTime: number;    // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  success: boolean;
  error?: string;
}

/**
 * çº¿è·¯å“åº”æ£€æµ‹ç»“æ? */
export interface LineResponseResult {
  lineId: string;
  lineName: string;
  responseTime: number;    // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  success: boolean;
  error?: string;
  sourceResults?: SourceResponseResult[];
}

/**
 * çº¿è·¯ç®¡ç†ç»“æœ
 */
export interface LineResult {
  success: boolean;
  message?: string;
  data?: Record<string, unknown>;
}

/**
 * çº¿è·¯ç®¡ç†å™? * è´Ÿè´£é…ç½®URLçš„çº¿è·¯ç®¡ç†ã€æ›´æ–°å’Œåˆ‡æ¢
 */
export class LineManager {
  private static instance: LineManager | null = null;
  private lines: Map<string, LineItem> = new Map();
  private siteManager: SiteManager;
  private configLoader: ConfigLoader;
  private configParser: ConfigParser;
  private siteDao: SiteDao;
  private lineDao: LineDao;
  private initialized: boolean = false;
  private context?: Context;
  
  // é»˜è®¤ç¼“å­˜æ—¶é—´é…ç½®
  private defaultCacheHours: number = 24; // é»˜è®¤24å°æ—¶
  private minCacheHours: number = 24;     // æœ€å°?4å°æ—¶
  private maxCacheHours: number = 72;     // æœ€å¤?2å°æ—¶

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): LineManager {
    if (!LineManager.instance) {
      LineManager.instance = new LineManager();
    }
    return LineManager.instance;
  }

  /**
   * æ„é€ å‡½æ•?   */
  private constructor() {
    this.siteManager = SiteManager.getInstance();
    this.configLoader = ConfigLoader.getInstance();
    this.configParser = ConfigParser.getInstance();
    this.siteDao = new SiteDao();
    this.lineDao = new LineDao();
    Logger.info(TAG, 'LineManager initialized');
  }

  /**
   * è®¾ç½®ç¼“å­˜æ—¶é—´èŒƒå›´
   * @param minHours æœ€å°ç¼“å­˜æ—¶é—´ï¼ˆå°æ—¶ï¼?   * @param maxHours æœ€å¤§ç¼“å­˜æ—¶é—´ï¼ˆå°æ—¶ï¼?   */
  public setCacheTimeRange(minHours: number, maxHours: number): void {
    this.minCacheHours = Math.max(24, minHours);
    this.maxCacheHours = Math.min(72, Math.max(this.minCacheHours, maxHours));
    Logger.info(TAG, `Cache time range set to ${this.minCacheHours}-${this.maxCacheHours} hours`);
  }

  /**
   * åˆå§‹åŒ–çº¿è·¯ç®¡ç†å™¨
   * @param context åº”ç”¨ä¸Šä¸‹æ–?   */
  public async initialize(context?: Context): Promise<void> {
    if (this.initialized) {
      return;
    }

    try {
      // ä¿å­˜ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæä¾›ï¼?      if (context) {
        this.context = context;
      }
      
      Logger.info(TAG, 'Initializing line manager...');
      
      // åˆå§‹åŒ–çº¿è·¯è¡¨
      await this.lineDao.initTable(context);
      
      // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½çº¿è·¯é…ç½®
      await this.loadLines();
      
      // æ¢å¤å½“å‰çº¿è·¯çš„ç‰‡æº?      const currentLine = this.getCurrentLine();
      if (currentLine && currentLine.enabled) {
        Logger.info(TAG, `Restoring sources for current line: ${currentLine.name}`);
        try {
          // åŠ è½½é…ç½®å¹¶æ³¨å†Œç‰‡æº?          const configContent = await this.configLoader.loadFromUrl(currentLine.url);
          const sites = this.configParser.parseSites(configContent);
          await this.siteManager.registerSites(sites);
        } catch (error) {
          Logger.error(TAG, `Failed to restore current line sources`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
        }
      }
      
      this.initialized = true;
      Logger.info(TAG, `Line manager initialized with ${this.lines.size} lines`);
    } catch (error) {
      Logger.error(TAG, `Failed to initialize line manager`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      throw error;
    }
  }

  /**
   * æ·»åŠ çº¿è·¯
   * @param name çº¿è·¯åç§°
   * @param url çº¿è·¯URL
   * @param description çº¿è·¯æè¿°
   * @param cacheTime ç¼“å­˜æ—¶é—´ï¼ˆå°æ—¶ï¼‰
   */
  public async addLine(name: string, url: string, description?: string, cacheTime?: number): Promise<LineResult> {
    try {
      // éªŒè¯URLæ ¼å¼
      if (!this.isValidUrl(url)) {
        return {
          success: false,
          message: 'æ— æ•ˆçš„URLæ ¼å¼'
        };
      }

      // éªŒè¯å¹¶è§„èŒƒåŒ–ç¼“å­˜æ—¶é—´
      const normalizedCacheTime = this.normalizeCacheTime(cacheTime);

      // ç”Ÿæˆçº¿è·¯ID
      const id = this.generateLineId(url);
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„çº¿è·?      if (this.lines.has(id)) {
        return {
          success: false,
          message: 'çº¿è·¯URLå·²å­˜åœ?
        };
      }

      // æµ‹è¯•çº¿è·¯URLæ˜¯å¦å¯è®¿é—?      const testResult = await this.testLineUrl(url);
      if (!testResult.success) {
        return testResult;
      }

      // åˆ›å»ºçº¿è·¯é¡?      const line: LineItem = {
        id,
        name,
        url,
        description,
        updateTime: Date.now(),
        createTime: Date.now(),
        sourceCount: (testResult.data?.sites?.length || 0),
        enabled: true,
        current: false,
        cacheTime: normalizedCacheTime,
        responseTime: testResult.data?.responseTime
      };

      // æ·»åŠ åˆ°çº¿è·¯åˆ—è¡?      this.lines.set(id, line);
      
      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveLines();

      Logger.info(TAG, `Added line: ${name} (${url})`);
      return {
        success: true,
        message: 'çº¿è·¯æ·»åŠ æˆåŠŸ',
        data: line
      };
    } catch (error) {
      Logger.error(TAG, `Failed to add line: ${error}`);
      return {
        success: false, message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * åˆ é™¤çº¿è·¯
   * @param lineId çº¿è·¯ID
   */
  public async deleteLine(lineId: string): Promise<LineResult> {
    try {
      const line = this.lines.get(lineId);
      if (!line) {
        return {
          success: false,
          message: 'çº¿è·¯ä¸å­˜åœ?
        };
      }

      // å¦‚æœæ˜¯å½“å‰ä½¿ç”¨çš„çº¿è·¯ï¼Œå…ˆåœç”¨
      if (line.current) {
        await this.disableCurrentLine();
      }

      // ä»çº¿è·¯åˆ—è¡¨ä¸­ç§»é™¤
      this.lines.delete(lineId);
      
      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveLines();

      Logger.info(TAG, `Deleted line: ${line.name}`);
      return {
        success: true,
        message: 'çº¿è·¯åˆ é™¤æˆåŠŸ'
      };
    } catch (error) {
      Logger.error(TAG, `Failed to delete line: ${error}`);
      return {
        success: false, message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * æ›´æ–°çº¿è·¯
   * @param lineId çº¿è·¯ID
   * @param data æ›´æ–°æ•°æ®
   */
  public async updateLine(lineId: string, data: Partial<LineItem>): Promise<LineResult> {
    try {
      const line = this.lines.get(lineId);
      if (!line) {
        return {
          success: false,
          message: 'çº¿è·¯ä¸å­˜åœ?
        };
      }

      // éªŒè¯å¹¶è§„èŒƒåŒ–ç¼“å­˜æ—¶é—´ï¼ˆå¦‚æœæä¾›ï¼‰
      if (data.cacheTime !== undefined) {
        data.cacheTime = this.normalizeCacheTime(data.cacheTime);
      }

      // æ›´æ–°çº¿è·¯ä¿¡æ¯
      const updatedLine: Record<string, string | number | boolean | null> = { ... };

      // å¦‚æœæ›´æ–°äº†URLï¼Œéœ€è¦é‡æ–°ç”ŸæˆID
      if (data.url && data.url !== line.url) {
        // éªŒè¯æ–°URL
        if (!this.isValidUrl(data.url)) {
          return {
            success: false,
            message: 'æ— æ•ˆçš„URLæ ¼å¼'
          };
        }

        // æ£€æŸ¥æ–°URLæ˜¯å¦å·²å­˜åœ?        const newId = this.generateLineId(data.url);
        if (this.lines.has(newId) && newId !== lineId) {
          return {
            success: false,
            message: 'æ–°URLå·²å­˜åœ¨çº¿è·?
          };
        }

        // ä»æ—§IDç§»é™¤
        this.lines.delete(lineId);
        
        // ç”¨æ–°IDæ·»åŠ 
        updatedLine.id = newId;
        this.lines.set(newId, updatedLine);
      } else {
        this.lines.set(lineId, updatedLine);
      }

      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveLines();

      Logger.info(TAG, `Updated line: ${updatedLine.name}`);
      return {
        success: true,
        message: 'çº¿è·¯æ›´æ–°æˆåŠŸ',
        data: updatedLine
      };
    } catch (error) {
      Logger.error(TAG, `Failed to update line: ${error}`);
      return {
        success: false, message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * åˆ·æ–°çº¿è·¯ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼Œå¿½ç•¥ç¼“å­˜ï¼?   * @param lineId çº¿è·¯ID
   */
  public async refreshLine(lineId: string): Promise<LineResult> {
    try {
      const line = this.lines.get(lineId);
      if (!line) {
        return {
          success: false,
          message: 'çº¿è·¯ä¸å­˜åœ?
        };
      }

      // å¼ºåˆ¶ä»URLåŠ è½½æœ€æ–°é…ç½®ï¼ˆå¿½ç•¥ç¼“å­˜ï¼?      const startTime = Date.now();
      const configContent = await this.configLoader.loadFromUrl(line.url, line.cacheTime, true);
      const responseTime = Date.now() - startTime;
      
      // è§£æç‰‡æºé…ç½®
      const sites = this.configParser.parseSites(configContent);
      
      // æ›´æ–°çº¿è·¯ä¿¡æ¯
      line.sourceCount = sites.length;
      line.updateTime = Date.now();
      line.responseTime = responseTime;
      
      // å¦‚æœæ˜¯å½“å‰çº¿è·¯ï¼Œæ›´æ–°ç‰‡æº
      if (line.current) {
        // å…ˆç¦ç”¨æ‰€æœ‰å½“å‰ç‰‡æº?        await this.disableCurrentSources();
        
        // æ³¨å†Œæ–°ç‰‡æº?        await this.siteManager.registerSites(sites);
      }

      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveLines();

      Logger.info(TAG, `Refreshed line: ${line.name}, loaded ${sites.length} sources`);
      return {
        success: true,
        message: `çº¿è·¯åˆ·æ–°æˆåŠŸï¼Œå…±${sites.length}ä¸ªç‰‡æºï¼Œå“åº”æ—¶é—´${responseTime}ms`,
        data: {
          line,
          sites,
          responseTime
        }
      };
    } catch (error) {
      Logger.error(TAG, `Failed to refresh line: ${error}`);
      return {
        success: false, message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * åˆ‡æ¢åˆ°æŒ‡å®šçº¿è·?   * @param lineId çº¿è·¯ID
   */
  public async switchToLine(lineId: string): Promise<LineResult> {
    try {
      const line = this.lines.get(lineId);
      if (!line) {
        return {
          success: false,
          message: 'çº¿è·¯ä¸å­˜åœ?
        };
      }

      if (!line.enabled) {
        return {
          success: false,
          message: 'çº¿è·¯å·²ç¦ç”?
        };
      }

      // åœç”¨å½“å‰çº¿è·¯
      await this.disableCurrentLine();

      // è®¾ç½®æ–°çš„å½“å‰çº¿è·¯
      line.current = true;
      
      // åŠ è½½çº¿è·¯é…ç½®ï¼Œä½¿ç”¨çº¿è·¯é…ç½®çš„ç¼“å­˜æ—¶é—´
      const configContent = await this.configLoader.loadFromUrl(line.url, line.cacheTime);
      const sites = this.configParser.parseSites(configContent);
      
      // æ³¨å†Œç‰‡æº
      await this.siteManager.registerSites(sites);
      
      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveLines();

      Logger.info(TAG, `Switched to line: ${line.name}, loaded ${sites.length} sources`);
      return {
        success: true,
        message: `æˆåŠŸåˆ‡æ¢åˆ°çº¿è·?${line.name}"`,
        data: sites
      };
    } catch (error) {
      Logger.error(TAG, `Failed to switch line: ${error}`);
      return {
        success: false, message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢çº¿è·¯å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * æ£€æµ‹çº¿è·¯å“åº”é€Ÿåº¦
   * @param lineId çº¿è·¯ID
   * @param multiThread æ˜¯å¦ä½¿ç”¨å¤šçº¿ç¨?   * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   */
  public async testLineResponse(lineId: string, multiThread: boolean = false, timeout: number = 20000): Promise<LineResponseResult> {
    const line = this.lines.get(lineId);
    if (!line) {
      return {
        lineId,
        lineName: '',
        responseTime: 0,
        success: false,
        error: 'çº¿è·¯ä¸å­˜åœ?
      };
    }

    try {
      const startTime = Date.now();
      
      // æµ‹è¯•çº¿è·¯å“åº”é€Ÿåº¦
      const configContent = await this.configLoader.loadFromUrl(line.url);
      const responseTime = Date.now() - startTime;
      
      // è§£æç‰‡æº
      const sites = this.configParser.parseSites(configContent);
      
      // æ›´æ–°çº¿è·¯å“åº”æ—¶é—´
      line.responseTime = responseTime;
      await this.saveLines();
      
      return {
        lineId: line.id,
        lineName: line.name,
        responseTime,
        success: true
      };
    } catch (error) {
      Logger.error(TAG, `Failed to test line response: ${error}`);
      return {
        lineId: line.id, lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error instanceof Error ? lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error : new Error(String(lineName: line.name,
        responseTime: 0,
        success: false,
        error: String(error)))))))
      };
    }
  }

  /**
   * æ£€æµ‹çº¿è·¯ä¸‹æ‰€æœ‰ç‰‡æºçš„å“åº”é€Ÿåº¦
   * @param lineId çº¿è·¯ID
   * @param multiThread æ˜¯å¦ä½¿ç”¨å¤šçº¿ç¨?   * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   */
  public async testSourceResponses(lineId: string, multiThread: boolean = false, timeout: number = 15000): Promise<SourceResponseResult[]> {
    const line = this.lines.get(lineId);
    if (!line) {
      return [];
    }

    try {
      // åŠ è½½çº¿è·¯é…ç½®
      const configContent = await this.configLoader.loadFromUrl(line.url);
      const sites = this.configParser.parseSites(configContent);
      
      const results: SourceResponseResult[] = [];
      
      if (multiThread) {
        // å¤šçº¿ç¨‹æ¨¡å¼?        const testPromises = sites.map(async (site) => {
          try {
            const startTime = Date.now();
            
            // åˆ›å»ºHTTPè¯·æ±‚å¯¹è±¡
            const httpRequest = http.createHttp();
            httpRequest.setTimeout({ connectTimeout: timeout });
            
            // æµ‹è¯•ç‰‡æºURL
            const response = await httpRequest.request(site.url, {
              method: http.RequestMethod.GET,
              header: {
                'User-Agent': 'RayTV-HarmonyOS',
                'Accept': '*/*'
              }
            });
            
            // é‡Šæ”¾èµ„æº
            httpRequest.destroy();
            
            const responseTime = Date.now() - startTime;
            
            return {
              sourceId: site.key,
              sourceName: site.name,
              responseTime,
              success: response.ok
            };
          } catch (error) {
            return {
              sourceId: site.key,
              sourceName: site.name,
              responseTime: 0,
              success: false,
              error: String(error)
            };
          }
        });
        
        // ç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆ?        const threadResults = await Promise.all(testPromises);
        results.push(...threadResults);
      } else {
        // å•çº¿ç¨‹æ¨¡å¼?        for (const site of sites) {
          try {
            const startTime = Date.now();
            
            // åˆ›å»ºHTTPè¯·æ±‚å¯¹è±¡
            const httpRequest = http.createHttp();
            httpRequest.setTimeout({ connectTimeout: timeout });
            
            // æµ‹è¯•ç‰‡æºURL
            const response = await httpRequest.request(site.url, {
              method: http.RequestMethod.GET,
              header: {
                'User-Agent': 'RayTV-HarmonyOS',
                'Accept': '*/*'
              }
            });
            
            // é‡Šæ”¾èµ„æº
            httpRequest.destroy();
            
            const responseTime = Date.now() - startTime;
            
            results.push({
              sourceId: site.key,
              sourceName: site.name,
              responseTime,
              success: response.ok
            });
          } catch (error) {
            results.push({
              sourceId: site.key,
              sourceName: site.name,
              responseTime: 0,
              success: false,
              error: String(error)
            });
          }
        }
      }
      
      return results;
    } catch (error) {
      Logger.error(TAG, 'Failed to test source responses', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return [];
    }
  }

  /**
   * ç¦ç”¨å½“å‰çº¿è·¯
   */
  private async disableCurrentLine(): Promise<void> {
    // ç¦ç”¨æ‰€æœ‰ç‰‡æº?    await this.disableCurrentSources();
    
    // é‡ç½®æ‰€æœ‰çº¿è·¯çš„currentçŠ¶æ€?    for (const line of this.lines.values()) {
      line.current = false;
    }
  }

  /**
   * ç¦ç”¨å½“å‰æ‰€æœ‰ç‰‡æº?   */
  private async disableCurrentSources(): Promise<void> {
    const sites = this.siteManager.getAllSites();
    for (const site of sites) {
      await this.siteManager.setSiteEnabled(site.key, false);
    }
  }

  /**
   * æµ‹è¯•çº¿è·¯URL
   * @param url çº¿è·¯URL
   */
  public async testLineUrl(url: string): Promise<LineResult> {
    try {
      Logger.info(TAG, `Testing line URL: ${url}`);
      
      const startTime = Date.now();
      // åŠ è½½é…ç½®ï¼Œä½¿ç”¨é»˜è®¤ç¼“å­˜æ—¶é—´ï¼Œä¸å¼ºåˆ¶åˆ·æ–?      const configContent = await this.configLoader.loadFromUrl(url, this.defaultCacheHours);
      const responseTime = Date.now() - startTime;
      
      // è§£æç‰‡æº
      const sites = this.configParser.parseSites(configContent);
      
      // éªŒè¯ç‰‡æºæ•°é‡
      if (sites.length === 0) {
        return {
          success: false,
          message: 'é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆç‰‡æº'
        };
      }
      
      return {
        success: true,
        message: `URLè®¿é—®æˆåŠŸï¼Œå‘ç?{sites.length}ä¸ªç‰‡æºï¼Œå“åº”æ—¶é—´${responseTime}ms`,
        data: { sites, responseTime }
      };
    } catch (error) {
      Logger.error(TAG, 'Failed to test line URL', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)))));
      return {
        success: false,
        message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
      };
    }
  }

  /**
   * è·å–æ‰€æœ‰çº¿è·?   */
  public getAllLines(): LineItem[] {
    return Array.from(this.lines.values());
  }

  /**
   * è·å–çº¿è·¯è¯¦æƒ…
   * @param lineId çº¿è·¯ID
   */
  public getLine(lineId: string): LineItem | undefined {
    return this.lines.get(lineId);
  }

  /**
   * è·å–å½“å‰ä½¿ç”¨çš„çº¿è·?   */
  public getCurrentLine(): LineItem | undefined {
    return Array.from(this.lines.values()).find(line => line.current);
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çº¿è·¯
   */
  public hasAvailableLines(): boolean {
    return Array.from(this.lines.values()).some(line => line.enabled);
  }

  /**
   * ç”Ÿæˆçº¿è·¯ID
   * @param url çº¿è·¯URL
   */
  private generateLineId(url: string): string {
    // ç®€å•çš„URLå“ˆå¸Œä½œä¸ºçº¿è·¯ID
    let hash = 0;
    for (let i = 0; i < url.length; i++) {
      const char = url.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return `line_${Math.abs(hash).toString(36)}`;
  }

  /**
   * éªŒè¯URLæ ¼å¼
   * @param url URLå­—ç¬¦ä¸?   */
  private isValidUrl(url: string): boolean {
    try {
      new URL(url);
      return true;
    } catch {
      // ç®€å•çš„URLæ ¼å¼æ£€æŸ¥ä½œä¸ºå¤‡ç”?      return /^https?:\/\/.+/.test(url);
    }
  }

  /**
   * è§„èŒƒåŒ–ç¼“å­˜æ—¶é—?   * @param hours ç¼“å­˜æ—¶é—´ï¼ˆå°æ—¶ï¼‰
   */
  private normalizeCacheTime(hours?: number): number {
    if (hours === undefined) {
      return this.defaultCacheHours;
    }
    return Math.max(this.minCacheHours, Math.min(this.maxCacheHours, Math.floor(hours)));
  }

  /**
   * ä¿å­˜çº¿è·¯åˆ—è¡¨åˆ°æŒä¹…åŒ–å­˜å‚¨
   */
  private async saveLines(): Promise<void> {
    try {
      const lines = Array.from(this.lines.values());
      Logger.info(TAG, `Saving ${lines.length} lines`);
      
      // æ‰¹é‡ä¿å­˜çº¿è·¯
      await this.lineDao.saveAll(lines);
    } catch (error) {
      Logger.error(TAG, `Failed to save lines: ${error}`);
      // ä¿å­˜å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ?    }
  }

  /**
   * ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½çº¿è·¯åˆ—è¡¨
   */
  private async loadLines(): Promise<void> {
    try {
      Logger.info(TAG, 'Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage' : new Error(String('Loading lines from storage' instanceof Error ? 'Loading lines from storage' : new Error(String('Loading lines from storage')))))));
      
      // ä»æ•°æ®åº“åŠ è½½çº¿è·¯
      const lines = await this.lineDao.getAll();
      
      // æ¸…ç©ºç°æœ‰çº¿è·¯
      this.lines.clear();
      
      // æ·»åŠ åˆ°å†…å­?      lines.forEach(line => {
        this.lines.set(line.id, line);
      });
      
      Logger.info(TAG, `Loaded ${lines.length} lines from storage`);
    } catch (error) {
      Logger.error(TAG, `Failed to load lines: ${error}`);
    }
  }
}

export function getLineManager(): LineManager {
  return LineManager.getInstance();
}



