// ConfigParser - é…ç½®è§£æå™?// å®ç°Fongmié…ç½®æ–‡ä»¶è§£æå’Œé€‚é…åŠŸèƒ½
import Logger from '../../common/util/Logger';
import { TypeSafetyUtil } from '../../common/util/TypeSafetyUtil';
import { Site, SiteType } from '../../data/bean/Site';
import { AppConfig, HarmonyConfig } from '../../data/bean/Config';
import type { Record } from '../../types/commonTypes';

const TAG = 'ConfigParser';

// æ¥å£å®šä¹‰
export interface CategoryItem {
  key: string;
  name: string;
}

// æœç´¢è§„åˆ™æ¥å£ - æ›¿æ¢anyå’Œunknownä¸ºå…·ä½“ç±»å?export interface SearchRuleItem {
  name: string;
  regex?: string;
  fixed?: string;
  type?: string;
  filter?: boolean;
}

export interface SearchRules {
  page: boolean;
  searchKey: string;
  pageKey: string;
  resultPath: string;
  list: SearchRuleItem[];
}

// è¯¦æƒ…è§„åˆ™æ¥å£ - æ›¿æ¢unknownä¸ºå…·ä½“ç±»å?export interface DetailRules {
  title?: SearchRuleItem;
  cover?: SearchRuleItem;
  desc?: SearchRuleItem;
  director?: SearchRuleItem;
  actor?: SearchRuleItem;
  year?: SearchRuleItem;
  area?: SearchRuleItem;
  update?: SearchRuleItem;
  score?: SearchRuleItem;
  type?: SearchRuleItem;
  playlist?: SearchRuleItem;
  tags?: SearchRuleItem;
}

// æ’­æ”¾è§„åˆ™æ¥å£ - æ›¿æ¢unknownä¸ºå…·ä½“ç±»å?export interface PlaySource {
  name: string;
  rules: Record<string, SearchRuleItem>;
}

export interface PlayRules {
  // ArkTSå…¼å®¹ï¼šä½¿ç”¨æ•°ç»„æ›¿ä»£ç´¢å¼•ç­¾å?  sources: Array<{
    key: string;
    source: PlaySource;
  }>;
}

/**
 * é…ç½®è§£æå™¨ï¼Œè´Ÿè´£è§£æå’Œé€‚é…å„ç§æ ¼å¼çš„é…ç½®æ–‡ä»? */
export class ConfigParser {
  private static instance: ConfigParser;
  
  private constructor() {}
  
  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): ConfigParser {
    if (!ConfigParser.instance) {
      ConfigParser.instance = new ConfigParser();
    }
    return ConfigParser.instance;
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®
   * ä½¿ç”¨TypeSafetyUtilç¡®ä¿ç±»å‹å®‰å…¨
   */
  private getObjectKeys<T extends object>(obj: T): string[] {
    return TypeSafetyUtil.getObjectKeys(obj);
  }

  /**
   * éªŒè¯ç«™ç‚¹é…ç½®
   * @param site ç«™ç‚¹é…ç½®
   */
  public validateSite(site: Record<string, string | number | boolean | null>): site is Site {
    try {
      // ä½¿ç”¨TypeSafetyUtilç¡®ä¿å®‰å…¨è®¿é—®
      const siteObj = TypeSafetyUtil.asObject(site);
      
      // åŸºæœ¬å­—æ®µéªŒè¯
      const key = TypeSafetyUtil.getProperty(siteObj, 'key', '');
      if (typeof key !== 'string' || key.trim() === '') {
        Logger.warn(TAG, 'Site missing required field: key');
        return false;
      }
      
      const name = TypeSafetyUtil.getProperty(siteObj, 'name', '');
      if (typeof name !== 'string' || name.trim() === '') {
        Logger.warn(TAG, `Site ${key} missing required field: name`);
        return false;
      }
      
      const api = TypeSafetyUtil.getProperty(siteObj, 'api', '');
      if (typeof api !== 'string' || api.trim() === '') {
        Logger.warn(TAG, `Site ${name} missing required field: api`);
        return false;
      }
      
      // éªŒè¯API URLæ ¼å¼
      if (!this.isValidUrl(api)) {
        Logger.warn(TAG, `Site ${name} has invalid API URL: ${api}`);
        return false;
      }
      
      // éªŒè¯ç«™ç‚¹ç±»å‹
      const type = TypeSafetyUtil.getProperty(siteObj, 'type', '') as string;
      if (type && !this.isValidSiteType(type)) {
        Logger.warn(TAG, `Site ${name} has invalid type: ${type}`);
        TypeSafetyUtil.setProperty(siteObj, 'type', SiteType.ALL);
      }
      
      // éªŒè¯è§£æè§„åˆ™
      const search = TypeSafetyUtil.getProperty(siteObj, 'search', null);
      if (search && typeof search !== 'object') {
        Logger.warn(TAG, `Site ${name} has invalid search config`);
        TypeSafetyUtil.setProperty(siteObj, 'search', { 
          page: true, 
          searchKey: 'wd', 
          pageKey: 'page', 
          resultPath: '', 
          list: [] 
        });
      }
      
      const detail = TypeSafetyUtil.getProperty(siteObj, 'detail', null);
      if (detail && typeof detail !== 'object') {
        Logger.warn(TAG, `Site ${name} has invalid detail config`);
        TypeSafetyUtil.setProperty(siteObj, 'detail', {});
      }
      
      // ç¡®ä¿å¿…è¦çš„é»˜è®¤å€?      this.ensureDefaultValues(siteObj);
      
      return true;
    } catch (error) {
      Logger.error(TAG, `Error validating site: ${error}`);
      return false;
    }
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ç«™ç‚¹ç±»å?   */
  private isValidSiteType(type: string): boolean {
    const validTypes: SiteType[] = [SiteType.ALL, SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType instanceof Error ? SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType : new Error(String(SiteType.MOVIE, SiteType.SERIES, SiteType.ANIME, SiteType.VOD, SiteType.LIVE];
    return validTypes.includes(type as SiteType)))))));
  }
  private ensureDefaultValues(site: Record<string, string | number | boolean | object | null>): void {
    TypeSafetyUtil.setProperty(site, 'type', TypeSafetyUtil.getProperty(site, 'type', SiteType.ALL));
    TypeSafetyUtil.setProperty(site, 'searchable', TypeSafetyUtil.getProperty(site, 'searchable', true));
    TypeSafetyUtil.setProperty(site, 'categories', TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(site, 'categories', [])));
    TypeSafetyUtil.setProperty(site, 'headers', TypeSafetyUtil.asObject(TypeSafetyUtil.getProperty(site, 'headers', {})));
    
    const search = TypeSafetyUtil.getProperty(site, 'search', null);
    if (search !== null && typeof search === 'object') {
      site.search = search as Record<string, string | number | boolean | object | null>;
    } else {
      site.search = { page: true, searchKey: 'wd', pageKey: 'page', resultPath: '', list: [] };
    }
    
    TypeSafetyUtil.setProperty(site, 'detail', TypeSafetyUtil.asObject(TypeSafetyUtil.getProperty(site, 'detail', {})));
    TypeSafetyUtil.setProperty(site, 'play', TypeSafetyUtil.asObject(TypeSafetyUtil.getProperty(site, 'play', {})));
    TypeSafetyUtil.setProperty(site, 'filterable', TypeSafetyUtil.getProperty(site, 'filterable', false));
    TypeSafetyUtil.setProperty(site, 'filters', TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(site, 'filters', [])));
    TypeSafetyUtil.setProperty(site, 'proxy', TypeSafetyUtil.getProperty(site, 'proxy', false));
    TypeSafetyUtil.setProperty(site, 'weight', TypeSafetyUtil.asNumber(TypeSafetyUtil.getProperty(site, 'weight', 0)));
    TypeSafetyUtil.setProperty(site, 'enabled', TypeSafetyUtil.getProperty(site, 'enabled', true));
    TypeSafetyUtil.setProperty(site, 'updateTime', TypeSafetyUtil.asNumber(TypeSafetyUtil.getProperty(site, 'updateTime', Date.now())));
    TypeSafetyUtil.setProperty(site, 'lastCheckTime', TypeSafetyUtil.asNumber(TypeSafetyUtil.getProperty(site, 'lastCheckTime', 0)));
  }

  /**
   * è§£æç«™ç‚¹é…ç½®
   * @param configContent é…ç½®æ–‡ä»¶å†…å®¹
   * @returns ç«™ç‚¹åˆ—è¡¨
   */
  public parseSites(configContent: string): Site[] {
    try {
      Logger.info(TAG, 'Parsing sites configuration');
      
      // å°è¯•è§£æä¸ºJSON
      const config = this.parseJsonContent(configContent);
      
      // æ”¯æŒä¸åŒæ ¼å¼çš„é…ç½®ç»“æ?      const sitesData = config.sites || config.subscriptions || config.data || config;
      if (!sitesData) {
        throw new Error('Invalid sites configuration format');
      }
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºFongmiæ ¼å¼
      if (this.isFongmiFormat(sitesData)) {
        return this.convertFongmiFormat(sitesData);
      }
      
      // æ ‡å‡†æ•°ç»„æ ¼å¼
      const sites: Site[] = [];
      if (Array.isArray(sitesData)) {
        for (const siteData of sitesData) {
          try {
            const site = this.parseSiteItem(siteData);
            sites.push(site);
          } catch (error) {
            Logger.error(TAG, `Failed to parse site item: ${error}`);
          }
        }
      }
      
      Logger.info(TAG, `Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites` instanceof Error ? `Successfully parsed ${sites.length} sites` : new Error(String(`Successfully parsed ${sites.length} sites`)))))));
      return sites;
    } catch (error) {
      Logger.error(TAG, `Failed to parse sites configuration: ${error}`);
      throw error;
    }
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºFongmiæ ¼å¼é…ç½®
   */
  private isFongmiFormat(config: Record<string, string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null>))): boolean {
    if (!TypeSafetyUtil.isValidObject(config)) return false;
    
    // Fongmiæ ¼å¼é€šå¸¸æ˜¯å¯¹è±¡ï¼Œæ¯ä¸ªé”®å¯¹åº”ä¸€ä¸ªç«™ç‚?    const configObj = TypeSafetyUtil.asObject(config);
    return !Array.isArray(config) && 
           this.getObjectKeys(configObj).length > 0 &&
           this.getObjectKeys(configObj).some(key => {
             // å…ˆå°†configObjè½¬æ¢ä¸ºæ›´å®½æ³›çš„ç±»å‹ï¼Œæ”¯æŒå¯¹è±¡å€?             const broadConfigObj = configObj as Record<string, string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null instanceof Error ? string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null : new Error(String(string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null instanceof Error ? string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null instanceof Error ? string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null : new Error(String(string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null : new Error(String(string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null instanceof Error ? string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null : new Error(String(string | number | boolean | object | null>;
             // ä½¿ç”¨getNestedPropertyè·å–åµŒå¥—å¯¹è±¡
             const value = TypeSafetyUtil.getNestedProperty(broadConfigObj, key, null)))));
             return TypeSafetyUtil.isValidObject(value) && 
                    (TypeSafetyUtil.getNestedProperty(value as Record<string, string | number | boolean | object | null>, 'api', null) !== null || 
                     TypeSafetyUtil.getNestedProperty(value as Record<string, string | number | boolean | object | null>, 'name', null) !== null);
           });
  }
  
  /**
   * è½¬æ¢Fongmiæ ¼å¼é…ç½®
   * @param fongmiConfig Fongmiæ ¼å¼é…ç½®
   */
  public convertFongmiFormat(fongmiConfig: Record<string, unknown>): Site[] {
    try {
      Logger.info(TAG, 'Converting Fongmi format config');
      
      const sites: Site[] = [];
      
      // éå†é…ç½®ä¸­çš„æ¯ä¸ªç«™ç‚¹
      for (const [key, value] of TypeSafetyUtil.getObjectEntries(fongmiConfig)) {
        if (TypeSafetyUtil.isValidObject(value)) {
          const siteData = TypeSafetyUtil.asObject(value);
          
          // è½¬æ¢ä¸ºæ ‡å‡†ç«™ç‚¹æ ¼å¼?          const site: Site = {
            key: key,
            name: TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'name', key)),
            type: this.detectSiteType(siteData),
            api: TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'api', '')),
            searchable: TypeSafetyUtil.getProperty(siteData, 'searchable', true),
            categories: this.convertCategories(TypeSafetyUtil.getProperty(siteData, 'categories', [])),
            headers: this.convertHeaders(TypeSafetyUtil.getProperty(siteData, 'headers', TypeSafetyUtil.getProperty(siteData, 'header', {}))),
            search: this.convertSearchRules(TypeSafetyUtil.getProperty(siteData, 'search', null)),
            detail: this.convertDetailRules(TypeSafetyUtil.getProperty(siteData, 'detail', null)),
            play: this.convertPlayRules(TypeSafetyUtil.getProperty(siteData, 'play', null)),
            filterable: TypeSafetyUtil.getProperty(siteData, 'filterable', false),
            filters: TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(siteData, 'filters', [])),
            proxy: TypeSafetyUtil.getProperty(siteData, 'proxy', false),
            weight: TypeSafetyUtil.asNumber(TypeSafetyUtil.getProperty(siteData, 'weight', 0)),
            enabled: TypeSafetyUtil.getProperty(siteData, 'enabled', true),
            updateTime: Date.now(),
            lastCheckTime: 0
          };
          
          // éªŒè¯å¹¶æ·»åŠ åˆ°ç»“æœåˆ—è¡¨
          if (this.validateSite(site)) {
            sites.push(site);
          }
        }
      }
      
      Logger.info(TAG, `Converted ${sites.length} sites from Fongmi format`);
      return sites;
    } catch (error) {
      Logger.error(TAG, `Failed to convert Fongmi format: ${error}`);
      return [];
    }
  }
  
  /**
   * è‡ªåŠ¨æ£€æµ‹ç«™ç‚¹ç±»å?   * @param siteData ç«™ç‚¹æ•°æ®
   */
  public detectSiteType(siteData: Record<string, unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown>))))))): SiteType {
    // æ ¹æ®ç«™ç‚¹é…ç½®ç‰¹å¾è‡ªåŠ¨åˆ¤æ–­ç±»å‹
    const type = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'type', ''));
    if (type) {
      return this.convertSiteType(type);
    }
    
    // é€šè¿‡å…³é”®è¯åˆ¤æ–?    const name = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'name', '')).toLowerCase();
    const api = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'api', '')).toLowerCase();
    
    if (name.includes('live') || name.includes('ç›´æ’­') || 
        api.includes('live') || api.includes('zhibo')) {
      return SiteType.LIVE;
    }
    
    if (name.includes('vod') || name.includes('ç‚¹æ’­') || 
        name.includes('ç”µå½±') || name.includes('tv') || 
        name.includes('ç”µè§†å‰?)) {
      return SiteType.VOD;
    }
    
    // é»˜è®¤ç±»å‹
    return SiteType.ALL;
  }

  /**
   * å®‰å…¨è§£æJSONå†…å®¹
   * @param content JSONå­—ç¬¦ä¸²å†…å®?   */
  public parseJsonContent(content: string): Record<string, unknown> {
    try {
      // é¢„å¤„ç†ï¼Œç§»é™¤æ³¨é‡Šå’Œå¤šä½™ç©ºæ ?      const cleanContent = this.cleanJsonContent(content);
      return JSON.parse(cleanContent);
    } catch (error) {
      Logger.error(TAG, `Failed to parse JSON content: ${error}`);
      throw new Error(`Invalid JSON format: ${error instanceof Error ? error.message : String(error)}`);
    }
  }
  
  /**
   * æ¸…ç†JSONå†…å®¹ï¼Œç§»é™¤æ³¨é‡Šå’Œæ— æ•ˆå­—ç¬¦
   * @param content åŸå§‹JSONå†…å®¹
   */
  private cleanJsonContent(content: string): string {
    // ç§»é™¤å•è¡Œæ³¨é‡Š
    let clean = content.replace(/\/\/.*$/gm, '' instanceof Error ? '' : new Error(String('' instanceof Error ? '' instanceof Error ? '' : new Error(String('' : new Error(String('' instanceof Error ? '' : new Error(String('' instanceof Error ? '' instanceof Error ? '' : new Error(String('' instanceof Error ? '' instanceof Error ? '' : new Error(String('' : new Error(String('' instanceof Error ? '' : new Error(String('' : new Error(String('' instanceof Error ? '' : new Error(String('' instanceof Error ? '' instanceof Error ? '' : new Error(String('' : new Error(String('' instanceof Error ? '' : new Error(String('')))))));
    // ç§»é™¤å¤šè¡Œæ³¨é‡Š
    clean = clean.replace(/\/\*[\s\S]*?\*\//g, '');
    // ç§»é™¤å¤šä½™ç©ºç™½å­—ç¬¦
    clean = clean.trim();
    return clean;
  }
  
  /**
   * è§£æå•ä¸ªç«™ç‚¹é…ç½®é¡?   * @param siteData ç«™ç‚¹æ•°æ®
   */
  private parseSiteItem(siteData: Record<string, unknown>): Site {
    if (!TypeSafetyUtil.isValidObject(siteData)) {
      throw new Error('Invalid site data format');
    }
    
    const key = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'key', '')) || 
                this.generateSiteKey(TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'name', 'unknown')));
    const name = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'name', 'Unknown Site'));
    const api = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'api', '')) || 
                TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'url', ''));
    
    const site: Site = {
      key: key,
      name: name,
      type: this.convertSiteType(TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(siteData, 'type', ''))),
      api: api,
      searchable: TypeSafetyUtil.getProperty(siteData, 'searchable', true),
      categories: this.convertCategories(TypeSafetyUtil.getProperty(siteData, 'categories', null)),
      headers: this.convertHeaders(TypeSafetyUtil.getProperty(siteData, 'headers', TypeSafetyUtil.getProperty(siteData, 'header', null))),
      search: this.convertSearchRules(TypeSafetyUtil.getProperty(siteData, 'search', null)),
      detail: this.convertDetailRules(TypeSafetyUtil.getProperty(siteData, 'detail', null)),
      play: this.convertPlayRules(TypeSafetyUtil.getProperty(siteData, 'play', null)),
      filterable: TypeSafetyUtil.getProperty(siteData, 'filterable', false),
      filters: TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(siteData, 'filters', [])),
      proxy: TypeSafetyUtil.getProperty(siteData, 'proxy', false),
      weight: TypeSafetyUtil.asNumber(TypeSafetyUtil.getProperty(siteData, 'weight', 0)),
      enabled: TypeSafetyUtil.getProperty(siteData, 'enabled', true),
      updateTime: Date.now(),
      lastCheckTime: 0
    };
    
    if (!this.validateSite(site)) {
      throw new Error(`Invalid site configuration for: ${site.name}`);
    }
    
    return site;
  }
  
  /**
   * ç”Ÿæˆç«™ç‚¹å”¯ä¸€é”?   * @param name ç«™ç‚¹åç§°
   */
  private generateSiteKey(name: string): string {
    return name.toLowerCase().replace(/[^a-z0-9]/g, '_');
  }
  
  /**
   * è½¬æ¢ç«™ç‚¹ç±»å‹
   * @param type åŸå§‹ç±»å‹
   */
  private convertSiteType(type?: string): SiteType {
    if (!type) return SiteType.ALL;
    
    const lowerType = type.toLowerCase();
    if (lowerType === 'vod' || lowerType.includes('ç‚¹æ’­')) return SiteType.VOD;
    if (lowerType === 'live' || lowerType.includes('ç›´æ’­')) return SiteType.LIVE;
    return SiteType.ALL;
  }

  /**
   * è½¬æ¢è¯·æ±‚å¤?   * @param headers åŸå§‹è¯·æ±‚å¤?   */
  public convertHeaders(headers: Record<string, string | number | boolean | null>): Record<string, string> {
    const result: Record<string, string> = {};
    
    if (!headers) {
      return result;
    }
    
    // å¤„ç†ä¸åŒæ ¼å¼çš„è¯·æ±‚å¤´
    if (TypeSafetyUtil.isValidString(headers)) {
      // å­—ç¬¦ä¸²æ ¼å¼? "User-Agent: xxx; Referer: yyy"
      headers.split(';').forEach((header: string) => {
        const parts = header.split(':');
        if (parts.length >= 2) {
          const key = parts[0].trim();
          const value = parts.slice(1).join(':').trim();
          result[key] = value;
        }
      });
    } else if (TypeSafetyUtil.isValidObject(headers)) {
      // å¯¹è±¡æ ¼å¼ï¼Œæ‰‹åŠ¨å¤åˆ¶å­—ç¬¦ä¸²å€?      const headersObj = TypeSafetyUtil.asObject(headers);
      for (const [key, value] of TypeSafetyUtil.getObjectEntries(headersObj)) {
        result[key] = TypeSafetyUtil.asString(value, '');
      }
    }
    
    return result;
  }
  
  /**
   * è½¬æ¢åˆ†ç±»é…ç½®
   * @param categories åŸå§‹åˆ†ç±»
   */
  public convertCategories(categories: Record<string, string | number | boolean | null>): CategoryItem[] {
    const result: CategoryItem[] = [];
    
    if (!categories) {
      return result;
    }
    
    // å¤„ç†æ•°ç»„æ ¼å¼åˆ†ç±»
    if (Array.isArray(categories)) {
      categories.forEach((cat: Record<string, string | number | boolean | null>) => {
        if (TypeSafetyUtil.isValidString(cat)) {
            const category: CategoryItem = {
              key: cat,
              name: cat
            };
            result.push(category);
          } else if (TypeSafetyUtil.isValidObject(cat)) {
            const catObj = TypeSafetyUtil.asObject(cat);
            const key = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(catObj, 'key', ''));
            const name = TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(catObj, 'name', ''));
            if (key && name) {
              const category: CategoryItem = {
                key: key,
                name: name
              };
              result.push(category);
            }
          }
      });
    } 
    // å¤„ç†Fongmiæ ¼å¼åˆ†ç±»ï¼ˆå¯¹è±¡æ ¼å¼ï¼‰
    else if (TypeSafetyUtil.isValidObject(categories)) {
      const categoriesObj = TypeSafetyUtil.asObject(categories);
      for (const [key, value] of TypeSafetyUtil.getObjectEntries(categoriesObj)) {
        const name = TypeSafetyUtil.asString(value, key);
        const category: CategoryItem = {
          key: key,
          name: name
        };
        result.push(category);
      }
    }
    
    // ç¡®ä¿åˆ†ç±»å”¯ä¸€
    const uniqueCategories = new Map<string, CategoryItem>();
    result.forEach(cat => {
      if (!uniqueCategories.has(cat.key)) {
        uniqueCategories.set(cat.key, cat);
      }
    });
    
    return Array.from(uniqueCategories.values());
  }

  /**
   * è½¬æ¢æœç´¢è§„åˆ™
   * @param searchData åŸå§‹æœç´¢é…ç½®
   */
  public convertSearchRules(searchData: Record<string, string | number | boolean | null>): SearchRules {
    if (!TypeSafetyUtil.isValidObject(searchData)) {
      return {
        page: true,
        searchKey: 'wd',
        pageKey: 'page',
        resultPath: '',
        list: []
      };
    }
    
    const searchObj = TypeSafetyUtil.asObject(searchData);
    // æ ‡å‡†åŒ–æœç´¢è§„åˆ™æ ¼å¼?    const result: SearchRules = {
      // Fongmiæ ¼å¼æœç´¢è§„åˆ™é€‚é…
      page: TypeSafetyUtil.getProperty(searchObj, 'page', true),
      searchKey: TypeSafetyUtil.asString(
        TypeSafetyUtil.getProperty(searchObj, 'key', 
          TypeSafetyUtil.getProperty(searchObj, 'searchKey', 'wd')
        )
      ),
      pageKey: TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(searchObj, 'pageKey', 'page')),
      resultPath: TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(searchObj, 'resultPath', '')),
      list: TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(searchObj, 'list', []))
    };
    
    // æ‰‹åŠ¨åˆå¹¶å…¶ä»–å±æ€§ï¼ˆç¡®ä¿ç±»å‹å®‰å…¨ï¼?    for (const [key, value] of TypeSafetyUtil.getObjectEntries(searchObj)) {
      if (!['page', 'searchKey', 'pageKey', 'resultPath', 'list'].includes(key)) {
        TypeSafetyUtil.setProperty(result as Record<string, unknown>, key, value);
      }
    }
    
    return result;
  }
  
  /**
   * è½¬æ¢è¯¦æƒ…é¡µè§„åˆ?   * @param detailData åŸå§‹è¯¦æƒ…é…ç½®
   */
  public convertDetailRules(detailData: Record<string, string | number | boolean | null>): DetailRules {
    if (!TypeSafetyUtil.isValidObject(detailData)) {
      return {};
    }
    
    const detailObj = TypeSafetyUtil.asObject(detailData);
    const result: DetailRules = {};
    
    // æ‰‹åŠ¨å¤åˆ¶æ‰€æœ‰å±æ€?    for (const [key, value] of TypeSafetyUtil.getObjectEntries(detailObj)) {
      TypeSafetyUtil.setProperty(result as Record<string, unknown>, key, value);
    }
    
    return result;
  }
  
  /**
   * è½¬æ¢æ’­æ”¾è§„åˆ™
   * @param playData åŸå§‹æ’­æ”¾é…ç½®
   */
  public convertPlayRules(playData: Record<string, string | number | boolean | null>): PlayRules {
    if (!TypeSafetyUtil.isValidObject(playData)) {
      return { sources: [] };
    }
    
    const playObj = TypeSafetyUtil.asObject(playData);
    const result: PlayRules = { sources: [] };
    
    // æ‰‹åŠ¨å¤åˆ¶æ‰€æœ‰å±æ€§åˆ°sourcesæ•°ç»„
    for (const [key, value] of TypeSafetyUtil.getObjectEntries(playObj)) {
      if (TypeSafetyUtil.isValidObject(value)) {
        const playSource: PlaySource = {
          name: TypeSafetyUtil.asString(TypeSafetyUtil.getProperty(value, 'name', key)),
          rules: TypeSafetyUtil.asObject(TypeSafetyUtil.getProperty(value, 'rules', {}))
        };
        result.sources.push({ key, source: playSource });
      }
    }
    
    return result;
  }
  
  /**
   * éªŒè¯URLæ˜¯å¦æœ‰æ•ˆ
   * @param url è¦éªŒè¯çš„URLå­—ç¬¦ä¸?   */
  private isValidUrl(url: string): boolean {
    if (typeof url !== 'string' || url.trim() === '') {
      return false;
    }
    
    try {
      // ç®€å•çš„URLéªŒè¯é€»è¾‘
      return url.startsWith('http://') || url.startsWith('https://');
    } catch (error) {
      Logger.error(TAG, `Error validating URL: ${error}`);
      return false;
    }
  }

  /**
   * è§£æåº”ç”¨é…ç½®
   * @param configContent é…ç½®æ–‡ä»¶å†…å®¹
   */
  public parseAppConfig(configContent: string): HarmonyConfig {
    try {
      Logger.info(TAG, 'Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration' : new Error(String('Parsing application configuration' instanceof Error ? 'Parsing application configuration' : new Error(String('Parsing application configuration')))))));
      
      const config = this.parseJsonContent(configContent);
      const harmonySection = TypeSafetyUtil.asObject(TypeSafetyUtil.getProperty(config, 'harmony', {}));
      
      // åˆ›å»ºHarmonyOSä¸“ç”¨é…ç½®
      const harmonyConfig: HarmonyConfig = {
        enableVoiceAssistant: TypeSafetyUtil.getProperty(harmonySection, 'enableVoiceAssistant', false),
        enableDeviceFlow: TypeSafetyUtil.getProperty(harmonySection, 'enableDeviceFlow', false),
        enableGestureControl: TypeSafetyUtil.getProperty(harmonySection, 'enableGestureControl', false),
        enableWidget: TypeSafetyUtil.getProperty(harmonySection, 'enableWidget', false),
        enableNotification: TypeSafetyUtil.getProperty(harmonySection, 'enableNotification', false),
        enableAutoStart: TypeSafetyUtil.getProperty(harmonySection, 'enableAutoStart', false),
        enableBackgroundSync: TypeSafetyUtil.getProperty(harmonySection, 'enableBackgroundSync', false),
        enableMultiWindow: TypeSafetyUtil.getProperty(harmonySection, 'enableMultiWindow', false),
        enableHiAI: TypeSafetyUtil.getProperty(harmonySection, 'enableHiAI', false),
        enableSuperDevice: TypeSafetyUtil.getProperty(harmonySection, 'enableSuperDevice', false),
        deviceSharingEnabled: TypeSafetyUtil.getProperty(harmonySection, 'deviceSharingEnabled', false),
        notificationChannels: TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(harmonySection, 'notificationChannels', [])),
        quickActions: TypeSafetyUtil.asArray(TypeSafetyUtil.getProperty(harmonySection, 'quickActions', []))
      };
      
      return harmonyConfig;
    } catch (error) {
      Logger.error(TAG, `Failed to parse application configuration: ${error}`);
      // è¿”å›é»˜è®¤é…ç½®
      return this.getDefaultConfig();
    }
  }
  
  /**
   * è·å–é»˜è®¤é…ç½®
   */
  private getDefaultConfig(): HarmonyConfig {
    return {
      app: {
        name: 'RayTV', version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( instanceof Error ? version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now( : new Error(String(version: '1.0.0',
        debug: false
      },
      services: {
        autoStart: false,
        backgroundRefresh: false,
        dataSync: false
      },
      player: {
        defaultEngine: 'system',
        autoPlayNext: true,
        rememberPosition: true,
        subtitles: { enabled: true }
      },
      ui: {
        theme: 'system',
        fontSize: 'medium',
        layout: 'default'
      },
      security: {
        enableScreenLock: false,
        allowScreenshots: true,
        dataEncryption: false
      },
      sites: [],
      updateTime: Date.now()))))))
    };
  }

}



