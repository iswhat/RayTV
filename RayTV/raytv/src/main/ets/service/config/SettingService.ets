// SettingService.ets - è®¾ç½®æœåŠ¡
// è´Ÿè´£åº”ç”¨é…ç½®ç®¡ç†ã€ä¸»é¢˜è®¾ç½®ã€è¯­è¨€åˆ‡æ¢ç­‰åŠŸèƒ?

import Logger from '../../common/util/Logger';
import StorageUtil from '../../common/util/StorageUtil';
import ConfigService from '../../service/config/ConfigService';
import UserService, { UserPreferences } from '../../service/user/UserService';
import DatabaseManager from '../../data/db/DatabaseManager';
import { BusinessError } from '@ohos.base';
import type { ApplicationInfo } from '@ohos.bundle.bundleManager';

// å¸¸é‡å®šä¹‰
const TAG = 'SettingService';
const SETTINGS_STORAGE_KEY = 'app_settings';
const USER_SETTINGS_KEY_PREFIX = 'user_settings_';

// è®¾ç½®ç±»å‹æšä¸¾
export enum SettingType {
  APPLICATION = 0,     // åº”ç”¨çº§è®¾ç½?
  USER = 1,            // ç”¨æˆ·çº§è®¾ç½?
  DEVICE = 2,          // è®¾å¤‡çº§è®¾ç½?
  CUSTOM = 3           // è‡ªå®šä¹‰è®¾ç½?
}

// ä¸»é¢˜æ¨¡å¼æšä¸¾
export enum ThemeMode {
  LIGHT = 0,           // æµ…è‰²æ¨¡å¼
  DARK = 1,            // æ·±è‰²æ¨¡å¼
  AUTO = 2,            // è‡ªåŠ¨ï¼ˆè·Ÿéšç³»ç»Ÿï¼‰
  SEPia = 3            // æŠ¤çœ¼æ¨¡å¼
}

// è¯­è¨€ä»£ç æšä¸¾
export enum LanguageCode {
  SIMPLIFIED_CHINESE = 'zh_CN',
  TRADITIONAL_CHINESE = 'zh_TW',
  ENGLISH = 'en_US',
  JAPANESE = 'ja_JP',
  KOREAN = 'ko_KR',
  GERMAN = 'de_DE',
  FRENCH = 'fr_FR',
  SPANISH = 'es_ES'
}

// æ’­æ”¾è´¨é‡æšä¸¾
export enum PlaybackQuality {
  LOW = 'low',         // æµç•…
  MEDIUM = 'medium',   // æ ‡æ¸…
  HIGH = 'high',       // é«˜æ¸…
  ULTRA_HIGH = 'uhd',  // è¶…æ¸…
  AUTO = 'auto'        // è‡ªåŠ¨
}

// å­—å¹•å¤§å°æšä¸¾
export enum SubtitleSize {
  SMALL = 'small',     // å°?
  MEDIUM = 'medium',   // ä¸?
  LARGE = 'large',     // å¤?
  X_LARGE = 'xlarge'   // è¶…å¤§
}

// å­—å¹•æ ·å¼æšä¸¾
export enum SubtitleStyle {
  NORMAL = 'normal',   // æ™®é€?
  BOLD = 'bold',       // ç²—ä½“
  ITALIC = 'italic',   // æ–œä½“
  SHADOWED = 'shadowed' // é˜´å½±
}

// ç½‘ç»œç±»å‹æšä¸¾
export enum NetworkType {
  ALL = 0,             // æ‰€æœ‰ç½‘ç»?
  WIFI_ONLY = 1,       // ä»…WiFi
  MOBILE_ONLY = 2,     // ä»…ç§»åŠ¨ç½‘ç»?
  NO_MOBILE_HIGH_SPEED = 3 // éé«˜é€Ÿç§»åŠ¨ç½‘ç»?
}

// é€šçŸ¥ç±»å‹æšä¸¾
export enum NotificationCategory {
  ALL = 0,             // æ‰€æœ‰é€šçŸ¥
  UPDATES = 1,         // æ›´æ–°é€šçŸ¥
  RECOMMENDATIONS = 2, // æ¨èé€šçŸ¥
  LIVE = 3,            // ç›´æ’­é€šçŸ¥
  SYSTEM = 4           // ç³»ç»Ÿé€šçŸ¥
}

// å®¶é•¿æ§åˆ¶çº§åˆ«æšä¸¾
export enum ParentalControlLevel {
  OFF = 0,             // å…³é—­
  G = 1,               // ä¸€èˆ¬è§‚ä¼?
  PG = 2,              // å»ºè®®å®¶é•¿æŒ‡å¯¼
  PG_13 = 3,           // 13å²ä»¥ä¸?
  R = 4,               // é™åˆ¶çº?
  NC_17 = 5            // 17å²ä»¥ä¸?
}

// è®¾ç½®é¡¹æ¥å?
export interface SettingItem<T> {
  key: string;         // è®¾ç½®é”®å
  value: T;            // è®¾ç½®å€?
  type: SettingType;   // è®¾ç½®ç±»å‹
  defaultValue: T;     // é»˜è®¤å€?
  description?: string; // è®¾ç½®æè¿°
  minValue?: number;   // æœ€å°å€¼ï¼ˆæ•°å€¼ç±»å‹ï¼‰
  maxValue?: number;   // æœ€å¤§å€¼ï¼ˆæ•°å€¼ç±»å‹ï¼‰
  options?: T[];       // å¯é€‰å€¼åˆ—è¡?
  readOnly?: boolean;  // æ˜¯å¦åªè¯»
  requiresRestart?: boolean; // æ˜¯å¦éœ€è¦é‡å?
  lastUpdated?: number; // æœ€åæ›´æ–°æ—¶é—?
}

// åº”ç”¨è®¾ç½®æ¥å£
export interface AppSettings {
  // ä¸»é¢˜ç›¸å…³
  themeMode: ThemeMode;
  accentColor: string;
  darkThemeAccentColor: string;
  customTheme?: Record<string, string>;
  
  // è¯­è¨€ç›¸å…³
  language: LanguageCode;
  autoDetectLanguage: boolean;
  
  // æ’­æ”¾ç›¸å…³
  defaultPlaybackQuality: PlaybackQuality;
  autoPlayNext: boolean;
  rememberPlaybackPosition: boolean;
  playbackSpeed: number;
  defaultVolume: number;
  
  // å­—å¹•ç›¸å…³
  subtitleEnabled: boolean;
  subtitleLanguage: string;
  subtitleSize: SubtitleSize;
  subtitleStyle: SubtitleStyle;
  subtitleColor: string;
  subtitleBackgroundColor: string;
  
  // å­˜å‚¨ç›¸å…³
  downloadPath: string;
  cacheSizeLimit: number;
  autoClearCache: boolean;
  cacheClearInterval: number;
  
  // ç½‘ç»œç›¸å…³
  networkTypeForPlayback: NetworkType;
  networkTypeForDownload: NetworkType;
  bandwidthSaver: boolean;
  preloadEnabled: boolean;
  preloadLimit: number;
  
  // é€šçŸ¥ç›¸å…³
  notificationsEnabled: boolean;
  notificationCategories: NotificationCategory[];
  pushEnabled: boolean;
  
  // å®¶é•¿æ§åˆ¶
  parentalControlEnabled: boolean;
  parentalControlLevel: ParentalControlLevel;
  parentalControlPin?: string;
  
  // å¤–è§‚ç›¸å…³
  gridLayoutColumns: number;
  showFileExtensions: boolean;
  showHiddenFiles: boolean;
  defaultSortBy: string;
  defaultSortOrder: 'asc' | 'desc';
  
  // è®¾å¤‡ç›¸å…³
  enableHardwareAcceleration: boolean;
  enableDolbyAudio: boolean;
  enableHDR: boolean;
  screenTimeout: number;
  
  // å…¶ä»–è®¾ç½®
  crashReportingEnabled: boolean;
  usageAnalyticsEnabled: boolean;
  backgroundPlayEnabled: boolean;
  startupPage: string;
  enableGestureControl: boolean;
}

// è®¾ç½®ç»„æ¥å?
export interface SettingGroup {
  id: string;
  title: string;
  description?: string;
  settings: SettingItem<unknown>[];
  icon?: string;
}

// è®¾ç½®å˜æ›´äº‹ä»¶æ¥å£
export interface SettingChangeEvent<T> {
  key: string;
  oldValue: T;
  newValue: T;
  timestamp: number;
  userInitiated: boolean;
}

// é»˜è®¤åº”ç”¨è®¾ç½®
const DEFAULT_APP_SETTINGS: AppSettings = {
  // ä¸»é¢˜ç›¸å…³
  themeMode: ThemeMode.DARK,
  accentColor: '#007AFF',
  darkThemeAccentColor: '#0A84FF',
  
  // è¯­è¨€ç›¸å…³
  language: LanguageCode.SIMPLIFIED_CHINESE,
  autoDetectLanguage: true,
  
  // æ’­æ”¾ç›¸å…³
  defaultPlaybackQuality: PlaybackQuality.AUTO,
  autoPlayNext: true,
  rememberPlaybackPosition: true,
  playbackSpeed: 1.0,
  defaultVolume: 80,
  
  // å­—å¹•ç›¸å…³
  subtitleEnabled: true,
  subtitleLanguage: 'zh_CN',
  subtitleSize: SubtitleSize.MEDIUM,
  subtitleStyle: SubtitleStyle.NORMAL,
  subtitleColor: '#FFFFFF',
  subtitleBackgroundColor: 'rgba(0, 0, 0, 0.5)',
  
  // å­˜å‚¨ç›¸å…³
  downloadPath: '',
  cacheSizeLimit: 1024 * 1024 * 1024 * 10, // 10GB
  autoClearCache: true,
  cacheClearInterval: 7 * 24 * 60 * 60 * 1000, // 7å¤?
  
  // ç½‘ç»œç›¸å…³
  networkTypeForPlayback: NetworkType.ALL,
  networkTypeForDownload: NetworkType.WIFI_ONLY,
  bandwidthSaver: false,
  preloadEnabled: true,
  preloadLimit: 3,
  
  // é€šçŸ¥ç›¸å…³
  notificationsEnabled: true,
  notificationCategories: [
    NotificationCategory.UPDATES,
    NotificationCategory.RECOMMENDATIONS,
    NotificationCategory.LIVE,
    NotificationCategory.SYSTEM
  ],
  pushEnabled: true,
  
  // å®¶é•¿æ§åˆ¶
  parentalControlEnabled: false,
  parentalControlLevel: ParentalControlLevel.OFF,
  
  // å¤–è§‚ç›¸å…³
  gridLayoutColumns: 3,
  showFileExtensions: false,
  showHiddenFiles: false,
  defaultSortBy: 'name',
  defaultSortOrder: 'asc',
  
  // è®¾å¤‡ç›¸å…³
  enableHardwareAcceleration: true,
  enableDolbyAudio: false,
  enableHDR: false,
  screenTimeout: 30000, // 30ç§?
  
  // å…¶ä»–è®¾ç½®
  crashReportingEnabled: true,
  usageAnalyticsEnabled: true,
  backgroundPlayEnabled: false,
  startupPage: 'home',
  enableGestureControl: true
};

export default class SettingService {
  private static instance: SettingService;
  
  /**
   * æ£€æŸ¥å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡å®šå±æ€?
   */
  private hasOwnProperty(obj: object, key: string): boolean {
    return Object.getOwnPropertyNames(obj).includes(key);
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰è‡ªèº«å±æ€§é”®
   */
  private getOwnPropertyKeys(obj: object): string[] {
    return Object.getOwnPropertyNames(obj);
  }
  private configService: ConfigService;
  private userService: UserService;
  private databaseManager: DatabaseManager;
  private appSettings: AppSettings = DEFAULT_APP_SETTINGS;
  private userSettings: Record<string, AppSettings> = {};
  private isInitialized: boolean = false;
  
  // ç›‘å¬å™?
  private generalListeners: Array<() => void> = [];
  private specificListeners: Map<string, Array<(event: SettingChangeEvent<unknown>) => void>> = new Map();
  private themeListeners: Array<(themeMode: ThemeMode, accentColor: string) => void> = [];
  private languageListeners: Array<(language: LanguageCode) => void> = [];

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): SettingService {
    if (!SettingService.instance) {
      SettingService.instance = new SettingService();
    }
    return SettingService.instance;
  }

  /**
   * æ„é€ å‡½æ•?
   */
  private constructor() {
    this.configService = ConfigService.getInstance();
    this.userService = UserService.getInstance();
    this.databaseManager = DatabaseManager.getInstance();
  }

  /**
   * åˆå§‹åŒ–è®¾ç½®æœåŠ?
   */
  public async initialize(): Promise<void> {
    if (this.isInitialized) {
      Logger.info(TAG, 'Setting service already initialized');
      return;
    }

    try {
      Logger.info(TAG, 'Initializing setting service...');
      
      // åŠ è½½é»˜è®¤ä¸‹è½½è·¯å¾„
      this.appSettings.downloadPath = await this.getDefaultDownloadPath();
      
      // åŠ è½½åº”ç”¨å…¨å±€è®¾ç½®
      await this.loadSettings();
      
      // åŠ è½½ç”¨æˆ·è®¾ç½®ï¼ˆå¦‚æœå·²ç™»å½•ï¼?
      const currentUser = this.userService.getCurrentUser();
      if (currentUser && !this.userService.isGuest()) {
        await this.loadUserSettings(currentUser.id);
      }
      
      // åº”ç”¨å½“å‰ä¸»é¢˜å’Œè¯­è¨€
      await this.applyTheme();
      await this.applyLanguage();
      
      // æ·»åŠ ç”¨æˆ·å˜æ›´ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”çš„è®¾ç½?
      this.userService.addUserChangeListener(async (user) => {
        if (user && !this.userService.isGuest()) {
          await this.loadUserSettings(user.id);
          await this.applyTheme();
          await this.applyLanguage();
        }
      });
      
      this.isInitialized = true;
      Logger.info(TAG, 'Setting service initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize setting service: ${error}`);
      // ä½¿ç”¨é»˜è®¤è®¾ç½®ç»§ç»­
      this.appSettings = DEFAULT_APP_SETTINGS;
      this.isInitialized = true;
    }
  }

  /**
   * è·å–é»˜è®¤ä¸‹è½½è·¯å¾„
   */
  private async getDefaultDownloadPath(): Promise<string> {
    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨åº”ç”¨çš„æ–‡ä»¶ç³»ç»ŸAPIè·å–å¯ç”¨çš„ä¸‹è½½ç›®å½?
      // ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿå®ç?
      return '/storage/emulated/0/Download/RayTV';
    } catch (error) {
      Logger.error(TAG, `Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}` instanceof Error ? `Failed to get default download path: ${error}` : new Error(String(`Failed to get default download path: ${error}`)))))));
      return '/tmp';
    }
  }

  /**
   * åŠ è½½åº”ç”¨è®¾ç½®
   */
  private async loadSettings(): Promise<void> {
    try {
      const savedSettings = await StorageUtil.getObject<AppSettings>(SETTINGS_STORAGE_KEY);
      if (savedSettings) {
        this.appSettings = { ...DEFAULT_APP_SETTINGS, ...savedSettings };
        Logger.info(TAG, 'App settings loaded from storage');
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load app settings: ${error}`);
    }
  }

  /**
   * åŠ è½½ç”¨æˆ·è®¾ç½®
   */
  private async loadUserSettings(userId: string): Promise<void> {
    try {
      const userSettingsKey = `${USER_SETTINGS_KEY_PREFIX}${userId}`;
      const savedSettings = await StorageUtil.getObject<AppSettings>(userSettingsKey);
      
      if (savedSettings) {
        this.userSettings[userId] = { ...DEFAULT_APP_SETTINGS, ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` instanceof Error ? ...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}` : new Error(String(...savedSettings };
        Logger.info(TAG, `User settings loaded for user: ${userId}`)))))));
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load user settings: ${error}`);
    }
  }

  /**
   * ä¿å­˜åº”ç”¨è®¾ç½®
   */
  private async saveSettings(): Promise<void> {
    try {
      await StorageUtil.setObject(SETTINGS_STORAGE_KEY, this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings : new Error(String(this.appSettings instanceof Error ? this.appSettings : new Error(String(this.appSettings)))))));
      Logger.info(TAG, 'App settings saved to storage');
    } catch (error) {
      Logger.error(TAG, `Failed to save app settings: ${error}`);
    }
  }

  /**
   * ä¿å­˜ç”¨æˆ·è®¾ç½®
   */
  private async saveUserSettings(userId: string): Promise<void> {
    try {
      const userSettings = this.userSettings[userId];
      if (userSettings) {
        const userSettingsKey = `${USER_SETTINGS_KEY_PREFIX}${userId}`;
        await StorageUtil.setObject(userSettingsKey, userSettings instanceof Error ? userSettings : new Error(String(userSettings instanceof Error ? userSettings instanceof Error ? userSettings : new Error(String(userSettings : new Error(String(userSettings instanceof Error ? userSettings : new Error(String(userSettings instanceof Error ? userSettings instanceof Error ? userSettings : new Error(String(userSettings instanceof Error ? userSettings instanceof Error ? userSettings : new Error(String(userSettings : new Error(String(userSettings instanceof Error ? userSettings : new Error(String(userSettings : new Error(String(userSettings instanceof Error ? userSettings : new Error(String(userSettings instanceof Error ? userSettings instanceof Error ? userSettings : new Error(String(userSettings : new Error(String(userSettings instanceof Error ? userSettings : new Error(String(userSettings)))))));
        Logger.info(TAG, `User settings saved for user: ${userId}`);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to save user settings: ${error}`);
    }
  }

  /**
   * è·å–å½“å‰è®¾ç½®ï¼ˆè€ƒè™‘ç”¨æˆ·è®¾ç½®è¦†ç›–ï¼?
   */
  public getSettings(): AppSettings {
    const currentUser = this.userService.getCurrentUser();
    
    if (currentUser && !this.userService.isGuest() && this.userSettings[currentUser.id]) {
      return { ...this.userSettings[currentUser.id] };
    }
    
    return { ...this.appSettings };
  }

  /**
   * è·å–ç‰¹å®šè®¾ç½®é¡?
   */
  public getSetting<K extends keyof AppSettings>(key: K): AppSettings[K] {
    const settings = this.getSettings();
    return settings[key];
  }

  /**
   * è®¾ç½®ç‰¹å®šè®¾ç½®é¡?
   */
  public async setSetting<K extends keyof AppSettings>(key: K, value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true instanceof Error ? value: AppSettings[K], userInitiated: boolean = true : new Error(String(value: AppSettings[K], userInitiated: boolean = true))))))): Promise<boolean> {
    try {
      const oldValue = this.getSetting(key);
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šå¤„ç?
      if (oldValue === value) {
        return true; // å€¼æœªå˜åŒ–
      }
      
      // ç¡®å®šæ˜¯åº”ç”¨è®¾ç½®è¿˜æ˜¯ç”¨æˆ·è®¾ç½?
      const currentUser = this.userService.getCurrentUser();
      const isUserSetting = currentUser && !this.userService.isGuest();
      
      if (isUserSetting) {
        // ç¡®ä¿ç”¨æˆ·è®¾ç½®å¯¹è±¡å­˜åœ¨
        if (!this.userSettings[currentUser.id]) {
          this.userSettings[currentUser.id] = { ...DEFAULT_APP_SETTINGS };
        }
        // æ›´æ–°ç”¨æˆ·è®¾ç½®
        this.userSettings[currentUser.id][key] = value;
        await this.saveUserSettings(currentUser.id);
      } else {
        // æ›´æ–°åº”ç”¨è®¾ç½®
        this.appSettings[key] = value;
        await this.saveSettings();
      }
      
      // è§¦å‘è®¾ç½®å˜æ›´äº‹ä»¶
      this.notifySettingChanged(key as string, oldValue, value, userInitiated);
      
      // å¤„ç†ç‰¹æ®Šè®¾ç½®é¡¹çš„åº”ç”¨
      await this.handleSpecialSetting(key, value);
      
      Logger.info(TAG, `Setting ${key} updated to: ${String(value)}`);
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to set setting ${key}: ${error}`);
      return false;
    }
  }

  /**
   * æ‰¹é‡è®¾ç½®å¤šä¸ªè®¾ç½®é¡?
   */
  public async setMultipleSettings(updates: Partial<AppSettings>, userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true : new Error(String(userInitiated: boolean = true instanceof Error ? userInitiated: boolean = true : new Error(String(userInitiated: boolean = true))))))): Promise<boolean> {
    try {
      const changedKeys: Array<{ key: string, oldValue: Record<string, string | number | boolean | null>, newValue: Record<string, string | number | boolean | null> }> = [];
      
      // æ”¶é›†æ‰€æœ‰è¦æ›´æ”¹çš„è®¾ç½?
      const keys = this.getOwnPropertyKeys(updates);
      for (const key of keys) {
        if (this.hasOwnProperty(updates, key)) {
          // é¿å…ä½¿ç”¨anyç±»å‹ï¼Œä½¿ç”¨æ›´å…·ä½“çš„ç±»å‹æ–­è¨€
          const newValue = updates[key as keyof AppSettings];
          const oldValue = this.getSetting(key as keyof AppSettings);
          if (oldValue !== newValue) {
            changedKeys.push({ key, oldValue, newValue });
          }
        }
      }
      
      if (changedKeys.length === 0) {
        return true; // æ²¡æœ‰éœ€è¦æ›´æ”¹çš„è®¾ç½®
      }
      
      // ç¡®å®šæ˜¯åº”ç”¨è®¾ç½®è¿˜æ˜¯ç”¨æˆ·è®¾ç½?
      const currentUser = this.userService.getCurrentUser();
      const isUserSetting = currentUser && !this.userService.isGuest();
      
      // æ‰¹é‡æ›´æ–°è®¾ç½®
      for (const { key, newValue } of changedKeys) {
        if (isUserSetting) {
          if (!this.userSettings[currentUser.id]) {
            this.userSettings[currentUser.id] = { ...DEFAULT_APP_SETTINGS };
          }
          this.userSettings[currentUser.id][key as keyof AppSettings] = newValue;
        } else {
          this.appSettings[key as keyof AppSettings] = newValue;
        }
      }
      
      // ä¿å­˜è®¾ç½®
      if (isUserSetting) {
        await this.saveUserSettings(currentUser.id);
      } else {
        await this.saveSettings();
      }
      
      // è§¦å‘è®¾ç½®å˜æ›´äº‹ä»¶
      for (const { key, oldValue, newValue } of changedKeys) {
        this.notifySettingChanged(key, oldValue, newValue, userInitiated);
        // å¤„ç†ç‰¹æ®Šè®¾ç½®é¡?
        await this.handleSpecialSetting(key as keyof AppSettings, newValue);
      }
      
      // è§¦å‘é€šç”¨è®¾ç½®å˜æ›´äº‹ä»¶
      this.notifySettingsChanged();
      
      Logger.info(TAG, `Batch updated ${changedKeys.length} settings`);
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to set multiple settings: ${error}`);
      return false;
    }
  }

  /**
   * å¤„ç†éœ€è¦ç‰¹æ®Šåº”ç”¨çš„è®¾ç½®é¡?
   */
  private async handleSpecialSetting<K extends keyof AppSettings>(key: K, value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K] : new Error(String(value: AppSettings[K] instanceof Error ? value: AppSettings[K] : new Error(String(value: AppSettings[K]))))))): Promise<void> {
    switch (key) {
      case 'themeMode':
      case 'accentColor':
      case 'darkThemeAccentColor':
        await this.applyTheme();
        break;
      case 'language':
      case 'autoDetectLanguage':
        await this.applyLanguage();
        break;
      case 'parentalControlEnabled':
        // å¤„ç†å®¶é•¿æ§åˆ¶è®¾ç½®
        if (value === true && !this.getSetting('parentalControlPin')) {
          Logger.warn(TAG, 'Parental control enabled but no PIN set');
        }
        break;
      case 'downloadPath':
        // éªŒè¯ä¸‹è½½è·¯å¾„æ˜¯å¦æœ‰æ•ˆ
        await this.validateDownloadPath(value as string);
        break;
    }
  }

  /**
   * åº”ç”¨å½“å‰ä¸»é¢˜è®¾ç½®
   */
  private async applyTheme(): Promise<void> {
    const themeMode = this.getSetting('themeMode');
    const accentColor = themeMode === ThemeMode.DARK 
      ? this.getSetting('darkThemeAccentColor') 
      : this.getSetting('accentColor');
    
    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨HarmonyOSçš„ä¸»é¢˜APIæ¥åº”ç”¨ä¸»é¢?
      // ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿå®ç?
      Logger.info(TAG, `Applying theme: ${themeMode}, accent color: ${accentColor}`);
      
      // é€šçŸ¥ä¸»é¢˜ç›‘å¬å™?
      this.notifyThemeChanged(themeMode, accentColor);
    } catch (error) {
      Logger.error(TAG, `Failed to apply theme: ${error}`);
    }
  }

  /**
   * åº”ç”¨å½“å‰è¯­è¨€è®¾ç½®
   */
  private async applyLanguage(): Promise<void> {
    let language = this.getSetting('language');
    
    if (this.getSetting('autoDetectLanguage')) {
      // å°è¯•æ£€æµ‹ç³»ç»Ÿè¯­è¨€
      const systemLanguage = await this.detectSystemLanguage();
      if (systemLanguage) {
        language = systemLanguage;
      }
    }
    
    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨HarmonyOSçš„è¯­è¨€é…ç½®APIæ¥åº”ç”¨è¯­è¨€
      // ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿå®ç?
      Logger.info(TAG, `Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}` : new Error(String(`Applying language: ${language}` instanceof Error ? `Applying language: ${language}` : new Error(String(`Applying language: ${language}`)))))));
      
      // é€šçŸ¥è¯­è¨€ç›‘å¬å™?
      this.notifyLanguageChanged(language);
    } catch (error) {
      Logger.error(TAG, `Failed to apply language: ${error}`);
    }
  }

  /**
   * æ£€æµ‹ç³»ç»Ÿè¯­è¨€
   */
  private async detectSystemLanguage(): Promise<LanguageCode | null> {
    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨HarmonyOSçš„APIè·å–ç³»ç»Ÿè¯­è¨€
      // ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿå®ç?
      const systemLocale = 'zh_CN'; // å‡è®¾è·å–åˆ°çš„ç³»ç»Ÿè¯­è¨€ä»£ç 
      
      // æ˜ å°„ç³»ç»Ÿè¯­è¨€åˆ°åº”ç”¨æ”¯æŒçš„è¯­è¨€
      if (systemLocale.startsWith('zh')) {
        return systemLocale.includes('TW') || systemLocale.includes('HK')
          ? LanguageCode.TRADITIONAL_CHINESE
          : LanguageCode.SIMPLIFIED_CHINESE;
      } else if (systemLocale.startsWith('en')) {
        return LanguageCode.ENGLISH;
      } else if (systemLocale.startsWith('ja')) {
        return LanguageCode.JAPANESE;
      } else if (systemLocale.startsWith('ko')) {
        return LanguageCode.KOREAN;
      } else if (systemLocale.startsWith('de')) {
        return LanguageCode.GERMAN;
      } else if (systemLocale.startsWith('fr')) {
        return LanguageCode.FRENCH;
      } else if (systemLocale.startsWith('es')) {
        return LanguageCode.SPANISH;
      }
      
      return null;
    } catch (error) {
      Logger.error(TAG, `Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}` instanceof Error ? `Failed to detect system language: ${error}` : new Error(String(`Failed to detect system language: ${error}`)))))));
      return null;
    }
  }

  /**
   * éªŒè¯ä¸‹è½½è·¯å¾„
   */
  private async validateDownloadPath(path: string): Promise<boolean> {
    try {
      // è¿™é‡Œåº”è¯¥ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPIéªŒè¯è·¯å¾„æ˜¯å¦æœ‰æ•ˆä¸”å¯å†?
      // ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿå®ç?
      if (!path || path.length < 3) {
        throw new Error('Invalid download path');
      }
      
      Logger.info(TAG, `Validated download path: ${path}`);
      return true;
    } catch (error) {
      Logger.error(TAG, `Invalid download path: ${error}`);
      // æ¢å¤é»˜è®¤è·¯å¾„
      this.setSetting('downloadPath', await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath( instanceof Error ? await this.getDefaultDownloadPath( : new Error(String(await this.getDefaultDownloadPath())))))));
      return false;
    }
  }

  /**
   * é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€?
   */
  public async resetAllSettings(): Promise<boolean> {
    try {
      // é‡ç½®åº”ç”¨è®¾ç½®
      this.appSettings = { ...DEFAULT_APP_SETTINGS };
      this.appSettings.downloadPath = await this.getDefaultDownloadPath();
      await this.saveSettings();
      
      // é‡ç½®å½“å‰ç”¨æˆ·è®¾ç½®
      const currentUser = this.userService.getCurrentUser();
      if (currentUser && !this.userService.isGuest()) {
        this.userSettings[currentUser.id] = { ...DEFAULT_APP_SETTINGS };
        this.userSettings[currentUser.id].downloadPath = this.appSettings.downloadPath;
        await this.saveUserSettings(currentUser.id);
      }
      
      // åº”ç”¨é»˜è®¤ä¸»é¢˜å’Œè¯­è¨€
      await this.applyTheme();
      await this.applyLanguage();
      
      // é€šçŸ¥è®¾ç½®å˜æ›´
      this.notifySettingsChanged();
      
      Logger.info(TAG, 'All settings reset to default');
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to reset settings: ${error}`);
      return false;
    }
  }

  /**
   * è·å–è®¾ç½®é¡¹çš„é»˜è®¤å€?
   */
  public getDefaultSetting<K extends keyof AppSettings>(key: K): AppSettings[K] {
    return DEFAULT_APP_SETTINGS[key];
  }

  /**
   * æ£€æŸ¥è®¾ç½®æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆä¸é»˜è®¤å€¼æ¯”è¾ƒï¼‰
   */
  public isSettingModified<K extends keyof AppSettings>(key: K): boolean {
    return this.getSetting(key) !== DEFAULT_APP_SETTINGS[key];
  }

  /**
   * è·å–æ‰€æœ‰è¢«ä¿®æ”¹çš„è®¾ç½®é¡¹
   */
  public getModifiedSettings(): Partial<AppSettings> {
    const modified: Partial<AppSettings> = {};
    const settings = this.getSettings();
    
    for (const key in settings) {
      const typedKey = key as keyof AppSettings;
      if (settings[typedKey] !== DEFAULT_APP_SETTINGS[typedKey]) {
        modified[typedKey] = settings[typedKey];
      }
    }
    
    return modified;
  }

  /**
   * å¯¼å‡ºè®¾ç½®ä¸ºJSON
   */
  public exportSettings(): string {
    const settings = this.getSettings();
    const exportData: Record<string, string | number | boolean | null> = { ... };
    
    return JSON.stringify(exportData, null, 2 instanceof Error ? string | number | boolean | null> = { ... };
    
    return JSON.stringify(exportData, null, 2 : new Error(String(string | number | boolean | null> = { ... };
    
    return JSON.stringify(exportData, null, 2)));
  }

  /**
   * å¯¼å…¥è®¾ç½®ä»JSON
   */
  public async importSettings(jsonString: string): Promise<boolean> {
    try {
      const importData = JSON.parse(jsonString);
      
      if (!importData.settings || typeof importData.settings !== 'object') {
        throw new Error('Invalid import data format');
      }
      
      // éªŒè¯å¯¼å…¥æ•°æ®çš„æœ‰æ•ˆæ€?
      await this.validateImportedSettings(importData.settings);
      
      // åº”ç”¨å¯¼å…¥çš„è®¾ç½?
      await this.setMultipleSettings(importData.settings, false);
      
      Logger.info(TAG, 'Settings imported successfully');
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to import settings: ${error}`);
      return false;
    }
  }

  /**
   * éªŒè¯å¯¼å…¥çš„è®¾ç½?
   */
  private async validateImportedSettings(settings: Partial<AppSettings>): Promise<void> {
    // éªŒè¯å¿…éœ€çš„è®¾ç½®é¡¹
    if (settings.themeMode !== undefined && settings.themeMode !== null && settings.themeMode !== 0) {
      throw new Error('Invalid theme mode in imported settings');
    }
    
    if (!settings.language && settings.language !== '') {
      throw new Error('Invalid language in imported settings');
    }
    
    // éªŒè¯ä¸‹è½½è·¯å¾„
    if (settings.downloadPath) {
      await this.validateDownloadPath(settings.downloadPath);
    }
    
    // éªŒè¯æ•°å€¼èŒƒå›?
    if (settings.defaultVolume !== undefined && 
        (settings.defaultVolume < 0 || settings.defaultVolume > 100)) {
      throw new Error('Invalid default volume in imported settings');
    }
    
    if (settings.playbackSpeed !== undefined && 
        (settings.playbackSpeed < 0.5 || settings.playbackSpeed > 3.0)) {
      throw new Error('Invalid playback speed in imported settings');
    }
  }

  /**
   * åº”ç”¨ç”¨æˆ·åå¥½è®¾ç½®
   */
  public async applyUserPreferences(preferences: UserPreferences): Promise<void> {
    const settingsToApply: Partial<AppSettings> = {};
    
    // æ˜ å°„ç”¨æˆ·åå¥½åˆ°åº”ç”¨è®¾ç½?
    if (preferences.theme) {
      settingsToApply.themeMode = preferences.theme === 'light' 
        ? ThemeMode.LIGHT 
        : ThemeMode.DARK;
    }
    
    if (preferences.language) {
      settingsToApply.language = preferences.language as LanguageCode;
    }
    
    if (preferences.playQuality) {
      settingsToApply.defaultPlaybackQuality = preferences.playQuality as PlaybackQuality;
    }
    
    if (preferences.subtitleEnabled !== undefined) {
      settingsToApply.subtitleEnabled = preferences.subtitleEnabled;
    }
    
    if (preferences.subtitleLanguage) {
      settingsToApply.subtitleLanguage = preferences.subtitleLanguage;
    }
    
    if (preferences.autoPlay !== undefined) {
      settingsToApply.autoPlayNext = preferences.autoPlay;
    }
    
    if (preferences.bandwidthSaver !== undefined) {
      settingsToApply.bandwidthSaver = preferences.bandwidthSaver;
    }
    
    if (preferences.downloadQuality) {
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸‹è½½è´¨é‡çš„æ˜ å°?
    }
    
    if (preferences.downloadWifiOnly !== undefined) {
      settingsToApply.networkTypeForDownload = preferences.downloadWifiOnly 
        ? NetworkType.WIFI_ONLY 
        : NetworkType.ALL;
    }
    
    // åº”ç”¨è®¾ç½®
    if (this.getObjectKeys(settingsToApply).length > 0) {
      await this.setMultipleSettings(settingsToApply, false instanceof Error ? false : new Error(String(false instanceof Error ? false instanceof Error ? false : new Error(String(false : new Error(String(false instanceof Error ? false : new Error(String(false instanceof Error ? false instanceof Error ? false : new Error(String(false instanceof Error ? false instanceof Error ? false : new Error(String(false : new Error(String(false instanceof Error ? false : new Error(String(false : new Error(String(false instanceof Error ? false : new Error(String(false instanceof Error ? false instanceof Error ? false : new Error(String(false : new Error(String(false instanceof Error ? false : new Error(String(false)))))));
    }
  }

  /**
   * ä»é…ç½®æœåŠ¡åŠ è½½è®¾ç½?
   */
  public async loadSettingsFromConfig(): Promise<void> {
    try {
      // ä»é…ç½®æœåŠ¡åŠ è½½å…³é”®è®¾ç½?
      const themeMode = await this.configService.getConfig<ThemeMode>('themeMode');
      const language = await this.configService.getConfig<LanguageCode>('language');
      const defaultPlaybackQuality = await this.configService.getConfig<PlaybackQuality>('playQuality');
      
      // åº”ç”¨è¿™äº›è®¾ç½®ï¼ˆä½†ä¸è§¦å‘ç”¨æˆ·å‘èµ·çš„é€šçŸ¥ï¼?
      const settingsToApply: Partial<AppSettings> = {};
      
      if (themeMode !== undefined) {
        settingsToApply.themeMode = themeMode;
      }
      
      if (language !== undefined) {
        settingsToApply.language = language;
      }
      
      if (defaultPlaybackQuality !== undefined) {
        settingsToApply.defaultPlaybackQuality = defaultPlaybackQuality;
      }
      
      if (this.getObjectKeys(settingsToApply).length > 0) {
        await this.setMultipleSettings(settingsToApply, false);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load settings from config: ${error}`);
    }
  }

  /**
   * è·å–è®¾ç½®åˆ†ç»„åˆ—è¡¨
   */
  public getSettingGroups(): SettingGroup[] {
    const currentSettings = this.getSettings();
    
    return [
      {
        id: 'appearance', title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode instanceof Error ? title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode : new Error(String(title: 'å¤–è§‚',
        description: 'è‡ªå®šä¹‰åº”ç”¨å¤–è§‚å’Œæ˜¾ç¤ºè®¾ç½®',
        icon: 'ic_settings_appearance',
        settings: [
          this.createSettingItem('themeMode', currentSettings.themeMode))))))),
          this.createSettingItem('accentColor', currentSettings.accentColor),
          this.createSettingItem('darkThemeAccentColor', currentSettings.darkThemeAccentColor),
          this.createSettingItem('gridLayoutColumns', currentSettings.gridLayoutColumns),
        ]
      },
      {
        id: 'playback',
        title: 'æ’­æ”¾',
        description: 'è°ƒæ•´æ’­æ”¾ç›¸å…³è®¾ç½®',
        icon: 'ic_settings_playback',
        settings: [
          this.createSettingItem('defaultPlaybackQuality', currentSettings.defaultPlaybackQuality),
          this.createSettingItem('autoPlayNext', currentSettings.autoPlayNext),
          this.createSettingItem('rememberPlaybackPosition', currentSettings.rememberPlaybackPosition),
          this.createSettingItem('playbackSpeed', currentSettings.playbackSpeed),
          this.createSettingItem('defaultVolume', currentSettings.defaultVolume),
        ]
      },
      {
        id: 'subtitle',
        title: 'å­—å¹•',
        description: 'é…ç½®å­—å¹•æ˜¾ç¤ºé€‰é¡¹',
        icon: 'ic_settings_subtitle',
        settings: [
          this.createSettingItem('subtitleEnabled', currentSettings.subtitleEnabled),
          this.createSettingItem('subtitleLanguage', currentSettings.subtitleLanguage),
          this.createSettingItem('subtitleSize', currentSettings.subtitleSize),
          this.createSettingItem('subtitleStyle', currentSettings.subtitleStyle),
          this.createSettingItem('subtitleColor', currentSettings.subtitleColor),
          this.createSettingItem('subtitleBackgroundColor', currentSettings.subtitleBackgroundColor),
        ]
      },
      {
        id: 'network',
        title: 'ç½‘ç»œ',
        description: 'ç®¡ç†ç½‘ç»œä½¿ç”¨å’Œä¸‹è½½è®¾ç½?,
        icon: 'ic_settings_network',
        settings: [
          this.createSettingItem('networkTypeForPlayback', currentSettings.networkTypeForPlayback),
          this.createSettingItem('networkTypeForDownload', currentSettings.networkTypeForDownload),
          this.createSettingItem('bandwidthSaver', currentSettings.bandwidthSaver),
          this.createSettingItem('preloadEnabled', currentSettings.preloadEnabled),
        ]
      },
      {
        id: 'storage',
        title: 'å­˜å‚¨',
        description: 'ç®¡ç†ç¼“å­˜å’Œä¸‹è½½å­˜å‚?,
        icon: 'ic_settings_storage',
        settings: [
          this.createSettingItem('downloadPath', currentSettings.downloadPath),
          this.createSettingItem('cacheSizeLimit', currentSettings.cacheSizeLimit),
          this.createSettingItem('autoClearCache', currentSettings.autoClearCache),
        ]
      },
      {
        id: 'notification',
        title: 'é€šçŸ¥',
        description: 'é…ç½®åº”ç”¨é€šçŸ¥é€‰é¡¹',
        icon: 'ic_settings_notification',
        settings: [
          this.createSettingItem('notificationsEnabled', currentSettings.notificationsEnabled),
          this.createSettingItem('notificationCategories', currentSettings.notificationCategories),
          this.createSettingItem('pushEnabled', currentSettings.pushEnabled),
        ]
      },
      {
        id: 'parental',
        title: 'å®¶é•¿æ§åˆ¶',
        description: 'è®¾ç½®å†…å®¹è®¿é—®é™åˆ¶',
        icon: 'ic_settings_parental',
        settings: [
          this.createSettingItem('parentalControlEnabled', currentSettings.parentalControlEnabled),
          this.createSettingItem('parentalControlLevel', currentSettings.parentalControlLevel),
        ]
      },
    ];
  }

  /**
   * åˆ›å»ºè®¾ç½®é¡¹å¯¹è±?
   */
  private createSettingItem<T>(key: string, value: T): SettingItem<T> {
    const defaultSettings = DEFAULT_APP_SETTINGS as Record<string, T>;
    
    const settingItem: SettingItem<T> = {
      key,
      value,
      type: SettingType.USER,
      defaultValue: defaultSettings[key],
      lastUpdated: Date.now()
    };
    
    // æ ¹æ®é”®åæ·»åŠ ä¸€äº›é¢å¤–ä¿¡æ?
    if (key === 'gridLayoutColumns') {
      settingItem.minValue = 2;
      settingItem.maxValue = 6;
    } else if (key === 'defaultVolume') {
      settingItem.minValue = 0;
      settingItem.maxValue = 100;
    } else if (key === 'playbackSpeed') {
      settingItem.minValue = 0.5;
      settingItem.maxValue = 3.0;
    } else if (key === 'themeMode') {
      settingItem.options = [ThemeMode.LIGHT, ThemeMode.DARK, ThemeMode.AUTO, ThemeMode.SEPia];
    }
    
    return settingItem;
  }

  /**
   * æ·»åŠ è®¾ç½®å˜æ›´ç›‘å¬å™?
   */
  public addSettingsChangeListener(listener: () => void): () => void {
    this.generalListeners.push(listener);
    
    // è¿”å›å–æ¶ˆç›‘å¬å‡½æ•°
    return () => {
      const index = this.generalListeners.indexOf(listener);
      if (index > -1) {
        this.generalListeners.splice(index, 1);
      }
    };
  }

  /**
   * æ·»åŠ ç‰¹å®šè®¾ç½®é¡¹å˜æ›´ç›‘å¬å™¨
   */
  public addSettingChangeListener<K extends keyof AppSettings>(
    key: K,
    listener: (event: SettingChangeEvent<AppSettings[K]>) => void
  ): () => void {
    const keyStr = key as string;
    if (!this.specificListeners.has(keyStr)) {
      this.specificListeners.set(keyStr, []);
    }
    
    const listeners = this.specificListeners.get(keyStr)!;
    listeners.push(listener as (event: SettingChangeEvent<unknown>) => void);
    
    // è¿”å›å–æ¶ˆç›‘å¬å‡½æ•°
    return () => {
      if (this.specificListeners.has(keyStr)) {
        const listeners = this.specificListeners.get(keyStr)!;
        const index = listeners.indexOf(listener as (event: SettingChangeEvent<unknown>) => void);
        if (index > -1) {
          listeners.splice(index, 1);
        }
        if (listeners.length === 0) {
          this.specificListeners.delete(keyStr);
        }
      }
    };
  }

  /**
   * æ·»åŠ ä¸»é¢˜å˜æ›´ç›‘å¬å™?
   */
  public addThemeChangeListener(listener: (themeMode: ThemeMode, accentColor: string) => void): () => void {
    this.themeListeners.push(listener);
    
    // ç«‹å³é€šçŸ¥å½“å‰ä¸»é¢˜
    const themeMode = this.getSetting('themeMode');
    const accentColor = themeMode === ThemeMode.DARK 
      ? this.getSetting('darkThemeAccentColor') 
      : this.getSetting('accentColor');
    listener(themeMode, accentColor);
    
    // è¿”å›å–æ¶ˆç›‘å¬å‡½æ•°
    return () => {
      const index = this.themeListeners.indexOf(listener);
      if (index > -1) {
        this.themeListeners.splice(index, 1);
      }
    };
  }

  /**
   * æ·»åŠ è¯­è¨€å˜æ›´ç›‘å¬å™?
   */
  public addLanguageChangeListener(listener: (language: LanguageCode) => void): () => void {
    this.languageListeners.push(listener);
    
    // ç«‹å³é€šçŸ¥å½“å‰è¯­è¨€
    let language = this.getSetting('language');
    if (this.getSetting('autoDetectLanguage')) {
      // æ³¨æ„ï¼šè¿™é‡Œä¸ç­‰å¾…å¼‚æ­¥æ£€æµ‹ï¼Œä½¿ç”¨å½“å‰è®¾ç½®
    }
    listener(language);
    
    // è¿”å›å–æ¶ˆç›‘å¬å‡½æ•°
    return () => {
      const index = this.languageListeners.indexOf(listener);
      if (index > -1) {
        this.languageListeners.splice(index, 1);
      }
    };
  }

  /**
   * é€šçŸ¥é€šç”¨è®¾ç½®å˜æ›´
   */
  private notifySettingsChanged(): void {
    for (const listener of this.generalListeners) {
      try {
        listener();
      } catch (error) {
        Logger.error(TAG, `Error in settings listener: ${error}`);
      }
    }
  }

  /**
   * é€šçŸ¥ç‰¹å®šè®¾ç½®é¡¹å˜æ›?
   */
  private notifySettingChanged<T>(
    key: string, oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
   instanceof Error ? oldValue: T,
    newValue: T,
    userInitiated: boolean
   : new Error(String(oldValue: T,
    newValue: T,
    userInitiated: boolean
  ))))))): void {
    const event: SettingChangeEvent<T> = {
      key,
      oldValue,
      newValue,
      timestamp: Date.now(),
      userInitiated
    };
    
    // é€šçŸ¥ç‰¹å®šé”®çš„ç›‘å¬å™?
    if (this.specificListeners.has(key)) {
      const listeners = this.specificListeners.get(key)!;
      for (const listener of listeners) {
        try {
          listener(event);
        } catch (error) {
          Logger.error(TAG, `Error in specific setting listener for ${key}: ${error}`);
        }
      }
    }
  }

  /**
   * é€šçŸ¥ä¸»é¢˜å˜æ›´
   */
  private notifyThemeChanged(themeMode: ThemeMode, accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string : new Error(String(accentColor: string instanceof Error ? accentColor: string : new Error(String(accentColor: string))))))): void {
    for (const listener of this.themeListeners) {
      try {
        listener(themeMode, accentColor);
      } catch (error) {
        Logger.error(TAG, `Error in theme listener: ${error}`);
      }
    }
  }

  /**
   * é€šçŸ¥è¯­è¨€å˜æ›´
   */
  private notifyLanguageChanged(language: LanguageCode): void {
    for (const listener of this.languageListeners) {
      try {
        listener(language);
      } catch (error) {
        Logger.error(TAG, `Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}` instanceof Error ? `Error in language listener: ${error}` : new Error(String(`Error in language listener: ${error}`)))))));
      }
    }
  }

  /**
   * æ¸…ç†è®¾ç½®æœåŠ¡
   */
  public async close(): Promise<void> {
    try {
      // æ¸…ç†ç›‘å¬å™?
      this.generalListeners = [];
      this.specificListeners = {};
      this.themeListeners = [];
      this.languageListeners = [];
      
      Logger.info(TAG, 'Setting service closed');
    } catch (error) {
      Logger.error(TAG, `Error closing setting service: ${error}`);
    }
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®
   * æ›¿ä»£Object.keysï¼Œå…¼å®¹ArkTSè¯­æ³•
   */
  private getObjectKeys<T extends object>(obj: T): string[] {
    const keys: string[] = [];
    for (const key in obj) {
      if (Object.keys(obj).includes(key)) {
        keys.push(key);
      }
    }
    return keys;
  }
}


