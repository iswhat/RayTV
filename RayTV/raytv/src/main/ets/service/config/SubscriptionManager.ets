import Logger from '../../common/util/Logger';
import { Site } from '../../data/bean/Site';
import { SiteManager } from '../spider/SiteManager';
import { ConfigLoader } from './ConfigLoader';
import { ConfigParser } from './ConfigParser';
import { SiteDao } from '../../data/db/dao/SiteDao';
import { SubscriptionDao } from '../../data/dao/SubscriptionDao';

const TAG = 'SubscriptionManager';

/**
 * è®¢é˜…é¡¹æ¥å£å®šä¹? */
export interface SubscriptionItem {
  id: string;              // å”¯ä¸€æ ‡è¯†
  name: string;            // è®¢é˜…åç§°
  url: string;             // è®¢é˜…URL
  description?: string;    // è®¢é˜…æè¿°
  type?: 'all' | 'vod' | 'live'; // è®¢é˜…ç±»å‹
  updateTime: number;      // æœ€åæ›´æ–°æ—¶é—?  createTime: number;      // åˆ›å»ºæ—¶é—´
  siteCount: number;       // åŒ…å«ç«™ç‚¹æ•°é‡
  enabled: boolean;        // æ˜¯å¦å¯ç”¨
  current: boolean;        // æ˜¯å¦ä¸ºå½“å‰ä½¿ç”¨çš„è®¢é˜…
}

/**
 * è®¢é˜…ç®¡ç†ç»“æœ
 */
export interface SubscriptionResult {
  success: boolean;
  message?: string;
  data?: Record<string, string | number | boolean | null>;
}

/**
 * è®¢é˜…ç®¡ç†å™? * è´Ÿè´£é…ç½®URLçš„è®¢é˜…ç®¡ç†ã€æ›´æ–°å’Œåˆ‡æ¢
 */
export class SubscriptionManager {
  private static instance: SubscriptionManager | null = null;
  private subscriptions: Map<string, SubscriptionItem> = new Map();
  private siteManager: SiteManager;
  private configLoader: ConfigLoader;
  private configParser: ConfigParser;
  private siteDao: SiteDao;
  private subscriptionDao: SubscriptionDao;
  private initialized: boolean = false;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): SubscriptionManager {
    if (!SubscriptionManager.instance) {
      SubscriptionManager.instance = new SubscriptionManager();
    }
    return SubscriptionManager.instance;
  }

  /**
   * æ„é€ å‡½æ•?   */
  private constructor() {
    this.siteManager = SiteManager.getInstance();
    this.configLoader = ConfigLoader.getInstance();
    this.configParser = ConfigParser.getInstance();
    this.siteDao = new SiteDao();
    this.subscriptionDao = new SubscriptionDao();
    Logger.info(TAG, 'SubscriptionManager initialized');
  }

  private context?: Record<string, string | number | boolean | null>;

  /**
   * åˆå§‹åŒ–è®¢é˜…ç®¡ç†å™¨
   * @param context åº”ç”¨ä¸Šä¸‹æ–?   */
  public async initialize(context?: Record<string, string | number | boolean | null>): Promise<void> {
    if (this.initialized) {
      return;
    }

    try {
      // ä¿å­˜ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæä¾›ï¼?      if (context) {
        this.context = context;
      }
      
      Logger.info(TAG, 'Initializing subscription manager...');
      
      // åˆå§‹åŒ–è®¢é˜…è¡¨
      await this.subscriptionDao.initTable(context);
      
      // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½è®¢é˜…é…ç½®
      await this.loadSubscriptions();
      
      // æ¢å¤å½“å‰è®¢é˜…çš„ç«™ç‚?      const currentSubscription = this.getCurrentSubscription();
      if (currentSubscription && currentSubscription.enabled) {
        Logger.info(TAG, `Restoring sites for current subscription: ${currentSubscription.name}`);
        try {
          // åŠ è½½é…ç½®å¹¶æ³¨å†Œç«™ç‚?          const configContent = await this.configLoader.loadFromUrl(currentSubscription.url);
          const sites = this.configParser.parseSites(configContent);
          await this.siteManager.registerSites(sites);
        } catch (error) {
          Logger.error(TAG, `Failed to restore current subscription sites: ${error}`);
        }
      }
      
      this.initialized = true;
      Logger.info(TAG, `Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions` instanceof Error ? `Subscription manager initialized with ${this.subscriptions.size} subscriptions` : new Error(String(`Subscription manager initialized with ${this.subscriptions.size} subscriptions`)))))));
    } catch (error) {
      Logger.error(TAG, `Failed to initialize subscription manager: ${error}`);
      throw error;
    }
  }

  /**
   * æ·»åŠ è®¢é˜…
   * @param name è®¢é˜…åç§°
   * @param url è®¢é˜…URL
   * @param description è®¢é˜…æè¿°
   */
  public async addSubscription(name: string, url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string : new Error(String(url: string, description?: string instanceof Error ? url: string, description?: string : new Error(String(url: string, description?: string))))))): Promise<SubscriptionResult> {
    try {
      // éªŒè¯URLæ ¼å¼
      if (!this.isValidUrl(url)) {
        return {
          success: false,
          message: 'æ— æ•ˆçš„URLæ ¼å¼'
        };
      }

      // ç”Ÿæˆè®¢é˜…ID
      const id = this.generateSubscriptionId(url);
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„è®¢é˜?      if (this.subscriptions.has(id)) {
        return {
          success: false,
          message: 'è®¢é˜…URLå·²å­˜åœ?
        };
      }

      // æµ‹è¯•è®¢é˜…URLæ˜¯å¦å¯è®¿é—?      const testResult = await this.testSubscriptionUrl(url);
      if (!testResult.success) {
        return testResult;
      }

      // åˆ›å»ºè®¢é˜…é¡?      const subscription: SubscriptionItem = {
        id,
        name,
        url,
        description,
        updateTime: Date.now(),
        createTime: Date.now(),
        siteCount: (testResult.data?.sites?.length || 0),
        enabled: true,
        current: false
      };

      // æ·»åŠ åˆ°è®¢é˜…åˆ—è¡?      this.subscriptions.set(id, subscription);
      
      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveSubscriptions();

      Logger.info(TAG, `Added subscription: ${name} (${url})`);
      return {
        success: true,
        message: 'è®¢é˜…æ·»åŠ æˆåŠŸ',
        data: subscription
      };
    } catch (error) {
      Logger.error(TAG, `Failed to add subscription: ${error}`);
      return {
        success: false, message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ·»åŠ è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * åˆ é™¤è®¢é˜…
   * @param subscriptionId è®¢é˜…ID
   */
  public async deleteSubscription(subscriptionId: string): Promise<SubscriptionResult> {
    try {
      const subscription = this.subscriptions.get(subscriptionId);
      if (!subscription) {
        return {
          success: false,
          message: 'è®¢é˜…ä¸å­˜åœ?
        };
      }

      // å¦‚æœæ˜¯å½“å‰ä½¿ç”¨çš„è®¢é˜…ï¼Œå…ˆåœç”¨
      if (subscription.current) {
        await this.disableCurrentSubscription();
      }

      // ä»è®¢é˜…åˆ—è¡¨ä¸­ç§»é™¤
      this.subscriptions.delete(subscriptionId);
      
      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveSubscriptions();

      Logger.info(TAG, `Deleted subscription: ${subscription.name}`);
      return {
        success: true,
        message: 'è®¢é˜…åˆ é™¤æˆåŠŸ'
      };
    } catch (error) {
      Logger.error(TAG, `Failed to delete subscription: ${error}`);
      return {
        success: false, message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ é™¤è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * æ›´æ–°è®¢é˜…
   * @param subscriptionId è®¢é˜…ID
   * @param data æ›´æ–°æ•°æ®
   */
  public async updateSubscription(subscriptionId: string, data: Partial<SubscriptionItem>): Promise<SubscriptionResult> {
    try {
      const subscription = this.subscriptions.get(subscriptionId);
      if (!subscription) {
        return {
          success: false,
          message: 'è®¢é˜…ä¸å­˜åœ?
        };
      }

      // æ›´æ–°è®¢é˜…ä¿¡æ¯
      const updatedSubscription: Record<string, string | number | boolean | null> = { ... };

      // å¦‚æœæ›´æ–°äº†URLï¼Œéœ€è¦é‡æ–°ç”ŸæˆID
      if (data.url && data.url !== subscription.url) {
        // éªŒè¯æ–°URL
        if (!this.isValidUrl(data.url)) {
          return {
            success: false,
            message: 'æ— æ•ˆçš„URLæ ¼å¼'
          };
        }

        // æ£€æŸ¥æ–°URLæ˜¯å¦å·²å­˜åœ?        const newId = this.generateSubscriptionId(data.url);
        if (this.subscriptions.has(newId) && newId !== subscriptionId) {
          return {
            success: false,
            message: 'æ–°URLå·²å­˜åœ¨è®¢é˜?
          };
        }

        // ä»æ—§IDç§»é™¤
        this.subscriptions.delete(subscriptionId);
        
        // ç”¨æ–°IDæ·»åŠ 
        updatedSubscription.id = newId;
        this.subscriptions.set(newId, updatedSubscription);
      } else {
        this.subscriptions.set(subscriptionId, updatedSubscription);
      }

      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveSubscriptions();

      Logger.info(TAG, `Updated subscription: ${updatedSubscription.name}`);
      return {
        success: true,
        message: 'è®¢é˜…æ›´æ–°æˆåŠŸ',
        data: updatedSubscription
      };
    } catch (error) {
      Logger.error(TAG, `Failed to update subscription: ${error}`);
      return {
        success: false, message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `æ›´æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * åˆ·æ–°è®¢é˜…
   * @param subscriptionId è®¢é˜…ID
   */
  public async refreshSubscription(subscriptionId: string): Promise<SubscriptionResult> {
    try {
      const subscription = this.subscriptions.get(subscriptionId);
      if (!subscription) {
        return {
          success: false,
          message: 'è®¢é˜…ä¸å­˜åœ?
        };
      }

      // åŠ è½½æœ€æ–°é…ç½?      const configContent = await this.configLoader.loadFromUrl(subscription.url);
      
      // è§£æç«™ç‚¹é…ç½®
      const sites = this.configParser.parseSites(configContent);
      
      // æ›´æ–°è®¢é˜…ä¿¡æ¯
      subscription.siteCount = sites.length;
      subscription.updateTime = Date.now();
      
      // å¦‚æœæ˜¯å½“å‰è®¢é˜…ï¼Œæ›´æ–°ç«™ç‚¹
      if (subscription.current) {
        // å…ˆç¦ç”¨æ‰€æœ‰å½“å‰ç«™ç‚?        await this.disableCurrentSites();
        
        // æ³¨å†Œæ–°ç«™ç‚?        await this.siteManager.registerSites(sites);
      }

      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveSubscriptions();

      Logger.info(TAG, `Refreshed subscription: ${subscription.name}, loaded ${sites.length} sites`);
      return {
        success: true,
        message: `è®¢é˜…åˆ·æ–°æˆåŠŸï¼Œå…±${sites.length}ä¸ªç«™ç‚¹`,
        data: {
          subscription,
          sites
        }
      };
    } catch (error) {
      Logger.error(TAG, `Failed to refresh subscription: ${error}`);
      return {
        success: false, message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ·æ–°è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * åˆ‡æ¢åˆ°æŒ‡å®šè®¢é˜?   * @param subscriptionId è®¢é˜…ID
   */
  public async switchToSubscription(subscriptionId: string): Promise<SubscriptionResult> {
    try {
      const subscription = this.subscriptions.get(subscriptionId);
      if (!subscription) {
        return {
          success: false,
          message: 'è®¢é˜…ä¸å­˜åœ?
        };
      }

      if (!subscription.enabled) {
        return {
          success: false,
          message: 'è®¢é˜…å·²ç¦ç”?
        };
      }

      // åœç”¨å½“å‰è®¢é˜…
      await this.disableCurrentSubscription();

      // è®¾ç½®æ–°çš„å½“å‰è®¢é˜…
      subscription.current = true;
      
      // åŠ è½½è®¢é˜…é…ç½®
      const configContent = await this.configLoader.loadFromUrl(subscription.url);
      const sites = this.configParser.parseSites(configContent);
      
      // æ³¨å†Œç«™ç‚¹
      await this.siteManager.registerSites(sites);
      
      // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
      await this.saveSubscriptions();

      Logger.info(TAG, `Switched to subscription: ${subscription.name}, loaded ${sites.length} sites`);
      return {
        success: true,
        message: `æˆåŠŸåˆ‡æ¢åˆ°è®¢é˜?${subscription.name}"`,
        data: sites
      };
    } catch (error) {
      Logger.error(TAG, `Failed to switch subscription: ${error}`);
      return {
        success: false, message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `åˆ‡æ¢è®¢é˜…å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * ç¦ç”¨å½“å‰è®¢é˜…
   */
  private async disableCurrentSubscription(): Promise<void> {
    // ç¦ç”¨æ‰€æœ‰ç«™ç‚?    await this.disableCurrentSites();
    
    // é‡ç½®æ‰€æœ‰è®¢é˜…çš„currentçŠ¶æ€?    for (const subscription of this.subscriptions.values()) {
      subscription.current = false;
    }
  }

  /**
   * ç¦ç”¨å½“å‰æ‰€æœ‰ç«™ç‚?   */
  private async disableCurrentSites(): Promise<void> {
    const sites = this.siteManager.getAllSites();
    for (const site of sites) {
      await this.siteManager.setSiteEnabled(site.key, false);
    }
  }

  /**
   * æµ‹è¯•è®¢é˜…URL
   * @param url è®¢é˜…URL
   */
  public async testSubscriptionUrl(url: string): Promise<SubscriptionResult> {
    try {
      Logger.info(TAG, `Testing subscription URL: ${url}`);
      
      // åŠ è½½é…ç½®
      const configContent = await this.configLoader.loadFromUrl(url);
      
      // è§£æç«™ç‚¹
      const sites = this.configParser.parseSites(configContent);
      
      // éªŒè¯ç«™ç‚¹æ•°é‡
      if (sites.length === 0) {
        return {
          success: false,
          message: 'é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆç«™ç‚¹'
        };
      }
      
      return {
        success: true,
        message: `URLè®¿é—®æˆåŠŸï¼Œå‘ç?{sites.length}ä¸ªç«™ç‚¹`,
        data: { sites }
      };
    } catch (error) {
      Logger.error(TAG, `Failed to test subscription URL: ${error}`);
      return {
        success: false, message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error instanceof Error ? message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error : new Error(String(message: `URLæµ‹è¯•å¤±è´¥: ${error instanceof Error ? error.message : String(error)))))))}`
      };
    }
  }

  /**
   * è·å–æ‰€æœ‰è®¢é˜?   */
  public getAllSubscriptions(): SubscriptionItem[] {
    return Array.from(this.subscriptions.values());
  }

  /**
   * è·å–è®¢é˜…è¯¦æƒ…
   * @param subscriptionId è®¢é˜…ID
   */
  public getSubscription(subscriptionId: string): SubscriptionItem | undefined {
    return this.subscriptions.get(subscriptionId);
  }

  /**
   * è·å–å½“å‰ä½¿ç”¨çš„è®¢é˜?   */
  public getCurrentSubscription(): SubscriptionItem | undefined {
    return Array.from(this.subscriptions.values()).find(sub => sub.current);
  }

  /**
   * ç”Ÿæˆè®¢é˜…ID
   * @param url è®¢é˜…URL
   */
  private generateSubscriptionId(url: string): string {
    // ç®€å•çš„URLå“ˆå¸Œä½œä¸ºè®¢é˜…ID
    let hash = 0;
    for (let i = 0; i < url.length; i++) {
      const char = url.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return `sub_${Math.abs(hash).toString(36)}`;
  }

  /**
   * éªŒè¯URLæ ¼å¼
   * @param url URLå­—ç¬¦ä¸?   */
  private isValidUrl(url: string): boolean {
    try {
      new URL(url);
      return true;
    } catch {
      // ç®€å•çš„URLæ ¼å¼æ£€æŸ¥ä½œä¸ºå¤‡ç”?      return /^https?:\/\/.+/.test(url);
    }
  }

  /**
   * ä¿å­˜è®¢é˜…åˆ—è¡¨åˆ°æŒä¹…åŒ–å­˜å‚¨
   */
  private async saveSubscriptions(): Promise<void> {
    try {
      const subscriptions = Array.from(this.subscriptions.values());
      Logger.info(TAG, `Saving ${subscriptions.length} subscriptions`);
      
      // æ‰¹é‡ä¿å­˜è®¢é˜…
      await this.subscriptionDao.saveAll(subscriptions);
    } catch (error) {
      Logger.error(TAG, `Failed to save subscriptions: ${error}`);
      // ä¿å­˜å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ?    }
  }

  /**
   * ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½è®¢é˜…åˆ—è¡¨
   */
  private async loadSubscriptions(): Promise<void> {
    try {
      Logger.info(TAG, 'Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage' instanceof Error ? 'Loading subscriptions from storage' : new Error(String('Loading subscriptions from storage')))))));
      
      // ä»æ•°æ®åº“åŠ è½½è®¢é˜…
      const subscriptions = await this.subscriptionDao.getAll();
      
      // æ¸…ç©ºç°æœ‰è®¢é˜…
      this.subscriptions.clear();
      
      // æ·»åŠ åˆ°å†…å­?      subscriptions.forEach(subscription => {
        this.subscriptions.set(subscription.id, subscription);
      });
      
      Logger.info(TAG, `Loaded ${subscriptions.length} subscriptions from storage`);
    } catch (error) {
      Logger.error(TAG, `Failed to load subscriptions: ${error}`);
    }
  }
}

export function getSubscriptionManager(): SubscriptionManager {
  return SubscriptionManager.getInstance();
}



