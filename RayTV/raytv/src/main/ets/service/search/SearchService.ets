// æœç´¢æœåŠ¡
// æä¾›å…¨é¢çš„æœç´¢åŠŸèƒ½ï¼ŒåŒ…æ‹¬è·¨ç«™ç‚¹æœç´¢ã€é«˜çº§è¿‡æ»¤ã€å†å²è®°å½•ç®¡ç†ã€çƒ­é—¨æœç´¢ç­‰

import { StorageUtil } from '../../common/util/StorageUtil';
import { SiteManager } from '../spider/SiteManager';
import { VideoItem } from '../../data/bean/Vod';
import { LiveChannel } from '../../data/bean/Live';
import { AnalyticsService } from '../analytics/AnalyticsService';
import Logger from '../../common/util/Logger';
import ConfigService from '../config/ConfigService';
import pinyinUtil from '../../common/util/PinyinUtil';
import { VodRepository } from '../../data/repository/VodRepository';

// å¸¸é‡å®šä¹‰
const TAG = 'SearchService';
const MAX_HISTORY_ITEMS = 100;
const MIN_SEARCH_LENGTH = 1;
const HOT_SEARCH_UPDATE_INTERVAL = 3600000; // 1å°æ—¶

// æœç´¢ç±»å‹æšä¸¾
export enum SearchType {
  ALL = 'all',             // å…¨éƒ¨æœç´¢
  TITLE = 'title',         // æ ‡é¢˜æœç´¢
  ACTOR = 'actor',         // æ¼”å‘˜æœç´¢
  DIRECTOR = 'director',   // å¯¼æ¼”æœç´¢
  GENRE = 'genre',         // ç±»å‹æœç´¢
  TAG = 'tag'              // æ ‡ç­¾æœç´¢
}

// æœç´¢ç»“æœç±»å‹æšä¸¾
export enum SearchResultType {
  MOVIE = 'movie',         // ç”µå½±
  TV_SERIES = 'tv_series', // ç”µè§†å‰?  LIVE = 'live',           // ç›´æ’­
  CHANNEL = 'channel',     // é¢‘é“
  ACTOR = 'actor',         // æ¼”å‘˜
  DIRECTOR = 'director',   // å¯¼æ¼”
  GENRE = 'genre',         // ç±»å‹
  TAG = 'tag'              // æ ‡ç­¾
}

// æœç´¢è¿‡æ»¤é€‰é¡¹æ¥å£
export interface SearchFilter {
  types?: SearchResultType[]; // ç»“æœç±»å‹è¿‡æ»¤
  yearFrom?: number;         // èµ·å§‹å¹´ä»½
  yearTo?: number;           // ç»“æŸå¹´ä»½
  genres?: string[];         // ç±»å‹è¿‡æ»¤
  countries?: string[];      // å›½å®¶è¿‡æ»¤
  languages?: string[];      // è¯­è¨€è¿‡æ»¤
  minRating?: number;        // æœ€ä½è¯„åˆ?  maxDuration?: number;      // æœ€å¤§æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼?  sortBy?: 'relevance' | 'date' | 'rating' | 'popularity'; // æ’åºæ–¹å¼
  sortOrder?: 'asc' | 'desc'; // æ’åºé¡ºåº
}

// æœç´¢ç»“æœé¡¹æ¥å?export interface SearchResultItem {
  id: string;               // ç»“æœID
  type: SearchResultType;   // ç»“æœç±»å‹
  title: string;            // æ ‡é¢˜
  subtitle?: string;        // å‰¯æ ‡é¢?  description?: string;     // æè¿°
  posterUrl?: string;       // æµ·æŠ¥URL
  coverUrl?: string;        // å°é¢URL
  year?: number;            // å¹´ä»½
  rating?: number;          // è¯„åˆ†
  genre?: string[];         // ç±»å‹
  country?: string;         // å›½å®¶
  language?: string;        // è¯­è¨€
  duration?: number;        // æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  matchScore?: number;      // åŒ¹é…å¾—åˆ†
  highlight?: {
    title?: string[];       // æ ‡é¢˜é«˜äº®ä½ç½®
    description?: string[]; // æè¿°é«˜äº®ä½ç½®
  };
  meta?: { viewCount?: number; extraData?: Record<string, unknown> }; // é¢å¤–å…ƒæ•°æ?  siteKey?: string;         // ç«™ç‚¹é”?  siteName?: string;        // ç«™ç‚¹åç§°
}

// æœç´¢ç»“æœæ¥å£
export interface SearchResponse {
  query: string;            // æœç´¢è¯?  total: number;            // æ€»ç»“æœæ•°
  items: SearchResultItem[]; // ç»“æœé¡¹åˆ—è¡?  page: number;             // å½“å‰é¡µç 
  pageSize: number;         // æ¯é¡µå¤§å°
  filters: SearchFilter;    // åº”ç”¨çš„è¿‡æ»¤æ¡ä»?  searchType: SearchType;   // æœç´¢ç±»å‹
  searchTime: number;       // æœç´¢è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  successSites?: number;    // æˆåŠŸçš„ç«™ç‚¹æ•°é‡?  totalSites?: number;      // æ€»ç«™ç‚¹æ•°é‡?}

// æœç´¢å†å²é¡¹æ¥å?export interface SearchHistoryItem {
  id: string;               // å†å²è®°å½•ID
  keyword: string;          // æœç´¢è¯?  timestamp: number;        // æœç´¢æ—¶é—´
  resultCount: number;      // ç»“æœæ•°é‡
  clickCount: number;       // ç‚¹å‡»æ¬¡æ•°
  lastClickTime?: number;   // æœ€åç‚¹å‡»æ—¶é—?  searchType: SearchType;   // æœç´¢ç±»å‹
  type?: 'vod' | 'live';    // å…¼å®¹æ—§æ¥å?  filters?: SearchFilter;   // ä½¿ç”¨çš„è¿‡æ»¤æ¡ä»?}

// çƒ­é—¨æœç´¢é¡¹æ¥å?export interface HotSearchItem {
  id: string;               // çƒ­é—¨æœç´¢ID
  keyword: string;          // å…³é”®è¯?  rank: number;             // æ’å
  searchCount: number;      // æœç´¢æ¬¡æ•°
  trend: 'up' | 'down' | 'stable'; // è¶‹åŠ¿
  changeCount?: number;     // å˜åŒ–æ•°é‡
  isNew?: boolean;          // æ˜¯å¦æ–°ä¸Šæ¦?  category?: string;        // åˆ†ç±»
  imageUrl?: string;        // å›¾ç‰‡URL
  tag?: string;             // æ ‡ç­¾
}

// æœç´¢å»ºè®®é¡¹æ¥å?export interface SearchSuggestionItem {
  text: string;             // å»ºè®®æ–‡æœ¬
  type: 'query' | 'tag' | 'actor' | 'director'; // å»ºè®®ç±»å‹
  count?: number;           // ç›¸å…³ç»“æœæ•°é‡
  highlight?: boolean;      // æ˜¯å¦é«˜äº®æ˜¾ç¤º
  icon?: string;            // å›¾æ ‡
}

// æœç´¢é…ç½®æ¥å£
export interface SearchConfig {
  enableHistory: boolean;   // æ˜¯å¦å¯ç”¨å†å²è®°å½•
  enableSuggestions: boolean; // æ˜¯å¦å¯ç”¨æœç´¢å»ºè®®
  enableHotSearches: boolean; // æ˜¯å¦å¯ç”¨çƒ­é—¨æœç´¢
  maxHistoryItems: number;  // æœ€å¤§å†å²è®°å½•æ•°é‡?  minSearchLength: number;  // æœ€å°æœç´¢é•¿åº?  autoSearchDelay: number;  // è‡ªåŠ¨æœç´¢å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  saveHistoryOnEnter: boolean; // æŒ‰Enteræ—¶ä¿å­˜å†å?  saveHistoryOnClick: boolean; // ç‚¹å‡»å»ºè®®æ—¶ä¿å­˜å†å?  highlightResults: boolean; // æ˜¯å¦é«˜äº®æœç´¢ç»“æœ
  searchInDescription: boolean; // æ˜¯å¦åœ¨æè¿°ä¸­æœç´¢
}

// é»˜è®¤æœç´¢é…ç½®
export const DEFAULT_SEARCH_CONFIG: SearchConfig = {
  enableHistory: true,
  enableSuggestions: true,
  enableHotSearches: true,
  maxHistoryItems: MAX_HISTORY_ITEMS,
  minSearchLength: MIN_SEARCH_LENGTH,
  autoSearchDelay: 500,
  saveHistoryOnEnter: true,
  saveHistoryOnClick: true,
  highlightResults: true,
  searchInDescription: true
};

// æœç´¢ç›‘å¬å™¨å›è°ƒç±»å?type SearchListener = (response: SearchResponse) => void;

// æœç´¢å»ºè®®ç›‘å¬å™¨å›è°ƒç±»å?type SuggestionListener = (suggestions: SearchSuggestionItem[]) => void;

export class SearchService {
  static instance: SearchService;
  storageUtil: StorageUtil;
  siteManager: SiteManager;
  analyticsService: AnalyticsService;
  configService: ConfigService;
  searchHistory: SearchHistoryItem[] = [];
  searchCache: Map<string, SearchResponse> = new Map();
  hotSearches: HotSearchItem[] = [];
  lastHotSearchUpdate: number = 0;
  activeSearches: Map<string, SearchResponse> = new Map();
  searchListeners: SearchListener[] = [];
  suggestionListeners: SuggestionListener[] = [];
  isInitialized: boolean = false;
  debounceTimerId: number | null = null;
  lastSearchQuery: string = '';
  config: SearchConfig = DEFAULT_SEARCH_CONFIG;
  maxHistoryCount = 50;
  maxCacheSize = 20;

  constructor() {
    this.storageUtil = StorageUtil.getInstance();
    this.siteManager = SiteManager.getInstance();
    this.analyticsService = AnalyticsService.getInstance();
    this.configService = ConfigService.getInstance();
    this.initialize();
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): SearchService {
    if (!SearchService.instance) {
      SearchService.instance = new SearchService();
    }
    return SearchService.instance;
  }

  /**
   * åˆå§‹åŒ–æœç´¢æœåŠ?   */
  async initialize(): Promise<void> {
    try {
      Logger.info(TAG, 'Initializing search service...');

      // åŠ è½½é…ç½®
      await this.loadConfig();
      
      // åŠ è½½æœç´¢å†å²
      await this.loadSearchHistory();
      
      // åŠ è½½çƒ­é—¨æœç´¢
      if (this.config.enableHotSearches) {
        await this.loadHotSearches();
      }
      
      this.isInitialized = true;
      Logger.info(TAG, 'Search service initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize search service: ${error}`);
    }
  }

  /**
   * æœç´¢è§†é¢‘ï¼ˆé«˜çº§æœç´¢ï¼Œæ”¯æŒå¤šç§è¿‡æ»¤æ¡ä»¶ï¼?   */
  async search(options: {
    query: string;
    type?: SearchType;
    page?: number;
    pageSize?: number;
    filters?: SearchFilter;
    siteKeys?: string[];
    limitPerSite?: number;
    timeout?: number;
  }): Promise<SearchResponse> {
    const { 
      query = '', type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength instanceof Error ? type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength : new Error(String(type = SearchType.ALL, 
      page = 1, 
      pageSize = 20, 
      filters = {},
      siteKeys = [],
      limitPerSite = 20,
      timeout = 10000
    } = options;
    
    // éªŒè¯æœç´¢æ¡ä»¶
    if (query.length < this.config.minSearchLength))))))) {
      throw new Error(`æœç´¢å…³é”®è¯å¿…é¡»è‡³å°?{this.config.minSearchLength}ä¸ªå­—ç¬¦`);
    }
    
    const startTime = Date.now();
    
    try {
      Logger.info(TAG, `æ‰§è¡Œæœç´¢: query=${query}, type=${type}, page=${page}, filters=${JSON.stringify(filters)}`);
      
      // è®°å½•æœç´¢äº‹ä»¶
      this.analyticsService.trackSearch(query);

      // æ£€æŸ¥ç¼“å­?      const cacheKey = this.getCacheKey(query, type, filters, siteKeys, limitPerSite);
      if (this.searchCache.has(cacheKey)) {
        const cachedResult = this.searchCache.get(cacheKey)!;
        await this.addToSearchHistory({
          query,
          resultCount: cachedResult.total,
          searchType: type,
          filters
        });
        this.notifySearchCompleted(cachedResult);
        return cachedResult;
      }

      // è·å–è¦æœç´¢çš„ç«™ç‚¹
      const sites = await this.getSearchableSites(siteKeys);
      
      // æ‰§è¡Œè·¨ç«™ç‚¹æœç´?      const searchResults = await this.searchInSites(query, sites, limitPerSite, timeout);
      
      // åˆå¹¶å’Œè½¬æ¢ç»“æ?      const mergedResults = this.mergeAndTransformSearchResults(searchResults, filters, type);
      
      const searchTime = Date.now() - startTime;
      const response: SearchResponse = {
        query,
        total: mergedResults.total,
        items: mergedResults.items,
        page,
        pageSize,
        filters,
        searchType: type,
        searchTime,
        successSites: mergedResults.successSites,
        totalSites: mergedResults.totalSites
      };
      
      // ä¿å­˜æ´»è·ƒæœç´¢ç»“æœ
      this.activeSearches.set(cacheKey, response);
      
      // é€šçŸ¥ç›‘å¬å™?      this.notifySearchCompleted(response);
      
      // ä¿å­˜åˆ°æœç´¢å†å?      if (this.config.enableHistory && this.config.saveHistoryOnEnter) {
        await this.addToSearchHistory({
          query,
          resultCount: mergedResults.total,
          searchType: type,
          filters
        });
      }
      
      // ç¼“å­˜ç»“æœ
      this.cacheResult(cacheKey, response);
      
      // æ›´æ–°æœ€åæœç´¢è®°å½?      this.lastSearchQuery = query;
      
      return response;
    } catch (error) {
      Logger.error(TAG, `æœç´¢å¤±è´¥: ${error}`);
      throw error;
    }
  }

  /**
   * å…¼å®¹æ—§ç‰ˆæœç´¢æ¥å£
   */
  async searchVod(keyword: string, options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions))))))): Promise<SearchResult> {
    try {
      const response = await this.search({
        query: keyword,
        type: SearchType.ALL,
        filters: {},
        ...options
      });
      
      // è½¬æ¢ä¸ºæ—§ç‰ˆç»“æœæ ¼å¼?      return {
        results: response.items.map(item => ({
          id: item.id,
          title: item.title,
          cover: item.coverUrl || item.posterUrl || '',
          rating: item.rating || 0,
          updateInfo: item.description || '',
          tags: item.genre || [],
          category: '',
          siteKey: item.siteKey,
          originalUrl: '',
          isFavorite: false,
          siteName: item.siteName
        })),
        total: response.total,
        successSites: response.successSites || 0,
        totalSites: response.totalSites || 0
      };
    } catch (error) {
      Logger.error(TAG, `VODæœç´¢å¤±è´¥: ${error}`);
      throw error;
    }
  }

  /**
   * æœç´¢ç›´æ’­é¢‘é“
   * @param keyword æœç´¢å…³é”®è¯?   * @param options æœç´¢é€‰é¡¹
   */
  public async searchLiveChannels(keyword: string, options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions : new Error(String(options?: SearchOptions instanceof Error ? options?: SearchOptions : new Error(String(options?: SearchOptions))))))): Promise<LiveSearchResult> {
    try {
      if (!keyword.trim()) {
        throw new Error('æœç´¢å…³é”®è¯ä¸èƒ½ä¸ºç©?);
      }

      // è®°å½•æœç´¢äº‹ä»¶
      this.analyticsService.trackSearch(keyword, undefined, 0);

      // è·å–æ‰€æœ‰æ´»è·ƒçš„ç›´æ’­ç«™ç‚¹
      const sites = await this.siteManager.getActiveSites();
      const liveSites = sites.filter(site => site.type === 'LIVE' || site.supportedFeatures?.includes('live'));
      
      // æ‰§è¡Œæœç´¢
      const results: LiveChannel[] = [];
      
      for (const site of liveSites) {
        try {
          const channelResults = await this.siteManager.callSiteMethod<LiveChannel[]>(
            site.key,
            'searchLiveChannels',
            [keyword],
            { timeout: 5000 }
          );
          
          if (channelResults && Array.isArray(channelResults)) {
            channelResults.forEach(channel => {
              if (channel) {
                channel.siteKey = site.key;
                channel.siteName = site.name;
                results.push(channel);
              }
            });
          }
        } catch (error) {
          Logger.warn(TAG, `åœ¨ç«™ç‚?${site.name} æœç´¢å¤±è´¥:`, error);
        }
      }

      // ä¿å­˜åˆ°å†å?      await this.addToSearchHistory({
        query: keyword,
        resultCount: results.length,
        searchType: SearchType.ALL,
        type: 'live',
        filters: { types: [SearchResultType.LIVE, SearchResultType.CHANNEL] }
      });
      
      return {
        channels: results,
        total: results.length,
        keyword
      };
    } catch (error) {
      Logger.error(TAG, `ç›´æ’­é¢‘é“æœç´¢å¤±è´¥: ${error}`);
      throw error;
    }
  }

  /**
   * æŒ‰ç±»å‹æœç´¢å†…å®?   */
  public async searchByType(
    query: string, resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   instanceof Error ? resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
   : new Error(String(resultTypes: SearchResultType[],
    options?: Partial<{filters: SearchFilter, page: number, pageSize: number}> 
  ))))))): Promise<SearchResponse> {
    const filters: Record<string, string | number | boolean | null> = { ... };
    return this.search({
      query,
      type: SearchType.ALL,
      filters,
      page: options?.page || 1,
      pageSize: options?.pageSize || 20
    });
  }

  /**
   * åœ¨å¤šä¸ªç«™ç‚¹ä¸­æ‰§è¡Œæœç´¢
   */
  private async searchInSites(keyword: string, sites: Record<string, unknown>[], limitPerSite: number, timeout: number): Promise<SiteSearchResult[]> {
    const promises: Promise<SiteSearchResult>[] = sites.map(async (site) => {
      try {
        const results = await Promise.race([
          this.siteManager.callSiteMethod<Record<string, unknown>[]>(
            site.key,
            'search',
            [keyword, { limit: limitPerSite }],
            { timeout }
          ),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Search timeout')), timeout))
        ]);

        // è½¬æ¢ç»“æœæ ¼å¼
        const videoItems = this.convertToVideoItems(results, site);
        
        return {
          siteKey: site.key,
          siteName: site.name,
          results: videoItems,
          success: true
        };
      } catch (error) {
        Logger.warn(TAG, `åœ¨ç«™ç‚?${site.name} æœç´¢å¤±è´¥:`, error);
        return {
          siteKey: site.key,
          siteName: site.name,
          results: [],
          success: false,
          error: error instanceof Error ? error.message : 'Unknown error'
        };
      }
    });

    return Promise.all(promises);
  }

  /**
   * æœç´¢é¡¹æ¥å£å®šä¹?   */
  interface SearchItem {
    id?: string;
    vodId?: string;
    title?: string;
    name?: string;
    cover?: string;
    img?: string;
    pic?: string;
    rating?: number;
    score?: number;
    updateInfo?: string;
    desc?: string;
    tags?: string[];
    category?: string;
    type?: string;
    url?: string;
  }

  /**
   * è½¬æ¢ä¸ºç»Ÿä¸€çš„è§†é¢‘é¡¹æ ¼å¼
   */
  private convertToVideoItems(results: SearchItem[], site: { key: string; name: string }): VideoItem[] {
    if (!results || !Array.isArray(results)) {
      return [];
    }
    
    return results.map((item: SearchItem) => ({
      id: item.id || item.vodId || `unknown_${Date.now()}_${Math.random()}`,
      title: item.title || item.name || 'æœªçŸ¥æ ‡é¢˜',
      cover: item.cover || item.img || item.pic || '',
      rating: item.rating || item.score || 0,
      updateInfo: item.updateInfo || item.desc || '',
      tags: item.tags || [],
      category: item.category || item.type || '',
      siteKey: site.key,
      originalUrl: item.url || '',
      isFavorite: false
    }));
  }

  /**
   * åˆå¹¶å¹¶è½¬æ¢æœç´¢ç»“æ?   */
  private mergeAndTransformSearchResults(siteResults: SiteSearchResult[], filters: SearchFilter, searchType: SearchType): { 
    items: SearchResultItem[], 
    total: number, 
    successSites: number, 
    totalSites: number 
  } {
    let allItems: SearchResultItem[] = [];
    let totalCount = 0;
    let successSites = 0;

    siteResults.forEach(siteResult => {
      if (siteResult.success) {
        successSites++;
        siteResult.results.forEach(item => {
          // è½¬æ¢ä¸ºSearchResultItemæ ¼å¼
          const searchItem: SearchResultItem = {
            id: item.id,
            type: this.determineResultType(item.category),
            title: item.title,
            description: item.updateInfo,
            coverUrl: item.cover,
            rating: item.rating,
            genre: item.tags,
            siteKey: item.siteKey,
            siteName: siteResult.siteName,
            matchScore: this.calculateMatchScore(item, searchType)
          };
          
          allItems.push(searchItem);
        });
      }
      totalCount += siteResult.results.length;
    });

    // åº”ç”¨è¿‡æ»¤æ¡ä»¶
    allItems = this.applyFilters(allItems, filters);
    
    // åº”ç”¨æ’åº
    allItems = this.sortResults(allItems, filters);
    
    // æ·»åŠ é«˜äº®
    if (this.config.highlightResults) {
      allItems = this.addHighlightToResults(allItems);
    }

    return {
      items: allItems,
      total: allItems.length,
      successSites,
      totalSites: siteResults.length
    };
  }

  /**
   * æ ¹æ®åˆ†ç±»ç¡®å®šç»“æœç±»å‹
   */
  private determineResultType(category: string): SearchResultType {
    const categoryLower = category.toLowerCase();
    if (categoryLower.includes('ç”µå½±')) return SearchResultType.MOVIE;
    if (categoryLower.includes('ç”µè§†å‰?) || categoryLower.includes('å‰§é›†')) return SearchResultType.TV_SERIES;
    return SearchResultType.MOVIE; // é»˜è®¤ç±»å‹
  }

  /**
   * è®¡ç®—åŒ¹é…å¾—åˆ†
   */
  private calculateMatchScore(item: VideoItem, searchType: SearchType): number {
    let score = 50; // åŸºç¡€åˆ?    
    // æ ¹æ®ç±»å‹è°ƒæ•´åˆ†æ•°
    switch (searchType) {
      case SearchType.TITLE:
        score += 30;
        break;
      case SearchType.GENRE:
        if (item.tags && item.tags.length > 0) score += 20;
        break;
      case SearchType.ALL:
      default:
        break;
    }
    
    // æ ¹æ®è¯„åˆ†è°ƒæ•´
    if (item.rating > 8) score += 20;
    else if (item.rating > 6) score += 10;
    
    return score;
  }

  /**
   * åº”ç”¨è¿‡æ»¤æ¡ä»¶
   */
  private applyFilters(items: SearchResultItem[], filters: SearchFilter): SearchResultItem[] {
    return items.filter(item => {
      // ç±»å‹è¿‡æ»¤
      if (filters.types && filters.types.length > 0 && !filters.types.includes(item.type)) {
        return false;
      }
      
      // è¯„åˆ†è¿‡æ»¤
      if (filters.minRating && (item.rating || 0) < filters.minRating) {
        return false;
      }
      
      // å…¶ä»–è¿‡æ»¤æ¡ä»¶å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ?      
      return true;
    });
  }

  /**
   * æ’åºç»“æœ
   */
  private sortResults(items: SearchResultItem[], filters: SearchFilter): SearchResultItem[] {
    const { sortBy = 'relevance', sortOrder = 'desc' } = filters;
    
    return [...items].sort((a, b) => {
      let comparison = 0;
      
      switch (sortBy) {
        case 'rating':
          comparison = (b.rating || 0) - (a.rating || 0);
          break;
        case 'popularity':
          // è¿™é‡Œå¯ä»¥ä½¿ç”¨viewCountç­‰æŒ‡æ ‡ï¼Œå¦‚æœæœ‰çš„è¯?          comparison = (b.meta?.viewCount || 0) - (a.meta?.viewCount || 0);
          break;
        case 'relevance':
        default:
          comparison = (b.matchScore || 0) - (a.matchScore || 0);
          break;
      }
      
      return sortOrder === 'asc' ? comparison : -comparison;
    });
  }

  /**
   * æ·»åŠ é«˜äº®åˆ°ç»“æ?   */
  private addHighlightToResults(items: SearchResultItem[]): SearchResultItem[] {
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦çŸ¥é“å½“å‰æœç´¢è¯æ‰èƒ½æ·»åŠ é«˜äº®
    // åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå¯ä»¥ä»ç¼“å­˜æˆ–å‚æ•°ä¸­è·å–æœç´¢è¯?    return items;
  }

  /**
   * è·å–å¯æœç´¢çš„ç«™ç‚¹
   */
  private async getSearchableSites(siteKeys: string[]): Promise<{ key: string; supportedFeatures?: string[]; }[]> {
    const allSites = await this.siteManager.getActiveSites();
    
    if (siteKeys.length > 0) {
      return allSites.filter(site => siteKeys.includes(site.key));
    }
    
    // è¿”å›æ‰€æœ‰æ”¯æŒæœç´¢çš„ç«™ç‚¹
    return allSites.filter(site => site.supportedFeatures?.includes('search') || true);
  }

  /**
   * æ·»åŠ åˆ°æœç´¢å†å²ï¼ˆæ–°ç‰ˆï¼?   */
  private async addToSearchHistory(data: {
    query: string;
    resultCount: number;
    searchType: SearchType;
    filters?: SearchFilter;
    type?: 'vod' | 'live';
  }): Promise<void> {
    const { query, resultCount, searchType, filters, type = 'vod' } = data;
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„æœç´¢è®°å½?    const existingIndex = this.searchHistory.findIndex(
      item => item.keyword === query && item.searchType === searchType
    );
    
    const now = Date.now();
    
    if (existingIndex >= 0) {
      // æ›´æ–°ç°æœ‰è®°å½•
      this.searchHistory[existingIndex] = {
        ...this.searchHistory[existingIndex],
        resultCount,
        clickCount: this.searchHistory[existingIndex].clickCount + 1,
        lastClickTime: now,
        timestamp: now,
        filters
      };
      // ç§»åˆ°å‰é¢
      const [updatedItem] = this.searchHistory.splice(existingIndex, 1);
      this.searchHistory.unshift(updatedItem);
    } else {
      // æ·»åŠ æ–°è®°å½?      const historyItem: SearchHistoryItem = {
        id: `history_${now}_${Math.random().toString(36).substr(2, 9)}`,
        keyword: query,
        timestamp: now,
        resultCount,
        clickCount: 1,
        searchType,
        type,
        filters
      };
      this.searchHistory.unshift(historyItem);
    }

    // é™åˆ¶æ•°é‡
    const maxItems = Math.max(this.config.maxHistoryItems, this.maxHistoryCount);
    if (this.searchHistory.length > maxItems) {
      this.searchHistory = this.searchHistory.slice(0, maxItems);
    }

    await this.saveSearchHistory();
  }

  /**
   * è·å–æœç´¢å†å²
   */
  public async getSearchHistory(): Promise<SearchHistoryItem[]> {
    await this.loadSearchHistory();
    return [...this.searchHistory];
  }

  /**
   * æ¸…é™¤æœç´¢å†å²
   */
  public async clearSearchHistory(): Promise<void> {
    this.searchHistory = [];
    await this.saveSearchHistory();
    Logger.info(TAG, 'æœç´¢å†å²å·²æ¸…é™?);
  }

  /**
   * åˆ é™¤æŒ‡å®šæœç´¢å†å²
   */
  public async deleteSearchHistory(keyword: string): Promise<void> {
    this.searchHistory = this.searchHistory.filter(item => item.keyword !== keyword);
    await this.saveSearchHistory();
    Logger.info(TAG, `å·²åˆ é™¤æœç´¢å†å²å…³é”®è¯: ${keyword}`);
  }

  /**
   * é€šè¿‡IDåˆ é™¤æœç´¢å†å²é¡?   */
  public async removeSearchHistoryItem(historyId: string): Promise<void> {
    const index = this.searchHistory.findIndex(item => item.id === historyId);
    if (index >= 0) {
      this.searchHistory.splice(index, 1);
      await this.saveSearchHistory();
      Logger.info(TAG, `å·²åˆ é™¤æœç´¢å†å²é¡¹: ${historyId}`);
    }
  }

  /**
   * åŠ è½½æœç´¢å†å²
   */
  private async loadSearchHistory(): Promise<void> {
    try {
      const history = await this.storageUtil.get<SearchHistoryItem[]>('searchHistory', []);
      // å…¼å®¹æ—§æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼
      this.searchHistory = history.map(item => {
        // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼?        if (!item.id && 'keyword' in item) {
          return {
            id: `history_${item.timestamp}_${Math.random().toString(36).substr(2, 9)}`,
            keyword: item.keyword,
            timestamp: item.timestamp,
            resultCount: 0,
            clickCount: 1,
            searchType: SearchType.ALL,
            type: item.type || 'vod'
          };
        }
        return item;
      }).filter(item => item);
      
      Logger.info(TAG, `å·²åŠ è½?${this.searchHistory.length} æ¡æœç´¢å†å²`);
    } catch (error) {
      Logger.error(TAG, `åŠ è½½æœç´¢å†å²å¤±è´¥: ${error}`);
      this.searchHistory = [];
    }
  }

  /**
   * ä¿å­˜æœç´¢å†å²
   */
  private async saveSearchHistory(): Promise<void> {
    try {
      await this.storageUtil.save('searchHistory', this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory : new Error(String(this.searchHistory instanceof Error ? this.searchHistory : new Error(String(this.searchHistory)))))));
    } catch (error) {
      Logger.error(TAG, `ä¿å­˜æœç´¢å†å²å¤±è´¥: ${error}`);
    }
  }

  /**
   * è·å–æœ€è¿‘çš„æœç´¢
   */
  public getRecentSearches(limit: number = 10): SearchHistoryItem[] {
    return [...this.searchHistory]
      .sort((a, b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b))))))) => b.timestamp - a.timestamp)
      .slice(0, limit);
  }

  /**
   * è·å–æœ€å¸¸æœç´?   */
  public getFrequentSearches(limit: number = 10): SearchHistoryItem[] {
    return [...this.searchHistory]
      .sort((a, b) => b.clickCount - a.clickCount)
      .slice(0, limit);
  }

  /**
   * è·å–ç¼“å­˜é”?   */
  private getCacheKey(query: string, type: SearchType, filters: SearchFilter, siteKeys: string[], limitPerSite: number): string {
    const siteKeysStr = siteKeys.join(',') || 'all';
    const filtersStr = JSON.stringify(filters);
    return `${query}_${type}_${siteKeysStr}_${limitPerSite}_${filtersStr}`;
  }

  /**
   * ç¼“å­˜æœç´¢ç»“æœ
   */
  private cacheResult(key: string, result: SearchResponse): void {
    // é™åˆ¶ç¼“å­˜å¤§å°
    if (this.searchCache.size >= this.maxCacheSize) {
      // åˆ é™¤æœ€æ—©çš„ç¼“å­˜
      const firstKey = this.searchCache.keys().next().value;
      this.searchCache.delete(firstKey);
    }
    this.searchCache.set(key, result);
  }

  /**
   * åŠ è½½é…ç½®
   */
  private async loadConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig('searchConfig', DEFAULT_SEARCH_CONFIG);
      if (savedConfig) {
        this.config = { ...DEFAULT_SEARCH_CONFIG, ...savedConfig };
      }
    } catch (error) {
      Logger.error(TAG, `åŠ è½½æœç´¢é…ç½®å¤±è´¥: ${error}`);
    }
  }

  /**
   * ä¿å­˜é…ç½®
   */
  public async saveConfig(config: Partial<SearchConfig>): Promise<void> {
    try {
      this.config = { ...this.config, ...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('searchConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('searchConfig', this.config)))))));
      
      // å¦‚æœå†å²è®°å½•æ•°é‡é…ç½®å˜åŒ–ï¼Œæ¸…ç†è¶…å‡ºé™åˆ¶çš„å†å²
      if (config.maxHistoryItems && this.searchHistory.length > config.maxHistoryItems) {
        this.searchHistory = this.searchHistory.slice(0, config.maxHistoryItems);
        await this.saveSearchHistory();
      }
    } catch (error) {
      Logger.error(TAG, `ä¿å­˜æœç´¢é…ç½®å¤±è´¥: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–é…ç½®
   */
  public getConfig(): SearchConfig {
    return { ...this.config };
  }

  /**
   * åŠ è½½çƒ­é—¨æœç´¢
   */
  private async loadHotSearches(): Promise<void> {
    try {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–?      const now = Date.now();
      if (now - this.lastHotSearchUpdate < HOT_SEARCH_UPDATE_INTERVAL && this.hotSearches.length > 0) {
        Logger.info(TAG, 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? instanceof Error ? 'ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´? : new Error(String('ä½¿ç”¨ç¼“å­˜çš„çƒ­é—¨æœç´?)))))));
        return;
      }
      
      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»APIè·å–çƒ­é—¨æœç´¢
      // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.hotSearches = this.generateMockHotSearches();
      this.lastHotSearchUpdate = now;
      
      Logger.info(TAG, `å·²åŠ è½?${this.hotSearches.length} æ¡çƒ­é—¨æœç´¢`);
    } catch (error) {
      Logger.error(TAG, `åŠ è½½çƒ­é—¨æœç´¢å¤±è´¥: ${error}`);
    }
  }

  /**
   * ç”Ÿæˆæ¨¡æ‹Ÿçƒ­é—¨æœç´¢æ•°æ®
   */
  private generateMockHotSearches(): HotSearchItem[] {
    const mockData = [
      { keyword: 'æµæµªåœ°çƒ3', rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index instanceof Error ? rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index : new Error(String(rank: 1, searchCount: 1234567, trend: 'up', changeCount: 1567 },
      { keyword: 'ç¹èŠ±', rank: 2, searchCount: 987654, trend: 'stable', tag: 'çƒ­æ’­å‰? },
      { keyword: 'åŠŸå¤«ç†ŠçŒ«4', rank: 3, searchCount: 876543, trend: 'up', changeCount: 2345, tag: 'æ–°ä¸Šæ˜? },
      { keyword: 'æ²™ä¸˜2', rank: 4, searchCount: 765432, trend: 'down', changeCount: 123 },
      { keyword: 'å‘¨å†¬é›?, rank: 5, searchCount: 654321, trend: 'up', changeCount: 456, isNew: true },
      { keyword: 'å¼ è‰ºè°?, rank: 6, searchCount: 543210, trend: 'stable' },
      { keyword: 'ç‹‚é£™', rank: 7, searchCount: 432109, trend: 'down', changeCount: 567 },
      { keyword: 'å¤ä»‡è€…è”ç›?', rank: 8, searchCount: 321098, trend: 'up', changeCount: 789, tag: 'é¢„å‘Š' },
      { keyword: 'åŠ¨ç”»ç”µå½±', rank: 9, searchCount: 210987, trend: 'stable', category: 'ç±»å‹' },
      { keyword: 'çº¢æµ·è¡ŒåŠ¨2', rank: 10, searchCount: 109876, trend: 'up', changeCount: 345, isNew: true }
    ];
    
    return mockData.map((item, index))))))) => ({
      id: `hot_${index + 1}`,
      ...item,
      imageUrl: item.rank <= 3 ? `https://example.com/hot${item.rank}.jpg` : undefined
    }));
  }

  /**
   * è·å–çƒ­é—¨æœç´¢è¯ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
   */
  public async getHotSearches(): Promise<string[]> {
    const hotSearchItems = await this.getHotSearchItems();
    return hotSearchItems.map(item => item.keyword);
  }

  /**
   * è·å–çƒ­é—¨æœç´¢é¡¹ï¼ˆæ–°ç‰ˆï¼Œè¿”å›æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼‰
   */
  public async getHotSearchItems(limit: number = 20): Promise<HotSearchItem[]> {
    if (!this.config.enableHotSearches) {
      return [];
    }
    
    // ç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
    await this.loadHotSearches();
    
    return this.hotSearches.slice(0, limit).map(item => ({ ...item }));
  }

  /**
   * åˆ·æ–°çƒ­é—¨æœç´¢
   */
  public async refreshHotSearches(): Promise<HotSearchItem[]> {
    this.lastHotSearchUpdate = 0; // å¼ºåˆ¶æ›´æ–°
    await this.loadHotSearches();
    return this.hotSearches;
  }

  /**
   * è·å–æœç´¢å»ºè®®ï¼ˆæ–°ç‰ˆï¼Œè¿”å›æ›´ä¸°å¯Œçš„å»ºè®®ä¿¡æ¯ï¼?   */
  public async getSearchSuggestions(query: string, maxResults: number = 10): Promise<SearchSuggestionItem[]> {
    if (!this.config.enableSuggestions || query.length < this.config.minSearchLength) {
      return [];
    }
    
    try {
      Logger.debug(TAG, `è·å–æœç´¢å»ºè®®: ${query}`);
      
      const suggestions: SearchSuggestionItem[] = [];
      const lowerQuery = query.toLowerCase();
      
      // 1. ä»æœç´¢å†å²ä¸­è·å–å»ºè®®
      const historySuggestions = this.searchHistory
        .filter(item => item.keyword.toLowerCase().includes(lowerQuery))
        .map(item => ({
          text: item.keyword,
          type: 'query' as const,
          count: item.resultCount,
          highlight: true
        }));
      
      // æ·»åŠ åˆ°å»ºè®®åˆ—è¡?      suggestions.push(...historySuggestions);
      
      // 2. å°è¯•ä»VodRepositoryè·å–å»ºè®®
      try {
        const vodRepository = VodRepository.getInstance();
        let vodResults = await vodRepository.searchVod(query, undefined, maxResults * 3);
        
        if (vodResults && Array.isArray(vodResults)) {
          // è¿‡æ»¤å¹¶è½¬æ¢ä¸ºå»ºè®®æ ¼å¼
          const vodSuggestions = vodResults
            .filter(item => item && item.title)
            .map(item => ({
              text: item.title,
              type: 'query' as const,
              count: item.viewCount || 0
            }));
          
          // åˆå¹¶å»ºè®®ï¼Œå»é‡?          const existingTexts = new Set(suggestions.map(s => s.text));
          vodSuggestions.forEach(suggestion => {
            if (!existingTexts.has(suggestion.text)) {
              suggestions.push(suggestion);
              existingTexts.add(suggestion.text);
            }
          });
        }
      } catch (error) {
        Logger.warn(TAG, 'ä»VodRepositoryè·å–å»ºè®®å¤±è´¥:', error);
      }
      
      // æ’åºå’Œé™åˆ¶æ•°é‡?      suggestions.sort((a, b) => {
        // é«˜äº®é¡¹ä¼˜å…?        if (a.highlight && !b.highlight) return -1;
        if (!a.highlight && b.highlight) return 1;
        // ç„¶åæŒ‰ç›¸å…³åº¦æ’åº
        return (b.count || 0) - (a.count || 0);
      });
      
      return suggestions.slice(0, maxResults);
    } catch (error) {
      Logger.error(TAG, `è·å–æœç´¢å»ºè®®å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœç´¢å»ºè®®ï¼ˆå…¼å®¹æ—§æ¥å£ï¼Œåªè¿”å›å­—ç¬¦ä¸²æ•°ç»„ï¼‰
   */
  public async getSearchSuggestionTexts(keyword: string): Promise<string[]> {
    const suggestions = await this.getSearchSuggestions(keyword);
    return suggestions.map(item => item.text);
  }

  /**
   * é€šçŸ¥æœç´¢å®Œæˆ
   */
  private notifySearchCompleted(response: SearchResponse): void {
    for (const listener of this.searchListeners) {
      try {
        listener({ ...response });
      } catch (error) {
        Logger.error(TAG, `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` instanceof Error ? `æœç´¢ç›‘å¬å™¨é”™è¯? ${error}` : new Error(String(`æœç´¢ç›‘å¬å™¨é”™è¯? ${error}`)))))));
      }
    }
  }

  /**
   * é€šçŸ¥å»ºè®®æ›´æ–°
   */
  private notifySuggestionsUpdated(suggestions: SearchSuggestionItem[]): void {
    for (const listener of this.suggestionListeners) {
      try {
        listener([...suggestions]);
      } catch (error) {
        Logger.error(TAG, `å»ºè®®ç›‘å¬å™¨é”™è¯? ${error}`);
      }
    }
  }

  /**
   * æ·»åŠ æœç´¢ç›‘å¬å™?   */
  public addSearchListener(listener: SearchListener): void {
    this.searchListeners.push(listener);
  }

  /**
   * ç§»é™¤æœç´¢ç›‘å¬å™?   */
  public removeSearchListener(listener: SearchListener): void {
    const index = this.searchListeners.indexOf(listener);
    if (index > -1) {
      this.searchListeners.splice(index, 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1)))))));
    }
  }

  /**
   * æ·»åŠ æœç´¢å»ºè®®ç›‘å¬å™?   */
  public addSuggestionListener(listener: SuggestionListener): void {
    this.suggestionListeners.push(listener);
  }

  /**
   * ç§»é™¤æœç´¢å»ºè®®ç›‘å¬å™?   */
  public removeSuggestionListener(listener: SuggestionListener): void {
    const index = this.suggestionListeners.indexOf(listener);
    if (index > -1) {
      this.suggestionListeners.splice(index, 1);
    }
  }

  /**
   * è·å–æœ€åä¸€æ¬¡æœç´¢æŸ¥è¯?   */
  public getLastSearchQuery(): string {
    return this.lastSearchQuery;
  }

  /**
   * å…³é—­æœç´¢æœåŠ¡
   */
  public async close(): Promise<void> {
    if (!this.isInitialized) {
      return;
    }

    // æ¸…é™¤å®šæ—¶å™?    if (this.debounceTimerId !== null) {
      clearTimeout(this.debounceTimerId);
    }
    
    // ä¿å­˜æ•°æ®
    await this.saveSearchHistory();

    this.isInitialized = false;
    Logger.info(TAG, 'æœç´¢æœåŠ¡å·²å…³é—?);
  }
}

/**
 * æœç´¢é€‰é¡¹
 */
export interface SearchOptions {
  siteKeys?: string[];
  limitPerSite?: number;
  timeout?: number;
  type?: 'vod' | 'live';
}

/**
 * æœç´¢ç»“æœ
 */
export interface SearchResult {
  results: SearchItem[];
  total: number;
  successSites: number;
  totalSites: number;
}

/**
 * æœç´¢é¡? */
export interface SearchItem extends VideoItem {
  siteName?: string;
}

/**
 * ç«™ç‚¹æœç´¢ç»“æœ
 */
export interface SiteSearchResult {
  siteKey: string;
  siteName: string;
  results: VideoItem[];
  success: boolean;
  error?: string;
}

/**
 * ç›´æ’­æœç´¢ç»“æœ
 */
export interface LiveSearchResult {
  channels: LiveChannel[];
  total: number;
  keyword?: string;
  category?: string;
}

/**
 * æœç´¢å†å²é¡? */
export interface SearchHistoryItem {
  keyword: string;
  type: 'vod' | 'live';
  timestamp: number;
}


