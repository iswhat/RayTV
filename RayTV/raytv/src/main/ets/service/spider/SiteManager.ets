import Logger from '../../common/util/Logger';
import { LoaderType } from './loader/BaseLoader';
import { Site } from '../../data/bean/Site';
import { SiteDao } from '../../data/db/dao/SiteDao';

/**
 * ç«™ç‚¹çŠ¶æ€æšä¸? */
export enum SiteStatus {
  NORMAL = 'normal',
  ERROR = 'error',
  LOADING = 'loading',
  DISABLED = 'disabled'
}

/**
 * ç«™ç‚¹ä¿¡æ¯æ‰©å±•æ¥å£
 */
export interface SiteInfo extends Site {
  status: SiteStatus;
  errorCount: number;
  lastError?: string;
  lastSuccessTime?: number;
  performanceScore?: number;
}

/**
 * ç«™ç‚¹ç®¡ç†å™? * è´Ÿè´£ç«™ç‚¹ä¿¡æ¯çš„æ³¨å†Œã€æ›´æ–°ã€åˆ é™¤å’ŒæŸ¥è¯¢
 */
export class SiteManager {
  private readonly TAG: string = 'SiteManager';
  private static instance: SiteManager | null = null;
  private sites: Map<string, SiteInfo> = new Map();
  private siteDao: SiteDao;
  private initialized: boolean = false;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns SiteManager
   */
  public static getInstance(): SiteManager {
    if (!SiteManager.instance) {
      SiteManager.instance = new SiteManager();
    }
    return SiteManager.instance;
  }

  /**
   * éªŒè¯åŠ è½½å™¨ç±»å?   */
  private validateLoaderType(type: string): void {
    const validTypes = ['jar', 'js', 'py']; // å¯¹åº”LoaderTypeçš„æ‰€æœ‰å€?    if (!validTypes.includes(type)) {
      throw new Error(`Invalid loader type: ${type}`);
    }
  }

  /**
   * æ„é€ å‡½æ•?   * ç§æœ‰æ„é€ å‡½æ•°é˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
   */
  private constructor() {
    this.siteDao = new SiteDao();
    Logger.info(this.TAG, 'SiteManager initialized');
  }

  /**
   * åˆå§‹åŒ–ç«™ç‚¹ç®¡ç†å™¨
   * ä»æ•°æ®åº“åŠ è½½ç«™ç‚¹é…ç½®
   */
  public async initialize(): Promise<void> {
    if (this.initialized) {
      return;
    }

    try {
      Logger.info(this.TAG, 'Initializing site manager...');
      
      // ä»æ•°æ®åº“åŠ è½½ç«™ç‚¹ä¿¡æ¯
      const sites = await this.siteDao.getAll();
      
      // åˆå§‹åŒ–ç«™ç‚¹ä¿¡æ?      for (const site of sites) {
        const siteInfo: SiteInfo = {
          ...site,
          status: site.enabled ? SiteStatus.NORMAL : SiteStatus.DISABLED,
          errorCount: 0,
          performanceScore: 100
        };
        this.sites.set(site.key, siteInfo);
      }
      
      this.initialized = true;
      Logger.info(this.TAG, `Site manager initialized with ${this.sites.size} sites`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize site manager: ${error}`);
      throw error;
    }
  }

  /**
   * æ³¨å†Œç«™ç‚¹
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns Promise<void>
   */
  public async registerSite(site: Site): Promise<void> {
    try {
      // éªŒè¯ç«™ç‚¹ä¿¡æ¯
      this.validateSite(site);
      
      // æ£€æŸ¥ç«™ç‚¹æ˜¯å¦å·²å­˜åœ¨
      if (this.sites.has(site.key)) {
        throw new Error(`Site already exists: ${site.key}`);
      }
      
      // åˆ›å»ºç«™ç‚¹ä¿¡æ¯
      const siteInfo: SiteInfo = {
        ...site, status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo instanceof Error ? status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo : new Error(String(status: site.enabled !== false ? SiteStatus.NORMAL : SiteStatus.DISABLED,
        errorCount: 0,
        performanceScore: 100
      };
      
      // æ·»åŠ åˆ°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
      this.sites.set(site.key, siteInfo)))))));
      await this.siteDao.save(site);
      
      Logger.info(this.TAG, `Registered site: ${site.name} (${site.key})`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to register site: ${error}`);
      throw error;
    }
  }

  /**
   * æ›´æ–°ç«™ç‚¹
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns Promise<void>
   */
  public async updateSite(site: Site): Promise<void> {
    try {
      // éªŒè¯ç«™ç‚¹ä¿¡æ¯
      this.validateSite(site);
      
      // æ£€æŸ¥ç«™ç‚¹æ˜¯å¦å­˜åœ?      const existingSite = this.sites.get(site.key);
      if (!existingSite) {
        throw new Error(`Site not found: ${site.key}`);
      }
      
      // æ›´æ–°ç«™ç‚¹ä¿¡æ¯
      const updatedSiteInfo: SiteInfo = {
        ...site, status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo instanceof Error ? status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo : new Error(String(status: site.enabled !== false ? existingSite.status : SiteStatus.DISABLED,
        errorCount: existingSite.errorCount,
        lastError: existingSite.lastError,
        lastSuccessTime: existingSite.lastSuccessTime,
        performanceScore: existingSite.performanceScore
      };
      
      // æ›´æ–°å†…å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº?      this.sites.set(site.key, updatedSiteInfo)))))));
      await this.siteDao.update(site);
      
      Logger.info(this.TAG, `Updated site: ${site.name} (${site.key})`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to update site: ${error}`);
      throw error;
    }
  }

  /**
   * åˆ é™¤ç«™ç‚¹
   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @returns Promise<void>
   */
  public async deleteSite(siteKey: string): Promise<void> {
    try {
      // æ£€æŸ¥ç«™ç‚¹æ˜¯å¦å­˜åœ?      if (!this.sites.has(siteKey)) {
        throw new Error(`Site not found: ${siteKey}`);
      }
      
      // ä»å†…å­˜å’Œæ•°æ®åº“ä¸­åˆ é™¤
      this.sites.delete(siteKey);
      await this.siteDao.delete(siteKey);
      
      Logger.info(this.TAG, `Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}` instanceof Error ? `Deleted site: ${siteKey}` : new Error(String(`Deleted site: ${siteKey}`)))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to delete site: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–ç«™ç‚¹ä¿¡æ¯
   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @returns SiteInfo | undefined
   */
  public getSite(siteKey: string): SiteInfo | undefined {
    return this.sites.get(siteKey);
  }

  /**
   * è·å–æ‰€æœ‰ç«™ç‚?   * @returns SiteInfo[]
   */
  public getAllSites(): SiteInfo[] {
    return Array.from(this.sites.values());
  }

  /**
   * è·å–å¯ç”¨çš„ç«™ç‚?   * @returns SiteInfo[]
   */
  public getEnabledSites(): SiteInfo[] {
    return Array.from(this.sites.values()).filter(site => 
      site.enabled !== false && site.status !== SiteStatus.DISABLED
    );
  }

  /**
   * è·å–æŒ‡å®šç±»å‹çš„ç«™ç‚?   * @param loaderType åŠ è½½å™¨ç±»å?   * @returns SiteInfo[]
   */
  public getSitesByType(loaderType: LoaderType): SiteInfo[] {
    return Array.from(this.sites.values()).filter(site => site.type === loaderType);
  }

  /**
   * è·å–æ”¯æŒæœç´¢çš„ç«™ç‚?   * @returns SiteInfo[]
   */
  public getSearchableSites(): SiteInfo[] {
    return Array.from(this.sites.values()).filter(site => 
      site.enabled !== false && site.searchable !== false && site.status !== SiteStatus.DISABLED
    );
  }

  /**
   * è·å–æ”¯æŒç‚¹æ’­çš„ç«™ç‚?   * @returns SiteInfo[]
   */
  public getVodSites(): SiteInfo[] {
    return Array.from(this.sites.values()).filter(site => 
      site.enabled !== false && site.tvod !== false && site.status !== SiteStatus.DISABLED
    );
  }

  /**
   * è·å–æ”¯æŒç›´æ’­çš„ç«™ç‚?   * @returns SiteInfo[]
   */
  public getLiveSites(): SiteInfo[] {
    return Array.from(this.sites.values()).filter(site => 
      site.enabled !== false && site.live !== false && site.status !== SiteStatus.DISABLED
    );
  }

  /**
   * æ›´æ–°ç«™ç‚¹çŠ¶æ€?   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @param status ç«™ç‚¹çŠ¶æ€?   * @param errorMessage é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
   */
  public updateSiteStatus(siteKey: string, status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string instanceof Error ? status: SiteStatus, errorMessage?: string : new Error(String(status: SiteStatus, errorMessage?: string))))))): void {
    const site = this.sites.get(siteKey);
    if (site) {
      site.status = status;
      
      if (status === SiteStatus.ERROR) {
        site.errorCount++;
        site.lastError = errorMessage;
        // é™ä½æ€§èƒ½è¯„åˆ†
        site.performanceScore = Math.max(0, site.performanceScore! - 10);
      } else if (status === SiteStatus.NORMAL) {
        site.lastSuccessTime = Date.now();
        // é‡ç½®é”™è¯¯è®¡æ•°å¹¶æé«˜æ€§èƒ½è¯„åˆ†
        site.errorCount = 0;
        site.performanceScore = Math.min(100, site.performanceScore! + 5);
      }
      
      Logger.info(this.TAG, `Updated site status: ${siteKey} -> ${status}`);
    }
  }

  /**
   * è®¾ç½®ç«™ç‚¹å¯ç”¨çŠ¶æ€?   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @param enabled æ˜¯å¦å¯ç”¨
   */
  public async setSiteEnabled(siteKey: string, enabled: boolean): Promise<void> {
    const site = this.sites.get(siteKey);
    if (site) {
      site.enabled = enabled;
      site.status = enabled ? SiteStatus.NORMAL : SiteStatus.DISABLED;
      
      // æ›´æ–°æ•°æ®åº?      await this.siteDao.update(site);
      
      Logger.info(this.TAG, `Set site ${siteKey} enabled: ${enabled}`);
    }
  }

  /**
   * æ‰¹é‡æ³¨å†Œç«™ç‚¹
   * @param sites ç«™ç‚¹ä¿¡æ¯åˆ—è¡¨
   * @returns Promise<void>
   */
  public async registerSites(sites: Site[]): Promise<void> {
    try {
      for (const site of sites) {
        try {
          await this.registerSite(site);
        } catch (error) {
          Logger.warn(this.TAG, `Failed to register site ${site.key}: ${error}`);
          // ç»§ç»­å¤„ç†å…¶ä»–ç«™ç‚¹
        }
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to register sites: ${error}`);
      throw error;
    }
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ç«™ç‚?   * @returns Promise<void>
   */
  public async clearAllSites(): Promise<void> {
    try {
      this.sites.clear();
      await this.siteDao.clearAll();
      Logger.info(this.TAG, 'Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites' : new Error(String('Cleared all sites' instanceof Error ? 'Cleared all sites' : new Error(String('Cleared all sites')))))));
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear sites: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–ç«™ç‚¹æ•°é‡
   * @returns number
   */
  public getSiteCount(): number {
    return this.sites.size;
  }

  /**
   * è·å–å¯ç”¨ç«™ç‚¹æ•°é‡
   * @returns number
   */
  public getEnabledSiteCount(): number {
    return this.getEnabledSites().length;
  }

  /**
   * éªŒè¯ç«™ç‚¹ä¿¡æ¯
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @private
   */
  private validateSite(site: Site): void {
    if (!site.key || !site.name || !site.type) {
      throw new Error('Invalid site: key, name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required' : new Error(String(name and type are required' instanceof Error ? name and type are required' : new Error(String(name and type are required')))))));
    }
    
    // åœ¨ArkTSä¸­ï¼Œæšä¸¾ä¸èƒ½ç›´æ¥ä½œä¸ºå¯¹è±¡ä½¿ç”¨
    this.validateLoaderType(site.type);
    
    if (site.url && !site.url.startsWith('http://') && !site.url.startsWith('https://')) {
      throw new Error(`Invalid URL: ${site.url}`);
    }
  }
}


