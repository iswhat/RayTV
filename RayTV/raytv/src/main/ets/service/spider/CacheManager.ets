import Logger from '../../common/util/Logger';
import FileSystemManager from '@ohos.file.fs';

/**
 * ç¼“å­˜é¡¹æ¥å? */
export interface CacheItem {
  data: Record<string, string | number | boolean | null> | string | number | boolean | null;
  timestamp: number;
  expiry: number;
  size: number;
}

/**
 * ç¼“å­˜é…ç½®æ¥å£
 */
export interface CacheConfig {
  maxSize?: number; // æœ€å¤§ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼?  defaultExpiry?: number; // é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  cleanupInterval?: number; // æ¸…ç†é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  enabled?: boolean; // æ˜¯å¦å¯ç”¨ç¼“å­˜
}

/**
 * ç¼“å­˜ç®¡ç†å™? * å®ç°çˆ¬è™«ç»“æœçš„æœ¬åœ°ç¼“å­˜ï¼Œæ”¯æŒç¼“å­˜è¿‡æœŸç­–ç•¥å’Œæ¸…ç†æœºåˆ? */
export class CacheManager {
  private readonly TAG: string = 'CacheManager';
  private static instance: CacheManager | null = null;
  private memoryCache: Map<string, CacheItem> = new Map();
  private fsManager: FileSystemManager;
  private cacheDir: string = '';
  private config: CacheConfig;
  private totalSize: number = 0;
  private cleanupTimer: number | null = null;

  /**
   * é»˜è®¤ç¼“å­˜é…ç½®
   */
  private static readonly DEFAULT_CONFIG: CacheConfig = {
    maxSize: 100 * 1024 * 1024, // 100MB
    defaultExpiry: 3600 * 1000, // 1å°æ—¶
    cleanupInterval: 300000, // 5åˆ†é’Ÿ
    enabled: true
  };

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns CacheManager
   */
  public static getInstance(): CacheManager {
    if (!CacheManager.instance) {
      CacheManager.instance = new CacheManager();
    }
    return CacheManager.instance;
  }

  /**
   * æ„é€ å‡½æ•?   * ç§æœ‰æ„é€ å‡½æ•°é˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
   */
  private constructor() {
    this.fsManager = FileSystemManager.getFileSystemManager();
    // é¿å…å¯¹è±¡å±•å¼€æ“ä½œç¬¦ï¼Œæ˜¾å¼èµ‹å€¼ç¡®ä¿ç±»å‹å®‰å…?    this.config = {
      maxSize: CacheManager.DEFAULT_CONFIG.maxSize,
      defaultExpiry: CacheManager.DEFAULT_CONFIG.defaultExpiry,
      cleanupInterval: CacheManager.DEFAULT_CONFIG.cleanupInterval,
      enabled: CacheManager.DEFAULT_CONFIG.enabled
    };
    this.initialize();
    Logger.info(this.TAG, 'CacheManager initialized');
  }

  /**
   * åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
   * @private
   */
  private initialize(): void {
    try {
      // è®¾ç½®ç¼“å­˜ç›®å½•
      this.cacheDir = this.getCacheDirectory();
      
      // ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨
      if (!this.fsManager.existsSync(this.cacheDir)) {
        this.fsManager.mkdirSync(this.cacheDir, { recursive: true });
        Logger.info(this.TAG, `Created cache directory: ${this.cacheDir}`);
      }
      
      // å¯åŠ¨å®šæœŸæ¸…ç†
      this.startCleanupTimer();
      
      // åˆå§‹æ¸…ç†
      this.cleanupExpiredCache();
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize cache manager: ${error}`);
    }
  }

  /**
   * è®¾ç½®ç¼“å­˜é…ç½®
   * @param config ç¼“å­˜é…ç½®
   */
  public setConfig(config: CacheConfig): void {
    // é¿å…å¯¹è±¡å±•å¼€æ“ä½œç¬¦ï¼Œæ˜¾å¼åˆå¹¶é…ç½®ç¡®ä¿ç±»å‹å®‰å…¨
    this.config = {
      maxSize: config.maxSize !== null && config.maxSize !== undefined ? config.maxSize : this.config.maxSize, defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config instanceof Error ? defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config : new Error(String(defaultExpiry: config.defaultExpiry !== null && config.defaultExpiry !== undefined ? config.defaultExpiry : this.config.defaultExpiry,
      cleanupInterval: config.cleanupInterval !== null && config.cleanupInterval !== undefined ? config.cleanupInterval : this.config.cleanupInterval,
      enabled: config.enabled !== null && config.enabled !== undefined ? config.enabled : this.config.enabled
    };
    Logger.info(this.TAG, `Updated cache config: ${JSON.stringify(this.config)))))))}`);
    
    // é‡æ–°å¯åŠ¨æ¸…ç†å®šæ—¶å™?    if (this.cleanupTimer) {
      clearInterval(this.cleanupTimer);
    }
    this.startCleanupTimer();
    
    // å¦‚æœç¼“å­˜å¤§å°è¶…é™ï¼Œç«‹å³æ¸…ç?    this.cleanupExcessCache();
  }

  /**
   * è·å–ç¼“å­˜
   * @param key ç¼“å­˜é”?   * @returns ç¼“å­˜æ•°æ®æˆ–null
   */
  public get(key: string): Record<string, string | number | boolean | null> | string | number | boolean | null {
    if (!this.config.enabled) {
      return null;
    }

    try {
      // é¦–å…ˆä»å†…å­˜ç¼“å­˜ä¸­è·å–
      const cacheItem = this.memoryCache.get(key);
      
      if (cacheItem) {
        // æ£€æŸ¥æ˜¯å¦è¿‡æœ?        if (!this.isExpired(cacheItem)) {
          Logger.debug(this.TAG, `Cache hit for key: ${key} (memory)`);
          return cacheItem.data;
        } else {
          // è¿‡æœŸåˆ™ç§»é™?          this.remove(key);
        }
      }
      
      // ä»æ–‡ä»¶ç³»ç»Ÿè·å?      const filePath = this.getCacheFilePath(key);
      if (this.fsManager.existsSync(filePath)) {
        const fileContent = this.fsManager.readTextSync(filePath) as string;
        const fileCacheItem: CacheItem = JSON.parse(fileContent) as CacheItem;
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœ?        if (!this.isExpired(fileCacheItem)) {
          // åŠ è½½åˆ°å†…å­˜ç¼“å­?          this.memoryCache.set(key, fileCacheItem);
          Logger.debug(this.TAG, `Cache hit for key: ${key} (disk)`);
          return fileCacheItem.data;
        } else {
          // è¿‡æœŸåˆ™åˆ é™¤æ–‡ä»?          this.fsManager.unlinkSync(filePath);
        }
      }
      
      Logger.debug(this.TAG, `Cache miss for key: ${key}`);
      return null;
    } catch (error) {
      Logger.error(this.TAG, `Failed to get cache for key ${key}: ${error}`);
      return null;
    }
  }

  /**
   * è®¾ç½®ç¼“å­˜
   * @param key ç¼“å­˜é”?   * @param data ç¼“å­˜æ•°æ®
   * @param expiry è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼Œå¯é€‰ï¼‰
   * @returns boolean
   */
  public set(key: string, data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number instanceof Error ? data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number : new Error(String(data: Record<string, string | number | boolean | null> | string | number | boolean | null, expiry?: number))))))): boolean {
    if (!this.config.enabled) {
      return false;
    }

    try {
      const expiryTime = expiry || this.config.defaultExpiry!;
      const dataString = JSON.stringify(data);
      const size = dataString.length;
      
      // æ£€æŸ¥æ•°æ®å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ?      if (size > this.config.maxSize! * 0.1) { // ä¸ç¼“å­˜è¶…è¿‡æœ€å¤§ç¼“å­?0%çš„æ•°æ?        Logger.warn(this.TAG, `Data too large for caching: ${size} bytes`);
        return false;
      }
      
      const cacheItem: CacheItem = {
        data,
        timestamp: Date.now(),
        expiry: expiryTime,
        size
      };
      
      // æ›´æ–°æ€»å¤§å°?      this.updateTotalSize(key, size);
      
      // ä¿å­˜åˆ°å†…å­˜ç¼“å­?      this.memoryCache.set(key, cacheItem);
      
      // ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»?      const filePath = this.getCacheFilePath(key);
      this.fsManager.writeTextSync(filePath, JSON.stringify(cacheItem));
      
      // æ£€æŸ¥å¹¶æ¸…ç†è¶…å‡ºå¤§å°é™åˆ¶çš„ç¼“å­?      this.cleanupExcessCache();
      
      Logger.debug(this.TAG, `Cached data for key: ${key}, size: ${size} bytes, expiry: ${expiryTime}ms`);
      return true;
    } catch (error) {
      Logger.error(this.TAG, `Failed to set cache for key ${key}: ${error}`);
      return false;
    }
  }

  /**
   * ç§»é™¤ç¼“å­˜
   * @param key ç¼“å­˜é”?   * @returns boolean
   */
  public remove(key: string): boolean {
    try {
      // ä»å†…å­˜ç¼“å­˜ç§»é™?      const cacheItem = this.memoryCache.get(key);
      if (cacheItem) {
        this.totalSize -= cacheItem.size;
        this.memoryCache.delete(key);
      }
      
      // ä»æ–‡ä»¶ç³»ç»Ÿç§»é™?      const filePath = this.getCacheFilePath(key);
      if (this.fsManager.existsSync(filePath)) {
        this.fsManager.unlinkSync(filePath);
      }
      
      Logger.debug(this.TAG, `Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}` instanceof Error ? `Removed cache for key: ${key}` : new Error(String(`Removed cache for key: ${key}`)))))));
      return true;
    } catch (error) {
      Logger.error(this.TAG, `Failed to remove cache for key ${key}: ${error}`);
      return false;
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰ç¼“å­?   * @returns boolean
   */
  public clear(): boolean {
    try {
      // æ¸…ç©ºå†…å­˜ç¼“å­˜
      this.memoryCache.clear();
      this.totalSize = 0;
      
      // æ¸…ç©ºæ–‡ä»¶ç³»ç»Ÿç¼“å­˜
      if (this.fsManager.existsSync(this.cacheDir)) {
        const files = this.fsManager.listSync(this.cacheDir) as string[];
        if (files) {
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const filePath = `${this.cacheDir}/${file}`;
            try {
              // ç›´æ¥åˆ é™¤æ–‡ä»¶ï¼Œä¸æ£€æŸ¥æ–‡ä»¶ç±»å?              this.fsManager.unlinkSync(filePath);
            } catch (error) {
              // å¦‚æœåˆ é™¤å¤±è´¥ï¼Œå¿½ç•¥å¹¶ç»§ç»­
              Logger.warn(this.TAG, `Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}` instanceof Error ? `Failed to delete cache file: ${filePath}, error: ${error}` : new Error(String(`Failed to delete cache file: ${filePath}, error: ${error}`)))))));
            }
          }
        }
      }
      
      Logger.info(this.TAG, 'All cache cleared');
      return true;
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear cache: ${error}`);
      return false;
    }
  }

  /**
   * æ¸…ç©ºç«™ç‚¹ç›¸å…³çš„æ‰€æœ‰ç¼“å­?   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @returns boolean
   */
  public clearSiteCache(siteKey: string): boolean {
    try {
      const keysToRemove: string[] = [];
      
      // æ‰¾å‡ºç«™ç‚¹ç›¸å…³çš„ç¼“å­˜é”®
      for (const key of this.memoryCache.keys()) {
        if (key.startsWith(`${siteKey}:`)) {
          keysToRemove.push(key);
        }
      }
      
      // ç§»é™¤å†…å­˜ç¼“å­˜
      for (const key of keysToRemove) {
        this.remove(key);
      }
      
      // ç§»é™¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç¼“å­˜
      const files = this.fsManager.listSync(this.cacheDir) as string[];
      if (files) {
        for (const file of files) {
          if (file.startsWith(`${this.getCacheKeyHash(`${siteKey}:`)}_`)) {
            this.fsManager.unlinkSync(`${this.cacheDir}/${file}`);
          }
        }
      }
      
      Logger.info(this.TAG, `Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}` instanceof Error ? `Cleared cache for site: ${siteKey}` : new Error(String(`Cleared cache for site: ${siteKey}`)))))));
      return true;
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear site cache for ${siteKey}: ${error}`);
      return false;
    }
  }

  /**
   * è·å–ç¼“å­˜å¤§å°
   * @returns number ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
   */
  public getCacheSize(): number {
    return this.totalSize;
  }

  /**
   * è·å–ç¼“å­˜é¡¹æ•°é‡?   * @returns number
   */
  public getCacheCount(): number {
    return this.memoryCache.size;
  }

  /**
   * æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ä¸”æœªè¿‡æœ?   * @param key ç¼“å­˜é”?   * @returns boolean
   */
  public has(key: string): boolean {
    return this.get(key) !== null;
  }

  /**
   * ç”Ÿæˆçˆ¬è™«æ–¹æ³•çš„ç¼“å­˜é”®
   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @returns string
   */
  public generateCacheKey(siteKey: string, method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null instanceof Error ? method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null : new Error(String(method: string, params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null))))))): string {
    // ç”Ÿæˆå‚æ•°çš„å“ˆå¸Œå€?    const paramsHash = this.generateParamsHash(params);
    return `${siteKey}:${method}:${paramsHash}`;
  }

  /**
   * å¯åŠ¨æ¸…ç†å®šæ—¶å™?   * @private
   */
  private startCleanupTimer(): void {
    if (this.config.enabled && this.config.cleanupInterval) {
      this.cleanupTimer = setInterval(() => {
        this.cleanupExpiredCache();
      }, this.config.cleanupInterval);
      
      Logger.info(this.TAG, `Cleanup timer started with interval: ${this.config.cleanupInterval}ms`);
    }
  }

  /**
   * æ¸…ç†è¿‡æœŸç¼“å­˜
   * @private
   */
  private cleanupExpiredCache(): void {
    try {
      const keysToRemove: string[] = [];
      const currentTime = Date.now();
      
      // æ¸…ç†å†…å­˜ç¼“å­˜ - ä½¿ç”¨æ™®é€šå˜é‡å£°æ˜æ›¿ä»£è§£æ?      const entries = this.memoryCache.entries();
      let entry = entries.next();
      while (!entry.done) {
        const key = entry.value[0];
        const item = entry.value[1];
        if (currentTime > item.timestamp + item.expiry) {
          keysToRemove.push(key);
          this.totalSize -= item.size;
        }
        entry = entries.next();
      }
      
      for (const key of keysToRemove) {
        this.memoryCache.delete(key);
        // åŒæ—¶åˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç¼“å­˜
        const filePath = this.getCacheFilePath(key);
        if (this.fsManager.existsSync(filePath)) {
          this.fsManager.unlinkSync(filePath);
        }
      }
      
      if (keysToRemove.length > 0) {
        Logger.info(this.TAG, `Cleaned ${keysToRemove.length} expired cache items`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to cleanup expired cache: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * æ¸…ç†è¶…å‡ºå¤§å°é™åˆ¶çš„ç¼“å­?   * @private
   */
  private cleanupExcessCache(): void {
    if (this.totalSize > this.config.maxSize!) {
      try {
        // æŒ‰æ—¶é—´æ’åºç¼“å­˜é¡¹ - ä½¿ç”¨æ™®é€šå‡½æ•°æ›¿ä»£è§£æ?        const sortedItems = Array.from(this.memoryCache.entries())
          .sort((entryA, entryB instanceof Error ? entryB : new Error(String(entryB instanceof Error ? entryB instanceof Error ? entryB : new Error(String(entryB : new Error(String(entryB instanceof Error ? entryB : new Error(String(entryB instanceof Error ? entryB instanceof Error ? entryB : new Error(String(entryB instanceof Error ? entryB instanceof Error ? entryB : new Error(String(entryB : new Error(String(entryB instanceof Error ? entryB : new Error(String(entryB : new Error(String(entryB instanceof Error ? entryB : new Error(String(entryB instanceof Error ? entryB instanceof Error ? entryB : new Error(String(entryB : new Error(String(entryB instanceof Error ? entryB : new Error(String(entryB))))))) => {
            const a = entryA[1];
            const b = entryB[1];
            return a.timestamp - b.timestamp;
          });
        
        // ç§»é™¤æœ€æ—§çš„ç¼“å­˜é¡¹ï¼Œç›´åˆ°æ€»å¤§å°åœ¨é™åˆ¶å†?        let removedSize = 0;
        let removedCount = 0;
        
        // ä½¿ç”¨æ™®é€šå˜é‡å£°æ˜æ›¿ä»£è§£æ?        for (const entry of sortedItems) {
          const key = entry[0];
          const item = entry[1];
          if (this.totalSize - removedSize <= this.config.maxSize! * 0.8) { // ä¿ç•™20%çš„ç©ºé—?            break;
          }
          
          this.memoryCache.delete(key);
          removedSize += item.size;
          removedCount++;
          
          // åˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç¼“å­˜
          const filePath = this.getCacheFilePath(key);
          if (this.fsManager.existsSync(filePath)) {
            this.fsManager.unlinkSync(filePath);
          }
        }
        
        this.totalSize -= removedSize;
        Logger.info(this.TAG, `Cleaned ${removedCount} excess cache items, freed ${removedSize} bytes`);
      } catch (error) {
        Logger.error(this.TAG, `Failed to cleanup excess cache: ${error}`);
      }
    }
  }

  /**
   * æ£€æŸ¥ç¼“å­˜é¡¹æ˜¯å¦è¿‡æœŸ
   * @param item ç¼“å­˜é¡?   * @returns boolean
   * @private
   */
  private isExpired(item: CacheItem): boolean {
    return Date.now() > item.timestamp + item.expiry;
  }

  /**
   * æ›´æ–°æ€»ç¼“å­˜å¤§å°?   * @param key ç¼“å­˜é”?   * @param newSize æ–°çš„å¤§å°
   * @private
   */
  private updateTotalSize(key: string, newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number : new Error(String(newSize: number instanceof Error ? newSize: number : new Error(String(newSize: number))))))): void {
    const existingItem = this.memoryCache.get(key);
    if (existingItem) {
      this.totalSize -= existingItem.size;
    }
    this.totalSize += newSize;
  }

  /**
   * è·å–ç¼“å­˜ç›®å½•
   * @returns string
   * @private
   */
  private getCacheDirectory(): string {
    // ä½¿ç”¨åº”ç”¨ç¼“å­˜ç›®å½•
    return `/cache/raytv/spider`;
  }

  /**
   * è·å–ç¼“å­˜æ–‡ä»¶è·¯å¾„
   * @param key ç¼“å­˜é”?   * @returns string
   * @private
   */
  private getCacheFilePath(key: string): string {
    const keyHash = this.getCacheKeyHash(key);
    return `${this.cacheDir}/${keyHash}_${Date.now()}.cache`;
  }

  /**
   * è·å–ç¼“å­˜é”®çš„å“ˆå¸Œå€?   * @param key ç¼“å­˜é”?   * @returns string
   * @private
   */
  private getCacheKeyHash(key: string): string {
    return this.generateHash(key);
  }

  /**
   * ç”Ÿæˆå‚æ•°çš„å“ˆå¸Œå€?   * @param params æ–¹æ³•å‚æ•°
   * @returns string
   * @private
   */
  private generateParamsHash(params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null): string {
    try {
      const sortedParams = this.sortParams(params);
      return this.generateHash(JSON.stringify(sortedParams));
    } catch (error) {
      Logger.error(this.TAG, `Failed to generate params hash: ${error}`);
      return 'error';
    }
  }
  
  /**
   * ç®€å•çš„å­—ç¬¦ä¸²å“ˆå¸Œç”Ÿæˆå‡½æ•?   * @param str è¾“å…¥å­—ç¬¦ä¸?   * @returns å“ˆå¸Œå€¼å­—ç¬¦ä¸²
   * @private
   */
  private generateHash(str: string): string {
    let hash = 0;
    if (str.length === 0) return hash.toString();
    
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // è½¬æ¢ä¸?2ä½æ•´æ•?    }
    
    // è½¬æ¢ä¸?6è¿›åˆ¶å­—ç¬¦ä¸?    return Math.abs(hash).toString(16);
  }

  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®
   * @param obj è¾“å…¥å¯¹è±¡
   * @returns é”®æ•°ç»?   * @private
   */
  private getObjectKeys(obj: Record<string, string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null> : new Error(String(string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null>))))))): string[] {
    // ç›´æ¥ä½¿ç”¨Object.keysè·å–é”®ï¼Œé¿å…for-inå¾ªç¯å’ŒåŸå‹é“¾æ“ä½œ
    return Object.keys(obj);
  }

  /**
   * æ’åºå‚æ•°å¯¹è±¡ï¼Œç¡®ä¿ç›¸åŒå†…å®¹çš„å‚æ•°ç”Ÿæˆç›¸åŒçš„å“ˆå¸Œå€?   * @param params æ–¹æ³•å‚æ•°
   * @returns æ’åºåçš„å‚æ•°
   * @private
   */
  private sortParams(params: Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null): Record<string, string | number | boolean | null> | string[] | number[] | boolean[] | string | number | boolean | null {
    // å¤„ç†åŸºæœ¬ç±»å‹å’Œnull
    if (typeof params !== 'object' || params === null) {
      return params;
    }
    
    // å¤„ç†æ•°ç»„
    if (Array.isArray(params)) {
      // ç¡®ä¿ç±»å‹å®‰å…¨ï¼Œé¿å…unknownç±»å‹çš„é€’å½’
      const typedArray = params as (string | number | boolean | null)[];
      return typedArray.map(item => {
        // ä»…å¯¹å¯¹è±¡ç±»å‹è¿›è¡Œé€’å½’æ’åº
        if (typeof item === 'object' && item !== null) {
          if (Array.isArray(item)) {
            return this.sortParams(item as string[] | number[] | boolean[]);
          } else {
            return this.sortParams(item as Record<string, string | number | boolean | null>);
          }
        }
        return item;
      }) as string[] | number[] | boolean[];
    }
    
    // å¤„ç†å¯¹è±¡
    const sorted: Record<string, string | number | boolean | null> = {};
    const paramObj = params as Record<string, string | number | boolean | null>;
    
    this.getObjectKeys(paramObj).sort().forEach(key => {
      const value = paramObj[key];
      // ä»…å¯¹å¯¹è±¡ç±»å‹è¿›è¡Œé€’å½’æ’åº
      if (typeof value === 'object' && value !== null) {
        if (Array.isArray(value)) {
          sorted[key] = this.sortParams(value as string[] | number[] | boolean[]);
        } else {
          sorted[key] = this.sortParams(value as Record<string, string | number | boolean | null>);
        }
      } else {
        sorted[key] = value;
      }
    });
    
    return sorted;
  }
}


