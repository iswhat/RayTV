import Logger from '../../common/util/Logger';
import { BaseLoader, LoaderType } from './loader';
import { Site } from '../../data/bean/Site';
import { ArkJsLoader, ArkPyLoader, ArkJarLoader } from './loader';

/**
 * åŠ è½½å™¨å·¥å?
 * æ ¹æ®ç«™ç‚¹é…ç½®åˆ›å»ºå¯¹åº”çš„çˆ¬è™«åŠ è½½å™¨
 */
export class LoaderFactory {
  private readonly TAG: string = 'LoaderFactory';
  private static instance: LoaderFactory | null = null;
  private loaderCache: Map<string, BaseLoader> = new Map();
  private maxCacheSize: number = 50; // æœ€å¤§ç¼“å­˜åŠ è½½å™¨æ•°é‡

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns LoaderFactory
   */
  public static getInstance(): LoaderFactory {
    if (!LoaderFactory.instance) {
      LoaderFactory.instance = new LoaderFactory();
    }
    return LoaderFactory.instance;
  }

  /**
   * æ„é€ å‡½æ•?
   * ç§æœ‰æ„é€ å‡½æ•°é˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
   */
  private constructor() {
    Logger.info(this.TAG, 'LoaderFactory initialized');
  }

  /**
   * æ ¹æ®ç«™ç‚¹ä¿¡æ¯åˆ›å»ºåŠ è½½å™?
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns Promise<BaseLoader>
   */
  public async createLoader(site: Site): Promise<BaseLoader> {
    try {
      // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰åŠ è½½å™?
      const cacheKey = this.getCacheKey(site);
      let loader = this.loaderCache.get(cacheKey);
      
      // å¦‚æœåŠ è½½å™¨å­˜åœ¨ä½†å·²é”€æ¯ï¼Œåˆ™ç§»é™¤ç¼“å­?
      if (loader && loader.isDestroyed()) {
        this.loaderCache.delete(cacheKey);
        loader = null;
      }
      
      // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºæ–°çš„åŠ è½½å™¨
      if (!loader) {
        loader = this.createNewLoader(site);
        
        // åˆå§‹åŒ–åŠ è½½å™¨
        await loader.init();
        
        // æ·»åŠ åˆ°ç¼“å­?
        this.addToCache(cacheKey, loader);
        
        Logger.info(this.TAG, `Created new ${loader.getLoaderType()} loader for site: ${site.name} (${site.key})`);
      } else {
        Logger.info(this.TAG, `Using cached loader for site: ${site.name} (${site.key})`);
      }
      
      return loader;
    } catch (error) {
      Logger.error(this.TAG, `Failed to create loader for site ${site.key}: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–ç«™ç‚¹çš„åŠ è½½å™¨
   * å¦‚æœç¼“å­˜ä¸­å­˜åœ¨å·²åˆå§‹åŒ–çš„åŠ è½½å™¨åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åˆ›å»ºæ–°çš?
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns Promise<BaseLoader>
   */
  public async getLoader(site: Site): Promise<BaseLoader> {
    // ç”Ÿæˆç¼“å­˜é”?
    const cacheKey = this.getCacheKey(site);
    
    // æŸ¥æ‰¾ç¼“å­˜ä¸­çš„åŠ è½½å™?
    let loader = this.loaderCache.get(cacheKey);
    
    // å¦‚æœåŠ è½½å™¨å­˜åœ¨ä¸”æœªé”€æ¯ä¸”å·²åˆå§‹åŒ–ï¼Œåˆ™ç›´æ¥è¿”å›
    if (loader && !loader.isDestroyed() && loader.isInitialized()) {
      return loader;
    }
    
    // å¦åˆ™åˆ›å»ºæ–°çš„åŠ è½½å™?
    return this.createLoader(site);
  }

  /**
   * é”€æ¯æŒ‡å®šç«™ç‚¹çš„åŠ è½½å™?
   * @param siteKey ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @returns boolean æ˜¯å¦æˆåŠŸé”€æ¯?
   */
  public async destroyLoader(siteKey: string): Promise<boolean> {
    const cacheKeysToRemove: string[] = [];
    
    // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç¼“å­˜é”?
    for (const [key, loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries( instanceof Error ? loader] of this.loaderCache.entries( : new Error(String(loader] of this.loaderCache.entries()))))))) {
      if (key.startsWith(`${siteKey}:`)) {
        try {
          await loader.destroy();
          cacheKeysToRemove.push(key);
          Logger.info(this.TAG, `Destroyed loader for site: ${siteKey}`);
        } catch (error) {
          Logger.error(this.TAG, `Failed to destroy loader for site ${siteKey}: ${error}`);
        }
      }
    }
    
    // ä»ç¼“å­˜ä¸­ç§»é™¤
    for (const key of cacheKeysToRemove) {
      this.loaderCache.delete(key);
    }
    
    return cacheKeysToRemove.length > 0;
  }

  /**
   * é”€æ¯æ‰€æœ‰åŠ è½½å™¨
   */
  public async destroyAllLoaders(): Promise<void> {
    const loaders = Array.from(this.loaderCache.values());
    this.loaderCache.clear();
    
    // å¹¶è¡Œé”€æ¯æ‰€æœ‰åŠ è½½å™¨
    await Promise.allSettled(
      loaders.map(loader => {
        return loader.destroy().catch(error => {
          Logger.error(this.TAG, `Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}` instanceof Error ? `Error destroying loader: ${error}` : new Error(String(`Error destroying loader: ${error}`)))))));
        });
      })
    );
    
    Logger.info(this.TAG, `Destroyed all ${loaders.length} loaders`);
  }

  /**
   * æ¸…ç©ºç¼“å­˜
   */
  public clearCache(): void {
    this.loaderCache.clear();
    Logger.info(this.TAG, 'Loader cache cleared');
  }

  /**
   * è·å–ç¼“å­˜å¤§å°
   * @returns number ç¼“å­˜ä¸­çš„åŠ è½½å™¨æ•°é‡?
   */
  public getCacheSize(): number {
    return this.loaderCache.size;
  }

  /**
   * è®¾ç½®æœ€å¤§ç¼“å­˜å¤§å°?
   * @param size æœ€å¤§ç¼“å­˜å¤§å°?
   */
  public setMaxCacheSize(size: number): void {
    if (size > 0) {
      this.maxCacheSize = size;
      // å¦‚æœå½“å‰ç¼“å­˜è¶…è¿‡æ–°çš„æœ€å¤§å€¼ï¼Œæ¸…ç†å¤šä½™çš„åŠ è½½å™¨
      this.cleanupCache();
      Logger.info(this.TAG, `Max cache size set to: ${size}`);
    }
  }

  /**
   * å…³é—­å·¥å‚ï¼Œæ¸…ç†æ‰€æœ‰èµ„æº?
   */
  public async shutdown(): Promise<void> {
    await this.destroyAllLoaders();
    Logger.info(this.TAG, 'LoaderFactory shutdown completed');
  }

  /**
   * åˆ›å»ºæ–°çš„åŠ è½½å™¨å®ä¾?
   * @param site ç«™ç‚¹é…ç½®
   * @returns BaseLoader
   * @private
   */
  private createNewLoader(site: Site): BaseLoader {
    switch (site.type) {
      case LoaderType.JS:
        return new ArkJsLoader(site);
      case LoaderType.PY:
        return new ArkPyLoader(site);
      case LoaderType.JAR:
        return new ArkJarLoader(site);
      default:
        throw new Error(`Unsupported loader type: ${site.type}`);
    }
  }

  /**
   * è·å–ç¼“å­˜é”?
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns string ç¼“å­˜é”?
   * @private
   */
  private getCacheKey(site: Site): string {
    // ä½¿ç”¨ç«™ç‚¹keyå’Œé…ç½®çš„å“ˆå¸Œå€¼ä½œä¸ºç¼“å­˜é”®
    const configHash = this.generateConfigHash(site);
    return `${site.key}:${configHash}`;
  }

  /**
   * ç”Ÿæˆç«™ç‚¹çš„å“ˆå¸Œå€¼ï¼Œç”¨äºç¼“å­˜é”?
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns string å“ˆå¸Œå€?
   * @private
   */
  private generateConfigHash(site: Site): string {
    // ä½¿ç”¨ç«™ç‚¹çš„å…³é”®ä¿¡æ¯ç”Ÿæˆå“ˆå¸?
    const configStr = JSON.stringify({
      key: site.key,
      api: site.api,
      ext: site.ext,
      jar: site.jar,
      type: site.type
    });
    
    // ç®€å•çš„å­—ç¬¦ä¸²å“ˆå¸Œç®—æ³?
    let hash = 0;
    if (configStr.length === 0) return String(hash);
    
    for (let i = 0; i < configStr.length; i++) {
      const char = configStr.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // è½¬æ¢ä¸?2ä½æ•´æ•?
    }
    
    return String(hash);
  }

  /**
   * æ·»åŠ åˆ°ç¼“å­?
   * @param key ç¼“å­˜é”?
   * @param loader åŠ è½½å™¨å®ä¾?
   * @private
   */
  private addToCache(key: string, loader: BaseLoader): void {
    // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œæ¸…ç†ä¸€äº›æ—§çš„åŠ è½½å™¨
    if (this.loaderCache.size >= this.maxCacheSize) {
      this.cleanupCache();
    }
    
    this.loaderCache.set(key, loader);
    Logger.debug(this.TAG, `Added loader to cache: ${key}, current cache size: ${this.loaderCache.size}`);
  }

  /**
   * æ¸…ç†ç¼“å­˜ï¼Œç§»é™¤æœ€æ—§çš„æˆ–å·²é”€æ¯çš„åŠ è½½å™?
   * @private
   */
  private cleanupCache(): void {
    const loadersToKeep: [string, BaseLoader][] = [];
    const loadersToRemove: [string, BaseLoader][] = [];
    
    // åˆ†ç¦»å·²é”€æ¯çš„åŠ è½½å™?
    for (const [key, loader] of this.loaderCache.entries()) {
      if (loader.isDestroyed()) {
        loadersToRemove.push([key, loader]);
      } else {
        loadersToKeep.push([key, loader]);
      }
    }
    
    // å¦‚æœä»ç„¶éœ€è¦ç§»é™¤æ›´å¤šåŠ è½½å™¨ï¼ŒæŒ‰åˆå§‹åŒ–æ—¶é—´æ’åºå¹¶ç§»é™¤æœ€æ—§çš„
    if (loadersToKeep.length > this.maxCacheSize * 0.8) {
      // æŒ‰åˆå§‹åŒ–æ—¶é—´æ’åº
      loadersToKeep.sort((a, b) => {
        const statusA = a[1].getStatus();
        const statusB = b[1].getStatus();
        return (statusA.initializedTime || 0) - (statusB.initializedTime || 0);
      });
      
      // ç§»é™¤å¤šä½™çš„åŠ è½½å™¨
      const excess = loadersToKeep.length - Math.floor(this.maxCacheSize * 0.8);
      for (let i = 0; i < excess && i < loadersToKeep.length; i++) {
        loadersToRemove.push(loadersToKeep[i]);
      }
    }
    
    // ç§»é™¤é€‰ä¸­çš„åŠ è½½å™¨
    for (const [key, loader] of loadersToRemove) {
      this.loaderCache.delete(key);
      try {
        loader.destroy();
        Logger.debug(this.TAG, `Removed and destroyed loader from cache: ${key}`);
      } catch (error) {
        Logger.error(this.TAG, `Error destroying loader during cache cleanup: ${error}`);
      }
    }
    
    Logger.debug(this.TAG, `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` instanceof Error ? `Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}` : new Error(String(`Cache cleanup completed, removed ${loadersToRemove.length} loaders, current cache size: ${this.loaderCache.size}`)))))));
  }
}


