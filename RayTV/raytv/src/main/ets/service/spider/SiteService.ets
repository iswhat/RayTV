import Logger from '../../../common/util/Logger';
import { Site, SiteType } from '../../data/bean/Site';
import { SiteDao } from '../db/dao/SiteDao';
import JsonUtil from '../../../common/util/JsonUtil';

// ç«™ç‚¹æµ‹è¯•ç»“æœæ¥å£
export interface SiteTestResult {
  siteKey: string;
  status: 'success' | 'failed';
  responseTime: number;
  testTime: number;
  errorMessage?: string;
}

// ç«™ç‚¹å¯¼å…¥å¯¼å‡ºé…ç½®æ¥å£
export interface SiteImportExportConfig {
  includeCredentials?: boolean;
  includeStats?: boolean;
  includeCustomConfig?: boolean;
  description?: string;
}

const TAG = 'SiteService';

/**
 * ç«™ç‚¹æœåŠ¡æ¥å£
 */
export interface ISiteService {
  /**
   * åˆå§‹åŒ–ç«™ç‚¹æœï¿?
   */
  initialize(): Promise<void>;
  
  /**
   * è·å–æ‰€æœ‰ç«™ï¿?
   * @returns ç«™ç‚¹åˆ—è¡¨
   */
  getAllSites(): Promise<Site[]>;
  
  /**
   * è·å–å¯ç”¨çš„ç«™ï¿?
   * @returns å¯ç”¨çš„ç«™ç‚¹åˆ—ï¿?
   */
  getEnabledSites(): Promise<Site[]>;
  
  /**
   * æ ¹æ®ç±»å‹è·å–ç«™ç‚¹
   * @param type ç«™ç‚¹ç±»å‹
   * @returns ç«™ç‚¹åˆ—è¡¨
   */
  getSitesByType(type: SiteType): Promise<Site[]>;
  
  /**
   * æ ¹æ®keyè·å–ç«™ç‚¹
   * @param key ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @returns ç«™ç‚¹ä¿¡æ¯
   */
  getSiteByKey(key: string): Promise<Site | null>;
  
  /**
   * ä¿å­˜ç«™ç‚¹ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¿?
   * @param site ç«™ç‚¹ä¿¡æ¯
   */
  saveSite(site: Site): Promise<void>;
  
  /**
   * æ‰¹é‡ä¿å­˜ç«™ç‚¹
   * @param sites ç«™ç‚¹åˆ—è¡¨
   */
  batchSaveSites(sites: Site[]): Promise<void>;
  
  /**
   * åˆ é™¤ç«™ç‚¹
   * @param key ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   */
  deleteSite(key: string): Promise<void>;
  
  /**
   * æ›´æ–°ç«™ç‚¹å¯ç”¨çŠ¶ï¿½?
   * @param key ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @param enabled æ˜¯å¦å¯ç”¨
   */
  updateSiteEnabled(key: string, enabled: boolean): Promise<void>;
  
  /**
   * æ›´æ–°ç«™ç‚¹æ’åº
   * @param key ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @param order æ’åºæƒé‡
   */
  updateSiteOrder(key: string, order: number): Promise<void>;
  
  /**
   * æ›´æ–°ç«™ç‚¹æœ€åä½¿ç”¨æ—¶ï¿?
   * @param key ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   */
  updateSiteLastUsed(key: string): Promise<void>;
  
  /**
   * æµ‹è¯•ç«™ç‚¹è¿æ¥
   * @param key ç«™ç‚¹å”¯ä¸€æ ‡è¯†
   * @returns æµ‹è¯•ç»“æœ
   */
  testSiteConnection(key: string): Promise<SiteTestResult>;
  
  /**
   * å¯¼å‡ºç«™ç‚¹é…ç½®
   * @param config å¯¼å‡ºé…ç½®
   * @param siteKeys å¯é€‰çš„ç«™ç‚¹keyåˆ—è¡¨ï¼Œä¸æä¾›åˆ™å¯¼å‡ºæ‰€ï¿?
   * @returns å¯¼å‡ºçš„é…ç½®å­—ç¬¦ä¸²
   */
  exportSites(config?: SiteImportExportConfig, siteKeys?: string[]): Promise<string>;
  
  /**
   * å¯¼å…¥ç«™ç‚¹é…ç½®
   * @param data é…ç½®æ•°æ®
   * @param config å¯¼å…¥é…ç½®
   * @returns å¯¼å…¥ç»“æœç»Ÿè®¡
   */
  importSites(data: string, config?: SiteImportExportConfig): Promise<{success: number, skipped: number, failed: number}>;
  
  /**
   * æ¸…ç©ºæ‰€æœ‰ç«™ï¿?
   */
  clearAllSites(): Promise<void>;
}

/**
 * ç«™ç‚¹æœåŠ¡å®ç°ï¿?
 */
export class SiteService implements ISiteService {
  private static instance: SiteService | null = null;
  private siteDao: SiteDao;
  private initialized: boolean = false;
  
  /**
   * ç§æœ‰æ„é€ å‡½ï¿?
   */
  private constructor() {
    this.siteDao = new SiteDao();
  }
  
  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns ç«™ç‚¹æœåŠ¡å®ä¾‹
   */
  public static getInstance(): SiteService {
    if (!SiteService.instance) {
      SiteService.instance = new SiteService();
    }
    return SiteService.instance;
  }
  
  /**
   * åˆå§‹åŒ–ç«™ç‚¹æœï¿?
   */
  public async initialize(): Promise<void> {
    if (this.initialized) {
      return;
    }
    
    try {
      // é¢„åŠ è½½ç«™ç‚¹æ•°ï¿?
      const sites = await this.getAllSites();
      Logger.info(TAG, `Initialized with ${sites.length} sites`);
      this.initialized = true;
    } catch (error) {
      Logger.error(TAG, `Failed to initialize: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * è·å–æ‰€æœ‰ç«™ï¿?
   */
  public async getAllSites(): Promise<Site[]> {
    try {
      return await this.siteDao.getAll();
    } catch (error) {
      Logger.error(TAG, `Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error instanceof Error ? `Failed to get all sites: ${JSON.stringify(error : new Error(String(`Failed to get all sites: ${JSON.stringify(error)))))))}`);
      return [];
    }
  }
  
  /**
   * è·å–å¯ç”¨çš„ç«™ï¿?
   */
  public async getEnabledSites(): Promise<Site[]> {
    try {
      return await this.siteDao.getEnabled();
    } catch (error) {
      Logger.error(TAG, `Failed to get enabled sites: ${JSON.stringify(error)}`);
      return [];
    }
  }
  
  /**
   * æ ¹æ®ç±»å‹è·å–ç«™ç‚¹
   */
  public async getSitesByType(type: SiteType): Promise<Site[]> {
    try {
      return await this.siteDao.getByType(type);
    } catch (error) {
      Logger.error(TAG, `Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error instanceof Error ? `Failed to get sites by type ${type}: ${JSON.stringify(error : new Error(String(`Failed to get sites by type ${type}: ${JSON.stringify(error)))))))}`);
      return [];
    }
  }
  
  /**
   * æ ¹æ®keyè·å–ç«™ç‚¹
   */
  public async getSiteByKey(key: string): Promise<Site | null> {
    try {
      return await this.siteDao.getByKey(key);
    } catch (error) {
      Logger.error(TAG, `Failed to get site by key ${key}: ${JSON.stringify(error)}`);
      return null;
    }
  }
  
  /**
   * ä¿å­˜ç«™ç‚¹
   */
  public async saveSite(site: Site): Promise<void> {
    try {
      // ç¡®ä¿æ—¶é—´æˆ³æ­£ç¡®è®¾ï¿?
      const now = Date.now();
      if (!site.createdAt) {
        site.createdAt = now;
      }
      site.updatedAt = now;
      
      // ç¡®ä¿å¿…è¦çš„é…ç½®å­˜ï¿?
      if (!site.searchConfig) {
        site.searchConfig = { enabled: false };
      }
      if (!site.filterConfig) {
        site.filterConfig = { enabled: false };
      }
      if (!site.performanceConfig) {
        site.performanceConfig = {};
      }
      if (!site.stats) {
        site.stats = { queryCount: 0, errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle instanceof Error ? errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle : new Error(String(errorCount: 0, avgResponseTime: 0 };
      }
      if (!site.lifecycle))))))) {
        site.lifecycle = { initialized: false, loading: false, error: false };
      }
      
      await this.siteDao.save(site);
      Logger.info(TAG, `Saved site: ${site.name} (${site.key})`);
    } catch (error) {
      Logger.error(TAG, `Failed to save site ${site.name}: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * æ‰¹é‡ä¿å­˜ç«™ç‚¹
   */
  public async batchSaveSites(sites: Site[]): Promise<void> {
    try {
      await this.siteDao.batchSave(sites);
      Logger.info(TAG, `Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites` instanceof Error ? `Batch saved ${sites.length} sites` : new Error(String(`Batch saved ${sites.length} sites`)))))));
    } catch (error) {
      Logger.error(TAG, `Failed to batch save sites: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * åˆ é™¤ç«™ç‚¹
   */
  public async deleteSite(key: string): Promise<void> {
    try {
      await this.siteDao.delete(key);
      Logger.info(TAG, `Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` : new Error(String(`Deleted site: ${key}` instanceof Error ? `Deleted site: ${key}` : new Error(String(`Deleted site: ${key}`)))))));
    } catch (error) {
      Logger.error(TAG, `Failed to delete site ${key}: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°ç«™ç‚¹å¯ç”¨çŠ¶ï¿½?
   */
  public async updateSiteEnabled(key: string, enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean))))))): Promise<void> {
    try {
      const site = await this.getSiteByKey(key);
      if (site) {
        site.enabled = enabled;
        site.updatedAt = Date.now();
        await this.siteDao.save(site);
        Logger.info(TAG, `Updated site ${key} enabled: ${enabled}`);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to update site enabled: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°ç«™ç‚¹æ’åº
   */
  public async updateSiteOrder(key: string, order: number instanceof Error ? order: number : new Error(String(order: number instanceof Error ? order: number instanceof Error ? order: number : new Error(String(order: number : new Error(String(order: number instanceof Error ? order: number : new Error(String(order: number instanceof Error ? order: number instanceof Error ? order: number : new Error(String(order: number instanceof Error ? order: number instanceof Error ? order: number : new Error(String(order: number : new Error(String(order: number instanceof Error ? order: number : new Error(String(order: number : new Error(String(order: number instanceof Error ? order: number : new Error(String(order: number instanceof Error ? order: number instanceof Error ? order: number : new Error(String(order: number : new Error(String(order: number instanceof Error ? order: number : new Error(String(order: number))))))): Promise<void> {
    try {
      const site = await this.getSiteByKey(key);
      if (site) {
        site.order = order;
        site.updatedAt = Date.now();
        await this.siteDao.save(site);
        Logger.info(TAG, `Updated site ${key} order: ${order}`);
      }
    } catch (error) {
      Logger.error(TAG, `Failed to update site order: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°ç«™ç‚¹æœ€åä½¿ç”¨æ—¶ï¿?
   */
  public async updateSiteLastUsed(key: string): Promise<void> {
    try {
      await this.siteDao.updateLastUsed(key);
      Logger.info(TAG, `Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}` instanceof Error ? `Updated site last used: ${key}` : new Error(String(`Updated site last used: ${key}`)))))));
    } catch (error) {
      Logger.error(TAG, `Failed to update site last used: ${JSON.stringify(error)}`);
    }
  }
  
  /**
   * æµ‹è¯•ç«™ç‚¹è¿æ¥
   */
  public async testSiteConnection(key: string): Promise<SiteTestResult> {
    const startTime = Date.now();
    const result: SiteTestResult = {
      siteKey: key, status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key instanceof Error ? status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key : new Error(String(status: 'failed',
      responseTime: 0,
      testTime: startTime
    };
    
    try {
      const site = await this.getSiteByKey(key)))))));
      if (!site) {
        result.errorMessage = 'Site not found';
        return result;
      }
      
      // è¿™é‡Œå®ç°ç«™ç‚¹è¿æ¥æµ‹è¯•é€»è¾‘
      // å®é™…å®ç°å¯èƒ½éœ€è¦æ ¹æ®ç«™ç‚¹ç±»å‹å’ŒåŠ è½½å™¨ç±»å‹è¿›è¡Œä¸åŒçš„æµ‹è¯•
      result.responseTime = Date.now() - startTime;
      result.status = 'success';
      
      // æ›´æ–°ç«™ç‚¹ç»Ÿè®¡ä¿¡æ¯
      site.stats.queryCount++;
      site.stats.lastQueryTime = Date.now();
      
      // æ›´æ–°å¹³å‡å“åº”æ—¶é—´
      const totalResponseTime = site.stats.avgResponseTime * (site.stats.queryCount - 1) + result.responseTime;
      site.stats.avgResponseTime = Math.round(totalResponseTime / site.stats.queryCount);
      
      await this.saveSite(site);
      
    } catch (error) {
      result.status = 'failed';
      result.errorMessage = error instanceof Error ? error.message : 'Unknown error';
      result.responseTime = Date.now() - startTime;
      
      // æ›´æ–°ç«™ç‚¹é”™è¯¯ç»Ÿè®¡
      try {
        const site = await this.getSiteByKey(key);
        if (site) {
          site.stats.errorCount++;
          site.stats.lastErrorTime = Date.now();
          site.stats.lastErrorMessage = result.errorMessage;
          await this.saveSite(site);
        }
      } catch (updateError) {
        Logger.error(TAG, `Failed to update error stats: ${JSON.stringify(updateError)}`);
      }
    }
    
    return result;
  }
  
  /**
   * å¯¼å‡ºç«™ç‚¹é…ç½®
   */
  public async exportSites(config?: SiteImportExportConfig, siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[] : new Error(String(siteKeys?: string[] instanceof Error ? siteKeys?: string[] : new Error(String(siteKeys?: string[]))))))): Promise<string> {
    try {
      let sites: Site[];
      
      if (siteKeys && siteKeys.length > 0) {
        sites = [];
        for (const key of siteKeys) {
          const site = await this.getSiteByKey(key);
          if (site) {
            sites.push(site);
          }
        }
      } else {
        sites = await this.getAllSites();
      }
      
      // æ ¹æ®é…ç½®å¤„ç†å¯¼å‡ºæ•°æ®
      const exportData = sites.map(site => {
        const exportSite: Record<string, string | number | boolean | null> = { ... };
        
        // ä¸å¯¼å‡ºæ•æ„Ÿä¿¡ï¿?
        if (!config?.includeCredentials) {
          exportSite.siteAuth = undefined;
          exportSite.headers = undefined;
        }
        
        // æ˜¯å¦å¯¼å‡ºç»Ÿè®¡ä¿¡æ¯
        if (!config?.includeStats) {
          exportSite.stats = { queryCount: 0, errorCount: 0, avgResponseTime: 0 };
        }
        
        // æ˜¯å¦å¯¼å‡ºè‡ªå®šä¹‰é…ï¿?
        if (!config?.includeCustomConfig) {
          exportSite.customCode = undefined;
        }
        
        return exportSite;
      });
      
      const exportConfig: Record<string, string | number | boolean | null> = { ... };
      
      return JsonUtil.stringify(exportConfig, null, 2);
    } catch (error) {
      Logger.error(TAG, `Failed to export sites: ${JSON.stringify(error)}`);
      throw error;
    }
  }
  
  /**
   * å¯¼å…¥ç«™ç‚¹é…ç½®
   */
  public async importSites(data: string, config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig instanceof Error ? config?: SiteImportExportConfig : new Error(String(config?: SiteImportExportConfig))))))): Promise<{success: number, skipped: number, failed: number}> {
    const stats: Record<string, string | number | boolean | null> = { ... };
    
    try {
      const importData = JsonUtil.parse(data);
      const sites = importData.sites || [];
      
      for (const site of sites) {
        try {
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          const existing = await this.getSiteByKey(site.key);
          
          if (existing) {
            // æ ¹æ®å¯¼å…¥é…ç½®å†³å®šæ˜¯è·³è¿‡è¿˜æ˜¯è¦†ï¿?
            stats.skipped++;
            Logger.info(TAG, `Skipped existing site: ${site.key}`);
            continue;
          }
          
          // è®¾ç½®å¯¼å…¥æ—¶çš„å¿…è¦ä¿¡æ¯
          site.createdAt = Date.now();
          site.updatedAt = Date.now();
          
          await this.saveSite(site);
          stats.success++;
          Logger.info(TAG, `Successfully imported site: ${site.key}`);
          
        } catch (siteError) {
          stats.failed++;
          Logger.error(TAG, `Failed to import site ${site.key}: ${JSON.stringify(siteError)}`);
        }
      }
      
    } catch (error) {
      Logger.error(TAG, `Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error instanceof Error ? `Failed to parse import data: ${JSON.stringify(error : new Error(String(`Failed to parse import data: ${JSON.stringify(error)))))))}`);
      throw error;
    }
    
    return stats;
  }
  
  /**
   * æ¸…ç©ºæ‰€æœ‰ç«™ï¿?
   */
  public async clearAllSites(): Promise<void> {
    try {
      // ç”±äºSiteDaoæ²¡æœ‰æä¾›clearAllæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè·å–æ‰€æœ‰ç«™ç‚¹ç„¶åé€ä¸ªåˆ é™¤
      const sites = await this.getAllSites();
      for (const site of sites) {
        await this.deleteSite(site.key);
      }
      Logger.info(TAG, `Cleared all ${sites.length} sites`);
    } catch (error) {
      Logger.error(TAG, `Failed to clear all sites: ${JSON.stringify(error)}`);
      throw error;
    }
  }
}


