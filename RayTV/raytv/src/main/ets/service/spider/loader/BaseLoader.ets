import Logger from '../../../common/util/Logger';
import { Site } from '../../../data/bean/Site';

/**
 * çˆ¬è™«åŠ è½½å™¨ç±»å‹æšä¸? */
export enum LoaderType {
  JAR = 'jar',
  JS = 'js',
  PY = 'py'
}

/**
 * çˆ¬è™«ç»“æœé€šç”¨æ¥å£
 */
export interface CrawlerResult<T> {
  code: number;
  message: string;
  data: T;
}

/**
 * é¦–é¡µç»“æœæ¥å£
 */
export interface HomeResult {
  banners?: Array<{
    id: string;
    imageUrl: string;
    link: string;
    title: string;
  }>;
  categories?: Array<{
    id: string;
    name: string;
    icon?: string;
  }>;
  lists?: Array<{
    title: string;
    moreUrl?: string;
    items: Array<{
      id: string;
      name: string;
      cover: string;
      url: string;
      type?: string;
      score?: string;
      updateInfo?: string;
    }>;
  }>;
}

/**
 * åˆ†ç±»ç»“æœæ¥å£
 */
export interface CategoryResult {
  page: number;
  pageSize: number;
  total: number;
  list: Array<{
    id: string;
    name: string;
    cover: string;
    url: string;
    type?: string;
    score?: string;
    updateInfo?: string;
  }>;
}

/**
 * è¯¦æƒ…ç»“æœæ¥å£
 */
export interface DetailResult {
  id: string;
  name: string;
  cover: string;
  type?: string;
  score?: string;
  updateInfo?: string;
  description?: string;
  director?: string;
  actors?: string;
  releaseYear?: string;
  region?: string;
  language?: string;
  status?: string;
  playCount?: string;
  categories?: string[];
  episodes: Array<{
    title?: string;
    list: Array<{
      id: string;
      name: string;
      url: string;
    }>;
  }>;
  related?: Array<{
    id: string;
    name: string;
    cover: string;
    url: string;
  }>;
}

/**
 * æœç´¢ç»“æœæ¥å£
 */
export interface SearchResult {
  page: number;
  pageSize: number;
  total: number;
  list: Array<{
    id: string;
    name: string;
    cover: string;
    url: string;
    type?: string;
    score?: string;
    updateInfo?: string;
    description?: string;
  }>;
}

/**
 * æ’­æ”¾ç»“æœæ¥å£
 */
export interface PlayResult {
  playUrl: string;
  headers?: Record<string, string>;
  cookies?: string;
  format?: string;
  quality?: string;
  subtitles?: Array<{
    name: string;
    url: string;
    type?: string;
  }>;
  sources?: Array<{
    name: string;
    url: string;
    format?: string;
    quality?: string;
  }>;
}

/**
 * ç›´æ’­ç»“æœæ¥å£
 */
export interface LiveResult {
  category: string;
  channels: Array<{
    id: string;
    name: string;
    logo: string;
    url: string;
    description?: string;
    tags?: string[];
  }>;
}

/**
 * çˆ¬è™«åŠ è½½å™¨åŸºç±? * å®šä¹‰çˆ¬è™«åŠ è½½å™¨çš„æ ¸å¿ƒæ¥å£å’ŒæŠ½è±¡æ–¹æ³? */
export abstract class BaseLoader {
  protected readonly TAG: string = `BaseLoader-${this.constructor.name}`;
  protected site: Site;
  protected isInitialized: boolean = false;
  protected isDestroyed: boolean = false;
  protected errorCount: number = 0;
  protected maxErrorCount: number = 5;
  protected initializedTime: number = 0;
  protected lastInvokeTime: number = 0;

  /**
   * æ„é€ å‡½æ•?   * @param site ç«™ç‚¹ä¿¡æ¯
   */
  constructor(site: Site) {
    this.site = site;
    Logger.info(this.TAG, `Creating loader for site: ${site.name} (${site.key})`);
  }

  /**
   * åˆå§‹åŒ–åŠ è½½å™¨
   * @returns Promise<boolean> åˆå§‹åŒ–æ˜¯å¦æˆåŠ?   */
  public async init(): Promise<boolean> {
    if (this.isDestroyed) {
      Logger.error(this.TAG, 'Cannot initialize destroyed loader');
      return false;
    }
    
    if (!this.isInitialized) {
      try {
        Logger.info(this.TAG, `Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}` instanceof Error ? `Initializing loader for site: ${this.site.name}` : new Error(String(`Initializing loader for site: ${this.site.name}`)))))));
        await this.onInit();
        this.isInitialized = true;
        this.initializedTime = Date.now();
        this.errorCount = 0;
        Logger.info(this.TAG, `Loader initialized successfully for site: ${this.site.name}`);
        return true;
      } catch (error) {
        Logger.error(this.TAG, `Failed to initialize loader: ${error}`);
        this.handleError();
        return false;
      }
    }
    return true;
  }

  /**
   * é”€æ¯åŠ è½½å™¨ï¼Œé‡Šæ”¾èµ„æº?   */
  public async destroy(): Promise<void> {
    if (!this.isDestroyed) {
      try {
        Logger.info(this.TAG, `Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}` instanceof Error ? `Destroying loader for site: ${this.site.name}` : new Error(String(`Destroying loader for site: ${this.site.name}`)))))));
        await this.onDestroy();
        this.isDestroyed = true;
        this.isInitialized = false;
        Logger.info(this.TAG, `Loader destroyed successfully for site: ${this.site.name}`);
      } catch (error) {
        Logger.error(this.TAG, `Failed to destroy loader: ${error}`);
      }
    }
  }

  /**
   * è°ƒç”¨çˆ¬è™«æ–¹æ³•
   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @returns Promise<CrawlerResult<T>> æ–¹æ³•æ‰§è¡Œç»“æœ
   */
  public async invoke<T>(method: string, params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {} instanceof Error ? params: Record<string, string | number | boolean | null> = {} : new Error(String(params: Record<string, string | number | boolean | null> = {}))))))): Promise<CrawlerResult<T>> {
    try {
      // æ£€æŸ¥çŠ¶æ€?      if (this.isDestroyed) {
        return this.createErrorResult('Cannot invoke method on destroyed loader');
      }
      
      // è‡ªåŠ¨åˆå§‹åŒ?      if (!this.isInitialized) {
        const initialized = await this.init();
        if (!initialized) {
          return this.createErrorResult('Loader initialization failed');
        }
      }
      
      // éªŒè¯æ–¹æ³•
      if (!this.validateMethod(method)) {
        return this.createErrorResult(`Method ${method} not supported`);
      }
      
      this.lastInvokeTime = Date.now();
      Logger.debug(this.TAG, `Invoking method: ${method} with params: ${JSON.stringify(params)}`);
      
      const result = await this.onInvoke<T>(method, params);
      this.errorCount = 0; // é‡ç½®é”™è¯¯è®¡æ•°
      
      Logger.debug(this.TAG, `Method ${method} executed successfully for site: ${this.site.name}`);
      return this.createSuccessResult(result);
    } catch (error) {
      Logger.error(this.TAG, `Failed to invoke method ${method}: ${error}`);
      this.handleError();
      return this.createErrorResult(error instanceof Error ? error.message : String(error));
    }
  }

  /**
   * è·å–ç«™ç‚¹ä¿¡æ¯
   * @returns Site ç«™ç‚¹ä¿¡æ¯
   */
  public getSite(): Site {
    return { ...this.site };
  }

  /**
   * æ›´æ–°ç«™ç‚¹é…ç½®
   * @param config æ–°çš„é…ç½®
   */
  public updateConfig(config: Partial<Site>): void {
    this.site = { ...this.site, ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` instanceof Error ? ...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}` : new Error(String(...config };
    Logger.info(this.TAG, `Site config updated for ${this.site.name}`)))))));
  }

  /**
   * è·å–åŠ è½½å™¨ç±»å?   * @returns LoaderType åŠ è½½å™¨ç±»å?   */
  public getLoaderType(): LoaderType {
    return this.site.type as LoaderType;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ?   * @returns boolean æ˜¯å¦å·²åˆå§‹åŒ–
   */
  public isInitialized(): boolean {
    return this.isInitialized;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å·²é”€æ¯?   * @returns boolean æ˜¯å¦å·²é”€æ¯?   */
  public isDestroyed(): boolean {
    return this.isDestroyed;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ç”?   * @returns boolean æ˜¯å¦å¯ç”¨
   */
  public isAvailable(): boolean {
    return !this.isDestroyed && this.errorCount < this.maxErrorCount;
  }

  /**
   * è·å–åŠ è½½å™¨çŠ¶æ€?   */
  public getStatus(): {
    initialized: boolean;
    destroyed: boolean;
    errorCount: number;
    maxErrorCount: number;
    initializedTime: number;
    lastInvokeTime: number;
    site: Site;
  } {
    return {
      initialized: this.isInitialized,
      destroyed: this.isDestroyed,
      errorCount: this.errorCount,
      maxErrorCount: this.maxErrorCount,
      initializedTime: this.initializedTime,
      lastInvokeTime: this.lastInvokeTime,
      site: this.site
    };
  }

  /**
   * é‡ç½®é”™è¯¯è®¡æ•°
   */
  public resetErrorCount(): void {
    this.errorCount = 0;
  }

  /**
   * éªŒè¯æ–¹æ³•åç§°
   * @param method æ–¹æ³•åç§°
   * @returns boolean æ–¹æ³•æ˜¯å¦æœ‰æ•ˆ
   */
  protected validateMethod(method: string): boolean {
    const validMethods = ['home', 'category', 'detail', 'search', 'play', 'live'];
    return validMethods.includes(method);
  }

  /**
   * å¤„ç†é”™è¯¯
   */
  protected handleError(): void {
    this.errorCount++;
    Logger.warn(this.TAG, `Site ${this.site.key} error count: ${this.errorCount}/${this.maxErrorCount}`);
    
    if (this.errorCount >= this.maxErrorCount) {
      Logger.error(this.TAG, `Site ${this.site.key} reached max error count, disabling...` instanceof Error ? disabling...` : new Error(String(disabling...` instanceof Error ? disabling...` instanceof Error ? disabling...` : new Error(String(disabling...` : new Error(String(disabling...` instanceof Error ? disabling...` : new Error(String(disabling...` instanceof Error ? disabling...` instanceof Error ? disabling...` : new Error(String(disabling...` instanceof Error ? disabling...` instanceof Error ? disabling...` : new Error(String(disabling...` : new Error(String(disabling...` instanceof Error ? disabling...` : new Error(String(disabling...` : new Error(String(disabling...`  as Error)));
    }
  }

  /**
   * åˆ›å»ºæˆåŠŸç»“æœ
   */
  protected createSuccessResult<T>(data: T): CrawlerResult<T> {
    return {
      code: 200,
      message: 'success',
      data
    };
  }

  /**
   * åˆ›å»ºé”™è¯¯ç»“æœ
   */
  protected createErrorResult<T>(message: string, data?: T): CrawlerResult<T> {
    return {
      code: 500,
      message,
      data: data as T
    };
  }

  /**
   * æ‰§è¡Œé¦–é¡µæ–¹æ³•
   */
  public async home(): Promise<CrawlerResult<HomeResult>> {
    return this.invoke<HomeResult>('home');
  }

  /**
   * æ‰§è¡Œåˆ†ç±»æ–¹æ³•
   */
  public async category(params: {
    url: string;
    page?: number;
    pageSize?: number;
    filters?: Record<string, string | number | boolean>;
  }): Promise<CrawlerResult<CategoryResult>> {
    return this.invoke<CategoryResult>('category', params);
  }

  /**
   * æ‰§è¡Œè¯¦æƒ…æ–¹æ³•
   */
  public async detail(params: {
    url: string;
  }): Promise<CrawlerResult<DetailResult>> {
    return this.invoke<DetailResult>('detail', params);
  }

  /**
   * æ‰§è¡Œæœç´¢æ–¹æ³•
   */
  public async search(params: {
    keyword: string;
    page?: number;
    pageSize?: number;
  }): Promise<CrawlerResult<SearchResult>> {
    return this.invoke<SearchResult>('search', params);
  }

  /**
   * æ‰§è¡Œæ’­æ”¾æ–¹æ³•
   */
  public async play(params: {
    url: string;
    source?: string;
    episode?: string;
  }): Promise<CrawlerResult<PlayResult>> {
    return this.invoke<PlayResult>('play', params);
  }

  /**
   * æ‰§è¡Œç›´æ’­æ–¹æ³•
   */
  public async live(params?: {
    category?: string;
  }): Promise<CrawlerResult<LiveResult>> {
    return this.invoke<LiveResult>('live', params || {});
  }

  /**
   * åˆå§‹åŒ–æ–¹æ³•ï¼ˆç”±å­ç±»å®ç°ï¼‰
   * @protected
   */
  protected abstract onInit(): Promise<void>;

  /**
   * æ–¹æ³•è°ƒç”¨ï¼ˆç”±å­ç±»å®ç°ï¼?   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @protected
   */
  protected abstract onInvoke<T>(method: string, params: Record<string, string | number | boolean | object | null>): Promise<T>;

  /**
   * é”€æ¯æ–¹æ³•ï¼ˆç”±å­ç±»å®ç°ï¼‰
   * @protected
   */
  protected abstract onDestroy(): Promise<void>;
}


