import Logger from '../../../common/util/Logger';
import { BaseLoader, LoaderType, Site } from './BaseLoader';
import { TaskPoolManager } from '../../../task/pool/TaskPoolManager';
import HttpService from '../../http/HttpService';
import MemoryManager from '../../../common/util/MemoryManager';
import TimeoutManager from '../../../common/util/TimeoutManager';

/**
 * Pythonæ‰§è¡Œä¸Šä¸‹æ–? */
interface PyContext {
  contextData?: Record<string, unknown>;
}

/**
 * Ark PythonåŠ è½½å™? * å®ç°åŸºäºHarmonyOSçš„Pythonä»£ç åŠ è½½å’Œæ‰§è¡Œå™¨
 */
export class ArkPyLoader extends BaseLoader {
  private readonly TAG: string = 'ArkPyLoader';
  private pyContext: PyContext = {};
  private scriptContent: string = '';
  private taskPoolManager: TaskPoolManager;
  private httpService: HttpService;
  private memoryManager: MemoryManager;
  private timeoutManager: TimeoutManager;
  private lastUsedTime: number = 0;
  private isInitialized: boolean = false;
  private pyModuleName: string = '';

  /**
   * æ„é€ å‡½æ•?   * @param site ç«™ç‚¹é…ç½®
   */
  constructor(site: Site) {
    super(site);
    this.taskPoolManager = TaskPoolManager.getInstance();
    this.httpService = HttpService.getInstance();
    this.memoryManager = MemoryManager.getInstance();
    this.timeoutManager = TimeoutManager.getInstance();
    this.pyModuleName = `site_${site.key || 'default'}`;
  }

  /**
   * åˆå§‹åŒ–åŠ è½½å™¨
   * @protected
   */
  protected async onInit(): Promise<void> {
    try {
      // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†?      if (!this.memoryManager.checkMemoryAvailability()) {
        throw new Error('Insufficient memory to initialize Python loader');
      }

      Logger.info(this.TAG, `Initializing Python loader for site: ${this.site.name}`);
      
      // åŠ è½½Pythonä»£ç 
      await this.loadScript();
      
      // åˆ›å»ºPythonæ‰§è¡Œç¯å¢ƒ
      this.createPyEnvironment();
      
      // æ³¨å…¥åŸºç¡€API
      this.injectApis();
      
      // æ‰§è¡Œåˆå§‹åŒ–è„šæœ?      await this.executeInitScript();
      
      this.isInitialized = true;
      this.lastUsedTime = Date.now();
      Logger.info(this.TAG, `Python loader initialized successfully for site: ${this.site.name}`);
    } catch (error) {
      this.isInitialized = false;
      this.cleanupResources();
      Logger.error(this.TAG, `Failed to initialize Python loader: ${error}`);
      throw error;
    }
  }

  /**
   * æ–¹æ³•è°ƒç”¨
   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @protected
   */
  protected async onInvoke(method: string, params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null>))))))): Promise<unknown> {
    if (!this.isInitialized) {
      await this.onInit();
    }

    this.lastUsedTime = Date.now();

    try {
      // å®‰å…¨æ£€æŸ?      this.validateParams(params);
      
      Logger.info(this.TAG, `Invoking Python method: ${method} for site: ${this.site.name}`);

      // è®¾ç½®æ‰§è¡Œè¶…æ—¶
      const timeoutId = this.timeoutManager.setTimeout(() => {
        throw new Error(`Method ${method} execution timed out`);
      }, 60000); // Pythonæ‰§è¡Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾ç½®60ç§’è¶…æ—?
      try {
        // åœ¨åå°çº¿ç¨‹æ‰§è¡ŒPythonæ–¹æ³•
        const result = await this.taskPoolManager.execute(() => {
          return this.executeMethod(method, params);
        });

        return result;
      } finally {
        this.timeoutManager.clearTimeout(timeoutId);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to invoke Python method ${method}: ${error}`);
      // é”™è¯¯è®¡æ•°å¢åŠ 
      this.errorCount++;

      // å¦‚æœé”™è¯¯è¿‡å¤šï¼Œæ¸…ç†èµ„æº?      if (this.errorCount >= this.maxErrorCount) {
        Logger.warn(this.TAG, `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources`)))))));
        this.cleanupResources();
      }

      throw error;
    }
  }

  /**
   * é”€æ¯æ–¹æ³?   * @protected
   */
  protected onDestroy(): void {
    this.cleanupResources();
    Logger.info(this.TAG, `Python loader destroyed for site: ${this.site.name}`);
  }
  
  /**
   * æ¸…ç†èµ„æº
   * @private
   */
  private cleanupResources(): void {
    // æ¸…ç†Pythonä¸Šä¸‹æ–?    if (this.pyContext) {
      // ç›´æ¥åˆ›å»ºæ–°å¯¹è±¡æ›¿ä»£deleteæ“ä½œ
      this.pyContext = {};
    }

    this.scriptContent = '';
    this.isInitialized = false;

    // é‡Šæ”¾å†…å­˜
    this.memoryManager.forceGC();

    Logger.info(this.TAG, 'Resources cleaned up');
  }
  
  /**
   * è·å–æœ€åä½¿ç”¨æ—¶é—?   */
  public getLastUsedTime(): number {
    return this.lastUsedTime;
  }
  
  /**
   * æ˜¯å¦å·²åˆå§‹åŒ–
   */
  public getIsInitialized(): boolean {
    return this.isInitialized;
  }

  /**
   * åŠ è½½Pythonä»£ç 
   * @private
   */
  private async loadScript(): Promise<void> {
    const config = this.site;

    if (config.url && (config.url.startsWith('http://') || config.url.startsWith('https://'))) {
      // ä»URLåŠ è½½
      Logger.info(this.TAG, `Loading Python script from URL: ${config.url}`);
      try {
        const response = await this.httpService.get(config.url, { timeout: 15000 });
        this.scriptContent = response.data as string;
      } catch (error) {
        Logger.error(this.TAG, `Failed to load Python script from URL: ${error}`);
        // å¦‚æœURLåŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ä»£ç ?        if (config.content) {
          Logger.warn(this.TAG, 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content')))))));
          this.scriptContent = config.content as string;
        } else {
          throw new Error(`Failed to load Python script: ${error}`);
        }
      }
    } else if (config.content) {
      // ç›´æ¥ä½¿ç”¨é…ç½®ä¸­çš„ä»£ç 
      Logger.info(this.TAG, 'Using Python script content from config');
      this.scriptContent = config.content as string;
    } else {
      throw new Error('No Python script source provided (url or content)');
    }

    // å®‰å…¨è¿‡æ»¤
    this.filterDangerousCode();
  }

  /**
   * åˆ›å»ºPythonæ²™ç®±ç¯å¢ƒ
   * @private
   */
  private createPyEnvironment(): void {
    // åˆ›å»ºPythonæ¨¡å—ç¯å¢ƒ
    this.pyContext = {
      // åŸºæœ¬çš„Pythonå†…ç½®å‡½æ•°æ˜ å°„
      print: (...args: Record<string, string | number | boolean | null>[]) => {
        Logger.info(`${this.TAG}[${this.site.name}]`, args.map(String).join(' '));
      },
      len: (obj: Record<string, string | number | boolean | null>) => {
        return Array.isArray(obj) ? obj.length : this.getObjectKeys(obj || {}).length;
      },
      str: (obj: Record<string, string | number | boolean | null>) => String(obj),
      int: (obj: Record<string, string | number | boolean | null>) => parseInt(obj as string, 10),
      float: (obj: Record<string, string | number | boolean | null>) => parseFloat(obj as string),
      bool: (obj: Record<string, string | number | boolean | null>) => Boolean(obj),
      list: (obj: Record<string, string | number | boolean | null>) => Array.isArray(obj) ? [...obj] : [obj],
      dict: (obj: Record<string, string | number | boolean | null>) => (typeof obj === 'object' && obj !== null) ? { ...(obj as object) } : {},
      range: (start: number, stop?: number, step: number = 1) => {
        const result = [];
        if (stop === undefined) {
          stop = start;
          start = 0;
        }
        for (let i = start; i < stop; i += step) {
          result.push(i);
        }
        return result;
      }
    };

    Logger.info(this.TAG, 'Created Python execution environment');
  }

  /**
   * æ³¨å…¥Python API
   * @private
   */
  private injectApis(): void {
    // æ³¨å…¥HTTPè¯·æ±‚API
    this.pyContext.http = {
      get: async (url: string, options?: { headers?: Record<string, string>, timeout?: number }) => {
        // éªŒè¯URLå®‰å…¨æ€?        this.validateUrl(url);
        return this.httpService.get(url, options || {});
      },
      post: async (url: string, data?: Record<string, string | number | boolean | null>, options?: { headers?: Record<string, string>, timeout?: number }) => {
        // éªŒè¯URLå®‰å…¨æ€?        this.validateUrl(url);
        return this.httpService.post(url, data, options || {});
      }
    };

    // æ³¨å…¥åŠ å¯†API
    this.pyContext.crypto = {
      md5: (str: string) => {
        try {
          // åœ¨HarmonyOSä¸­ï¼Œä½¿ç”¨å…¼å®¹çš„MD5å®ç°
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸?2ä½æ•´æ•?          }
          return Math.abs(hash).toString(16);
        } catch (error) {
          // é™çº§å¤„ç†
          return `md5_${str}`;
        }
      },
      base64: {
        encode: (str: string) => {
          try {
            return btoa(unescape(encodeURIComponent(str)));
          } catch (error) {
            Logger.error(this.TAG, `Base64 encode error: ${error}`);
            return '';
          }
        }, decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string))))))) => {
          try {
            return decodeURIComponent(escape(atob(str)));
          } catch (error) {
            Logger.error(this.TAG, `Base64 decode error: ${error}`);
            return '';
          }
        }
      }
    };

    // æ³¨å…¥å­—ç¬¦ä¸²å¤„ç†å·¥å…·ï¼ˆæ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼ï¼‰
    this.pyContext.stringUtil = {
      // ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ–¹æ³•æ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼
      contains: (text: string, substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string))))))): boolean => {
        return text.indexOf(substring) !== -1;
      },
      startsWith: (text: string, prefix: string): boolean => {
        return text.indexOf(prefix) === 0;
      },
      endsWith: (text: string, suffix: string): boolean => {
        return text.lastIndexOf(suffix) === text.length - suffix.length;
      },
      split: (text: string, separator: string): string[] => {
        return text.split(separator);
      },
      replace: (text: string, search: string, replacement: string): string => {
        return text.replace(search, replacement);
      }
    };

    // æ³¨å…¥æ—¥å¿—API
    this.pyContext.logger = {
      info: (message: string) => {
        Logger.info(`${this.TAG}[${this.site.name}]`, message);
      },
      warning: (message: string) => {
        Logger.warn(`${this.TAG}[${this.site.name}]`, message);
      },
      error: (message: string) => {
        Logger.error(`${this.TAG}[${this.site.name}]`, message);
      }
    };

    // æ³¨å…¥å·¥å…·å‡½æ•°
    this.pyContext.util = {
      json: {
        loads: (text: string) => {
          try {
            return JSON.parse(text);
          } catch (error) {
            Logger.error(this.TAG, `JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}` instanceof Error ? `JSON loads error: ${error}` : new Error(String(`JSON loads error: ${error}`)))))));
            return null;
          }
        },
        dumps: (obj: Record<string, string | number | boolean | null>, indent?: number) => {
          try {
            return JSON.stringify(obj, null, indent);
          } catch (error) {
            Logger.error(this.TAG, `JSON dumps error: ${error}`);
            return '{}';
          }
        }
      }, sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number : new Error(String(sleep: (seconds: number instanceof Error ? sleep: (seconds: number : new Error(String(sleep: (seconds: number))))))) => {
        return new Promise(resolve => setTimeout(resolve, Math.min(seconds * 1000, 10000))); // é™åˆ¶æœ€å¤§å»¶æ—?0ç§?      }
    };

    Logger.info(this.TAG, 'Injected enhanced APIs into Python context');
  }
  
  /**
   * éªŒè¯URLå®‰å…¨æ€?   * @private
   */
  private validateUrl(url: string): void {
    // æ£€æŸ¥URLæ˜¯å¦ä¸ºç›¸å¯¹è·¯å¾„æˆ–ç™½åå•å†…çš„åŸŸå?    const allowedDomains = this.site.allowedDomains || [];

    try {
      const urlObj = new URL(url);
      const hostname = urlObj.hostname;

      // æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•å†…
      const isAllowed = allowedDomains.some(domain => {
        return hostname === domain || hostname.endsWith(`.${domain}`);
      });

      if (!isAllowed) {
        throw new Error(`URL domain not allowed: ${hostname}`);
      }
    } catch (error) {
      if (error instanceof TypeError) {
        // å¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¿½ç•¥URLè§£æé”™è¯¯
      } else {
        throw error;
      }
    }
  }

  /**
   * æ‰§è¡Œåˆå§‹åŒ–ä»£ç ?   * @private
   */
  private async executeInitScript(): Promise<void> {
    try {
      // åœ¨Pythonç¯å¢ƒä¸­æ‰§è¡Œè„šæœ?      // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨JavaScriptæ¨¡æ‹ŸPythonæ‰§è¡Œç¯å¢ƒ
      // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦ä½¿ç”¨Pythonè§£é‡Šå™¨æˆ–æ¡¥æ¥æ–¹æ¡ˆ
      
      // é¢„å¤„ç†Pythonä»£ç ï¼Œè½¬æ¢ä¸ºJavaScriptå…¼å®¹æ ¼å¼
      const processedScript = this.preprocessPythonCode(this.scriptContent);
      
      // åˆ›å»ºå®‰å…¨çš„æ‰§è¡Œä¸Šä¸‹æ–‡
      const execContext: Record<string, string | number | boolean | null> = { ... };
      
      // æ¨¡æ‹ŸPythonæ¨¡å—ç³»ç»Ÿ
      execContext.__name__ = this.pyModuleName;
      execContext.__file__ = `${this.pyModuleName}.py`;
      
      // æ‰§è¡Œè„šæœ¬
      // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®å¯èƒ½éœ€è¦æ›´å¤æ‚çš„Pythonä»£ç è½¬è¯‘æˆ–è§£é‡?      Logger.info(this.TAG, 'Executing Python initialization script');
      
      // æå–Pythonå‡½æ•°
      this.extractPythonFunctions();
      
      // è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦æ ¹æ®å…·ä½“çš„Pythonæ‰§è¡Œæ–¹æ¡ˆè¿›è¡Œè°ƒæ•´
      Logger.warn(this.TAG, 'Python script execution is simulated. In production, use actual Python interpreter.');
      
      Logger.info(this.TAG, 'Python initialization script executed successfully');
    } catch (error) {
      Logger.error(this.TAG, `Failed to execute Python init script: ${error}`);
      throw error;
    }
  }

  /**
   * æ‰§è¡ŒPythonæ–¹æ³•
   * @param method æ–¹æ³•åç§°
   * @param params å‚æ•°
   * @private
   */
  private executeMethod(method: string, params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null>))))))): Record<string, string | number | boolean | null> {
    // æ£€æŸ¥æ–¹æ³•æ˜¯å¦å­˜åœ?    if (typeof this.pyContext[method] !== 'function') {
      // å°è¯•åœ¨Pythonæ¨¡å—ä¸­æŸ¥æ‰?      const pyMethodName = `parse_${method}`;
      if (typeof this.pyContext[pyMethodName] !== 'function') {
        throw new Error(`Method ${method} or ${pyMethodName} not found in Python script`);
      }
      method = pyMethodName;
    }

    // é™åˆ¶æ–¹æ³•æ‰§è¡Œå†…å­˜ä½¿ç”¨
    const maxMemoryUsage = 100 * 1024 * 1024; // Pythonæ‰§è¡Œå¯èƒ½éœ€è¦æ›´å¤šå†…å­˜ï¼Œè®¾ç½®100MB
    if (!this.memoryManager.checkMemoryLimit(maxMemoryUsage)) {
      throw new Error('Memory limit exceeded for method execution');
    }

    try {
      // æ·±åº¦æ‹·è´å‚æ•°ï¼Œé¿å…å¼•ç”¨é—®é¢?      const safeParams = this.deepClone(params);

      // æ‰§è¡Œæ–¹æ³•
      const result = this.pyContext[method](safeParams);

      // åºåˆ—åŒ–ç»“æœä»¥æ£€æµ‹å¾ªç¯å¼•ç”?      const serializedResult = JSON.stringify(result);

      // æ·±åº¦æ‹·è´ç»“æœè¿”å›
      return this.deepClone(result);
    } catch (error) {
      Logger.error(this.TAG, `Error executing Python method ${method}: ${error instanceof Error ? error.message : String(error)}`);
      throw error;
    }
  }
  
  /**
   * æ·±åº¦æ‹·è´å¯¹è±¡
   * @private
   */
  private deepClone<T>(obj: T): T {
    if (obj === null || typeof obj !== 'object') {
      return obj;
    }

    try {
      return JSON.parse(JSON.stringify(obj));
    } catch (error) {
      Logger.error(this.TAG, `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}`)))))));
      return obj;
    }
  }

  /**
   * è·å–å®‰å…¨çš„å†…ç½®å‡½æ•?   * @private
   */
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®
   * æ›¿ä»£Object.keysï¼Œå…¼å®¹ArkTSè¯­æ³•
   */
  private getObjectKeys<T extends object>(obj: T): string[] {
    const keys: string[] = [];
    for (const key in obj) {
      if (Object.keys(obj).includes(key)) {
        keys.push(key);
      }
    }
    return keys;
  }
  
  /**
   * é¢„å¤„ç†Pythonä»£ç 
   * @private
   */
  private preprocessPythonCode(code: string): string {
    // è¿™é‡Œæ˜¯ç®€åŒ–çš„Pythonä»£ç é¢„å¤„ç†ç¤ºä¾?    // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è½¬æ¢é€»è¾‘
    
    // ç§»é™¤Pythonç‰¹å®šè¯­æ³•æ³¨é‡Š
    let processed = code.replace(/#.*$/gm, '');
    
    // ç§»é™¤å¤šè¡Œå­—ç¬¦ä¸²ï¼ˆç®€åŒ–å¤„ç†ï¼‰
    processed = processed.replace(/'''[\s\S]*?'''/g, '');
    processed = processed.replace(/"""[\s\S]*?"""/g, '');
    
    // æ›¿æ¢Pythonå¯¼å…¥è¯­å¥ï¼ˆç®€åŒ–å¤„ç†ï¼‰
    processed = processed.replace(/^import\s+\w+(\s+as\s+\w+)?$/gm, '');
    processed = processed.replace(/^from\s+\w+\s+import\s+.*$/gm, '');
    
    return processed;
  }

  /**
   * éªŒè¯Pythonä»£ç 
   * @private
   */
  private filterDangerousCode(): void {
    // æ£€æµ‹å¹¶è¿‡æ»¤å±é™©çš„Pythonæ“ä½œ
    const dangerousPatterns = [
      /__file__/g,
      /__name__/g,
      /__import__\s*\(/g,
      /exec\s*\(/g,
      /eval\s*\(/g,
      /compile\s*\(/g,
      /open\s*\(/g,
      /file\s*\(/g,
      /input\s*\(/g,
      /raw_input\s*\(/g,
      /os\./g,
      /sys\./g,
      /subprocess\./g,
      /shutil\./g,
      /ctypes\./g,
      /pickle\./g,
      /marshal\./g,
      /globals\s*\(/g,
      /locals\s*\(/g,
      /vars\s*\(/g,
      /dir\s*\(/g,
      /getattr\s*\(/g,
      /setattr\s*\(/g,
      /delattr\s*\(/g,
      /hasattr\s*\(/g,
      /type\s*\(/g,
      /isinstance\s*\(/g,
      /issubclass\s*\(/g
    ];

    for (const pattern of dangerousPatterns) {
      if (pattern.test(this.scriptContent)) {
        Logger.warn(this.TAG, `Dangerous Python code pattern detected: ${pattern.toString()}`);
        throw new Error(`Security violation: dangerous Python code pattern detected: ${pattern.toString()}`);
      }
    }

    // æ£€æŸ¥ä»£ç å¤æ‚åº¦ï¼Œé˜²æ­¢æ¶æ„å¾ªç?    const lineCount = this.scriptContent.split('\n').length;
    const braceCount = (this.scriptContent.match(/:/g) || []).length;

    if (lineCount > 2000 || braceCount > 800) {
      throw new Error('Python script too complex, potential security risk');
    }
  }

  /**
   * æå–Pythonå‡½æ•°
   * @private
   */
  private extractPythonFunctions(): void {
    // ç®€å•çš„å‡½æ•°æå–é€»è¾‘
    // åœ¨å®é™…å®ç°ä¸­ï¼Œéœ€è¦æ›´å¤æ‚çš„Pythonè¯­æ³•è§£æ
    const functionRegex = /def\s+(\w+)\s*\([^)]*\)\s*:/g;
    let match;
    
    while ((match = functionRegex.exec(this.pythonCode)) !== null) {
      const functionName = match[1];
      Logger.info(this.TAG, `Found Python function: ${functionName}`);
      
      // åˆ›å»ºå‡½æ•°ä»£ç†
      this.pyContext[functionName] = async (params: Record<string, string | number | boolean | null>) => {
        // æ¨¡æ‹Ÿå‡½æ•°æ‰§è¡Œ
        return { result: `Function ${functionName} executed with params` };
      };
    }
  }

  /**
   * å…³é—­Pythonæ²™ç®±
   * @private
   */
  // closePythonSandboxæ–¹æ³•å·²åˆå¹¶åˆ°cleanupResourcesæ–¹æ³•ä¸?
  /**
   * éªŒè¯å‚æ•°
   * @param params æ–¹æ³•å‚æ•°
   * @private
   */
  private validateParams(params: Record<string, string | number | boolean | null>): void {
    // æ£€æŸ¥å‚æ•°å¤§å°ï¼Œé˜²æ­¢è¿‡å¤§çš„å‚æ•°å¯¼è‡´å†…å­˜é—®é¢?    const paramsSize = JSON.stringify(params).length;
    if (paramsSize > 2 * 1024 * 1024) { // Pythonå¯èƒ½å¤„ç†æ›´å¤§çš„æ•°æ®ï¼Œè®¾ç½®2MBé™åˆ¶
      throw new Error('Parameters too large');
    }

    // æ£€æŸ¥å‚æ•°æ·±åº¦ï¼Œé˜²æ­¢æ·±å±‚åµŒå¥—å¯¹è±¡
    const maxDepth = 12;
    if (this.checkObjectDepth(params) > maxDepth) {
      throw new Error('Parameters too deeply nested');
    }

    // æ£€æŸ¥æ•°ç»„é•¿åº¦ï¼Œé˜²æ­¢è¿‡å¤§çš„æ•°ç»?    this.checkCollectionSize(params);
  }
  
  /**
   * æ£€æŸ¥å¯¹è±¡æ·±åº?   * @private
   */
  private checkObjectDepth(obj: Record<string, string | number | boolean | null>, currentDepth: number = 0): number {
    if (obj === null || typeof obj !== 'object') {
      return currentDepth;
    }

    const maxDepth = currentDepth;
    for (const key in obj) {
      if (Object.keys(obj).includes(key)) {
        const depth = this.checkObjectDepth(obj[key], currentDepth + 1);
        if (depth > maxDepth) {
          return depth;
        }
      }
    }

    return maxDepth;
  }
  
  /**
   * æ£€æŸ¥é›†åˆå¤§å°?   * @private
   */
  private checkCollectionSize(obj: Record<string, string | number | boolean | null>): void {
    const maxArrayLength = 20000;

    if (Array.isArray(obj)) {
      if (obj.length > maxArrayLength) {
        throw new Error('Array too large');
      }

      // é€’å½’æ£€æŸ¥æ•°ç»„å…ƒç´?      for (const item of obj) {
        if (typeof item === 'object' && item !== null) {
          this.checkCollectionSize(item);
        }
      }
    } else if (typeof obj === 'object' && obj !== null) {
      const keys = this.getObjectKeys(obj);
      if (keys.length > 2000) {
        throw new Error('Object has too many properties');
      }

      // é€’å½’æ£€æŸ¥å¯¹è±¡å±æ€?      for (const key of keys) {
        this.checkCollectionSize(obj[key]);
      }
    }
  }

  /**
   * è½¬æ¢ä¸ºPythonå‚æ•°æ ¼å¼
   * @param params JavaScriptå‚æ•°
   * @private
   */
  // è½¬æ¢æ–¹æ³•å·²åœ¨deepCloneå’ŒexecuteMethodä¸­å¤„ç?}


