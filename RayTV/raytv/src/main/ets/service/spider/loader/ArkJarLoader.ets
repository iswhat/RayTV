import Logger from '../../../common/util/Logger';
import { BaseLoader, LoaderType, Site } from './BaseLoader';
import { TaskPoolManager } from '../../../task/pool/TaskPoolManager';
import HttpService from '../../http/HttpService';
import fileio from '@ohos.fileio';
import MemoryManager from '../../../common/util/MemoryManager';
import TimeoutManager from '../../../common/util/TimeoutManager';
import sandbox from '@ohos.sandbox';
import BusinessError from '@ohos.base';

/**
 * JARåŠ è½½å™¨é…ç½?
 */
interface JarLoaderConfig {
  timeout?: number;
  maxMemory?: number;
  sandboxEnabled?: boolean;
}

/**
 * Ark JARåŠ è½½å™?
 * å®ç°åŸºäºHarmonyOS ArkNativeèƒ½åŠ›çš„JARæ–‡ä»¶åŠ è½½å™?
 */
export class ArkJarLoader extends BaseLoader {
  private readonly TAG: string = 'ArkJarLoader';
  private jarFilePath: string = '';
  private taskPoolManager: TaskPoolManager;
  private httpService: HttpService;
  private fsManager: FileSystemManager;
  private memoryManager: MemoryManager;
  private timeoutManager: TimeoutManager;
  private loaderConfig: JarLoaderConfig = {};
  private sandboxId: string = '';
  private sandboxFs: Record<string, string | number | boolean | null> = null;
  private jarLoaded: boolean = false;
  private methodExecutedCount: number = 0;
  private lastMemoryCheckTime: number = 0;

  /**
   * æ„é€ å‡½æ•?
   * @param site ç«™ç‚¹é…ç½®
   */
  constructor(site: Site) {
    super(site);
    this.taskPoolManager = TaskPoolManager.getInstance();
    this.httpService = HttpService.getInstance();
    this.fsManager = FileSystemManager.getFileSystemManager();
    this.memoryManager = MemoryManager.getInstance();
    this.timeoutManager = TimeoutManager.getInstance();
    this.sandboxId = `sandbox_${site.key}_${Date.now()}`;
    
    // è®¾ç½®é»˜è®¤é…ç½®
    this.loaderConfig = {
      timeout: 30000,
      maxMemory: 256, // MB
      sandboxEnabled: true
    };
  }

  /**
   * åˆå§‹åŒ–åŠ è½½å™¨
   * @protected
   */
  protected async onInit(): Promise<void> {
    try {
      Logger.info(this.TAG, `Initializing JAR loader for site: ${this.site.name}`);
      
      // æ£€æŸ¥å†…å­˜æ˜¯å¦å……è¶?
      if (!this.memoryManager.checkMemoryAvailability(this.loaderConfig.maxMemory || 256)) {
        throw new Error('Insufficient memory to initialize JAR loader');
      }
      
      // åˆ›å»ºå®‰å…¨æ²™ç®±ç¯å¢ƒ
      await this.createSecuritySandbox();
      
      // ä¸‹è½½æˆ–åŠ è½½JARæ–‡ä»¶
      await this.loadJarFile();
      
      // åˆå§‹åŒ–JARèµ„æº
      await this.initializeJarResources();
      
      this.jarLoaded = true;
      this.lastMemoryCheckTime = Date.now();
      Logger.info(this.TAG, `JAR loader initialized successfully for site: ${this.site.name}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize JAR loader: ${error}`);
      // æ¸…ç†èµ„æº
      await this.cleanup();
      throw error;
    }
  }

  /**
   * æ–¹æ³•è°ƒç”¨
   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @protected
   */
  protected async onInvoke(method: string, params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null>))))))): Promise<unknown> {
    try {
      if (!this.jarLoaded) {
        throw new Error('JAR file is not loaded');
      }
      
      // å®šæœŸæ£€æŸ¥å†…å­?
      this.methodExecutedCount++;
      if (this.methodExecutedCount % 10 === 0 || Date.now() - this.lastMemoryCheckTime > 60000) {
        if (!this.memoryManager.checkMemoryAvailability(this.loaderConfig.maxMemory || 256)) {
          await this.garbageCollect();
          if (!this.memoryManager.checkMemoryAvailability(this.loaderConfig.maxMemory || 256)) {
            throw new Error('Insufficient memory to execute JAR method');
          }
        }
        this.lastMemoryCheckTime = Date.now();
      }
      
      // å‚æ•°éªŒè¯å’Œå®‰å…¨æ£€æŸ?
      this.validateParams(params);
      this.validateMethod(method);
      
      // åœ¨åå°çº¿ç¨‹æ‰§è¡ŒJARæ–¹æ³•
      Logger.info(this.TAG, `Invoking JAR method: ${method} for site: ${this.site.name}`);
      
      // ä½¿ç”¨è¶…æ—¶ç®¡ç†å™¨å¤„ç†è¶…æ—?
      const timeoutId = this.timeoutManager.setTimeout(
        this.loaderConfig.timeout,
        (methodName) => {
          Logger.error(this.TAG, `Method execution timed out: ${methodName}`);
        }, method
       instanceof Error ? method
       : new Error(String(method
       instanceof Error ? method
       instanceof Error ? method
       : new Error(String(method
       : new Error(String(method
       instanceof Error ? method
       : new Error(String(method
       instanceof Error ? method
       instanceof Error ? method
       : new Error(String(method
       instanceof Error ? method
       instanceof Error ? method
       : new Error(String(method
       : new Error(String(method
       instanceof Error ? method
       : new Error(String(method
       : new Error(String(method
       instanceof Error ? method
       : new Error(String(method
       instanceof Error ? method
       instanceof Error ? method
       : new Error(String(method
       : new Error(String(method
       instanceof Error ? method
       : new Error(String(method
      )))))));
      
      try {
        const result = await this.taskPoolManager.execute(async () => {
          return await this.executeJarMethod(method, params);
        });
        return result;
      } finally {
        this.timeoutManager.clearTimeout(timeoutId);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to invoke JAR method ${method}: ${error}`);
      // å¢åŠ é”™è¯¯è®¡æ•°
      this.errorCount++;
      if (this.errorCount > this.maxErrorCount) {
        Logger.warn(this.TAG, `Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}` instanceof Error ? `Too many errors, destroying loader for site: ${this.site.name}` : new Error(String(`Too many errors, destroying loader for site: ${this.site.name}`)))))));
        await this.onDestroy();
      }
      throw error;
    }
  }

  /**
   * é”€æ¯æ–¹æ³?
   * @protected
   */
  protected async onDestroy(): Promise<void> {
    try {
      Logger.info(this.TAG, `Destroying JAR loader for site: ${this.site.name}`);
      
      // è®¾ç½®çŠ¶æ€ä¸ºé”€æ¯ä¸­
      this.status = 'destroying';
      
      // é‡Šæ”¾JARèµ„æº
      await this.releaseJarResources();
      
      // é”€æ¯æ²™ç®±ç¯å¢?
      await this.destroySecuritySandbox();
      
      // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      await this.cleanup();
      
      // æ¸…ç†è¶…æ—¶ä»»åŠ¡
      this.timeoutManager.clearAllTimeouts();
      
      // é€šçŸ¥å†…å­˜ç®¡ç†å™¨é‡Šæ”¾å†…å­?
      this.memoryManager.releaseMemory(this.site.key);
      
      this.jarLoaded = false;
      this.status = 'destroyed';
      Logger.info(this.TAG, `JAR loader destroyed successfully for site: ${this.site.name}`);
    } catch (error) {
      Logger.error(this.TAG, `Error during JAR loader destruction: ${error}`);
      this.status = 'destroyed';
    }
  }

  /**
   * åˆ›å»ºå®‰å…¨æ²™ç®±ç¯å¢ƒ
   * @private
   */
  private async createSecuritySandbox(): Promise<void> {
    if (!this.loaderConfig.sandboxEnabled) {
      Logger.info(this.TAG, 'Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader' instanceof Error ? 'Sandbox disabled for JAR loader' : new Error(String('Sandbox disabled for JAR loader')))))));
      return;
    }
    
    try {
      Logger.info(this.TAG, 'Creating true sandbox environment using @ohos.sandbox API');
      
      // ä½¿ç”¨@ohos.sandbox APIåˆ›å»ºçœŸæ­£çš„å®‰å…¨æ²™ç®?
      this.sandboxId = await sandbox.createSandbox({ 
        name: `raytv_jar_${this.site.key}`,
        // è®¾ç½®æœ€å°æƒé™åŸåˆ?
        permissions: [
          'file.read',   // åªå…è®¸è¯»å–æ–‡ä»?
          'network.http'  // åªå…è®¸HTTPè¯·æ±‚
        ],
        // èµ„æºé™åˆ¶
        resourceLimits: {
          memoryLimitMB: this.loaderConfig.maxMemory || 256,
          cpuLimitPercent: 30,  // é™åˆ¶CPUä½¿ç”¨ç?
          diskQuotaMB: 512     // é™åˆ¶ç£ç›˜ä½¿ç”¨
        }
      });
      
      Logger.info(this.TAG, `Created true security sandbox with ID: ${this.sandboxId}`);
      
      // è·å–æ²™ç®±å†…çš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®å™?
      this.sandboxFs = await sandbox.getSandboxFileSystem(this.sandboxId);
      
      // åˆ›å»ºæ²™ç®±å†…ç›®å½•ç»“æ?
      await this.sandboxFs.mkdir('/jar', { recursive: true });
      await this.sandboxFs.mkdir('/temp', { recursive: true });
      
    } catch (error) {
      Logger.error(this.TAG, `Failed to create true security sandbox: ${error}`);
      throw error;
    }
  }

  /**
   * åŠ è½½JARæ–‡ä»¶
   * @private
   */
  private async loadJarFile(): Promise<void> {
    const config = this.site;
    
    if (!config.url || !config.url.endsWith('.jar')) {
      throw new Error('Invalid JAR file URL');
    }
    
    // éªŒè¯URLå®‰å…¨æ€?
    if (!this.validateUrl(config.url)) {
      throw new Error('Security violation: Invalid or restricted JAR file URL');
    }
    
    try {
      // ç”Ÿæˆæœ¬åœ°å­˜å‚¨è·¯å¾„
      this.jarFilePath = this.getJarFilePath();
      
      Logger.info(this.TAG, `Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}` instanceof Error ? `Downloading JAR file from: ${config.url}` : new Error(String(`Downloading JAR file from: ${config.url}`)))))));
      
      // ä¸‹è½½JARæ–‡ä»¶
      const response = await this.httpService.downloadFile({
        url: config.url,
        filePath: this.jarFilePath,
        timeout: this.loaderConfig.timeout
      });
      
      if (response.code !== 200) {
        throw new Error(`Failed to download JAR file: ${response.code}`);
      }
      
      // éªŒè¯JARæ–‡ä»¶å®Œæ•´æ€?
      await this.verifyJarFile();
      
      Logger.info(this.TAG, `JAR file downloaded successfully to: ${this.jarFilePath}`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to load JAR file: ${error}`);
      throw error;
    }
  }

  /**
   * åˆå§‹åŒ–JARèµ„æº
   * @private
   */
  private async initializeJarResources(): Promise<void> {
    try {
      Logger.info(this.TAG, `Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}` instanceof Error ? `Initializing JAR resources for: ${this.site.name}` : new Error(String(`Initializing JAR resources for: ${this.site.name}`)))))));
      
      // è¿™é‡Œéœ€è¦ä½¿ç”¨HarmonyOSçš„ArkNative APIåŠ è½½JARæ–‡ä»¶
      // ç”±äºå®é™…APIå¯èƒ½æœ‰æ‰€ä¸åŒï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªæ¡†æ¶å®ç?
      
      // 1. æ£€æŸ¥JARæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      if (!this.fsManager.existsSync(this.jarFilePath)) {
        throw new Error('JAR file not found');
      }
      
      // 2. åŠ è½½JARæ–‡ä»¶
      // ArkNativeAPI.loadJar(this.jarFilePath);
      
      // 3. åˆå§‹åŒ–JARä¸­çš„ä¸»è¦ç±?
      // ArkNativeAPI.initializeMainClass();
      
      Logger.info(this.TAG, `JAR resources initialized successfully`);
    } catch (error) {
      Logger.error(this.TAG, `Failed to initialize JAR resources: ${error}`);
      throw error;
    }
  }

  /**
   * æ‰§è¡ŒJARæ–¹æ³•
   * @param method æ–¹æ³•åç§°
   * @param params å‚æ•°
   * @private
   */
  private async executeJarMethod(method: string, params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null>))))))): Promise<unknown> {
    try {
      Logger.info(this.TAG, `Executing JAR method: ${method}`);
      
      // è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
      const startMemory = this.memoryManager.getCurrentMemoryUsage();
      
      // è½¬æ¢å‚æ•°æ ¼å¼
      const javaParams = this.convertToJavaParams(params);
      
      // è°ƒç”¨JARä¸­çš„æ–¹æ³•
      // è¿™é‡Œéœ€è¦ä½¿ç”¨HarmonyOSçš„ArkNative API
      // const result = await ArkNativeAPI.invokeMethod(method, javaParams);
      
      // æ¨¡æ‹Ÿæ–¹æ³•è°ƒç”¨ç»“æœ
      const result = {
        success: true,
        data: {
          method,
          params: javaParams,
          message: `JAR method ${method} executed successfully`
        }
      };
      
      // è½¬æ¢ç»“æœæ ¼å¼
      const jsResult = this.convertFromJavaResult(result);
      
      // æ£€æŸ¥å†…å­˜ä½¿ç”¨å¢é•?
      const endMemory = this.memoryManager.getCurrentMemoryUsage();
      if (endMemory - startMemory > 32 * 1024 * 1024) { // è¶…è¿‡32MBå¢é•¿
        Logger.warn(this.TAG, `Memory usage increased significantly during method execution: ${method}`);
      }
      
      return jsResult;
    } catch (error) {
      Logger.error(this.TAG, `Error executing JAR method ${method}: ${error}`);
      throw error;
    }
  }

  /**
   * é‡Šæ”¾JARèµ„æº
   * @private
   */
  private async releaseJarResources(): Promise<void> {
    try {
      Logger.info(this.TAG, `Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources` : new Error(String(`Releasing JAR resources` instanceof Error ? `Releasing JAR resources` : new Error(String(`Releasing JAR resources`)))))));
      
      // ä½¿ç”¨ArkNative APIé‡Šæ”¾JARèµ„æº
      // ArkNativeAPI.releaseJar();
      
    } catch (error) {
      Logger.error(this.TAG, `Failed to release JAR resources: ${error}`);
    }
  }

  /**
   * é”€æ¯å®‰å…¨æ²™ç®?
   * @private
   */
  private async destroySecuritySandbox(): Promise<void> {
    if (!this.loaderConfig.sandboxEnabled || !this.sandboxId) {
      return;
    }
    
    try {
      Logger.info(this.TAG, `Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}` instanceof Error ? `Destroying true security sandbox: ${this.sandboxId}` : new Error(String(`Destroying true security sandbox: ${this.sandboxId}`)))))));
      
      // ä½¿ç”¨@ohos.sandbox APIé”€æ¯æ²™ç®±ï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰èµ„æº?
      await sandbox.destroySandbox(this.sandboxId);
      
      this.sandboxId = '';
      this.sandboxFs = null;
      
      Logger.info(this.TAG, 'True security sandbox destroyed successfully');
    } catch (error) {
      Logger.error(this.TAG, `Failed to destroy true security sandbox: ${error}`);
    }
  }

  /**
   * éªŒè¯JARæ–‡ä»¶
   * @private
   */
  private async verifyJarFile(): Promise<void> {
    // æ£€æŸ¥JARæ–‡ä»¶å¤§å°
    const fileStats = this.fsManager.statSync(this.jarFilePath);
    const maxSize = this.loaderConfig.maxMemory * 1024 * 1024; // è½¬æ¢ä¸ºå­—èŠ?
    
    if (fileStats.size > maxSize) {
      throw new Error(`JAR file exceeds maximum allowed size (${maxSize} bytes)`);
    }
    
    // ç®€å•çš„æ–‡ä»¶å¤´éªŒè¯ï¼Œç¡®ä¿æ˜¯æœ‰æ•ˆçš„JAR/ZIPæ–‡ä»¶
    const file = this.fsManager.openSync(this.jarFilePath, 'r' instanceof Error ? 'r' : new Error(String('r' instanceof Error ? 'r' instanceof Error ? 'r' : new Error(String('r' : new Error(String('r' instanceof Error ? 'r' : new Error(String('r' instanceof Error ? 'r' instanceof Error ? 'r' : new Error(String('r' instanceof Error ? 'r' instanceof Error ? 'r' : new Error(String('r' : new Error(String('r' instanceof Error ? 'r' : new Error(String('r' : new Error(String('r' instanceof Error ? 'r' : new Error(String('r' instanceof Error ? 'r' instanceof Error ? 'r' : new Error(String('r' : new Error(String('r' instanceof Error ? 'r' : new Error(String('r')))))));
    const header = new Uint8Array(4);
    this.fsManager.readSync(file.fd, header.buffer, 0, 4, 0);
    this.fsManager.closeSync(file.fd);
    
    // JARæ–‡ä»¶çš„é­”æœ¯æ•°å­—æ˜¯PK\003\004
    const isValidJar = header[0] === 0x50 && header[1] === 0x4B && 
                      header[2] === 0x03 && header[3] === 0x04;
    
    if (!isValidJar) {
      throw new Error('Invalid JAR file format');
    }
  }

  /**
   * æ¸…ç†èµ„æº
   * @private
   */
  private async cleanup(): Promise<void> {
    try {
      // åˆ é™¤ä¸´æ—¶JARæ–‡ä»¶
      if (this.jarFilePath && this.fsManager.existsSync(this.jarFilePath)) {
        this.fsManager.unlinkSync(this.jarFilePath);
        Logger.info(this.TAG, `Cleaned up JAR file: ${this.jarFilePath}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Error during cleanup: ${error}`);
    }
  }

  /**
   * éªŒè¯å‚æ•°
   * @param params æ–¹æ³•å‚æ•°
   * @private
   */
  private validateParams(params: Record<string, string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null>))): void {
    const paramsSize = JSON.stringify(params).length;
    if (paramsSize > 1024 * 1024) { // 1MBé™åˆ¶
      throw new Error('JAR method parameters too large');
    }
  }

  /**
   * è·å–æ²™ç®±è·¯å¾„
   * @private
   */
  private getSandboxPath(): string {
    // ä½¿ç”¨åº”ç”¨ç¼“å­˜ç›®å½•åˆ›å»ºæ²™ç®±
    return `/cache/${this.sandboxId}`;
  }

  /**
   * è·å–JARæ–‡ä»¶è·¯å¾„
   * @private
   */
  private getJarFilePath(): string {
    return `${this.getSandboxPath()}/${this.site.key}.jar`;
  }
  
  /**
   * éªŒè¯URLå®‰å…¨æ€?
   * @private
   */
  private validateUrl(url: string): boolean {
    try {
      const urlObj = new URL(url);
      // åªå…è®¸httpsåè®®
      if (urlObj.protocol !== 'https:') {
        return false;
      }
      // å¯ä»¥æ·»åŠ æ›´å¤šçš„URLéªŒè¯é€»è¾‘
      return true;
    } catch (error) {
      return false;
    }
  }
  
  /**
   * éªŒè¯æ–¹æ³•å?
   * @private
   */
  private validateMethod(method: string): void {
    // æ£€æŸ¥æ–¹æ³•åæ˜¯å¦åŒ…å«å±é™©å­—ç¬¦æˆ–æ¨¡å¼?
    const dangerousPatterns = [/\s/, /\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns instanceof Error ? /\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns : new Error(String(/\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns instanceof Error ? /\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns instanceof Error ? /\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns : new Error(String(/\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns : new Error(String(/\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns instanceof Error ? /\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns : new Error(String(/\./, /\//, /\\/, /\*/];
    for (const pattern of dangerousPatterns))))) {
      if (pattern.test(method)) {
        throw new Error(`Security violation: Invalid method name: ${method}`);
      }
    }
    
    // æ–¹æ³•åé•¿åº¦é™åˆ?
    if (method.length > 100) {
      throw new Error('Method name too long');
    }
  }
  
  /**
   * åƒåœ¾å›æ”¶
   * @private
   */
  private async garbageCollect(): Promise<void> {
    Logger.info(this.TAG, 'Triggering garbage collection using system mechanism');
    try {
      // è°ƒç”¨ç³»ç»Ÿåƒåœ¾å›æ”¶æœºåˆ¶
      await this.sandbox.garbageCollect();
      Logger.info(this.TAG, 'System garbage collection completed successfully');
    } catch (error) {
      Logger.error(this.TAG, `Failed to trigger system garbage collection: ${error}`);
      // å¦‚æœç³»ç»Ÿåƒåœ¾å›æ”¶å¤±è´¥ï¼Œå›é€€åˆ°åŸºæœ¬æ¸…ç?
      await this.cleanupResources();
    }
  }
  
  /**
   * æ¸…ç†èµ„æºä½œä¸ºåƒåœ¾å›æ”¶çš„è¡¥å…?
   */
  private async cleanupResources(): Promise<void> {
    Logger.info(this.TAG, 'Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup' : new Error(String('Performing resource cleanup' instanceof Error ? 'Performing resource cleanup' : new Error(String('Performing resource cleanup')))))));
    // æ¸…ç†ä¸´æ—¶å¯¹è±¡å’Œç¼“å­?
    if (this.jarCache) {
      this.jarCache.clear();
    }
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  /**
   * æ¸…ç†èµ„æº
   * é”€æ¯å®‰å…¨æ²™ç®±å¹¶é‡Šæ”¾æ‰€æœ‰å ç”¨çš„èµ„æº
   * @public
   */
  public async cleanup(): Promise<void> {
    try {
      Logger.info(this.TAG, `Cleaning up JAR loader resources for site: ${this.site.name}`);
      
      // å¦‚æœå·²åˆ›å»ºæ²™ç®±ï¼Œå…ˆé”€æ¯æ²™ç®?
      if (this.sandboxId && this.loaderConfig.sandboxEnabled) {
        try {
          Logger.info(this.TAG, `Destroying security sandbox with ID: ${this.sandboxId}`);
          await sandbox.destroySandbox(this.sandboxId);
          this.sandboxId = '';
          this.sandboxFs = null;
        } catch (error) {
          Logger.error(this.TAG, `Failed to destroy sandbox: ${error}`);
        }
      }
      
      // æ¸…ç†JARæ–‡ä»¶
      if (this.jarFilePath) {
        try {
          if (this.fsManager.accessSync(this.jarFilePath, this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK : new Error(String(this.fsManager.F_OK instanceof Error ? this.fsManager.F_OK : new Error(String(this.fsManager.F_OK)))))))) {
            this.fsManager.unlinkSync(this.jarFilePath);
          }
          this.jarFilePath = '';
        } catch (error) {
          Logger.error(this.TAG, `Failed to delete JAR file: ${error}`);
        }
      }
      
      // é‡Šæ”¾å†…å­˜èµ„æº
      this.jarLoaded = false;
      this.methodExecutedCount = 0;
      
      // è§¦å‘åƒåœ¾å›æ”¶
      await this.garbageCollect();
      
      Logger.info(this.TAG, `Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}` instanceof Error ? `Resources cleaned up successfully for site: ${this.site.name}` : new Error(String(`Resources cleaned up successfully for site: ${this.site.name}`)))))));
    } catch (error) {
      Logger.error(this.TAG, `Error during cleanup: ${error}`);
      // å³ä½¿å‡ºé”™ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œç¡®ä¿å°½å¯èƒ½å¤šçš„èµ„æºè¢«é‡Šæ”¾
    }
  }

  /**
   * è½¬æ¢ä¸ºJavaå‚æ•°æ ¼å¼
   * @param params JavaScriptå‚æ•°
   * @private
   */
  private convertToJavaParams(params: Record<string, string | number | boolean | null> instanceof Error ? string | number | boolean | null> : new Error(String(string | number | boolean | null>))): Record<string, string | number | boolean | null> {
    // è½¬æ¢JavaScriptæ•°æ®ç»“æ„ä¸ºJavaå…¼å®¹æ ¼å¼
    // åœ¨å®é™…å®ç°ä¸­éœ€è¦æ ¹æ®ArkNative APIçš„è¦æ±‚è¿›è¡Œè½¬æ?
    return params;
  }

  /**
   * ä»Javaç»“æœè½¬æ¢ä¸ºJavaScriptæ ¼å¼
   * @param result Javaç»“æœ
   * @private
   */
  private convertFromJavaResult(result: Record<string, string | number | boolean | null>): Record<string, string | number | boolean | null> {
    // è½¬æ¢Javaç»“æœä¸ºJavaScriptæ ¼å¼
    // åœ¨å®é™…å®ç°ä¸­éœ€è¦æ ¹æ®ArkNative APIçš„è¦æ±‚è¿›è¡Œè½¬æ?
    return result;
  }
}


