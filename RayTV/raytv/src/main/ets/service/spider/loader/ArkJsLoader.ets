import Logger from '../../../common/util/Logger';
import { BaseLoader, LoaderType, Site } from './BaseLoader';
import { TaskPoolManager } from '../../../task/pool/TaskPoolManager';
import HttpService from '../../http/HttpService';
import MemoryManager from '../../../common/util/MemoryManager';
import TimeoutManager from '../../../common/util/TimeoutManager';

/**
 * JavaScriptæ‰§è¡Œä¸Šä¸‹æ–? */
interface JsContext {
  contextData?: Record<string, unknown>;
}

/**
 * Ark JavaScriptåŠ è½½å™? * å®ç°åŸºäºHarmonyOSçš„JavaScriptä»£ç åŠ è½½å’Œæ‰§è¡Œå™¨
 */
export class ArkJsLoader extends BaseLoader {
  private readonly TAG: string = 'ArkJsLoader';
  private jsContext: JsContext = {};
  private scriptContent: string = '';
  private taskPoolManager: TaskPoolManager;
  private httpService: HttpService;
  private memoryManager: MemoryManager;
  private timeoutManager: TimeoutManager;
  private lastUsedTime: number = 0;
  private isInitialized: boolean = false;

  /**
   * æ„é€ å‡½æ•?   * @param site ç«™ç‚¹é…ç½®
   */
  constructor(site: Site) {
    super(site);
    this.taskPoolManager = TaskPoolManager.getInstance();
    this.httpService = HttpService.getInstance();
    this.memoryManager = MemoryManager.getInstance();
    this.timeoutManager = TimeoutManager.getInstance();
  }

  /**
   * åˆå§‹åŒ–åŠ è½½å™¨
   * @protected
   */
  protected async onInit(): Promise<void> {
    try {
      // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†?      if (!this.memoryManager.checkMemoryAvailability()) {
        throw new Error('Insufficient memory to initialize JS loader');
      }
      
      // åŠ è½½JavaScriptä»£ç 
      await this.loadScript();
      
      // åˆ›å»ºå®‰å…¨æ²™ç®±ç¯å¢ƒ
      this.createSandbox();
      
      // æ³¨å…¥åŸºç¡€API
      this.injectApis();
      
      // æ‰§è¡Œåˆå§‹åŒ–è„šæœ?      await this.executeInitScript();
      
      this.isInitialized = true;
      this.lastUsedTime = Date.now();
      Logger.info(this.TAG, `JS loader initialized for site: ${this.site.name}`);
    } catch (error) {
      this.isInitialized = false;
      this.cleanupResources();
      Logger.error(this.TAG, `Failed to initialize JS loader: ${error}`);
      throw error;
    }
  }

  /**
   * æ–¹æ³•è°ƒç”¨
   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @protected
   */
  protected async onInvoke(method: string, params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null>))))))): Promise<unknown> {
    if (!this.isInitialized) {
      await this.onInit();
    }
    
    this.lastUsedTime = Date.now();
    
    try {
      // å®‰å…¨æ£€æŸ?      this.validateParams(params);
      
      // è®¾ç½®æ‰§è¡Œè¶…æ—¶
      const timeoutId = this.timeoutManager.setTimeout(() => {
        throw new Error(`Method ${method} execution timed out`);
      }, 30000); // 30ç§’è¶…æ—?      
      try {
        // åœ¨åå°çº¿ç¨‹æ‰§è¡ŒJavaScriptæ–¹æ³•
        const result = await this.taskPoolManager.execute(() => {
          return this.executeMethod(method, params);
        });
        
        return result;
      } finally {
        this.timeoutManager.clearTimeout(timeoutId);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to invoke JS method ${method}: ${error}`);
      // é”™è¯¯è®¡æ•°å¢åŠ 
      this.errorCount++;
      
      // å¦‚æœé”™è¯¯è¿‡å¤šï¼Œæ¸…ç†èµ„æº?      if (this.errorCount >= this.maxErrorCount) {
        Logger.warn(this.TAG, `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources` instanceof Error ? `Too many errors, cleaning up resources` : new Error(String(`Too many errors, cleaning up resources`)))))));
        this.cleanupResources();
      }
      
      throw error;
    }
  }

  /**
   * é”€æ¯æ–¹æ³?   * @protected
   */
  protected onDestroy(): void {
    this.cleanupResources();
    Logger.info(this.TAG, `JS loader destroyed for site: ${this.site.name}`);
  }
  
  /**
   * æ¸…ç†èµ„æº
   * @private
   */
  private cleanupResources(): void {
    // æ¸…ç†JavaScriptä¸Šä¸‹æ–?    if (this.jsContext) {
      // ç›´æ¥åˆ›å»ºæ–°å¯¹è±¡æ›¿ä»£deleteæ“ä½œ
      this.jsContext = {};
    }
    
    this.scriptContent = '';
    this.isInitialized = false;
    
    // é‡Šæ”¾å†…å­˜
    this.memoryManager.forceGC();
    
    Logger.info(this.TAG, 'Resources cleaned up');
  }
  
  /**
   * è·å–æœ€åä½¿ç”¨æ—¶é—?   */
  public getLastUsedTime(): number {
    return this.lastUsedTime;
  }
  
  /**
   * æ˜¯å¦å·²åˆå§‹åŒ–
   */
  public getIsInitialized(): boolean {
    return this.isInitialized;
  }

  /**
   * åŠ è½½JavaScriptä»£ç 
   * @private
   */
  private async loadScript(): Promise<void> {
    const config = this.site;
    
    if (config.url && (config.url.startsWith('http://') || config.url.startsWith('https://'))) {
      // ä»URLåŠ è½½
      Logger.info(this.TAG, `Loading script from URL: ${config.url}`);
      try {
        const response = await this.httpService.get(config.url, { timeout: 10000 });
        this.scriptContent = response.data as string;
      } catch (error) {
        Logger.error(this.TAG, `Failed to load script from URL: ${error}`);
        // å¦‚æœURLåŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ä»£ç ?        if (config.content) {
          Logger.warn(this.TAG, 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content' : new Error(String('Falling back to config content' instanceof Error ? 'Falling back to config content' : new Error(String('Falling back to config content')))))));
          this.scriptContent = config.content as string;
        } else {
          throw new Error(`Failed to load script: ${error}`);
        }
      }
    } else if (config.content) {
      // ç›´æ¥ä½¿ç”¨é…ç½®ä¸­çš„ä»£ç 
      Logger.info(this.TAG, 'Using script content from config');
      this.scriptContent = config.content as string;
    } else {
      throw new Error('No script source provided (url or content)');
    }
    
    // å®‰å…¨è¿‡æ»¤
    this.filterDangerousCode();
  }

  /**
   * åˆ›å»ºæ²™ç®±ç¯å¢ƒ
   * @private
   */
  private createSandbox(): void {
    // åˆ›å»ºç‹¬ç«‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡
    this.jsContext = {
      // æ¸…ç©ºä¸Šä¸‹æ–‡ï¼ŒåªåŒ…å«å¿…è¦çš„å¯¹è±¡
    };
    
    Logger.info(this.TAG, 'Created JavaScript sandbox environment');
  }

  /**
   * æ³¨å…¥åŸºç¡€API
   * @private
   */
  private injectApis(): void {
    // æ³¨å…¥HTTPè¯·æ±‚API
    this.jsContext.http = {
      get: async (url: string, options?: { headers?: Record<string, string>, timeout?: number }) => {
        // éªŒè¯URLå®‰å…¨æ€?        this.validateUrl(url);
        return this.httpService.get(url, options || {});
      },
      post: async (url: string, data?: Record<string, string | number | boolean | null>, options?: { headers?: Record<string, string>, timeout?: number }) => {
        // éªŒè¯URLå®‰å…¨æ€?        this.validateUrl(url);
        return this.httpService.post(url, data, options || {});
      }
    };
    
    // æ³¨å…¥åŠ å¯†API
    this.jsContext.crypto = {
      md5: (str: string) => {
        // ä½¿ç”¨HarmonyOSæä¾›çš„åŠ å¯†API
        try {
          // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥ä½¿ç”¨@ohos.security.cryptoæä¾›çš„åŠ å¯†åŠŸèƒ?          // è¿™é‡Œä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²å¤„ç†ä½œä¸ºé™çº§æ–¹æ¡?          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸?2ä½æ•´æ•?          }
          return Math.abs(hash).toString(16);
        } catch (error) {
          // é™çº§å¤„ç†
          return `md5_${str}`;
        }
      },
      base64: {
        encode: (str: string) => {
          try {
            return btoa(unescape(encodeURIComponent(str)));
          } catch (error) {
            Logger.error(this.TAG, `Base64 encode error: ${error}`);
            return '';
          }
        }, decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string : new Error(String(decode: (str: string instanceof Error ? decode: (str: string : new Error(String(decode: (str: string))))))) => {
          try {
            return decodeURIComponent(escape(atob(str)));
          } catch (error) {
            Logger.error(this.TAG, `Base64 decode error: ${error}`);
            return '';
          }
        }
      }
    };
    
    // æ³¨å…¥å­—ç¬¦ä¸²å¤„ç†å·¥å…·ï¼ˆæ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼ï¼‰
    this.jsContext.stringUtil = {
      // ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ–¹æ³•æ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼
      contains: (text: string, substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string instanceof Error ? substring: string instanceof Error ? substring: string : new Error(String(substring: string : new Error(String(substring: string instanceof Error ? substring: string : new Error(String(substring: string))))))): boolean => {
        return text.indexOf(substring) !== -1;
      },
      startsWith: (text: string, prefix: string): boolean => {
        return text.indexOf(prefix) === 0;
      },
      endsWith: (text: string, suffix: string): boolean => {
        return text.lastIndexOf(suffix) === text.length - suffix.length;
      },
      split: (text: string, separator: string): string[] => {
        return text.split(separator);
      },
      replace: (text: string, search: string, replacement: string): string => {
        return text.replace(search, replacement);
      }
    };
    
    // æ³¨å…¥æ—¥å¿—API
    this.jsContext.logger = {
      info: (message: string) => {
        Logger.info(`${this.TAG}[${this.site.name}]`, message);
      },
      warn: (message: string) => {
        Logger.warn(`${this.TAG}[${this.site.name}]`, message);
      },
      error: (message: string) => {
        Logger.error(`${this.TAG}[${this.site.name}]`, message);
      }
    };
    
    // æ³¨å…¥å·¥å…·å‡½æ•°
    this.jsContext.util = {
      parseJson: (text: string) => {
        try {
          return JSON.parse(text);
        } catch (error) {
          Logger.error(this.TAG, `JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}` instanceof Error ? `JSON parse error: ${error}` : new Error(String(`JSON parse error: ${error}`)))))));
          return null;
        }
      },
      stringifyJson: (obj: Record<string, string | number | boolean | null>) => {
        try {
          return JSON.stringify(obj);
        } catch (error) {
          Logger.error(this.TAG, `JSON stringify error: ${error}`);
          return '{}';
        }
      }, // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number instanceof Error ? // æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number : new Error(String(// æ·»åŠ å»¶æ—¶å‡½æ•°
      sleep: (ms: number))))))) => {
        return new Promise(resolve => setTimeout(resolve, Math.min(ms, 5000))); // é™åˆ¶æœ€å¤§å»¶æ—?ç§?      }
    };
    
    Logger.info(this.TAG, 'Injected enhanced APIs into JS context');
  }
  
  /**
   * éªŒè¯URLå®‰å…¨æ€?   * @private
   */
  private validateUrl(url: string): void {
    // æ£€æŸ¥URLæ˜¯å¦ä¸ºç›¸å¯¹è·¯å¾„æˆ–ç™½åå•å†…çš„åŸŸå?    const allowedDomains = this.site.allowedDomains || [];
    
    try {
      const urlObj = new URL(url);
      const hostname = urlObj.hostname;
      
      // æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•å†…
      const isAllowed = allowedDomains.some(domain => {
        return hostname === domain || hostname.endsWith(`.${domain}`);
      });
      
      if (!isAllowed) {
        throw new Error(`URL domain not allowed: ${hostname}`);
      }
    } catch (error) {
      if (error instanceof TypeError) {
        // å¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¿½ç•¥URLè§£æé”™è¯¯
      } else {
        throw error;
      }
    }
  }

  /**
   * æ‰§è¡Œåˆå§‹åŒ–è„šæœ?   * @private
   */
  private async executeInitScript(): Promise<void> {
    try {
      // ä½¿ç”¨å®‰å…¨çš„æ–¹å¼æ‰§è¡Œè„šæœ?      const safeEval = new Function('context', `
        with(context) {
          ${this.scriptContent};
        }
        return { exports: module?.exports || {} };
      `);
      
      const result = safeEval(this.jsContext);
      
      // åˆå¹¶å¯¼å‡ºå¯¹è±¡åˆ°ä¸Šä¸‹æ–‡
      if (result.exports) {
        Object.assign(this.jsContext, result.exports);
      }
      
      Logger.info(this.TAG, 'Initial script executed successfully');
    } catch (error) {
      Logger.error(this.TAG, `Failed to execute init script: ${error}`);
      throw error;
    }
  }

  /**
   * æ‰§è¡Œæ–¹æ³•
   * @param method æ–¹æ³•åç§°
   * @param params æ–¹æ³•å‚æ•°
   * @private
   */
  private executeMethod(method: string, params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null> instanceof Error ? params: Record<string, string | number | boolean | null> : new Error(String(params: Record<string, string | number | boolean | null>))))))): Record<string, string | number | boolean | null> {
    if (typeof this.jsContext[method] !== 'function') {
      throw new Error(`Method ${method} not found in script`);
    }
    
    // é™åˆ¶æ–¹æ³•æ‰§è¡Œå†…å­˜ä½¿ç”¨
    const maxMemoryUsage = 50 * 1024 * 1024; // 50MB
    if (!this.memoryManager.checkMemoryLimit(maxMemoryUsage)) {
      throw new Error('Memory limit exceeded for method execution');
    }
    
    try {
      // æ·±åº¦æ‹·è´å‚æ•°ï¼Œé¿å…å¼•ç”¨é—®é¢?      const safeParams = this.deepClone(params);
      
      // æ‰§è¡Œæ–¹æ³•
      const result = this.jsContext[method](safeParams);
      
      // åºåˆ—åŒ–ç»“æœä»¥æ£€æµ‹å¾ªç¯å¼•ç”?      const serializedResult = JSON.stringify(result);
      
      // æ·±åº¦æ‹·è´ç»“æœè¿”å›
      return this.deepClone(result);
    } catch (error) {
      Logger.error(this.TAG, `Error executing method ${method}: ${error instanceof Error ? error.message : String(error)}`);
      throw error;
    }
  }
  
  /**
   * æ·±åº¦æ‹·è´å¯¹è±¡
   * @private
   */
  private deepClone<T>(obj: T): T {
    if (obj === null || typeof obj !== 'object') {
      return obj;
    }
    
    try {
      return JSON.parse(JSON.stringify(obj));
    } catch (error) {
      Logger.error(this.TAG, `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}` instanceof Error ? `Deep clone error: ${error}` : new Error(String(`Deep clone error: ${error}`)))))));
      return obj;
    }
  }

  /**
   * è¿‡æ»¤å±é™©ä»£ç 
   * @private
   */
  private filterDangerousCode(): void {
    // æ£€æµ‹å¹¶è¿‡æ»¤å±é™©çš„JavaScriptæ“ä½œ
    const dangerousPatterns = [
      /eval\s*\(/g,
      /new\s+Function\s*\(/g,
      /document\.write\s*\(/g,
      /window\.open\s*\(/g,
      /localStorage\s*\./g,
      /sessionStorage\s*\./g,
      /__proto__/g,
      /constructor\s*\(/g,
      /Object\.prototype/g,
      /Array\.prototype/g,
      /RegExp\.prototype/g,
      /Function\.prototype/g,
      /\.call\s*\(/g,
      /\.apply\s*\(/g,
      /\.bind\s*\(/g,
      /process\./g,
      /globalThis/g,
      /\$[\w_\$]+\(/g, // æ£€æµ‹å¯èƒ½çš„jQueryç­‰åº“è°ƒç”¨
      /require\s*\(/g,
      /import\s+(?:.*from\s+)?["']/g
    ];
    
    for (const pattern of dangerousPatterns) {
      if (pattern.test(this.scriptContent)) {
        Logger.warn(this.TAG, `Dangerous code pattern detected: ${pattern.toString()}`);
        // å¢å¼ºçš„å®‰å…¨æªæ–½ï¼šæŠ›å‡ºé”™è¯¯
        throw new Error(`Security violation: dangerous code pattern detected: ${pattern.toString()}`);
      }
    }
    
    // æ£€æŸ¥ä»£ç å¤æ‚åº¦ï¼Œé˜²æ­¢æ¶æ„å¾ªç?    const lineCount = this.scriptContent.split('\n').length;
    const braceCount = (this.scriptContent.match(/\{/g) || []).length;
    
    if (lineCount > 1000 || braceCount > 500) {
      throw new Error('Script too complex, potential security risk');
    }
  }

  /**
   * éªŒè¯å‚æ•°
   * @param params æ–¹æ³•å‚æ•°
   * @private
   */
  private validateParams(params: Record<string, string | number | boolean | null>): void {
    // æ£€æŸ¥å‚æ•°å¤§å°ï¼Œé˜²æ­¢è¿‡å¤§çš„å‚æ•°å¯¼è‡´å†…å­˜é—®é¢?    const paramsSize = JSON.stringify(params).length;
    if (paramsSize > 1024 * 1024) { // 1MBé™åˆ¶
      throw new Error('Parameters too large');
    }
    
    // æ£€æŸ¥å‚æ•°æ·±åº¦ï¼Œé˜²æ­¢æ·±å±‚åµŒå¥—å¯¹è±¡
    const maxDepth = 10;
    if (this.checkObjectDepth(params) > maxDepth) {
      throw new Error('Parameters too deeply nested');
    }
    
    // æ£€æŸ¥æ•°ç»„é•¿åº¦ï¼Œé˜²æ­¢è¿‡å¤§çš„æ•°ç»?    this.checkCollectionSize(params);
  }
  
  /**
   * æ£€æŸ¥å¯¹è±¡æ·±åº?   * @private
   */
  private checkObjectDepth(obj: Record<string, string | number | boolean | null>, currentDepth: number = 0): number {
    if (obj === null || typeof obj !== 'object') {
      return currentDepth;
    }
    
    const maxDepth = currentDepth;
    for (const key in obj) {
      if (Object.keys(obj).includes(key)) {
        const depth = this.checkObjectDepth(obj[key], currentDepth + 1);
        if (depth > maxDepth) {
          return depth;
        }
      }
    }
    
    return maxDepth;
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®
   * æ›¿ä»£Object.keysï¼Œå…¼å®¹ArkTSè¯­æ³•
   */
  private getObjectKeys<T extends object>(obj: T): string[] {
    const keys: string[] = [];
    for (const key in obj) {
      if (Object.keys(obj).includes(key)) {
        keys.push(key);
      }
    }
    return keys;
  }

  /**
   * æ£€æŸ¥é›†åˆå¤§å°?   * @private
   */
  private checkCollectionSize(obj: Record<string, string | number | boolean | null>): void {
    const maxArrayLength = 10000;
    
    if (Array.isArray(obj)) {
      if (obj.length > maxArrayLength) {
        throw new Error('Array too large');
      }
      
      // é€’å½’æ£€æŸ¥æ•°ç»„å…ƒç´?      for (const item of obj) {
        if (typeof item === 'object' && item !== null) {
          this.checkCollectionSize(item);
        }
      }
    } else if (typeof obj === 'object' && obj !== null) {
      const keys = this.getObjectKeys(obj);
      if (keys.length > 1000) {
        throw new Error('Object has too many properties');
      }
      
      // é€’å½’æ£€æŸ¥å¯¹è±¡å±æ€?      for (const key of keys) {
        this.checkCollectionSize(obj[key]);
      }
    }
  }
}


