import Logger from '../../common/util/Logger';
import { DeviceFlowStatus } from '../../data/bean/DeviceInfo';
import { configService } from '../config/ConfigService';
import { playerManager } from '../media/PlayerManager';
import TypeSafetyUtil from '../../common/util/TypeSafetyUtil';
import deviceManager from '@ohos.distributedHardware.deviceManager';
import BusinessError from '@ohos.base';

/**
 * è®¾å¤‡ä¿¡æ¯æ¥å£
 */
export interface DeviceInfo {
  deviceId: string;        // è®¾å¤‡ID
  deviceName: string;      // è®¾å¤‡åç§°
  deviceType: string;      // è®¾å¤‡ç±»å‹ï¼ˆæ‰‹æœºã€å¹³æ¿ã€ç”µè§†ç­‰ï¼?  status: 'online' | 'offline';  // è®¾å¤‡çŠ¶æ€?  capabilities: string[];  // è®¾å¤‡æ”¯æŒçš„èƒ½åŠ?  distance?: number;       // è·ç¦»ï¼ˆç”¨äºæ’åºï¼‰
}

/**
 * æµè½¬æ•°æ®æ¥å£
 */
export interface FlowData {
  mediaInfo?: {
    title?: string;
    url?: string;
    position?: number;
    duration?: number;
    coverUrl?: string;
  };
  screenInfo?: {
    width?: number;
    height?: number;
    dpi?: number;
  };
  audioInfo?: {
    title?: string;
    artist?: string;
    album?: string;
    url?: string;
    position?: number;
    duration?: number;
  };
  appState?: Record<string, string | number | boolean>;
}

/**
 * æµè½¬å‚æ•°æ¥å£
 */
export interface FlowParams {
  flowType: 'video' | 'audio' | 'screen' | 'data'; // æµè½¬ç±»å‹
  data?: FlowData;                               // æµè½¬æ•°æ®
  sourceDeviceId?: string;                       // æºè®¾å¤‡ID
  targetDeviceId: string;                        // ç›®æ ‡è®¾å¤‡ID
}

/**
 * è®¾å¤‡ç®¡ç†å™? */
class DeviceManager {
  private static readonly TAG: string = 'DeviceManager';
  private devices: Map<string, DeviceInfo> = new Map();
  private listeners: Array<(devices: DeviceInfo[]) => void> = [];
  private dmInstance: deviceManager.DeviceManager | null = null;
  private discoveryStarted: boolean = false;
  
  /**
   * åˆå§‹åŒ–è®¾å¤‡ç®¡ç†å™¨
   */
  public async initialize(): Promise<void> {
    try {
      Logger.info(DeviceManager.TAG, 'Initializing DeviceManager with HarmonyOS distributed device API...');
      
      // è·å–è®¾å¤‡ç®¡ç†å™¨å®ä¾?      this.dmInstance = await this.getDeviceManagerInstance();
      
      // è®¾ç½®è®¾å¤‡çŠ¶æ€å˜åŒ–ç›‘å?      this.setupDeviceStateListener();
      
      // å¼€å§‹è®¾å¤‡å‘ç?      await this.startDeviceDiscovery();
      
      Logger.info(DeviceManager.TAG, 'DeviceManager initialized successfully');
    } catch (error) {
      Logger.error(DeviceManager.TAG, `Failed to initialize DeviceManager: ${error}`);
      // å¦‚æœåˆ†å¸ƒå¼è®¾å¤‡APIå¤±è´¥ï¼Œå›é€€åˆ°åŸºæœ¬åŠŸèƒ?      await this.initializeFallback();
    }
  }
  
  /**
   * è·å–è®¾å¤‡ç®¡ç†å™¨å®ä¾?   */
  private async getDeviceManagerInstance(): Promise<deviceManager.DeviceManager> {
    return new Promise((resolve, reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject instanceof Error ? reject instanceof Error ? reject : new Error(String(reject : new Error(String(reject instanceof Error ? reject : new Error(String(reject))))))) => {
      try {
        deviceManager.createDeviceManager('RayTV', (error: BusinessError, dm: deviceManager.DeviceManager) => {
          if (error) {
            Logger.error(DeviceManager.TAG, `Failed to create device manager: ${error}`);
            reject(error);
            return;
          }
          Logger.info(DeviceManager.TAG, 'Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully' : new Error(String('Device manager created successfully' instanceof Error ? 'Device manager created successfully' : new Error(String('Device manager created successfully')))))));
          resolve(dm);
        });
      } catch (error) {
        Logger.error(DeviceManager.TAG, `Error creating device manager: ${error}`);
        reject(error);
      }
    });
  }
  
  /**
   * è®¾ç½®è®¾å¤‡çŠ¶æ€å˜åŒ–ç›‘å?   */
  private setupDeviceStateListener(): void {
    if (!this.dmInstance) return;
    
    try {
      this.dmInstance.on('deviceStateChange', (device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown> : new Error(String((device: Record<string, unknown> instanceof Error ? (device: Record<string, unknown> : new Error(String((device: Record<string, unknown>))))))) => {
        Logger.info(DeviceManager.TAG, `Device state changed: ${JSON.stringify(device)}`);
        this.handleDeviceStateChange(device);
      });
      
      this.dmInstance.on('deviceFound', (devices: Record<string, unknown>[]) => {
        Logger.info(DeviceManager.TAG, `Devices found: ${devices.length}`);
        this.handleDevicesFound(devices);
      });
    } catch (error) {
      Logger.error(DeviceManager.TAG, `Failed to setup device listeners: ${error}`);
    }
  }
  
  /**
   * å¼€å§‹è®¾å¤‡å‘ç?   */
  private async startDeviceDiscovery(): Promise<void> {
    if (!this.dmInstance || this.discoveryStarted) return;
    
    try {
      Logger.info(DeviceManager.TAG, 'Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...' : new Error(String('Starting device discovery...' instanceof Error ? 'Starting device discovery...' : new Error(String('Starting device discovery...')))))));
      
      // å‘å¸ƒæœ¬åœ°è®¾å¤‡ä¿¡æ¯
      this.dmInstance.publishDeviceDiscovery({});
      
      // å‘ç°å‘¨å›´è®¾å¤‡
      this.dmInstance.startDeviceDiscovery({});
      
      this.discoveryStarted = true;
      Logger.info(DeviceManager.TAG, 'Device discovery started');
      
      // è·å–å·²å‘ç°çš„å¯ä¿¡è®¾å¤‡
      const trustedDevices = this.dmInstance.getTrustedDeviceListSync();
      if (trustedDevices && trustedDevices.length > 0) {
        this.handleDevicesFound(trustedDevices);
      }
    } catch (error) {
      Logger.error(DeviceManager.TAG, `Failed to start device discovery: ${error}`);
      throw error;
    }
  }
  
  /**
   * è®¾å¤‡çŠ¶æ€å˜åŒ–æ¥å?   */
  interface DeviceStateChangeData {
    deviceId: string;
    status: number;
    
    // å¯èƒ½çš„é¢å¤–å­—æ®µï¼Œä½†ä½¿ç”¨å…·ä½“åç§°è€Œä¸æ˜¯ç´¢å¼•ç­¾å?    deviceName?: string;
    deviceTypeId?: number;
    networkId?: string;
    isLocal?: boolean;
    authType?: number;
    extraInfo?: Record<string, string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData instanceof Error ? string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData : new Error(String(string | number | boolean>;
  }

  /**
   * å¤„ç†è®¾å¤‡çŠ¶æ€å˜åŒ?   */
  private handleDeviceStateChange(device: DeviceStateChangeData))))))): void {
    if (!device || !device.deviceId) return;
    
    const deviceId = device.deviceId;
    const existingDevice = this.devices.get(deviceId);
    
    if (existingDevice) {
      // æ›´æ–°è®¾å¤‡çŠ¶æ€?      existingDevice.status = device.status === 0 ? 'online' : 'offline';
      this.notifyDeviceListChanged();
    }
  }
  
  /**
   * è®¾å¤‡å‘ç°æ¥å£
   */
  interface DiscoveredDevice {
    deviceId: string;
    deviceName?: string;
    deviceTypeId?: number;
    
    // å¯èƒ½çš„é¢å¤–å­—æ®µï¼Œä½†ä½¿ç”¨å…·ä½“åç§°è€Œä¸æ˜¯ç´¢å¼•ç­¾å?    networkId?: string;
    isLocal?: boolean;
    authType?: number;
    isTrusted?: boolean;
    extraInfo?: Record<string, string | number | boolean>;
  }

  /**
   * å¤„ç†å‘ç°çš„è®¾å¤?   */
  private handleDevicesFound(devices: DiscoveredDevice[]): void {
    if (!devices || devices.length === 0) return;
    
    Logger.info(DeviceManager.TAG, `Processing ${devices.length} discovered devices`);
    
    devices.forEach(device => {
      if (!device.deviceId) return;
      
      // è½¬æ¢ä¸ºæ ‡å‡†è®¾å¤‡ä¿¡æ¯æ ¼å¼?      const standardDevice: DeviceInfo = {
        deviceId: device.deviceId,
        deviceName: device.deviceName || `Device-${device.deviceId.substring(0, 8)}`,
        deviceType: this.getDeviceType(device),
        status: 'online',
        capabilities: this.getDeviceCapabilities(device)
      };
      
      this.devices.set(device.deviceId, standardDevice);
    });
    
    this.notifyDeviceListChanged();
  }
  
  /**
   * è·å–è®¾å¤‡ç±»å‹
   */
  private getDeviceType(device: DiscoveredDevice): string {
    // æ ¹æ®è®¾å¤‡ä¿¡æ¯åˆ¤æ–­ç±»å‹
    const deviceTypeId = device.deviceTypeId ?? 0;
    if (deviceTypeId === 2) return 'tv';
    if (deviceTypeId === 3) return 'tablet';
    if (deviceTypeId === 4) return 'phone';
    return 'unknown';
  }
  
  /**
   * è·å–è®¾å¤‡èƒ½åŠ›
   */
  private getDeviceCapabilities(device: DiscoveredDevice): string[] {
    const capabilities: string[] = ['data'];
    
    // æ ¹æ®è®¾å¤‡ç±»å‹æ·»åŠ é»˜è®¤èƒ½åŠ›
    if (this.getDeviceType(device) === 'tv' || this.getDeviceType(device) === 'tablet') {
      capabilities.push('video', 'audio', 'screen');
    } else if (this.getDeviceType(device) === 'phone') {
      capabilities.push('video', 'audio', 'screen');
    }
    
    return capabilities;
  }
  
  /**
   * å›é€€åˆå§‹åŒ–ï¼ˆå½“åˆ†å¸ƒå¼APIå¤±è´¥æ—¶ï¼‰
   */
  private async initializeFallback(): Promise<void> {
    Logger.warning(DeviceManager.TAG, 'Using fallback device manager implementation');
    
    // æ‰«æè®¾å¤‡ï¼ˆä½¿ç”¨ç®€åŒ–é€»è¾‘ï¼?    await this.scanDevices();
  }
  
  /**
   * æ‰«æè®¾å¤‡ï¼ˆå›é€€æ–¹æ³•ï¼?   */
  public async scanDevices(): Promise<void> {
    try {
      Logger.info(DeviceManager.TAG, 'Scanning for available devices...');
      
      // å¦‚æœæœ‰åˆ†å¸ƒå¼è®¾å¤‡ç®¡ç†å™¨å®ä¾‹ï¼Œä½¿ç”¨å®ƒè·å–è®¾å¤‡åˆ—è¡?      if (this.dmInstance) {
        const trustedDevices = this.dmInstance.getTrustedDeviceListSync();
        if (trustedDevices && trustedDevices.length > 0) {
          this.handleDevicesFound(trustedDevices);
          Logger.info(DeviceManager.TAG, `Found ${trustedDevices.length} trusted devices`);
          return;
        }
      }
      
      Logger.info(DeviceManager.TAG, 'No devices found or using fallback mode');
      
      // é€šçŸ¥ç›‘å¬å™¨ï¼ˆå¯èƒ½æ˜¯ç©ºåˆ—è¡¨ï¼?      this.notifyDeviceListChanged();
    } catch (error) {
      Logger.error(DeviceManager.TAG, `Failed to scan devices: ${error}`);
      throw error;
    }
  }
  
  /**
   * è·å–å¯ç”¨è®¾å¤‡åˆ—è¡¨
   */
  public getAvailableDevices(): DeviceInfo[] {
    return Array.from(this.devices.values()).filter(device => 
      device.status === 'online'
    );
  }
  
  /**
   * æ ¹æ®è®¾å¤‡IDè·å–è®¾å¤‡ä¿¡æ¯
   */
  public getDeviceById(deviceId: string): DeviceInfo | undefined {
    return this.devices.get(deviceId);
  }
  
  /**
   * æ·»åŠ è®¾å¤‡åˆ—è¡¨å˜åŒ–ç›‘å¬å™?   */
  public addDeviceListListener(listener: (devices: DeviceInfo[]) => void): void {
    this.listeners.push(listener);
  }
  
  /**
   * ç§»é™¤è®¾å¤‡åˆ—è¡¨å˜åŒ–ç›‘å¬å™?   */
  public removeDeviceListListener(listener: (devices: DeviceInfo[]) => void): void {
    const index = this.listeners.indexOf(listener);
    if (index > -1) {
      this.listeners.splice(index, 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1)))))));
    }
  }
  
  /**
   * é€šçŸ¥è®¾å¤‡åˆ—è¡¨å˜åŒ–
   */
  private notifyDeviceListChanged(): void {
    const devices = this.getAvailableDevices();
    this.listeners.forEach(listener => {
      try {
        listener(devices);
      } catch (error) {
        Logger.error(DeviceManager.TAG, `Error in device list listener: ${error}`);
      }
    });
  }
}

/**
 * è®¾å¤‡æµè½¬ç®¡ç†å™? */
export class DeviceFlowManager {
  private static readonly TAG: string = 'DeviceFlowManager';
  private static instance: DeviceFlowManager;
  
  private deviceManager: DeviceManager = new DeviceManager();
  private currentFlowStatus: DeviceFlowStatus | null = null;
  private isEnabled: boolean = false;
  private flowListeners: Array<(status: DeviceFlowStatus) => void> = [];
  
  private constructor() {}
  
  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): DeviceFlowManager {
    if (!DeviceFlowManager.instance) {
      DeviceFlowManager.instance = new DeviceFlowManager();
    }
    return DeviceFlowManager.instance;
  }
  
  /**
   * åˆå§‹åŒ–è®¾å¤‡æµè½¬ç®¡ç†å™¨
   */
  public async initialize(): Promise<void> {
    try {
      Logger.info(DeviceFlowManager.TAG, 'Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...' instanceof Error ? 'Initializing DeviceFlowManager...' : new Error(String('Initializing DeviceFlowManager...')))))));
      
      // åŠ è½½é…ç½®
      this.isEnabled = await configService.getConfig('enableDeviceFlow', true);
      
      // åˆå§‹åŒ–è®¾å¤‡ç®¡ç†å™¨
      await this.deviceManager.initialize();
      
      Logger.info(DeviceFlowManager.TAG, 'DeviceFlowManager initialized successfully');
    } catch (error) {
      Logger.error(DeviceFlowManager.TAG, `Failed to initialize DeviceFlowManager: ${error}`);
      throw error;
    }
  }
  
  /**
   * å¯åŠ¨è®¾å¤‡æµè½¬
   */
  public async startFlow(params: FlowParams): Promise<void> {
    try {
      if (!this.isEnabled) {
        throw new Error('Device flow is disabled');
      }
      
      Logger.info(DeviceFlowManager.TAG, `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` instanceof Error ? `Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}` : new Error(String(`Starting flow to device: ${params.targetDeviceId}, type: ${params.flowType}`)))))));
      
      // æ£€æŸ¥ç›®æ ‡è®¾å¤‡æ˜¯å¦å­˜åœ¨ä¸”åœ¨çº¿
      const targetDevice = this.deviceManager.getDeviceById(params.targetDeviceId);
      if (!targetDevice || targetDevice.status !== 'online') {
        throw new Error('Target device is not available');
      }
      
      // æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒè¯¥æµè½¬ç±»å‹
      if (!targetDevice.capabilities.includes(params.flowType)) {
        throw new Error(`Target device does not support ${params.flowType} flow`);
      }
      
      // æ›´æ–°æµè½¬çŠ¶æ€?      this.currentFlowStatus = {
        flowType: params.flowType,
        status: 'initiating',
        progress: 0,
        sourceDeviceId: params.sourceDeviceId,
        targetDeviceId: params.targetDeviceId
      };
      
      this.notifyFlowStatusChanged();
      
      // å¦‚æœæ˜¯è§†é¢‘æµè½¬ï¼Œä¿å­˜å½“å‰æ’­æ”¾çŠ¶æ€?      let flowData = params.data;
      if (params.flowType === 'video' && !flowData) {
        flowData = {
          currentMedia: playerManager.getCurrentMedia(),
          position: playerManager.getCurrentPosition(),
          playState: playerManager.isPlaying() ? 'playing' : 'paused'
        };
      }
      
      // å°è¯•ä½¿ç”¨åˆ†å¸ƒå¼æ•°æ®ä¼ è¾“API
      try {
        await this.performDistributedTransfer(params.targetDeviceId, flowData);
      } catch (distributedError) {
        Logger.warning(DeviceFlowManager.TAG, `Distributed transfer failed, using fallback: ${distributedError}`);
        // å¦‚æœåˆ†å¸ƒå¼ä¼ è¾“å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿè¿‡ç¨‹ä½œä¸ºå›é€€
        await this.simulateFlowProcess(params.flowType, params.targetDeviceId);
      }
      
      // æµè½¬å®Œæˆ
      this.currentFlowStatus.status = 'completed';
      this.currentFlowStatus.progress = 100;
      
      Logger.info(DeviceFlowManager.TAG, `Flow completed successfully`);
      this.notifyFlowStatusChanged();
    } catch (error) {
      Logger.error(DeviceFlowManager.TAG, `Failed to start flow: ${error}`);
      
      // æ›´æ–°ä¸ºå¤±è´¥çŠ¶æ€?      if (this.currentFlowStatus) {
        this.currentFlowStatus.status = 'failed';
        this.notifyFlowStatusChanged();
      }
      
      throw error;
    }
  }
  
  /**
   * æ‰§è¡Œåˆ†å¸ƒå¼æ•°æ®ä¼ è¾?   */
  private async performDistributedTransfer(targetDeviceId: string, data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown> : new Error(String(data: Record<string, unknown> instanceof Error ? data: Record<string, unknown> : new Error(String(data: Record<string, unknown>))))))): Promise<void> {
    try {
      Logger.info(DeviceFlowManager.TAG, `Performing distributed data transfer to ${targetDeviceId}`);
      
      // è¿™é‡Œå¯ä»¥å®ç°åŸºäºHarmonyOSåˆ†å¸ƒå¼æ•°æ®æœåŠ¡çš„ä¼ è¾“é€»è¾‘
      // ä¾‹å¦‚ä½¿ç”¨DeviceManagerçš„sendDataæ¥å£æˆ–åˆ†å¸ƒå¼æ–‡ä»¶æœåŠ¡
      
      // æ¨¡æ‹Ÿä¼ è¾“è¿›åº¦æ›´æ–°
      for (let progress = 10; progress < 100; progress += 20) {
        await new Promise(resolve => setTimeout(resolve, 300));
        if (this.currentFlowStatus) {
          this.currentFlowStatus.status = 'transferring';
          this.currentFlowStatus.progress = progress;
          this.notifyFlowStatusChanged();
        }
      }
      
      Logger.info(DeviceFlowManager.TAG, `Distributed transfer completed`);
    } catch (error) {
      Logger.error(DeviceFlowManager.TAG, `Distributed transfer failed: ${error}`);
      throw error;
    }
  }
  
  /**
   * åœæ­¢è®¾å¤‡æµè½¬
   */
  public async stopFlow(): Promise<void> {
    try {
      if (!this.currentFlowStatus || this.currentFlowStatus.status !== 'transferring') {
        throw new Error('No active flow to stop');
      }
      
      Logger.info(DeviceFlowManager.TAG, 'Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow' : new Error(String('Stopping current flow' instanceof Error ? 'Stopping current flow' : new Error(String('Stopping current flow')))))));
      
      this.currentFlowStatus.status = 'cancelled';
      this.notifyFlowStatusChanged();
      
      // æ¸…ç†èµ„æº
      this.currentFlowStatus = null;
    } catch (error) {
      Logger.error(DeviceFlowManager.TAG, `Failed to stop flow: ${error}`);
      throw error;
    }
  }
  
  /**
   * è·å–å¯ç”¨è®¾å¤‡åˆ—è¡¨
   */
  public getAvailableDevices(): DeviceInfo[] {
    return this.deviceManager.getAvailableDevices();
  }
  
  /**
   * åˆ·æ–°è®¾å¤‡åˆ—è¡¨
   */
  public async refreshDevices(): Promise<void> {
    await this.deviceManager.scanDevices();
  }
  
  /**
   * è·å–å½“å‰æµè½¬çŠ¶æ€?   */
  public getCurrentFlowStatus(): DeviceFlowStatus | null {
    return this.currentFlowStatus;
  }
  
  /**
   * å¯ç”¨/ç¦ç”¨è®¾å¤‡æµè½¬
   */
  public async setEnabled(enabled: boolean): Promise<void> {
    try {
      this.isEnabled = enabled;
      await configService.setConfig('enableDeviceFlow', enabled instanceof Error ? enabled : new Error(String(enabled instanceof Error ? enabled instanceof Error ? enabled : new Error(String(enabled : new Error(String(enabled instanceof Error ? enabled : new Error(String(enabled instanceof Error ? enabled instanceof Error ? enabled : new Error(String(enabled instanceof Error ? enabled instanceof Error ? enabled : new Error(String(enabled : new Error(String(enabled instanceof Error ? enabled : new Error(String(enabled : new Error(String(enabled instanceof Error ? enabled : new Error(String(enabled instanceof Error ? enabled instanceof Error ? enabled : new Error(String(enabled : new Error(String(enabled instanceof Error ? enabled : new Error(String(enabled)))))));
      
      Logger.info(DeviceFlowManager.TAG, `Device flow ${enabled ? 'enabled' : 'disabled'}`);
    } catch (error) {
      Logger.error(DeviceFlowManager.TAG, `Failed to set device flow enabled state: ${error}`);
      throw error;
    }
  }
  
  /**
   * æ·»åŠ æµè½¬çŠ¶æ€ç›‘å¬å™¨
   */
  public addFlowStatusListener(listener: (status: DeviceFlowStatus) => void): void {
    this.flowListeners.push(listener);
  }
  
  /**
   * ç§»é™¤æµè½¬çŠ¶æ€ç›‘å¬å™¨
   */
  public removeFlowStatusListener(listener: (status: DeviceFlowStatus) => void): void {
    const index = this.flowListeners.indexOf(listener);
    if (index > -1) {
      this.flowListeners.splice(index, 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1 instanceof Error ? 1 instanceof Error ? 1 : new Error(String(1 : new Error(String(1 instanceof Error ? 1 : new Error(String(1)))))));
    }
  }
  
  /**
   * é€šçŸ¥æµè½¬çŠ¶æ€å˜åŒ?   */
  private notifyFlowStatusChanged(): void {
    if (this.currentFlowStatus) {
      this.flowListeners.forEach(listener => {
        try {
          listener({ ...this.currentFlowStatus });
        } catch (error) {
          Logger.error(DeviceFlowManager.TAG, `Error in flow status listener: ${error}`);
        }
      });
    }
  }
  
  /**
   * æ¨¡æ‹Ÿæµè½¬è¿‡ç¨‹ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
   */
  private async simulateFlowProcess(flowType: string, targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string : new Error(String(targetDeviceId: string instanceof Error ? targetDeviceId: string : new Error(String(targetDeviceId: string))))))): Promise<void> {
    return new Promise((resolve) => {
      // æ¨¡æ‹Ÿ2ç§’çš„æµè½¬è¿‡ç¨‹
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        if (this.currentFlowStatus) {
          this.currentFlowStatus.status = 'transferring';
          this.currentFlowStatus.progress = progress;
          this.notifyFlowStatusChanged();
        }
        
        if (progress >= 100) {
          clearInterval(interval);
          resolve();
        }
      }, 200);
    });
  }
  
  /**
   * ä»æµè½¬å‚æ•°æ¢å¤åº”ç”¨çŠ¶æ€?   */
  public async restoreFromFlowParams(params: Record<string, unknown>): Promise<void> {
    try {
      Logger.info(DeviceFlowManager.TAG, 'Restoring application state from flow params');
      
      if (!params || !params.data) {
        Logger.warn(DeviceFlowManager.TAG, 'No valid flow params data found');
        return;
      }
      
      const flowData = params.data as Record<string, unknown>;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è§†é¢‘æ’­æ”¾çŠ¶æ€éœ€è¦æ¢å¤?      if (flowData.currentMedia && flowData.position !== undefined) {
        // æ¢å¤æ’­æ”¾çŠ¶æ€?        await playerManager.loadMedia(flowData.currentMedia);
        await playerManager.seekTo(flowData.position);
        
        if (flowData.playState === 'playing') {
          await playerManager.play();
        }
      }
    } catch (error) {
      Logger.error(DeviceFlowManager.TAG, `Failed to restore from flow params: ${error}`);
      throw error;
    }
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export function getDeviceFlowManager(): DeviceFlowManager {
  return DeviceFlowManager.getInstance();
}


