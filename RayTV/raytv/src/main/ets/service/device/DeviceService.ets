// DeviceService - è®¾å¤‡æœåŠ¡ç±?import Logger from '../../common/util/Logger';
import { DeviceInfo, DeviceType, DeviceCapability } from '../../data/bean/DeviceInfo';
import { DeviceInfoRepository } from '../../data/repository/DeviceInfoRepository';
import ConfigService from '../../service/config/ConfigService';
import TypeSafetyUtil from '../../common/util/TypeSafetyUtil';
import deviceInfo from '@ohos.deviceInfo';
import i18n from '@ohos.i18n';
import connection from '@ohos.net.connection';
import display from '@ohos.display';

const TAG = 'DeviceService';

// è®¾å¤‡åŠŸèƒ½æ£€æµ‹è¯¦æƒ…æ¥å?export interface CapabilityDetails {
  capabilityType?: string;
  version?: string;
  maxValue?: number;
  minValue?: number;
  supportedFormats?: string[];
  properties?: Record<string, string | number | boolean>;
}

// è®¾å¤‡åŠŸèƒ½æ£€æµ‹ç»“æ?export interface CapabilityCheckResult {
  supported: boolean;
  details?: CapabilityDetails;
  error?: string;
}

export default class DeviceService {
  private static instance: DeviceService;
  private deviceInfoRepository: DeviceInfoRepository;
  private configService: ConfigService;
  private cachedDeviceInfo: DeviceInfo | null = null;
  private deviceListeners: Array<(info: DeviceInfo) => void> = [];
  private isInitialized: boolean = false;
  private lastCapabilityCheckTime: number = 0;

  private constructor() {
    this.deviceInfoRepository = DeviceInfoRepository.getInstance();
    this.configService = ConfigService.getInstance();
    this.initialize();
  }

  public static getInstance(): DeviceService {
    if (!DeviceService.instance) {
      DeviceService.instance = new DeviceService();
    }
    return DeviceService.instance;
  }

  /**
   * åˆå§‹åŒ–è®¾å¤‡æœåŠ?   */
  public async initialize(): Promise<void> {
    try {
      // åŠ è½½è®¾å¤‡ä¿¡æ¯
      this.cachedDeviceInfo = await this.deviceInfoRepository.getDeviceInfo();
      
      // å¦‚æœæ²¡æœ‰è®¾å¤‡ä¿¡æ¯ï¼Œæ”¶é›†å¹¶ä¿å­˜
      if (!this.cachedDeviceInfo) {
        this.cachedDeviceInfo = await this.collectDeviceInfo();
        await this.deviceInfoRepository.saveDeviceInfo(this.cachedDeviceInfo);
      }
      
      // å®šæœŸæ›´æ–°è®¾å¤‡ä¿¡æ¯
      this.scheduleDeviceInfoUpdate();
      
      this.isInitialized = true;
      Logger.info(TAG, 'Device service initialized');
    } catch (error) {
      Logger.error(TAG, 'Failed to initialize device service', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      // åˆ›å»ºåŸºæœ¬çš„è®¾å¤‡ä¿¡æ¯ä½œä¸ºåå¤?      this.cachedDeviceInfo = this.createDefaultDeviceInfo();
      this.isInitialized = true;
    }
  }

  /**
   * æ”¶é›†è®¾å¤‡ä¿¡æ¯
   */
  private async collectDeviceInfo(): Promise<DeviceInfo> {
    Logger.info(TAG, 'Collecting device information');
    
    try {
      // è®¾å¤‡æ ‡è¯†
      const deviceId = await this.generateDeviceId();
      
      // è®¾å¤‡åŸºæœ¬ä¿¡æ¯
      const deviceInfo: DeviceInfo = {
        deviceId,
        deviceName: this.getDeviceName(),
        deviceType: this.detectDeviceType(),
        manufacturer: this.getManufacturer(),
        model: this.getModel(),
        osVersion: this.getOSVersion(),
        appVersion: this.getAppVersion(),
        screenResolution: this.getScreenResolution(),
        deviceLanguage: this.getDeviceLanguage(),
        timezone: this.getTimezone(),
        capabilities: await this.detectDeviceCapabilities(),
        lastActiveTime: Date.now(),
        firstActiveTime: Date.now(),
        usageCount: 1,
        storageInfo: await this.getStorageInfo(),
        memoryInfo: await this.getMemoryInfo(),
        networkInfo: await this.getNetworkInfo(),
        audioDevices: await this.getAudioDevices(),
        videoOutputs: await this.getVideoOutputs(),
        systemProperties: this.getSystemProperties(),
        customProperties: {}
      };
      
      Logger.info(TAG, 'Device information collected: ' + deviceInfo.deviceName + ' (' + deviceInfo.deviceType + ')');
      return deviceInfo;
    } catch (error) {
      Logger.error(TAG, 'Error collecting device information: ' + (error instanceof Error ? error.message : String(error)));
      return this.createDefaultDeviceInfo();
    }
  }

  /**
   * åˆ›å»ºé»˜è®¤è®¾å¤‡ä¿¡æ¯
   */
  private createDefaultDeviceInfo(): DeviceInfo {
    return {
      deviceId: 'unknown-device-' + Date.now(), deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( instanceof Error ? deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now( : new Error(String(deviceName: 'Unknown Device',
      deviceType: DeviceType.UNKNOWN,
      manufacturer: 'Unknown',
      model: 'Unknown',
      osVersion: 'Unknown',
      appVersion: '1.0.0',
      screenResolution: { width: 1920, height: 1080 },
      deviceLanguage: 'zh-CN',
      timezone: 'Asia/Shanghai',
      capabilities: [],
      lastActiveTime: Date.now())))))),
      firstActiveTime: Date.now(),
      usageCount: 1,
      storageInfo: { total: 0, available: 0 },
      memoryInfo: { total: 0, available: 0 },
      networkInfo: { type: 'unknown', isConnected: false },
      audioDevices: [],
      videoOutputs: [],
      systemProperties: {},
      customProperties: {}
    };
  }

  /**
   * ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†
   */
  private async generateDeviceId(): Promise<string> {
    try {
      // å°è¯•ä»å­˜å‚¨è·å–å·²æœ‰ID
      const existingId = await this.deviceInfoRepository.getDeviceId();
      if (existingId) {
        return existingId;
      }
      
      // ç”Ÿæˆæ–°çš„è®¾å¤‡IDï¼ˆç®€åŒ–å®ç°ï¼‰
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      const deviceId = `device-${timestamp}-${random}`;
      
      // ä¿å­˜è®¾å¤‡ID
      await this.deviceInfoRepository.saveDeviceId(deviceId);
      return deviceId;
    } catch (error) {
      Logger.error(TAG, 'Failed to generate device ID', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return 'fallback-device-' + Date.now();
    }
  }

  /**
   * æ£€æµ‹è®¾å¤‡ç±»å?   */
  private detectDeviceType(): DeviceType {
    // ä½¿ç”¨HarmonyOSè®¾å¤‡ä¿¡æ¯APIæ£€æµ‹è®¾å¤‡ç±»å?    try {
      // æ ¹æ®productModelæˆ–deviceTypeåˆ¤æ–­è®¾å¤‡ç±»å‹
      // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ç”¨ä¸­å¯æ ¹æ®å…·ä½“çš„è®¾å¤‡æ ‡è¯†è¿›è¡Œæ›´ç²¾ç¡®åˆ¤æ–­
      const deviceModel = deviceInfo.productModel.toLowerCase();
      
      // å¸¸è§ç”µè§†è®¾å¤‡æ ‡è¯†å…³é”®è¯?      const tvKeywords = ['smarttv', 'tizen', 'webos', 'tv', 'smart-tv'];
      // å¸¸è§å¹³æ¿è®¾å¤‡æ ‡è¯†å…³é”®è¯?      const tabletKeywords = ['tablet', 'pad', 'tab'];
      // å¸¸è§ç§»åŠ¨è®¾å¤‡æ ‡è¯†å…³é”®è¯?      const mobileKeywords = ['phone', 'mobile', 'cell'];
      
      if (tvKeywords.some(keyword => deviceModel.includes(keyword))) {
        return DeviceType.TV;
      }
      if (tabletKeywords.some(keyword => deviceModel.includes(keyword))) {
        return DeviceType.TABLET;
      }
      if (mobileKeywords.some(keyword => deviceModel.includes(keyword))) {
        return DeviceType.PHONE;
      }
      
      // é»˜è®¤è¿”å›TVç±»å‹ï¼Œå› ä¸ºè¿™æ˜¯TVåº”ç”¨
      return DeviceType.TV;
    } catch (error) {
      Logger.error(TAG, 'Failed to detect device type', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return DeviceType.TV;
    }
  }

  /**
   * è·å–è®¾å¤‡åç§°
   */
  private getDeviceName(): string {
    try {
      // ä½¿ç”¨HarmonyOSè®¾å¤‡ä¿¡æ¯APIè·å–è®¾å¤‡åç§°
      return `${deviceInfo.manufacture} ${deviceInfo.productModel}` || 'RayTV Device';
    } catch (error) {
      Logger.error(TAG, 'Failed to get device name', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return 'RayTV Device';
    }
  }

  /**
   * è·å–åˆ¶é€ å•†ä¿¡æ¯
   */
  private getManufacturer(): string {
    try {
      // ä½¿ç”¨HarmonyOSè®¾å¤‡ä¿¡æ¯APIè·å–åˆ¶é€ å•†
      return deviceInfo.manufacture || 'Unknown Manufacturer';
    } catch (error) {
      Logger.error(TAG, 'Failed to get manufacturer', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return 'Unknown';
    }
  }

  /**
   * è·å–è®¾å¤‡å‹å·
   */
  private getModel(): string {
    try {
      // ä½¿ç”¨HarmonyOSè®¾å¤‡ä¿¡æ¯APIè·å–è®¾å¤‡å‹å·
      return deviceInfo.productModel || 'Unknown Model';
    } catch (error) {
      Logger.error(TAG, 'Failed to get device model', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return 'Unknown';
    }
  }

  /**
   * è·å–æ“ä½œç³»ç»Ÿç‰ˆæœ¬
   */
  private getOSVersion(): string {
    try {
      // ä½¿ç”¨HarmonyOSè®¾å¤‡ä¿¡æ¯APIè·å–ç³»ç»Ÿç‰ˆæœ¬
      return deviceInfo.osFullName || deviceInfo.sdkApiVersion.toString() || 'Unknown';
    } catch (error) {
      Logger.error(TAG, 'Failed to get OS version', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return 'Unknown';
    }
  }

  /**
   * è·å–åº”ç”¨ç‰ˆæœ¬
   */
  private getAppVersion(): string {
    try {
      // å®é™…åº”ç”¨ä¸­ä»é…ç½®æˆ–æ¸…å•æ–‡ä»¶è·å?      return '1.0.0';
    } catch {
      return '1.0.0';
    }
  }

  /**
   * è·å–å±å¹•åˆ†è¾¨ç?   */
  private getScreenResolution(): { width: number; height: number } {
    try {
      // ä½¿ç”¨HarmonyOS display APIè·å–å±å¹•åˆ†è¾¨ç?      const displays = display.getAllDisplays();
      if (displays && displays.length > 0) {
        const defaultDisplay = displays[0];
        return {
          width: defaultDisplay.width,
          height: defaultDisplay.height
        };
      }
      return { width: 1920, height: 1080 };
    } catch (error) {
      Logger.error(TAG, 'Failed to get screen resolution', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return { width: 1920, height: 1080 };
    }
  }

  /**
   * è·å–è®¾å¤‡è¯­è¨€
   */
  private getDeviceLanguage(): string {
    try {
      // ä½¿ç”¨HarmonyOS i18næ¨¡å—è·å–è®¾å¤‡è¯­è¨€
      return i18n.System.getSystemLanguageSync() || 'zh-CN';
    } catch (error) {
      Logger.error(TAG, 'Failed to get device language', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return 'zh-CN';
    }
  }

  /**
   * è·å–æ—¶åŒº
   */
  private getTimezone(): string {
    try {
      return Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Shanghai';
    } catch {
      return 'Asia/Shanghai';
    }
  }

  /**
   * æ£€æµ‹è®¾å¤‡èƒ½åŠ?   */
  private async detectDeviceCapabilities(): Promise<DeviceCapability[]> {
    const capabilities: DeviceCapability[] = [];
    
    // éŸ³é¢‘èƒ½åŠ›
    if (await this.checkAudioCapability()) {
      capabilities.push(DeviceCapability.AUDIO_OUTPUT);
    }
    
    // è§†é¢‘èƒ½åŠ›
    if (await this.checkVideoCapability()) {
      capabilities.push(DeviceCapability.VIDEO_PLAYBACK);
    }
    
    // ç½‘ç»œèƒ½åŠ›
    capabilities.push(DeviceCapability.WIFI_DIRECT);
    
    // å­˜å‚¨èƒ½åŠ›
    capabilities.push(DeviceCapability.FILE_SHARING);
    
    // è§¦æ‘¸èƒ½åŠ›æ£€æµ?    if (await this.checkTouchCapability()) {
      capabilities.push(DeviceCapability.TOUCH_SCREEN);
    }
    
    // é”®ç›˜èƒ½åŠ›æ£€æµ?    if (await this.checkKeyboardCapability()) {
      capabilities.push(DeviceCapability.KEYBOARD_INPUT);
    }
    
    // é¥æ§å™¨èƒ½åŠ›æ£€æµ?    capabilities.push(DeviceCapability.REMOTE_CONTROL);
    
    // ç¡¬ä»¶è§£ç èƒ½åŠ›æ£€æµ?    if (await this.checkHardwareDecoding()) {
      capabilities.push(DeviceCapability.HIGHER_RESOLUTION);
    }
    
    // HDRèƒ½åŠ›æ£€æµ?    if (await this.checkHDRCapability()) {
      capabilities.push(DeviceCapability.HDR_SUPPORT);
    }
    
    return capabilities;
  }

  /**
   * æ£€æŸ¥éŸ³é¢‘èƒ½åŠ?   */
  private async checkAudioCapability(): Promise<boolean> {
    try {
      // ç®€åŒ–å®ç?      return true;
    } catch {
      return false;
    }
  }

  /**
   * æ£€æŸ¥è§†é¢‘èƒ½åŠ?   */
  private async checkVideoCapability(): Promise<boolean> {
    try {
      // ç®€åŒ–å®ç?      return true;
    } catch {
      return false;
    }
  }

  /**
   * æ£€æŸ¥è§¦æ‘¸èƒ½åŠ?   */
  private async checkTouchCapability(): Promise<boolean> {
    try {
      // HarmonyOSè®¾å¤‡é€šå¸¸æ”¯æŒè§¦æ‘¸ï¼Œè¿™é‡Œç®€åŒ–å¤„ç?      // å®é™…åº”ç”¨ä¸­å¯ä»¥é€šè¿‡å¤šæ¨¡æ€è¾“å…¥APIè¿›è¡Œæ›´ç²¾ç¡®çš„æ£€æµ?      return true;
    } catch (error) {
      Logger.error(TAG, 'Failed to check touch capability', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return false;
    }
  }

  /**
   * æ£€æŸ¥é”®ç›˜èƒ½åŠ?   */
  private async checkKeyboardCapability(): Promise<boolean> {
    try {
      // ç®€åŒ–å®ç?      return true;
    } catch {
      return false;
    }
  }

  /**
   * æ£€æŸ¥ç¡¬ä»¶è§£ç èƒ½åŠ?   */
  private async checkHardwareDecoding(): Promise<boolean> {
    try {
      // ç®€åŒ–å®ç?      return true;
    } catch {
      return false;
    }
  }

  /**
   * æ£€æŸ¥HDRèƒ½åŠ›
   */
  private async checkHDRCapability(): Promise<boolean> {
    try {
      // ç®€åŒ–å®ç?      return false;
    } catch {
      return false;
    }
  }

  /**
   * è·å–å­˜å‚¨ä¿¡æ¯
   */
  private async getStorageInfo(): Promise<{ total: number; available: number }> {
    try {
      // ç®€åŒ–å®ç?      return { total: 0, available: 0 };
    } catch {
      return { total: 0, available: 0 };
    }
  }

  /**
   * è·å–å†…å­˜ä¿¡æ¯
   */
  private async getMemoryInfo(): Promise<{ total: number; available: number }> {
    try {
      // ç®€åŒ–å®ç?      return { total: 0, available: 0 };
    } catch {
      return { total: 0, available: 0 };
    }
  }

  /**
   * è·å–ç½‘ç»œä¿¡æ¯
   */
  private async getNetworkInfo(): Promise<{ type: string; isConnected: boolean }> {
    try {
      // ä½¿ç”¨HarmonyOSç½‘ç»œè¿æ¥APIè·å–ç½‘ç»œä¿¡æ¯
      const netInfo = connection.getDefaultNetSync();
      if (netInfo) {
        const netCapabilities = connection.getNetCapabilitiesSync(netInfo);
        const bearerTypes = netCapabilities.bearerTypes || [];
        
        // å°†ç½‘ç»œç±»å‹è½¬æ¢ä¸ºå¯è¯»å­—ç¬¦ä¸?        let typeStr = 'unknown';
        if (bearerTypes.includes(connection.NetBearType.WIFI)) {
          typeStr = 'wifi';
        } else if (bearerTypes.includes(connection.NetBearType.CELLULAR)) {
          typeStr = 'cellular';
        } else if (bearerTypes.includes(connection.NetBearType.ETHERNET)) {
          typeStr = 'ethernet';
        }
        
        return {
          type: typeStr,
          isConnected: true
        };
      }
      return { type: 'unknown', isConnected: false };
    } catch (error) {
      Logger.error(TAG, 'Failed to get network info', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return { type: 'unknown', isConnected: false };
    }
  }

  /**
   * è·å–éŸ³é¢‘è®¾å¤‡
   */
  private async getAudioDevices(): Promise<Array<{ id: string; name: string; type: string }>> {
    try {
      // ç®€åŒ–å®ç?      return [];
    } catch {
      return [];
    }
  }

  /**
   * è·å–è§†é¢‘è¾“å‡º
   */
  private async getVideoOutputs(): Promise<Array<{ id: string; name: string; resolution: string }>> {
    try {
      // ç®€åŒ–å®ç?      return [];
    } catch {
      return [];
    }
  }

  /**
   * è·å–ç³»ç»Ÿå±æ€?   */
  private getSystemProperties(): Record<string, string> {
    const properties: Record<string, string> = {};
    
    try {
      // ä½¿ç”¨HarmonyOSè®¾å¤‡ä¿¡æ¯APIè·å–ç³»ç»Ÿå±æ€?      properties.manufacturer = deviceInfo.manufacture || '';
      properties.model = deviceInfo.productModel || '';
      properties.osFullName = deviceInfo.osFullName || '';
      properties.apiVersion = deviceInfo.sdkApiVersion.toString() || '';
      properties.deviceType = deviceInfo.deviceType || '';
      properties.language = i18n.System.getSystemLanguageSync() || '';
    } catch (error) {
      Logger.error(TAG, 'Error getting system properties', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
    }
    
    return properties;
  }

  /**
   * è®¡åˆ’è®¾å¤‡ä¿¡æ¯æ›´æ–°
   */
  private scheduleDeviceInfoUpdate(): void {
    // æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡è®¾å¤‡ä¿¡æ?    setInterval(async () => {
      try {
        await this.updateDeviceInfo();
      } catch (error) {
        Logger.error(TAG, 'Failed to update device info scheduled', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      }
    }, 3600000);
  }

  /**
   * æ›´æ–°è®¾å¤‡ä¿¡æ¯
   */
  public async updateDeviceInfo(): Promise<DeviceInfo> {
    try {
      if (!this.cachedDeviceInfo) {
        this.cachedDeviceInfo = await this.collectDeviceInfo();
      } else {
        // æ›´æ–°è®¾å¤‡ä¿¡æ¯
        this.cachedDeviceInfo.lastActiveTime = Date.now();
        this.cachedDeviceInfo.usageCount += 1;
        this.cachedDeviceInfo.screenResolution = this.getScreenResolution();
        this.cachedDeviceInfo.deviceLanguage = this.getDeviceLanguage();
        this.cachedDeviceInfo.networkInfo = await this.getNetworkInfo();
        
        // å®šæœŸé‡æ–°æ£€æµ‹èƒ½åŠ›ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
        const now = Date.now();
        if (now - this.lastCapabilityCheckTime > 86400000) {
          this.cachedDeviceInfo.capabilities = await this.detectDeviceCapabilities();
          this.lastCapabilityCheckTime = now;
        }
      }
      
      // ä¿å­˜æ›´æ–°åçš„ä¿¡æ¯
      await this.deviceInfoRepository.saveDeviceInfo(this.cachedDeviceInfo);
      
      // é€šçŸ¥ç›‘å¬å™?      this.notifyDeviceInfoChanged();
      
      return this.cachedDeviceInfo;
    } catch (error) {
      Logger.error(TAG, 'Failed to update device information', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      throw error;
    }
  }

  /**
   * è·å–è®¾å¤‡ä¿¡æ¯
   */
  public async getDeviceInfo(): Promise<DeviceInfo> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    // æ›´æ–°æ´»è·ƒæ—¶é—´
    await this.updateDeviceInfo();
    
    return this.cachedDeviceInfo as DeviceInfo;
  }

  /**
   * è·å–è®¾å¤‡ID
   */
  public async getDeviceId(): Promise<string> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    return (this.cachedDeviceInfo as DeviceInfo).deviceId;
  }

  /**
   * æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒç‰¹å®šèƒ½åŠ?   */
  public async hasCapability(capability: DeviceCapability): Promise<boolean> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    return (this.cachedDeviceInfo as DeviceInfo).capabilities.includes(capability);
  }

  /**
   * è·å–è®¾å¤‡èƒ½åŠ›åˆ—è¡¨
   */
  public async getDeviceCapabilities(): Promise<DeviceCapability[]> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    return [...(this.cachedDeviceInfo as DeviceInfo).capabilities];
  }

  /**
   * è®¾ç½®è‡ªå®šä¹‰è®¾å¤‡å±æ€?   */
  public async setCustomProperty<T extends string | number | boolean | object>(key: string, value: T): Promise<void> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    if (this.cachedDeviceInfo) {
      // ä½¿ç”¨ç±»å‹å®‰å…¨çš„æ–¹å¼å­˜å‚¨è‡ªå®šä¹‰å±æ€?      this.cachedDeviceInfo.customProperties[key] = TypeSafetyUtil.safeStringify(value);
      await this.deviceInfoRepository.saveDeviceInfo(this.cachedDeviceInfo);
      this.notifyDeviceInfoChanged();
    }
  }

  /**
   * è·å–è‡ªå®šä¹‰è®¾å¤‡å±æ€?   */
  public async getCustomProperty<T>(key: string, defaultValue?: T): Promise<T | undefined> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    if (this.cachedDeviceInfo) {
      return (this.cachedDeviceInfo.customProperties[key] as T) || defaultValue;
    }
    
    return defaultValue;
  }

  /**
   * æ³¨å†Œè®¾å¤‡ä¿¡æ¯å˜æ›´ç›‘å¬å™?   */
  public addDeviceInfoListener(listener: (info: DeviceInfo) => void): void {
    this.deviceListeners.push(listener);
  }

  /**
   * ç§»é™¤è®¾å¤‡ä¿¡æ¯å˜æ›´ç›‘å¬å™?   */
  public removeDeviceInfoListener(listener: (info: DeviceInfo) => void): void {
    this.deviceListeners = this.deviceListeners.filter(l => l !== listener);
  }

  /**
   * é€šçŸ¥è®¾å¤‡ä¿¡æ¯å˜æ›´
   */
  private notifyDeviceInfoChanged(): void {
    if (!this.cachedDeviceInfo) return;
    
    const infoCopy: Record<string, string | number | boolean | null> = { ... };
    this.deviceListeners.forEach(listener => {
      try {
        listener(infoCopy);
      } catch (error) {
        Logger.error(TAG, 'Error in device info listener', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      }
    });
  }

  /**
   * æ£€æŸ¥è®¾å¤‡å­˜å‚¨ç©ºé—´æ˜¯å¦å……è¶?   */
  public async isStorageSufficient(minRequiredMB: number): Promise<boolean> {
    try {
      const storageInfo = await this.getStorageInfo();
      // å°†å­—èŠ‚è½¬æ¢ä¸ºMB
      const availableMB = storageInfo.available / (1024 * 1024);
      return availableMB >= minRequiredMB;
    } catch (error) {
      Logger.error(TAG, 'Failed to check storage', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error  as Error)));
      return false;
    }
  }

  /**
   * è·å–è®¾å¤‡ä½¿ç”¨ç»Ÿè®¡
   */
  public async getUsageStats(): Promise<{ usageCount: number; firstUsed: number; lastUsed: number }> {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    const deviceInfo = this.cachedDeviceInfo as DeviceInfo;
    return {
      usageCount: deviceInfo.usageCount,
      firstUsed: deviceInfo.firstActiveTime,
      lastUsed: deviceInfo.lastActiveTime
    };
  }
}


