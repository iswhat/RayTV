// DeviceManager.ets - è®¾å¤‡ç®¡ç†æœåŠ¡
// åŸºäºHarmonyOS DeviceManager APIå®ç°è®¾å¤‡ç®¡ç†åŠŸèƒ½

import Logger from '../../common/util/Logger';
import deviceManager from '@ohos.distributedHardware.deviceManager';
import BusinessError from '@ohos.base';
import ConfigService from '../../service/config/ConfigService';
import ModernDistributedDataService from '../sync/ModernDistributedDataService';

// å¸¸é‡å®šä¹‰
const TAG = 'DeviceManager';
const PKG_NAME = 'com.raytv';

// è®¾å¤‡ç±»å‹æšä¸¾
export enum DeviceType {
  PHONE = 'phone',
  TABLET = 'tablet',
  TV = 'tv',
  CAR = 'car',
  WEARABLE = 'wearable',
  SMART_VISION = 'smart_vision',
  OTHER = 'other'
}

// è®¾å¤‡çŠ¶æ€æšä¸?
export enum DeviceStatus {
  ONLINE = 'online',
  OFFLINE = 'offline',
  CONNECTING = 'connecting',
  DISCONNECTING = 'disconnecting',
  UNAUTHORIZED = 'unauthorized'
}

// è®¾å¤‡è®¤è¯çŠ¶æ€æšä¸?
export enum AuthStatus {
  UNKNOWN = 'unknown',
  UNAUTHENTICATED = 'unauthenticated',
  AUTHENTICATING = 'authenticating',
  AUTHENTICATED = 'authenticated',
  AUTHENTICATION_FAILED = 'authentication_failed'
}

// åŸå§‹è®¾å¤‡ä¿¡æ¯æ¥å£ï¼ˆæ¥è‡ªç³»ç»ŸAPIï¼?
interface RawDeviceInfo {
  deviceId: string;          // è®¾å¤‡å”¯ä¸€æ ‡è¯†
  deviceName: string;        // è®¾å¤‡åç§°
  deviceType: number;        // è®¾å¤‡ç±»å‹ç¼–å·
  networkId?: string;        // ç½‘ç»œID
  ip?: string;               // IPåœ°å€
  mac?: string;              // MACåœ°å€
  version?: string;          // ç‰ˆæœ¬ä¿¡æ¯
}

// è®¾å¤‡ä¿¡æ¯æ¥å£
export interface DeviceInfo {
  deviceId: string;          // è®¾å¤‡å”¯ä¸€æ ‡è¯†
  deviceName: string;        // è®¾å¤‡åç§°
  deviceType: DeviceType;    // è®¾å¤‡ç±»å‹
  networkId?: string;        // ç½‘ç»œID
  ip?: string;               // IPåœ°å€
  mac?: string;              // MACåœ°å€
  version?: string;          // ç‰ˆæœ¬ä¿¡æ¯
  status: DeviceStatus;      // è®¾å¤‡çŠ¶æ€?
  authStatus: AuthStatus;    // è®¤è¯çŠ¶æ€?
  isLocalDevice: boolean;    // æ˜¯å¦ä¸ºæœ¬æœ?
  batteryLevel?: number;     // ç”µæ± ç”µé‡ï¼?-100ï¼?
  screenOn?: boolean;        // å±å¹•æ˜¯å¦ç‚¹äº®
  connectedTime?: number;    // è¿æ¥æ—¶é—´
  lastActiveTime?: number;   // æœ€åæ´»è·ƒæ—¶é—?
  deviceLabel?: string;      // è‡ªå®šä¹‰æ ‡ç­?
}

// åŒæ­¥æ•°æ®æ¥å£ - æ”¯æŒå…·ä½“æ•°æ®ç±»å‹
export interface SyncData<T = any> {
  deviceId: string;          // ç›®æ ‡è®¾å¤‡ID
  dataType: string;          // æ•°æ®ç±»å‹
  data: T;                   // è¦åŒæ­¥çš„æ•°æ®
}

// æ’­æ”¾æ§åˆ¶å‚æ•°æ¥å£
export interface PlaybackControlParams {
  position?: number;         // æ’­æ”¾ä½ç½®
  speed?: number;            // æ’­æ”¾é€Ÿåº¦
  volume?: number;           // éŸ³é‡
  // é¿å…ä½¿ç”¨anyç±»å‹ï¼Œå®šä¹‰å…·ä½“çš„å¯èƒ½å‚æ•°
  paused?: boolean;
  muted?: boolean;
  quality?: string;
  subtitles?: boolean;
}

// è®¾å¤‡é€‰æ‹©æ¡ä»¶æ¥å£
export interface DeviceFilter {
  deviceTypes?: DeviceType[];     // è®¾å¤‡ç±»å‹è¿‡æ»¤
  onlineOnly?: boolean;           // ä»…åœ¨çº¿è®¾å¤?
  authenticatedOnly?: boolean;    // ä»…å·²è®¤è¯è®¾å¤‡
  nameKeyword?: string;           // è®¾å¤‡åç§°å…³é”®å­?
}

// è®¾å¤‡ç®¡ç†é…ç½®æ¥å£
export interface DeviceManagerConfig {
  enableAutoConnect: boolean;     // å¯ç”¨è‡ªåŠ¨è¿æ¥
  enableDeviceDiscovery: boolean; // å¯ç”¨è®¾å¤‡å‘ç°
  requireAuthentication: boolean; // éœ€è¦è®¤è¯?
  autoAuthorizeDevices: boolean;  // è‡ªåŠ¨æˆæƒè®¾å¤‡
  rememberAuthorizedDevices: boolean; // è®°ä½å·²æˆæƒè®¾å¤?
}

// é»˜è®¤è®¾å¤‡ç®¡ç†é…ç½®
export const DEFAULT_DEVICE_MANAGER_CONFIG: DeviceManagerConfig = {
  enableAutoConnect: true,
  enableDeviceDiscovery: true,
  requireAuthentication: true,
  autoAuthorizeDevices: false,
  rememberAuthorizedDevices: true
};

// è®¾å¤‡å˜æ›´äº‹ä»¶ç±»å‹
export enum DeviceEvent {
  DEVICE_ONLINE = 'device_online',
  DEVICE_OFFLINE = 'device_offline',
  DEVICE_CHANGED = 'device_changed',
  AUTH_STATE_CHANGED = 'auth_state_changed',
  DEVICE_CONNECTED = 'device_connected',
  DEVICE_DISCONNECTED = 'device_disconnected'
}

// è®¾å¤‡äº‹ä»¶ç›‘å¬å›è°ƒç±»å‹
type DeviceEventListener = (event: DeviceEvent, deviceInfo: DeviceInfo) => void;

export default class DeviceManager {
  private static instance: DeviceManager;
  private deviceManagerInstance: deviceManager.DeviceManager | null = null;
  private configService: ConfigService;
  private distributedDataService: DistributedDataService;
  private config: DeviceManagerConfig = DEFAULT_DEVICE_MANAGER_CONFIG;
  private devices: Map<string, DeviceInfo> = new Map();
  private eventListeners: Map<DeviceEvent, DeviceEventListener[]> = new Map();
  private authorizedDevices: Set<string> = new Set();
  private isInitialized: boolean = false;
  private authCallbackId: number | null = null;
  private deviceStateCallbackId: number | null = null;

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): DeviceManager {
    if (!DeviceManager.instance) {
      DeviceManager.instance = new DeviceManager();
    }
    return DeviceManager.instance;
  }

  /**
   * æ„é€ å‡½æ•?
   */
  private constructor() {
    this.configService = ConfigService.getInstance();
    this.distributedDataService = ModernDistributedDataService.getInstance();
  }

  /**
   * åˆå§‹åŒ–è®¾å¤‡ç®¡ç†å™¨
   * @param context åº”ç”¨ä¸Šä¸‹æ–?
   */
  public async initialize(context: Context): Promise<void> {
    if (this.isInitialized) {
      Logger.info(TAG, 'Device manager already initialized');
      return;
    }

    try {
      Logger.info(TAG, 'Initializing device manager...');

      // åˆå§‹åŒ–DeviceManagerå®ä¾‹
      await this.initDeviceManagerInstance(context);
      
      // åŠ è½½é…ç½®
      await this.loadConfig();
      
      // åŠ è½½å·²æˆæƒè®¾å¤‡åˆ—è¡?
      await this.loadAuthorizedDevices();
      
      // æ³¨å†Œè®¾å¤‡çŠ¶æ€å›è°?
      await this.registerDeviceStateCallback();
      
      // æ³¨å†Œè®¤è¯å›è°ƒ
      await this.registerAuthCallback();
      
      // è·å–æœ¬åœ°è®¾å¤‡ä¿¡æ¯
      await this.updateLocalDeviceInfo();
      
      // å¦‚æœå¯ç”¨äº†è®¾å¤‡å‘ç°ï¼Œå¼€å§‹å‘ç°è®¾å¤?
      if (this.config.enableDeviceDiscovery) {
        await this.startDeviceDiscovery();
      }
      
      this.isInitialized = true;
      Logger.info(TAG, 'Device manager initialized successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to initialize device manager: ${JSON.stringify(error)}`);
      throw error;
    }
  }

  /**
   * åˆå§‹åŒ–DeviceManagerå®ä¾‹
   */
  private async initDeviceManagerInstance(context: Context): Promise<void> {
    try {
      const dmInstance = await deviceManager.createDeviceManager(PKG_NAME);
      if (!dmInstance) {
        throw new Error('Failed to create DeviceManager instance');
      }
      this.deviceManagerInstance = dmInstance;
    } catch (error) {
      Logger.error(TAG, `Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}` instanceof Error ? `Failed to create DeviceManager instance: ${error}` : new Error(String(`Failed to create DeviceManager instance: ${error}`)))))));
      throw error;
    }
  }

  /**
   * åŠ è½½é…ç½®
   */
  private async loadConfig(): Promise<void> {
    try {
      const savedConfig = await this.configService.getConfig('deviceManagerConfig', DEFAULT_DEVICE_MANAGER_CONFIG);
      if (savedConfig) {
        this.config = { ...DEFAULT_DEVICE_MANAGER_CONFIG, ...savedConfig };
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load device manager config: ${error}`);
    }
  }

  /**
   * ä¿å­˜é…ç½®
   */
  public async saveConfig(config: Partial<DeviceManagerConfig>): Promise<void> {
    try {
      this.config = { ...this.config, ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config instanceof Error ? ...config };
      await this.configService.setConfig('deviceManagerConfig', this.config : new Error(String(...config };
      await this.configService.setConfig('deviceManagerConfig', this.config)))))));
      
      // æ ¹æ®é…ç½®è°ƒæ•´è®¾å¤‡å‘ç°çŠ¶æ€?
      if (this.config.enableDeviceDiscovery && this.isInitialized) {
        await this.startDeviceDiscovery();
      } else {
        await this.stopDeviceDiscovery();
      }
    } catch (error) {
      Logger.error(TAG, `Failed to save device manager config: ${error}`);
      throw error;
    }
  }

  /**
   * è·å–é…ç½®
   */
  public getConfig(): DeviceManagerConfig {
    return { ...this.config };
  }

  /**
   * åŠ è½½å·²æˆæƒè®¾å¤‡åˆ—è¡?
   */
  private async loadAuthorizedDevices(): Promise<void> {
    try {
      const savedDevices = await this.configService.getConfig<string[]>('authorizedDevices', [] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([] instanceof Error ? [] instanceof Error ? [] : new Error(String([] : new Error(String([] instanceof Error ? [] : new Error(String([])))))));
      savedDevices.forEach(deviceId => this.authorizedDevices.add(deviceId));
    } catch (error) {
      Logger.error(TAG, `Failed to load authorized devices: ${error}`);
    }
  }

  /**
   * ä¿å­˜å·²æˆæƒè®¾å¤‡åˆ—è¡?
   */
  private async saveAuthorizedDevices(): Promise<void> {
    try {
      const deviceIds = Array.from(this.authorizedDevices);
      await this.configService.setConfig('authorizedDevices', deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds : new Error(String(deviceIds instanceof Error ? deviceIds : new Error(String(deviceIds)))))));
    } catch (error) {
      Logger.error(TAG, `Failed to save authorized devices: ${error}`);
    }
  }

  /**
   * æ³¨å†Œè®¾å¤‡çŠ¶æ€å›è°?
   */
  private async registerDeviceStateCallback(): Promise<void> {
    if (!this.deviceManagerInstance) {
      throw new Error('DeviceManager instance not initialized');
    }

    try {
      const callbackId = this.deviceManagerInstance.on('deviceStateChange', async (data instanceof Error ? async (data : new Error(String(async (data instanceof Error ? async (data instanceof Error ? async (data : new Error(String(async (data : new Error(String(async (data instanceof Error ? async (data : new Error(String(async (data instanceof Error ? async (data instanceof Error ? async (data : new Error(String(async (data instanceof Error ? async (data instanceof Error ? async (data : new Error(String(async (data : new Error(String(async (data instanceof Error ? async (data : new Error(String(async (data : new Error(String(async (data instanceof Error ? async (data : new Error(String(async (data instanceof Error ? async (data instanceof Error ? async (data : new Error(String(async (data : new Error(String(async (data instanceof Error ? async (data : new Error(String(async (data))))))) => {
        Logger.debug(TAG, `Device state changed: ${JSON.stringify(data)}`);
        
        const deviceId = data.deviceId;
        let deviceInfo = this.devices.get(deviceId);
        
        if (!deviceInfo) {
          // å¦‚æœæ˜¯æ–°è®¾å¤‡ï¼Œå°è¯•è·å–å®Œæ•´ä¿¡æ?
          try {
            const device = await this.getDeviceInfo(deviceId);
            deviceInfo = this.convertToDeviceInfo(device);
            this.devices.set(deviceId, deviceInfo);
          } catch (error) {
            Logger.error(TAG, `Failed to get device info for ${deviceId}: ${error}`);
            return;
          }
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€?
        switch (data.action) {
          case deviceManager.DeviceStateChangeAction.ONLINE:
            deviceInfo.status = DeviceStatus.ONLINE;
            deviceInfo.lastActiveTime = Date.now();
            this.notifyEvent(DeviceEvent.DEVICE_ONLINE, deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo)))))));
            break;
          case deviceManager.DeviceStateChangeAction.OFFLINE:
            deviceInfo.status = DeviceStatus.OFFLINE;
            this.notifyEvent(DeviceEvent.DEVICE_OFFLINE, deviceInfo);
            break;
          case deviceManager.DeviceStateChangeAction.CHANGE:
            this.notifyEvent(DeviceEvent.DEVICE_CHANGED, deviceInfo);
            break;
        }
      });
      
      this.deviceStateCallbackId = callbackId;
    } catch (error) {
      Logger.error(TAG, `Failed to register device state callback: ${error}`);
    }
  }

  /**
   * æ³¨å†Œè®¤è¯å›è°ƒ
   */
  private async registerAuthCallback(): Promise<void> {
    if (!this.deviceManagerInstance) {
      throw new Error('DeviceManager instance not initialized');
    }

    try {
      const callbackId = this.deviceManagerInstance.on('deviceAuth', (data instanceof Error ? (data : new Error(String((data instanceof Error ? (data instanceof Error ? (data : new Error(String((data : new Error(String((data instanceof Error ? (data : new Error(String((data instanceof Error ? (data instanceof Error ? (data : new Error(String((data instanceof Error ? (data instanceof Error ? (data : new Error(String((data : new Error(String((data instanceof Error ? (data : new Error(String((data : new Error(String((data instanceof Error ? (data : new Error(String((data instanceof Error ? (data instanceof Error ? (data : new Error(String((data : new Error(String((data instanceof Error ? (data : new Error(String((data))))))) => {
        Logger.debug(TAG, `Device auth event: ${JSON.stringify(data)}`);
        
        const deviceId = data.deviceId;
        const deviceInfo = this.devices.get(deviceId);
        
        if (deviceInfo) {
          switch (data.result) {
            case deviceManager.DeviceAuthResult.SUCCESS:
              deviceInfo.authStatus = AuthStatus.AUTHENTICATED;
              this.authorizedDevices.add(deviceId);
              this.saveAuthorizedDevices().catch(error => {
                Logger.error(TAG, `Failed to save authorized devices: ${error}`);
              });
              break;
            case deviceManager.DeviceAuthResult.FAIL:
              deviceInfo.authStatus = AuthStatus.AUTHENTICATION_FAILED;
              break;
          }
          
          this.notifyEvent(DeviceEvent.AUTH_STATE_CHANGED, deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo)))))));
        }
      });
      
      this.authCallbackId = callbackId;
    } catch (error) {
      Logger.error(TAG, `Failed to register auth callback: ${error}`);
    }
  }

  /**
   * æ›´æ–°æœ¬åœ°è®¾å¤‡ä¿¡æ¯
   */
  private async updateLocalDeviceInfo(): Promise<void> {
    if (!this.deviceManagerInstance) {
      return;
    }

    try {
      const localDeviceId = this.deviceManagerInstance.getLocalDeviceId();
      const deviceInfo: DeviceInfo = {
        deviceId: localDeviceId, deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( instanceof Error ? deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel( : new Error(String(deviceName: 'æœ¬æœº',
        deviceType: this.getDeviceTypeByModel())))))),
        status: DeviceStatus.ONLINE,
        authStatus: AuthStatus.AUTHENTICATED,
        isLocalDevice: true,
        lastActiveTime: Date.now(),
        connectedTime: Date.now()
      };
      
      this.devices.set(localDeviceId, deviceInfo);
    } catch (error) {
      Logger.error(TAG, `Failed to update local device info: ${error}`);
    }
  }

  /**
   * æ ¹æ®è®¾å¤‡å‹å·è·å–è®¾å¤‡ç±»å‹
   */
  private getDeviceTypeByModel(): DeviceType {
    try {
      // ä½¿ç”¨ç³»ç»ŸAPIè·å–è®¾å¤‡ä¿¡æ¯æ¥åˆ¤æ–­è®¾å¤‡ç±»å?
      // 1. è·å–å±å¹•ä¿¡æ¯
      const screenDpi = this.getScreenDpi();
      const screenWidth = this.getScreenWidth();
      const screenHeight = this.getScreenHeight();
      
      // 2. è·å–è®¾å¤‡å‹å·ä¿¡æ¯
      const deviceModel = this.getDeviceModel();
      const deviceBrand = this.getDeviceBrand();
      
      Logger.debug(TAG, `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` instanceof Error ? `Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}` : new Error(String(`Device info: model=${deviceModel}, brand=${deviceBrand}, screen=${screenWidth}x${screenHeight}, dpi=${screenDpi}`)))))));
      
      // 3. æ ¹æ®å±å¹•å°ºå¯¸å’Œåˆ†è¾¨ç‡åˆ¤æ–­
      const screenDiagonal = Math.sqrt(screenWidth * screenWidth + screenHeight * screenHeight) / screenDpi;
      
      // 4. è®¾å¤‡ç±»å‹åˆ¤æ–­é€»è¾‘
      
      // ç”µè§†åˆ¤æ–­ï¼šå¤§å±å¹•(>30è‹±å¯¸)ï¼Œç‰¹å®šåˆ†è¾¨ç‡(1080p/4K)ï¼Œæˆ–å‹å·åŒ…å«TV/televisionç­‰å…³é”®è¯
      if (screenDiagonal > 30 || 
          (screenWidth === 1920 && screenHeight === 1080) || 
          (screenWidth === 3840 && screenHeight === 2160) ||
          deviceModel.toLowerCase().includes('tv') ||
          deviceModel.toLowerCase().includes('television') ||
          deviceBrand.toLowerCase().includes('hisense') ||
          deviceBrand.toLowerCase().includes('tcl') ||
          deviceBrand.toLowerCase().includes('skyworth')) {
        return DeviceType.TV;
      }
      
      // å¹³æ¿åˆ¤æ–­ï¼šä¸­ç­‰å±å¹?7-12è‹±å¯¸)ï¼Œç‰¹å®šåˆ†è¾¨ç‡
      if (screenDiagonal >= 7 && screenDiagonal <= 12) {
        return DeviceType.TABLET;
      }
      
      // æ‰‹æœºåˆ¤æ–­ï¼šå°å±å¹•(<7è‹±å¯¸)ï¼Œæˆ–å‹å·åŒ…å«phone/mobileç­‰å…³é”®è¯
      if (screenDiagonal < 7 ||
          deviceModel.toLowerCase().includes('phone') ||
          deviceModel.toLowerCase().includes('mobile')) {
        return DeviceType.PHONE;
      }
      
      // å¯ç©¿æˆ´è®¾å¤‡åˆ¤æ–­ï¼šéå¸¸å°çš„å±å¹•(<2è‹±å¯¸)
      if (screenDiagonal < 2) {
        return DeviceType.WEARABLE;
      }
      
      // æ™ºèƒ½åº§èˆ±åˆ¤æ–­ï¼šç‰¹å®šå“ç‰Œæˆ–å‹å·å…³é”®è¯?
      if (deviceModel.toLowerCase().includes('car') ||
          deviceBrand.toLowerCase().includes('car')) {
        return DeviceType.CAR;
      }
      
      // æ™ºèƒ½è§†è§‰è®¾å¤‡åˆ¤æ–­ï¼šç‰¹å®šåˆ†è¾¨ç‡æˆ–å‹å·å…³é”®è¯
      if (deviceModel.toLowerCase().includes('vision') ||
          deviceModel.toLowerCase().includes('smartdisplay')) {
        return DeviceType.SMART_VISION;
      }
      
      // é»˜è®¤è¿”å›TVç±»å‹
      return DeviceType.TV;
    } catch (error) {
      Logger.error(TAG, `Failed to determine device type: ${error}`);
      // å‡ºé”™æ—¶é»˜è®¤è¿”å›TVç±»å‹
      return DeviceType.TV;
    }
  }
  
  /**
   * è·å–å±å¹•DPI
   */
  private getScreenDpi(): number {
    try {
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡display APIè·å–å±å¹•DPI
      // è¿™é‡Œä½¿ç”¨é»˜è®¤å€¼ä½œä¸ºåå¤?
      return 160;
    } catch {
      return 160;
    }
  }
  
  /**
   * è·å–å±å¹•å®½åº¦
   */
  private getScreenWidth(): number {
    try {
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡display APIè·å–å±å¹•å®½åº¦
      // è¿™é‡Œä½¿ç”¨é»˜è®¤å€¼ä½œä¸ºåå¤?
      return 1920;
    } catch {
      return 1920;
    }
  }
  
  /**
   * è·å–å±å¹•é«˜åº¦
   */
  private getScreenHeight(): number {
    try {
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡display APIè·å–å±å¹•é«˜åº¦
      // è¿™é‡Œä½¿ç”¨é»˜è®¤å€¼ä½œä¸ºåå¤?
      return 1080;
    } catch {
      return 1080;
    }
  }
  
  /**
   * è·å–è®¾å¤‡å‹å·
   */
  private getDeviceModel(): string {
    try {
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡systemParameter APIè·å–è®¾å¤‡å‹å·
      // è¿™é‡Œè¿”å›é»˜è®¤å€¼ä½œä¸ºåå¤?
      return 'DefaultDevice';
    } catch {
      return 'DefaultDevice';
    }
  }
  
  /**
   * è·å–è®¾å¤‡å“ç‰Œ
   */
  private getDeviceBrand(): string {
    try {
      // åœ¨HarmonyOSä¸­ï¼Œå¯ä»¥é€šè¿‡systemParameter APIè·å–è®¾å¤‡å“ç‰Œ
      // è¿™é‡Œè¿”å›é»˜è®¤å€¼ä½œä¸ºåå¤?
      return 'DefaultBrand';
    } catch {
      return 'DefaultBrand';
    }
  }

  /**
   * å¼€å§‹è®¾å¤‡å‘ç?
   */
  public async startDeviceDiscovery(): Promise<void> {
    if (!this.deviceManagerInstance || !this.config.enableDeviceDiscovery) {
      return;
    }

    try {
      await this.deviceManagerInstance.startDeviceDiscovery();
      Logger.info(TAG, 'Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started' : new Error(String('Device discovery started' instanceof Error ? 'Device discovery started' : new Error(String('Device discovery started')))))));
    } catch (error) {
      Logger.error(TAG, `Failed to start device discovery: ${error}`);
      throw error;
    }
  }

  /**
   * åœæ­¢è®¾å¤‡å‘ç°
   */
  public async stopDeviceDiscovery(): Promise<void> {
    if (!this.deviceManagerInstance) {
      return;
    }

    try {
      await this.deviceManagerInstance.stopDeviceDiscovery();
      Logger.info(TAG, 'Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped' : new Error(String('Device discovery stopped' instanceof Error ? 'Device discovery stopped' : new Error(String('Device discovery stopped')))))));
    } catch (error) {
      Logger.error(TAG, `Failed to stop device discovery: ${error}`);
    }
  }

  /**
   * è·å–è®¾å¤‡ä¿¡æ¯
   */
  private async getDeviceInfo(deviceId: string): Promise<RawDeviceInfo> {
    if (!this.deviceManagerInstance) {
      throw new Error('DeviceManager instance not initialized');
    }

    try {
      return await this.deviceManagerInstance.getDeviceInfo(deviceId);
    } catch (error) {
      Logger.error(TAG, `Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}` instanceof Error ? `Failed to get device info for ${deviceId}: ${error}` : new Error(String(`Failed to get device info for ${deviceId}: ${error}`)))))));
      throw error;
    }
  }

  /**
   * è½¬æ¢ä¸ºç»Ÿä¸€çš„è®¾å¤‡ä¿¡æ¯æ ¼å¼?
   */
  private convertToDeviceInfo(device: RawDeviceInfo): DeviceInfo {
    // è½¬æ¢è®¾å¤‡ç±»å‹
    let deviceType = DeviceType.OTHER;
    switch (device.deviceType) {
      case 0: // æ‰‹æœº
        deviceType = DeviceType.PHONE;
        break;
      case 1: // å¹³æ¿
        deviceType = DeviceType.TABLET;
        break;
      case 2: // TV
        deviceType = DeviceType.TV;
        break;
      case 3: // è½¦æœº
        deviceType = DeviceType.CAR;
        break;
      case 4: // ç©¿æˆ´
        deviceType = DeviceType.WEARABLE;
        break;
      case 5: // æ™ºèƒ½è§†è§‰
        deviceType = DeviceType.SMART_VISION;
        break;
    }

    // è½¬æ¢è®¤è¯çŠ¶æ€?
    let authStatus = AuthStatus.UNAUTHENTICATED;
    if (this.authorizedDevices.has(device.deviceId)) {
      authStatus = AuthStatus.AUTHENTICATED;
    }

    return {
      deviceId: device.deviceId,
      deviceName: device.deviceName || 'æœªçŸ¥è®¾å¤‡',
      deviceType: deviceType,
      networkId: device.networkId,
      status: DeviceStatus.ONLINE,
      authStatus: authStatus,
      isLocalDevice: false,
      lastActiveTime: Date.now(),
      connectedTime: Date.now()
    };
  }

  /**
   * è·å–è®¾å¤‡åˆ—è¡¨
   */
  public async getDevices(filter?: DeviceFilter): Promise<DeviceInfo[]> {
    if (!this.deviceManagerInstance) {
      return [];
    }

    try {
      // è·å–åœ¨çº¿è®¾å¤‡åˆ—è¡¨
      const onlineDevices = await this.deviceManagerInstance.getTrustedDeviceListSync();
      
      // è½¬æ¢è®¾å¤‡ä¿¡æ¯
      const allDevices: DeviceInfo[] = [];
      
      // æ·»åŠ åœ¨çº¿è®¾å¤‡
      for (const device of onlineDevices) {
        const deviceInfo = this.convertToDeviceInfo(device);
        this.devices.set(deviceInfo.deviceId, deviceInfo);
        allDevices.push(deviceInfo);
      }
      
      // æ·»åŠ æœ¬åœ°è®¾å¤‡
      allDevices.push(...Array.from(this.devices.values()).filter(device => device.isLocalDevice));
      
      // åº”ç”¨è¿‡æ»¤æ¡ä»¶
      let filteredDevices = allDevices;
      
      if (filter) {
        if (filter.deviceTypes && filter.deviceTypes.length > 0) {
          filteredDevices = filteredDevices.filter(device => 
            filter.deviceTypes!.includes(device.deviceType)
          );
        }
        
        if (filter.onlineOnly) {
          filteredDevices = filteredDevices.filter(device => 
            device.status === DeviceStatus.ONLINE
          );
        }
        
        if (filter.authenticatedOnly) {
          filteredDevices = filteredDevices.filter(device => 
            device.authStatus === AuthStatus.AUTHENTICATED || device.isLocalDevice
          );
        }
        
        if (filter.nameKeyword) {
          const keyword = filter.nameKeyword.toLowerCase();
          filteredDevices = filteredDevices.filter(device => 
            device.deviceName.toLowerCase().includes(keyword)
          );
        }
      }
      
      return filteredDevices;
    } catch (error) {
      Logger.error(TAG, `Failed to get devices: ${error}`);
      return [];
    }
  }
  
  /**
   * å‘ç›®æ ‡è®¾å¤‡å‘èµ·è®¤è¯è¯·æ±?
   * @param deviceId ç›®æ ‡è®¾å¤‡ID
   * @param authCode è®¤è¯ç ï¼ˆå¯é€‰ï¼‰
   */
  public async authenticateDevice(deviceId: string, authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string : new Error(String(authCode?: string instanceof Error ? authCode?: string : new Error(String(authCode?: string))))))): Promise<boolean> {
    if (!this.deviceManagerInstance) {
      throw new Error('DeviceManager instance not initialized');
    }
    
    try {
      Logger.info(TAG, `Authenticating device: ${deviceId}`);
      
      const deviceInfo = this.devices.get(deviceId);
      if (!deviceInfo) {
        throw new Error(`Device not found: ${deviceId}`);
      }
      
      // æ›´æ–°è®¾å¤‡è®¤è¯çŠ¶æ€ä¸ºè®¤è¯ä¸?
      deviceInfo.authStatus = AuthStatus.AUTHENTICATING;
      this.notifyEvent(DeviceEvent.AUTH_STATE_CHANGED, deviceInfo);
      
      // å‡†å¤‡è®¤è¯å‚æ•°
      const authParams: deviceManager.AuthParam = {
        authType: deviceManager.AuthType.PIN,
        extraInfo: authCode ? { pinCode: authCode } : {}
      };
      
      // å‘èµ·è®¤è¯
      await this.deviceManagerInstance.authenticateDevice(deviceId, authParams);
      
      // ç­‰å¾…è®¤è¯ç»“æœï¼ˆè¿™é‡Œä¼šé€šè¿‡è®¤è¯å›è°ƒå¤„ç†ï¼?
      // ç»™è®¤è¯è¿‡ç¨‹ä¸€ä¸ªè¶…æ—¶æ—¶é—?
      await new Promise<void>((resolve, reject) => {
        const timeout = setTimeout(() => reject(new Error('Authentication timeout')), 30000);
        
        const checkAuthStatus = () => {
          const updatedDevice = this.devices.get(deviceId);
          if (updatedDevice?.authStatus === AuthStatus.AUTHENTICATED) {
            clearTimeout(timeout);
            resolve();
          } else if (updatedDevice?.authStatus === AuthStatus.AUTHENTICATION_FAILED) {
            clearTimeout(timeout);
            reject(new Error('Authentication failed'));
          } else {
            // ç»§ç»­æ£€æŸ?
            setTimeout(checkAuthStatus, 1000);
          }
        };
        
        checkAuthStatus();
      });
      
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to authenticate device ${deviceId}: ${error}`);
      
      // æ›´æ–°è®¾å¤‡è®¤è¯çŠ¶æ€ä¸ºè®¤è¯å¤±è´¥
      const deviceInfo = this.devices.get(deviceId);
      if (deviceInfo) {
        deviceInfo.authStatus = AuthStatus.AUTHENTICATION_FAILED;
        this.notifyEvent(DeviceEvent.AUTH_STATE_CHANGED, deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo)))))));
      }
      
      return false;
    }
  }
  
  /**
   * åŒæ­¥æ•°æ®åˆ°ç›®æ ‡è®¾å¤?
   * @param deviceId ç›®æ ‡è®¾å¤‡ID
   * @param dataType æ•°æ®ç±»å‹
   * @param data è¦åŒæ­¥çš„æ•°æ®
   */
  public async syncDataToDevice<T>(deviceId: string, dataType: string, data: T): Promise<boolean> {
    if (!this.deviceManagerInstance) {
      throw new Error('DeviceManager instance not initialized');
    }
    
    try {
      // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è®¤è¯
      const deviceInfo = this.devices.get(deviceId);
      if (!deviceInfo || deviceInfo.authStatus !== AuthStatus.AUTHENTICATED) {
        throw new Error(`Device ${deviceId} is not authenticated`);
      }
      
      Logger.info(TAG, `Syncing data type ${dataType} to device: ${deviceId}`);
      
      // é€šè¿‡DistributedDataServiceåŒæ­¥æ•°æ®
      const syncResult = await this.distributedDataService.syncData({
        deviceId: deviceId,
        dataType: dataType,
        data: data
      });
      
      return syncResult;
    } catch (error) {
      Logger.error(TAG, `Failed to sync data to device ${deviceId}: ${error}`);
      return false;
    }
  }
  
  /**
   * æ§åˆ¶è·¨è®¾å¤‡åª’ä½“æ’­æ”?
   * @param deviceId ç›®æ ‡è®¾å¤‡ID
   * @param action æ’­æ”¾åŠ¨ä½œï¼ˆplay/pause/stop/seekç­‰ï¼‰
   * @param params åŠ¨ä½œå‚æ•°
   */
  public async controlRemotePlayback(deviceId: string, action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams instanceof Error ? action: string, params?: PlaybackControlParams : new Error(String(action: string, params?: PlaybackControlParams))))))): Promise<boolean> {
    if (!this.deviceManagerInstance) {
      throw new Error('DeviceManager instance not initialized');
    }
    
    try {
      // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è®¤è¯
      const deviceInfo = this.devices.get(deviceId);
      if (!deviceInfo || deviceInfo.authStatus !== AuthStatus.AUTHENTICATED) {
        throw new Error(`Device ${deviceId} is not authenticated`);
      }
      
      Logger.info(TAG, `Controlling remote playback on device ${deviceId}: ${action}`);
      
      // æ„å»ºæ§åˆ¶å‘½ä»¤
      const playbackCommand = {
        action: action,
        params: params || {},
        timestamp: Date.now()
      };
      
      // é€šè¿‡DistributedDataServiceå‘é€æ’­æ”¾æ§åˆ¶å‘½ä»?
      const controlResult = await this.distributedDataService.syncData({
        deviceId: deviceId,
        dataType: 'playback_control',
        data: playbackCommand
      });
      
      return controlResult;
    } catch (error) {
      Logger.error(TAG, `Failed to control remote playback on device ${deviceId}: ${error}`);
      return false;
    }
  }
  
  /**
   * è·å–å•ä¸ªè®¾å¤‡ä¿¡æ¯
   */
  public async getDevice(deviceId: string): Promise<DeviceInfo | null> {
    if (!this.deviceManagerInstance) {
      return null;
    }

    try {
      // å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰?
      let deviceInfo = this.devices.get(deviceId);
      
      if (!deviceInfo && !deviceInfo?.isLocalDevice) {
        // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ä¸”ä¸æ˜¯æœ¬åœ°è®¾å¤‡ï¼Œå°è¯•è·å?
        const device = await this.getDeviceInfo(deviceId);
        deviceInfo = this.convertToDeviceInfo(device);
        this.devices.set(deviceId, deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo : new Error(String(deviceInfo instanceof Error ? deviceInfo : new Error(String(deviceInfo)))))));
      }
      
      return deviceInfo || null;
    } catch (error) {
      Logger.error(TAG, `Failed to get device ${deviceId}: ${error}`);
      return null;
    }
  }
  
  /**
   * æ³¨å†Œè®¾å¤‡äº‹ä»¶ç›‘å¬å™?
   */
  public on(event: DeviceEvent, listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener : new Error(String(listener: DeviceEventListener instanceof Error ? listener: DeviceEventListener : new Error(String(listener: DeviceEventListener))))))): void {
    if (!this.eventListeners.has(event)) {
      this.eventListeners.set(event, []);
    }
    this.eventListeners.get(event)!.push(listener);
  }
  
  /**
   * å–æ¶ˆæ³¨å†Œè®¾å¤‡äº‹ä»¶ç›‘å¬å™?
   */
  public off(event: DeviceEvent, listener: DeviceEventListener): void {
    if (this.eventListeners.has(event)) {
      const listeners = this.eventListeners.get(event)!;
      const index = listeners.indexOf(listener);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    }
  }
  
  /**
   * é€šçŸ¥è®¾å¤‡äº‹ä»¶
   */
  private notifyEvent(event: DeviceEvent, deviceInfo: DeviceInfo): void {
    if (this.eventListeners.has(event)) {
      const listeners = this.eventListeners.get(event)!;
      for (const listener of listeners) {
        try {
          listener(event, deviceInfo);
        } catch (error) {
          Logger.error(TAG, `Error in event listener: ${error}`);
        }
      }
    }
  }
  
  /**
   * æ¸…ç†èµ„æº
   */
  public async destroy(): Promise<void> {
    try {
      // åœæ­¢è®¾å¤‡å‘ç°
      await this.stopDeviceDiscovery();
      
      // ç§»é™¤å›è°ƒ
      if (this.deviceManagerInstance) {
        if (this.deviceStateCallbackId) {
          this.deviceManagerInstance.off('deviceStateChange', this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId instanceof Error ? this.deviceStateCallbackId : new Error(String(this.deviceStateCallbackId)))))));
          this.deviceStateCallbackId = null;
        }
        if (this.authCallbackId) {
          this.deviceManagerInstance.off('deviceAuth', this.authCallbackId);
          this.authCallbackId = null;
        }
      }
      
      // æ¸…ç©ºè®¾å¤‡åˆ—è¡¨å’Œç›‘å¬å™¨
      this.devices.clear();
      this.eventListeners.clear();
      
      this.isInitialized = false;
      Logger.info(TAG, 'Device manager destroyed');
    } catch (error) {
      Logger.error(TAG, `Failed to destroy device manager: ${error}`);
    }
  }
}


