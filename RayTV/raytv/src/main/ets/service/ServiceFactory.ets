import Logger from '../../../common/util/Logger';
import RepositoryFactory from '../../data/repository/RepositoryFactory';
import ConfigService from '../../service/config/ConfigService';
import HistoryService from '../../service/media/HistoryService';
import { SiteService } from './spider/SiteService';
import { ConfigManager } from './ConfigManager';
import { HistoryManager } from './HistoryManager';

const TAG = 'ServiceFactory';

/**
 * æœåŠ¡ç±»å‹æšä¸¾
 */
export enum ServiceType {
  CONFIG,
  HISTORY,
  SITE,
  CONFIG_MANAGER,
  HISTORY_MANAGER
}

/**
 * æœåŠ¡å®ä¾‹ç±»å‹è”åˆ
 */
export type ServiceInstance = ConfigService | HistoryService | SiteService | ConfigManager | HistoryManager;

/**
 * æœåŠ¡å·¥å‚ç±? * è´Ÿè´£åˆ›å»ºå’Œç®¡ç†å„ç§æœåŠ¡çš„å®ä¾‹
 */
export default class ServiceFactory {
  private static instance: ServiceFactory | null = null;
  private serviceMap: Map<ServiceType, ServiceInstance> = new Map();
  private isInitialized: boolean = false;

  /**
   * ç§æœ‰æ„é€ å‡½æ•?   */
  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns ServiceFactoryå®ä¾‹
   */
  public static getInstance(): ServiceFactory {
    if (!ServiceFactory.instance) {
      ServiceFactory.instance = new ServiceFactory();
    }
    return ServiceFactory.instance;
  }

  /**
   * åˆå§‹åŒ–æ‰€æœ‰æœåŠ?   * @returns æ˜¯å¦åˆå§‹åŒ–æˆåŠ?   */
  public async initialize(): Promise<boolean> {
    try {
      if (this.isInitialized) {
        Logger.info(TAG, 'Services already initialized');
        return true;
      }

      Logger.info(TAG, 'Initializing services...');

      const repoInitResult = await RepositoryFactory.getInstance().initialize();

      if (!repoInitResult) {
        Logger.error(TAG, 'Failed to initialize repository factory');
        return false;
      }

      // åˆå§‹åŒ–é…ç½®æœåŠ?      const configService = ConfigService.getInstance();
      await configService.initializeConfig();
      this.serviceMap.set(ServiceType.CONFIG, configService instanceof Error ? configService : new Error(String(configService instanceof Error ? configService instanceof Error ? configService : new Error(String(configService : new Error(String(configService instanceof Error ? configService : new Error(String(configService instanceof Error ? configService instanceof Error ? configService : new Error(String(configService instanceof Error ? configService instanceof Error ? configService : new Error(String(configService : new Error(String(configService instanceof Error ? configService : new Error(String(configService : new Error(String(configService instanceof Error ? configService : new Error(String(configService instanceof Error ? configService instanceof Error ? configService : new Error(String(configService : new Error(String(configService instanceof Error ? configService : new Error(String(configService)))))));
      Logger.info(TAG, 'ConfigService initialized successfully');

      // åˆå§‹åŒ–å†å²æœåŠ?      const historyService = HistoryService.getInstance();
      this.serviceMap.set(ServiceType.HISTORY, historyService);
      Logger.info(TAG, 'HistoryService initialized successfully');

      // åˆå§‹åŒ–ç«™ç‚¹æœåŠ?      const siteService = SiteService.getInstance();
      await siteService.initialize();
      this.serviceMap.set(ServiceType.SITE, siteService);
      Logger.info(TAG, 'SiteService initialized successfully');

      // åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨ï¼ˆé€‚é…å™¨ï¼‰
      const configManager = ConfigManager.getInstance();
      await configManager.initialize();
      this.serviceMap.set(ServiceType.CONFIG_MANAGER, configManager);
      Logger.info(TAG, 'ConfigManager initialized successfully');

      // åˆå§‹åŒ–å†å²ç®¡ç†å™¨ï¼ˆé€‚é…å™¨ï¼‰
      const historyManager = HistoryManager.getInstance();
      await historyManager.initialize();
      this.serviceMap.set(ServiceType.HISTORY_MANAGER, historyManager);
      Logger.info(TAG, 'HistoryManager initialized successfully');

      this.isInitialized = true;
      Logger.info(TAG, 'All services initialized successfully');
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to initialize services: ${error instanceof Error ? error.message : String(error)}`);
      return false;
    }
  }

  /**
   * è·å–é…ç½®æœåŠ¡å®ä¾‹
   * @returns ConfigServiceå®ä¾‹
   */
  public getConfigService(): ConfigService {
    return this.getService(ServiceType.CONFIG);
  }

  /**
   * è·å–å†å²æœåŠ¡å®ä¾‹
   * @returns HistoryServiceå®ä¾‹
   */
  public getHistoryService(): HistoryService {
    return this.getService(ServiceType.HISTORY);
  }

  /**
   * è·å–ç«™ç‚¹æœåŠ¡å®ä¾‹
   * @returns SiteServiceå®ä¾‹
   */
  public getSiteService(): SiteService {
    return this.getService(ServiceType.SITE);
  }

  /**
   * è·å–é…ç½®ç®¡ç†å™¨å®ä¾?   * @returns ConfigManagerå®ä¾‹
   */
  public getConfigManager(): ConfigManager {
    return this.getService(ServiceType.CONFIG_MANAGER);
  }

  /**
   * è·å–å†å²ç®¡ç†å™¨å®ä¾?   * @returns HistoryManagerå®ä¾‹
   */
  public getHistoryManager(): HistoryManager {
    return this.getService(ServiceType.HISTORY_MANAGER);
  }

  /**
   * è·å–æŒ‡å®šç±»å‹çš„æœåŠ¡å®ä¾?   * @param type æœåŠ¡ç±»å‹
   * @returns æœåŠ¡å®ä¾‹
   */
  private getService<T>(type: ServiceType): T {
    const service = this.serviceMap.get(type);
    if (!service) {
      throw new Error(`Service of type ${type} not initialized. Call initialize() first.`);
    }
    return service as T;
  }

  /**
   * è®¾ç½®è‡ªå®šä¹‰æœåŠ¡å®ä¾?   * @param type æœåŠ¡ç±»å‹
   * @param service æœåŠ¡å®ä¾‹
   */
  public setService(type: ServiceType, service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance : new Error(String(service: ServiceInstance instanceof Error ? service: ServiceInstance : new Error(String(service: ServiceInstance))))))): void {
    this.serviceMap.set(type, service);
    Logger.info(TAG, `Custom service set for type: ${type}`);
  }

  /**
   * æ£€æŸ¥æœåŠ¡æ˜¯å¦åˆå§‹åŒ–
   * @param type æœåŠ¡ç±»å‹
   * @returns æ˜¯å¦åˆå§‹åŒ?   */
  public isServiceInitialized(type: ServiceType): boolean {
    return this.serviceMap.has(type);
  }

  /**
   * å…³é—­æ‰€æœ‰æœåŠ¡èµ„æº?   */
  public async close(): Promise<void> {
    try {
      Logger.info(TAG, 'Closing services...');

      // æ¸…ç†æœåŠ¡æ˜ å°„
      this.serviceMap.clear();
      this.isInitialized = false;
      
      // å…³é—­ä»“åº“èµ„æº
      await RepositoryFactory.getInstance().close();
      
      Logger.info(TAG, 'All services closed successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to close services: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * é‡ç½®å·¥å‚ï¼ˆä¸»è¦ç”¨äºæµ‹è¯•ï¼‰
   */
  public static reset(): void {
    if (ServiceFactory.instance) {
      ServiceFactory.instance.close().catch(error => {
        Logger.error(TAG, `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error)))))))}`);
      });
      ServiceFactory.instance = null;
    }
    Logger.info(TAG, 'Service factory reset');
  }
}


