import Logger from '../../common/util/Logger';
import { AdBlockConfig } from '../../data/bean/Config';
import { configService } from '../config/ConfigService';

/**
 * è§„åˆ™ç»Ÿè®¡ä¿¡æ¯æ¥å£
 */
export interface AdBlockStats {
  ruleCount: number;
  lastUpdate?: number;
  enabled: boolean;
}

/**
 * å¹¿å‘Šè§„åˆ™æ¨¡å‹
 */
export class AdRule {
  pattern: string;       // åŒ¹é…æ¨¡å¼
  type: 'domain' | 'regex' | 'keyword'; // è§„åˆ™ç±»å‹
  description?: string;  // è§„åˆ™æè¿°
  source?: string;       // è§„åˆ™æ¥æº

  constructor(pattern: string, type: 'domain' | 'regex' | 'keyword', description?: string, source?: string) {
    this.pattern = pattern;
    this.type = type;
    this.description = description;
    this.source = source;
  }

  /**
   * æµ‹è¯•URLæ˜¯å¦åŒ¹é…æ­¤è§„åˆ?
   */
  matches(url: string): boolean {
    switch (this.type) {
      case 'domain':
        return this.matchesDomain(url);
      case 'regex':
        return this.matchesRegex(url);
      case 'keyword':
        return this.matchesKeyword(url);
      default:
        return false;
    }
  }

  private matchesDomain(url: string): boolean {
    try {
      const urlObj = new URL(url);
      const domain = urlObj.hostname;
      if (!domain) {
        return false;
      }
      return domain === this.pattern || domain.endsWith(`.${this.pattern}`);
    } catch (error) {
      return false;
    }
  }

  private matchesRegex(url: string): boolean {
    try {
      // ä¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ”¹ç”¨å­—ç¬¦ä¸²åŒ…å«æ£€æŸ?
      // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å®ç°ï¼Œåªæ”¯æŒåŸºæœ¬çš„å­—ç¬¦ä¸²åŒ¹é…?
      // å¯¹äºå¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼Œéœ€è¦æ›´å¤æ‚çš„è§£æé€»è¾‘
      return url.indexOf(this.pattern) !== -1;
    } catch {
      return false;
    }
  }

  private matchesKeyword(url: string): boolean {
    return url.toLowerCase().includes(this.pattern.toLowerCase());
  }
}

/**
 * URLè¿‡æ»¤å™?
 */
export class UrlFilter {
  private rules: AdRule[] = [];

  /**
   * æ·»åŠ è§„åˆ™
   */
  addRule(rule: AdRule): void {
    this.rules.push(rule);
  }

  /**
   * æ‰¹é‡æ·»åŠ è§„åˆ™
   */
  addRules(rules: AdRule[]): void {
    this.rules.push(...rules);
  }

  /**
   * æ¸…é™¤æ‰€æœ‰è§„åˆ?
   */
  clearRules(): void {
    this.rules = [];
  }

  /**
   * æ£€æŸ¥URLæ˜¯å¦åº”è¯¥è¢«è¿‡æ»?
   */
  shouldBlock(url: string): boolean {
    if (!url || typeof url !== 'string') {
      return false;
    }

    return this.rules.some(rule => rule.matches(url));
  }

  /**
   * è·å–åŒ¹é…çš„è§„åˆ?
   */
  getMatchingRule(url: string): AdRule | null {
    return this.rules.find(rule => rule.matches(url)) || null;
  }

  /**
   * è·å–è§„åˆ™æ•°é‡
   */
  getRuleCount(): number {
    return this.rules.length;
  }
}

/**
 * å¹¿å‘Šå±è”½ç®¡ç†å™?
 */
export class AdBlockManager {
  private static readonly TAG: string = 'AdBlockManager';
  private static instance: AdBlockManager;
  
  private config: AdBlockConfig | null = null;
  private urlFilter: UrlFilter = new UrlFilter();
  private isInitialized: boolean = false;
  private whitelist: Set<string> = new Set();

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): AdBlockManager {
    if (!AdBlockManager.instance) {
      AdBlockManager.instance = new AdBlockManager();
    }
    return AdBlockManager.instance;
  }

  /**
   * åˆå§‹åŒ–å¹¿å‘Šå±è”½ç®¡ç†å™¨
   */
  public async initialize(): Promise<void> {
    try {
      Logger.info(AdBlockManager.TAG, 'Initializing AdBlockManager...');
      
      // åŠ è½½é…ç½®
      this.config = await configService.getAdBlockConfig();
      
      // åŠ è½½é»˜è®¤è§„åˆ™
      await this.loadDefaultRules();
      
      // åŠ è½½ç™½åå?
      await this.loadWhitelist();
      
      this.isInitialized = true;
      Logger.info(AdBlockManager.TAG, `AdBlockManager initialized with ${this.urlFilter.getRuleCount()} rules`);
    } catch (error) {
      Logger.error(AdBlockManager.TAG, `Failed to initialize AdBlockManager: ${error}`);
      throw new Error(`Failed to initialize AdBlockManager: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * åŠ è½½é»˜è®¤å¹¿å‘Šè§„åˆ™
   */
  private async loadDefaultRules(): Promise<void> {
    // é»˜è®¤å¹¿å‘Šè§„åˆ™åˆ—è¡¨
    const defaultRules: AdRule[] = [
      // å¸¸è§å¹¿å‘ŠåŸŸå
      new AdRule('example.com', 'domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService' : new Error(String('domain', 'AdService' instanceof Error ? 'domain', 'AdService' : new Error(String('domain', 'AdService'))))))),
      new AdRule('example-doubleclick.net', 'domain', 'Ad Network'),
        new AdRule('example-syndication.com', 'domain', 'Ad Network'),
      
      // å¹¿å‘Šå…³é”®è¯?
      new AdRule('banner', 'keyword', 'Banner ads'),
      new AdRule('adspot', 'keyword', 'Ad spot'),
      new AdRule('advertisement', 'keyword', 'Advertisement'),
      
      // è§†é¢‘å¹¿å‘Šå…³é”®è¯?
      new AdRule('ad.mp4', 'keyword', 'Video ads'),
      new AdRule('ad.m3u8', 'keyword', 'Video ads'),
      new AdRule('ad.ts', 'keyword', 'Video ads'),
      new AdRule('advertisement', 'keyword', 'Advertisement domains'),
    ];
    
    // å¦‚æœæœ‰è‡ªå®šä¹‰è§„åˆ™ï¼ŒåŠ è½½å®ƒä»?
    if (this.config?.rules && this.config.rules.length > 0) {
      this.config.rules.forEach(ruleStr => {
        try {
          // ç®€å•çš„è§„åˆ™è§£æé€»è¾‘
          if (ruleStr.startsWith('regex:')) {
            const pattern = ruleStr.replace('regex:', '');
            this.urlFilter.addRule(new AdRule(pattern, 'regex', 'Custom regex rule'));
          } else if (ruleStr.includes('.')) {
            this.urlFilter.addRule(new AdRule(ruleStr, 'domain', 'Custom domain rule'));
          } else {
            this.urlFilter.addRule(new AdRule(ruleStr, 'keyword', 'Custom keyword rule'));
          }
        } catch (e) {
          Logger.error(AdBlockManager.TAG, `Invalid custom rule: ${ruleStr}`, e instanceof Error ? e : new Error(String(e instanceof Error ? e instanceof Error ? e : new Error(String(e : new Error(String(e instanceof Error ? e : new Error(String(e instanceof Error ? e instanceof Error ? e : new Error(String(e instanceof Error ? e instanceof Error ? e : new Error(String(e : new Error(String(e instanceof Error ? e : new Error(String(e : new Error(String(e instanceof Error ? e : new Error(String(e instanceof Error ? e instanceof Error ? e : new Error(String(e : new Error(String(e instanceof Error ? e : new Error(String(e)))))));
        }
      });
    }
    
    // æ·»åŠ é»˜è®¤è§„åˆ™
    this.urlFilter.addRules(defaultRules);
  }

  /**
   * åŠ è½½ç™½åå?
   */
  private async loadWhitelist(): Promise<void> {
    if (this.config?.whitelist && this.config.whitelist.length > 0) {
      this.config.whitelist.forEach(item => this.whitelist.add(item));
    }
  }

  /**
   * æ›´æ–°å¹¿å‘Šè§„åˆ™
   */
  public async updateRules(): Promise<void> {
    try {
      Logger.info(AdBlockManager.TAG, 'Updating ad block rules...');
      
      // æ¸…é™¤ç°æœ‰è§„åˆ™
      this.urlFilter.clearRules();
      
      // é‡æ–°åŠ è½½é…ç½®
      this.config = await configService.getAdBlockConfig();
      
      // é‡æ–°åŠ è½½è§„åˆ™
      await this.loadDefaultRules();
      await this.loadWhitelist();
      
      // æ›´æ–°æœ€åæ›´æ–°æ—¶é—?
      if (this.config) {
        this.config.lastUpdateTime = Date.now();
        await configService.saveAdBlockConfig(this.config);
      }
      
      Logger.info(AdBlockManager.TAG, `Rules updated. Now have ${this.urlFilter.getRuleCount()} rules.`);
    } catch (error) {
      Logger.error(AdBlockManager.TAG, `Failed to update rules: ${error}`);
      throw new Error(`Failed to update rules: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * æ£€æŸ¥URLæ˜¯å¦åº”è¯¥è¢«å±è”?
   */
  public shouldBlock(url: string): boolean {
    if (!this.isInitialized || !this.config?.enabled) {
      return false;
    }

    // æ£€æŸ¥ç™½åå•
    for (const item of this.whitelist) {
      if (url.includes(item)) {
        return false;
      }
    }

    return this.urlFilter.shouldBlock(url);
  }

  /**
   * å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæ‹¦æˆªå¹¿å‘?
   */
  public interceptRequest(url: string, requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string : new Error(String(requestType: string instanceof Error ? requestType: string : new Error(String(requestType: string))))))): boolean {
    if (!this.isInitialized || !this.config?.enabled) {
      return false;
    }

    // æ ¹æ®è¯·æ±‚ç±»å‹å’Œé…ç½®å†³å®šæ˜¯å¦æ‹¦æˆ?
    if (requestType === 'video' && !this.config.blockVideoAds) {
      return false;
    }

    if (requestType === 'popup' && !this.config.blockPopupAds) {
      return false;
    }

    return this.shouldBlock(url);
  }

  /**
   * è·å–è§„åˆ™ç»Ÿè®¡ä¿¡æ¯
   */
  public getStats(): AdBlockStats {
    return {
      ruleCount: this.urlFilter.getRuleCount(),
      lastUpdate: this.config?.lastUpdateTime,
      enabled: this.config?.enabled || false
    };
  }

  /**
   * æ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ?
   */
  public async addCustomFilter(filter: string): Promise<void> {
    try {
      if (!this.config) {
        this.config = await configService.getAdBlockConfig();
      }
      
      // ç¡®ä¿configä¸ä¸ºnull
      if (this.config) {
        if (!this.config.customFilters) {
          this.config.customFilters = [];
        }
        
        if (!this.config.customFilters.includes(filter)) {
          this.config.customFilters.push(filter);
          await configService.saveAdBlockConfig(this.config);
          await this.updateRules();
        }
      }
    } catch (error) {
      Logger.error(AdBlockManager.TAG, `Failed to add custom filter: ${error}`);
      throw new Error(`Failed to add custom filter: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * å¯ç”¨/ç¦ç”¨å¹¿å‘Šå±è”½
   */
  public async setEnabled(enabled: boolean): Promise<void> {
    try {
      if (!this.config) {
        this.config = await configService.getAdBlockConfig();
      }
      
      // ç¡®ä¿configä¸ä¸ºnull
      if (this.config) {
        this.config.enabled = enabled;
        await configService.saveAdBlockConfig(this.config);
        
        Logger.info(AdBlockManager.TAG, `Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}` instanceof Error ? `Ad blocking ${enabled ? 'enabled' : 'disabled'}` : new Error(String(`Ad blocking ${enabled ? 'enabled' : 'disabled'}`)))))));
      }
    } catch (error) {
      Logger.error(AdBlockManager.TAG, `Failed to set ad block enabled state: ${error}`);
      throw new Error(`Failed to set ad block enabled state: ${error instanceof Error ? error.message : String(error)}`);
    }
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export function getAdBlockManager(): AdBlockManager {
  return AdBlockManager.getInstance();
}


