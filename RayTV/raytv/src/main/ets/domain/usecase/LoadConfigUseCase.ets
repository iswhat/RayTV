// LoadConfigUseCase - åŠ è½½é…ç½®ç”¨ä¾‹
import Logger from '../../common/util/Logger';
import { AppConfig, PlayerConfig, DisplayConfig, NetworkConfig, SecurityConfig, AdBlockConfig, HarmonyConfig } from '../../data/bean/Config';
import { ConfigRepository } from '../../data/repository/ConfigRepository';
import { DeviceInfoRepository } from '../../data/repository/DeviceInfoRepository';
import { CacheRepository } from '../../data/repository/CacheRepository';

const TAG = 'LoadConfigUseCase';
const CONFIG_CACHE_KEY = 'app_config_cache';
const CONFIG_CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24å°æ—¶ç¼“å­˜è¿‡æœŸæ—¶é—´

/**
 * åŠ è½½å’Œç®¡ç†åº”ç”¨é…ç½®çš„ä¸šåŠ¡ç”¨ä¾‹
 */
export class LoadConfigUseCase {
  private configRepository: ConfigRepository;
  private deviceInfoRepository: DeviceInfoRepository;
  private cacheRepository: CacheRepository;
  
  constructor(
    configRepository: ConfigRepository,
    deviceInfoRepository: DeviceInfoRepository,
    cacheRepository: CacheRepository
  ) {
    this.configRepository = configRepository;
    this.deviceInfoRepository = deviceInfoRepository;
    this.cacheRepository = cacheRepository;
  }
  
  /**
   * åŠ è½½åº”ç”¨é…ç½®
   * @param forceRefresh æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
   * @returns åº”ç”¨é…ç½®å¯¹è±¡
   */
  public async loadAppConfig(forceRefresh: boolean = false): Promise<AppConfig> {
    try {
      Logger.info(TAG, 'Loading app configuration');
      
      // å¦‚æœä¸æ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œå°è¯•ä»ç¼“å­˜åŠ è½½
      if (!forceRefresh) {
        const cachedConfig = await this.getCachedConfig();
        if (cachedConfig) {
          Logger.info(TAG, 'Using cached configuration');
          return cachedConfig;
        }
      }
      
      // ä»æ•°æ®åº“åŠ è½½é…ç½®
      let config = await this.configRepository.getAppConfig();
      
      // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½?      if (!config) {
        Logger.info(TAG, 'No configuration found, using default configuration');
        config = this.getDefaultConfig();
        // ä¿å­˜é»˜è®¤é…ç½®åˆ°æ•°æ®åº“
        await this.configRepository.saveAppConfig(config);
      }
      
      // æ ¹æ®è®¾å¤‡ä¿¡æ¯ä¼˜åŒ–é…ç½®
      config = await this.optimizeConfigForDevice(config);
      
      // ç¼“å­˜é…ç½®
      await this.cacheConfig(config);
      
      Logger.info(TAG, 'Configuration loaded successfully');
      return config;
    } catch (error) {
      Logger.error(TAG, `Failed to load configuration: ${error}`);
      // å‘ç”Ÿé”™è¯¯æ—¶è¿”å›é»˜è®¤é…ç½?      const defaultConfig = this.getDefaultConfig();
      await this.cacheConfig(defaultConfig);
      return defaultConfig;
    }
  }
  
  /**
   * ä¿å­˜åº”ç”¨é…ç½®
   * @param config åº”ç”¨é…ç½®å¯¹è±¡
   */
  public async saveAppConfig(config: AppConfig): Promise<void> {
    try {
      Logger.info(TAG, 'Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration' : new Error(String('Saving app configuration' instanceof Error ? 'Saving app configuration' : new Error(String('Saving app configuration')))))));
      
      // éªŒè¯é…ç½®
      this.validateConfig(config);
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      await this.configRepository.saveAppConfig(config);
      
      // æ›´æ–°ç¼“å­˜
      await this.cacheConfig(config);
      
      Logger.info(TAG, 'Configuration saved successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to save configuration: ${error}`);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°æ’­æ”¾å™¨é…ç½?   * @param playerConfig æ’­æ”¾å™¨é…ç½?   * @returns æ›´æ–°åçš„å®Œæ•´é…ç½®
   */
  public async updatePlayerConfig(playerConfig: Partial<PlayerConfig>): Promise<AppConfig> {
    try {
      Logger.info(TAG, 'Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration' : new Error(String('Updating player configuration' instanceof Error ? 'Updating player configuration' : new Error(String('Updating player configuration')))))));
      
      const currentConfig = await this.loadAppConfig();
      
      const updatedConfig: AppConfig = {
        ...currentConfig,
        player: {
          ...currentConfig.player,
          ...playerConfig
        }
      };
      
      await this.saveAppConfig(updatedConfig);
      return updatedConfig;
    } catch (error) {
      Logger.error(TAG, `Failed to update player configuration: ${error}`);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°æ˜¾ç¤ºé…ç½®
   * @param displayConfig æ˜¾ç¤ºé…ç½®
   * @returns æ›´æ–°åçš„å®Œæ•´é…ç½®
   */
  public async updateDisplayConfig(displayConfig: Partial<DisplayConfig>): Promise<AppConfig> {
    try {
      Logger.info(TAG, 'Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration' : new Error(String('Updating display configuration' instanceof Error ? 'Updating display configuration' : new Error(String('Updating display configuration')))))));
      
      const currentConfig = await this.loadAppConfig();
      
      const updatedConfig: AppConfig = {
        ...currentConfig,
        display: {
          ...currentConfig.display,
          ...displayConfig
        }
      };
      
      await this.saveAppConfig(updatedConfig);
      return updatedConfig;
    } catch (error) {
      Logger.error(TAG, `Failed to update display configuration: ${error}`);
      throw error;
    }
  }
  
  /**
   * æ›´æ–°ç½‘ç»œé…ç½®
   * @param networkConfig ç½‘ç»œé…ç½®
   * @returns æ›´æ–°åçš„å®Œæ•´é…ç½®
   */
  public async updateNetworkConfig(networkConfig: Partial<NetworkConfig>): Promise<AppConfig> {
    try {
      Logger.info(TAG, 'Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration' : new Error(String('Updating network configuration' instanceof Error ? 'Updating network configuration' : new Error(String('Updating network configuration')))))));
      
      const currentConfig = await this.loadAppConfig();
      
      const updatedConfig: AppConfig = {
        ...currentConfig,
        network: {
          ...currentConfig.network,
          ...networkConfig
        }
      };
      
      await this.saveAppConfig(updatedConfig);
      
      // å¦‚æœç½‘ç»œé…ç½®æ”¹å˜ï¼Œæ¸…é™¤ç½‘ç»œç›¸å…³ç¼“å­?      await this.clearNetworkCache();
      
      return updatedConfig;
    } catch (error) {
      Logger.error(TAG, `Failed to update network configuration: ${error}`);
      throw error;
    }
  }
  
  /**
   * é‡ç½®é…ç½®åˆ°é»˜è®¤å€?   * @returns é»˜è®¤é…ç½®
   */
  public async resetToDefaultConfig(): Promise<AppConfig> {
    try {
      Logger.info(TAG, 'Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values' : new Error(String('Resetting configuration to default values' instanceof Error ? 'Resetting configuration to default values' : new Error(String('Resetting configuration to default values')))))));
      
      const defaultConfig = this.getDefaultConfig();
      
      // ä¿å­˜é»˜è®¤é…ç½®
      await this.configRepository.saveAppConfig(defaultConfig);
      
      // æ›´æ–°ç¼“å­˜
      await this.cacheConfig(defaultConfig);
      
      // æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­?      await this.clearAllRelatedCache();
      
      return defaultConfig;
    } catch (error) {
      Logger.error(TAG, `Failed to reset configuration: ${error}`);
      throw error;
    }
  }
  
  /**
   * è·å–é»˜è®¤é…ç½®
   * @returns é»˜è®¤é…ç½®å¯¹è±¡
   */
  private getDefaultConfig(): AppConfig {
    return {
      player: {
        defaultPlayer: 'avplayer', enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig instanceof Error ? enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig : new Error(String(enableHardwareDecode: true,
        autoContinuePlay: true,
        rememberPosition: true,
        speedList: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0]
      },
      display: {
        theme: 'system',
        fontSize: 16,
        autoFullScreen: true,
        enableGestures: true
      },
      network: {
        timeout: 30,
        retryCount: 3,
        enableCache: true,
        cacheSize: 50
      },
      security: {
        enableSandbox: true,
        allowThirdParty: false
      },
      adBlock: {
        enabled: false,
        rules: [],
        updateInterval: 24
      },
      harmony: {
        enableVoiceAssistant: true,
        enableDeviceFlow: true,
        enableGestureControl: true
      }
    };
  }
  
  /**
   * éªŒè¯é…ç½®æœ‰æ•ˆæ€?   * @param config è¦éªŒè¯çš„é…ç½®
   */
  private validateConfig(config: AppConfig))))))): void {
    // éªŒè¯æ’­æ”¾å™¨é…ç½?    if (config.player) {
      if (config.player.timeout < 5 || config.player.timeout > 300) {
        throw new Error('Player timeout must be between 5 and 300 seconds');
      }
      if (config.player.speedList.length === 0) {
        throw new Error('Player speed list cannot be empty');
      }
    }
    
    // éªŒè¯ç½‘ç»œé…ç½®
    if (config.network) {
      if (config.network.timeout < 5 || config.network.timeout > 300) {
        throw new Error('Network timeout must be between 5 and 300 seconds');
      }
      if (config.network.retryCount < 0 || config.network.retryCount > 10) {
        throw new Error('Retry count must be between 0 and 10');
      }
      if (config.network.cacheSize < 0 || config.network.cacheSize > 500) {
        throw new Error('Cache size must be between 0 and 500 MB');
      }
    }
  }
  
  /**
   * æ ¹æ®è®¾å¤‡ä¿¡æ¯ä¼˜åŒ–é…ç½®
   * @param config åŸå§‹é…ç½®
   * @returns ä¼˜åŒ–åçš„é…ç½®
   */
  private async optimizeConfigForDevice(config: AppConfig): Promise<AppConfig> {
    try {
      const deviceInfo = await this.deviceInfoRepository.getDeviceInfo();
      
      // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´é…ç½®
      if (deviceInfo.isTvMode) {
        // TVæ¨¡å¼ä¸‹çš„ä¼˜åŒ–é…ç½®
        config.display.enableGestures = false; // TVé€šå¸¸ä¸ä½¿ç”¨æ‰‹åŠ?        config.display.autoFullScreen = true; // TVé»˜è®¤å…¨å±
        config.player.enableHardwareDecode = true; // TVä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶è§£ç 
      }
      
      // æ ¹æ®è®¾å¤‡æ€§èƒ½è°ƒæ•´ç¼“å­˜å¤§å°
      if (deviceInfo.screenHeight > 2160) { // 4Kè®¾å¤‡
        config.network.cacheSize = Math.max(config.network.cacheSize, 100);
      }
      
      return config;
    } catch (error) {
      Logger.warn(TAG, `Failed to optimize config for device: ${error}`);
      return config;
    }
  }
  
  /**
   * ç¼“å­˜é…ç½®
   */
  private async cacheConfig(config: AppConfig): Promise<void> {
    try {
      await this.cacheRepository.saveObject(CONFIG_CACHE_KEY, config, CONFIG_CACHE_EXPIRY);
    } catch (error) {
      Logger.warn(TAG, `Failed to cache configuration: ${error}`);
    }
  }
  
  /**
   * è·å–ç¼“å­˜çš„é…ç½?   */
  private async getCachedConfig(): Promise<AppConfig | null> {
    try {
      return await this.cacheRepository.getObject<AppConfig>(CONFIG_CACHE_KEY);
    } catch (error) {
      Logger.warn(TAG, `Failed to get cached configuration: ${error}`);
      return null;
    }
  }
  
  /**
   * æ¸…é™¤ç½‘ç»œç›¸å…³ç¼“å­˜
   */
  private async clearNetworkCache(): Promise<void> {
    try {
      // æ¸…é™¤ç½‘ç»œç›¸å…³çš„ç¼“å­˜é¡¹
      const cacheKeys = await this.cacheRepository.getAllKeys();
      const networkKeys = cacheKeys.filter(key => 
        key.includes('network_') || key.includes('http_') || key.includes('api_')
      );
      
      for (const key of networkKeys) {
        await this.cacheRepository.removeObject(key);
      }
    } catch (error) {
      Logger.warn(TAG, `Failed to clear network cache: ${error}`);
    }
  }
  
  /**
   * æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­?   */
  private async clearAllRelatedCache(): Promise<void> {
    try {
      // æ¸…é™¤é…ç½®ç¼“å­˜
      await this.cacheRepository.removeObject(CONFIG_CACHE_KEY);
      // æ¸…é™¤ç½‘ç»œç¼“å­˜
      await this.clearNetworkCache();
      // æ¸…é™¤å…¶ä»–å¯èƒ½å—é…ç½®å½±å“çš„ç¼“å­˜
      await this.cacheRepository.removeObject('live_hot_keywords');
    } catch (error) {
      Logger.warn(TAG, `Failed to clear related cache: ${error}`);
    }
  }
}


