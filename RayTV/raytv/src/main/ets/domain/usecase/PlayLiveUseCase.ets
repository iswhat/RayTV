// PlayLiveUseCase - æ’­æ”¾ç›´æ’­ç”¨ä¾‹
import Logger from '../../common/util/Logger';
import { Live } from '../../data/bean/Live';
import { History } from '../../data/bean/History';
import { LiveRepository } from '../../data/repository/LiveRepository';
import { HistoryRepository } from '../../data/repository/HistoryRepository';
import { CollectionRepository } from '../../data/repository/CollectionRepository';
import { LiveStreamRepository } from '../../data/repository/LiveStreamRepository';

const TAG = 'PlayLiveUseCase';

/**
 * æ’­æ”¾ç›´æ’­å†…å®¹çš„ä¸šåŠ¡ç”¨ä¾?
 */
export class PlayLiveUseCase {
  private liveRepository: LiveRepository;
  private historyRepository: HistoryRepository;
  private collectionRepository: CollectionRepository;
  private liveStreamRepository: LiveStreamRepository;
  
  constructor(
    liveRepository: LiveRepository,
    historyRepository: HistoryRepository,
    collectionRepository: CollectionRepository,
    liveStreamRepository: LiveStreamRepository
  ) {
    this.liveRepository = liveRepository;
    this.historyRepository = historyRepository;
    this.collectionRepository = collectionRepository;
    this.liveStreamRepository = liveStreamRepository;
  }
  
  /**
   * è·å–ç›´æ’­é¢‘é“åˆ†ç»„åˆ—è¡¨
   * @returns ç›´æ’­é¢‘é“åˆ†ç»„åˆ—è¡¨
   */
  public async getLiveGroups(): Promise<{ name: string; count: number }[]> {
    try {
      Logger.info(TAG, 'Loading live channel groups');
      const groups = await this.liveRepository.getLiveGroups();
      
      // ç»Ÿè®¡æ¯ä¸ªåˆ†ç»„çš„é¢‘é“æ•°é‡?
      const groupStats = await Promise.all(
        groups.map(async (groupName) => {
          const channels = await this.liveRepository.getLiveChannelsByGroup(groupName);
          return {
            name: groupName,
            count: channels.length
          };
        })
      );
      
      return groupStats;
    } catch (error) {
    Logger.error(TAG, `Failed to load live groups: ${error}`);
    throw error;
  }
  }
  
  /**
   * è·å–æŒ‡å®šåˆ†ç»„çš„ç›´æ’­é¢‘é?
   * @param groupName åˆ†ç»„åç§°
   * @returns ç›´æ’­é¢‘é“åˆ—è¡¨
   */
  public async getLiveChannelsByGroup(groupName: string): Promise<Live[]> {
    try {
      Logger.info(TAG, `Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}` instanceof Error ? `Loading live channels for group: ${groupName}` : new Error(String(`Loading live channels for group: ${groupName}`)))))));
      const channels = await this.liveRepository.getLiveChannelsByGroup(groupName);
      
      // å¹¶è¡Œæ£€æŸ¥æ¯ä¸ªé¢‘é“çš„æ”¶è—çŠ¶æ€?
      const channelsWithCollectionStatus = await Promise.all(
        channels.map(async (channel) => {
          const isCollected = await this.collectionRepository.isCollected(
            channel.id,
            channel.sourceKey
          );
          return {
            ...channel,
            isCollected
          };
        })
      );
      
      return channelsWithCollectionStatus;
    } catch (error) {
    Logger.error(TAG, `Failed to load live channels: ${error}`);
    throw error;
  }
  }
  
  /**
   * æœç´¢ç›´æ’­é¢‘é“
   * @param keyword æœç´¢å…³é”®è¯?
   * @returns åŒ¹é…çš„ç›´æ’­é¢‘é“åˆ—è¡?
   */
  public async searchLiveChannels(keyword: string): Promise<Live[]> {
    try {
      Logger.info(TAG, `Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}` instanceof Error ? `Searching live channels with keyword: ${keyword}` : new Error(String(`Searching live channels with keyword: ${keyword}`)))))));
      return await this.liveRepository.searchLiveChannels(keyword);
    } catch (error) {
    Logger.error(TAG, `Failed to search live channels: ${error}`);
    return [];
  }
  }
  
  /**
   * å‡†å¤‡æ’­æ”¾ç›´æ’­
   * @param liveChannel ç›´æ’­é¢‘é“
   * @returns å‡†å¤‡å¥½çš„ç›´æ’­é¢‘é“ä¿¡æ¯
   */
  public async prepareLivePlayback(liveChannel: Live): Promise<Live> {
    try {
      Logger.info(TAG, `Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}` instanceof Error ? `Preparing to play live channel: ${liveChannel.name}` : new Error(String(`Preparing to play live channel: ${liveChannel.name}`)))))));
      
      // æ£€æŸ¥å¹¶è§£æç›´æ’­æµURL
      let resolvedLive = { ...liveChannel };
      
      // å¦‚æœURLéœ€è¦è§£ææˆ–åˆ·æ–°
      if (!liveChannel.url || this.needsUrlResolution(liveChannel.url)) {
        const resolvedUrl = await this.liveStreamRepository.resolveLiveStreamUrl(
          liveChannel.url,
          liveChannel.headers
        );
        resolvedLive.url = resolvedUrl;
      }
      
      // è®°å½•è§‚çœ‹å†å²
      const history: History = {
        id: liveChannel.id,
        contentId: liveChannel.id,
        contentName: liveChannel.name,
        type: 'live',
        cover: liveChannel.logo,
        sourceKey: liveChannel.sourceKey,
        position: Date.now(), // å¯¹äºç›´æ’­ï¼Œè®°å½•å¼€å§‹è§‚çœ‹æ—¶é—?
        duration: 0,
        lastPlayedAt: Date.now(),
        createdAt: Date.now()
      };
      
      await this.historyRepository.saveHistory(history);
      
      // æ›´æ–°é¢‘é“è§‚çœ‹æ¬¡æ•°ï¼ˆå¦‚æœæœ‰è¿™ä¸ªåŠŸèƒ½ï¼?
      await this.liveRepository.incrementWatchCount(liveChannel.id, liveChannel.sourceKey);
      
      return resolvedLive;
    } catch (error) {
    Logger.error(TAG, `Failed to prepare live playback: ${error}`);
    throw error;
  }
  }
  
  /**
   * è·å–ç›´æ’­EPGï¼ˆç”µå­èŠ‚ç›®å•ï¼?
   * @param channelId é¢‘é“ID
   * @param date æ—¥æœŸï¼Œé»˜è®¤ä¸ºä»Šå¤©
   * @returns èŠ‚ç›®å•ä¿¡æ?
   */
  public async getEpgForChannel(
    channelId: string, date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date( : new Error(String(date: Date = new Date( instanceof Error ? date: Date = new Date( : new Error(String(date: Date = new Date()))))))
  ): Promise<Array<{ title: string; startTime: Date; endTime: Date; current?: boolean }>> {
    try {
      Logger.info(TAG, `Loading EPG for channel: ${channelId}, date: ${date.toDateString()}`);
      return await this.liveStreamRepository.getEpgForChannel(channelId, date);
    } catch (error) {
    Logger.error(TAG, `Failed to load EPG: ${error}`);
    return [];
  }
  }
  
  /**
   * æ”¶è—/å–æ¶ˆæ”¶è—ç›´æ’­é¢‘é“
   * @param liveChannel ç›´æ’­é¢‘é“
   * @returns æ”¶è—çŠ¶æ€?
   */
  public async toggleCollection(liveChannel: Live): Promise<boolean> {
    try {
      const isCurrentlyCollected = await this.collectionRepository.isCollected(
        liveChannel.id, liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
       instanceof Error ? liveChannel.sourceKey
       : new Error(String(liveChannel.sourceKey
      )))))));
      
      if (isCurrentlyCollected) {
        await this.collectionRepository.removeCollection(
          liveChannel.id,
          liveChannel.sourceKey
        );
        Logger.info(TAG, `Uncollected live channel: ${liveChannel.name}`);
        return false;
      } else {
        await this.collectionRepository.addCollection({
          id: liveChannel.id,
          name: liveChannel.name,
          type: 'live',
          cover: liveChannel.logo,
          sourceKey: liveChannel.sourceKey,
          addedAt: Date.now()
        });
        Logger.info(TAG, `Collected live channel: ${liveChannel.name}`);
        return true;
      }
    } catch (error) {
    Logger.error(TAG, `Failed to toggle live channel collection: ${error}`);
    throw error;
  }
  }
  
  /**
   * åˆ·æ–°ç›´æ’­æº?
   * @param liveChannel ç›´æ’­é¢‘é“
   * @returns åˆ·æ–°åçš„ç›´æ’­é¢‘é“
   */
  public async refreshLiveSource(liveChannel: Live): Promise<Live> {
    try {
      Logger.info(TAG, `Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}` instanceof Error ? `Refreshing live source for: ${liveChannel.name}` : new Error(String(`Refreshing live source for: ${liveChannel.name}`)))))));
      
      const refreshedUrl = await this.liveStreamRepository.refreshLiveStreamUrl(
        liveChannel.url,
        liveChannel.headers
      );
      
      const refreshedChannel: Record<string, string | number | boolean | null> = { ... };
      
      // æ›´æ–°æœ¬åœ°ç¼“å­˜
      await this.liveRepository.updateLiveChannel(refreshedChannel);
      
      return refreshedChannel;
    } catch (error) {
    Logger.error(TAG, `Failed to refresh live source: ${error}`);
    throw error;
  }
  }
  
  /**
   * æ£€æŸ¥URLæ˜¯å¦éœ€è¦è§£æ?
   * @param url åŸå§‹URL
   * @returns æ˜¯å¦éœ€è¦è§£æ?
   */
  private needsUrlResolution(url: string): boolean {
    // ç®€å•åˆ¤æ–­é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ‰©å±?
    return !url.startsWith('http') || url.includes('placeholder') || url.includes('resolve');
  }
}


