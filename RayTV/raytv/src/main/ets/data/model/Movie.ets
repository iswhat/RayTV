// Movie - ç”µå½±/è§†é¢‘å®ä½“ç±?import Logger from '../../common/util/Logger';
import DateUtil from '../../common/util/DateUtil';

const TAG = 'Movie';

/**
 * è§†é¢‘è´¨é‡æšä¸¾
 */
export enum VideoQuality {
  SD,     // æ ‡æ¸…
  HD,     // é«˜æ¸…
  FHD,    // å…¨é«˜æ¸?  UHD,    // 4Kè¶…é«˜æ¸?  HDR     // HDR
}

/**
 * è§†é¢‘ç±»å‹æšä¸¾
 */
export enum VideoType {
  MOVIE,      // ç”µå½±
  TV_SERIES,  // ç”µè§†å‰?  ANIME,      // åŠ¨æ¼«
  DOCUMENTARY,// çºªå½•ç‰?  VARIETY,    // ç»¼è‰º
  LIVE,       // ç›´æ’­
  OTHER       // å…¶ä»–
}

/**
 * Movieåºåˆ—åŒ–æ¥å? */
export interface MovieSerializable {
  id?: string;
  title?: string;
  originalTitle?: string;
  type?: VideoType;
  coverUrl?: string;
  backdropUrl?: string;
  overview?: string;
  releaseDate?: string;
  genres?: string[];
  tags?: string[];
  ratings?: RatingInfo[];
  directors?: string[];
  actors?: string[];
  countries?: string[];
  languages?: string[];
  duration?: number;
  totalEpisodes?: number;
  currentSeason?: number;
  episodes?: Episode[];
  recommended?: boolean;
  favorite?: boolean;
  watchedProgress?: number;
  playCount?: number;
  updateTime?: string;
  sources?: VideoSource[];
  score?: number;
  year?: number;
}

/**
 * è¯„åˆ†ä¿¡æ¯æ¥å£
 */
export interface RatingInfo {
  score: number;     // è¯„åˆ†
  source: string;    // è¯„åˆ†æ¥æº
  count: number;     // è¯„åˆ†äººæ•°
}

/**
 * éŸ³è½¨ä¿¡æ¯æ¥å£
 */
export interface AudioTrack {
  id: string;
  name: string;
  url: string;
}

/**
 * å­—å¹•ä¿¡æ¯æ¥å£
 */
export interface SubtitleTrack {
  id: string;
  name: string;
  url: string;
  language: string;
}

/**
 * è§†é¢‘æ’­æ”¾æºæ¥å? */
export interface VideoSource {
  id: string;          // æ’­æ”¾æºID
  name: string;        // æ’­æ”¾æºåç§?  url: string;         // æ’­æ”¾åœ°å€
  quality: VideoQuality; // è§†é¢‘è´¨é‡
  format: string;      // è§†é¢‘æ ¼å¼
  size?: number;       // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  duration?: number;   // æ—¶é•¿ï¼ˆç§’ï¼?  resolution?: string; // åˆ†è¾¨ç?  audioTracks?: Array<AudioTrack>; // éŸ³è½¨åˆ—è¡¨
  subtitleTracks?: Array<SubtitleTrack>; // å­—å¹•åˆ—è¡¨
}

/**
 * å‰§é›†ä¿¡æ¯æ¥å£
 */
export interface Episode {
  id: string;           // å‰§é›†ID
  season: number;       // å­£æ•°
  episode: number;      // é›†æ•°
  title: string;        // å‰§é›†æ ‡é¢˜
  duration?: number;    // æ—¶é•¿ï¼ˆç§’ï¼?  airDate?: string;     // æ’­å‡ºæ—¥æœŸ
  overview?: string;    // å‰§é›†ç®€ä»?  sources: VideoSource[]; // æ’­æ”¾æºåˆ—è¡?  watchedProgress?: number; // è§‚çœ‹è¿›åº¦ï¼ˆç§’ï¼?  isWatched?: boolean;   // æ˜¯å¦å·²è§‚çœ?}

/**
 * ç”µå½±/è§†é¢‘å®ä½“ç±? * å®šä¹‰è§†é¢‘å†…å®¹çš„åŸºæœ¬å±æ€§å’Œç›¸å…³æ“ä½œ
 */
export default class Movie {
  id: string;                  // å”¯ä¸€æ ‡è¯†ç¬?  title: string;               // æ ‡é¢˜
  originalTitle?: string;      // åŸå§‹æ ‡é¢˜
  type: VideoType;             // è§†é¢‘ç±»å‹
  coverUrl?: string;           // å°é¢å›¾URL
  backdropUrl?: string;        // èƒŒæ™¯å›¾URL
  overview?: string;           // ç®€ä»?  releaseDate?: string;        // ä¸Šæ˜ æ—¥æœŸ
  genres?: string[];           // ç±»å‹æ ‡ç­¾
  tags?: string[];             // æ ‡ç­¾
  ratings?: RatingInfo[];      // è¯„åˆ†ä¿¡æ¯
  directors?: string[];        // å¯¼æ¼”
  actors?: string[];           // æ¼”å‘˜
  countries?: string[];        // åˆ¶ç‰‡å›½å®¶/åœ°åŒº
  languages?: string[];        // è¯­è¨€
  duration?: number;           // æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  totalEpisodes?: number;      // æ€»é›†æ•?  currentSeason?: number;      // å½“å‰å­£æ•°
  episodes?: Episode[];        // å‰§é›†åˆ—è¡¨
  recommended?: boolean;       // æ˜¯å¦æ¨è
  favorite?: boolean;          // æ˜¯å¦æ”¶è—
  watchedProgress?: number;    // è§‚çœ‹è¿›åº¦ï¼ˆç§’ï¼?  playCount?: number;          // æ’­æ”¾æ¬¡æ•°
  updateTime?: string;         // æ›´æ–°æ—¶é—´
  sources?: VideoSource[];     // æ’­æ”¾æºåˆ—è¡?  score?: number;              // ç»¼åˆè¯„åˆ†ï¼ˆç”¨äºæ’åºï¼‰
  year?: number;               // å¹´ä»½

  /**
   * æ„é€ å‡½æ•?   */
  constructor(data: Partial<Movie>) {
    this.id = data.id || `movie_${DateUtil.getTimestamp()}_${Math.random().toString(36).substring(2, 11)}`;
    this.title = data.title || '';
    this.originalTitle = data.originalTitle;
    this.type = data.type || VideoType.OTHER;
    this.coverUrl = data.coverUrl;
    this.backdropUrl = data.backdropUrl;
    this.overview = data.overview;
    this.releaseDate = data.releaseDate;
    this.genres = data.genres || [];
    this.tags = data.tags || [];
    this.ratings = data.ratings || [];
    this.directors = data.directors || [];
    this.actors = data.actors || [];
    this.countries = data.countries || [];
    this.languages = data.languages || [];
    this.duration = data.duration;
    this.totalEpisodes = data.totalEpisodes;
    this.currentSeason = data.currentSeason;
    this.episodes = data.episodes || [];
    // æ˜ç¡®åˆå§‹åŒ–å¸ƒå°”å€¼ï¼Œé¿å…undefined
    this.recommended = !!data.recommended;
    this.favorite = !!data.favorite;
    this.watchedProgress = data.watchedProgress || 0;
    this.playCount = data.playCount || 0;
    this.updateTime = data.updateTime || DateUtil.format(new Date());
    this.sources = data.sources || [];
    this.score = data.score;
    // å®‰å…¨å¤„ç†æ—¥æœŸè½¬æ¢
    this.year = data.year || (data.releaseDate ? new Date(data.releaseDate).getFullYear() : undefined);
  }

  /**
   * è·å–ç»¼åˆè¯„åˆ†
   * @returns ç»¼åˆè¯„åˆ†
   */
  public getAverageRating(): number {
    if (!this.ratings || this.ratings.length === 0) {
      return this.score || 0;
    }

    const totalScore = this.ratings.reduce((sum, rating) => sum + rating.score, 0);
    return Number((totalScore / this.ratings.length).toFixed(1));
  }

  /**
   * è·å–ä¸»è¦è¯„åˆ†ä¿¡æ¯
   * @returns ä¸»è¦è¯„åˆ†
   */
  public getMainRating(): RatingInfo | null {
    if (!this.ratings || this.ratings.length === 0) {
      return null;
    }

    // è¿”å›è¯„åˆ†äººæ•°æœ€å¤šçš„è¯„åˆ†æ¥æº
    return this.ratings.sort((a, b) => b.count - a.count)[0];
  }

  /**
   * è·å–æ ¼å¼åŒ–çš„æ—¶é•¿
   * @returns æ ¼å¼åŒ–çš„æ—¶é•¿å­—ç¬¦ä¸?   */
  public getFormattedDuration(): string {
    if (!this.duration) {
      return 'æœªçŸ¥';
    }
    return DateUtil.formatDuration(this.duration);
  }

  /**
   * è·å–æ ¼å¼åŒ–çš„ä¸Šæ˜ æ—¥æœŸ
   * @returns æ ¼å¼åŒ–çš„æ—¥æœŸå­—ç¬¦ä¸?   */
  public getFormattedReleaseDate(): string {
    if (!this.releaseDate) {
      return 'æœªçŸ¥';
    }
    return DateUtil.format(this.releaseDate, 'YYYY-MM-DD');
  }

  /**
   * è·å–ç±»å‹å­—ç¬¦ä¸?   * @returns ç±»å‹å­—ç¬¦ä¸?   */
  public getGenresString(): string {
    if (!this.genres || this.genres.length === 0) {
      return 'æœªçŸ¥';
    }
    return this.genres.join(' / ');
  }

  /**
   * è·å–å¯¼æ¼”å­—ç¬¦ä¸?   * @returns å¯¼æ¼”å­—ç¬¦ä¸?   */
  public getDirectorsString(): string {
    if (!this.directors || this.directors.length === 0) {
      return 'æœªçŸ¥';
    }
    return this.directors.join('ã€?);
  }

  /**
   * è·å–æ¼”å‘˜å­—ç¬¦ä¸²ï¼ˆé™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼?   * @param maxCount æœ€å¤§æ˜¾ç¤ºæ•°é‡?   * @returns æ¼”å‘˜å­—ç¬¦ä¸?   */
  public getActorsString(maxCount: number = 5): string {
    if (!this.actors || this.actors.length === 0) {
      return 'æœªçŸ¥';
    }

    if (this.actors.length <= maxCount) {
      return this.actors.join('ã€?);
    }

    return `${this.actors.slice(0, maxCount).join('ã€?)}...ç­?{this.actors.length}äºº`;
  }

  /**
   * æ›´æ–°è§‚çœ‹è¿›åº¦
   * @param progress è¿›åº¦ï¼ˆç§’ï¼?   * @param episodeId å‰§é›†IDï¼ˆå¯é€‰ï¼‰
   */
  public updateWatchedProgress(progress: number, episodeId?: string): void {
    this.watchedProgress = progress;
    this.playCount = (this.playCount || 0) + 1;
    this.updateTime = DateUtil.format(new Date());

    // æ›´æ–°å¯¹åº”å‰§é›†çš„è¿›åº?    if (episodeId && this.episodes && this.episodes.length > 0) {
      const episode = this.episodes.find(e => e.id === episodeId);
      if (episode != null) {
        episode.watchedProgress = progress;
        // å¦‚æœè§‚çœ‹è¿›åº¦è¶…è¿‡æ€»æ—¶é•¿çš„90%ï¼Œæ ‡è®°ä¸ºå·²è§‚çœ?        if (episode.duration && progress >= episode.duration * 0.9) {
          episode.isWatched = true;
        }
      }
    }
  }

  /**
   * åˆ‡æ¢æ”¶è—çŠ¶æ€?   * @returns æ–°çš„æ”¶è—çŠ¶æ€?   */
  public toggleFavorite(): boolean {
    this.favorite = !this.favorite;
    return this.favorite;
  }

  /**
   * è·å–è§†é¢‘ç±»å‹çš„æ–‡æœ¬æè¿?   * @returns ç±»å‹æè¿°
   */
  public getTypeDescription(): string {
    switch (this.type) {
      case VideoType.MOVIE:
        return 'ç”µå½±';
      case VideoType.TV_SERIES:
        return 'ç”µè§†å‰?;
      case VideoType.ANIME:
        return 'åŠ¨æ¼«';
      case VideoType.DOCUMENTARY:
        return 'çºªå½•ç‰?;
      case VideoType.VARIETY:
        return 'ç»¼è‰º';
      case VideoType.LIVE:
        return 'ç›´æ’­';
      default:
        return 'å…¶ä»–';
    }
  }

  /**
   * è·å–è§‚çœ‹è¿›åº¦ç™¾åˆ†æ¯?   * @returns è¿›åº¦ç™¾åˆ†æ¯?   */
  public getProgressPercentage(): number {
    const watchedProgress = this.watchedProgress || 0;
    const duration = this.duration || 1;
    return Math.min(100, Math.round(watchedProgress / duration * 100));
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºå¤šé›†å†…å®¹
   * @returns æ˜¯å¦ä¸ºå¤šé›?   */
  public isMultiEpisode(): boolean {
    return this.type === VideoType.TV_SERIES || 
           this.type === VideoType.ANIME || 
           (this.episodes != null && this.episodes.length > 1);
  }

  /**
   * è·å–å·²è§‚çœ‹çš„é›†æ•°
   * @returns å·²è§‚çœ‹é›†æ•?   */
  public getWatchedEpisodeCount(): number {
    if (!this.episodes || this.episodes.length === 0) {
      return 0;
    }
    // ç¡®ä¿isWatchedæ˜¯æ˜ç¡®çš„å¸ƒå°”å€¼ï¼Œå¤„ç†undefinedæƒ…å†µ
    return this.episodes.filter(episode => {
      // ç¡®ä¿episodeå¯¹è±¡å­˜åœ¨ä¸”isWatchedä¸ºtrue
      return episode != null && episode.isWatched === true;
    }).length;
  }

  /**
   * åºåˆ—åŒ–å¯¹è±¡ï¼ˆç”¨äºå­˜å‚¨ï¼?   * @returns åºåˆ—åŒ–åçš„å¯¹è±?   */
  public toSerializable(): MovieSerializable {
    // ä½¿ç”¨ä¸“ç”¨çš„åºåˆ—åŒ–æ¥å£ï¼Œç¬¦åˆArkTSè§„èŒƒ
    const result: MovieSerializable = {
      id: this.id,
      title: this.title,
      originalTitle: this.originalTitle,
      type: this.type,
      coverUrl: this.coverUrl,
      backdropUrl: this.backdropUrl,
      overview: this.overview,
      releaseDate: this.releaseDate,
      genres: this.genres,
      tags: this.tags,
      ratings: this.ratings,
      directors: this.directors,
      actors: this.actors,
      countries: this.countries,
      languages: this.languages,
      duration: this.duration,
      totalEpisodes: this.totalEpisodes,
      currentSeason: this.currentSeason,
      episodes: this.episodes,
      recommended: this.recommended,
      favorite: this.favorite,
      watchedProgress: this.watchedProgress,
      playCount: this.playCount,
      updateTime: this.updateTime,
      sources: this.sources,
      score: this.score,
      year: this.year
    };
    return result;
  }

  /**
   * ä»åºåˆ—åŒ–å¯¹è±¡åˆ›å»ºMovieå®ä¾‹
   * @param data åºåˆ—åŒ–çš„æ•°æ®
   * @returns Movieå®ä¾‹
   */
  public static fromSerializable(data: Partial<Movie>): Movie {
    return new Movie(data);
  }

  /**
   * å…‹éš†Movieå®ä¾‹
   * @returns å…‹éš†åçš„å®ä¾‹
   */
  public clone(): Movie {
    return new Movie(this.toSerializable());
  }
}
