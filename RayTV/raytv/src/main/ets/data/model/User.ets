// User - ç”¨æˆ·å®ä½“ç±?import Logger from '../../common/util/Logger';
import DateUtil from '../../common/util/DateUtil';

const TAG = 'User';

/**
 * ç”¨æˆ·è§’è‰²æšä¸¾
 */
export enum UserRole {
  GUEST,      // è®¿å®¢
  REGULAR,    // æ™®é€šç”¨æˆ?  VIP,        // VIPç”¨æˆ·
  ADMIN       // ç®¡ç†å‘?}

/**
 * ç”¨æˆ·åå¥½è®¾ç½®æ¥å£
 */
export interface UserPreferences {
  theme?: 'light' | 'dark' | 'system';  // ä¸»é¢˜åå¥½
  language?: string;                    // è¯­è¨€åå¥½
  playerDefaultQuality?: string;        // é»˜è®¤æ’­æ”¾è´¨é‡
  autoplay?: boolean;                   // æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
  subtitleEnabled?: boolean;            // æ˜¯å¦å¯ç”¨å­—å¹•
  defaultSubtitleLanguage?: string;     // é»˜è®¤å­—å¹•è¯­è¨€
  audioLanguage?: string;               // éŸ³é¢‘è¯­è¨€
  maxConcurrentDownloads?: number;      // æœ€å¤§å¹¶å‘ä¸‹è½½æ•°
  parentalControlEnabled?: boolean;     // æ˜¯å¦å¯ç”¨å®¶é•¿æ§åˆ¶
  parentalControlLevel?: number;        // å®¶é•¿æ§åˆ¶çº§åˆ«
  searchHistoryEnabled?: boolean;       // æ˜¯å¦ä¿å­˜æœç´¢å†å²
  playbackSpeed?: number;               // é»˜è®¤æ’­æ”¾é€Ÿåº¦
  // ç§»é™¤ç´¢å¼•ç­¾åï¼Œç¬¦åˆArkTSè§„èŒƒ
}

/**
 * è®¾å¤‡ä¿¡æ¯æ¥å£
 */
export interface DeviceInfo {
  deviceId: string;         // è®¾å¤‡å”¯ä¸€æ ‡è¯†
  deviceName: string;       // è®¾å¤‡åç§°
  deviceType: string;       // è®¾å¤‡ç±»å‹
  lastActiveTime: string;   // æœ€åæ´»è·ƒæ—¶é—?  osVersion?: string;       // æ“ä½œç³»ç»Ÿç‰ˆæœ¬
  appVersion?: string;      // åº”ç”¨ç‰ˆæœ¬
  ipAddress?: string;       // IPåœ°å€ï¼ˆå¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºï¼?}

/**
 * ç”¨æˆ·è®¾ç½®ç±»å‹å®šä¹‰
 * æ›¿æ¢ç´¢å¼•ç­¾åä¸ºå…·ä½“å±æ€§ï¼Œç¬¦åˆArkTSè§„èŒƒ
 */
export interface UserSettings {
  // é¢„å®šä¹‰å¸¸è§è®¾ç½®é¡¹ï¼Œé¿å…ä½¿ç”¨ç´¢å¼•ç­¾å?  notificationsEnabled?: boolean;
  autoPlayEnabled?: boolean;
  defaultLanguage?: string;
  themePreference?: string;
  subtitleSize?: number;
  // å…¶ä»–è®¾ç½®ä½¿ç”¨Mapå­˜å‚¨ï¼Œæä¾›ç±»å‹å®‰å…¨çš„è®¿é—®æ–¹æ³•
}

/**
 * ç”¨æˆ·åºåˆ—åŒ–æ•°æ®æ¥å? * å®šä¹‰toSerializableæ–¹æ³•è¿”å›çš„å¯¹è±¡ç»“æ? */
export interface UserSerializableData {
  id: string | null;
  username: string | null;
  nickname: string | null;
  email: string | null;
  avatarUrl: string | null;
  role: number;
  preferences: UserPreferences | null;
  lastLoginTime: string | null;
  registrationDate: string | null;
  activeDevices: DeviceInfo[] | null;
  isVerified: boolean;
  status: string;
  subscriptionEndDate: string | null;
  watchHistoryEnabled: boolean;
  favoritesEnabled: boolean;
  totalWatchTime: number;
  settings: UserSettings | null;
}

/**
 * ç”¨æˆ·å®ä½“ç±? * å®šä¹‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å’Œç›¸å…³æ“ä½œ
 */
export default class User {
  id: string;                    // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  username: string;              // ç”¨æˆ·å?  nickname?: string;             // æ˜µç§°
  email?: string;                // é‚®ç®±
  avatarUrl?: string;            // å¤´åƒURL
  role: UserRole;                // ç”¨æˆ·è§’è‰²
  preferences?: UserPreferences; // ç”¨æˆ·åå¥½è®¾ç½®
  lastLoginTime?: string;        // æœ€åç™»å½•æ—¶é—?  registrationDate?: string;     // æ³¨å†Œæ—¥æœŸ
  activeDevices?: DeviceInfo[];  // æ´»è·ƒè®¾å¤‡åˆ—è¡¨
  isVerified?: boolean;          // æ˜¯å¦å·²éªŒè¯?  status?: 'active' | 'inactive' | 'suspended'; // è´¦æˆ·çŠ¶æ€?  subscriptionEndDate?: string;  // è®¢é˜…åˆ°æœŸæ—¥æœŸ
  watchHistoryEnabled?: boolean; // æ˜¯å¦å¯ç”¨è§‚çœ‹å†å²
  favoritesEnabled?: boolean;    // æ˜¯å¦å¯ç”¨æ”¶è—
  totalWatchTime?: number;       // æ€»è§‚çœ‹æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼?  settings?: UserSettings; // å…¶ä»–è®¾ç½®

  /**
   * æ„é€ å‡½æ•?   */
  constructor(data: Partial<User>) {
    // åˆ›å»ºå±€éƒ¨å˜é‡å­˜å‚¨IDå’Œç”¨æˆ·åï¼Œé¿å…ç›´æ¥ä½¿ç”¨Userç±»ä½œä¸ºå¯¹è±?    const defaultId = `user_${DateUtil.getTimestamp()}_${Math.random().toString(36).substr(2, 9)}`;
    const defaultUsername = `user_${Math.random().toString(36).substr(2, 8)}`;
    
    // ä¿®å¤undefinedèµ‹å€¼é—®é¢˜ï¼Œä½¿ç”¨??è¿ç®—ç¬¦æ›¿ä»£||
    this.id = data.id ?? defaultId;
    this.username = data.username ?? defaultUsername;
    this.nickname = data.nickname ?? this.username;
    this.email = data.email;
    this.avatarUrl = data.avatarUrl;
    this.role = data.role ?? UserRole.REGULAR;
    this.preferences = data.preferences ?? this.getDefaultPreferences();
    this.lastLoginTime = data.lastLoginTime ?? DateUtil.format(new Date());
    this.registrationDate = data.registrationDate ?? DateUtil.format(new Date());
    this.activeDevices = data.activeDevices ?? [];
    this.isVerified = data.isVerified ?? false;
    this.status = data.status ?? 'active';
    this.subscriptionEndDate = data.subscriptionEndDate;
    this.watchHistoryEnabled = data.watchHistoryEnabled !== undefined ? data.watchHistoryEnabled : true;
    this.favoritesEnabled = data.favoritesEnabled !== undefined ? data.favoritesEnabled : true;
    this.totalWatchTime = data.totalWatchTime ?? 0;
    
    // å®‰å…¨å¤„ç†settingså¯¹è±¡ï¼Œé¿å…ç±»ä½œä¸ºå¯¹è±¡ä½¿ç”¨å’Œç›´æ¥ç±»å‹æ–­è¨€
    if (data.settings && typeof data.settings === 'object' && !Array.isArray(data.settings)) {
      // åˆ›å»ºä¸€ä¸ªæ–°çš„ç¬¦åˆUserSettingsæ¥å£çš„å¯¹è±?      this.settings = this.createSafeUserSettings(data.settings);
    } else {
      // ä½¿ç”¨æ˜ç¡®çš„ç©ºå¯¹è±¡ï¼Œä¸è¿›è¡Œç±»å‹æ–­è¨€
      this.settings = {};
    }
  }

  /**
   * è·å–é»˜è®¤åå¥½è®¾ç½®
   * @returns é»˜è®¤åå¥½è®¾ç½®
   */
  private getDefaultPreferences(): UserPreferences {
    const result: UserPreferences = {} as UserPreferences;
    result.theme = 'system';
    result.language = 'zh-CN';
    result.playerDefaultQuality = 'HD';
    result.autoplay = true;
    result.subtitleEnabled = false;
    result.defaultSubtitleLanguage = 'zh-CN';
    result.audioLanguage = 'zh-CN';
    result.maxConcurrentDownloads = 3;
    result.parentalControlEnabled = false;
    result.parentalControlLevel = 0;
    result.searchHistoryEnabled = true;
    result.playbackSpeed = 1.0;
    return result;
  }

  /**
   * åˆå¹¶åå¥½è®¾ç½®ï¼ˆæ›¿ä»£Object.assignï¼?   * @param base åŸºç¡€åå¥½è®¾ç½®
   * @param updates è¦æ›´æ–°çš„åå¥½è®¾ç½®
   * @returns åˆå¹¶åçš„åå¥½è®¾ç½®
   */
  private mergePreferences(base: UserPreferences, updates: Partial<UserPreferences> | null | undefined): UserPreferences {
    // å®‰å…¨æ£€æŸ¥æ›´æ–°å¯¹è±?    if (!updates || typeof updates !== 'object') {
      // æ‰‹åŠ¨å¤åˆ¶å±æ€§ï¼Œæ›¿ä»£å±•å¼€æ“ä½œç¬?      return {
        theme: base.theme,
        language: base.language,
        playerDefaultQuality: base.playerDefaultQuality,
        autoplay: base.autoplay,
        subtitleEnabled: base.subtitleEnabled,
        defaultSubtitleLanguage: base.defaultSubtitleLanguage,
        audioLanguage: base.audioLanguage,
        maxConcurrentDownloads: base.maxConcurrentDownloads,
        parentalControlEnabled: base.parentalControlEnabled,
        parentalControlLevel: base.parentalControlLevel,
        searchHistoryEnabled: base.searchHistoryEnabled,
        playbackSpeed: base.playbackSpeed
      };
    }
    
    // ç¡®ä¿åŸºç¡€åå¥½è®¾ç½®å­˜åœ¨
    if (!base || typeof base !== 'object') {
      return this.getDefaultPreferences();
    }
    
    // ä¸ä½¿ç”¨å±•å¼€æ“ä½œç¬¦ï¼Œæ‰‹åŠ¨åˆ›å»ºå¹¶å¤åˆ¶å±æ€?    const result: UserPreferences = {
      theme: base.theme,
      language: base.language,
      playerDefaultQuality: base.playerDefaultQuality,
      autoplay: base.autoplay,
      subtitleEnabled: base.subtitleEnabled,
      defaultSubtitleLanguage: base.defaultSubtitleLanguage,
      audioLanguage: base.audioLanguage,
      maxConcurrentDownloads: base.maxConcurrentDownloads,
      parentalControlEnabled: base.parentalControlEnabled,
      parentalControlLevel: base.parentalControlLevel,
      searchHistoryEnabled: base.searchHistoryEnabled,
      playbackSpeed: base.playbackSpeed
    };
    
    // æ‰‹åŠ¨åˆå¹¶æ¯ä¸ªå±æ€?    if (updates.theme !== undefined) result.theme = updates.theme;
    if (updates.language !== undefined) result.language = updates.language;
    if (updates.playerDefaultQuality !== undefined) result.playerDefaultQuality = updates.playerDefaultQuality;
    if (updates.autoplay !== undefined) result.autoplay = updates.autoplay;
    if (updates.subtitleEnabled !== undefined) result.subtitleEnabled = updates.subtitleEnabled;
    if (updates.defaultSubtitleLanguage !== undefined) result.defaultSubtitleLanguage = updates.defaultSubtitleLanguage;
    if (updates.audioLanguage !== undefined) result.audioLanguage = updates.audioLanguage;
    if (updates.maxConcurrentDownloads !== undefined) result.maxConcurrentDownloads = updates.maxConcurrentDownloads;
    if (updates.parentalControlEnabled !== undefined) result.parentalControlEnabled = updates.parentalControlEnabled;
    if (updates.parentalControlLevel !== undefined) result.parentalControlLevel = updates.parentalControlLevel;
    if (updates.searchHistoryEnabled !== undefined) result.searchHistoryEnabled = updates.searchHistoryEnabled;
    if (updates.playbackSpeed !== undefined) result.playbackSpeed = updates.playbackSpeed;
    
    return result;
  }

  /**
   * æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®
   * @param preferences è¦æ›´æ–°çš„åå¥½è®¾ç½®
   */
  public updatePreferences(preferences: Partial<UserPreferences>): void {
    if (!this.preferences) {
      this.preferences = this.getDefaultPreferences();
    }
    this.preferences = this.mergePreferences(this.preferences, preferences);
  }

  /**
   * è·å–ç”¨æˆ·æ˜¾ç¤ºåç§°ï¼ˆä¼˜å…ˆä½¿ç”¨æ˜µç§°ï¼‰
   * @returns æ˜¾ç¤ºåç§°
   */
  public getDisplayName(): string {
    return this.nickname || this.username || 'æœªå‘½åç”¨æˆ?;
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºVIP
   * @returns æ˜¯å¦ä¸ºVIP
   */
  public isVip(): boolean {
    if (this.role === UserRole.ADMIN || this.role === UserRole.VIP) {
      // å¦‚æœæ˜¯VIPæˆ–ç®¡ç†å‘˜è§’è‰²ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥è®¢é˜…æ˜¯å¦è¿‡æœ?      if (!this.subscriptionEndDate) {
        return true; // æ²¡æœ‰è®¢é˜…æœŸé™çš„VIPæ°¸ä¹…æœ‰æ•ˆ
      }
      
      const now = new Date();
      const endDate = new Date(this.subscriptionEndDate);
      return now <= endDate;
    }
    return false;
  }

  /**
   * è·å–ç”¨æˆ·è§’è‰²çš„æ–‡æœ¬æè¿?   * @returns è§’è‰²æè¿°
   */
  public getRoleDescription(): string {
    switch (this.role) {
      case UserRole.ADMIN:
        return 'ç®¡ç†å‘?;
      case UserRole.VIP:
        return this.isVip() ? 'VIPç”¨æˆ·' : 'VIPå·²è¿‡æœ?;
      case UserRole.REGULAR:
        return 'æ™®é€šç”¨æˆ?;
      case UserRole.GUEST:
        return 'è®¿å®¢';
      default:
        return 'æœªçŸ¥è§’è‰²';
    }
  }

  /**
   * æ›´æ–°ç™»å½•æ—¶é—´
   */
  public updateLastLoginTime(): void {
    this.lastLoginTime = DateUtil.format(new Date());
  }

  /**
   * æ·»åŠ æ´»è·ƒè®¾å¤‡
   * @param deviceInfo è®¾å¤‡ä¿¡æ¯
   */
  public addActiveDevice(deviceInfo: DeviceInfo): void {
    if (!this.activeDevices) {
      this.activeDevices = [];
    }

    // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²å­˜åœ¨
    const existingIndex = this.activeDevices.findIndex(device => device.deviceId === deviceInfo.deviceId);
    
    if (existingIndex >= 0) {
      // æ›´æ–°ç°æœ‰è®¾å¤‡çš„ä¿¡æ?      const existingDevice = this.activeDevices[existingIndex];
      this.activeDevices[existingIndex] = {
        deviceId: deviceInfo.deviceId || existingDevice.deviceId,
        deviceName: deviceInfo.deviceName || existingDevice.deviceName,
        deviceType: deviceInfo.deviceType || existingDevice.deviceType,
        lastActiveTime: DateUtil.format(new Date()),
        osVersion: deviceInfo.osVersion || existingDevice.osVersion,
        appVersion: deviceInfo.appVersion || existingDevice.appVersion,
        ipAddress: deviceInfo.ipAddress || existingDevice.ipAddress
      };
    } else {
      // æ·»åŠ æ–°è®¾å¤?      const newDevice: DeviceInfo = {
        deviceId: deviceInfo.deviceId,
        deviceName: deviceInfo.deviceName,
        deviceType: deviceInfo.deviceType,
        lastActiveTime: DateUtil.format(new Date()),
        osVersion: deviceInfo.osVersion,
        appVersion: deviceInfo.appVersion,
        ipAddress: deviceInfo.ipAddress
      };
      this.activeDevices.push(newDevice);
    }
  }

  /**
   * ç§»é™¤æ´»è·ƒè®¾å¤‡
   * @param deviceId è®¾å¤‡ID
   * @returns æ˜¯å¦æˆåŠŸç§»é™¤
   */
  public removeActiveDevice(deviceId: string): boolean {
    if (!this.activeDevices) {
      return false;
    }

    const initialLength = this.activeDevices.length;
    this.activeDevices = this.activeDevices.filter(device => device.deviceId !== deviceId);
    return this.activeDevices.length < initialLength;
  }

  /**
   * æ›´æ–°æ€»è§‚çœ‹æ—¶é•?   * @param minutes å¢åŠ çš„åˆ†é’Ÿæ•°
   */
  public updateWatchTime(minutes: number): void {
    this.totalWatchTime = (this.totalWatchTime || 0) + minutes;
  }

  /**
   * è·å–æ ¼å¼åŒ–çš„æ€»è§‚çœ‹æ—¶é•?   * @returns æ ¼å¼åŒ–çš„æ—¶é•¿å­—ç¬¦ä¸?   */
  public getFormattedWatchTime(): string {
    const totalMinutes = this.totalWatchTime || 0;
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;

    if (hours > 0) {
      return `${hours}å°æ—¶${minutes > 0 ? ` ${minutes}åˆ†é’Ÿ` : ''}`;
    }
    return `${minutes}åˆ†é’Ÿ`;
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šåŠŸèƒ½
   * @param permission æƒé™æ ‡è¯†
   * @returns æ˜¯å¦æœ‰æƒé™?   */
  public hasPermission(permission: string): boolean {
    // åŸºç¡€æƒé™æ˜ å°„ - ä½¿ç”¨switchè¯­å¥æ›¿ä»£ç´¢å¼•è®¿é—®
    let userPermissions: string[] = [];
    
    switch (this.role) {
      case UserRole.GUEST:
        userPermissions = ['basic_view', 'limited_search'];
        break;
      case UserRole.REGULAR:
        userPermissions = ['basic_view', 'full_search', 'watch_history', 'favorites', 'download_basic'];
        break;
      case UserRole.VIP:
        userPermissions = ['basic_view', 'full_search', 'watch_history', 'favorites', 'download_full', 'hd_content', 'ad_free', 'exclusive_content'];
        break;
      case UserRole.ADMIN:
        userPermissions = ['*'];
        break;
      default:
        userPermissions = [];
    }
    
    // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™?    if (userPermissions.includes('*')) {
      return true;
    }

    // VIPæƒé™æ£€æŸ¥ï¼šå¦‚æœæ˜¯VIPä½†è®¢é˜…å·²è¿‡æœŸï¼Œé™çº§ä¸ºæ™®é€šç”¨æˆ·æƒé™?    if (this.role === UserRole.VIP && !this.isVip()) {
      const regularPermissions = ['basic_view', 'full_search', 'watch_history', 'favorites', 'download_basic'];
      return regularPermissions.includes(permission);
    }

    return userPermissions.includes(permission);
  }

  /**
   * è®¾ç½®ç”¨æˆ·çŠ¶æ€?   * @param status æ–°çŠ¶æ€?   */
  public setStatus(status: 'active' | 'inactive' | 'suspended'): void {
    this.status = status;
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·è´¦æˆ·æ˜¯å¦æœ‰æ•?   * @returns æ˜¯å¦æœ‰æ•ˆ
   */
  public isAccountActive(): boolean {
    return this.status === 'active' && 
           (!this.isVip() || (this.isVip() && this.status === 'active'));
  }

  /**
   * åºåˆ—åŒ–å¯¹è±¡ï¼ˆç”¨äºå­˜å‚¨ï¼?   * @returns åºåˆ—åŒ–åçš„å¯¹è±?   */
  public toSerializable(): UserSerializableData {
    // ç¡®ä¿æ‰€æœ‰å±æ€§éƒ½ä¸æ˜¯undefinedï¼Œä½¿ç”¨nullæ›¿ä»£undefined
    const result: UserSerializableData = {
      id: this.id || null,
      username: this.username || null,
      nickname: this.nickname || null,
      email: this.email || null,
      avatarUrl: this.avatarUrl || null,
      role: this.role || 0,
      preferences: this.preferences || null,
      lastLoginTime: this.lastLoginTime || null,
      registrationDate: this.registrationDate || null,
      activeDevices: this.activeDevices || null,
      isVerified: this.isVerified || false,
      status: this.status || 'active',
      subscriptionEndDate: this.subscriptionEndDate || null,
      watchHistoryEnabled: this.watchHistoryEnabled || false,
      favoritesEnabled: this.favoritesEnabled || false,
      totalWatchTime: this.totalWatchTime || 0,
      settings: this.settings || null
    };
    return result;
  }

  /**
   * ä»åºåˆ—åŒ–æ•°æ®åˆ›å»ºå¯¹è±¡
   * @param data åºåˆ—åŒ–æ•°æ?   * @returns Userå¯¹è±¡
   */
  public static fromSerializable(data: UserSerializableData): User {
    // å‡†å¤‡æ„é€ å‡½æ•°å‚æ•?    const userId = typeof data.id === 'string' ? data.id : `user_${DateUtil.getTimestamp()}_${Math.random().toString(36).substr(2, 9)}`;
    const userName = typeof data.username === 'string' ? data.username : `user_${Math.random().toString(36).substr(2, 8)}`;
    
    // ä½¿ç”¨æ„é€ å‡½æ•°ç›´æ¥åˆ›å»ºå®ä¾?    const instance = new User({
      id: userId,
      username: userName,
      nickname: typeof data.nickname === 'string' ? data.nickname : undefined,
      email: typeof data.email === 'string' ? data.email : undefined,
      avatarUrl: typeof data.avatarUrl === 'string' ? data.avatarUrl : undefined,
      role: typeof data.role === 'number' ? data.role : UserRole.REGULAR,
      lastLoginTime: typeof data.lastLoginTime === 'string' ? data.lastLoginTime : DateUtil.format(new Date()),
      registrationDate: typeof data.registrationDate === 'string' ? data.registrationDate : DateUtil.format(new Date()),
      isVerified: typeof data.isVerified === 'boolean' ? data.isVerified : false,
      status: typeof data.status === 'string' ? 
        (['active', 'inactive', 'suspended'].includes(data.status) ? data.status as 'active' | 'inactive' | 'suspended' : 'active') : 
        'active',
      subscriptionEndDate: typeof data.subscriptionEndDate === 'string' ? data.subscriptionEndDate : undefined,
      watchHistoryEnabled: typeof data.watchHistoryEnabled === 'boolean' ? data.watchHistoryEnabled : true,
      favoritesEnabled: typeof data.favoritesEnabled === 'boolean' ? data.favoritesEnabled : true,
      totalWatchTime: typeof data.totalWatchTime === 'number' ? data.totalWatchTime : 0
    });
    
    // å¤„ç†preferences
    if (data.preferences && typeof data.preferences === 'object' && !Array.isArray(data.preferences)) {
      instance.preferences = User.safeCastToUserPreferences(data.preferences);
    } else {
      instance.preferences = instance.getDefaultPreferences();
    }
    
    // å¤„ç†activeDevices
    if (Array.isArray(data.activeDevices)) {
      instance.activeDevices = [];
      for (let i = 0; i < data.activeDevices.length; i++) {
        const item = data.activeDevices[i];
        if (item && typeof item === 'object' && !Array.isArray(item)) {
          // ä½¿ç”¨ç±»å‹ä¿æŠ¤ç¡®ä¿itemæ˜¯DeviceInfoç±»å‹
          if ('deviceId' in item && 'deviceName' in item && 'deviceType' in item && 'lastActiveTime' in item) {
            const deviceItem = item as DeviceInfo;
            // åˆ›å»ºDeviceInfoå¯¹è±¡ï¼Œä½¿ç”¨æ˜¾å¼ç±»å‹åˆå§‹åŒ–
            const deviceInfo: DeviceInfo = {
              deviceId: typeof deviceItem.deviceId === 'string' ? deviceItem.deviceId : '',
              deviceName: typeof deviceItem.deviceName === 'string' ? deviceItem.deviceName : '',
              deviceType: typeof deviceItem.deviceType === 'string' ? deviceItem.deviceType : '',
              lastActiveTime: typeof deviceItem.lastActiveTime === 'string' ? deviceItem.lastActiveTime : ''
            };
            instance.activeDevices.push(deviceInfo);
          }
        }
      }
    } else {
      instance.activeDevices = [];
    }
    
    // å¤„ç†settings
    if (data.settings && typeof data.settings === 'object' && !Array.isArray(data.settings)) {
      // åˆ›å»ºUserSettingså¯¹è±¡ï¼Œä½¿ç”¨æ˜¾å¼ç±»å‹åˆå§‹åŒ–
      const userSettings: UserSettings = {
        notificationsEnabled: typeof data.settings.notificationsEnabled === 'boolean' ? data.settings.notificationsEnabled : undefined,
        autoPlayEnabled: typeof data.settings.autoPlayEnabled === 'boolean' ? data.settings.autoPlayEnabled : undefined,
        defaultLanguage: typeof data.settings.defaultLanguage === 'string' ? data.settings.defaultLanguage : undefined,
        themePreference: typeof data.settings.themePreference === 'string' ? data.settings.themePreference : undefined,
        subtitleSize: typeof data.settings.subtitleSize === 'number' ? data.settings.subtitleSize : undefined
      };
      instance.settings = userSettings;
    } else {
      instance.settings = {
        notificationsEnabled: undefined,
        autoPlayEnabled: undefined,
        defaultLanguage: undefined,
        themePreference: undefined,
        subtitleSize: undefined
      };
    }
    
    return instance;
  }
  
  /**
   * å®‰å…¨åœ°å°†å¯¹è±¡è½¬æ¢ä¸ºUserPreferencesç±»å‹
   * @param obj è¦è½¬æ¢çš„å¯¹è±¡
   * @returns è½¬æ¢åçš„UserPreferenceså¯¹è±¡
   */
  private static safeCastToUserPreferences(obj: Record<string, string | number | boolean | null>): UserPreferences {
    // åˆ›å»ºç¬¦åˆUserPreferencesæ¥å£çš„å¯¹è±?    const result: UserPreferences = {} as UserPreferences;
    
    // å®‰å…¨åœ°è®¾ç½®æ¯ä¸ªå±æ€?    if (typeof obj.theme === 'string' && ['light', 'dark', 'system'].includes(obj.theme)) {
      result.theme = obj.theme as 'light' | 'dark' | 'system';
    }
    if (typeof obj.language === 'string') {
      result.language = obj.language;
    }
    if (typeof obj.playerDefaultQuality === 'string') {
      result.playerDefaultQuality = obj.playerDefaultQuality;
    }
    if (typeof obj.autoplay === 'boolean') {
      result.autoplay = obj.autoplay;
    }
    if (typeof obj.subtitleEnabled === 'boolean') {
      result.subtitleEnabled = obj.subtitleEnabled;
    }
    if (typeof obj.defaultSubtitleLanguage === 'string') {
      result.defaultSubtitleLanguage = obj.defaultSubtitleLanguage;
    }
    if (typeof obj.audioLanguage === 'string') {
      result.audioLanguage = obj.audioLanguage;
    }
    if (typeof obj.maxConcurrentDownloads === 'number') {
      result.maxConcurrentDownloads = obj.maxConcurrentDownloads;
    }
    if (typeof obj.parentalControlEnabled === 'boolean') {
      result.parentalControlEnabled = obj.parentalControlEnabled;
    }
    if (typeof obj.parentalControlLevel === 'number') {
      result.parentalControlLevel = obj.parentalControlLevel;
    }
    if (typeof obj.searchHistoryEnabled === 'boolean') {
      result.searchHistoryEnabled = obj.searchHistoryEnabled;
    }
    if (typeof obj.playbackSpeed === 'number') {
      result.playbackSpeed = obj.playbackSpeed;
    }
    
    return result;
  }

  /**
   * å…‹éš†UserPreferenceså¯¹è±¡
   * @param preferences è¦å…‹éš†çš„UserPreferenceså¯¹è±¡
   * @returns å…‹éš†åçš„å¯¹è±¡
   */
  private static cloneUserPreferences(preferences: UserPreferences): UserPreferences {
    const cloned: UserPreferences = {
      theme: preferences.theme,
      language: preferences.language,
      playerDefaultQuality: preferences.playerDefaultQuality,
      autoplay: preferences.autoplay,
      subtitleEnabled: preferences.subtitleEnabled,
      defaultSubtitleLanguage: preferences.defaultSubtitleLanguage,
      audioLanguage: preferences.audioLanguage,
      maxConcurrentDownloads: preferences.maxConcurrentDownloads,
      parentalControlEnabled: preferences.parentalControlEnabled,
      parentalControlLevel: preferences.parentalControlLevel,
      searchHistoryEnabled: preferences.searchHistoryEnabled,
      playbackSpeed: preferences.playbackSpeed
    };
    return cloned;
  }

  /**
   * å…‹éš†DeviceInfoæ•°ç»„
   * @param devices è¦å…‹éš†çš„DeviceInfoæ•°ç»„
   * @returns å…‹éš†åçš„æ•°ç»„
   */
  private static cloneActiveDevices(devices: DeviceInfo[]): DeviceInfo[] {
    const cloned: DeviceInfo[] = [];
    for (let i = 0; i < devices.length; i++) {
      const device = devices[i];
      cloned.push({
        deviceId: device.deviceId,
        deviceName: device.deviceName,
        deviceType: device.deviceType,
        lastActiveTime: device.lastActiveTime,
        osVersion: device.osVersion,
        appVersion: device.appVersion,
        ipAddress: device.ipAddress
      });
    }
    return cloned;
  }

  /**
   * å…‹éš†UserSettingså¯¹è±¡
   * @param settings è¦å…‹éš†çš„UserSettingså¯¹è±¡
   * @returns å…‹éš†åçš„å¯¹è±¡
   */
  private static cloneUserSettings(settings: UserSettings): UserSettings {
    const cloned: UserSettings = {
      notificationsEnabled: settings.notificationsEnabled,
      autoPlayEnabled: settings.autoPlayEnabled,
      defaultLanguage: settings.defaultLanguage,
      themePreference: settings.themePreference,
      subtitleSize: settings.subtitleSize
    };
    return cloned;
  }
  
  /**
   * å®‰å…¨åœ°åˆ›å»ºç¬¦åˆUserSettingsæ¥å£çš„å¯¹è±?   * é¿å…ç±»ä½œä¸ºå¯¹è±¡ä½¿ç”¨çš„è­¦å‘Š
   * @param settingsObj è¾“å…¥çš„settingså¯¹è±¡
   * @returns å®‰å…¨çš„UserSettingså¯¹è±¡
   */
  private createSafeUserSettings(settingsObj: Record<string, string | number | boolean | null>): UserSettings {
    const result: UserSettings = {
      notificationsEnabled: undefined,
      autoPlayEnabled: undefined,
      defaultLanguage: undefined,
      themePreference: undefined,
      subtitleSize: undefined
    };
    
    // åªå¤åˆ¶UserSettingsæ¥å£ä¸­å®šä¹‰çš„æœ‰æ•ˆå±æ€?    if (typeof settingsObj.notificationsEnabled === 'boolean') {
      result.notificationsEnabled = settingsObj.notificationsEnabled;
    }
    if (typeof settingsObj.autoPlayEnabled === 'boolean') {
      result.autoPlayEnabled = settingsObj.autoPlayEnabled;
    }
    if (typeof settingsObj.defaultLanguage === 'string') {
      result.defaultLanguage = settingsObj.defaultLanguage;
    }
    if (typeof settingsObj.themePreference === 'string') {
      result.themePreference = settingsObj.themePreference;
    }
    if (typeof settingsObj.subtitleSize === 'number') {
      result.subtitleSize = settingsObj.subtitleSize;
    }
    
    return result;
  }

  /**
   * å…‹éš†Userå®ä¾‹
   * @returns å…‹éš†åçš„å®ä¾‹
   */
  public clone(): User {
    // ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºå®Œæ•´å®ä¾‹ï¼Œé¿å…ç©ºå¯¹è±¡å­—é¢é‡
    const instance = new User({
      id: this.id,
      username: this.username,
      nickname: this.nickname,
      email: this.email,
      avatarUrl: this.avatarUrl,
      role: this.role,
      lastLoginTime: this.lastLoginTime,
      registrationDate: this.registrationDate,
      isVerified: this.isVerified,
      status: this.status,
      subscriptionEndDate: this.subscriptionEndDate,
      watchHistoryEnabled: this.watchHistoryEnabled,
      favoritesEnabled: this.favoritesEnabled,
      totalWatchTime: this.totalWatchTime
    });
    
    // æ‰‹åŠ¨å¤„ç†å¤æ‚ç±»å‹å±æ€?    instance.preferences = this.preferences ? User.cloneUserPreferences(this.preferences) : undefined;
    instance.activeDevices = this.activeDevices ? User.cloneActiveDevices(this.activeDevices) : undefined;
    instance.settings = this.settings ? User.cloneUserSettings(this.settings) : undefined;
    
    return instance;
  }
}

