// History - è§‚çœ‹å†å²å®ä½“ç±?import Logger from '../../common/util/Logger';
import DateUtil from '../../common/util/DateUtil';
import { VideoType } from './Movie';

const TAG = 'History';

/**
 * å†å²è®°å½•åºåˆ—åŒ–æ¥å? * å®šä¹‰å†å²è®°å½•å¯¹è±¡åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶çš„ç»“æ? */
export interface HistorySerializable {
  id: string;
  userId: string;
  contentId: string;
  contentTitle: string;
  contentType: number;
  progress: number;
  totalDuration: number;
  lastWatchTime: string;
  playCount: number;
  isFinished: boolean;
  coverUrl?: string;
  episodeId?: string;
  episodeTitle?: string;
  season?: number;
  episode?: number;
  sourceId?: string;
  quality?: string;
  deviceId?: string;
}

/**
 * è§‚çœ‹å†å²å®ä½“ç±? * è®°å½•ç”¨æˆ·çš„è§‚çœ‹å†å²ä¿¡æ? */
export default class History {
  id: string;              // å†å²è®°å½•ID
  userId: string;          // ç”¨æˆ·ID
  contentId: string;       // å†…å®¹IDï¼ˆMovie IDç­‰ï¼‰
  contentTitle: string;    // å†…å®¹æ ‡é¢˜
  contentType: VideoType;  // å†…å®¹ç±»å‹
  coverUrl?: string;       // å°é¢å›¾ç‰‡URL
  episodeId?: string;      // å‰§é›†IDï¼ˆå¦‚æœæ˜¯å¤šé›†å†…å®¹ï¼?  episodeTitle?: string;   // å‰§é›†æ ‡é¢˜
  season?: number;         // å­£æ•°
  episode?: number;        // é›†æ•°
  progress: number;        // è§‚çœ‹è¿›åº¦ï¼ˆç§’ï¼?  totalDuration: number;   // æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  lastWatchTime: string;   // æœ€åè§‚çœ‹æ—¶é—?  playCount: number;       // æ’­æ”¾æ¬¡æ•°
  isFinished: boolean;     // æ˜¯å¦è§‚çœ‹å®Œæˆ
  sourceId?: string;       // æ’­æ”¾æºID
  quality?: string;        // æ’­æ”¾è´¨é‡
  deviceId?: string;       // è§‚çœ‹è®¾å¤‡ID

  /**
   * æ„é€ å‡½æ•?   */
  constructor(data: Partial<History>) {
    this.id = data.id || `history_${DateUtil.getTimestamp()}_${Math.random().toString(36).substr(2, 9)}`;
    this.userId = data.userId || '';
    this.contentId = data.contentId || '';
    this.contentTitle = data.contentTitle || 'æœªçŸ¥å†…å®¹';
    this.contentType = data.contentType || VideoType.OTHER;
    this.coverUrl = data.coverUrl;
    this.episodeId = data.episodeId;
    this.episodeTitle = data.episodeTitle;
    this.season = data.season;
    this.episode = data.episode;
    this.progress = data.progress || 0;
    this.totalDuration = data.totalDuration || 0;
    this.lastWatchTime = data.lastWatchTime || DateUtil.format(new Date());
    this.playCount = data.playCount || 1;
    this.isFinished = data.isFinished || false;
    this.sourceId = data.sourceId;
    this.quality = data.quality;
    this.deviceId = data.deviceId;
  }

  /**
   * æ›´æ–°è§‚çœ‹è¿›åº¦
   * @param progress æ–°çš„è¿›åº¦ï¼ˆç§’ï¼?   * @param duration æ€»æ—¶é•¿ï¼ˆç§’ï¼Œå¯é€‰ï¼‰
   */
  public updateProgress(progress: number, duration?: number): void {
    this.progress = progress;
    this.lastWatchTime = DateUtil.format(new Date());
    this.playCount += 1;

    if (duration !== undefined) {
      this.totalDuration = duration;
    }

    // å¦‚æœè§‚çœ‹è¿›åº¦è¶…è¿‡æ€»æ—¶é•¿çš„90%ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ?    this.isFinished = this.totalDuration > 0 && progress >= this.totalDuration * 0.9;
  }

  /**
   * è·å–è§‚çœ‹è¿›åº¦ç™¾åˆ†æ¯?   * @returns è¿›åº¦ç™¾åˆ†æ¯?   */
  public getProgressPercentage(): number {
    if (this.totalDuration <= 0) {
      return 0;
    }
    return Math.min(100, Math.round((this.progress / this.totalDuration) * 100));
  }

  /**
   * è·å–æ ¼å¼åŒ–çš„è§‚çœ‹è¿›åº¦
   * @returns æ ¼å¼åŒ–çš„è¿›åº¦å­—ç¬¦ä¸?   */
  public getFormattedProgress(): string {
    return `${DateUtil.formatDuration(this.progress)} / ${DateUtil.formatDuration(this.totalDuration)}`;
  }

  /**
   * è·å–ç›¸å¯¹æœ€åè§‚çœ‹æ—¶é—´æè¿?   * @returns ç›¸å¯¹æ—¶é—´æè¿°
   */
  public getRelativeWatchTime(): string {
    return DateUtil.getRelativeTime(this.lastWatchTime);
  }

  /**
   * è·å–æ ¼å¼åŒ–çš„æœ€åè§‚çœ‹æ—¶é—?   * @returns æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸?   */
  public getFormattedLastWatchTime(): string {
    return DateUtil.format(this.lastWatchTime);
  }

  /**
   * è·å–å‰§é›†ä¿¡æ¯æè¿°ï¼ˆå¦‚æœæœ‰ï¼?   * @returns å‰§é›†æè¿°
   */
  public getEpisodeInfo(): string {
    if (this.episodeTitle) {
      return this.episodeTitle;
    }
    if (this.season !== undefined && this.episode !== undefined) {
      return `ç¬?{this.season}å­?ç¬?{this.episode}é›†`;
    }
    return '';
  }

  /**
   * è·å–å†…å®¹ç±»å‹æè¿°
   * @returns ç±»å‹æè¿°
   */
  public getContentTypeDescription(): string {
    switch (this.contentType) {
      case VideoType.MOVIE:
        return 'ç”µå½±';
      case VideoType.TV_SERIES:
        return 'ç”µè§†å‰?;
      case VideoType.ANIME:
        return 'åŠ¨æ¼«';
      case VideoType.DOCUMENTARY:
        return 'çºªå½•ç‰?;
      case VideoType.VARIETY:
        return 'ç»¼è‰º';
      case VideoType.LIVE:
        return 'ç›´æ’­';
      default:
        return 'å…¶ä»–';
    }
  }

  /**
   * é‡ç½®è§‚çœ‹è¿›åº¦
   */
  public resetProgress(): void {
    this.progress = 0;
    this.isFinished = false;
    this.lastWatchTime = DateUtil.format(new Date());
  }

  /**
   * æ ‡è®°ä¸ºå·²å®Œæˆ
   */
  public markAsFinished(): void {
    this.progress = this.totalDuration;
    this.isFinished = true;
    this.lastWatchTime = DateUtil.format(new Date());
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºæœ€è¿‘è§‚çœ‹ï¼ˆ24å°æ—¶å†…ï¼‰
   * @returns æ˜¯å¦ä¸ºæœ€è¿‘è§‚çœ?   */
  public isRecentlyWatched(): boolean {
    const lastWatchDate = new Date(this.lastWatchTime);
    const now = new Date();
    const diffHours = (now.getTime() - lastWatchDate.getTime()) / (1000 * 60 * 60);
    return diffHours <= 24;
  }

  /**
   * è·å–è§‚çœ‹çŠ¶æ€æ–‡æœ?   * @returns çŠ¶æ€æ–‡æœ?   */
  public getWatchStatusText(): string {
    if (this.isFinished) {
      return 'å·²å®Œæˆ?;
    }
    const percentage = this.getProgressPercentage();
    if (percentage >= 70) {
      return 'å³å°†å®Œæˆ';
    } else if (percentage >= 30) {
      return 'è§‚çœ‹ä¸?;
    } else {
      return 'å¼€å§‹è§‚çœ?;
    }
  }

  /**
   * åºåˆ—åŒ–å¯¹è±¡ï¼ˆç”¨äºå­˜å‚¨ï¼?   * @returns åºåˆ—åŒ–åçš„å¯¹è±?   */
  public toSerializable(): HistorySerializable {
    // ä½¿ç”¨å¯¹è±¡å­—é¢é‡ç›´æ¥åˆå§‹åŒ–ï¼Œé¿å…ç©ºå¯¹è±¡å­—é¢é‡?    const result: HistorySerializable = {
      id: this.id,
      userId: this.userId,
      contentId: this.contentId,
      contentTitle: this.contentTitle,
      contentType: this.contentType,
      progress: this.progress,
      totalDuration: this.totalDuration,
      lastWatchTime: this.lastWatchTime,
      playCount: this.playCount,
      isFinished: this.isFinished
    };
    
    // ä»…åœ¨å±æ€§æœ‰å€¼æ—¶æ·»åŠ å¯é€‰å­—æ®?    if (this.coverUrl !== undefined) result.coverUrl = this.coverUrl;
    if (this.episodeId !== undefined) result.episodeId = this.episodeId;
    if (this.episodeTitle !== undefined) result.episodeTitle = this.episodeTitle;
    if (this.season !== undefined) result.season = this.season;
    if (this.episode !== undefined) result.episode = this.episode;
    if (this.sourceId !== undefined) result.sourceId = this.sourceId;
    if (this.quality !== undefined) result.quality = this.quality;
    if (this.deviceId !== undefined) result.deviceId = this.deviceId;
    
    return result;
  }

  /**
   * ä»åºåˆ—åŒ–å¯¹è±¡åˆ›å»ºHistoryå®ä¾‹
   * @param data åºåˆ—åŒ–çš„æ•°æ®
   * @returns Historyå®ä¾‹
   */
  public static fromSerializable(data: HistorySerializable): History {
    // ä¸ºå¯¹è±¡å­—é¢é‡æ·»åŠ æ˜ç¡®çš„ç±»å‹æ³¨è§?    const historyData: Partial<History> = {
      id: typeof data.id === 'string' ? data.id : `history_${DateUtil.getTimestamp()}_${Math.random().toString(36).substr(2, 9)}`,
      userId: typeof data.userId === 'string' ? data.userId : '',
      contentId: typeof data.contentId === 'string' ? data.contentId : '',
      contentTitle: typeof data.contentTitle === 'string' ? data.contentTitle : 'æœªçŸ¥å†…å®¹',
      contentType: typeof data.contentType === 'number' ? data.contentType as VideoType : VideoType.OTHER,
      progress: typeof data.progress === 'number' ? data.progress : 0,
      totalDuration: typeof data.totalDuration === 'number' ? data.totalDuration : 0,
      lastWatchTime: typeof data.lastWatchTime === 'string' ? data.lastWatchTime : DateUtil.format(new Date()),
      playCount: typeof data.playCount === 'number' ? data.playCount : 1,
      isFinished: typeof data.isFinished === 'boolean' ? data.isFinished : false,
      coverUrl: data.coverUrl,
      episodeId: data.episodeId,
      episodeTitle: data.episodeTitle,
      season: data.season,
      episode: data.episode,
      sourceId: data.sourceId,
      quality: data.quality,
      deviceId: data.deviceId
    };
    return new History(historyData);
  }

  /**
   * å…‹éš†Historyå®ä¾‹
   * @returns å…‹éš†åçš„å®ä¾‹
   */
  public clone(): History {
    return new History(this.toSerializable());
  }

  /**
   * åˆ›å»ºå†å²è®°å½•çš„æ¯”è¾ƒå‡½æ•°ï¼ˆç”¨äºæ’åºï¼?   * @param order æ’åºé¡ºåº 'desc'ï¼ˆé»˜è®¤ï¼‰æˆ?'asc'
   * @returns æ¯”è¾ƒå‡½æ•°
   */
  public static getSortComparator(order: 'desc' | 'asc' = 'desc'): (a: History, b: History) => number {
    return (a: History, b: History) => {
      const dateA = new Date(a.lastWatchTime).getTime();
      const dateB = new Date(b.lastWatchTime).getTime();
      return order === 'desc' ? dateB - dateA : dateA - dateB;
    };
  }

  /**
   * åˆå¹¶ç›¸åŒå†…å®¹çš„å†å²è®°å½?   * @param histories å†å²è®°å½•æ•°ç»„
   * @returns åˆå¹¶åçš„å†å²è®°å½•æ•°ç»„
   */
  public static mergeHistories(histories: History[]): History[] {
    const historyMap = new Map<string, History>();

    histories.forEach(history => {
      // ä½¿ç”¨contentIdå’ŒepisodeIdä½œä¸ºå”¯ä¸€é”®ï¼ˆå¦‚æœæœ‰episodeIdï¼?      const key = history.episodeId ? `${history.contentId}_${history.episodeId}` : history.contentId;
      
      const existingHistory = historyMap.get(key);
      if (existingHistory) {
        // å¦‚æœå·²æœ‰è®°å½•ï¼Œä¿ç•™æœ€æ–°çš„è§‚çœ‹æ—¶é—´å’Œæœ€å¤§çš„è§‚çœ‹è¿›åº¦
        const lastWatchTime = new Date(history.lastWatchTime).getTime();
        const existingLastWatchTime = new Date(existingHistory.lastWatchTime).getTime();
        
        if (lastWatchTime > existingLastWatchTime) {
          // æ–°è®°å½•æ›´æ–°æ—¶é—´æ›´æ–°ï¼Œæ›¿æ¢ä¸ºæ–°è®°å½•
          historyMap.set(key, history);
        } else if (history.progress > existingHistory.progress) {
          // è¿›åº¦æ›´æ–°ï¼Œåˆå¹¶ä¿¡æ?          existingHistory.progress = history.progress;
          existingHistory.playCount += history.playCount;
          existingHistory.isFinished = existingHistory.progress >= existingHistory.totalDuration * 0.9;
        }
      } else {
        // æ–°è®°å½?        historyMap.set(key, history);
      }
    });

    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æœ€åè§‚çœ‹æ—¶é—´æ’åº?    return Array.from(historyMap.values()).sort(History.getSortComparator());
  }
}
