// SearchDto - æœç´¢ç›¸å…³æ•°æ®ä¼ è¾“å¯¹è±¡
import { VideoType } from '../model/Movie';
import ApiResponse from './ApiResponse';

/**
 * æœç´¢ç±»å‹æšä¸¾
 */
export enum SearchType {
  ALL = 'all',          // å…¨éƒ¨ç±»å‹
  MOVIE = 'movie',      // ç”µå½±
  TV_SERIES = 'tv_series', // ç”µè§†å‰?  LIVE = 'live',        // ç›´æ’­
  ANIME = 'anime',      // åŠ¨æ¼«
  VARIETY = 'variety',  // ç»¼è‰º
  DOCUMENTARY = 'documentary', // çºªå½•ç‰?  SPORTS = 'sports',    // ä½“è‚²
  MUSIC = 'music',      // éŸ³ä¹
  KIDS = 'kids'         // å°‘å„¿
}

/**
 * æœç´¢æ’åºæšä¸¾
 */
export enum SearchSort {
  DEFAULT = 'default',           // é»˜è®¤æ’åº
  LATEST = 'latest',             // æœ€æ–?  HOTTEST = 'hottest',           // æœ€çƒ?  RATING_DESC = 'rating_desc',   // è¯„åˆ†ä»é«˜åˆ°ä½
  RATING_ASC = 'rating_asc',     // è¯„åˆ†ä»ä½åˆ°é«˜
  RELEASE_DATE_DESC = 'release_date_desc', // å‘è¡Œæ—¥æœŸä»æ–°åˆ°æ—§
  RELEASE_DATE_ASC = 'release_date_asc'    // å‘è¡Œæ—¥æœŸä»æ—§åˆ°æ–°
}

/**
 * æœç´¢ç­›é€‰æ¡ä»¶æ¥å? */
export interface SearchFilter {
  year?: number | null;              // å¹´ä»½
  country?: string | null;           // å›½å®¶/åœ°åŒº
  genre?: string | null;             // ç±»å‹
  language?: string | null;          // è¯­è¨€
  minRating?: number | null;         // æœ€ä½è¯„åˆ?  maxRating?: number | null;         // æœ€é«˜è¯„åˆ?  durationMin?: number | null;       // æœ€çŸ­æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼?  durationMax?: number | null;       // æœ€é•¿æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼?  studio?: string | null;            // åˆ¶ä½œå…¬å¸
  director?: string | null;          // å¯¼æ¼”
  actor?: string | null;             // æ¼”å‘˜
  keywords?: string[] | null;        // å…³é”®è¯åˆ—è¡?  subtitle?: boolean | null;         // æ˜¯å¦æœ‰å­—å¹?  hd?: boolean | null;               // æ˜¯å¦é«˜æ¸…
  premium?: boolean | null;          // æ˜¯å¦ä»˜è´¹å†…å®¹
}

/**
 * æœç´¢è¯·æ±‚å‚æ•°æ¥å£
 */
export interface SearchRequest {
  keyword: string;                  // æœç´¢å…³é”®è¯?  type: SearchType;                 // æœç´¢ç±»å‹
  page: number;                     // é¡µç 
  pageSize: number;                 // æ¯é¡µå¤§å°
  sort: SearchSort;                 // æ’åºæ–¹å¼
  filter?: SearchFilter;            // ç­›é€‰æ¡ä»?  includeSuggestions?: boolean;     // æ˜¯å¦åŒ…å«æœç´¢å»ºè®®
  autoCorrect?: boolean;            // æ˜¯å¦è‡ªåŠ¨çº æ­£æ‹¼å†™
  language?: string;                // æœç´¢è¯­è¨€
}

/**
 * æœç´¢å»ºè®®æ¥å£
 */
export interface SearchSuggestion {
  text: string;                     // å»ºè®®æ–‡æœ¬
  type?: SearchType;                // å»ºè®®ç±»å‹
  count?: number;                   // ç›¸å…³ç»“æœæ•°é‡
  tags?: string[];                  // ç›¸å…³æ ‡ç­¾
  highlight?: boolean;              // æ˜¯å¦é«˜äº®æ˜¾ç¤º
  source?: string;                  // æ¥æº
}

/**
 * æœç´¢å†å²è®°å½•æ¥å£
 */
export interface SearchHistory {
  id: string;                       // å†å²è®°å½•ID
  keyword: string;                  // æœç´¢å…³é”®è¯?  type: SearchType;                 // æœç´¢ç±»å‹
  timestamp: number;                // æœç´¢æ—¶é—´æˆ?  count: number;                    // æœç´¢æ¬¡æ•°
  lastSearchAt: number;             // æœ€åæœç´¢æ—¶é—?}

/**
 * æœç´¢ç»“æœé¡¹æ¥å? */
export interface SearchResultItem {
  id: string;                       // å†…å®¹ID
  title: string;                    // æ ‡é¢˜
  originalTitle?: string;           // åŸå§‹æ ‡é¢˜
  subtitle?: string;                // å‰¯æ ‡é¢?  description?: string;             // ç®€ä»?  type: VideoType;                  // è§†é¢‘ç±»å‹
  coverUrl?: string;                // å°é¢å›¾ç‰‡URL
  posterUrl?: string;               // æµ·æŠ¥å›¾ç‰‡URL
  backdropUrl?: string;             // èƒŒæ™¯å›¾ç‰‡URL
  rating?: number;                  // è¯„åˆ†
  releaseYear?: number;             // å‘è¡Œå¹´ä»½
  genres?: string[];                // ç±»å‹æ ‡ç­¾
  countries?: string[];             // å›½å®¶/åœ°åŒº
  duration?: number;                // æ—¶é•¿ï¼ˆç§’ï¼?  isNew?: boolean;                  // æ˜¯å¦æ–°å†…å®?  isHot?: boolean;                  // æ˜¯å¦çƒ­é—¨
  isVip?: boolean;                  // æ˜¯å¦VIPå†…å®¹
  hasSubtitle?: boolean;            // æ˜¯å¦æœ‰å­—å¹?  totalEpisodes?: number;           // æ€»é›†æ•°ï¼ˆç”µè§†å‰§ï¼‰
  airedEpisodes?: number;           // å·²æ›´æ–°é›†æ•°ï¼ˆç”µè§†å‰§ï¼‰
  directors?: string[];             // å¯¼æ¼”åˆ—è¡¨
  actors?: string[];                // æ¼”å‘˜åˆ—è¡¨
  provider?: string;                // å†…å®¹æä¾›å•?  providerId?: string;              // æä¾›å•†ID
  searchScore?: number;             // æœç´¢åŒ¹é…åˆ†æ•°
  highlightTerms?: string[];        // éœ€è¦é«˜äº®çš„å…³é”®è¯?  source?: string;                  // æ¥æº
  metadata?: Record<string, unknown>;   // é¢å¤–å…ƒæ•°æ?}

/**
 * æœç´¢ç»“æœå“åº”æ¥å£
 */
export interface SearchResponseData {
  items: SearchResultItem[];        // æœç´¢ç»“æœåˆ—è¡¨
  total: number;                    // æ€»ç»“æœæ•°
  page: number;                     // å½“å‰é¡µç 
  pageSize: number;                 // æ¯é¡µå¤§å°
  totalPages: number;               // æ€»é¡µæ•?  hasMore: boolean;                 // æ˜¯å¦æœ‰æ›´å¤?  suggestions?: SearchSuggestion[]; // æœç´¢å»ºè®®ï¼ˆå¦‚æœè¯·æ±‚äº†ï¼?  correctedKeyword?: string;        // çº æ­£åçš„å…³é”®è¯ï¼ˆå¦‚æœè‡ªåŠ¨çº æ­£äº†ï¼‰
  searchTime: number;               // æœç´¢è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  filters?: SearchFilter;           // åº”ç”¨çš„ç­›é€‰æ¡ä»?  typeDistribution?: Record<string, number>; // ç±»å‹åˆ†å¸ƒç»Ÿè®¡
}

/**
 * æœç´¢ç»“æœAPIå“åº”
 */
export type SearchApiResponse = ApiResponse<SearchResponseData>;

/**
 * æœç´¢å»ºè®®å“åº”æ¥å£
 */
export interface SearchSuggestionsResponseData {
  suggestions: SearchSuggestion[];  // æœç´¢å»ºè®®åˆ—è¡¨
  keyword: string;                  // æœç´¢å…³é”®è¯?  totalSuggestions: number;         // å»ºè®®æ€»æ•°
}

/**
 * æœç´¢å»ºè®®APIå“åº”
 */
export type SearchSuggestionsApiResponse = ApiResponse<SearchSuggestionsResponseData>;

/**
 * æœç´¢å†å²å“åº”æ¥å£
 */
export interface SearchHistoryResponseData {
  histories: SearchHistory[];       // æœç´¢å†å²åˆ—è¡¨
  total: number;                    // æ€»æ•°
}

/**
 * æœç´¢å†å²APIå“åº”
 */
export type SearchHistoryApiResponse = ApiResponse<SearchHistoryResponseData>;

/**
 * çƒ­é—¨æœç´¢å…³é”®è¯æ¥å? */
export interface HotKeyword {
  id: string;                       // å…³é”®è¯ID
  keyword: string;                  // å…³é”®è¯æ–‡æœ?  count: number;                    // æœç´¢æ¬¡æ•°
  trend: 'up' | 'down' | 'stable';  // è¶‹åŠ¿
  isNew?: boolean;                  // æ˜¯å¦æ–°å…³é”®è¯
  tags?: string[];                  // æ ‡ç­¾
  rank?: number;                    // æ’å
}

/**
 * çƒ­é—¨æœç´¢å“åº”æ¥å£
 */
export interface HotSearchResponseData {
  keywords: HotKeyword[];           // çƒ­é—¨å…³é”®è¯åˆ—è¡?  updatedAt: number;                // æ›´æ–°æ—¶é—´
}

/**
 * çƒ­é—¨æœç´¢APIå“åº”
 */
export type HotSearchApiResponse = ApiResponse<HotSearchResponseData>;

/**
 * æœç´¢é…ç½®æ¥å£
 */
export interface SearchConfig {
  enabled: boolean;                 // æ˜¯å¦å¯ç”¨æœç´¢
  maxResults: number;               // æœ€å¤§ç»“æœæ•°
  minKeywordLength: number;         // æœ€å°å…³é”®è¯é•¿åº¦
  suggestionEnabled: boolean;       // æ˜¯å¦å¯ç”¨æœç´¢å»ºè®®
  historyEnabled: boolean;          // æ˜¯å¦å¯ç”¨æœç´¢å†å²
  maxHistoryItems: number;          // æœ€å¤§å†å²è®°å½•æ•°
  autoCorrectEnabled: boolean;      // æ˜¯å¦å¯ç”¨è‡ªåŠ¨çº æ­£
  cacheEnabled: boolean;            // æ˜¯å¦å¯ç”¨æœç´¢ç¼“å­˜
  cacheExpiry: number;              // ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  supportedTypes: SearchType[];     // æ”¯æŒçš„æœç´¢ç±»å?  defaultType: SearchType;          // é»˜è®¤æœç´¢ç±»å‹
  supportedSorts: SearchSort[];     // æ”¯æŒçš„æ’åºæ–¹å¼?  defaultSort: SearchSort;          // é»˜è®¤æ’åºæ–¹å¼
}

/**
 * æœç´¢ç»“æœåˆ†ç»„æ¥å£
 */
export interface SearchResultGroup {
  type: SearchType;                 // åˆ†ç»„ç±»å‹
  title: string;                    // åˆ†ç»„æ ‡é¢˜
  items: SearchResultItem[];        // åˆ†ç»„å†…çš„ç»“æœ
  total: number;                    // åˆ†ç»„å†…æ€»ç»“æœæ•°
  hasMore: boolean;                 // åˆ†ç»„å†…æ˜¯å¦æœ‰æ›´å¤š
}

/**
 * åˆ†ç»„æœç´¢ç»“æœå“åº”æ¥å£
 */
export interface GroupedSearchResponseData {
  groups: SearchResultGroup[];      // åˆ†ç»„æœç´¢ç»“æœ
  total: number;                    // æ€»ç»“æœæ•°
  searchTime: number;               // æœç´¢è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  keyword: string;                  // æœç´¢å…³é”®è¯?}

/**
 * åˆ†ç»„æœç´¢ç»“æœAPIå“åº”
 */
export type GroupedSearchApiResponse = ApiResponse<GroupedSearchResponseData>;

/**
 * é«˜çº§æœç´¢å‚æ•°æ¥å£
 */
export interface AdvancedSearchParams {
  title?: string;                   // æ ‡é¢˜
  originalTitle?: string;           // åŸå§‹æ ‡é¢˜
  actor?: string;                   // æ¼”å‘˜
  director?: string;                // å¯¼æ¼”
  writer?: string;                  // ç¼–å‰§
  year?: number | [number, number]; // å¹´ä»½æˆ–å¹´ä»½èŒƒå›?  genre?: string[];                 // ç±»å‹åˆ—è¡¨
  country?: string[];               // å›½å®¶/åœ°åŒºåˆ—è¡¨
  language?: string[];              // è¯­è¨€åˆ—è¡¨
  rating?: [number, number];        // è¯„åˆ†èŒƒå›´
  duration?: [number, number];      // æ—¶é•¿èŒƒå›´ï¼ˆåˆ†é’Ÿï¼‰
  releaseDate?: [string, string];   // å‘è¡Œæ—¥æœŸèŒƒå›´
  sort?: SearchSort;                // æ’åºæ–¹å¼
  page?: number;                    // é¡µç 
  pageSize?: number;                // æ¯é¡µå¤§å°
}

/**
 * æœç´¢ç»Ÿè®¡ä¿¡æ¯æ¥å£
 */
export interface SearchStats {
  totalResults: number;             // æ€»ç»“æœæ•°
  timeTaken: number;                // è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  cached: boolean;                  // æ˜¯å¦æ¥è‡ªç¼“å­˜
  hitRate?: number;                 // å‘½ä¸­ç?  facets?: Record<string, Record<string, number>>; // åˆ†é¢ç»Ÿè®¡
}

/**
 * æœç´¢è®°å½•æ¥å£
 */
export interface SearchRecord {
  id: string;                       // è®°å½•ID
  userId?: string;                  // ç”¨æˆ·IDï¼ˆå¦‚æœå·²ç™»å½•ï¼?  keyword: string;                  // æœç´¢å…³é”®è¯?  type: SearchType;                 // æœç´¢ç±»å‹
  filters?: SearchFilter;           // ç­›é€‰æ¡ä»?  sort: SearchSort;                 // æ’åºæ–¹å¼
  resultsCount: number;             // ç»“æœæ•°é‡
  selectedResultId?: string;        // é€‰æ‹©çš„ç»“æœID
  timestamp: number;                // æœç´¢æ—¶é—´
  ipAddress?: string;               // IPåœ°å€ï¼ˆç”¨äºç»Ÿè®¡ï¼‰
  userAgent?: string;               // ç”¨æˆ·ä»£ç†ï¼ˆç”¨äºç»Ÿè®¡ï¼‰
}

/**
 * æœç´¢ç›¸å…³çš„å·¥å…·æ–¹æ³? */
export class SearchUtils {
  /**
   * è½¬æ¢SearchTypeåˆ°VideoType
   */
  static searchTypeToVideoType(searchType: SearchType): VideoType {
    switch (searchType) {
      case SearchType.MOVIE:
        return VideoType.MOVIE;
      case SearchType.TV_SERIES:
        return VideoType.TV_SERIES;
      case SearchType.LIVE:
        return VideoType.LIVE;
      case SearchType.ANIME:
        return VideoType.ANIME;
      case SearchType.VARIETY:
        return VideoType.VARIETY;
      case SearchType.DOCUMENTARY:
        return VideoType.DOCUMENTARY;
      case SearchType.SPORTS:
        return VideoType.SPORTS;
      case SearchType.MUSIC:
        return VideoType.MUSIC;
      case SearchType.KIDS:
        return VideoType.KIDS;
      default:
        return VideoType.UNKNOWN;
    }
  }

  /**
   * è·å–SearchTypeçš„æ˜¾ç¤ºåç§?   */
  static getSearchTypeDisplayName(type: SearchType): string {
    const typeMap: Record<SearchType, string> = {
      [SearchType.ALL]: 'å…¨éƒ¨',
      [SearchType.MOVIE]: 'ç”µå½±',
      [SearchType.TV_SERIES]: 'ç”µè§†å‰?,
      [SearchType.LIVE]: 'ç›´æ’­',
      [SearchType.ANIME]: 'åŠ¨æ¼«',
      [SearchType.VARIETY]: 'ç»¼è‰º',
      [SearchType.DOCUMENTARY]: 'çºªå½•ç‰?,
      [SearchType.SPORTS]: 'ä½“è‚²',
      [SearchType.MUSIC]: 'éŸ³ä¹',
      [SearchType.KIDS]: 'å°‘å„¿'
    };
    return typeMap[type] || 'æœªçŸ¥';
  }

  /**
   * è·å–SearchSortçš„æ˜¾ç¤ºåç§?   */
  static getSearchSortDisplayName(sort: SearchSort): string {
    const sortMap: Record<SearchSort, string> = {
      [SearchSort.DEFAULT]: 'é»˜è®¤æ’åº',
      [SearchSort.LATEST]: 'æœ€æ–?,
      [SearchSort.HOTTEST]: 'æœ€çƒ?,
      [SearchSort.RATING_DESC]: 'è¯„åˆ†ä»é«˜åˆ°ä½',
      [SearchSort.RATING_ASC]: 'è¯„åˆ†ä»ä½åˆ°é«˜',
      [SearchSort.RELEASE_DATE_DESC]: 'å‘è¡Œæ—¥æœŸä»æ–°åˆ°æ—§',
      [SearchSort.RELEASE_DATE_ASC]: 'å‘è¡Œæ—¥æœŸä»æ—§åˆ°æ–°'
    };
    return sortMap[sort] || 'é»˜è®¤æ’åº';
  }

  /**
   * éªŒè¯æœç´¢å…³é”®è¯?   */
  static validateKeyword(keyword: string, minLength: number = 1): boolean {
    if (!keyword || typeof keyword !== 'string') {
      return false;
    }
    const trimmedKeyword = keyword.trim();
    return trimmedKeyword.length >= minLength;
  }

  /**
   * æ¸…ç†æœç´¢å…³é”®è¯?   */
  static sanitizeKeyword(keyword: string): string {
    if (!keyword || typeof keyword !== 'string') {
      return '';
    }
    // ç§»é™¤å¤šä½™ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™åŸºæœ¬æ ‡ç‚¹
    return keyword.trim()
      .replace(/\s+/g, ' ')  // æ›¿æ¢å¤šä¸ªç©ºæ ¼ä¸ºå•ä¸ªç©ºæ ?      .replace(/[<>"'&]/g, ''); // ç§»é™¤æ½œåœ¨çš„å±é™©å­—ç¬?  }

  /**
   * åˆ›å»ºé»˜è®¤çš„æœç´¢è¯·æ±?   */
  static createDefaultSearchRequest(keyword: string): SearchRequest {
    return {
      keyword: this.sanitizeKeyword(keyword),
      type: SearchType.ALL,
      page: 1,
      pageSize: 20,
      sort: SearchSort.DEFAULT,
      includeSuggestions: false,
      autoCorrect: false
    };
  }
}
