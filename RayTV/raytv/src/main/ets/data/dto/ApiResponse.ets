// ApiResponse - APIå“åº”æ•°æ®ä¼ è¾“å¯¹è±¡
import Logger from '../../common/util/Logger';

const TAG = 'ApiResponse';

/**
 * å“åº”çŠ¶æ€ç æšä¸¾
 */
export enum ResponseCode {
  // æˆåŠŸçŠ¶æ€ç 
  SUCCESS = 200,
  CREATED = 201,
  NO_CONTENT = 204,
  
  // å®¢æˆ·ç«¯é”™è¯¯çŠ¶æ€ç 
  BAD_REQUEST = 400,
  UNAUTHORIZED = 401,
  FORBIDDEN = 403,
  NOT_FOUND = 404,
  METHOD_NOT_ALLOWED = 405,
  CONFLICT = 409,
  VALIDATION_ERROR = 422,
  
  // æœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç 
  INTERNAL_SERVER_ERROR = 500,
  SERVICE_UNAVAILABLE = 503,
  GATEWAY_TIMEOUT = 504,
  
  // è‡ªå®šä¹‰çŠ¶æ€ç 
  NETWORK_ERROR = -100,
  TIMEOUT_ERROR = -101,
  PARSE_ERROR = -102,
  UNKNOWN_ERROR = -103,
  CACHE_ERROR = -104,
  AUTHENTICATION_ERROR = -401,
  PERMISSION_ERROR = -403
}

/**
 * åˆ†é¡µä¿¡æ¯æ¥å£
 */
export interface PaginationInfo {
  page: number;        // å½“å‰é¡µç 
  pageSize: number;    // æ¯é¡µå¤§å°
  total: number;       // æ€»æ¡æ•?  totalPages: number;  // æ€»é¡µæ•?  hasMore: boolean;    // æ˜¯å¦æœ‰æ›´å¤?}

/**
   * é”™è¯¯è¯¦æƒ…æ¥å£
   */
export interface ErrorDetail {
  field?: string;      // å­—æ®µåç§°ï¼ˆç”¨äºéªŒè¯é”™è¯¯ï¼‰
  message: string;     // é”™è¯¯æ¶ˆæ¯
  code?: string;       // é”™è¯¯ä»£ç 
  value?: string | number | boolean | null;     // é”™è¯¯å€?}

/**
 * APIå“åº”ç±? * ç”¨äºæ ‡å‡†åŒ–APIå“åº”ç»“æ„
 */
// APIå“åº”å‚æ•°æ¥å£
export interface ApiResponseParams<T = string | number | boolean | null | Record<string, string | number | boolean | null>> {
  code: ResponseCode;
  message: string;
  data?: T;
  errors?: ErrorDetail[];
  pagination?: PaginationInfo;
  requestId?: string;
  trace?: string;
}

export default class ApiResponse<T = string | number | boolean | null | Record<string, string | number | boolean | null>> {
  code: ResponseCode;             // å“åº”çŠ¶æ€ç 
  message: string;                // å“åº”æ¶ˆæ¯
  data?: T;                       // å“åº”æ•°æ®
  errors?: ErrorDetail[];         // é”™è¯¯è¯¦æƒ…ï¼ˆç”¨äºè¡¨å•éªŒè¯ç­‰ï¼?  pagination?: PaginationInfo;    // åˆ†é¡µä¿¡æ¯
  timestamp: number;              // å“åº”æ—¶é—´æˆ?  requestId?: string;             // è¯·æ±‚IDï¼ˆç”¨äºè·Ÿè¸ªï¼‰
  trace?: string;                 // è·Ÿè¸ªä¿¡æ¯

  /**
   * æ„é€ å‡½æ•?   */
  constructor(params: ApiResponseParams<T>) {
    this.code = params.code;
    this.message = params.message;
    this.data = params.data;
    this.errors = params.errors;
    this.pagination = params.pagination;
    this.timestamp = Date.now();
    this.requestId = params.requestId;
    this.trace = params.trace;
  }

  /**
   * æ˜¯å¦æˆåŠŸå“åº”
   */
  isSuccess(): boolean {
    return this.code >= 200 && this.code < 300;
  }

  /**
   * æ˜¯å¦é”™è¯¯å“åº”
   */
  isError(): boolean {
    return !this.isSuccess();
  }

  /**
   * æ˜¯å¦å®¢æˆ·ç«¯é”™è¯?   */
  isClientError(): boolean {
    return this.code >= 400 && this.code < 500 || 
           this.code === ResponseCode.AUTHENTICATION_ERROR || 
           this.code === ResponseCode.PERMISSION_ERROR;
  }

  /**
   * æ˜¯å¦æœåŠ¡å™¨é”™è¯?   */
  isServerError(): boolean {
    return this.code >= 500 || 
           this.code === ResponseCode.NETWORK_ERROR ||
           this.code === ResponseCode.TIMEOUT_ERROR ||
           this.code === ResponseCode.UNKNOWN_ERROR;
  }

  /**
   * æ˜¯å¦ç½‘ç»œé”™è¯¯
   */
  isNetworkError(): boolean {
    return [
      ResponseCode.NETWORK_ERROR,
      ResponseCode.TIMEOUT_ERROR
    ].includes(this.code);
  }

  /**
   * æ˜¯å¦è®¤è¯é”™è¯¯
   */
  isAuthError(): boolean {
    return this.code === ResponseCode.UNAUTHORIZED || 
           this.code === ResponseCode.AUTHENTICATION_ERROR;
  }

  /**
   * æ˜¯å¦æƒé™é”™è¯¯
   */
  isPermissionError(): boolean {
    return this.code === ResponseCode.FORBIDDEN || 
           this.code === ResponseCode.PERMISSION_ERROR;
  }

  /**
   * æ˜¯å¦æœªæ‰¾åˆ°èµ„æº?   */
  isNotFound(): boolean {
    return this.code === ResponseCode.NOT_FOUND;
  }

  /**
   * è·å–ç¬¬ä¸€ä¸ªé”™è¯¯æ¶ˆæ?   */
  getFirstErrorMessage(): string | null {
    if (this.errors && this.errors.length > 0) {
      return this.errors[0].message;
    }
    return null;
  }

  /**
   * è·å–å­—æ®µé”™è¯¯ä¿¡æ¯
   * @param field å­—æ®µå?   */
  getFieldError(field: string): ErrorDetail | undefined {
    return this.errors?.find(error => error.field === field);
  }

  /**
   * è·å–æ‰€æœ‰é”™è¯¯æ¶ˆæ?   */
  getAllErrorMessages(): string[] {
    if (!this.errors || this.errors.length === 0) {
      return [];
    }
    return this.errors.map(error => error.message);
  }

  /**
   * è½¬æ¢ä¸ºå­—ç¬¦ä¸²
   */
  toString(): string {
    return `ApiResponse(code=${this.code}, message=${this.message}, hasData=${!!this.data})`;
  }

  /**
   * è®°å½•æ—¥å¿—
   */
  log(): void {
    if (this.isSuccess()) {
      Logger.info(TAG, `Success response: ${this.toString()}`);
    } else {
      Logger.error(TAG, `Error response: ${this.toString()}, errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors instanceof Error ? errors: ${JSON.stringify(this.errors : new Error(String(errors: ${JSON.stringify(this.errors)))))))}`);
    }
  }

  /**
   * è½¬æ¢ä¸ºå¯¹è±¡ï¼ˆç”¨äºåºåˆ—åŒ–ï¼‰
   */
  toObject(): Record<string, unknown> {
    return {
      code: this.code,
      message: this.message,
      data: this.data,
      errors: this.errors,
      pagination: this.pagination,
      timestamp: this.timestamp,
      requestId: this.requestId,
      trace: this.trace
    };
  }

  /**
   * ä»å¯¹è±¡åˆ›å»ºå®ä¾?   * @param obj å¯¹è±¡æ•°æ®
   */
  static fromObject<T = unknown>(obj: Record<string, unknown>): ApiResponse<T> {
    const params: ApiResponseParams<T> = {
      code: typeof obj.code === 'number' ? obj.code : ResponseCode.SUCCESS,
      message: typeof obj.message === 'string' ? obj.message : 'Unknown response',
      data: obj.data as T,
      errors: Array.isArray(obj.errors) ? obj.errors : undefined,
      pagination: typeof obj.pagination === 'object' && obj.pagination !== null ? obj.pagination : undefined,
      requestId: typeof obj.requestId === 'string' ? obj.requestId : undefined,
      trace: typeof obj.trace === 'string' ? obj.trace : undefined
    };
    return new ApiResponse<T>(params);
  }

  // ========== é™æ€å·¥å‚æ–¹æ³?==========

  /**
   * åˆ›å»ºæˆåŠŸå“åº”
   */
  static success<T = unknown>(data?: T, message: string = 'Success'): ApiResponse<T> {
    return new ApiResponse<T>({
      code: ResponseCode.SUCCESS,
      message,
      data
    });
  }

  /**
   * åˆ›å»ºå¸¦åˆ†é¡µçš„æˆåŠŸå“åº”
   */
  static successWithPagination<T = unknown>(
    data: T,
    pagination: PaginationInfo,
    message: string = 'Success'
  ): ApiResponse<T> {
    return new ApiResponse<T>({
      code: ResponseCode.SUCCESS,
      message,
      data,
      pagination
    });
  }

  /**
   * åˆ›å»ºé”™è¯¯å“åº”
   */
  static error<T = unknown>(
    code: ResponseCode,
    message: string,
    errors?: ErrorDetail[]
  ): ApiResponse<T> {
    return new ApiResponse<T>({
      code,
      message,
      errors
    });
  }

  /**
   * åˆ›å»ºå‚æ•°é”™è¯¯å“åº”
   */
  static badRequest<T = unknown>(message: string = 'Bad Request', errors?: ErrorDetail[]): ApiResponse<T> {
    return this.error<T>(ResponseCode.BAD_REQUEST, message, errors);
  }

  /**
   * åˆ›å»ºæœªæˆæƒé”™è¯¯å“åº?   */
  static unauthorized<T = unknown>(message: string = 'Unauthorized'): ApiResponse<T> {
    return this.error<T>(ResponseCode.UNAUTHORIZED, message);
  }

  /**
   * åˆ›å»ºç¦æ­¢è®¿é—®é”™è¯¯å“åº”
   */
  static forbidden<T = unknown>(message: string = 'Forbidden'): ApiResponse<T> {
    return this.error<T>(ResponseCode.FORBIDDEN, message);
  }

  /**
   * åˆ›å»ºæœªæ‰¾åˆ°èµ„æºé”™è¯¯å“åº?   */
  static notFound<T = unknown>(message: string = 'Resource not found'): ApiResponse<T> {
    return this.error<T>(ResponseCode.NOT_FOUND, message);
  }

  /**
   * åˆ›å»ºæœåŠ¡å™¨é”™è¯¯å“åº?   */
  static serverError<T = unknown>(message: string = 'Internal server error'): ApiResponse<T> {
    return this.error<T>(ResponseCode.INTERNAL_SERVER_ERROR, message);
  }

  /**
   * åˆ›å»ºç½‘ç»œé”™è¯¯å“åº”
   */
  static networkError<T = unknown>(message: string = 'Network error'): ApiResponse<T> {
    return this.error<T>(ResponseCode.NETWORK_ERROR, message);
  }

  /**
   * åˆ›å»ºè¶…æ—¶é”™è¯¯å“åº”
   */
  static timeoutError<T = unknown>(message: string = 'Request timeout'): ApiResponse<T> {
    return this.error<T>(ResponseCode.TIMEOUT_ERROR, message);
  }

  /**
   * åˆ›å»ºè§£æé”™è¯¯å“åº”
   */
  static parseError<T = unknown>(message: string = 'Parse error'): ApiResponse<T> {
    return this.error<T>(ResponseCode.PARSE_ERROR, message);
  }

  /**
   * åˆ›å»ºéªŒè¯é”™è¯¯å“åº”
   */
  static validationError<T = unknown>(errors: ErrorDetail[], message: string = 'Validation failed'): ApiResponse<T> {
    return this.error<T>(ResponseCode.VALIDATION_ERROR, message, errors);
  }

  /**
   * åˆ›å»ºå•ä¸ªéªŒè¯é”™è¯¯å“åº”
   */
  static singleValidationError<T = unknown>(field: string, message: string): ApiResponse<T> {
    const error: ErrorDetail = { field, message };
    return this.validationError<T>([error]);
  }

  /**
   * ä»é”™è¯¯åˆ›å»ºå“åº?   */
  static fromError<T = unknown>(error: Error): ApiResponse<T> {
    // å¯ä»¥æ ¹æ®ä¸åŒç±»å‹çš„é”™è¯¯è¿”å›ä¸åŒçš„å“åº”
    Logger.error(TAG, `Creating response from error: ${error.message}`, error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
    
    return this.error<T>(ResponseCode.UNKNOWN_ERROR, error.message);
  }

  /**
   * åˆ›å»ºåˆ†é¡µä¿¡æ¯
   */
  static createPagination(
    page: number,
    pageSize: number,
    total: number
  ): PaginationInfo {
    const totalPages = Math.ceil(total / pageSize);
    return {
      page,
      pageSize,
      total,
      totalPages,
      hasMore: page < totalPages
    };
  }

  /**
   * åˆ›å»ºé”™è¯¯è¯¦æƒ…
   */
  static createErrorDetail(
    message: string,
    field?: string,
    code?: string,
    value?: Record<string, string | number | boolean | null>
  ): ErrorDetail {
    return {
      field,
      message,
      code,
      value
    };
  }
}


