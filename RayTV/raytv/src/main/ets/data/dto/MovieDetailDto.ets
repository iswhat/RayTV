// MovieDetailDto - ç”µå½±/è§†é¢‘è¯¦æƒ…ç›¸å…³æ•°æ®ä¼ è¾“å¯¹è±¡
import { VideoType, VideoQuality, RatingInfo, VideoSource, Episode } from '../model/Movie';
import ApiResponse from './ApiResponse';

/**
 * æ¼”å‘˜ä¿¡æ¯æ¥å£
 */
export interface Actor {
  id: string;                     // æ¼”å‘˜ID
  name: string;                   // æ¼”å‘˜åç§°
  originalName?: string;          // æ¼”å‘˜åŸå
  role?: string;                  // è§’è‰²åç§°
  avatarUrl?: string;             // æ¼”å‘˜å¤´åƒURL
  country?: string;               // å›½å®¶/åœ°åŒº
  birthYear?: number;             // å‡ºç”Ÿå¹´ä»½
  gender?: 'male' | 'female' | 'other'; // æ€§åˆ«
  description?: string;           // æ¼”å‘˜ç®€ä»?}

/**
 * å¯¼æ¼”ä¿¡æ¯æ¥å£
 */
export interface Director {
  id: string;                     // å¯¼æ¼”ID
  name: string;                   // å¯¼æ¼”åç§°
  originalName?: string;          // å¯¼æ¼”åŸå
  avatarUrl?: string;             // å¯¼æ¼”å¤´åƒURL
  country?: string;               // å›½å®¶/åœ°åŒº
  birthYear?: number;             // å‡ºç”Ÿå¹´ä»½
  description?: string;           // å¯¼æ¼”ç®€ä»?}

/**
 * ç¼–å‰§ä¿¡æ¯æ¥å£
 */
export interface Writer {
  id: string;                     // ç¼–å‰§ID
  name: string;                   // ç¼–å‰§åç§°
  originalName?: string;          // ç¼–å‰§åŸå
  avatarUrl?: string;             // ç¼–å‰§å¤´åƒURL
  country?: string;               // å›½å®¶/åœ°åŒº
  birthYear?: number;             // å‡ºç”Ÿå¹´ä»½
  description?: string;           // ç¼–å‰§ç®€ä»?}

/**
 * å½±è§†åˆ¶ä½œå…¬å¸æ¥å£
 */
export interface ProductionCompany {
  id: string;                     // å…¬å¸ID
  name: string;                   // å…¬å¸åç§°
  logoUrl?: string;               // å…¬å¸Logo URL
  country?: string;               // å…¬å¸æ‰€åœ¨å›½å®?åœ°åŒº
}

/**
 * å½±è§†åˆ¶ä½œå›½å®¶/åœ°åŒºæ¥å£
 */
export interface ProductionCountry {
  id: string;                     // å›½å®¶/åœ°åŒºID
  name: string;                   // å›½å®¶/åœ°åŒºåç§°
  code?: string;                  // å›½å®¶/åœ°åŒºä»£ç 
}

/**
 * è¯­è¨€ä¿¡æ¯æ¥å£
 */
export interface LanguageInfo {
  id: string;                     // è¯­è¨€ID
  name: string;                   // è¯­è¨€åç§°
  code: string;                   // è¯­è¨€ä»£ç 
  isOriginal?: boolean;           // æ˜¯å¦ä¸ºåŸå£?}

/**
 * å›¾ç‰‡èµ„æºæ¥å£
 */
export interface ImageAsset {
  id: string;                     // å›¾ç‰‡ID
  url: string;                    // å›¾ç‰‡URL
  type: 'poster' | 'backdrop' | 'still' | 'clip' | 'logo' | 'banner' | 'other'; // å›¾ç‰‡ç±»å‹
  width?: number;                 // å›¾ç‰‡å®½åº¦
  height?: number;                // å›¾ç‰‡é«˜åº¦
  aspectRatio?: number;           // å®½é«˜æ¯?  language?: string;              // å›¾ç‰‡è¯­è¨€
  caption?: string;               // å›¾ç‰‡è¯´æ˜
  fileSize?: number;              // æ–‡ä»¶å¤§å°
}

/**
 * è§†é¢‘èµ„æºæ¥å£
 */
export interface VideoAsset {
  id: string;                     // è§†é¢‘ID
  url: string;                    // è§†é¢‘URL
  type: 'trailer' | 'teaser' | 'clip' | 'featurette' | 'behind_the_scenes' | 'other'; // è§†é¢‘ç±»å‹
  name?: string;                  // è§†é¢‘åç§°
  description?: string;           // è§†é¢‘æè¿°
  duration?: number;              // è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼?  thumbnailUrl?: string;          // ç¼©ç•¥å›¾URL
  quality?: VideoQuality;         // è§†é¢‘è´¨é‡
  width?: number;                 // è§†é¢‘å®½åº¦
  height?: number;                // è§†é¢‘é«˜åº¦
  language?: string;              // è§†é¢‘è¯­è¨€
  publishedAt?: number;           // å‘å¸ƒæ—¶é—´æˆ?  viewCount?: number;             // è§‚çœ‹æ¬¡æ•°
}

/**
 * è¯„è®ºä¿¡æ¯æ¥å£
 */
export interface Review {
  id: string;                     // è¯„è®ºID
  userId: string;                 // ç”¨æˆ·ID
  userName: string;               // ç”¨æˆ·å?  userAvatar?: string;            // ç”¨æˆ·å¤´åƒ
  rating: number;                 // è¯„åˆ†ï¼?-10ï¼?  content: string;                // è¯„è®ºå†…å®¹
  timestamp: number;              // è¯„è®ºæ—¶é—´æˆ?  likes: number;                  // ç‚¹èµæ•?  dislikes: number;               // ç‚¹è¸©æ•?  replyCount?: number;            // å›å¤æ•?  isSpoiler?: boolean;            // æ˜¯å¦åŒ…å«å‰§é€?  isVerified?: boolean;           // æ˜¯å¦å·²éªŒè¯?}

/**
 * ç›¸å…³æ¨èæ¥å£
 */
export interface RelatedItem {
  id: string;                     // å†…å®¹ID
  title: string;                  // æ ‡é¢˜
  type: VideoType;                // è§†é¢‘ç±»å‹
  coverUrl: string;               // å°é¢URL
  rating?: number;                // è¯„åˆ†
  releaseYear?: number;           // å‘è¡Œå¹´ä»½
  genres?: string[];              // ç±»å‹æ ‡ç­¾
  reason?: string;                // æ¨èç†ç”±
  similarityScore?: number;       // ç›¸ä¼¼åº¦åˆ†æ•?}

/**
 * ç”µå½±/è§†é¢‘è¯¦æƒ…æ•°æ®æ¥å£
 */
export interface MovieDetailData {
  // åŸºæœ¬ä¿¡æ¯
  id: string;                     // å†…å®¹ID
  title: string;                  // æ ‡é¢˜
  originalTitle?: string;         // åŸå§‹æ ‡é¢˜
  subtitle?: string;              // å‰¯æ ‡é¢?  type: VideoType;                // è§†é¢‘ç±»å‹
  description: string;            // ç®€ä»?  longDescription?: string;       // è¯¦ç»†ä»‹ç»
  
  // æ—¶é—´ä¿¡æ¯
  releaseYear: number;            // å‘è¡Œå¹´ä»½
  releaseDate?: string;           // å‘è¡Œæ—¥æœŸ
  runtime: number;                // æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  
  // è¯„åˆ†ä¿¡æ¯
  rating: RatingInfo;             // è¯„åˆ†ä¿¡æ¯
  votes?: number;                 // è¯„åˆ†äººæ•°
  
  // åˆ†ç±»ä¿¡æ¯
  genres: string[];               // ç±»å‹æ ‡ç­¾
  tags?: string[];                // å…¶ä»–æ ‡ç­¾
  
  // åˆ¶ä½œä¿¡æ¯
  directors: Director[];          // å¯¼æ¼”åˆ—è¡¨
  writers: Writer[];              // ç¼–å‰§åˆ—è¡¨
  actors: Actor[];                // æ¼”å‘˜åˆ—è¡¨
  productionCompanies: ProductionCompany[]; // åˆ¶ä½œå…¬å¸
  productionCountries: ProductionCountry[]; // åˆ¶ä½œå›½å®¶/åœ°åŒº
  
  // è¯­è¨€ä¿¡æ¯
  languages: LanguageInfo[];      // è¯­è¨€ä¿¡æ¯
  
  // åª’ä½“èµ„æº
  posters: ImageAsset[];          // æµ·æŠ¥å›¾ç‰‡
  backdrops: ImageAsset[];        // èƒŒæ™¯å›¾ç‰‡
  stills?: ImageAsset[];          // å‰§ç…§
  videos: VideoAsset[];           // è§†é¢‘èµ„æºï¼ˆé¢„å‘Šç‰‡ç­‰ï¼‰
  
  // å†…å®¹å¯ç”¨æ€?  isVip?: boolean;                // æ˜¯å¦VIPå†…å®¹
  isNew?: boolean;                // æ˜¯å¦æ–°å†…å®?  isHot?: boolean;                // æ˜¯å¦çƒ­é—¨
  isExclusive?: boolean;          // æ˜¯å¦ç‹¬å®¶
  
  // ç³»åˆ—ä¿¡æ¯ï¼ˆç”µè§†å‰§ã€åŠ¨æ¼«ç­‰ï¼?  totalEpisodes?: number;         // æ€»é›†æ•?  airedEpisodes?: number;         // å·²æ›´æ–°é›†æ•?  status?: 'ongoing' | 'completed' | 'upcoming'; // è¿è½½çŠ¶æ€?  seasons?: number;               // å­£æ•°
  currentSeason?: number;         // å½“å‰å­?  
  // æŠ€æœ¯ä¿¡æ?  aspectRatio?: number;           // ç”»é¢æ¯”ä¾‹
  colorInfo?: string;             // è‰²å½©ä¿¡æ¯
  soundMix?: string;              // éŸ³æ•ˆæ··éŸ³
  
  // å¤–éƒ¨é“¾æ¥
  imdbId?: string;                // IMDB ID
  tmdbId?: string;                // TMDB ID
  doubanId?: string;              // è±†ç“£ ID
  
  // æ¥æºä¿¡æ¯
  provider?: string;              // å†…å®¹æä¾›å•?  providerId?: string;            // æä¾›å•†ID
  sourceUpdatedAt?: number;       // æ¥æºæ›´æ–°æ—¶é—´
  
  // è§‚çœ‹ç»Ÿè®¡
  viewCount?: number;             // è§‚çœ‹æ¬¡æ•°
  favoriteCount?: number;         // æ”¶è—æ¬¡æ•°
  commentCount?: number;          // è¯„è®ºæ¬¡æ•°
  
  // é™„åŠ ä¿¡æ¯
  isFavorite?: boolean;           // å½“å‰ç”¨æˆ·æ˜¯å¦å·²æ”¶è—?  watchProgress?: number;         // è§‚çœ‹è¿›åº¦
  lastWatchTime?: number;         // æœ€åè§‚çœ‹æ—¶é—?  
  // æ’­æ”¾æºä¿¡æ?  sources: VideoSource[];         // æ’­æ”¾æºåˆ—è¡?  
  // å‰§é›†ä¿¡æ¯ï¼ˆé’ˆå¯¹ç”µè§†å‰§ã€åŠ¨æ¼«ç­‰ï¼?  episodes?: Episode[];           // å‰§é›†åˆ—è¡¨
  
  // ç›¸å…³å†…å®¹
  related?: RelatedItem[];        // ç›¸å…³æ¨è
  recommendations?: RelatedItem[]; // æ¨èå†…å®¹
  similar?: RelatedItem[];        // ç›¸ä¼¼å†…å®¹
  
  // è¯„è®ºä¿¡æ¯
  reviews?: Review[];             // è¯„è®ºåˆ—è¡¨
  
  // é™„åŠ å…ƒæ•°æ?  metadata?: Record<string, string | number | boolean | null>; // é¢å¤–å…ƒæ•°æ?}

/**
 * ç”µå½±/è§†é¢‘è¯¦æƒ…APIå“åº”
 */
export type MovieDetailApiResponse = ApiResponse<MovieDetailData>;

/**
 * å‰§é›†åˆ—è¡¨å“åº”æ¥å£
 */
export interface EpisodesResponseData {
  id: string;                     // å†…å®¹ID
  title: string;                  // æ ‡é¢˜
  season: number;                 // å­£æ•°
  totalEpisodes: number;          // æ€»é›†æ•?  airedEpisodes: number;          // å·²æ›´æ–°é›†æ•?  episodes: Episode[];            // å‰§é›†åˆ—è¡¨
  hasMore: boolean;               // æ˜¯å¦æœ‰æ›´å¤?  nextPage?: number;              // ä¸‹ä¸€é¡µé¡µç ?}

/**
 * å‰§é›†åˆ—è¡¨APIå“åº”
 */
export type EpisodesApiResponse = ApiResponse<EpisodesResponseData>;

/**
 * è§†é¢‘æºè¯·æ±‚å‚æ•°æ¥å? */
export interface VideoSourceRequest {
  contentId: string;              // å†…å®¹ID
  episodeId?: string;             // å‰§é›†IDï¼ˆå¯é€‰ï¼Œé’ˆå¯¹ç”µè§†å‰§ç­‰ï¼?  season?: number;                // å­£æ•°ï¼ˆå¯é€‰ï¼‰
  episode?: number;               // é›†æ•°ï¼ˆå¯é€‰ï¼‰
  preferredQuality?: VideoQuality; // é¦–é€‰ç”»è´?  preferredLanguage?: string;     // é¦–é€‰è¯­è¨€
  providerId?: string;            // æä¾›å•†ID
}

/**
 * è§†é¢‘æºå“åº”æ¥å? */
export interface VideoSourcesResponseData {
  contentId: string;              // å†…å®¹ID
  sources: VideoSource[];         // è§†é¢‘æºåˆ—è¡?  defaultSource?: string;         // é»˜è®¤è§†é¢‘æºID
  fallbackSource?: string;        // å¤‡ç”¨è§†é¢‘æºID
  availableQualities: VideoQuality[]; // å¯ç”¨ç”»è´¨åˆ—è¡¨
  availableLanguages: string[];   // å¯ç”¨è¯­è¨€åˆ—è¡¨
}

/**
 * è§†é¢‘æºAPIå“åº”
 */
export type VideoSourcesApiResponse = ApiResponse<VideoSourcesResponseData>;

/**
 * è§†é¢‘æ’­æ”¾çŠ¶æ€æ¥å? */
export interface PlaybackState {
  contentId: string;              // å†…å®¹ID
  episodeId?: string;             // å‰§é›†ID
  position: number;               // æ’­æ”¾ä½ç½®ï¼ˆæ¯«ç§’ï¼‰
  duration: number;               // æ€»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼?  completed: boolean;             // æ˜¯å¦æ’­æ”¾å®Œæˆ
  quality?: VideoQuality;         // æ’­æ”¾ç”»è´¨
  language?: string;              // æ’­æ”¾è¯­è¨€
  volume?: number;                // éŸ³é‡
  muted?: boolean;                // æ˜¯å¦é™éŸ³
  timestamp: number;              // æ›´æ–°æ—¶é—´æˆ?  sourceId?: string;              // æ’­æ”¾æºID
}

/**
 * è§†é¢‘æ’­æ”¾çŠ¶æ€APIå“åº”
 */
export type PlaybackStateApiResponse = ApiResponse<PlaybackState>;

/**
 * æ”¶è—çŠ¶æ€æ¥å? */
export interface FavoriteState {
  contentId: string;              // å†…å®¹ID
  isFavorite: boolean;            // æ˜¯å¦æ”¶è—
  favoriteAt?: number;            // æ”¶è—æ—¶é—´æˆ?  note?: string;                  // æ”¶è—å¤‡æ³¨
  tags?: string[];                // æ”¶è—æ ‡ç­¾
  rating?: number;                // ç”¨æˆ·è¯„åˆ†
}

/**
 * æ”¶è—çŠ¶æ€APIå“åº”
 */
export type FavoriteStateApiResponse = ApiResponse<FavoriteState>;

/**
 * è¯„è®ºè¯·æ±‚å‚æ•°æ¥å£
 */
export interface ReviewsRequest {
  contentId: string;              // å†…å®¹ID
  page: number;                   // é¡µç 
  pageSize: number;               // æ¯é¡µå¤§å°
  sort?: 'newest' | 'highest' | 'lowest' | 'most_liked'; // æ’åºæ–¹å¼
  minRating?: number;             // æœ€ä½è¯„åˆ?  maxRating?: number;             // æœ€é«˜è¯„åˆ?  includeSpoilers?: boolean;      // æ˜¯å¦åŒ…å«å‰§é€?}

/**
 * è¯„è®ºåˆ—è¡¨å“åº”æ¥å£
 */
export interface ReviewsResponseData {
  contentId: string;              // å†…å®¹ID
  reviews: Review[];              // è¯„è®ºåˆ—è¡¨
  total: number;                  // æ€»è¯„è®ºæ•°
  page: number;                   // å½“å‰é¡µç 
  pageSize: number;               // æ¯é¡µå¤§å°
  totalPages: number;             // æ€»é¡µæ•?  hasMore: boolean;               // æ˜¯å¦æœ‰æ›´å¤?  averageRating?: number;         // å¹³å‡è¯„åˆ†
}

/**
 * è¯„è®ºåˆ—è¡¨APIå“åº”
 */
export type ReviewsApiResponse = ApiResponse<ReviewsResponseData>;

/**
 * ç”µå½±è¯¦æƒ…ç›¸å…³çš„å·¥å…·æ–¹æ³? */
export class MovieDetailUtils {
  /**
   * è·å–ç”µå½±/è§†é¢‘çš„æ˜¾ç¤ºæ ‡é¢?   */
  static getDisplayName(movie: Partial<MovieDetailData>): string {
    if (movie.title && movie.originalTitle && movie.title !== movie.originalTitle) {
      return `${movie.title} / ${movie.originalTitle}`;
    }
    return movie.title || movie.originalTitle || 'æœªçŸ¥æ ‡é¢˜';
  }

  /**
   * è·å–å‘å¸ƒå¹´ä»½çš„æ˜¾ç¤ºæ–‡æœ?   */
  static getReleaseYearText(movie: Partial<MovieDetailData>): string {
    if (movie.releaseDate) {
      const date = new Date(movie.releaseDate);
      return date.getFullYear().toString();
    }
    return movie.releaseYear?.toString() || 'æœªçŸ¥';
  }

  /**
   * è·å–æ—¶é•¿çš„æ˜¾ç¤ºæ–‡æœ?   */
  static getDurationText(movie: Partial<MovieDetailData>): string {
    if (movie.runtime) {
      const hours = Math.floor(movie.runtime / 60);
      const minutes = movie.runtime % 60;
      if (hours > 0) {
        return `${hours}å°æ—¶${minutes > 0 ? minutes + 'åˆ†é’Ÿ' : ''}`;
      }
      return `${minutes}åˆ†é’Ÿ`;
    }
    return 'æœªçŸ¥æ—¶é•¿';
  }

  /**
   * è·å–è¯„åˆ†çš„æ˜¾ç¤ºæ–‡æœ?   */
  static getRatingText(rating: RatingInfo): string {
    if (rating.score !== null && rating.score !== undefined) {
      return rating.score.toFixed(1);
    }
    return 'æš‚æ— è¯„åˆ†';
  }

  /**
   * è·å–æ¼”å‘˜åˆ—è¡¨çš„æ˜¾ç¤ºæ–‡æœ?   */
  static getActorsText(actors: Actor[], maxCount: number = 5): string {
    if (!actors || actors.length === 0) {
      return 'æœªçŸ¥';
    }
    const displayNames = actors.slice(0, maxCount).map(actor => actor.name);
    if (actors.length > maxCount) {
      displayNames.push('ç­?);
    }
    return displayNames.join('ã€?);
  }

  /**
   * è·å–å¯¼æ¼”åˆ—è¡¨çš„æ˜¾ç¤ºæ–‡æœ?   */
  static getDirectorsText(directors: Director[]): string {
    if (!directors || directors.length === 0) {
      return 'æœªçŸ¥';
    }
    return directors.map(director => director.name).join('ã€?);
  }

  /**
   * è·å–ç±»å‹æ ‡ç­¾çš„æ˜¾ç¤ºæ–‡æœ?   */
  static getGenresText(genres: string[]): string {
    return genres?.join(' / ') || 'æœªçŸ¥ç±»å‹';
  }

  /**
   * è·å–ç¬¬ä¸€å¼ æµ·æŠ¥URL
   */
  static getFirstPosterUrl(posters: ImageAsset[]): string | undefined {
    return posters && posters.length > 0 ? posters[0].url : undefined;
  }

  /**
   * è·å–ç¬¬ä¸€å¼ èƒŒæ™¯å›¾ç‰‡URL
   */
  static getFirstBackdropUrl(backdrops: ImageAsset[]): string | undefined {
    return backdrops && backdrops.length > 0 ? backdrops[0].url : undefined;
  }

  /**
   * è·å–ç¬¬ä¸€ä¸ªé¢„å‘Šç‰‡URL
   */
  static getFirstTrailerUrl(videos: VideoAsset[]): string | undefined {
    if (!videos || videos.length === 0) {
      return undefined;
    }
    const trailer = videos.find(video => video.type === 'trailer');
    return trailer?.url || videos[0].url;
  }

  /**
   * è·å–è§‚çœ‹è¿›åº¦ç™¾åˆ†æ¯?   */
  static getWatchProgressPercentage(state: PlaybackState): number {
    if (!state || !state.duration || state.duration <= 0) {
      return 0;
    }
    return Math.min(100, Math.max(0, (state.position / state.duration) * 100));
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æœªè§‚çœ‹å®Œçš„è¿›åº?   */
  static hasUnwatchedProgress(state: PlaybackState | undefined): boolean {
    if (!state || state.completed) {
      return false;
    }
    // è¿›åº¦è¶…è¿‡5%ä¸”æœªå®Œæˆè§†ä¸ºæœ‰æœªè§‚çœ‹å®Œçš„è¿›åº¦
    const percentage = this.getWatchProgressPercentage(state);
    return percentage >= 5 && percentage < 95;
  }
}
