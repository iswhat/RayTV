// NetworkRepository - ç½‘ç»œæœåŠ¡æ¥å£
import Logger from '../../common/util/Logger';
import Movie from '../model/Movie';
import SearchResult from '../model/SearchResult';

const TAG = 'NetworkRepository';

/**
 * ç½‘ç»œè¯·æ±‚ç»“æœæ¥å£
 */
export interface NetworkResult<T> {
  success: boolean;
  data?: T;
  error?: Error;
  message?: string;
  code?: number;
  headers?: Record<string, string>;
  statusCode?: number;
}

/**
 * ç½‘ç»œè¯·æ±‚é…ç½®æ¥å£
 */
export interface NetworkConfig {
  baseUrl: string;
  timeout: number;      // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  retryCount: number;   // é‡è¯•æ¬¡æ•°
  headers?: Record<string, string>;  // é»˜è®¤è¯·æ±‚å¤?  params?: Record<string, string>;    // é»˜è®¤å‚æ•°
  cacheEnabled?: boolean;  // æ˜¯å¦å¯ç”¨ç¼“å­˜
  cacheExpiry?: number;    // ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
}

/**
 * æœç´¢å‚æ•°æ¥å£
 */
export interface SearchParams {
  keyword: string;        // æœç´¢å…³é”®è¯?  page: number;           // é¡µç 
  pageSize: number;       // æ¯é¡µæ•°é‡
  type?: string;          // å†…å®¹ç±»å‹ç­›é€?  genre?: string;         // ç±»å‹ç­›é€?  year?: number;          // å¹´ä»½ç­›é€?  region?: string;        // åœ°åŒºç­›é€?  sortBy?: string;        // æ’åºå­—æ®µ
  sortOrder?: 'asc' | 'desc'; // æ’åºé¡ºåº
  filters?: Record<string, string | number | boolean | string[]>; // é¢å¤–ç­›é€‰æ¡ä»?}

/**
 * åˆ†é¡µå“åº”æ¥å£
 */
export interface PaginatedResponse<T> {
  items: T[];             // å½“å‰é¡µæ•°æ?  total: number;          // æ€»æ•°æ®é‡
  page: number;           // å½“å‰é¡µç 
  pageSize: number;       // æ¯é¡µæ•°é‡
  totalPages: number;     // æ€»é¡µæ•?  hasMore: boolean;       // æ˜¯å¦æœ‰æ›´å¤?  extra?: Record<string, string | number | boolean | string[]>; // é¢å¤–ä¿¡æ¯
}

/**
 * è§†é¢‘æºæ¥å? */
export interface VideoSourceInfo {
  id: string;             // æºID
  name: string;           // æºåç§?  url: string;            // æºURL
  quality: string;        // ç”»è´¨
  format: string;         // æ ¼å¼
  size?: number;          // æ–‡ä»¶å¤§å°
  duration?: number;      // æ—¶é•¿
  isDefault?: boolean;    // æ˜¯å¦é»˜è®¤
  headers?: Record<string, string>; // è¯·æ±‚å¤?  cookies?: string;       // Cookies
  extra?: Record<string, Record<string, string | number | boolean>>; // é¢å¤–ä¿¡æ¯
}

/**
 * ç« èŠ‚ä¿¡æ¯æ¥å£
 */
export interface ChapterInfo {
  id: string;             // ç« èŠ‚ID
  title: string;          // ç« èŠ‚æ ‡é¢˜
  index: number;          // ç« èŠ‚ç´¢å¼•
  duration?: number;      // ç« èŠ‚æ—¶é•¿
  startTime?: number;     // å¼€å§‹æ—¶é—´ç‚¹
  endTime?: number;       // ç»“æŸæ—¶é—´ç‚?  previewUrl?: string;    // é¢„è§ˆå›¾URL
  description?: string;   // ç« èŠ‚æè¿°
}

/**
 * ç›´æ’­é¢‘é“ä¿¡æ¯æ¥å£
 */
export interface LiveChannelInfo {
  id: string;             // é¢‘é“ID
  name: string;           // é¢‘é“åç§°
  logo?: string;          // é¢‘é“Logo
  url: string;            // æ’­æ”¾URL
  category?: string;      // é¢‘é“åˆ†ç±»
  country?: string;       // æ‰€å±å›½å®?  language?: string;      // è¯­è¨€
  description?: string;   // é¢‘é“æè¿°
  epgUrl?: string;        // EPGæŒ‡å—URL
  nowPlaying?: string;    // å½“å‰æ’­æ”¾èŠ‚ç›®
  nextPlaying?: string;   // ä¸‹ä¸€ä¸ªèŠ‚ç›?  isFavorite?: boolean;   // æ˜¯å¦æ”¶è—
  sortOrder?: number;     // æ’åºé¡ºåº
  extra?: Record<string, Record<string, string | number | boolean>>; // é¢å¤–ä¿¡æ¯
}

/**
 * è§£æå™¨æ¥å? */
export interface ParserInfo {
  id: string;             // è§£æå™¨ID
  name: string;           // è§£æå™¨åç§?  description?: string;   // è§£æå™¨æè¿?  supports?: string[];    // æ”¯æŒçš„ç½‘ç«?åè®®
  version?: string;       // ç‰ˆæœ¬
  isEnabled?: boolean;    // æ˜¯å¦å¯ç”¨
  config?: Record<string, Record<string, string | number | boolean>>; // è§£æå™¨é…ç½?}

/**
 * ç½‘ç»œä»“åº“æ¥å£
 * å®šä¹‰ä¸å¤–éƒ¨æ•°æ®æºäº¤äº’çš„æŠ½è±¡æ–¹æ³? */
export default interface NetworkRepository {
  /**
   * åˆå§‹åŒ–ç½‘ç»œæœåŠ?   * @param config ç½‘ç»œé…ç½®
   * @returns åˆå§‹åŒ–ç»“æ?   */
  initialize(config: NetworkConfig): Promise<NetworkResult<void>>;

  /**
   * è®¾ç½®ç½‘ç»œé…ç½®
   * @param config ç½‘ç»œé…ç½®
   */
  setConfig(config: Partial<NetworkConfig>): void;

  /**
   * è·å–å½“å‰ç½‘ç»œé…ç½®
   * @returns ç½‘ç»œé…ç½®
   */
  getConfig(): NetworkConfig;

  // ========== æœç´¢ç›¸å…³æ¥å£ ==========
  
  /**
   * æœç´¢å†…å®¹
   * @param params æœç´¢å‚æ•°
   * @returns æœç´¢ç»“æœ
   */
  searchContent(params: SearchParams): Promise<NetworkResult<PaginatedResponse<SearchResult>>>;

  /**
   * è·å–çƒ­é—¨æœç´¢å…³é”®è¯?   * @param limit é™åˆ¶æ•°é‡
   * @returns çƒ­é—¨æœç´¢å…³é”®è¯åˆ—è¡?   */
  getHotSearchKeywords(limit: number = 20): Promise<NetworkResult<string[]>>;

  /**
   * è·å–æœç´¢å»ºè®®
   * @param keyword æœç´¢å…³é”®è¯?   * @param limit é™åˆ¶æ•°é‡
   * @returns æœç´¢å»ºè®®åˆ—è¡¨
   */
  getSearchSuggestions(keyword: string, limit: number = 10): Promise<NetworkResult<string[]>>;

  // ========== ç”µå½±/è§†é¢‘ç›¸å…³æ¥å£ ==========
  
  /**
   * è·å–ç”µå½±è¯¦æƒ…
   * @param movieId ç”µå½±ID
   * @returns ç”µå½±è¯¦æƒ…
   */
  getMovieDetail(movieId: string): Promise<NetworkResult<Movie>>;

  /**
   * è·å–ç”µå½±åˆ—è¡¨
   * @param params åˆ†é¡µå‚æ•°
   * @returns ç”µå½±åˆ—è¡¨
   */
  getMovieList(params: SearchParams): Promise<NetworkResult<PaginatedResponse<Movie>>>;

  /**
   * è·å–æ¨èç”µå½±
   * @param movieId å½“å‰ç”µå½±ID
   * @param limit é™åˆ¶æ•°é‡
   * @returns æ¨èç”µå½±åˆ—è¡¨
   */
  getRecommendedMovies(movieId: string, limit: number = 20): Promise<NetworkResult<Movie[]>>;

  /**
   * è·å–ç›¸å…³ç”µå½±
   * @param movieId å½“å‰ç”µå½±ID
   * @param limit é™åˆ¶æ•°é‡
   * @returns ç›¸å…³ç”µå½±åˆ—è¡¨
   */
  getRelatedMovies(movieId: string, limit: number = 20): Promise<NetworkResult<Movie[]>>;

  /**
   * è·å–ç”µå½±è¯„åˆ†
   * @param movieId ç”µå½±ID
   * @returns è¯„åˆ†ä¿¡æ¯
   */
  getMovieRating(movieId: string): Promise<NetworkResult<Record<string, string | number | boolean>>>;

  // ========== è§†é¢‘æ’­æ”¾ç›¸å…³æ¥å£ ==========
  
  /**
   * è·å–è§†é¢‘æºåˆ—è¡?   * @param contentId å†…å®¹ID
   * @param contentType å†…å®¹ç±»å‹
   * @returns è§†é¢‘æºåˆ—è¡?   */
  getVideoSources(contentId: string, contentType: string): Promise<NetworkResult<VideoSourceInfo[]>>;

  /**
   * è§£æè§†é¢‘æº?   * @param sourceUrl è§†é¢‘æºURL
   * @param parserId è§£æå™¨IDï¼ˆå¯é€‰ï¼‰
   * @returns è§£æåçš„è§†é¢‘ä¿¡æ¯
   */
  parseVideoSource(sourceUrl: string, parserId?: string): Promise<NetworkResult<VideoSourceInfo>>;

  /**
   * è·å–è§†é¢‘ç« èŠ‚åˆ—è¡¨
   * @param contentId å†…å®¹ID
   * @param season å­£æ•°
   * @returns ç« èŠ‚åˆ—è¡¨
   */
  getVideoChapters(contentId: string, season: number = 1): Promise<NetworkResult<ChapterInfo[]>>;

  /**
   * è·å–è§†é¢‘å¼¹å¹•
   * @param contentId å†…å®¹ID
   * @param startTime å¼€å§‹æ—¶é—?   * @param endTime ç»“æŸæ—¶é—´
   * @returns å¼¹å¹•åˆ—è¡¨
   */
  getVideoDanmaku(contentId: string, startTime: number, endTime: number): Promise<NetworkResult<Record<string, string | number | boolean>[]>>;

  /**
   * æäº¤è§†é¢‘å¼¹å¹•
   * @param contentId å†…å®¹ID
   * @param danmaku å¼¹å¹•å†…å®¹
   * @param timestamp æ—¶é—´æˆ?   * @returns æäº¤ç»“æœ
   */
  submitDanmaku(contentId: string, danmaku: string, timestamp: number): Promise<NetworkResult<boolean>>;

  // ========== åˆ†ç±»ç›¸å…³æ¥å£ ==========
  
  /**
   * è·å–æ‰€æœ‰åˆ†ç±?   * @returns åˆ†ç±»åˆ—è¡¨
   */
  getCategories(): Promise<NetworkResult<Record<string, string[]>>>;

  /**
   * è·å–ç±»å‹åˆ—è¡¨
   * @returns ç±»å‹åˆ—è¡¨
   */
  getGenres(): Promise<NetworkResult<string[]>>;

  /**
   * è·å–åœ°åŒºåˆ—è¡¨
   * @returns åœ°åŒºåˆ—è¡¨
   */
  getRegions(): Promise<NetworkResult<string[]>>;

  /**
   * è·å–å¹´ä»½åˆ—è¡¨
   * @returns å¹´ä»½åˆ—è¡¨
   */
  getYears(): Promise<NetworkResult<number[]>>;

  // ========== æ’è¡Œæ¦œç›¸å…³æ¥å?==========
  
  /**
   * è·å–æ’è¡Œæ¦?   * @param type æ’è¡Œæ¦œç±»å?   * @param limit é™åˆ¶æ•°é‡
   * @returns æ’è¡Œæ¦œæ•°æ?   */
  getRankings(type: string, limit: number = 20): Promise<NetworkResult<Movie[]>>;

  /**
   * è·å–æœ¬å‘¨çƒ­æ¦œ
   * @param limit é™åˆ¶æ•°é‡
   * @returns çƒ­æ¦œæ•°æ®
   */
  getWeeklyHot(limit: number = 20): Promise<NetworkResult<Movie[]>>;

  /**
   * è·å–æœ¬æœˆæ–°ç‰‡
   * @param limit é™åˆ¶æ•°é‡
   * @returns æ–°ç‰‡æ•°æ®
   */
  getMonthlyNew(limit: number = 20): Promise<NetworkResult<Movie[]>>;

  // ========== ç›´æ’­ç›¸å…³æ¥å£ ==========
  
  /**
   * è·å–ç›´æ’­é¢‘é“åˆ—è¡¨
   * @param category é¢‘é“åˆ†ç±»
   * @returns é¢‘é“åˆ—è¡¨
   */
  getLiveChannels(category?: string): Promise<NetworkResult<LiveChannelInfo[]>>;

  /**
   * è·å–ç›´æ’­EPG
   * @param channelId é¢‘é“ID
   * @returns EPGæ•°æ®
   */
  getLiveEpg(channelId: string): Promise<NetworkResult<Record<string, string | number | boolean>>>;

  /**
   * æœç´¢ç›´æ’­é¢‘é“
   * @param keyword æœç´¢å…³é”®è¯?   * @returns åŒ¹é…çš„é¢‘é“åˆ—è¡?   */
  searchLiveChannels(keyword: string): Promise<NetworkResult<LiveChannelInfo[]>>;

  // ========== è§£æå™¨ç›¸å…³æ¥å?==========
  
  /**
   * è·å–æ‰€æœ‰è§£æå™¨
   * @returns è§£æå™¨åˆ—è¡?   */
  getParsers(): Promise<NetworkResult<ParserInfo[]>>;

  /**
   * æ£€æµ‹è§£æå™¨æ˜¯å¦å¯ç”¨
   * @param parserId è§£æå™¨ID
   * @returns å¯ç”¨æ€§æ£€æµ‹ç»“æ?   */
  checkParserAvailability(parserId: string): Promise<NetworkResult<boolean>>;

  // ========== è®¾ç½®ç›¸å…³æ¥å£ ==========
  
  /**
   * æäº¤åé¦ˆ
   * @param feedback åé¦ˆå†…å®¹
   * @param contact è”ç³»æ–¹å¼
   * @returns æäº¤ç»“æœ
   */
  submitFeedback(feedback: string, contact?: string): Promise<NetworkResult<boolean>>;

  /**
   * æ£€æŸ¥æ›´æ–?   * @param currentVersion å½“å‰ç‰ˆæœ¬
   * @returns æ›´æ–°ä¿¡æ¯
   */
  checkUpdate(currentVersion: string): Promise<NetworkResult<Record<string, string | number | boolean>>>;

  /**
   * è·å–åº”ç”¨é…ç½®
   * @returns åº”ç”¨é…ç½®
   */
  getAppConfig(): Promise<NetworkResult<Record<string, string | number | boolean>>>;

  /**
   * è·å–å…¬å‘Šä¿¡æ¯
   * @returns å…¬å‘Šä¿¡æ¯
   */
  getAnnouncements(): Promise<NetworkResult<string[]>>;

  // ========== é€šç”¨ç½‘ç»œæ–¹æ³• ==========
  
  /**
   * å‘é€GETè¯·æ±‚
   * @param url è¯·æ±‚URL
   * @param params è¯·æ±‚å‚æ•°
   * @param headers è¯·æ±‚å¤?   * @returns è¯·æ±‚ç»“æœ
   */
  get<T>(url: string, params?: Record<string, string | number | boolean | string[]>, headers?: Record<string, string>): Promise<NetworkResult<T>>;

  /**
   * å‘é€POSTè¯·æ±‚
   * @param url è¯·æ±‚URL
   * @param data è¯·æ±‚æ•°æ®
   * @param headers è¯·æ±‚å¤?   * @returns è¯·æ±‚ç»“æœ
   */
  post<T>(url: string, data?: Record<string, string | number | boolean | string[]>, headers?: Record<string, string>): Promise<NetworkResult<T>>;

  /**
   * å‘é€PUTè¯·æ±‚
   * @param url è¯·æ±‚URL
   * @param data è¯·æ±‚æ•°æ®
   * @param headers è¯·æ±‚å¤?   * @returns è¯·æ±‚ç»“æœ
   */
  put<T>(url: string, data?: Record<string, string | number | boolean | string[]>, headers?: Record<string, string>): Promise<NetworkResult<T>>;

  /**
   * å‘é€DELETEè¯·æ±‚
   * @param url è¯·æ±‚URL
   * @param params è¯·æ±‚å‚æ•°
   * @param headers è¯·æ±‚å¤?   * @returns è¯·æ±‚ç»“æœ
   */
  delete<T>(url: string, params?: Record<string, string | number | boolean | string[]>, headers?: Record<string, string>): Promise<NetworkResult<T>>;

  /**
   * ä¸Šä¼ æ–‡ä»¶
   * @param url ä¸Šä¼ URL
   * @param file æ–‡ä»¶æ•°æ®
   * @param params å…¶ä»–å‚æ•°
   * @param headers è¯·æ±‚å¤?   * @returns ä¸Šä¼ ç»“æœ
   */
  upload<T>(url: string, file: File, params?: Record<string, string | number | boolean | string[]>, headers?: Record<string, string>): Promise<NetworkResult<T>>;

  /**
   * ä¸‹è½½æ–‡ä»¶
   * @param url ä¸‹è½½URL
   * @param savePath ä¿å­˜è·¯å¾„
   * @param headers è¯·æ±‚å¤?   * @returns ä¸‹è½½ç»“æœ
   */
  download(url: string, savePath: string, headers?: Record<string, string>): Promise<NetworkResult<boolean>>;

  /**
   * å–æ¶ˆæ‰€æœ‰è¯·æ±?   */
  cancelAllRequests(): void;

  /**
   * å–æ¶ˆæŒ‡å®šè¯·æ±‚
   * @param requestId è¯·æ±‚ID
   */
  cancelRequest(requestId: string): void;
}
