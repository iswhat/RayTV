// Êí≠Êîæ‰ªìÂ∫ìÁ±?- ÁÆ°ÁêÜÊí≠ÊîæÁõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÊìç‰Ω?import Logger from '../utils/Logger';
import StorageUtil from '../utils/StorageUtil';
import NetworkUtil from '../utils/NetworkUtil';
import EventBusUtil from '../utils/EventBusUtil';
import CacheService from '../service/CacheService';
import UserRepository from './UserRepository';
import VideoRepository from './VideoRepository';
import { LocalStorageType, CacheType } from '../model/commonTypes';

// Êí≠ÊîæÁä∂ÊÄÅÊûö‰∏?export enum PlaybackState {
  IDLE = 'idle',
  LOADING = 'loading',
  PLAYING = 'playing',
  PAUSED = 'paused',
  BUFFERING = 'buffering',
  ENDED = 'ended',
  ERROR = 'error'
}

// ËßÜÈ¢ëË¥®ÈáèÊûö‰∏æ
export enum VideoQuality {
  LOW = 'low',
  MEDIUM = 'medium',
  HIGH = 'high',
  HD = 'hd',
  FHD = 'fhd',
  UHD = 'uhd'
}

// Êí≠ÊîæÈÄüÂ∫¶Êûö‰∏æ
export enum PlaybackSpeed {
  QUARTER = 0.25,
  HALF = 0.5,
  NORMAL = 1.0,
  ONE_QUARTER = 1.25,
  ONE_HALF = 1.5,
  DOUBLE = 2.0
}

// Êí≠ÊîæÊ®°ÂºèÊûö‰∏æ
export enum PlaybackMode {
  DEFAULT = 'default',
  LOOP = 'loop',
  SHUFFLE = 'shuffle'
}

// Èü≥È¢ëËΩ®ÈÅìÊé•Âè£
export interface AudioTrack {
  id: string;
  language: string;
  label: string;
  isDefault: boolean;
}

// Â≠óÂπïËΩ®ÈÅìÊé•Âè£
export interface SubtitleTrack {
  id: string;
  language: string;
  label: string;
  isDefault: boolean;
}

// Êí≠Êîæ‰∫ã‰ª∂Êé•Âè£
export interface PlaybackEvent {
  type: string;
  timestamp: number;
  data?: Record<string, unknown>;
}

// Êí≠ÊîæÂéÜÂè≤È°πÊé•Âè?export interface PlaybackHistoryItem {
  contentId: string;
  contentType: 'video' | 'live';
  title: string;
  thumbnailUrl?: string;
  channelId?: string;
  channelName?: string;
  duration: number;
  position: number; // ÊúÄÂêéËßÇÁúã‰ΩçÁΩ?  lastPlayedAt: number;
  playCount: number;
  isCompleted: boolean;
}

// Êí≠ÊîæËÆæÁΩÆÊé•Âè£
export interface PlaybackSettings {
  defaultQuality: VideoQuality;
  defaultSpeed: PlaybackSpeed;
  autoPlay: boolean;
  autoResume: boolean;
  rememberPosition: boolean;
  playNextAutomatically: boolean;
  enableHardwareAcceleration: boolean;
  enableBackgroundPlayback: boolean;
  enableDataSaving: boolean;
  preferredAudioLanguage: string;
  preferredSubtitleLanguage: string;
  subtitleEnabled: boolean;
  subtitleSize: number;
  subtitleColor: string;
  subtitleBackgroundColor: string;
  subtitleFont: string;
  lastUpdated: number;
}

// Êí≠ÊîæÁªüËÆ°Êé•Âè£
export interface PlaybackStats {
  totalWatchTime: number;
  totalPlayCount: number;
  watchedVideos: number;
  completedVideos: number;
  favoriteQuality: VideoQuality;
  favoriteSpeed: PlaybackSpeed;
  byQuality: Map<VideoQuality, number>;
  bySpeed: Map<PlaybackSpeed, number>;
  byContentType: Map<'video' | 'live', number>;
  lastUpdated: number;
}

// ÂΩìÂâçÊí≠ÊîæÁä∂ÊÄÅÊé•Âè?export interface CurrentPlaybackState {
  contentId?: string;
  contentTitle?: string;
  contentType?: 'video' | 'live';
  state: PlaybackState;
  position: number;
  duration: number;
  speed: number;
  quality: VideoQuality;
  mode: PlaybackMode;
  audioTrack?: AudioTrack;
  subtitleTrack?: SubtitleTrack;
  bufferPercent: number;
  isMuted: boolean;
  volume: number;
  currentTime: number; // Áä∂ÊÄÅËÆ∞ÂΩïÊó∂Èó?}

// Êí≠ÊîæÈòüÂàóÈ°πÊé•Âè?export interface PlaybackQueueItem {
  contentId: string;
  contentType: 'video' | 'live';
  title: string;
  thumbnailUrl?: string;
  channelId?: string;
  channelName?: string;
  duration?: number;
}

export class PlaybackRepository {
  private static instance: PlaybackRepository;
  private readonly logger: Logger;
  private readonly storageUtil: StorageUtil;
  private readonly networkUtil: NetworkUtil;
  private readonly eventBus: EventBusUtil;
  private readonly cacheService: CacheService;
  private readonly userRepository: UserRepository;
  private readonly videoRepository: VideoRepository;
  
  // Â≠òÂÇ®ÈîÆÂêç
  private readonly storageKeys = {
    playbackSettings: 'playback_settings',
    playbackHistory: 'playback_history',
    playbackStats: 'playback_stats',
    currentPlaybackState: 'current_playback_state',
    playbackQueue: 'playback_queue',
    lastWatchPosition: 'last_watch_position'
  };
  
  // Êï∞ÊçÆÁºìÂ≠ò
  private playbackSettings: PlaybackSettings;
  private playbackHistory: Map<string, PlaybackHistoryItem>; // key: contentId
  private playbackStats: PlaybackStats;
  private currentPlaybackState: CurrentPlaybackState;
  private playbackQueue: PlaybackQueueItem[];
  
  // ËøáÊª§Âô®ÁºìÂ≠?  private filterCache: Map<string, unknown[]>;
  
  // Ëá™Âä®‰øùÂ≠òÈó¥ÈöîÔºàÊØ´ÁßíÔºâ
  private readonly autoSaveInterval = 30000; // 30Áß?  
  // Ëá™Âä®‰øùÂ≠òËÆ°Êó∂Âô?  private autoSaveTimer: number | null = null;
  
  // ÊúÄÂ§ßÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èá?  private readonly maxHistoryItems = 100;
  
  // ÊúÄÂ§ßÈòüÂàóÈïøÂ∫?  private readonly maxQueueLength = 50;
  
  private constructor() {
    this.logger = Logger.getInstance();
    this.storageUtil = StorageUtil.getInstance();
    this.networkUtil = NetworkUtil.getInstance();
    this.eventBus = EventBusUtil.getInstance();
    this.cacheService = CacheService.getInstance();
    this.userRepository = UserRepository.getInstance();
    this.videoRepository = VideoRepository.getInstance();
    
    // ÂàùÂßãÂåñÈªòËÆ§Êï∞Êç?    this.playbackSettings = this.getDefaultSettings();
    this.playbackHistory = new Map();
    this.playbackStats = this.getEmptyStats();
    this.currentPlaybackState = this.getEmptyPlaybackState();
    this.playbackQueue = [];
    this.filterCache = new Map();
    
    // ÂàùÂßãÂå?    this.initialize();
  }
  
  /**
   * Ëé∑ÂèñÂÆû‰æã
   */
  public static getInstance(): PlaybackRepository {
    if (!PlaybackRepository.instance) {
      PlaybackRepository.instance = new PlaybackRepository();
    }
    return PlaybackRepository.instance;
  }
  
  /**
   * Ê£ÄÊü•ÂØπË±°ÊòØÂê¶ÂåÖÂê´ÊåáÂÆöÂ±ûÊÄ?   * Êõø‰ª£Object.prototype.hasOwnProperty.callÔºåÂÖºÂÆπArkTSËØ≠Ê≥ï
   */
  private hasOwnProperty<T extends object>(obj: T, key: string): boolean {
    return Object.getOwnPropertyNames(obj).includes(key);
  }

  /**
   * Ëé∑ÂèñÂØπË±°ÁöÑÊâÄÊúâÂÄ?   * Êõø‰ª£Object.valuesÔºåÂÖºÂÆπArkTSËØ≠Ê≥ï
   */
  private getObjectValues<T extends object>(obj: T): Record<string, string | number | boolean | null>[] {
    const values: Record<string, string | number | boolean | null>[] = [];
    for (const key in obj) {
      if (this.hasOwnProperty(obj, key)) {
        values.push(obj[key]);
      }
    }
    return values;
  }
  
  /**
   * ÂàùÂßãÂå?   */
  public async initialize(): Promise<void> {
    try {
      // Âä†ËΩΩËÆæÁΩÆ
      await this.loadSettings();
      
      // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
      await this.loadHistory();
      
      // Âä†ËΩΩÁªüËÆ°
      await this.loadStats();
      
      // Âä†ËΩΩÂΩìÂâçÊí≠ÊîæÁä∂ÊÄ?      await this.loadCurrentPlaybackState();
      
      // Âä†ËΩΩÊí≠ÊîæÈòüÂàó
      await this.loadPlaybackQueue();
      
      // ÂêØÂä®Ëá™Âä®‰øùÂ≠ò
      this.startAutoSave();
      
      this.logger.info(`PlaybackRepository initialized with ${this.playbackHistory.size} history items`);
    } catch (error) {
      this.Logger.error('Failed to initialize PlaybackRepository', error as Error);
    }
  }
  
  /**
   * Ëé∑ÂèñÈªòËÆ§ËÆæÁΩÆ
   */
  private getDefaultSettings(): PlaybackSettings {
    return {
      defaultQuality: VideoQuality.HIGH, defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( instanceof Error ? defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now( : new Error(String(defaultSpeed: PlaybackSpeed.NORMAL,
      autoPlay: true,
      autoResume: true,
      rememberPosition: true,
      playNextAutomatically: true,
      enableHardwareAcceleration: true,
      enableBackgroundPlayback: true,
      enableDataSaving: false,
      preferredAudioLanguage: 'en',
      preferredSubtitleLanguage: 'en',
      subtitleEnabled: false,
      subtitleSize: 16,
      subtitleColor: '#FFFFFF',
      subtitleBackgroundColor: 'transparent',
      subtitleFont: 'default',
      lastUpdated: Date.now()))))))
    };
  }
  
  /**
   * Ëé∑ÂèñÁ©∫ÁöÑÁªüËÆ°Êï∞ÊçÆ
   */
  private getEmptyStats(): PlaybackStats {
    const byQuality = new Map<VideoQuality, number>();
    const bySpeed = new Map<PlaybackSpeed, number>();
    const byContentType = new Map<'video' | 'live', number>();
    
    // ÂàùÂßãÂåñÁîªË¥®ÁªüËÆ?    this.getObjectValues(VideoQuality).forEach(quality => {
      byQuality.set(quality, 0);
    });
    
    // ÂàùÂßãÂåñÊí≠ÊîæÈÄüÂ∫¶ÁªüËÆ°
    this.getObjectValues(PlaybackSpeed).forEach(speed => {
      bySpeed.set(speed, 0);
    });
    
    // ÂàùÂßãÂåñÂÜÖÂÆπÁ±ªÂûãÁªüËÆ?    byContentType.set('video', 0);
    byContentType.set('live', 0);
    
    return {
      totalWatchTime: 0,
      totalPlayCount: 0,
      watchedVideos: 0,
      completedVideos: 0,
      favoriteQuality: VideoQuality.HIGH,
      favoriteSpeed: PlaybackSpeed.NORMAL,
      byQuality,
      bySpeed,
      byContentType,
      lastUpdated: Date.now()
    };
  }
  
  /**
   * Ëé∑ÂèñÁ©∫ÁöÑÊí≠ÊîæÁä∂ÊÄ?   */
  private getEmptyPlaybackState(): CurrentPlaybackState {
    return {
      state: PlaybackState.IDLE,
      position: 0,
      duration: 0,
      speed: this.playbackSettings.defaultSpeed,
      quality: this.playbackSettings.defaultQuality,
      mode: PlaybackMode.DEFAULT,
      bufferPercent: 0,
      isMuted: false,
      volume: 1.0,
      currentTime: Date.now()
    };
  }
  
  /**
   * Âä†ËΩΩËÆæÁΩÆ
   */
  private async loadSettings(): Promise<void> {
    try {
      const settings = await this.storageUtil.getObject<PlaybackSettings>(
        this.storageKeys.playbackSettings,
        LocalStorageType.DEFAULT
      );
      
      if (settings) {
        this.playbackSettings = { ...this.getDefaultSettings(), ...settings };
      }
    } catch (error) {
      this.Logger.error('Failed to load playback settings', error as Error);
      this.playbackSettings = this.getDefaultSettings();
    }
  }
  
  /**
   * ‰øùÂ≠òËÆæÁΩÆ
   */
  private async saveSettings(): Promise<void> {
    try {
      this.playbackSettings.lastUpdated = Date.now();
      await this.storageUtil.setObject(
        this.storageKeys.playbackSettings, this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackSettings,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackSettings,
        LocalStorageType.DEFAULT
      )))))));
    } catch (error) {
      this.Logger.error('Failed to save playback settings', error as Error);
    }
  }
  
  /**
   * Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
   */
  private async loadHistory(): Promise<void> {
    try {
      const historyData = await this.storageUtil.getObject<PlaybackHistoryItem[]>(
        this.storageKeys.playbackHistory, LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
      )))))));
      
      if (historyData) {
        historyData.forEach(item => {
          this.playbackHistory.set(item.contentId, item);
        });
      }
    } catch (error) {
      this.Logger.error('Failed to load playback history', error as Error);
      this.playbackHistory.clear();
    }
  }
  
  /**
   * ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
   */
  private async saveHistory(): Promise<void> {
    try {
      // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊåâÊúÄÂêéÊí≠ÊîæÊó∂Èó¥ÊéíÂ∫?      const historyArray = Array.from(this.playbackHistory.values())
        .sort((a, b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b instanceof Error ? b instanceof Error ? b : new Error(String(b : new Error(String(b instanceof Error ? b : new Error(String(b))))))) => b.lastPlayedAt - a.lastPlayedAt)
        .slice(0, this.maxHistoryItems);
      
      await this.storageUtil.setObject(
        this.storageKeys.playbackHistory,
        historyArray,
        LocalStorageType.DEFAULT
      );
    } catch (error) {
      this.Logger.error('Failed to save playback history', error as Error);
    }
  }
  
  /**
   * Âä†ËΩΩÁªüËÆ°
   */
  private async loadStats(): Promise<void> {
    try {
      const stats = await this.storageUtil.getObject<PlaybackStats>(
        this.storageKeys.playbackStats, LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
      )))))));
      
      if (stats) {
        this.playbackStats = { ...this.getEmptyStats(), ...stats };
      }
    } catch (error) {
      this.Logger.error('Failed to load playback stats', error as Error);
      this.playbackStats = this.getEmptyStats();
    }
  }
  
  /**
   * ‰øùÂ≠òÁªüËÆ°
   */
  private async saveStats(): Promise<void> {
    try {
      this.playbackStats.lastUpdated = Date.now();
      await this.storageUtil.setObject(
        this.storageKeys.playbackStats, this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackStats,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackStats,
        LocalStorageType.DEFAULT
      )))))));
    } catch (error) {
      this.Logger.error('Failed to save playback stats', error as Error);
    }
  }
  
  /**
   * Âä†ËΩΩÂΩìÂâçÊí≠ÊîæÁä∂ÊÄ?   */
  private async loadCurrentPlaybackState(): Promise<void> {
    try {
      const state = await this.storageUtil.getObject<CurrentPlaybackState>(
        this.storageKeys.currentPlaybackState, LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
      )))))));
      
      if (state) {
        this.currentPlaybackState = { ...this.getEmptyPlaybackState(), ...state };
      }
    } catch (error) {
      this.Logger.error('Failed to load current playback state', error as Error);
      this.currentPlaybackState = this.getEmptyPlaybackState();
    }
  }
  
  /**
   * ‰øùÂ≠òÂΩìÂâçÊí≠ÊîæÁä∂ÊÄ?   */
  private async saveCurrentPlaybackState(): Promise<void> {
    try {
      this.currentPlaybackState.currentTime = Date.now();
      await this.storageUtil.setObject(
        this.storageKeys.currentPlaybackState, this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
       instanceof Error ? this.currentPlaybackState,
        LocalStorageType.DEFAULT
       : new Error(String(this.currentPlaybackState,
        LocalStorageType.DEFAULT
      )))))));
    } catch (error) {
      this.Logger.error('Failed to save current playback state', error as Error);
    }
  }
  
  /**
   * Âä†ËΩΩÊí≠ÊîæÈòüÂàó
   */
  private async loadPlaybackQueue(): Promise<void> {
    try {
      const queue = await this.storageUtil.getObject<PlaybackQueueItem[]>(
        this.storageKeys.playbackQueue, LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
       instanceof Error ? LocalStorageType.DEFAULT
       : new Error(String(LocalStorageType.DEFAULT
      )))))));
      
      if (queue) {
        this.playbackQueue = queue.slice(0, this.maxQueueLength);
      }
    } catch (error) {
      this.Logger.error('Failed to load playback queue', error as Error);
      this.playbackQueue = [];
    }
  }
  
  /**
   * ‰øùÂ≠òÊí≠ÊîæÈòüÂàó
   */
  private async savePlaybackQueue(): Promise<void> {
    try {
      await this.storageUtil.setObject(
        this.storageKeys.playbackQueue, this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
       instanceof Error ? this.playbackQueue,
        LocalStorageType.DEFAULT
       : new Error(String(this.playbackQueue,
        LocalStorageType.DEFAULT
      )))))));
    } catch (error) {
      this.Logger.error('Failed to save playback queue', error as Error);
    }
  }
  
  /**
   * ÂêØÂä®Ëá™Âä®‰øùÂ≠ò
   */
  private startAutoSave(): void {
    if (this.autoSaveTimer) {
      clearInterval(this.autoSaveTimer);
    }
    
    this.autoSaveTimer = setInterval(() => {
      this.autoSave();
    }, this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval : new Error(String(this.autoSaveInterval instanceof Error ? this.autoSaveInterval : new Error(String(this.autoSaveInterval))))))) as unknown as number;
  }
  
  /**
   * Ëá™Âä®‰øùÂ≠ò
   */
  private async autoSave(): Promise<void> {
    try {
      await Promise.all([
        this.saveSettings(),
        this.saveHistory(),
        this.saveStats(),
        this.saveCurrentPlaybackState(),
        this.savePlaybackQueue()
      ]);
      
      this.logger.debug('Playback data auto-saved');
    } catch (error) {
      this.Logger.error('Failed to auto-save playback data', error as Error);
    }
  }
  
  /**
   * Ëé∑ÂèñÊí≠ÊîæËÆæÁΩÆ
   */
  public getPlaybackSettings(): PlaybackSettings {
    return { ...this.playbackSettings };
  }
  
  /**
   * Êõ¥Êñ∞Êí≠ÊîæËÆæÁΩÆ
   */
  public async updatePlaybackSettings(settings: Partial<PlaybackSettings>): Promise<void> {
    this.playbackSettings = { ...this.playbackSettings, ...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now( instanceof Error ? ...settings };
    this.playbackSettings.lastUpdated = Date.now( : new Error(String(...settings };
    this.playbackSettings.lastUpdated = Date.now()))))));
    
    await this.saveSettings();
    
    // ÂèëÂ∏ÉËÆæÁΩÆÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_settings_updated', {
      settings: this.playbackSettings
    });
  }
  
  /**
   * Ëé∑ÂèñÊí≠ÊîæÂéÜÂè≤
   */
  public getPlaybackHistory(): PlaybackHistoryItem[] {
    return Array.from(this.playbackHistory.values())
      .sort((a, b) => b.lastPlayedAt - a.lastPlayedAt);
  }
  
  /**
   * Ê∑ªÂä†Êí≠ÊîæÂéÜÂè≤ËÆ∞ÂΩï
   */
  public async addPlaybackHistory(item: Omit<PlaybackHistoryItem, 'playCount' | 'lastPlayedAt' | 'isCompleted'>): Promise<void> {
    const existingItem = this.playbackHistory.get(item.contentId);
    const now = Date.now();
    
    const historyItem: PlaybackHistoryItem = {
      ...item,
      playCount: (existingItem?.playCount || 0) + 1,
      lastPlayedAt: now,
      isCompleted: item.position >= item.duration * 0.95 // ËßÇÁúãËøõÂ∫¶Ë∂ÖËøá95%ËßÜ‰∏∫ÂÆåÊàê
    };
    
    this.playbackHistory.set(item.contentId, historyItem);
    
    // Êõ¥Êñ∞ÁªüËÆ°
    this.updateStats(historyItem);
    
    // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
    await this.saveHistory();
    
    // ÂèëÂ∏ÉÂéÜÂè≤ËÆ∞ÂΩïÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_history_updated', {
      item: historyItem,
      action: 'add'
    });
  }
  
  /**
   * Êõ¥Êñ∞Êí≠ÊîæÂéÜÂè≤ËÆ∞ÂΩï
   */
  public async updatePlaybackHistory(contentId: string, updates: Partial<PlaybackHistoryItem>): Promise<void> {
    const existingItem = this.playbackHistory.get(contentId);
    if (!existingItem) {
      return;
    }
    
    const updatedItem: Record<string, string | number | boolean | null> = { ... };
    this.playbackHistory.set(contentId, updatedItem);
    
    await this.saveHistory();
    
    // ÂèëÂ∏ÉÂéÜÂè≤ËÆ∞ÂΩïÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_history_updated', {
      item: updatedItem,
      action: 'update'
    });
  }
  
  /**
   * Âà†Èô§Êí≠ÊîæÂéÜÂè≤ËÆ∞ÂΩï
   */
  public async deletePlaybackHistory(contentId: string): Promise<void> {
    const deletedItem = this.playbackHistory.get(contentId);
    if (!deletedItem) {
      return;
    }
    
    this.playbackHistory.delete(contentId);
    
    await this.saveHistory();
    
    // ÂèëÂ∏ÉÂéÜÂè≤ËÆ∞ÂΩïÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_history_updated', {
      item: deletedItem,
      action: 'delete'
    });
  }
  
  /**
   * Ê∏ÖÁ©∫Êí≠ÊîæÂéÜÂè≤ËÆ∞ÂΩï
   */
  public async clearPlaybackHistory(): Promise<void> {
    const deletedItems = Array.from(this.playbackHistory.values());
    this.playbackHistory.clear();
    
    await this.saveHistory();
    
    // ÂèëÂ∏ÉÂéÜÂè≤ËÆ∞ÂΩïÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_history_cleared', {
      deletedCount: deletedItems.length
    });
  }
  
  /**
   * Ëé∑ÂèñÊí≠ÊîæÁªüËÆ°
   */
  public getPlaybackStats(): PlaybackStats {
    return { ...this.playbackStats };
  }
  
  /**
   * Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
   */
  private updateStats(historyItem: PlaybackHistoryItem): void {
    // Êõ¥Êñ∞ÊÄªÊí≠ÊîæÊó∂Èó?    this.playbackStats.totalWatchTime += historyItem.duration;
    
    // Êõ¥Êñ∞ÊÄªÊí≠ÊîæÊ¨°Êï?    this.playbackStats.totalPlayCount++;
    
    // Êõ¥Êñ∞ËßÇÁúãËßÜÈ¢ëÊï∞Èáè
    if (historyItem.contentType === 'video') {
      this.playbackStats.watchedVideos++;
      if (historyItem.isCompleted) {
        this.playbackStats.completedVideos++;
      }
    }
    
    // Êõ¥Êñ∞ÁîªË¥®ÁªüËÆ°
    const quality = this.currentPlaybackState.quality;
    this.playbackStats.byQuality.set(quality, (this.playbackStats.byQuality.get(quality) || 0) + 1);
    
    // Êõ¥Êñ∞Êí≠ÊîæÈÄüÂ∫¶ÁªüËÆ°
    const speed = this.currentPlaybackState.speed;
    this.playbackStats.bySpeed.set(speed, (this.playbackStats.bySpeed.get(speed) || 0) + 1);
    
    // Êõ¥Êñ∞ÂÜÖÂÆπÁ±ªÂûãÁªüËÆ°
    this.playbackStats.byContentType.set(historyItem.contentType, 
      (this.playbackStats.byContentType.get(historyItem.contentType) || 0) + 1);
    
    // Êõ¥Êñ∞ÊúÄÂñúÊ¨¢ÁöÑÁîªË¥®ÂíåÈÄüÂ∫¶
    this.updateFavoriteStats();
    
    this.playbackStats.lastUpdated = Date.now();
  }
  
  /**
   * Êõ¥Êñ∞ÊúÄÂñúÊ¨¢ÁöÑÁªüËÆ?   */
  private updateFavoriteStats(): void {
    // ÊâæÂà∞ÊúÄÂ∏∏Áî®ÁöÑÁîªË¥?    let maxQualityCount = 0;
    let favoriteQuality = VideoQuality.HIGH;
    
    this.playbackStats.byQuality.forEach((count, quality) => {
      if (count > maxQualityCount) {
        maxQualityCount = count;
        favoriteQuality = quality;
      }
    });
    
    // ÊâæÂà∞ÊúÄÂ∏∏Áî®ÁöÑÊí≠ÊîæÈÄüÂ∫¶
    let maxSpeedCount = 0;
    let favoriteSpeed = PlaybackSpeed.NORMAL;
    
    this.playbackStats.bySpeed.forEach((count, speed) => {
      if (count > maxSpeedCount) {
        maxSpeedCount = count;
        favoriteSpeed = speed;
      }
    });
    
    this.playbackStats.favoriteQuality = favoriteQuality;
    this.playbackStats.favoriteSpeed = favoriteSpeed;
  }
  
  /**
   * Ëé∑ÂèñÂΩìÂâçÊí≠ÊîæÁä∂ÊÄ?   */
  public getCurrentPlaybackState(): CurrentPlaybackState {
    return { ...this.currentPlaybackState };
  }
  
  /**
   * Êõ¥Êñ∞ÂΩìÂâçÊí≠ÊîæÁä∂ÊÄ?   */
  public async updateCurrentPlaybackState(state: Partial<CurrentPlaybackState>): Promise<void> {
    this.currentPlaybackState = { ...this.currentPlaybackState, ...state };
    this.currentPlaybackState.currentTime = Date.now();
    
    await this.saveCurrentPlaybackState();
    
    // ÂèëÂ∏ÉÊí≠ÊîæÁä∂ÊÄÅÊõ¥Êñ∞‰∫ã‰ª?    this.eventBus.publish('playback_state_updated', {
      state: this.currentPlaybackState
    });
  }
  
  /**
   * Ëé∑ÂèñÊí≠ÊîæÈòüÂàó
   */
  public getPlaybackQueue(): PlaybackQueueItem[] {
    return [...this.playbackQueue];
  }
  
  /**
   * Ê∑ªÂä†È°πÁõÆÂà∞Êí≠ÊîæÈòüÂà?   */
  public async addToPlaybackQueue(item: PlaybackQueueItem): Promise<void> {
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Âú®ÈòüÂàó‰∏≠
    const existingIndex = this.playbackQueue.findIndex(q => q.contentId === item.contentId);
    if (existingIndex >= 0) {
      // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÁßªÂä®Âà∞ÈòüÂàóÊú´Â∞?      this.playbackQueue.splice(existingIndex, 1);
    }
    
    this.playbackQueue.push(item);
    
    // ÈôêÂà∂ÈòüÂàóÈïøÂ∫¶
    if (this.playbackQueue.length > this.maxQueueLength) {
      this.playbackQueue = this.playbackQueue.slice(-this.maxQueueLength);
    }
    
    await this.savePlaybackQueue();
    
    // ÂèëÂ∏ÉÈòüÂàóÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_queue_updated', {
      action: 'add',
      item
    });
  }
  
  /**
   * ‰ªéÊí≠ÊîæÈòüÂàó‰∏≠ÁßªÈô§È°πÁõÆ
   */
  public async removeFromPlaybackQueue(contentId: string): Promise<void> {
    const index = this.playbackQueue.findIndex(item => item.contentId === contentId);
    if (index >= 0) {
      const removedItem = this.playbackQueue.splice(index, 1)[0];
      
      await this.savePlaybackQueue();
      
      // ÂèëÂ∏ÉÈòüÂàóÊõ¥Êñ∞‰∫ã‰ª∂
      this.eventBus.publish('playback_queue_updated', {
        action: 'remove',
        item: removedItem
      });
    }
  }
  
  /**
   * Ê∏ÖÁ©∫Êí≠ÊîæÈòüÂàó
   */
  public async clearPlaybackQueue(): Promise<void> {
    const clearedItems = [...this.playbackQueue];
    this.playbackQueue = [];
    
    await this.savePlaybackQueue();
    
    // ÂèëÂ∏ÉÈòüÂàóÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_queue_cleared', {
      clearedCount: clearedItems.length
    });
  }
  
  /**
   * ÈáçÊñ∞ÊéíÂ∫èÊí≠ÊîæÈòüÂàó
   */
  public async reorderPlaybackQueue(contentIds: string[]): Promise<void> {
    const newQueue: PlaybackQueueItem[] = [];
    
    // ÊåâÁÖßÊñ∞ÁöÑÈ°∫Â∫èÈáçÊñ∞ÊûÑÂª∫ÈòüÂàó
    contentIds.forEach(contentId => {
      const item = this.playbackQueue.find(q => q.contentId === contentId);
      if (item) {
        newQueue.push(item);
      }
    });
    
    // Ê∑ªÂä†‰∏çÂú®Êñ∞È°∫Â∫è‰∏≠ÁöÑÈ°πÁõ?    this.playbackQueue.forEach(item => {
      if (!contentIds.includes(item.contentId)) {
        newQueue.push(item);
      }
    });
    
    this.playbackQueue = newQueue;
    
    await this.savePlaybackQueue();
    
    // ÂèëÂ∏ÉÈòüÂàóÊõ¥Êñ∞‰∫ã‰ª∂
    this.eventBus.publish('playback_queue_reordered', {
      newOrder: contentIds
    });
  }
  
  /**
   * Ëé∑Âèñ‰∏ã‰∏Ä‰∏™Êí≠ÊîæÈ°πÁõ?   */
  public getNextPlaybackItem(): PlaybackQueueItem | null {
    if (this.playbackQueue.length === 0) {
      return null;
    }
    
    // Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèËøîÂõû‰∏ã‰∏Ä‰∏™È°πÁõ?    switch (this.currentPlaybackState.mode) {
      case PlaybackMode.LOOP:
        // Âæ™ÁéØÊí≠ÊîæÔºöËøîÂõûÈòüÂàó‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™È°πÁõ?        return this.playbackQueue[0];
        
      case PlaybackMode.SHUFFLE:
        // ÈöèÊú∫Êí≠ÊîæÔºöÈöèÊú∫ËøîÂõû‰∏Ä‰∏™È°πÁõ?        const randomIndex = Math.floor(Math.random() * this.playbackQueue.length);
        return this.playbackQueue[randomIndex];
        
      case PlaybackMode.DEFAULT:
      default:
        // ÈªòËÆ§Ê®°ÂºèÔºöËøîÂõûÈòüÂàó‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™È°πÁõ?        return this.playbackQueue[0];
    }
  }
  
  /**
   * ÊêúÁ¥¢Êí≠ÊîæÂéÜÂè≤
   */
  public searchPlaybackHistory(query: string): PlaybackHistoryItem[] {
    const searchTerm = query.toLowerCase();
    return this.getPlaybackHistory().filter(item => 
      item.title.toLowerCase().includes(searchTerm) ||
      (item.channelName && item.channelName.toLowerCase().includes(searchTerm))
    );
  }
  
  /**
   * Ëé∑ÂèñÊúÄËøëËßÇÁúãÁöÑÈ°πÁõÆ
   */
  public getRecentPlaybackHistory(limit: number = 10): PlaybackHistoryItem[] {
    return this.getPlaybackHistory().slice(0, limit);
  }
  
  /**
   * Ëé∑ÂèñÊúÄÂ∏∏ËßÇÁúãÁöÑÈ°πÁõÆ
   */
  public getMostWatchedPlaybackHistory(limit: number = 10): PlaybackHistoryItem[] {
    return Array.from(this.playbackHistory.values())
      .sort((a, b) => b.playCount - a.playCount)
      .slice(0, limit);
  }
  
  /**
   * Ëé∑ÂèñÂÆåÊàêÁöÑÈ°πÁõ?   */
  public getCompletedPlaybackHistory(): PlaybackHistoryItem[] {
    return this.getPlaybackHistory().filter(item => item.isCompleted);
  }
  
  /**
   * Ëé∑ÂèñÊú™ÂÆåÊàêÁöÑÈ°πÁõÆ
   */
  public getIncompletePlaybackHistory(): PlaybackHistoryItem[] {
    return this.getPlaybackHistory().filter(item => !item.isCompleted);
  }
  
  /**
   * Ê∏ÖÁêÜËøáÊúüÊï∞ÊçÆ
   */
  public async cleanupExpiredData(): Promise<void> {
    const now = Date.now();
    const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000); // 30Â§©Ââç
    
    // Ê∏ÖÁêÜ30Â§©ÂâçÁöÑÂéÜÂè≤ËÆ∞ÂΩ?    let cleanedCount = 0;
    this.playbackHistory.forEach((item, contentId) => {
      if (item.lastPlayedAt < thirtyDaysAgo) {
        this.playbackHistory.delete(contentId);
        cleanedCount++;
      }
    });
    
    if (cleanedCount > 0) {
      await this.saveHistory();
      this.logger.info(`Cleaned ${cleanedCount} expired playback history items`);
    }
    
    // Ê∏ÖÁêÜËøáÊª§Âô®ÁºìÂ≠?    this.filterCache.clear();
  }
  
  /**
   * ÂÖ≥Èó≠‰ªìÂ∫ì
   */
  public async shutdown(): Promise<void> {
    // ÂÅúÊ≠¢Ëá™Âä®‰øùÂ≠ò
    if (this.autoSaveTimer) {
      clearInterval(this.autoSaveTimer);
      this.autoSaveTimer = null;
    }
    
    // ÊâßË°åÊúÄÂêé‰∏ÄÊ¨°‰øùÂ≠?    await this.autoSave();
    
    this.logger.info('PlaybackRepository shutdown completed');
  }
}


