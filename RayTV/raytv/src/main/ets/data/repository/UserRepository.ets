// UserRepository - ç”¨æˆ·æ•°æ®ä»“åº“ç±?// è´Ÿè´£ç®¡ç†ç”¨æˆ·ç›¸å…³æ•°æ®ï¼ŒåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯ã€æƒé™ã€æ”¶è—ã€å†å²è®°å½•ç­‰

import Logger from '../../common/util/Logger';
import StorageUtil from '../../common/util/StorageUtil';
import NetworkUtil from '../../common/util/NetworkUtil';
import EventBusUtil from '../../common/util/EventBusUtil';
import CacheService from '../../service/cache/CacheService';
import {
  UserRole,
  UserStatus,
  RegisterRequest,
  LoginRequest,
  UserInfo,
  UserProfile,
  UserSettings,
  UserPermission,
  ChangePasswordRequest,
  UpdateProfileRequest,
  UpdateSettingsRequest,
  UserStatistics,
  UserActivity
} from '../dto/UserDto';
import { LocalStorageType } from '../model/LocalModel';
import { CacheType } from '../model/CacheModel';

/**
 * ç”¨æˆ·äº‹ä»¶ç±»å‹
 */
export const UserEventType = {
  USER_LOGIN: 'user:login',
  USER_LOGOUT: 'user:logout',
  USER_REGISTERED: 'user:registered',
  USER_PROFILE_UPDATED: 'user:profileUpdated',
  USER_SETTINGS_UPDATED: 'user:settingsUpdated',
  USER_PERMISSIONS_CHANGED: 'user:permissionsChanged',
  USER_STATUS_CHANGED: 'user:statusChanged',
  USER_ACTIVITY_LOGGED: 'user:activityLogged',
  USER_ERROR: 'user:error'
} as const;

/**
 * ç”¨æˆ·çŠ¶æ€å˜æ›´äº‹ä»¶æ•°æ? */
export interface UserStatusChangeEvent {
  userId: string;
  oldStatus: UserStatus;
  newStatus: UserStatus;
  timestamp: number;
}

/**
 * æƒé™å˜æ›´äº‹ä»¶æ•°æ®
 */
export interface PermissionChangeEvent {
  userId: string;
  addedPermissions?: UserPermission[];
  removedPermissions?: UserPermission[];
  timestamp: number;
}

/**
 * ç”¨æˆ·æ´»åŠ¨äº‹ä»¶æ•°æ®
 */
export interface UserActivityEvent {
  userId: string;
  activity: UserActivity;
  timestamp: number;
}

/**
 * ç”¨æˆ·æ•°æ®ä»“åº“ç±? */
export class UserRepository {
  private static instance: UserRepository;
  private logger = Logger.getInstance();
  private storageUtil = StorageUtil.getInstance();
  private networkUtil = NetworkUtil.getInstance();
  private eventBus = EventBusUtil.getInstance();
  private cacheService = CacheService.getInstance();
  
  // å½“å‰ç™»å½•ç”¨æˆ·
  private currentUser: UserInfo | null = null;
  
  // è®¤è¯ä»¤ç‰Œ
  private authToken: string | null = null;
  
  // ä¼šè¯è¿‡æœŸæ—¶é—´
  private sessionExpiry: number | null = null;
  
  // APIç«¯ç‚¹é…ç½®
  private apiEndpoints = {
    baseUrl: 'https://api.raytv.example.com',
    register: '/auth/register',
    login: '/auth/login',
    logout: '/auth/logout',
    refreshToken: '/auth/refresh',
    userProfile: '/user/profile',
    userSettings: '/user/settings',
    userStatistics: '/user/statistics',
    userActivity: '/user/activity',
    changePassword: '/user/change-password'
  };
  
  // ç¼“å­˜é”®é…ç½?  private cacheKeys = {
    currentUser: 'user:current',
    authToken: 'user:authToken',
    sessionExpiry: 'user:sessionExpiry',
    userCache: 'user:cache:',
    userSettings: 'user:settings:',
    userStatistics: 'user:statistics:'
  };

  /**
   * ç§æœ‰æ„é€ å‡½æ•?   */
  private constructor() {
    this.logger.info('UserRepository initialized');
    this.setupEventListeners();
    this.initialize();
  }

  /**
   * è·å–UserRepositoryå•ä¾‹å®ä¾‹
   */
  public static getInstance(): UserRepository {
    if (!UserRepository.instance) {
      UserRepository.instance = new UserRepository();
    }
    return UserRepository.instance;
  }

  /**
   * åˆå§‹åŒ–ç”¨æˆ·ä»“åº?   */
  public async initialize(): Promise<void> {
    try {
      // ä»å­˜å‚¨ä¸­æ¢å¤ç”¨æˆ·ä¼šè¯
      await this.restoreUserSession();
      
      // æ³¨å†Œä¼šè¯è¿‡æœŸæ£€æŸ?      this.setupSessionExpiryCheck();
      
      this.logger.info('UserRepository initialization completed');
    } catch (error) {
      this.Logger.error('Failed to initialize UserRepository', error as Error);
      
      // å‘å¸ƒç”¨æˆ·é”™è¯¯äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ERROR, { error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error } : new Error(String({ error: error as Error } instanceof Error ? { error: error as Error } : new Error(String({ error: error as Error })))))));
    }
  }

  /**
   * è®¾ç½®äº‹ä»¶ç›‘å¬å™?   */
  private setupEventListeners(): void {
    // ç›‘å¬åº”ç”¨é€€å‡ºäº‹ä»¶ï¼Œä¿å­˜ç”¨æˆ·çŠ¶æ€?    this.eventBus.on('app:exit', async () => {
      await this.saveUserSession();
    });
    
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼Œå¤„ç†ç¦»çº¿/åœ¨çº¿åˆ‡æ¢
    this.eventBus.on('network:statusChanged', async (status: { isOnline: boolean }) => {
      if (status.isOnline && this.currentUser) {
        // é‡æ–°åŒæ­¥ç”¨æˆ·æ•°æ®
        await this.syncUserData();
      }
    });
  }

  /**
   * ç”¨æˆ·æ³¨å†Œ
   * @param request æ³¨å†Œè¯·æ±‚
   */
  public async register(request: RegisterRequest): Promise<UserInfo> {
    try {
      // éªŒè¯æ³¨å†Œè¯·æ±‚
      this.validateRegisterRequest(request);
      
      // è°ƒç”¨APIæ³¨å†Œ
      const response = await this.networkUtil.post<UserInfo>(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.register}`,
        request
      );
      
      const userInfo = response.data;
      
      // å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
      this.eventBus.emit(UserEventType.USER_REGISTERED, userInfo);
      
      this.logger.info(`User registered successfully: ${userInfo.username}`);
      
      return userInfo;
    } catch (error) {
      this.Logger.error('User registration failed', error as Error);
      
      // å‘å¸ƒç”¨æˆ·é”™è¯¯äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ERROR, { 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error instanceof Error ? { 
        operation: 'register', 
        error: (error as Error : new Error(String({ 
        operation: 'register', 
        error: (error as Error))))))).message 
      });
      
      throw error;
    }
  }

  /**
   * ç”¨æˆ·ç™»å½•
   * @param request ç™»å½•è¯·æ±‚
   */
  public async login(request: LoginRequest): Promise<UserInfo> {
    try {
      // éªŒè¯ç™»å½•è¯·æ±‚
      this.validateLoginRequest(request);
      
      // è°ƒç”¨APIç™»å½•
      const response = await this.networkUtil.post<{
        user: UserInfo;
        token: string;
        expiresIn: number;
      }>(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.login}`,
        request
      );
      
      const { user, token, expiresIn } = response.data;
      
      // è®¾ç½®å½“å‰ç”¨æˆ·å’Œè®¤è¯ä¿¡æ?      this.setCurrentUser(user, token, expiresIn);
      
      // ä¿å­˜ä¼šè¯
      await this.saveUserSession();
      
      // åŠ è½½ç”¨æˆ·è®¾ç½®å’Œç»Ÿè®¡ä¿¡æ?      await this.loadUserSettings();
      await this.loadUserStatistics();
      
      // å‘å¸ƒç”¨æˆ·ç™»å½•äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_LOGIN, user);
      
      this.logger.info(`User logged in successfully: ${user.username}`);
      
      return user;
    } catch (error) {
      this.Logger.error('User login failed', error as Error);
      
      // å‘å¸ƒç”¨æˆ·é”™è¯¯äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ERROR, { 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error instanceof Error ? { 
        operation: 'login', 
        error: (error as Error : new Error(String({ 
        operation: 'login', 
        error: (error as Error))))))).message 
      });
      
      throw error;
    }
  }

  /**
   * ç”¨æˆ·ç™»å‡º
   */
  public async logout(): Promise<void> {
    try {
      if (!this.isLoggedIn()) {
        return;
      }
      
      const userId = this.currentUser?.id;
      
      try {
        // å°è¯•è°ƒç”¨APIç™»å‡º
        await this.networkUtil.post(
          `${this.apiEndpoints.baseUrl}${this.apiEndpoints.logout}`,
          {},
          {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
        );
      } catch (error) {
        // APIè°ƒç”¨å¤±è´¥æ—¶è®°å½•æ—¥å¿—ä½†ä¸æŠ›å‡ºé”™è¯?        this.logger.warn('API logout failed, continuing with local logout', error as Error);
      }
      
      // æ¸…é™¤æœ¬åœ°ä¼šè¯æ•°æ®
      this.clearUserSession();
      
      // å‘å¸ƒç”¨æˆ·ç™»å‡ºäº‹ä»¶
      this.eventBus.emit(UserEventType.USER_LOGOUT, { userId });
      
      this.logger.info(`User logged out: ${userId}`);
    } catch (error) {
      this.Logger.error('User logout failed', error as Error);
      
      // å³ä½¿å‡ºé”™ä¹Ÿè¦æ¸…ç†æœ¬åœ°ä¼šè¯
      this.clearUserSession();
      
      throw error;
    }
  }

  /**
   * åˆ·æ–°è®¤è¯ä»¤ç‰Œ
   */
  public async refreshToken(): Promise<boolean> {
    try {
      if (!this.authToken || !this.currentUser) {
        return false;
      }
      
      const response = await this.networkUtil.post<{
        token: string;
        expiresIn: number;
      }>(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.refreshToken}`, {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? {},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String({},
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      )))))));
      
      const { token, expiresIn } = response.data;
      
      // æ›´æ–°ä»¤ç‰Œä¿¡æ¯
      this.authToken = token;
      this.sessionExpiry = Date.now() + expiresIn * 1000;
      
      // ä¿å­˜æ›´æ–°åçš„ä»¤ç‰Œ
      await this.storageUtil.setString(this.cacheKeys.authToken, token, LocalStorageType.SECURE);
      await this.storageUtil.setNumber(this.cacheKeys.sessionExpiry, this.sessionExpiry, LocalStorageType.SECURE);
      
      this.logger.info('Auth token refreshed successfully');
      
      return true;
    } catch (error) {
      this.Logger.error('Failed to refresh auth token', error as Error);
      
      // ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½?      await this.logout();
      
      return false;
    }
  }

  /**
   * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   */
  public async getCurrentUser(forceRefresh: boolean = false): Promise<UserInfo | null> {
    if (!this.isLoggedIn()) {
      return null;
    }
    
    // å¦‚æœå¼ºåˆ¶åˆ·æ–°æˆ–ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨ï¼Œä»APIè·å–
    if (forceRefresh || !this.currentUser) {
      await this.loadCurrentUserProfile();
    }
    
    return this.currentUser;
  }

  /**
   * æ›´æ–°ç”¨æˆ·èµ„æ–™
   * @param request æ›´æ–°èµ„æ–™è¯·æ±‚
   */
  public async updateProfile(request: UpdateProfileRequest): Promise<UserProfile> {
    try {
      if (!this.isLoggedIn()) {
        throw new Error('User not logged in');
      }
      
      const response = await this.networkUtil.put<UserProfile>(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.userProfile}`, request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       instanceof Error ? request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
       : new Error(String(request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      )))))));
      
      const updatedProfile = response.data;
      
      // æ›´æ–°å½“å‰ç”¨æˆ·çš„èµ„æ–™ä¿¡æ?      if (this.currentUser) {
        this.currentUser.profile = { ...this.currentUser.profile, ...updatedProfile };
        
        // æ›´æ–°ç¼“å­˜
        await this.cacheService.setCache(
          `${this.cacheKeys.userCache}${this.currentUser.id}`,
          this.currentUser,
          {
            type: CacheType.MEMORY_DISK,
            expiry: 3600 * 1000 // 1å°æ—¶
          }
        );
      }
      
      // å‘å¸ƒç”¨æˆ·èµ„æ–™æ›´æ–°äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_PROFILE_UPDATED, updatedProfile);
      
      this.logger.info(`User profile updated: ${this.currentUser?.username}`);
      
      return updatedProfile;
    } catch (error) {
      this.Logger.error('Failed to update user profile', error as Error);
      
      // å‘å¸ƒç”¨æˆ·é”™è¯¯äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ERROR, { 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateProfile', 
        error: (error as Error : new Error(String({ 
        operation: 'updateProfile', 
        error: (error as Error))))))).message 
      });
      
      throw error;
    }
  }

  /**
   * è·å–ç”¨æˆ·è®¾ç½®
   */
  public async getUserSettings(): Promise<UserSettings | null> {
    if (!this.isLoggedIn()) {
      return null;
    }
    
    return await this.loadUserSettings();
  }

  /**
   * æ›´æ–°ç”¨æˆ·è®¾ç½®
   * @param request æ›´æ–°è®¾ç½®è¯·æ±‚
   */
  public async updateSettings(request: UpdateSettingsRequest): Promise<UserSettings> {
    try {
      if (!this.isLoggedIn()) {
        throw new Error('User not logged in');
      }
      
      const response = await this.networkUtil.put<UserSettings>(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.userSettings}`,
        request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      );
      
      const updatedSettings = response.data;
      
      // ä¿å­˜æ›´æ–°åçš„è®¾ç½®
      const settingsKey = `${this.cacheKeys.userSettings}${this.currentUser!.id}`;
      await this.cacheService.setCache(
        settingsKey,
        updatedSettings,
        {
          type: CacheType.MEMORY_DISK,
          expiry: 86400 * 1000 // 24å°æ—¶
        }
      );
      
      // å‘å¸ƒç”¨æˆ·è®¾ç½®æ›´æ–°äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_SETTINGS_UPDATED, updatedSettings);
      
      this.logger.info(`User settings updated: ${this.currentUser?.username}`);
      
      return updatedSettings;
    } catch (error) {
      this.Logger.error('Failed to update user settings', error as Error);
      
      // å‘å¸ƒç”¨æˆ·é”™è¯¯äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ERROR, { 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error instanceof Error ? { 
        operation: 'updateSettings', 
        error: (error as Error : new Error(String({ 
        operation: 'updateSettings', 
        error: (error as Error))))))).message 
      });
      
      throw error;
    }
  }

  /**
   * ä¿®æ”¹å¯†ç 
   * @param request ä¿®æ”¹å¯†ç è¯·æ±‚
   */
  public async changePassword(request: ChangePasswordRequest): Promise<boolean> {
    try {
      if (!this.isLoggedIn()) {
        throw new Error('User not logged in');
      }
      
      await this.networkUtil.post(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.changePassword}`,
        request,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      );
      
      this.logger.info(`Password changed successfully for user: ${this.currentUser?.username}`);
      
      // è®°å½•ç”¨æˆ·æ´»åŠ¨
      await this.logUserActivity({
        type: 'password_changed',
        details: { timestamp: Date.now() }
      });
      
      return true;
    } catch (error) {
      this.Logger.error('Failed to change password', error as Error);
      
      // å‘å¸ƒç”¨æˆ·é”™è¯¯äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ERROR, { 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error instanceof Error ? { 
        operation: 'changePassword', 
        error: (error as Error : new Error(String({ 
        operation: 'changePassword', 
        error: (error as Error))))))).message 
      });
      
      throw error;
    }
  }

  /**
   * è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
   */
  public async getUserStatistics(): Promise<UserStatistics | null> {
    if (!this.isLoggedIn()) {
      return null;
    }
    
    return await this.loadUserStatistics();
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
   */
  public isLoggedIn(): boolean {
    // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å’Œä»¤ç‰Œæ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠä¼šè¯æ˜¯å¦æœªè¿‡æœŸ
    return this.currentUser !== null && 
           this.authToken !== null && 
           (this.sessionExpiry === null || Date.now() < this.sessionExpiry);
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™
   * @param permission æƒé™åç§°
   */
  public hasPermission(permission: UserPermission): boolean {
    if (!this.currentUser) {
      return false;
    }
    
    // è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™?    if (this.currentUser.role === UserRole.ADMINISTRATOR) {
      return true;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æƒé™åˆ—è¡?    return this.currentUser.permissions?.includes(permission) || false;
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šè§’è‰²
   * @param role è§’è‰²åç§°
   */
  public hasRole(role: UserRole): boolean {
    if (!this.currentUser) {
      return false;
    }
    
    // è§’è‰²æœ‰å±‚çº§å…³ç³»ï¼Œé«˜çº§è§’è‰²åŒ…å«ä½çº§è§’è‰²çš„æƒé™?    switch (role) {
      case UserRole.USER:
        return true; // æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·éƒ½è‡³å°‘æœ‰USERè§’è‰²
      case UserRole.PREMIUM:
        return this.currentUser.role === UserRole.PREMIUM || 
               this.currentUser.role === UserRole.ADMINISTRATOR;
      case UserRole.ADMINISTRATOR:
        return this.currentUser.role === UserRole.ADMINISTRATOR;
      default:
        return false;
    }
  }

  /**
   * è·å–è®¤è¯ä»¤ç‰Œ
   */
  public getAuthToken(): string | null {
    return this.authToken;
  }

  /**
   * è®¾ç½®å½“å‰ç”¨æˆ·å’Œè®¤è¯ä¿¡æ?   */
  private setCurrentUser(user: UserInfo, token: string, expiresIn: number): void {
    this.currentUser = user;
    this.authToken = token;
    this.sessionExpiry = Date.now() + expiresIn * 1000;
  }

  /**
   * ä¿å­˜ç”¨æˆ·ä¼šè¯åˆ°å­˜å‚?   */
  private async saveUserSession(): Promise<void> {
    try {
      if (this.currentUser) {
        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«æ•æ„Ÿæ•°æ®ï¼?        await this.storageUtil.setObject(
          this.cacheKeys.currentUser, 
          this.sanitizeUserInfo(this.currentUser),
          LocalStorageType.SECURE
        );
      }
      
      if (this.authToken) {
        // ä¿å­˜è®¤è¯ä»¤ç‰Œ
        await this.storageUtil.setString(this.cacheKeys.authToken, this.authToken, LocalStorageType.SECURE);
      }
      
      if (this.sessionExpiry) {
        // ä¿å­˜ä¼šè¯è¿‡æœŸæ—¶é—´
        await this.storageUtil.setNumber(this.cacheKeys.sessionExpiry, this.sessionExpiry, LocalStorageType.SECURE);
      }
    } catch (error) {
      this.logger.warn('Failed to save user session', error as Error);
    }
  }

  /**
   * ä»å­˜å‚¨æ¢å¤ç”¨æˆ·ä¼šè¯?   */
  private async restoreUserSession(): Promise<void> {
    try {
      // è¯»å–ç”¨æˆ·ä¿¡æ¯
      const savedUser = await this.storageUtil.getObject<UserInfo>(this.cacheKeys.currentUser, LocalStorageType.SECURE);
      const savedToken = await this.storageUtil.getString(this.cacheKeys.authToken, LocalStorageType.SECURE);
      const savedExpiry = await this.storageUtil.getNumber(this.cacheKeys.sessionExpiry, LocalStorageType.SECURE);
      
      // æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•?      if (savedUser && savedToken && savedExpiry && Date.now() < savedExpiry) {
        this.currentUser = savedUser;
        this.authToken = savedToken;
        this.sessionExpiry = savedExpiry;
        
        this.logger.info(`Restored user session: ${savedUser.username}`);
        
        // éªŒè¯ä»¤ç‰Œæ˜¯å¦ä»ç„¶æœ‰æ•ˆ
        try {
          await this.loadCurrentUserProfile();
        } catch (error) {
          // ä»¤ç‰Œå¯èƒ½å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°
          const refreshed = await this.refreshToken();
          if (!refreshed) {
            // åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤ä¼šè¯?            this.clearUserSession();
          }
        }
      } else {
        // ä¼šè¯æ— æ•ˆï¼Œæ¸…é™¤å­˜å‚¨çš„ä¼šè¯æ•°æ®
        await this.clearStoredSession();
      }
    } catch (error) {
      this.logger.warn('Failed to restore user session', error as Error);
      await this.clearStoredSession();
    }
  }

  /**
   * æ¸…é™¤ç”¨æˆ·ä¼šè¯
   */
  private clearUserSession(): void {
    this.currentUser = null;
    this.authToken = null;
    this.sessionExpiry = null;
    
    // æ¸…é™¤å†…å­˜ç¼“å­˜
    this.cacheService.removeCache(this.cacheKeys.currentUser);
    
    // å¼‚æ­¥æ¸…é™¤å­˜å‚¨çš„ä¼šè¯æ•°æ?    this.clearStoredSession().catch(err => {
      this.logger.warn('Failed to clear stored session', err);
    });
  }

  /**
   * æ¸…é™¤å­˜å‚¨çš„ä¼šè¯æ•°æ?   */
  private async clearStoredSession(): Promise<void> {
    await this.storageUtil.remove(this.cacheKeys.currentUser, LocalStorageType.SECURE);
    await this.storageUtil.remove(this.cacheKeys.authToken, LocalStorageType.SECURE);
    await this.storageUtil.remove(this.cacheKeys.sessionExpiry, LocalStorageType.SECURE);
  }

  /**
   * è®¾ç½®ä¼šè¯è¿‡æœŸæ£€æŸ?   */
  private setupSessionExpiryCheck(): void {
    // æ¯?0ç§’æ£€æŸ¥ä¸€æ¬¡ä¼šè¯æ˜¯å¦è¿‡æœ?    setInterval(async () => {
      if (this.sessionExpiry && Date.now() > this.sessionExpiry) {
        // ä¼šè¯å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°ä»¤ç‰Œ
        const refreshed = await this.refreshToken();
        if (!refreshed) {
          this.logger.info('Session expired and token refresh failed, logging out');
          
          // å‘å¸ƒç”¨æˆ·ç™»å‡ºäº‹ä»¶
          this.eventBus.emit(UserEventType.USER_LOGOUT, { userId: this.currentUser?.id });
          
          this.clearUserSession();
        }
      }
    }, 60000);
  }

  /**
   * åŠ è½½å½“å‰ç”¨æˆ·èµ„æ–™
   */
  private async loadCurrentUserProfile(): Promise<void> {
    try {
      if (!this.isLoggedIn()) {
        return;
      }
      
      const response = await this.networkUtil.get<UserInfo>(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.userProfile}`,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      );
      
      this.currentUser = response.data;
      
      // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
      await this.cacheService.setCache(
        `${this.cacheKeys.userCache}${this.currentUser.id}`,
        this.currentUser,
        {
          type: CacheType.MEMORY_DISK,
          expiry: 3600 * 1000 // 1å°æ—¶
        }
      );
      
      this.logger.debug(`Loaded user profile: ${this.currentUser.username}`);
    } catch (error) {
      this.Logger.error('Failed to load user profile', error as Error);
      throw error;
    }
  }

  /**
   * åŠ è½½ç”¨æˆ·è®¾ç½®
   */
  private async loadUserSettings(): Promise<UserSettings | null> {
    try {
      if (!this.currentUser) {
        return null;
      }
      
      const settingsKey = `${this.cacheKeys.userSettings}${this.currentUser.id}`;
      
      // å°è¯•ä»ç¼“å­˜è·å?      let settings = await this.cacheService.getCache<UserSettings>(settingsKey);
      
      if (!settings) {
        // ä»APIè·å–
        const response = await this.networkUtil.get<UserSettings>(
          `${this.apiEndpoints.baseUrl}${this.apiEndpoints.userSettings}`, {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         instanceof Error ? {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
         : new Error(String({
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
        )))))));
        
        settings = response.data;
        
        // ç¼“å­˜è®¾ç½®
        await this.cacheService.setCache(
          settingsKey,
          settings,
          {
            type: CacheType.MEMORY_DISK,
            expiry: 86400 * 1000 // 24å°æ—¶
          }
        );
      }
      
      return settings;
    } catch (error) {
      this.logger.warn('Failed to load user settings', error as Error);
      return null;
    }
  }

  /**
   * åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
   */
  private async loadUserStatistics(): Promise<UserStatistics | null> {
    try {
      if (!this.currentUser) {
        return null;
      }
      
      const statsKey = `${this.cacheKeys.userStatistics}${this.currentUser.id}`;
      
      // å°è¯•ä»ç¼“å­˜è·å–ï¼ˆç»Ÿè®¡ä¿¡æ¯å¯ä»¥ç¼“å­˜5åˆ†é’Ÿï¼?      let statistics = await this.cacheService.getCache<UserStatistics>(statsKey);
      
      if (!statistics) {
        // ä»APIè·å–
        const response = await this.networkUtil.get<UserStatistics>(
          `${this.apiEndpoints.baseUrl}${this.apiEndpoints.userStatistics}`,
          {
            headers: {
              'Authorization': `Bearer ${this.authToken}`
            }
          }
        );
        
        statistics = response.data;
        
        // ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
        await this.cacheService.setCache(
          statsKey,
          statistics,
          {
            type: CacheType.MEMORY,
            expiry: 300000 // 5åˆ†é’Ÿ
          }
        );
      }
      
      return statistics;
    } catch (error) {
      this.logger.warn('Failed to load user statistics', error as Error);
      return null;
    }
  }

  /**
   * åŒæ­¥ç”¨æˆ·æ•°æ®ï¼ˆåœ¨çº¿æ—¶ï¼?   */
  private async syncUserData(): Promise<void> {
    try {
      if (!this.isLoggedIn()) {
        return;
      }
      
      // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ã€è®¾ç½®å’Œç»Ÿè®¡ä¿¡æ¯
      await Promise.all([
        this.loadCurrentUserProfile(),
        this.loadUserSettings(),
        this.loadUserStatistics()
      ]);
      
      this.logger.debug('User data synchronized');
    } catch (error) {
      this.logger.warn('Failed to synchronize user data', error as Error);
    }
  }

  /**
   * è®°å½•ç”¨æˆ·æ´»åŠ¨
   * @param activity æ´»åŠ¨ä¿¡æ¯
   */
  private async logUserActivity(activity: UserActivity): Promise<void> {
    try {
      if (!this.isLoggedIn()) {
        return;
      }
      
      // å‘å¸ƒç”¨æˆ·æ´»åŠ¨äº‹ä»¶
      this.eventBus.emit(UserEventType.USER_ACTIVITY_LOGGED, {
        userId: this.currentUser!.id,
        activity,
        timestamp: Date.now()
      } as UserActivityEvent);
      
      // å¼‚æ­¥å‘é€åˆ°æœåŠ¡å™?      this.networkUtil.post(
        `${this.apiEndpoints.baseUrl}${this.apiEndpoints.userActivity}`,
        {
          ...activity,
          timestamp: Date.now()
        },
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      ).catch(error => {
        this.logger.warn('Failed to send user activity to server', error as Error);
      });
    } catch (error) {
      this.logger.warn('Failed to log user activity', error as Error);
    }
  }

  /**
   * éªŒè¯æ³¨å†Œè¯·æ±‚
   */
  private validateRegisterRequest(request: RegisterRequest): void {
    const errors: string[] = [];
    
    if (!request.username || request.username.trim().length < 3) {
      errors.push('Username must be at least 3 characters long');
    }
    
    if (!request.email || !this.isValidEmail(request.email)) {
      errors.push('Invalid email address');
    }
    
    if (!request.password || request.password.length < 6) {
      errors.push('Password must be at least 6 characters long');
    }
    
    if (request.password !== request.confirmPassword) {
      errors.push('Passwords do not match');
    }
    
    if (errors.length > 0) {
      throw new Error(errors.join(', '));
    }
  }

  /**
   * éªŒè¯ç™»å½•è¯·æ±‚
   */
  private validateLoginRequest(request: LoginRequest): void {
    const errors: string[] = [];
    
    if (!request.usernameOrEmail) {
      errors.push('Username or email is required');
    }
    
    if (!request.password) {
      errors.push('Password is required');
    }
    
    if (errors.length > 0) {
      throw new Error(errors.join(', '));
    }
  }

  /**
   * ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
   */
  private isValidEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  /**
   * æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œç§»é™¤æ•æ„Ÿæ•°æ?   */
  private sanitizeUserInfo(userInfo: UserInfo): UserInfo {
    const sanitized: Record<string, string | number | boolean | null> = { ... };
    
    // ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼?    if (sanitized) {
        delete (sanitized as Record<string, unknown>).password;
        delete (sanitized as Record<string, unknown>).resetToken;
        delete (sanitized as Record<string, unknown>).verificationToken;
    }
    
    return sanitized;
  }
}

// å¯¼å‡ºé»˜è®¤å®ä¾‹
export default UserRepository.getInstance();


