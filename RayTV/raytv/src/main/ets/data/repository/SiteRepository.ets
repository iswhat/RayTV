// SiteRepository.ets - ç«™ç‚¹æ•°æ®ä»“åº“
// è´Ÿè´£ç«™ç‚¹ç›¸å…³æ•°æ®çš„å­˜å‚¨ã€è¯»å–å’Œç®¡ç†

import { SQLiteHelper, QueryCondition } from '../db/SQLiteHelper';
import { Site, SiteGroup, SiteType, LoaderType, SiteSearchConfig } from '../bean/Site';
import { SITE_TABLE, SITE_GROUP_TABLE } from '../db/TableSchema';
import Logger from '../../common/util/Logger';
import StorageUtil from '../../common/util/StorageUtil';

const TAG = 'SiteRepository';
const SITE_CACHE_PREFIX = 'site_data_';
const SITE_LIST_CACHE = 'site_list_cache';

export class SiteRepository {
  private static instance: SiteRepository;
  private sqliteHelper: SQLiteHelper;
  private storageUtil: StorageUtil;
  
  private constructor() {
    this.sqliteHelper = SQLiteHelper.getInstance();
    this.storageUtil = StorageUtil.getInstance();
  }
  
  /**
   * è·å–ç«™ç‚¹ä»“åº“å•ä¾‹å®ä¾‹
   */
  public static getInstance(): SiteRepository {
    if (!SiteRepository.instance) {
      SiteRepository.instance = new SiteRepository();
    }
    return SiteRepository.instance;
  }
  
  /**
   * ä¿å­˜ç«™ç‚¹ä¿¡æ¯
   * @param site ç«™ç‚¹ä¿¡æ¯
   * @returns æ˜¯å¦ä¿å­˜æˆåŠŸ
   */
  public async saveSite(site: Site): Promise<boolean> {
    try {
      Logger.debug(TAG, `Saving site: ${site.name}`);
      
      const siteData = {
        [SITE_TABLE.COLUMNS.ID]: site.id || null,
        [SITE_TABLE.COLUMNS.NAME]: site.name,
        [SITE_TABLE.COLUMNS.URL]: site.url,
        [SITE_TABLE.COLUMNS.ICON]: site.icon,
        [SITE_TABLE.COLUMNS.TYPE]: site.type,
        [SITE_TABLE.COLUMNS.LOADER_TYPE]: site.loaderType,
        [SITE_TABLE.COLUMNS.GROUP_ID]: site.groupId || null,
        [SITE_TABLE.COLUMNS.DESCRIPTION]: site.description || '',
        [SITE_TABLE.COLUMNS.ENABLED]: site.enabled ? 1 : 0,
        [SITE_TABLE.COLUMNS.SORT_ORDER]: site.sortOrder || 0,
        [SITE_TABLE.COLUMNS.CREATE_TIME]: site.createTime || Date.now(),
        [SITE_TABLE.COLUMNS.UPDATE_TIME]: Date.now(),
        [SITE_TABLE.COLUMNS.CONFIG]: JSON.stringify(site.config || {}),
        [SITE_TABLE.COLUMNS.EXTRA_DATA]: JSON.stringify(site.extraData || {})
      };
      
      let result: number | undefined;
      if (site.id) {
        // æ›´æ–°ç°æœ‰ç«™ç‚¹
        const conditions: QueryCondition[] = [{
          column: SITE_TABLE.COLUMNS.ID,
          value: site.id
        }];
        result = await this.sqliteHelper.update(SITE_TABLE.TABLE_NAME, siteData, conditions);
      } else {
        // æ’å…¥æ–°ç«™ç‚?        result = await this.sqliteHelper.insert(SITE_TABLE.TABLE_NAME, siteData);
        if (result.success && result.lastInsertRowId) {
          site.id = result.lastInsertRowId.toString();
        }
      }
      
      if (result.success) {
        // æ›´æ–°ç¼“å­˜
        await this.cacheSiteData(site);
        await this.invalidateSiteListCache();
        Logger.info(TAG, `Site ${site.name} saved successfully`);
      }
      
      return result.success;
    } catch (error) {
      Logger.error(TAG, `Failed to save site ${site.name}: ${JSON.stringify(error)}`);
      return false;
    }
  }
  
  /**
   * æ‰¹é‡ä¿å­˜ç«™ç‚¹
   * @param sites ç«™ç‚¹åˆ—è¡¨
   * @returns ä¿å­˜æˆåŠŸçš„ç«™ç‚¹æ•°é‡?   */
  public async saveSites(sites: Site[]): Promise<number> {
    if (!sites || sites.length === 0) {
      return 0;
    }
    
    let successCount = 0;
    
    try {
      for (const site of sites) {
        const success = await this.saveSite(site);
        if (success) {
          successCount++;
        }
      }
      
      await this.invalidateSiteListCache();
      Logger.info(TAG, `Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites` instanceof Error ? `Batch saved ${successCount}/${sites.length} sites` : new Error(String(`Batch saved ${successCount}/${sites.length} sites`)))))));
      return successCount;
    } catch (error) {
      Logger.error(TAG, `Failed to batch save sites: ${JSON.stringify(error)}`);
      return successCount;
    }
  }
  
  /**
   * è·å–æ‰€æœ‰ç«™ç‚?   * @param includeDisabled æ˜¯å¦åŒ…å«ç¦ç”¨çš„ç«™ç‚?   * @returns ç«™ç‚¹åˆ—è¡¨
   */
  public async getAllSites(includeDisabled: boolean = false): Promise<Site[]> {
    try {
      // å°è¯•ä»ç¼“å­˜è·å?      const cachedList = await this.getCachedSiteList();
      if (cachedList && cachedList.length > 0 && includeDisabled === false) {
        Logger.debug(TAG, 'Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache' : new Error(String('Returning sites from cache' instanceof Error ? 'Returning sites from cache' : new Error(String('Returning sites from cache')))))));
        return cachedList;
      }
      
      // æ„å»ºæŸ¥è¯¢æ¡ä»¶
      const conditions: QueryCondition[] = [];
      if (!includeDisabled) {
        conditions.push({
          column: SITE_TABLE.COLUMNS.ENABLED,
          value: 1
        });
      }
      
      // æ„å»ºæ’åºé€‰é¡¹
      const sortOptions = [{
        column: SITE_TABLE.COLUMNS.SORT_ORDER,
        order: 'ASC'
      }, {
        column: SITE_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      // æŸ¥è¯¢æ•°æ®åº?      const siteRecords = await this.sqliteHelper.query(
        SITE_TABLE.TABLE_NAME,
        ['*'],
        conditions,
        sortOptions
      );
      
      // è½¬æ¢ä¸ºSiteå¯¹è±¡
      const sites = this.convertToSiteObjects(siteRecords);
      
      // ç¼“å­˜å¯ç”¨çš„ç«™ç‚¹åˆ—è¡?      if (!includeDisabled && sites.length > 0) {
        await this.cacheSiteList(sites);
      }
      
      Logger.info(TAG, `Retrieved ${sites.length} sites from database`);
      return sites;
    } catch (error) {
      Logger.error(TAG, `Failed to get all sites: ${JSON.stringify(error)}`);
      return [];
    }
  }
  
  /**
   * æ ¹æ®IDè·å–ç«™ç‚¹
   * @param siteId ç«™ç‚¹ID
   * @returns ç«™ç‚¹ä¿¡æ¯æˆ–null
   */
  public async getSiteById(siteId: string): Promise<Site | null> {
    try {
      // å°è¯•ä»ç¼“å­˜è·å?      const cachedSite = await this.getCachedSite(siteId);
      if (cachedSite) {
        Logger.debug(TAG, `Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache` instanceof Error ? `Returning site ${siteId} from cache` : new Error(String(`Returning site ${siteId} from cache`)))))));
        return cachedSite;
      }
      
      // æŸ¥è¯¢æ•°æ®åº?      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.ID,
        value: siteId
      }];
      
      const siteRecord = await this.sqliteHelper.getFirst(
        SITE_TABLE.TABLE_NAME,
        ['*'],
        conditions
      );
      
      if (!siteRecord) {
        return null;
      }
      
      // è½¬æ¢ä¸ºSiteå¯¹è±¡
      const site = this.convertToSiteObject(siteRecord);
      
      // æ›´æ–°ç¼“å­˜
      await this.cacheSiteData(site);
      
      Logger.info(TAG, `Retrieved site ${site.name} by ID ${siteId}`);
      return site;
    } catch (error) {
      Logger.error(TAG, `Failed to get site by ID ${siteId}: ${JSON.stringify(error)}`);
      return null;
    }
  }
  
  /**
   * æ ¹æ®ç±»å‹è·å–ç«™ç‚¹
   * @param type ç«™ç‚¹ç±»å‹
   * @param includeDisabled æ˜¯å¦åŒ…å«ç¦ç”¨çš„ç«™ç‚?   * @returns ç«™ç‚¹åˆ—è¡¨
   */
  public async getSitesByType(type: SiteType, includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false))))))): Promise<Site[]> {
    try {
      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.TYPE,
        value: type
      }];
      
      if (!includeDisabled) {
        conditions.push({
          column: SITE_TABLE.COLUMNS.ENABLED,
          value: 1
        });
      }
      
      const sortOptions = [{
        column: SITE_TABLE.COLUMNS.SORT_ORDER,
        order: 'ASC'
      }, {
        column: SITE_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const siteRecords = await this.sqliteHelper.query(
        SITE_TABLE.TABLE_NAME,
        ['*'],
        conditions,
        sortOptions
      );
      
      const sites = this.convertToSiteObjects(siteRecords);
      Logger.info(TAG, `Retrieved ${sites.length} sites of type ${type}`);
      return sites;
    } catch (error) {
      Logger.error(TAG, `Failed to get sites by type ${type}: ${JSON.stringify(error)}`);
      return [];
    }
  }
  
  /**
   * æ ¹æ®åˆ†ç»„è·å–ç«™ç‚¹
   * @param groupId åˆ†ç»„ID
   * @param includeDisabled æ˜¯å¦åŒ…å«ç¦ç”¨çš„ç«™ç‚?   * @returns ç«™ç‚¹åˆ—è¡¨
   */
  public async getSitesByGroup(groupId: string, includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false instanceof Error ? includeDisabled: boolean = false : new Error(String(includeDisabled: boolean = false))))))): Promise<Site[]> {
    try {
      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.GROUP_ID,
        value: groupId
      }];
      
      if (!includeDisabled) {
        conditions.push({
          column: SITE_TABLE.COLUMNS.ENABLED,
          value: 1
        });
      }
      
      const sortOptions = [{
        column: SITE_TABLE.COLUMNS.SORT_ORDER,
        order: 'ASC'
      }, {
        column: SITE_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const siteRecords = await this.sqliteHelper.query(
        SITE_TABLE.TABLE_NAME,
        ['*'],
        conditions,
        sortOptions
      );
      
      const sites = this.convertToSiteObjects(siteRecords);
      Logger.info(TAG, `Retrieved ${sites.length} sites from group ${groupId}`);
      return sites;
    } catch (error) {
      Logger.error(TAG, `Failed to get sites by group ${groupId}: ${JSON.stringify(error)}`);
      return [];
    }
  }
  
  /**
   * åˆ é™¤ç«™ç‚¹
   * @param siteId ç«™ç‚¹ID
   * @returns æ˜¯å¦åˆ é™¤æˆåŠŸ
   */
  public async deleteSite(siteId: string): Promise<boolean> {
    try {
      Logger.debug(TAG, `Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}` instanceof Error ? `Deleting site with ID: ${siteId}` : new Error(String(`Deleting site with ID: ${siteId}`)))))));
      
      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.ID,
        value: siteId
      }];
      
      const result = await this.sqliteHelper.delete(SITE_TABLE.TABLE_NAME, conditions);
      
      if (result.success) {
        // æ¸…é™¤ç¼“å­˜
        await this.removeCachedSite(siteId);
        await this.invalidateSiteListCache();
        Logger.info(TAG, `Site ${siteId} deleted successfully`);
      }
      
      return result.success;
    } catch (error) {
      Logger.error(TAG, `Failed to delete site ${siteId}: ${JSON.stringify(error)}`);
      return false;
    }
  }
  
  /**
   * æ‰¹é‡åˆ é™¤ç«™ç‚¹
   * @param siteIds ç«™ç‚¹IDåˆ—è¡¨
   * @returns åˆ é™¤æˆåŠŸçš„ç«™ç‚¹æ•°é‡?   */
  public async deleteSites(siteIds: string[]): Promise<number> {
    if (!siteIds || siteIds.length === 0) {
      return 0;
    }
    
    try {
      Logger.debug(TAG, `Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites` instanceof Error ? `Deleting ${siteIds.length} sites` : new Error(String(`Deleting ${siteIds.length} sites`)))))));
      
      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.ID,
        operator: 'IN',
        value: siteIds
      }];
      
      const result = await this.sqliteHelper.delete(SITE_TABLE.TABLE_NAME, conditions);
      
      if (result.success) {
        // æ¸…é™¤ç¼“å­˜
        for (const siteId of siteIds) {
          await this.removeCachedSite(siteId);
        }
        await this.invalidateSiteListCache();
        Logger.info(TAG, `Deleted ${result.affectedRows} sites`);
      }
      
      return result.affectedRows || 0;
    } catch (error) {
      Logger.error(TAG, `Failed to batch delete sites: ${JSON.stringify(error)}`);
      return 0;
    }
  }
  
  /**
   * æ›´æ–°ç«™ç‚¹å¯ç”¨çŠ¶æ€?   * @param siteId ç«™ç‚¹ID
   * @param enabled æ˜¯å¦å¯ç”¨
   * @returns æ˜¯å¦æ›´æ–°æˆåŠŸ
   */
  public async updateSiteEnabled(siteId: string, enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean : new Error(String(enabled: boolean instanceof Error ? enabled: boolean : new Error(String(enabled: boolean))))))): Promise<boolean> {
    try {
      const data: Record<string, string | number | boolean | null> = { ... };
      
      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.ID,
        value: siteId
      }];
      
      const result = await this.sqliteHelper.update(SITE_TABLE.TABLE_NAME, data, conditions);
      
      if (result.success) {
        // æ¸…é™¤ç¼“å­˜
        await this.removeCachedSite(siteId);
        await this.invalidateSiteListCache();
        Logger.info(TAG, `Site ${siteId} enabled status updated to ${enabled}`);
      }
      
      return result.success;
    } catch (error) {
      Logger.error(TAG, `Failed to update site ${siteId} enabled status: ${JSON.stringify(error)}`);
      return false;
    }
  }
  
  /**
   * æ›´æ–°ç«™ç‚¹æ’åº
   * @param siteId ç«™ç‚¹ID
   * @param sortOrder æ’åºé¡ºåº
   * @returns æ˜¯å¦æ›´æ–°æˆåŠŸ
   */
  public async updateSiteSortOrder(siteId: string, sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number : new Error(String(sortOrder: number instanceof Error ? sortOrder: number : new Error(String(sortOrder: number))))))): Promise<boolean> {
    try {
      const data: Record<string, string | number | boolean | null> = { ... };
      
      const conditions: QueryCondition[] = [{
        column: SITE_TABLE.COLUMNS.ID,
        value: siteId
      }];
      
      const result = await this.sqliteHelper.update(SITE_TABLE.TABLE_NAME, data, conditions);
      
      if (result.success) {
        // æ¸…é™¤ç¼“å­˜
        await this.removeCachedSite(siteId);
        await this.invalidateSiteListCache();
        Logger.info(TAG, `Site ${siteId} sort order updated to ${sortOrder}`);
      }
      
      return result.success;
    } catch (error) {
      Logger.error(TAG, `Failed to update site ${siteId} sort order: ${JSON.stringify(error)}`);
      return false;
    }
  }
  
  /**
   * ä¿å­˜ç«™ç‚¹åˆ†ç»„
   * @param group ç«™ç‚¹åˆ†ç»„
   * @returns æ˜¯å¦ä¿å­˜æˆåŠŸ
   */
  public async saveSiteGroup(group: SiteGroup): Promise<boolean> {
    try {
      Logger.debug(TAG, `Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}` instanceof Error ? `Saving site group: ${group.name}` : new Error(String(`Saving site group: ${group.name}`)))))));
      
      const groupData: Record<string, string | number | boolean | null> = { ... };
      
      let result: number | undefined;
      if (group.id) {
        // æ›´æ–°ç°æœ‰åˆ†ç»„
        const conditions: QueryCondition[] = [{
          column: SITE_GROUP_TABLE.COLUMNS.ID,
          value: group.id
        }];
        result = await this.sqliteHelper.update(SITE_GROUP_TABLE.TABLE_NAME, groupData, conditions);
      } else {
        // æ’å…¥æ–°åˆ†ç»?        result = await this.sqliteHelper.insert(SITE_GROUP_TABLE.TABLE_NAME, groupData);
        if (result.success && result.lastInsertRowId) {
          group.id = result.lastInsertRowId.toString();
        }
      }
      
      Logger.info(TAG, `Site group ${group.name} saved successfully`);
      return result.success;
    } catch (error) {
      Logger.error(TAG, `Failed to save site group ${group.name}: ${JSON.stringify(error)}`);
      return false;
    }
  }
  
  /**
   * è·å–æ‰€æœ‰ç«™ç‚¹åˆ†ç»?   * @returns ç«™ç‚¹åˆ†ç»„åˆ—è¡¨
   */
  public async getAllSiteGroups(): Promise<SiteGroup[]> {
    try {
      const sortOptions = [{
        column: SITE_GROUP_TABLE.COLUMNS.SORT_ORDER, order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       instanceof Error ? order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
       : new Error(String(order: 'ASC'
      }, {
        column: SITE_GROUP_TABLE.COLUMNS.NAME,
        order: 'ASC'
      }];
      
      const groupRecords = await this.sqliteHelper.query(
        SITE_GROUP_TABLE.TABLE_NAME,
        ['*'],
        undefined,
        sortOptions
      )))))));
      
      const groups: SiteGroup[] = groupRecords.map(record => ({
        id: record[SITE_GROUP_TABLE.COLUMNS.ID]?.toString(),
        name: record[SITE_GROUP_TABLE.COLUMNS.NAME],
        description: record[SITE_GROUP_TABLE.COLUMNS.DESCRIPTION],
        sortOrder: record[SITE_GROUP_TABLE.COLUMNS.SORT_ORDER],
        createTime: record[SITE_GROUP_TABLE.COLUMNS.CREATE_TIME],
        updateTime: record[SITE_GROUP_TABLE.COLUMNS.UPDATE_TIME]
      }));
      
      Logger.info(TAG, `Retrieved ${groups.length} site groups`);
      return groups;
    } catch (error) {
      Logger.error(TAG, `Failed to get all site groups: ${JSON.stringify(error)}`);
      return [];
    }
  }
  
  /**
   * ç¼“å­˜ç«™ç‚¹æ•°æ®
   */
  private async cacheSiteData(site: Site): Promise<void> {
    try {
      await this.storageUtil.setObject(`${SITE_CACHE_PREFIX}${site.id}`, site instanceof Error ? site : new Error(String(site instanceof Error ? site instanceof Error ? site : new Error(String(site : new Error(String(site instanceof Error ? site : new Error(String(site instanceof Error ? site instanceof Error ? site : new Error(String(site instanceof Error ? site instanceof Error ? site : new Error(String(site : new Error(String(site instanceof Error ? site : new Error(String(site : new Error(String(site instanceof Error ? site : new Error(String(site instanceof Error ? site instanceof Error ? site : new Error(String(site : new Error(String(site instanceof Error ? site : new Error(String(site)))))));
    } catch (error) {
      Logger.warn(TAG, `Failed to cache site ${site.id}: ${JSON.stringify(error)}`);
    }
  }
  
  /**
   * è·å–ç¼“å­˜çš„ç«™ç‚¹æ•°æ?   */
  private async getCachedSite(siteId: string): Promise<Site | null> {
    try {
      return await this.storageUtil.getObject<Site>(`${SITE_CACHE_PREFIX}${siteId}`);
    } catch (error) {
      return null;
    }
  }
  
  /**
   * ç§»é™¤ç¼“å­˜çš„ç«™ç‚¹æ•°æ?   */
  private async removeCachedSite(siteId: string): Promise<void> {
    try {
      await this.storageUtil.remove(`${SITE_CACHE_PREFIX}${siteId}`);
    } catch (error) {
      Logger.warn(TAG, `Failed to remove cached site ${siteId}: ${JSON.stringify(error)}`);
    }
  }
  
  /**
   * ç¼“å­˜ç«™ç‚¹åˆ—è¡¨
   */
  private async cacheSiteList(sites: Site[]): Promise<void> {
    try {
      await this.storageUtil.setObject(SITE_LIST_CACHE, sites);
    } catch (error) {
      Logger.warn(TAG, `Failed to cache site list: ${JSON.stringify(error)}`);
    }
  }
  
  /**
   * è·å–ç¼“å­˜çš„ç«™ç‚¹åˆ—è¡?   */
  private async getCachedSiteList(): Promise<Site[] | null> {
    try {
      return await this.storageUtil.getObject<Site[]>(SITE_LIST_CACHE);
    } catch (error) {
      return null;
    }
  }
  
  /**
   * ä½¿ç«™ç‚¹åˆ—è¡¨ç¼“å­˜å¤±æ•?   */
  private async invalidateSiteListCache(): Promise<void> {
    try {
      await this.storageUtil.remove(SITE_LIST_CACHE);
    } catch (error) {
      Logger.warn(TAG, `Failed to invalidate site list cache: ${JSON.stringify(error)}`);
    }
  }
  
  /**
   * å°†æ•°æ®åº“è®°å½•è½¬æ¢ä¸ºSiteå¯¹è±¡
   */
  private convertToSiteObject(record: Record<string, unknown>): Site {
    return {
      id: record[SITE_TABLE.COLUMNS.ID]?.toString(),
      name: record[SITE_TABLE.COLUMNS.NAME],
      url: record[SITE_TABLE.COLUMNS.URL],
      icon: record[SITE_TABLE.COLUMNS.ICON],
      type: record[SITE_TABLE.COLUMNS.TYPE],
      loaderType: record[SITE_TABLE.COLUMNS.LOADER_TYPE],
      groupId: record[SITE_TABLE.COLUMNS.GROUP_ID]?.toString(),
      description: record[SITE_TABLE.COLUMNS.DESCRIPTION],
      enabled: record[SITE_TABLE.COLUMNS.ENABLED] === 1,
      sortOrder: record[SITE_TABLE.COLUMNS.SORT_ORDER],
      createTime: record[SITE_TABLE.COLUMNS.CREATE_TIME],
      updateTime: record[SITE_TABLE.COLUMNS.UPDATE_TIME],
      config: record[SITE_TABLE.COLUMNS.CONFIG] ? JSON.parse(record[SITE_TABLE.COLUMNS.CONFIG]) : {},
      extraData: record[SITE_TABLE.COLUMNS.EXTRA_DATA] ? JSON.parse(record[SITE_TABLE.COLUMNS.EXTRA_DATA]) : {}
    };
  }
  
  /**
   * å°†æ•°æ®åº“è®°å½•åˆ—è¡¨è½¬æ¢ä¸ºSiteå¯¹è±¡åˆ—è¡¨
   */
  private convertToSiteObjects(records: Record<string, string | number | boolean | null>[]): Site[] {
    return records.map(record => this.convertToSiteObject(record));
  }
}


