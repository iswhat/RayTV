// RepositoryFactory - ä»“åº“å·¥å‚ç±?import Logger from '../../common/util/Logger';
import DatabaseRepository from './DatabaseRepository';
import SQLiteDatabaseRepository from './SQLiteDatabaseRepository';
import NetworkRepository from './NetworkRepository';
import DefaultNetworkRepository from './DefaultNetworkRepository';

const TAG = 'RepositoryFactory';

/**
 * Repositoryç±»å‹æšä¸¾
 */
export enum RepositoryType {
  DATABASE,
  NETWORK
}

/**
 * Repositoryå·¥å‚ç±? * è´Ÿè´£åˆ›å»ºå’Œç®¡ç†å„ç§Repositoryçš„å®ä¾? */
export default class RepositoryFactory {
  private static instance: RepositoryFactory | null;
  private repositoryMap: Map<RepositoryType, DatabaseRepository | NetworkRepository> = new Map();
  private isInitialized: boolean = false;

  /**
   * ç§æœ‰æ„é€ å‡½æ•?   */
  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns RepositoryFactoryå®ä¾‹
   */
  public static getInstance(): RepositoryFactory {
    if (!RepositoryFactory.instance) {
      RepositoryFactory.instance = new RepositoryFactory();
    }
    return RepositoryFactory.instance;
  }

  /**
   * åˆå§‹åŒ–æ‰€æœ‰ä»“åº?   * @returns æ˜¯å¦åˆå§‹åŒ–æˆåŠ?   */
  public async initialize(): Promise<boolean> {
    try {
      if (this.isInitialized) {
        Logger.info(TAG, 'Repositories already initialized');
        return true;
      }

      Logger.info(TAG, 'Initializing repositories...');

      // åˆå§‹åŒ–æ•°æ®åº“ä»“åº“
      const databaseRepository = new SQLiteDatabaseRepository();
      const dbInitResult = await databaseRepository.initialize();
      
      if (!dbInitResult.success) {
        Logger.error(TAG, `Failed to initialize database repository: ${dbInitResult.message || 'Unknown error'}`);
        return false;
      }
      
      this.repositoryMap.set(RepositoryType.DATABASE, databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository : new Error(String(databaseRepository instanceof Error ? databaseRepository : new Error(String(databaseRepository)))))));
      Logger.info(TAG, 'Database repository initialized successfully');

      // åˆå§‹åŒ–ç½‘ç»œä»“åº“ï¼ˆè¿™é‡Œä½¿ç”¨é»˜è®¤é…ç½®ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æä¾›å…·ä½“é…ç½®ï¼‰
      const networkRepository = new DefaultNetworkRepository();
      // æ³¨æ„ï¼šè¿™é‡Œä¸è¿›è¡Œåˆå§‹åŒ–ï¼Œå› ä¸ºéœ€è¦å…·ä½“çš„baseUrlé…ç½®
      // åœ¨ä½¿ç”¨ç½‘ç»œä»“åº“ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨setConfigå¹¶initialize
      this.repositoryMap.set(RepositoryType.NETWORK, networkRepository);
      Logger.info(TAG, 'Network repository created (needs specific initialization)');

      this.isInitialized = true;
      Logger.info(TAG, 'All repositories initialized successfully');
      return true;
    } catch (error) {
      Logger.error(TAG, `Failed to initialize repositories: ${error instanceof Error ? error.message : String(error)}`);
      return false;
    }
  }

  /**
   * è·å–æ•°æ®åº“ä»“åº“å®ä¾?   * @returns DatabaseRepositoryå®ä¾‹
   */
  public getDatabaseRepository(): DatabaseRepository {
    const repository = this.repositoryMap.get(RepositoryType.DATABASE);
    if (!repository) {
      throw new Error('Database repository not initialized. Call initialize() first.');
    }
    return repository;
  }

  /**
   * è·å–ç½‘ç»œä»“åº“å®ä¾‹
   * @returns NetworkRepositoryå®ä¾‹
   */
  public getNetworkRepository(): NetworkRepository {
    const repository = this.repositoryMap.get(RepositoryType.NETWORK);
    if (!repository) {
      throw new Error('Network repository not initialized. Call initialize() first.');
    }
    return repository;
  }

  /**
   * è®¾ç½®è‡ªå®šä¹‰ä»“åº“å®ä¾?   * @param type ä»“åº“ç±»å‹
   * @param repository ä»“åº“å®ä¾‹
   */
  public setRepository(type: RepositoryType, repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository instanceof Error ? repository: DatabaseRepository | NetworkRepository : new Error(String(repository: DatabaseRepository | NetworkRepository))))))): void {
    this.repositoryMap.set(type, repository);
    Logger.info(TAG, `Custom repository set for type: ${type}`);
  }

  /**
   * æ£€æŸ¥ä»“åº“æ˜¯å¦åˆå§‹åŒ–
   * @param type ä»“åº“ç±»å‹
   * @returns æ˜¯å¦åˆå§‹åŒ?   */
  public isRepositoryInitialized(type: RepositoryType): boolean {
    return this.repositoryMap.has(type);
  }

  /**
   * å…³é—­æ‰€æœ‰ä»“åº“èµ„æº?   */
  public async close(): Promise<void> {
    try {
      Logger.info(TAG, 'Closing repositories...');

      // å…³é—­æ•°æ®åº“ä»“åº?      const dbRepository = this.repositoryMap.get(RepositoryType.DATABASE);
      if (dbRepository && typeof dbRepository.close === 'function') {
        await dbRepository.close();
        Logger.info(TAG, 'Database repository closed');
      }

      // æ¸…ç†ä»“åº“æ˜ å°„
      this.repositoryMap.clear();
      this.isInitialized = false;
      
      Logger.info(TAG, 'All repositories closed successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to close repositories: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  /**
   * é‡ç½®å·¥å‚ï¼ˆä¸»è¦ç”¨äºæµ‹è¯•ï¼‰
   */
  public static reset(): void {
    if (RepositoryFactory.instance) {
      RepositoryFactory.instance.close().catch(error => {
        Logger.error(TAG, `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error instanceof Error ? `Error during factory reset: ${error instanceof Error ? error.message : String(error : new Error(String(`Error during factory reset: ${error instanceof Error ? error.message : String(error)))))))}`);
      });
      RepositoryFactory.instance = null;
    }
    Logger.info(TAG, 'Repository factory reset');
  }
}


