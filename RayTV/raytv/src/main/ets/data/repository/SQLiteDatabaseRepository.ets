// SQLiteDatabaseRepository - SQLiteÊï∞ÊçÆÂ∫ìÂÆûÁé∞Á±ª
import Logger from '../../common/util/Logger';
import JsonUtil from '../../common/util/JsonUtil';
import DatabaseRepository, {
  DatabaseResult,
  DatabaseStatus,
  PaginationParams,
  PaginatedResult,
  ConfigValue
} from './DatabaseRepository';
import Movie from '../model/Movie';
import User from '../model/User';
import History from '../model/History';
import SearchResult, { ResultType } from '../model/SearchResult';
import relationalStore from '@ohos.data.relationalStore';
import BusinessError from '@ohos.base';
import common from '@ohos.app.ability.common';

const TAG = 'SQLiteDatabaseRepository';
const DATABASE_NAME = 'raytv.db';
const DATABASE_VERSION = 1;

/**
 * SQLiteÊï∞ÊçÆÂ∫ìÂÆûÁé∞Á±ª
 * ÂÆûÁé∞‰∫ÜDatabaseRepositoryÊé•Âè£ÔºåÊèê‰æõÂü∫‰∫éSQLiteÁöÑÊï∞ÊçÆÂ∫ìÊìç‰ΩúÂäüËÉΩ
 */
export default class SQLiteDatabaseRepository implements DatabaseRepository {
  private rdbStore: relationalStore.RdbStore | null = null;
  private status: DatabaseStatus = DatabaseStatus.INITIALIZING;
  private configMap: Map<string, Record<string, string | number | boolean | Record<string, string | number | boolean>>> = new Map(); // Áî®‰∫éÁºìÂ≠òÈÖçÁΩÆ
  private context: common.UIAbilityContext | null = null;

  /**
   * ËÆæÁΩÆ‰∏ä‰∏ãÊñ?
   */
  setContext(context: common.UIAbilityContext): void {
    this.context = context;
  }

  /**
   * ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì
   */
  async initialize(): Promise<DatabaseResult<void>> {
    try {
      Logger.info(TAG, 'Initializing database...');
      
      if (!this.context) {
        throw new Error('Context not set. Call setContext() before initialize().');
      }

      const config: relationalStore.StoreConfig = {
        name: DATABASE_NAME,
        securityLevel: relationalStore.SecurityLevel.S1
      };

      // ÂàõÂª∫ÊàñÊâìÂºÄÊï∞ÊçÆÂ∫?
      const rdbStore = await relationalStore.getRdbStore(this.context, config);
      
      // ËÆæÁΩÆÊï∞ÊçÆÂ∫ìÁâàÊú¨ÂíåÂçáÁ∫ßÂõûË∞É
      await rdbStore.setVersion(DATABASE_VERSION);
      
      // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂàõÂª∫ÊàñÂçáÁ∫ßÊï∞ÊçÆÂ∫?
      const currentVersion: number = await rdbStore.getVersion();
      if (currentVersion === 0) {
        await this.onCreateDatabase(rdbStore);
      } else if (currentVersion < DATABASE_VERSION) {
        await this.onUpgradeDatabase(rdbStore, currentVersion, DATABASE_VERSION);
      }

      this.rdbStore = rdbStore;
      this.status = DatabaseStatus.READY;
      
      // È¢ÑÂä†ËΩΩÈÖçÁΩÆÁºìÂ≠?
      await this.loadConfigCache();
      
      // Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
      await this.clearExpiredCache();
      
      Logger.info(TAG, 'Database initialized successfully');
      return {
        success: true
      };
    } catch (error) {
      Logger.error(TAG, `Failed to initialize database: ${error instanceof Error ? error.message : String(error)}`);
      this.status = DatabaseStatus.ERROR;
      return {
        success: false, error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error)))))))),
        message: 'Database initialization failed'
      };
    }
  }

  /**
   * Ëé∑ÂèñÊï∞ÊçÆÂ∫ìÁä∂ÊÄ?
   */
  getStatus(): DatabaseStatus {
    return this.status;
  }

  /**
   * ÂÖ≥Èó≠Êï∞ÊçÆÂ∫?
   */
  async close(): Promise<DatabaseResult<void>> {
    try {
      if (this.status === DatabaseStatus.CLOSED || this.status === DatabaseStatus.CLOSING) {
        return { success: true };
      }

      this.status = DatabaseStatus.CLOSING;
      
      if (this.rdbStore) {
        // RDB‰∏çÊèê‰æõÊòæÂºèÂÖ≥Èó≠ÊñπÊ≥ïÔºåÁî±Á≥ªÁªüÁÆ°Áê?
        this.rdbStore = null;
      }

      this.status = DatabaseStatus.CLOSED;
      this.configMap.clear();
      
      Logger.info(TAG, 'Database closed successfully');
      return { success: true };
    } catch (error) {
      Logger.error(TAG, `Failed to close database: ${error instanceof Error ? error.message : String(error)}`);
      return {
        success: false, error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error)))))))),
        message: 'Database closing failed'
      };
    }
  }

  /**
   * ÂàõÂª∫Êï∞ÊçÆÂ∫ìË°®
   */
  private async onCreateDatabase(rdb: relationalStore.RdbStore): Promise<void> {
    try {
      Logger.info(TAG, 'Creating database tables...');
      
      // ÂàõÂª∫ÁîµÂΩ±Ë°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS movies (
          id TEXT PRIMARY KEY,
          title TEXT NOT NULL,
          originalTitle TEXT,
          type INTEGER NOT NULL,
          coverUrl TEXT,
          backdropUrl TEXT,
          description TEXT,
          releaseDate TEXT,
          year INTEGER,
          genres TEXT,
          tags TEXT,
          duration INTEGER,
          totalEpisodes INTEGER,
          currentSeason INTEGER,
          score REAL,
          directors TEXT,
          actors TEXT,
          studio TEXT,
          country TEXT,
          language TEXT,
          plot TEXT,
          status INTEGER,
          createTime INTEGER,
          updateTime INTEGER,
          sourceId TEXT,
          sourceName TEXT,
          quality TEXT,
          videoSources TEXT,
          episodes TEXT,
          ratingInfo TEXT,
          extraInfo TEXT
        );
      `);

      // ÂàõÂª∫Áî®Êà∑Ë°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS users (
          id TEXT PRIMARY KEY,
          username TEXT NOT NULL UNIQUE,
          nickname TEXT,
          avatarUrl TEXT,
          email TEXT,
          phone TEXT,
          role INTEGER DEFAULT 0,
          isGuest INTEGER DEFAULT 0,
          preferences TEXT,
          lastLoginTime INTEGER,
          createTime INTEGER,
          updateTime INTEGER,
          deviceInfo TEXT,
          watchTime INTEGER DEFAULT 0,
          themeMode TEXT,
          interfaceLanguage TEXT,
          subtitleLanguage TEXT,
          audioLanguage TEXT,
          playMode INTEGER,
          playbackSpeed REAL,
          autoPlay INTEGER DEFAULT 1
        );
      `);

      // ÂàõÂª∫ËßÇÁúãÂéÜÂè≤Ë°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS history (
          id TEXT PRIMARY KEY,
          userId TEXT NOT NULL,
          contentId TEXT NOT NULL,
          contentType TEXT NOT NULL,
          contentTitle TEXT NOT NULL,
          coverUrl TEXT,
          lastWatchTime INTEGER NOT NULL,
          watchProgress INTEGER DEFAULT 0,
          totalDuration INTEGER DEFAULT 0,
          currentEpisodeIndex INTEGER DEFAULT 0,
          currentSeason INTEGER DEFAULT 1,
          playCount INTEGER DEFAULT 0,
          sourceId TEXT,
          sourceName TEXT,
          extraInfo TEXT,
          FOREIGN KEY (userId) REFERENCES users(id)
        );
      `);

      // ÂàõÂª∫Êî∂ËóèË°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS favorites (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          userId TEXT NOT NULL,
          movieId TEXT NOT NULL,
          collectionName TEXT DEFAULT 'ÈªòËÆ§Êî∂Ëóè',
          addTime INTEGER NOT NULL,
          FOREIGN KEY (userId) REFERENCES users(id),
          FOREIGN KEY (movieId) REFERENCES movies(id),
          UNIQUE(userId, movieId)
        );
      `);

      // ÂàõÂª∫ÊêúÁ¥¢ÂéÜÂè≤Ë°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS search_history (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          userId TEXT NOT NULL,
          keyword TEXT NOT NULL,
          searchTime INTEGER NOT NULL,
          FOREIGN KEY (userId) REFERENCES users(id)
        );
      `);

      // ÂàõÂª∫ÁºìÂ≠òË°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS cache (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          key TEXT NOT NULL UNIQUE,
          value TEXT NOT NULL,
          expireTime INTEGER,
          createTime INTEGER NOT NULL,
          updateTime INTEGER NOT NULL
        );
      `);

      // ÂàõÂª∫ÈÖçÁΩÆË°?
      await rdb.executeSql(`
        CREATE TABLE IF NOT EXISTS config (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          key TEXT NOT NULL,
          value TEXT NOT NULL,
          config_group TEXT DEFAULT 'default',
          createTime INTEGER NOT NULL,
          updateTime INTEGER NOT NULL,
          UNIQUE(key, config_group)
        );
      `);

      Logger.info(TAG, 'Database tables created successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to create database tables: ${error instanceof Error ? error.message : String(error)}`);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * Êï∞ÊçÆÂ∫ìÂçáÁ∫?
   */
  private async onUpgradeDatabase(rdb: relationalStore.RdbStore, oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number instanceof Error ? oldVersion: number, newVersion: number : new Error(String(oldVersion: number, newVersion: number))))))): Promise<void> {
    try {
      Logger.info(TAG, `Upgrading database from version ${oldVersion} to ${newVersion}`);
      
      // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êï∞ÊçÆÂ∫ìÂçáÁ∫ßÈÄªËæë
      // ‰æãÂ¶ÇÊ∑ªÂä†Êñ∞Ë°®„ÄÅ‰øÆÊîπË°®ÁªìÊûÑ„ÄÅÊ∑ªÂä†Êñ∞Â≠óÊÆµÁ≠?
      
      // Á§∫‰æãÔºö‰ªéÁâàÊú¨1ÂçáÁ∫ßÂà∞ÁâàÊú?
      if (oldVersion === 1 && newVersion >= 2) {
        // Ê∑ªÂä†Êñ∞Ë°®Êàñ‰øÆÊîπË°®ÁªìÊûÑ
        Logger.info(TAG, 'Applying database upgrade from version 1 to 2');
      }
      
      // Á§∫‰æãÔºö‰ªéÁâàÊú¨2ÂçáÁ∫ßÂà∞ÁâàÊú?
      if (oldVersion === 2 && newVersion >= 3) {
        // Ê∑ªÂä†Êñ∞Ë°®Êàñ‰øÆÊîπË°®ÁªìÊûÑ
        Logger.info(TAG, 'Applying database upgrade from version 2 to 3');
      }
      
      Logger.info(TAG, 'Database upgrade completed successfully');
    } catch (error) {
      Logger.error(TAG, `Failed to upgrade database: ${error instanceof Error ? error.message : String(error)}`);
      throw error instanceof Error ? error : new Error(String(error));
    }
  }

  /**
   * Âä†ËΩΩÈÖçÁΩÆÁºìÂ≠ò
   */
  private async loadConfigCache(): Promise<void> {
    try {
      if (!this.rdbStore) {
        return;
      }

      const predicates = new relationalStore.RdbPredicates('config');
      const resultSet = await this.rdbStore.query(predicates);
      
      if (resultSet && resultSet.goToFirstRow()) {
        do {
          const key = resultSet.getString(resultSet.getColumnIndex('key'));
          const value = resultSet.getString(resultSet.getColumnIndex('value'));
          const config_group = resultSet.getString(resultSet.getColumnIndex('config_group')) || 'default';
          
          if (key) {
            try {
              const parsedValue = JsonUtil.safeParse<Record<string, string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '' instanceof Error ? string | number | boolean | Record<string, string | number | boolean>>>(value || '' : new Error(String(string | number | boolean | Record<string, string | number | boolean>>>(value || '')))))));
              if (parsedValue) {
                this.configMap.set(`${config_group}:${key}`, parsedValue);
              }
            } catch (e) {
              Logger.warn(TAG, `Failed to parse config value for key ${key}: ${e instanceof Error ? e.message : String(e)}`);
              const configValue: ConfigValueObject = { value: value };
              this.configMap.set(`${config_group}:${key}`, configValue);
            }
          }
        } while (resultSet.goToNextRow());
        resultSet.close();
      }
    } catch (error) {
      Logger.error(TAG, `Failed to load config cache: ${error instanceof Error ? error.message : String(error)}`);
    }
  }

  // ÈÖçÁΩÆÂÄºÁ±ªÂûãÊé•Âè?
export interface ConfigValueObject {
  value: string;
}

  // ========== ÁîµÂΩ±Áõ∏ÂÖ≥ÂÆûÁé∞ ==========

  async addMovie(movie: Movie): Promise<DatabaseResult<string>> {
    try {
      if (!this.rdbStore) {
        throw new Error('Database not initialized');
      }

      const valuesBucket: relationalStore.ValuesBucket = {
        'id': movie.id, 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] instanceof Error ? 'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || [] : new Error(String('title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || []))))))),
        'tags': JsonUtil.stringify(movie.tags || []),
        'duration': movie.duration || null,
        'totalEpisodes': movie.totalEpisodes || null,
        'currentSeason': movie.currentSeason || null,
        'score': movie.score || null,
        'directors': JsonUtil.stringify(movie.directors || []),
        'actors': JsonUtil.stringify(movie.actors || []),
        'studio': movie.studio || null,
        'country': movie.country || null,
        'language': movie.language || null,
        'plot': movie.plot || null,
        'status': movie.status || null,
        'createTime': Date.now(),
        'updateTime': Date.now(),
        'sourceId': movie.sourceId || null,
        'sourceName': movie.sourceName || null,
        'quality': movie.quality?.toString() || null,
        'videoSources': JsonUtil.stringify(movie.videoSources || []),
        'episodes': JsonUtil.stringify(movie.episodes || []),
        'ratingInfo': movie.ratingInfo ? JsonUtil.stringify(movie.ratingInfo) : null,
        'extraInfo': JsonUtil.stringify(movie.extraInfo || {})
      };

      const rowsInserted = await this.rdbStore.insert('movies', valuesBucket);
      
      if (rowsInserted > 0) {
        Logger.info(TAG, `Movie added successfully: ${movie.id}`);
        // ÊòéÁ°ÆÂàùÂßãÂåñDatabaseResultÂØπË±°
        const result: DatabaseResult<string> = {
          success: true,
          data: movie.id
        };
        return result;
      } else {
        throw new Error('Failed to insert movie');
      }
    } catch (error) {
      Logger.error(TAG, `Failed to add movie: ${error instanceof Error ? error.message : String(error)}`);
      const result: DatabaseResult<string> = {
        success: false, error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error)))))))),
        message: 'Failed to add movie'
      };
      return result;
    }
  }

  async updateMovie(movie: Movie): Promise<DatabaseResult<boolean>> {
    try {
      if (!this.rdbStore) {
        throw new Error('Database not initialized');
      }

      const valuesBucket: relationalStore.ValuesBucket = {
        'title': movie.title,
        'originalTitle': movie.originalTitle || null,
        'type': movie.type,
        'coverUrl': movie.coverUrl || null,
        'backdropUrl': movie.backdropUrl || null,
        'description': movie.description || null,
        'releaseDate': movie.releaseDate || null,
        'year': movie.year || null,
        'genres': JsonUtil.stringify(movie.genres || []),
        'tags': JsonUtil.stringify(movie.tags || []),
        'duration': movie.duration || null,
        'totalEpisodes': movie.totalEpisodes || null,
        'currentSeason': movie.currentSeason || null,
        'score': movie.score || null,
        'directors': JsonUtil.stringify(movie.directors || []),
        'actors': JsonUtil.stringify(movie.actors || []),
        'studio': movie.studio || null,
        'country': movie.country || null,
        'language': movie.language || null,
        'plot': movie.plot || null,
        'status': movie.status || null,
        'updateTime': Date.now(),
        'sourceId': movie.sourceId || null,
        'sourceName': movie.sourceName || null,
        'quality': movie.quality?.toString() || null,
        'videoSources': JsonUtil.stringify(movie.videoSources || []),
        'episodes': JsonUtil.stringify(movie.episodes || []),
        'ratingInfo': movie.ratingInfo ? JsonUtil.stringify(movie.ratingInfo) : null,
        'extraInfo': JsonUtil.stringify(movie.extraInfo || {})
      };

      const predicates = new relationalStore.RdbPredicates('movies');
      predicates.equalTo('id', movie.id);
      
      const rowsUpdated = await this.rdbStore.update(valuesBucket, predicates);
      
      if (rowsUpdated > 0) {
        Logger.info(TAG, `Movie updated successfully: ${movie.id}`);
        const result: DatabaseResult<boolean> = {
          success: true,
          data: true
        };
        return result;
      } else {
        const result: DatabaseResult<boolean> = {
          success: true,
          data: false,
          message: 'Movie not found'
        };
        return result;
      }
    } catch (error) {
      Logger.error(TAG, `Failed to update movie: ${error instanceof Error ? error.message : String(error)}`);
      const result: DatabaseResult<boolean> = {
        success: false, error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error)))))))),
        message: 'Failed to update movie'
      };
      return result;
    }
  }

  async deleteMovie(movieId: string): Promise<DatabaseResult<boolean>> {
    try {
      if (!this.rdbStore) {
        throw new Error('Database not initialized');
      }

      const predicates = new relationalStore.RdbPredicates('movies');
      predicates.equalTo('id', movieId);
      
      const rowsDeleted = await this.rdbStore.delete(predicates);
      
      if (rowsDeleted > 0) {
        Logger.info(TAG, `Movie deleted successfully: ${movieId}`);
        // ÂêåÊó∂Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊî∂ËóèËÆ∞ÂΩ?
        const favPredicates = new relationalStore.RdbPredicates('favorites');
        favPredicates.equalTo('movieId', movieId);
        await this.rdbStore.delete(favPredicates);
        
        const result: DatabaseResult<boolean> = {
          success: true,
          data: true
        };
        return result;
      } else {
        const result: DatabaseResult<boolean> = {
          success: true,
          data: false,
          message: 'Movie not found'
        };
        return result;
      }
    } catch (error) {
      Logger.error(TAG, `Failed to delete movie: ${error instanceof Error ? error.message : String(error)}`);
      const result: DatabaseResult<boolean> = {
        success: false, error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error)))))))),
        message: 'Failed to delete movie'
      };
      return result;
    }
  }

  async getMovieById(movieId: string): Promise<DatabaseResult<Movie | null>> {
    try {
      if (!this.rdbStore) {
        throw new Error('Database not initialized');
      }

      const predicates = new relationalStore.RdbPredicates('movies');
      predicates.equalTo('id', movieId);
      
      const resultSet = await this.rdbStore.query(predicates);
      
      if (resultSet && resultSet.goToFirstRow()) {
        const movie = this.parseMovieFromResultSet(resultSet);
        resultSet.close();
        const result: DatabaseResult<Movie | null> = {
          success: true,
          data: movie
        };
        return result;
      } else {
        if (resultSet) {
          resultSet.close();
        }
        const result: DatabaseResult<Movie | null> = {
          success: true,
          data: null
        };
        return result;
      }
    } catch (error) {
      Logger.error(TAG, `Failed to get movie by ID: ${error instanceof Error ? error.message : String(error)}`);
      const result: DatabaseResult<Movie | null> = {
        success: false, error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error instanceof Error ? error: error instanceof Error ? error : new Error(String(error : new Error(String(error: error instanceof Error ? error : new Error(String(error)))))))),
        message: 'Failed to get movie by ID'
      };
      return result;
    }
  }

  /**
   * ‰ªéÁªìÊûúÈõÜ‰∏≠Ëß£ÊûêMovieÂØπË±°
   */
  private parseMovieFromResultSet(resultSet: relationalStore.ResultSet): Movie | null {
    try {
      if (!resultSet || resultSet.rowCount === 0) {
        return null;
      }

      // ÂàõÂª∫‰∏Ä‰∏™Á¨¶ÂêàPartial<Movie>Á±ªÂûãÁöÑÂØπË±°ÔºåÈÅøÂÖçÁõ¥Êé•‰ΩøÁî®ÂØπË±°Â≠óÈù¢Èá?
      const movieData: Partial<Movie> = {};
      
      // ÈÄê‰∏™ËµãÂÄºÂ±ûÊÄßÔºåÁ°Æ‰øùÁ±ªÂûãÂÆâÂÖ®
      movieData.id = this.safeGetString(resultSet, 'id') || '';
      movieData.title = this.safeGetString(resultSet, 'title') || '';
      movieData.originalTitle = this.safeGetString(resultSet, 'originalTitle');
      movieData.type = this.safeGetLong(resultSet, 'type') || 0;
      movieData.coverUrl = this.safeGetString(resultSet, 'coverUrl');
      movieData.backdropUrl = this.safeGetString(resultSet, 'backdropUrl');
      movieData.description = this.safeGetString(resultSet, 'description');
      movieData.releaseDate = this.safeGetString(resultSet, 'releaseDate');
      movieData.year = this.safeGetLong(resultSet, 'year') || 0;
      movieData.genres = this.safeParseJson(this.safeGetString(resultSet, 'genres') || '[]');
      movieData.tags = this.safeParseJson(this.safeGetString(resultSet, 'tags') || '[]');
      movieData.duration = this.safeGetLong(resultSet, 'duration') || 0;
      movieData.totalEpisodes = this.safeGetLong(resultSet, 'totalEpisodes') || 0;
      movieData.currentSeason = this.safeGetLong(resultSet, 'currentSeason') || 1;
      movieData.score = this.safeGetDouble(resultSet, 'score') || 0;
      movieData.directors = this.safeParseJson(this.safeGetString(resultSet, 'directors') || '[]');
      movieData.actors = this.safeParseJson(this.safeGetString(resultSet, 'actors') || '[]');
      movieData.studio = this.safeGetString(resultSet, 'studio');
      movieData.country = this.safeGetString(resultSet, 'country');
      movieData.language = this.safeGetString(resultSet, 'language');
      movieData.plot = this.safeGetString(resultSet, 'plot');
      movieData.status = this.safeGetLong(resultSet, 'status') || 0;
      movieData.createTime = this.safeGetLong(resultSet, 'createTime') || Date.now();
      movieData.updateTime = this.safeGetLong(resultSet, 'updateTime') || Date.now();
      movieData.sourceId = this.safeGetString(resultSet, 'sourceId');
      movieData.sourceName = this.safeGetString(resultSet, 'sourceName');
      movieData.quality = this.safeGetString(resultSet, 'quality') as string;
      movieData.videoSources = this.safeParseJson(this.safeGetString(resultSet, 'videoSources') || '[]');
      movieData.episodes = this.safeParseJson(this.safeGetString(resultSet, 'episodes') || '[]');
      movieData.ratingInfo = this.safeParseJson(this.safeGetString(resultSet, 'ratingInfo') || '{}');
      movieData.extraInfo = this.safeParseJson(this.safeGetString(resultSet, 'extraInfo') || '{}');
      
      const movie = new Movie(movieData);
      return movie;
    } catch (error) {
      Logger.error(TAG, `Failed to parse movie from result set: ${error instanceof Error ? error.message : String(error)}`);
      return null;
    }
  }

  /**
   * ÂÆâÂÖ®Ëé∑ÂèñÂ≠óÁ¨¶‰∏≤Á±ªÂûãÂ≠óÊÆ?
   */
  private safeGetString(resultSet: relationalStore.ResultSet, columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string : new Error(String(columnName: string instanceof Error ? columnName: string : new Error(String(columnName: string))))))): string | undefined {
    try {
      const columnIndex = resultSet.getColumnIndex(columnName);
      if (columnIndex === -1) return undefined;
      const value = resultSet.getString(columnIndex);
      return value || undefined;
    } catch (error) {
      Logger.warn(TAG, `Failed to get string column ${columnName}: ${error instanceof Error ? error.message : String(error)}`);
      return undefined;
    }
  }

  /**
   * ÂÆâÂÖ®Ëé∑ÂèñÈïøÊï¥ÂûãÂ≠óÊÆ?
   */
  private safeGetLong(resultSet: relationalStore.ResultSet, columnName: string): number | undefined {
    try {
      const columnIndex = resultSet.getColumnIndex(columnName);
      if (columnIndex === -1) return undefined;
      const value = resultSet.getLong(columnIndex);
      return value !== null ? value : undefined;
    } catch (error) {
      Logger.warn(TAG, `Failed to get long column ${columnName}: ${error instanceof Error ? error.message : String(error)}`);
      return undefined;
    }
  }

  /**
   * ÂÆâÂÖ®Ëé∑ÂèñÂèåÁ≤æÂ∫¶Â≠óÊÆ?
   */
  private safeGetDouble(resultSet: relationalStore.ResultSet, columnName: string): number | undefined {
    try {
      const columnIndex = resultSet.getColumnIndex(columnName);
      if (columnIndex === -1) return undefined;
      const value = resultSet.getDouble(columnIndex);
      return value !== null ? value : undefined;
    } catch (error) {
      Logger.warn(TAG, `Failed to get double column ${columnName}: ${error instanceof Error ? error.message : String(error)}`);
      return undefined;
    }
  }

  /**
   * ÂÆâÂÖ®Ëß£ÊûêJSON
   */
  private safeParseJson(jsonStr: string): Record<string, string | number | boolean | null> {
    try {
      const result = JsonUtil.safeParse<Record<string, string | number | boolean | null>>(jsonStr);
      return result || {};
    } catch (error) {
      Logger.warn(TAG, `Failed to parse JSON: ${error instanceof Error ? error.message : String(error)}`);
      return {};
    }
  }

  // ÂÆûÁé∞ÂÖ∂‰ªñÊé•Âè£ÊñπÊ≥ï...
  // Áî±‰∫éÁØáÂπÖÈôêÂà∂ÔºåËøôÈáåÁúÅÁï•‰∫ÜÂÖ∂‰ªñÊñπÊ≥ïÁöÑÂÖ∑‰ΩìÂÆûÁé?
  // Âú®ÂÆûÈôÖÂºÄÂèë‰∏≠ÔºåÈúÄË¶ÅÂÆûÁé∞DatabaseRepositoryÊé•Âè£‰∏≠ÂÆö‰πâÁöÑÊâÄÊúâÊñπÊ≥?

  // ========== Âç†‰ΩçÂÆûÁé∞ ==========
  // ‰∏∫‰∫Ü‰ª£Á†ÅËÉΩÁºñËØëÈÄöËøáÔºåÊèê‰æõÂü∫Á°ÄÁöÑÂç†‰ΩçÂÆûÁé?
  async getMoviesByIds(movieIds: string[]): Promise<DatabaseResult<Movie[]>> { return { success: false, message: 'Not implemented' }; }
  async getMoviesPaginated(params: PaginationParams, filters?: import('./DatabaseRepository').MovieFilter): Promise<DatabaseResult<PaginatedResult<Movie>>> { return { success: false, message: 'Not implemented' }; }
  async searchMovies(keyword: string, params: PaginationParams, filters?: import('./DatabaseRepository').MovieFilter): Promise<DatabaseResult<PaginatedResult<Movie>>> { return { success: false, message: 'Not implemented' }; }
  async addUser(user: User): Promise<DatabaseResult<string>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async updateUser(user: User): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async deleteUser(userId: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getUserById(userId: string): Promise<DatabaseResult<User | null>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getAllUsers(): Promise<DatabaseResult<User[]>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: [] }; 
  }
  async getUserByUsername(username: string): Promise<DatabaseResult<User | null>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async saveHistory(history: History): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async deleteHistory(historyId: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async deleteAllHistoryByUserId(userId: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getHistoryById(historyId: string): Promise<DatabaseResult<History | null>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getUserHistory(userId: string, params: PaginationParams): Promise<DatabaseResult<PaginatedResult<History>>> { 
    return { 
      success: false, 
      message: 'Not implemented', 
      error: new Error('Not implemented'),
      data: { items: [], totalCount: 0, page: params.page, pageSize: params.pageSize } 
    }; 
  }
  async getUserContentHistory(userId: string, contentId: string, contentType: string): Promise<DatabaseResult<History | null>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getRecentHistory(userId: string, limit: number = 20): Promise<DatabaseResult<History[]>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: [] }; 
  }
  async addFavorite(userId: string, movieId: string, collectionName?: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async removeFavorite(userId: string, movieId: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async isFavorited(userId: string, movieId: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getUserFavorites(userId: string, params: PaginationParams, collectionName?: string): Promise<DatabaseResult<PaginatedResult<Movie>>> { 
    return { 
      success: false, 
      message: 'Not implemented', 
      error: new Error('Not implemented'),
      data: { items: [], totalCount: 0, page: params.page, pageSize: params.pageSize } 
    }; 
  }
  async getUserCollections(userId: string): Promise<DatabaseResult<string[]>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: [] }; 
  }
  async addSearchHistory(userId: string, keyword: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async deleteSearchHistory(userId: string, keyword: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async clearSearchHistory(userId: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getUserSearchHistory(userId: string, limit: number = 50): Promise<DatabaseResult<string[]>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: [] }; 
  }
  async cacheSearchResults(keyword: string, results: SearchResult[], expirationTime?: number): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getCachedSearchResults(keyword: string): Promise<DatabaseResult<SearchResult[] | null>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async clearExpiredCache(): Promise<DatabaseResult<number>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: 0 }; 
  }
  async getCacheSize(): Promise<DatabaseResult<number>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: 0 }; 
  }
  async clearAllCache(): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async saveConfig(key: string, value: ConfigValue, group?: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getConfig(key: string, group?: string): Promise<DatabaseResult<ConfigValue | null>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async deleteConfig(key: string, group?: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
  async getConfigGroup(group: string): Promise<DatabaseResult<Record<string, ConfigValue>>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented'), data: {} }; 
  }
  async clearConfigGroup(group: string): Promise<DatabaseResult<boolean>> { 
    return { success: false, message: 'Not implemented', error: new Error('Not implemented') }; 
  }
}


