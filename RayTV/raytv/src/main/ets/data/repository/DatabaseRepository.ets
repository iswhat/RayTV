// DatabaseRepository - æ•°æ®åº“è®¿é—®æ¥å?import Logger from '../../common/util/Logger';
import Movie from '../model/Movie';
import User from '../model/User';
import History from '../model/History';
import SearchResult from '../model/SearchResult';

const TAG = 'DatabaseRepository';

/**
 * æ•°æ®åº“æ“ä½œç»“æœæ¥å? */
export interface DatabaseResult<T> {
  success: boolean;
  data?: T;
  error?: Error;
  message?: string;
}

/**
 * åˆ†é¡µå‚æ•°æ¥å£
 */
export interface PaginationParams {
  page: number;           // é¡µç ï¼Œä»1å¼€å§?  pageSize: number;       // æ¯é¡µæ•°é‡
  sortBy?: string;        // æ’åºå­—æ®µ
  sortOrder?: 'asc' | 'desc'; // æ’åºé¡ºåº
}

/**
 * åˆ†é¡µç»“æœæ¥å£
 */
export interface PaginatedResult<T> {
  items: T[];             // å½“å‰é¡µæ•°æ®é¡¹
  totalCount: number;     // æ€»æ•°é‡?  page: number;           // å½“å‰é¡µç 
  pageSize: number;       // æ¯é¡µæ•°é‡
  totalPages: number;     // æ€»é¡µæ•?  hasNextPage: boolean;   // æ˜¯å¦æœ‰ä¸‹ä¸€é¡?  hasPrevPage: boolean;   // æ˜¯å¦æœ‰ä¸Šä¸€é¡?}

/**
 * èŒƒå›´ç­›é€‰æ¥å? */
export interface RangeFilter {
  min?: number;
  max?: number;
}

/**
 * ç”µå½±ç­›é€‰æ¡ä»¶æ¥å? */
export interface MovieFilter {
  genres?: string[];      // ç±»å‹ç­›é€?  yearRange?: RangeFilter; // å¹´ä»½èŒƒå›´
  ratingRange?: RangeFilter; // è¯„åˆ†èŒƒå›´
  country?: string[];     // å›½å®¶/åœ°åŒº
  language?: string[];    // è¯­è¨€
  isVip?: boolean;       // æ˜¯å¦VIPå†…å®¹
  hasSubtitle?: boolean; // æ˜¯å¦æœ‰å­—å¹?  sortBy?: 'year' | 'rating' | 'popularity' | 'releaseDate'; // æ’åºå­—æ®µ
  sortOrder?: 'asc' | 'desc'; // æ’åºé¡ºåº
}

/**
 * é…ç½®å€¼ç±»å? */
export type ConfigValue = string | number | boolean | Record<string, string | number | boolean | string[] | number[] | boolean[]> | string[] | number[] | boolean[];

/**
 * æ•°æ®åº“æ“ä½œçŠ¶æ€æšä¸? */
export enum DatabaseStatus {
  INITIALIZING = 'initializing',
  READY = 'ready',
  ERROR = 'error',
  CLOSING = 'closing',
  CLOSED = 'closed'
}

/**
 * æ•°æ®åº“ä»“åº“æ¥å? * å®šä¹‰æ•°æ®æŒä¹…åŒ–æ“ä½œçš„æŠ½è±¡æ–¹æ³•
 */
export default interface DatabaseRepository {
  /**
   * åˆå§‹åŒ–æ•°æ®åº“
   * @returns åˆå§‹åŒ–ç»“æ?   */
  initialize(): Promise<DatabaseResult<void>>;

  /**
   * è·å–æ•°æ®åº“çŠ¶æ€?   * @returns æ•°æ®åº“çŠ¶æ€?   */
  getStatus(): DatabaseStatus;

  /**
   * å…³é—­æ•°æ®åº?   * @returns å…³é—­ç»“æœ
   */
  close(): Promise<DatabaseResult<void>>;

  // ========== ç”µå½±/è§†é¢‘ç›¸å…³æ“ä½œ ==========
  
  /**
   * æ·»åŠ ç”µå½±
   * @param movie ç”µå½±å¯¹è±¡
   * @returns æ“ä½œç»“æœ
   */
  addMovie(movie: Movie): Promise<DatabaseResult<string>>;

  /**
   * æ›´æ–°ç”µå½±
   * @param movie ç”µå½±å¯¹è±¡
   * @returns æ“ä½œç»“æœ
   */
  updateMovie(movie: Movie): Promise<DatabaseResult<boolean>>;

  /**
   * åˆ é™¤ç”µå½±
   * @param movieId ç”µå½±ID
   * @returns æ“ä½œç»“æœ
   */
  deleteMovie(movieId: string): Promise<DatabaseResult<boolean>>;

  /**
   * æ ¹æ®IDè·å–ç”µå½±
   * @param movieId ç”µå½±ID
   * @returns ç”µå½±å¯¹è±¡æˆ–null
   */
  getMovieById(movieId: string): Promise<DatabaseResult<Movie | null>>;

  /**
   * æ‰¹é‡è·å–ç”µå½±
   * @param movieIds ç”µå½±IDæ•°ç»„
   * @returns ç”µå½±å¯¹è±¡æ•°ç»„
   */
  getMoviesByIds(movieIds: string[]): Promise<DatabaseResult<Movie[]>>;

  /**
   * åˆ†é¡µè·å–ç”µå½±åˆ—è¡¨
   * @param params åˆ†é¡µå‚æ•°
   * @param filters ç­›é€‰æ¡ä»?   * @returns åˆ†é¡µç»“æœ
   */
  getMoviesPaginated(
    params: PaginationParams,
    filters?: MovieFilter
  ): Promise<DatabaseResult<PaginatedResult<Movie>>>;

  /**
   * æœç´¢ç”µå½±
   * @param keyword æœç´¢å…³é”®è¯?   * @param params åˆ†é¡µå‚æ•°
   * @param filters ç­›é€‰æ¡ä»?   * @returns åˆ†é¡µæœç´¢ç»“æœ
   */
  searchMovies(
    keyword: string,
    params: PaginationParams,
    filters?: MovieFilter
  ): Promise<DatabaseResult<PaginatedResult<Movie>>>;

  // ========== ç”¨æˆ·ç›¸å…³æ“ä½œ ==========
  
  /**
   * æ·»åŠ ç”¨æˆ·
   * @param user ç”¨æˆ·å¯¹è±¡
   * @returns æ“ä½œç»“æœ
   */
  addUser(user: User): Promise<DatabaseResult<string>>;

  /**
   * æ›´æ–°ç”¨æˆ·
   * @param user ç”¨æˆ·å¯¹è±¡
   * @returns æ“ä½œç»“æœ
   */
  updateUser(user: User): Promise<DatabaseResult<boolean>>;

  /**
   * åˆ é™¤ç”¨æˆ·
   * @param userId ç”¨æˆ·ID
   * @returns æ“ä½œç»“æœ
   */
  deleteUser(userId: string): Promise<DatabaseResult<boolean>>;

  /**
   * æ ¹æ®IDè·å–ç”¨æˆ·
   * @param userId ç”¨æˆ·ID
   * @returns ç”¨æˆ·å¯¹è±¡æˆ–null
   */
  getUserById(userId: string): Promise<DatabaseResult<User | null>>;

  /**
   * è·å–æ‰€æœ‰ç”¨æˆ?   * @returns ç”¨æˆ·åˆ—è¡¨
   */
  getAllUsers(): Promise<DatabaseResult<User[]>>;

  /**
   * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ?   * @param username ç”¨æˆ·å?   * @returns ç”¨æˆ·å¯¹è±¡æˆ–null
   */
  getUserByUsername(username: string): Promise<DatabaseResult<User | null>>;

  // ========== è§‚çœ‹å†å²ç›¸å…³æ“ä½œ ==========
  
  /**
   * æ·»åŠ æˆ–æ›´æ–°è§‚çœ‹å†å?   * @param history å†å²è®°å½•å¯¹è±¡
   * @returns æ“ä½œç»“æœ
   */
  saveHistory(history: History): Promise<DatabaseResult<boolean>>;

  /**
   * åˆ é™¤è§‚çœ‹å†å²
   * @param historyId å†å²è®°å½•ID
   * @returns æ“ä½œç»“æœ
   */
  deleteHistory(historyId: string): Promise<DatabaseResult<boolean>>;

  /**
   * æ ¹æ®ç”¨æˆ·IDåˆ é™¤æ‰€æœ‰å†å²è®°å½?   * @param userId ç”¨æˆ·ID
   * @returns æ“ä½œç»“æœ
   */
  deleteAllHistoryByUserId(userId: string): Promise<DatabaseResult<boolean>>;

  /**
   * æ ¹æ®IDè·å–å†å²è®°å½•
   * @param historyId å†å²è®°å½•ID
   * @returns å†å²è®°å½•å¯¹è±¡æˆ–null
   */
  getHistoryById(historyId: string): Promise<DatabaseResult<History | null>>;

  /**
   * è·å–ç”¨æˆ·çš„è§‚çœ‹å†å?   * @param userId ç”¨æˆ·ID
   * @param params åˆ†é¡µå‚æ•°
   * @returns åˆ†é¡µå†å²è®°å½•ç»“æœ
   */
  getUserHistory(
    userId: string,
    params: PaginationParams
  ): Promise<DatabaseResult<PaginatedResult<History>>>;

  /**
   * è·å–ç”¨æˆ·å¯¹ç‰¹å®šå†…å®¹çš„è§‚çœ‹å†å²
   * @param userId ç”¨æˆ·ID
   * @param contentId å†…å®¹ID
   * @param contentType å†…å®¹ç±»å‹
   * @returns å†å²è®°å½•å¯¹è±¡æˆ–null
   */
  getUserContentHistory(
    userId: string,
    contentId: string,
    contentType: string
  ): Promise<DatabaseResult<History | null>>;

  /**
   * è·å–æœ€è¿‘è§‚çœ‹çš„å†…å®¹
   * @param userId ç”¨æˆ·ID
   * @param limit é™åˆ¶æ•°é‡
   * @returns å†å²è®°å½•åˆ—è¡¨
   */
  getRecentHistory(
    userId: string,
    limit: number = 20
  ): Promise<DatabaseResult<History[]>>;

  // ========== æ”¶è—ç›¸å…³æ“ä½œ ==========
  
  /**
   * æ·»åŠ æ”¶è—
   * @param userId ç”¨æˆ·ID
   * @param movieId ç”µå½±ID
   * @param collectionName æ”¶è—é›†åç§?   * @returns æ“ä½œç»“æœ
   */
  addFavorite(
    userId: string,
    movieId: string,
    collectionName?: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * ç§»é™¤æ”¶è—
   * @param userId ç”¨æˆ·ID
   * @param movieId ç”µå½±ID
   * @returns æ“ä½œç»“æœ
   */
  removeFavorite(
    userId: string,
    movieId: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
   * @param userId ç”¨æˆ·ID
   * @param movieId ç”µå½±ID
   * @returns æ˜¯å¦å·²æ”¶è—?   */
  isFavorited(
    userId: string,
    movieId: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * è·å–ç”¨æˆ·çš„æ”¶è—åˆ—è¡?   * @param userId ç”¨æˆ·ID
   * @param params åˆ†é¡µå‚æ•°
   * @param collectionName æ”¶è—é›†åç§°ï¼ˆå¯é€‰ï¼‰
   * @returns åˆ†é¡µæ”¶è—ç»“æœ
   */
  getUserFavorites(
    userId: string,
    params: PaginationParams,
    collectionName?: string
  ): Promise<DatabaseResult<PaginatedResult<Movie>>>;

  /**
   * è·å–ç”¨æˆ·çš„æ”¶è—é›†åˆ—è¡¨
   * @param userId ç”¨æˆ·ID
   * @returns æ”¶è—é›†åç§°åˆ—è¡?   */
  getUserCollections(
    userId: string
  ): Promise<DatabaseResult<string[]>>;

  // ========== æœç´¢å†å²ç›¸å…³æ“ä½œ ==========
  
  /**
   * æ·»åŠ æœç´¢å†å²
   * @param userId ç”¨æˆ·ID
   * @param keyword æœç´¢å…³é”®è¯?   * @returns æ“ä½œç»“æœ
   */
  addSearchHistory(
    userId: string,
    keyword: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * åˆ é™¤æœç´¢å†å²
   * @param userId ç”¨æˆ·ID
   * @param keyword æœç´¢å…³é”®è¯?   * @returns æ“ä½œç»“æœ
   */
  deleteSearchHistory(
    userId: string,
    keyword: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * æ¸…ç©ºç”¨æˆ·æœç´¢å†å²
   * @param userId ç”¨æˆ·ID
   * @returns æ“ä½œç»“æœ
   */
  clearSearchHistory(
    userId: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * è·å–ç”¨æˆ·æœç´¢å†å²
   * @param userId ç”¨æˆ·ID
   * @param limit é™åˆ¶æ•°é‡
   * @returns æœç´¢å…³é”®è¯åˆ—è¡?   */
  getUserSearchHistory(
    userId: string,
    limit: number = 50
  ): Promise<DatabaseResult<string[]>>;

  // ========== ç¼“å­˜ç›¸å…³æ“ä½œ ==========
  
  /**
   * ç¼“å­˜æœç´¢ç»“æœ
   * @param keyword æœç´¢å…³é”®è¯?   * @param results æœç´¢ç»“æœ
   * @param expirationTime è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   * @returns æ“ä½œç»“æœ
   */
  cacheSearchResults(
    keyword: string,
    results: SearchResult[],
    expirationTime?: number
  ): Promise<DatabaseResult<boolean>>;

  /**
   * è·å–ç¼“å­˜çš„æœç´¢ç»“æ?   * @param keyword æœç´¢å…³é”®è¯?   * @returns ç¼“å­˜çš„æœç´¢ç»“æœæˆ–null
   */
  getCachedSearchResults(
    keyword: string
  ): Promise<DatabaseResult<SearchResult[] | null>>;

  /**
   * æ¸…é™¤è¿‡æœŸç¼“å­˜
   * @returns æ¸…é™¤çš„ç¼“å­˜é¡¹æ•°é‡
   */
  clearExpiredCache(): Promise<DatabaseResult<number>>;

  /**
   * è·å–ç¼“å­˜å¤§å°
   * @returns ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
   */
  getCacheSize(): Promise<DatabaseResult<number>>;

  /**
   * æ¸…ç©ºæ‰€æœ‰ç¼“å­?   * @returns æ“ä½œç»“æœ
   */
  clearAllCache(): Promise<DatabaseResult<boolean>>;

  // ========== é…ç½®ç›¸å…³æ“ä½œ ==========
  
  /**
   * ä¿å­˜é…ç½®é¡?   * @param key é…ç½®é”?   * @param value é…ç½®å€?   * @param group é…ç½®åˆ†ç»„
   * @returns æ“ä½œç»“æœ
   */
  saveConfig(
    key: string,
    value: ConfigValue,
    group?: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * è·å–é…ç½®é¡?   * @param key é…ç½®é”?   * @param group é…ç½®åˆ†ç»„
   * @returns é…ç½®å€?   */
  getConfig(
    key: string,
    group?: string
  ): Promise<DatabaseResult<ConfigValue | null>>;

  /**
   * åˆ é™¤é…ç½®é¡?   * @param key é…ç½®é”?   * @param group é…ç½®åˆ†ç»„
   * @returns æ“ä½œç»“æœ
   */
  deleteConfig(
    key: string,
    group?: string
  ): Promise<DatabaseResult<boolean>>;

  /**
   * è·å–é…ç½®åˆ†ç»„
   * @param group é…ç½®åˆ†ç»„
   * @returns é…ç½®åˆ†ç»„å¯¹è±¡
   */
  getConfigGroup(
    group: string
  ): Promise<DatabaseResult<Record<string, ConfigValue>>>;

  /**
   * æ¸…ç©ºé…ç½®åˆ†ç»„
   * @param group é…ç½®åˆ†ç»„
   * @returns æ“ä½œç»“æœ
   */
  clearConfigGroup(
    group: string
  ): Promise<DatabaseResult<boolean>>;
}
