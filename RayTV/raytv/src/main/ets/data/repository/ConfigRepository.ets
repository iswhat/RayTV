// ConfigRepository - é…ç½®ä»“åº“
// è´Ÿè´£å¤„ç†åº”ç”¨é…ç½®çš„å­˜å‚¨å’Œç®¡ç†

import Logger from '../../common/util/Logger';
import StorageUtil from '../../common/util/StorageUtil';
import { ConfigKey, ConfigValue, ConfigCategory } from '../model/ConfigModel';
import DatabaseRepository from './DatabaseRepository';

/**
 * é…ç½®ä»“åº“ç±? * ç®¡ç†åº”ç”¨çš„æ‰€æœ‰é…ç½®é¡¹ï¼Œæ”¯æŒå¤šçº§å­˜å‚¨ç­–ç•? */
class ConfigRepository {
  private static instance: ConfigRepository;
  private databaseRepository: DatabaseRepository;
  private configCache: Map<string, ConfigValue> = new Map();
  private defaultConfigs: Map<string, ConfigValue> = new Map();
  private initialized: boolean = false;

  // ç§æœ‰æ„é€ å‡½æ•?  private constructor() {
    this.databaseRepository = DatabaseRepository.getInstance();
    this.initializeDefaultConfigs();
    this.initialize();
  }

  /**
   * è·å–ConfigRepositoryå®ä¾‹
   * @returns ConfigRepositoryå•ä¾‹å®ä¾‹
   */
  public static getInstance(): ConfigRepository {
    if (!ConfigRepository.instance) {
      ConfigRepository.instance = new ConfigRepository();
    }
    return ConfigRepository.instance;
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤é…ç½?   */
  private initializeDefaultConfigs(): void {
    // åº”ç”¨åŸºç¡€é…ç½®
    this.defaultConfigs.set(ConfigKey.APP_VERSION, {
      value: '1.0.0',
      type: 'string',
      category: ConfigCategory.APPLICATION
    });
    
    this.defaultConfigs.set(ConfigKey.LANGUAGE, {
      value: 'zh-CN',
      type: 'string',
      category: ConfigCategory.APPLICATION
    });
    
    this.defaultConfigs.set(ConfigKey.THEME, {
      value: 'dark',
      type: 'string',
      category: ConfigCategory.UI
    });
    
    // æ’­æ”¾é…ç½®
    this.defaultConfigs.set(ConfigKey.DEFAULT_QUALITY, {
      value: 'auto',
      type: 'string',
      category: ConfigCategory.PLAYBACK
    });
    
    this.defaultConfigs.set(ConfigKey.AUTO_PLAY, {
      value: true,
      type: 'boolean',
      category: ConfigCategory.PLAYBACK
    });
    
    this.defaultConfigs.set(ConfigKey.REMEMBER_POSITION, {
      value: true,
      type: 'boolean',
      category: ConfigCategory.PLAYBACK
    });
    
    // ç½‘ç»œé…ç½®
    this.defaultConfigs.set(ConfigKey.NETWORK_TIMEOUT, {
      value: 30000,
      type: 'number',
      category: ConfigCategory.NETWORK
    });
    
    this.defaultConfigs.set(ConfigKey.USE_PROXY, {
      value: false,
      type: 'boolean',
      category: ConfigCategory.NETWORK
    });
    
    this.defaultConfigs.set(ConfigKey.MAX_CONNECTIONS, {
      value: 5,
      type: 'number',
      category: ConfigCategory.NETWORK
    });
    
    // ä¸‹è½½é…ç½®
    this.defaultConfigs.set(ConfigKey.DOWNLOAD_PATH, {
      value: '',
      type: 'string',
      category: ConfigCategory.DOWNLOAD
    });
    
    this.defaultConfigs.set(ConfigKey.MAX_DOWNLOAD_TASKS, {
      value: 2,
      type: 'number',
      category: ConfigCategory.DOWNLOAD
    });
    
    this.defaultConfigs.set(ConfigKey.DOWNLOAD_ONLY_WIFI, {
      value: true,
      type: 'boolean',
      category: ConfigCategory.DOWNLOAD
    });
    
    // å­—å¹•é…ç½®
    this.defaultConfigs.set(ConfigKey.SUBTITLE_FONT_SIZE, {
      value: 16,
      type: 'number',
      category: ConfigCategory.SUBTITLE
    });
    
    this.defaultConfigs.set(ConfigKey.SUBTITLE_COLOR, {
      value: '#FFFFFF',
      type: 'string',
      category: ConfigCategory.SUBTITLE
    });
    
    this.defaultConfigs.set(ConfigKey.SUBTITLE_BACKGROUND, {
      value: 'rgba(0,0,0,0.5)',
      type: 'string',
      category: ConfigCategory.SUBTITLE
    });
  }

  /**
   * åˆå§‹åŒ–é…ç½®ä»“åº?   */
  public async initialize(): Promise<void> {
    try {
      Logger.info('Initializing config repository');
      
      // ä»æ•°æ®åº“åŠ è½½é…ç½®
      await this.loadConfigsFromDatabase();
      
      // ç¡®ä¿é»˜è®¤é…ç½®å·²è®¾ç½?      await this.ensureDefaultConfigs();
      
      this.initialized = true;
      Logger.info('Config repository initialized successfully');
    } catch (error) {
      Logger.error('Failed to initialize config repository', error);
      this.initialized = false;
    }
  }

  /**
   * ä»æ•°æ®åº“åŠ è½½é…ç½®
   */
  private async loadConfigsFromDatabase(): Promise<void> {
    try {
      const configs = await this.databaseRepository.getAll('configs');
      
      for (const config of configs) {
        let parsedValue: Record<string, string | number | boolean | null> = config.value;
        
        // æ ¹æ®ç±»å‹è§£æå€?        switch (config.type instanceof Error ? string | number | boolean | null> = config.value;
        
        // æ ¹æ®ç±»å‹è§£æå€?        switch (config.type : new Error(String(string | number | boolean | null> = config.value;
        
        // æ ¹æ®ç±»å‹è§£æå€?        switch (config.type))) {
          case 'number':
            parsedValue = Number(config.value);
            break;
          case 'boolean':
            parsedValue = config.value === 'true' || config.value === true;
            break;
          case 'object':
            try {
              parsedValue = JSON.parse(config.value);
            } catch {
              parsedValue = config.value;
            }
            break;
        }
        
        this.configCache.set(config.key, {
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } instanceof Error ? {
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } : new Error(String({
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } instanceof Error ? {
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } instanceof Error ? {
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } : new Error(String({
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } : new Error(String({
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } instanceof Error ? {
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        } : new Error(String({
          value: parsedValue,
          type: config.type,
          category: config.category || ConfigCategory.GENERAL
        })))));
      }
      
      Logger.debug(`Loaded ${configs.length} configs from database`);
    } catch (error) {
      Logger.error('Failed to load configs from database', error);
    }
  }

  /**
   * ç¡®ä¿é»˜è®¤é…ç½®å·²è®¾ç½?   */
  private async ensureDefaultConfigs(): Promise<void> {
    try {
      for (const [key, defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries( instanceof Error ? defaultConfig] of this.defaultConfigs.entries( : new Error(String(defaultConfig] of this.defaultConfigs.entries()))))))) {
        if (!this.configCache.has(key)) {
          await this.setConfig(key, defaultConfig.value, defaultConfig.type, defaultConfig.category);
        }
      }
    } catch (error) {
      Logger.error('Failed to ensure default configs', error);
    }
  }

  /**
   * è·å–é…ç½®å€?   * @param key é…ç½®é”?   * @param defaultValue é»˜è®¤å€?   * @returns é…ç½®å€¼æˆ–é»˜è®¤å€?   */
  public async getConfig<T>(key: string, defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T : new Error(String(defaultValue?: T instanceof Error ? defaultValue?: T : new Error(String(defaultValue?: T))))))): Promise<T> {
    try {
      const config = this.configCache.get(key);
      
      if (config !== undefined) {
        return config.value as T;
      }
      
      // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æ•°æ®åº“è·å–
      const dbConfig = await this.databaseRepository.query('configs', [{ field: 'key', operator: '=', value: key }]);
      if (dbConfig.length > 0) {
        const configData = dbConfig[0];
        let parsedValue: Record<string, string | number | boolean | null> = configData.value;
        
        // è§£æå€¼ç±»å?        switch (configData.type) {
          case 'number':
            parsedValue = Number(configData.value);
            break;
          case 'boolean':
            parsedValue = configData.value === 'true' || configData.value === true;
            break;
          case 'object':
            try {
              parsedValue = JSON.parse(configData.value);
            } catch {
              parsedValue = configData.value;
            }
            break;
        }
        
        this.configCache.set(key, {
          value: parsedValue,
          type: configData.type,
          category: configData.category || ConfigCategory.GENERAL
        });
        
        return parsedValue as T;
      }
      
      // å¦‚æœæ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰ï¼Œè¿”å›é»˜è®¤å€¼æˆ–é»˜è®¤é…ç½®ä¸­çš„å€?      const defaultConfig = this.defaultConfigs.get(key);
      return (defaultConfig ? defaultConfig.value : defaultValue) as T;
    } catch (error) {
      Logger.error(`Failed to get config: ${key}`, error);
      return defaultValue as T;
    }
  }

  /**
   * è®¾ç½®é…ç½®å€?   * @param key é…ç½®é”?   * @param value é…ç½®å€?   * @param type å€¼ç±»å?   * @param category é…ç½®åˆ†ç±»
   */
  public async setConfig(key: string, value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL instanceof Error ? value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL : new Error(String(value: string | number | boolean | null, type: string = 'string', category: string = ConfigCategory.GENERAL))))))): Promise<void> {
    try {
      // æ›´æ–°ç¼“å­˜
      this.configCache.set(key, {
        value,
        type,
        category
      });
      
      // å‡†å¤‡å­˜å‚¨å€?      let storageValue: string | unknown = value;
      if (type === 'object') {
        storageValue = JSON.stringify(value);
      } else if (type === 'boolean') {
        storageValue = value.toString();
      }
      
      // æ£€æŸ¥é…ç½®æ˜¯å¦å·²å­˜åœ¨
      const existingConfigs = await this.databaseRepository.query('configs', [{ field: 'key', operator: '=', value: key }]);
      
      if (existingConfigs.length > 0) {
        // æ›´æ–°ç°æœ‰é…ç½®
        await this.databaseRepository.update('configs', existingConfigs[0].id, {
          value: storageValue,
          type,
          category,
          updated_at: Date.now()
        });
      } else {
        // æ’å…¥æ–°é…ç½?        await this.databaseRepository.insert('configs', {
          key,
          value: storageValue,
          type,
          category,
          created_at: Date.now(),
          updated_at: Date.now()
        });
      }
      
      Logger.debug(`Config set: ${key} = ${String(value)}, type: ${type}, category: ${category}`);
    } catch (error) {
      Logger.error(`Failed to set config: ${key}`, error);
      throw error;
    }
  }

  /**
   * åˆ é™¤é…ç½®
   * @param key é…ç½®é”?   * @returns æ˜¯å¦åˆ é™¤æˆåŠŸ
   */
  public async deleteConfig(key: string): Promise<boolean> {
    try {
      // ä»ç¼“å­˜ä¸­åˆ é™¤
      this.configCache.delete(key);
      
      // ä»æ•°æ®åº“ä¸­åˆ é™?      const configs = await this.databaseRepository.query('configs', [{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }] instanceof Error ? [{ field: 'key', operator: '=', value: key }] : new Error(String([{ field: 'key', operator: '=', value: key }])))))));
      
      if (configs.length > 0) {
        await this.databaseRepository.delete('configs', configs[0].id);
        Logger.debug(`Config deleted: ${key}`);
        return true;
      }
      
      return false;
    } catch (error) {
      Logger.error(`Failed to delete config: ${key}`, error);
      return false;
    }
  }

  /**
   * æ‰¹é‡è®¾ç½®é…ç½®
   * @param configs é…ç½®å¯¹è±¡
   */
  public async setConfigs(configs: Record<string, unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown>))))))): Promise<void> {
    try {
      for (const [key, value] of this.getObjectEntries(configs)) {
        const type = this.getValueType(value);
        await this.setConfig(key, value, type);
      }
      Logger.debug(`Batch set ${this.getObjectKeys(configs).length} configs`);
    } catch (error) {
      Logger.error('Failed to set configs in batch', error);
      throw error;
    }
  }

  /**
   * è·å–é…ç½®åˆ†ç±»
   * @param category é…ç½®åˆ†ç±»
   * @returns è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é…ç½?   */
  public async getConfigsByCategory(category: string): Promise<Map<string, ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( instanceof Error ? ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>( : new Error(String(ConfigValue>> {
    try {
      const result = new Map<string, ConfigValue>()))))));
      
      for (const [key, config] of this.configCache.entries()) {
        if (config.category === category) {
          result.set(key, config);
        }
      }
      
      return result;
    } catch (error) {
      Logger.error(`Failed to get configs by category: ${category}`, error);
      return new Map();
    }
  }

  /**
   * é‡ç½®é…ç½®åˆ°é»˜è®¤å€?   * @param key é…ç½®é”®ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™é‡ç½®æ‰€æœ‰ï¼‰
   */
  public async resetToDefault(key?: string): Promise<void> {
    try {
      if (key) {
        // é‡ç½®å•ä¸ªé…ç½®
        const defaultConfig = this.defaultConfigs.get(key);
        if (defaultConfig) {
          await this.setConfig(key, defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category instanceof Error ? defaultConfig.value, defaultConfig.type, defaultConfig.category : new Error(String(defaultConfig.value, defaultConfig.type, defaultConfig.category)))))));
          Logger.debug(`Config reset to default: ${key}`);
        }
      } else {
        // é‡ç½®æ‰€æœ‰é…ç½?        for (const [defaultKey, defaultConfig] of this.defaultConfigs.entries()) {
          await this.setConfig(defaultKey, defaultConfig.value, defaultConfig.type, defaultConfig.category);
        }
        Logger.debug('All configs reset to default');
      }
    } catch (error) {
      Logger.error(`Failed to reset config to default${key ? `: ${key}` : ''}`, error);
      throw error;
    }
  }

  /**
   * å¯¼å‡ºæ‰€æœ‰é…ç½?   * @returns é…ç½®å¯¹è±¡
   */
  public async exportConfigs(): Promise<Record<string, unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( instanceof Error ? unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries( : new Error(String(unknown>> {
    try {
      const exportData: Record<string, unknown> = {};
      
      for (const [key, config] of this.configCache.entries()))))))) {
        exportData[key] = {
          value: config.value,
          type: config.type,
          category: config.category
        };
      }
      
      Logger.info('Configs exported successfully');
      return exportData;
    } catch (error) {
      Logger.error('Failed to export configs', error);
      return {};
    }
  }

  /**
   * å¯¼å…¥é…ç½®
   * @param configs é…ç½®å¯¹è±¡
   */
  public async importConfigs(configs: Record<string, unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown> instanceof Error ? unknown> instanceof Error ? unknown> : new Error(String(unknown> : new Error(String(unknown> instanceof Error ? unknown> : new Error(String(unknown>))))))): Promise<void> {
    try {
      for (const [key, config] of Object.entries(configs)) {
        if (typeof config === 'object' && config !== null) {
          await this.setConfig(key, config.value, config.type, config.category);
        } else {
          // å…¼å®¹æ—§æ ¼å¼?          const type = this.getValueType(config);
          await this.setConfig(key, config, type);
        }
      }
      
      Logger.info(`Imported ${this.getObjectKeys(configs).length} configs`);
    } catch (error) {
      Logger.error('Failed to import configs', error);
      throw error;
    }
  }

  /**
   * è·å–å€¼çš„ç±»å‹
   * @param value å€?   * @returns ç±»å‹å­—ç¬¦ä¸?   */
  private getValueType(value: string | number | boolean | null): string {
    if (value === null) return 'null';
    if (Array.isArray(value)) return 'array';
    if (typeof value === 'object') return 'object';
    return typeof value;
  }

  /**
   * æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ?   * @param key é…ç½®é”?   * @returns æ˜¯å¦å­˜åœ¨
   */
  public async hasConfig(key: string): Promise<boolean> {
    return this.configCache.has(key);
  }

  /**
   * è·å–æ‰€æœ‰é…ç½®é”®
   * @returns é…ç½®é”®æ•°ç»?   */
  public getAllConfigKeys(): string[] {
    return Array.from(this.configCache.keys());
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®
   * æ›¿ä»£Object.keysï¼Œå…¼å®¹ArkTSè¯­æ³•
   */
  private getObjectKeys<T extends object>(obj: T): string[] {
    const keys: string[] = [];
    for (const key in obj) {
      if (Object.keys(obj).includes(key)) {
        keys.push(key);
      }
    }
    return keys;
  }
  
  /**
   * è·å–å¯¹è±¡çš„æ‰€æœ‰é”®å€¼å¯¹
   * æ›¿ä»£Object.entriesï¼Œå…¼å®¹ArkTSè¯­æ³•
   */
  private getObjectEntries<T extends object>(obj: T): [string, string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj instanceof Error ? string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj : new Error(String(string | number | boolean | null][] {
    const entries: [string, string | number | boolean | null][] = [];
    for (const key in obj))))))) {
      if (Object.keys(obj).includes(key)) {
        entries.push([key, obj[key]]);
      }
    }
    return entries;
  }

  /**
   * åˆ·æ–°é…ç½®ç¼“å­˜
   */
  public async refreshCache(): Promise<void> {
    try {
      this.configCache.clear();
      await this.loadConfigsFromDatabase();
      Logger.debug('Config cache refreshed');
    } catch (error) {
      Logger.error('Failed to refresh config cache', error);
    }
  }

  /**
   * é‡ç½®ä»“åº“
   */
  public async reset(): Promise<void> {
    try {
      Logger.info('Resetting config repository');
      
      // æ¸…ç©ºç¼“å­˜
      this.configCache.clear();
      
      // æ¸…ç©ºæ•°æ®åº“ä¸­çš„é…ç½?      await this.databaseRepository.clearTable('configs');
      
      // é‡æ–°åˆå§‹åŒ–é»˜è®¤é…ç½?      await this.initializeDefaultConfigs();
      await this.ensureDefaultConfigs();
      
      Logger.info('Config repository reset completed');
    } catch (error) {
      Logger.error('Failed to reset config repository', error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error instanceof Error ? error instanceof Error ? error : new Error(String(error : new Error(String(error instanceof Error ? error : new Error(String(error)))))));
      throw error;
    }
  }
}

export default ConfigRepository;



