import Logger from '../../common/util/Logger';
import { History } from '../bean/History';
import { DatabaseManager } from '../db/DatabaseManager';
import { TableSchema } from '../db/TableSchema';
import { ValuesBucket, RdbPredicates as RelationalPredicates, ResultSet, Order, OrderDirection } from '@ohos.data.relationalStore';

/**
 * å†å²è®°å½•æ•°æ®è®¿é—®å¯¹è±¡
 * è´Ÿè´£å†å²è®°å½•ç›¸å…³çš„æ•°æ®åº“æ“ä½œ
 */
export class HistoryDao {
  private readonly TAG: string = 'HistoryDao';
  private databaseManager: DatabaseManager;

  constructor() {
    this.databaseManager = DatabaseManager.getInstance();
  }

  /**
   * ä¿å­˜æˆ–æ›´æ–°å†å²è®°å½?
   * @param history å†å²è®°å½•ä¿¡æ¯
   */
  public async saveOrUpdate(history: History): Promise<void> {
    try {
      const db = await this.databaseManager.getDatabase();
      const valuesBucket: ValuesBucket = this.historyToValuesBucket(history);
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const existingHistory = await this.getByContentId(history.contentId);
      
      if (existingHistory) {
        // æ›´æ–°ç°æœ‰è®°å½•
        const predicates = new RelationalPredicates();
        predicates.equalTo(TableSchema.HISTORY_CONTENT_ID, history.contentId);
        const rowsAffected = await db.update(TableSchema.HISTORY_TABLE, valuesBucket, predicates);
        Logger.info(this.TAG, `History updated: ${history.title}, rows affected: ${rowsAffected}`);
      } else {
        // ä¿å­˜æ–°è®°å½?
        await db.insert(TableSchema.HISTORY_TABLE, valuesBucket);
        Logger.info(this.TAG, `History saved: ${history.title}`);
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to save or update history: ${error}`);
      throw error;
    }
  }

  /**
   * æ ¹æ®å†…å®¹IDè·å–å†å²è®°å½•
   * @param contentId å†…å®¹ID
   */
  public async getByContentId(contentId: string): Promise<History | null> {
    try {
      const db = await this.databaseManager.getDatabase();
      const predicates = new RelationalPredicates();
      predicates.equalTo(TableSchema.HISTORY_CONTENT_ID, contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId)))))));
      
      const resultSet = await db.query(TableSchema.HISTORY_TABLE, predicates);
      const histories = this.parseResultSet(resultSet);
      
      return histories.length > 0 ? histories[0] : null;
    } catch (error) {
      Logger.error(this.TAG, `Failed to get history by contentId: ${error}`);
      return null;
    }
  }

  /**
   * è·å–æ‰€æœ‰å†å²è®°å½?
   * @param limit é™åˆ¶æ•°é‡
   * @param offset åç§»é‡?
   */
  public async getAll(limit: number = 50, offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0 : new Error(String(offset: number = 0 instanceof Error ? offset: number = 0 : new Error(String(offset: number = 0))))))): Promise<History[]> {
    try {
      const db = await this.databaseManager.getDatabase();
      const predicates = new RelationalPredicates();
      predicates.orderByDesc(TableSchema.HISTORY_LAST_WATCH_TIME);
      predicates.limit(limit, offset);
      
      const resultSet = await db.query(TableSchema.HISTORY_TABLE, predicates);
      return this.parseResultSet(resultSet);
    } catch (error) {
      Logger.error(this.TAG, `Failed to get all histories: ${error}`);
      return [];
    }
  }

  /**
   * åˆ é™¤å†å²è®°å½•
   * @param contentId å†…å®¹ID
   */
  public async deleteByContentId(contentId: string): Promise<boolean> {
    try {
      const db = await this.databaseManager.getDatabase();
      const predicates = new RelationalPredicates();
      predicates.equalTo(TableSchema.HISTORY_CONTENT_ID, contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId)))))));
      
      const rowsAffected = await db.delete(TableSchema.HISTORY_TABLE, predicates);
      Logger.info(this.TAG, `History deleted: ${contentId}, rows affected: ${rowsAffected}`);
      return rowsAffected > 0;
    } catch (error) {
      Logger.error(this.TAG, `Failed to delete history: ${error}`);
      return false;
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å†å²è®°å½?
   */
  public async clearAll(): Promise<boolean> {
    try {
      const db = await this.databaseManager.getDatabase();
      const predicates = new RelationalPredicates();
      
      const rowsAffected = await db.delete(TableSchema.HISTORY_TABLE, predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates)))))));
      Logger.info(this.TAG, `All histories cleared, rows affected: ${rowsAffected}`);
      return rowsAffected > 0;
    } catch (error) {
      Logger.error(this.TAG, `Failed to clear all histories: ${error}`);
      return false;
    }
  }

  /**
   * è·å–å†å²è®°å½•æ•°é‡
   */
  public async getCount(): Promise<number> {
    try {
      const db = await this.databaseManager.getDatabase();
      const predicates = new RelationalPredicates();
      
      const resultSet = await db.query(TableSchema.HISTORY_TABLE, predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates instanceof Error ? predicates instanceof Error ? predicates : new Error(String(predicates : new Error(String(predicates instanceof Error ? predicates : new Error(String(predicates)))))));
      return resultSet.rowCount;
    } catch (error) {
      Logger.error(this.TAG, `Failed to get history count: ${error}`);
      return 0;
    }
  }

  /**
   * æ ¹æ®æ—¶é—´èŒƒå›´åˆ é™¤å†å²è®°å½•
   * @param beforeTime æ—¶é—´æˆ?
   */
  public async deleteBeforeTime(beforeTime: number): Promise<boolean> {
    try {
      const db = await this.databaseManager.getDatabase();
      const predicates = new RelationalPredicates();
      predicates.lessThan(TableSchema.HISTORY_LAST_WATCH_TIME, beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime : new Error(String(beforeTime instanceof Error ? beforeTime : new Error(String(beforeTime)))))));
      
      const rowsAffected = await db.delete(TableSchema.HISTORY_TABLE, predicates);
      Logger.info(this.TAG, `Histories deleted before ${beforeTime}, rows affected: ${rowsAffected}`);
      return rowsAffected > 0;
    } catch (error) {
      Logger.error(this.TAG, `Failed to delete histories before time: ${error}`);
      return false;
    }
  }

  /**
   * æ‰¹é‡åˆ é™¤å†å²è®°å½•
   * @param contentIds å†…å®¹IDåˆ—è¡¨
   */
  public async deleteBatch(contentIds: string[]): Promise<boolean> {
    try {
      const db = await this.databaseManager.getDatabase();
      
      for (const contentId of contentIds) {
        const predicates = new RelationalPredicates();
        predicates.equalTo(TableSchema.HISTORY_CONTENT_ID, contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId instanceof Error ? contentId instanceof Error ? contentId : new Error(String(contentId : new Error(String(contentId instanceof Error ? contentId : new Error(String(contentId)))))));
        await db.delete(TableSchema.HISTORY_TABLE, predicates);
      }
      
      Logger.info(this.TAG, `Batch deleted ${contentIds.length} histories`);
      return true;
    } catch (error) {
      Logger.error(this.TAG, `Failed to batch delete histories: ${error}`);
      return false;
    }
  }

  /**
   * å°†Historyå¯¹è±¡è½¬æ¢ä¸ºValuesBucket
   */
  private historyToValuesBucket(history: History): ValuesBucket {
    const bucket: ValuesBucket = {
      [TableSchema.HISTORY_CONTENT_ID]: history.contentId, [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( instanceof Error ? [TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now( : new Error(String([TableSchema.HISTORY_TITLE]: history.title,
      [TableSchema.HISTORY_COVER]: history.cover || '',
      [TableSchema.HISTORY_CURRENT_POSITION]: history.currentPosition || 0,
      [TableSchema.HISTORY_TOTAL_DURATION]: history.totalDuration || 0,
      [TableSchema.HISTORY_LAST_WATCH_TIME]: history.lastWatchTime || Date.now())))))),
      [TableSchema.HISTORY_SITE_KEY]: history.siteKey || '',
      [TableSchema.HISTORY_EPISODE_NAME]: history.episodeName || '',
      [TableSchema.HISTORY_OTHER_INFO]: JSON.stringify(history.otherInfo || {})
    };
    
    return bucket;
  }

  /**
   * è§£æç»“æœé›†ä¸ºHistoryå¯¹è±¡åˆ—è¡¨
   */
  private parseResultSet(resultSet: ResultSet): History[] {
    const histories: History[] = [];
    
    try {
      if (resultSet.rowCount > 0) {
        resultSet.goToFirstRow();
        
        do {
          const history: History = {
            contentId: resultSet.getString(resultSet.getColumnIndex(TableSchema.HISTORY_CONTENT_ID)),
            title: resultSet.getString(resultSet.getColumnIndex(TableSchema.HISTORY_TITLE)),
            cover: resultSet.getString(resultSet.getColumnIndex(TableSchema.HISTORY_COVER)),
            currentPosition: resultSet.getLong(resultSet.getColumnIndex(TableSchema.HISTORY_CURRENT_POSITION)),
            totalDuration: resultSet.getLong(resultSet.getColumnIndex(TableSchema.HISTORY_TOTAL_DURATION)),
            lastWatchTime: resultSet.getLong(resultSet.getColumnIndex(TableSchema.HISTORY_LAST_WATCH_TIME)),
            siteKey: resultSet.getString(resultSet.getColumnIndex(TableSchema.HISTORY_SITE_KEY)),
            episodeName: resultSet.getString(resultSet.getColumnIndex(TableSchema.HISTORY_EPISODE_NAME))
          };
          
          const otherInfoStr = resultSet.getString(resultSet.getColumnIndex(TableSchema.HISTORY_OTHER_INFO));
          if (otherInfoStr) {
            try {
              history.otherInfo = JSON.parse(otherInfoStr);
            } catch (e) {
              history.otherInfo = {};
            }
          }
          
          histories.push(history);
        } while (resultSet.goToNextRow());
      }
    } catch (error) {
      Logger.error(this.TAG, `Failed to parse result set: ${error}`);
    } finally {
      resultSet.close();
    }
    
    return histories;
  }
}


