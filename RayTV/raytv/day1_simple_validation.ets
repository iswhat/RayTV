/**
 * Day 1 ç®€åŒ–éªŒè¯è„šæœ¬
 * 
 * @file day1_simple_validation.ets
 * @description ä½¿ç”¨ArkTSè¯­æ³•éªŒè¯Day 1æ ¸å¿ƒåŠŸèƒ½
 */

import { EnhancedContainer } from './src/main/ets/common/di/EnhancedContainer';
import { MainViewModel } from './src/main/ets/presentation/viewmodel/MainViewModel';

@Entry
@Component
struct Day1Validation {
  @State validationResults: string[] = [];
  @State isRunning: boolean = false;

  aboutToAppear() {
    this.runValidation();
  }

  async runValidation() {
    this.isRunning = true;
    this.validationResults = ['ğŸš€ å¼€å§‹Day 1åŠŸèƒ½éªŒè¯...'];
    
    try {
      // éªŒè¯DIå®¹å™¨
      await this.validateDIContainer();
      
      // éªŒè¯ViewModel
      await this.validateViewModel();
      
      // éªŒè¯é›†æˆ
      await this.validateIntegration();
      
      this.validationResults.push('ğŸ‰ æ‰€æœ‰éªŒè¯å®Œæˆï¼');
      
    } catch (error) {
      this.validationResults.push(`âŒ éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error}`);
    } finally {
      this.isRunning = false;
    }
  }

  async validateDIContainer() {
    this.validationResults.push('\nğŸ§ª éªŒè¯DIå®¹å™¨åŠŸèƒ½...');
    
    try {
      const container = EnhancedContainer.getInstance();
      
      // æµ‹è¯•æœåŠ¡æ³¨å†Œ
      container.register('TestService', class {
        getValue() { return 'success'; }
        getServiceName() { return 'TestService'; }
        getServiceVersion() { return '1.0.0'; }
      });
      
      // æµ‹è¯•æœåŠ¡è§£æ
      const service = container.resolve<any>('TestService');
      if (service.getValue() === 'success') {
        this.validationResults.push('âœ… DIå®¹å™¨åŸºç¡€åŠŸèƒ½æ­£å¸¸');
      } else {
        this.validationResults.push('âŒ DIå®¹å™¨åŠŸèƒ½å¼‚å¸¸');
      }
      
    } catch (error) {
      this.validationResults.push(`âŒ DIå®¹å™¨éªŒè¯å¤±è´¥: ${error}`);
    }
  }

  async validateViewModel() {
    this.validationResults.push('\nğŸ§ª éªŒè¯ViewModelåŠŸèƒ½...');
    
    try {
      const viewModel = new MainViewModel();
      await viewModel.initialize();
      
      // æµ‹è¯•çŠ¶æ€æ›´æ–°
      viewModel.setStateProperty('searchQuery', 'test');
      const state = viewModel.getState();
      
      if (state.searchQuery === 'test') {
        this.validationResults.push('âœ… ViewModelçŠ¶æ€ç®¡ç†æ­£å¸¸');
      } else {
        this.validationResults.push('âŒ ViewModelçŠ¶æ€ç®¡ç†å¼‚å¸¸');
      }
      
      viewModel.dispose();
      
    } catch (error) {
      this.validationResults.push(`âŒ ViewModeléªŒè¯å¤±è´¥: ${error}`);
    }
  }

  async validateIntegration() {
    this.validationResults.push('\nğŸ§ª éªŒè¯ç»„ä»¶é›†æˆ...');
    
    try {
      // æµ‹è¯•DIå®¹å™¨å’ŒViewModelé›†æˆ
      const container = EnhancedContainer.getInstance();
      const viewModel = new MainViewModel();
      
      // æ¨¡æ‹Ÿä¾èµ–æ³¨å…¥
      viewModel['getService'] = (token: any) => container.resolve(token);
      
      await viewModel.initialize();
      this.validationResults.push('âœ… ç»„ä»¶é›†æˆæ­£å¸¸');
      
      viewModel.dispose();
      
    } catch (error) {
      this.validationResults.push(`âŒ é›†æˆéªŒè¯å¤±è´¥: ${error}`);
    }
  }

  build() {
    Column() {
      Text('RayTV Day 1 è¶…çº§å†²åˆºéªŒè¯')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })

      if (this.isRunning) {
        Text('â³ éªŒè¯è¿›è¡Œä¸­...')
          .fontSize(16)
          .fontColor('#FF9900')
          .margin({ bottom: 20 })
      }

      Scroller() {
        Column() {
          ForEach(this.validationResults, (result: string, index: number) => {
            Text(result)
              .fontSize(14)
              .textAlign(TextAlign.Start)
              .width('100%')
              .padding(8)
              .backgroundColor(index % 2 === 0 ? '#F5F5F5' : '#FFFFFF')
              .borderRadius(4)
          })
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor('#FAFAFA')

      Button('é‡æ–°è¿è¡ŒéªŒè¯')
        .width('80%')
        .height(48)
        .backgroundColor('#007AFF')
        .fontColor(Color.White)
        .borderRadius(8)
        .onClick(() => {
          this.runValidation();
        })
        .margin({ top: 20 })
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
  }
}